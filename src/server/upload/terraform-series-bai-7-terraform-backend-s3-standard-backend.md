## Gi·ªõi thi·ªáu
Ch√†o c√°c b·∫°n t·ªõi v·ªõi series v·ªÅ Terraform, ·ªü b√†i tr∆∞·ªõc ch√∫ng ta ƒë√£ n√≥i v·ªÅ l√Ω thuy·∫øt c·ªßa [Terraform Backend](https://viblo.asia/p/terraform-series-bai-6-terraform-backend-understand-backend-924lJRr6lPM). ·ªû b√†i n√†y ch√∫ng ta s·∫Ω th·ª±c h√†nh s·ª≠ d·ª•ng Terraform Standard Backend, c·ª• th·ªÉ l√† S3 Standard Backend. Ta s·∫Ω t√¨m hi·ªÉu Terraform S3 Backend s·∫Ω bao g·ªìm c√°c th√†nh ph·∫ßn g√¨, t·∫°o n√≥ ra sao v√† ·ª©ng d·ª•ng n√≥ v√†o d·ª± √°n c·ªßa ta th·∫ø n√†o.

M√¥ h√¨nh ƒë∆°n gi·∫£n c·ªßa S3 Standard Backend nh∆∞ sau.

![image.png](https://images.viblo.asia/ebbe6c3a-b692-4421-a6cc-a3d36bae14a2.png)

## Developing an S3 backend
### Architecture
Tr∆∞·ªõc khi s·ª≠ d·ª•ng S3 backend th√¨ ta c·∫ßn ph·∫£i t·∫°o n√≥ tr∆∞·ªõc, c·∫•u tr√∫c c·ªßa m·ªôt S3 backend g·ªìm nh·ªØng th√†nh ph·∫ßn:
+ IAM
+ DynamoDB
+ S3 bucket - KMS

![image.png](https://images.viblo.asia/12f98b04-c5be-47ec-86b8-c0f35f2b8678.png)

T·ª´ng th√†nh ph·∫ßn tr√™n s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng nh∆∞ sau:
+ IAM ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ terraform assume role, ƒë·ªÉ terraform c√≥ quy·ªÅn ghi v√†o dynamodb table v√† fetch/store state v√†o b√™n trong S3.
+ Dynamodb ƒë∆∞·ª£c terraform d√πng ƒë·ªÉ ghi lock key c·ªßa m·ªôt process v√†o b√™n trong n√≥, v√¨ dynamodb c√≥ t·ªëc ƒë·ªô ƒë·ªçc v√† ghi nhanh t·ªõi m·ª©c milisecond n√™n n√≥ r·∫•t th√≠ch h·ª£p ƒë·ªÉ lock state c·ªßa m·ªôt process.
+ S3 bucket d√πng ƒë·ªÉ l∆∞u tr·ªØ state khi terraform ch·∫°y xong, KMS ƒë∆∞·ª£c S3 s·ª≠ d·ª•ng ƒë·ªÉ m√£ h√≥a d·ªØ li·ªáu state khi n√≥ ƒë∆∞·ª£c l∆∞u v√†o b√™n trong S3.

### Developing
Gi·ªù th√¨ ta s·∫Ω ti·∫øn h√†nh t·∫°o S3 backend, ph√≠a d∆∞·ªõi c√°c resource m√† ta s·∫Ω s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o S3 backend.

![](https://images.viblo.asia/fe89e3b4-11f3-4d9d-83de-c65225a12b45.jpg)

T·∫°o m·ªôt m·ªôt folder v√† file `main.tf` + `variables.tf` + `versions.tf` v·ªõi n·ªôi dung.

```main.tf
provider "aws" {
  region = var.region
}
```

```variables.tf
variable "region" {
  type = string
  default = "us-west-2"
}

variable "project" {
  description = "The project name to use for unique resource naming"
  default     = "terraform-series"
  type        = string
}

variable "principal_arns" {
  description = "A list of principal arns allowed to assume the IAM role"
  default     = null
  type        = list(string)
}
```

```versions.tf
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 4.0"
    }
  }
}
```

Sau ƒë√≥ ch·∫°y c√¢u l·ªánh `terraform init`. Oke, v·∫≠y l√† b∆∞·ªõc chu·∫©n b·ªã ƒë√£ xong, ti·∫øp theo ta t·∫°o file `dynamodb.tf`.

```dynamodb.tf
resource "aws_dynamodb_table" "dynamodb_table" {
  name         = "${var.project}-s3-backend"

  hash_key     = "LockID"
  billing_mode = "PAY_PER_REQUEST"

  attribute {
    name = "LockID"
    type = "S"
  }

  tags = local.tags
}
```

ƒê√¢y l√† DynamoDB Table resource ƒë·ªÉ ch·ª©a lock state c·ªßa ta, ta ƒë·ªãnh nghƒ©a table n√†y s·∫Ω c√≥ m·ªôt tr∆∞·ªùng l√† **LockID v·ªõi type l√† String** ƒë√¢y l√† c·∫•u h√¨nh b·∫Øt bu·ªôc m√† terraform quy ƒë·ªãnh cho table m√† d√πng ƒë·ªÉ l∆∞u lock state.

Ti·∫øp theo ta t·∫°o file `iam.tf` ch·ª©a c√°c IAM resource.

```iam.tf
data "aws_caller_identity" "current" {}

locals {
  principal_arns = var.principal_arns != null ? var.principal_arns : [data.aws_caller_identity.current.arn]
}

data "aws_iam_policy_document" "policy_doc" {
  statement {
    actions   = ["s3:ListBucket"]
    resources = [aws_s3_bucket.s3_bucket.arn]
  }

  statement {
    actions   = ["s3:GetObject", "s3:PutObject", "s3:DeleteObject"]
    resources = ["${aws_s3_bucket.s3_bucket.arn}/*"]
  }

  statement {
    actions   = ["dynamodb:GetItem", "dynamodb:PutItem", "dynamodb:DeleteItem"]
    resources = [aws_dynamodb_table.dynamodb_table.arn]
  }
}
```

Data source `aws_caller_identity` d√πng ƒë·ªÉ l·∫•y th√¥ng tin v·ªÅ aws account m√† ta ƒëang ch·∫°y. Bi·∫øn principal_arns s·∫Ω ch·ª©a t·∫•t c·∫£ ƒë·ªëi t∆∞·ª£ng m√† ta cho ph√©p n√≥ assume role v·ªõi aws account c·ªßa ta.

T·ª´ bi·ªÉu th·ª©c so s√°nh `var.principal_arns != null ? var.principal_arns : [data.aws_caller_identity.current.arn]` ·ªü tr√™n => n·∫øu ta kh√¥ng truy·ªÅn bi·∫øn n√†y v√†o khi ch·∫°y terraform th√¨ n√≥ s·∫Ω ch·ªâ cho ph√©p account m√† ta d√πng ƒë·ªÉ ch·∫°y terraform c√≥ quy·ªÅn assume role.

Resoruce `aws_iam_policy_document` d√πng ƒë·ªÉ ƒë·ªãnh nghƒ©a c√°c policy c·ªßa ta, policy document ·ªü tr√™n s·∫Ω ƒë·ªãnh nghƒ©a quy·ªÅn c·∫ßn thi·∫øt ƒë·ªÉ ta c√≥ th·ªÉ th·ª±c hi·ªán h√†nh ƒë·ªông l√™n tr√™n DynamoDB, S3, KSM. Ti·∫øp theo ta s·∫Ω g·∫Øn policy document n√†y v√†o policy v√† role.

```iam.tf
...
resource "aws_iam_policy" "policy" {
  name   = "${title(var.project)}S3BackendPolicy"
  path   = "/"
  policy = data.aws_iam_policy_document.policy_doc.json
}

resource "aws_iam_role" "iam_role" {
  name = "${title(var.project)}S3BackendRole"

  assume_role_policy = <<-EOF
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Action": "sts:AssumeRole",
        "Principal": {
        "AWS": ${jsonencode(local.principal_arns)}
      },
      "Effect": "Allow"
      }
    ]
  }
  EOF

  tags = local.tags
}

resource "aws_iam_role_policy_attachment" "policy_attach" {
  role       = aws_iam_role.iam_role.name
  policy_arn = aws_iam_policy.policy.arn
}
```

Sau ƒë√≥ ta t·∫°o file `s3.tf`.

```s3.tf
resource "aws_s3_bucket" "s3_bucket" {
  bucket        = "${var.project}-s3-backend"
  force_destroy = false

  tags = local.tags
}

resource "aws_s3_bucket_acl" "s3_bucket" {
  bucket = aws_s3_bucket.s3_bucket.id
  acl    = "private"
}

resource "aws_s3_bucket_versioning" "s3_bucket" {
  bucket = aws_s3_bucket.s3_bucket.id

  versioning_configuration {
    status = "Enabled"
  }
}

resource "aws_kms_key" "kms_key" {
  tags = local.tags
}

resource "aws_s3_bucket_server_side_encryption_configuration" "s3_bucket" {
  bucket = aws_s3_bucket.s3_bucket.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
      kms_master_key_id = aws_kms_key.kms_key.arn
    }
  }
}
```

Resource `aws_s3_bucket` ta d√πng ƒë·ªÉ ƒë·ªãnh nghƒ©a s3 bucket, `aws_s3_bucket_acl` ta d√πng ƒë·ªÉ ƒë·ªãnh nghƒ©a access control list c·ªßa s3, ta n√™n ƒë·ªÉ l√† private.

Ti·∫øp theo v√† quan tr·ªçng l√† ƒë·ªÉ S3 c√≥ th·ªÉ d√πng ƒë·ªÉ l∆∞u tr·ªØ state, ta ph·∫£i b·∫≠t versioning cho n√≥, ta l√†m b·∫±ng resource `aws_s3_bucket_versioning`. Cu·ªëi c√πng l√† ta b·∫≠t SSE (Server Side Encryption) cho bucket c·ªßa ta b·∫±ng resource `aws_s3_bucket_server_side_encryption_configuration`.

Oke, v·∫≠y l√† ta ƒë√£ chu·∫©n b·ªã ƒë·ªß c√°c resource cho S3 backend, ti·∫øp theo ta c·∫≠p nh·∫≠t l·∫°i file `main.tf` ƒë·ªÉ n√≥ output ra gi√° tr·ªã c·ªßa S3 backend m√† ta s·∫Ω c·∫ßn, ƒë·ªÉ s·ª≠ d·ª•ng cho c√°c terraform project kh√°c.

```main.tf
...
locals {
  tags = {
    project = var.project
  }
}

data "aws_region" "current" {}

resource "aws_resourcegroups_group" "resourcegroups_group" {
  name = "${var.project}-s3-backend"

  resource_query {
    query = <<-JSON
      {
        "ResourceTypeFilters": [
          "AWS::AllSupported"
        ],
        "TagFilters": [
          {
            "Key": "project",
            "Values": ["${var.project}"]
          }
        ]
      }
    JSON
  }
}

output "config" {
  value = {
    bucket         = aws_s3_bucket.s3_bucket.bucket
    region         = data.aws_region.current.name
    role_arn       = aws_iam_role.iam_role.arn
    dynamodb_table = aws_dynamodb_table.dynamodb_table.name
  }
}
```

B·∫°n s·∫Ω ƒë·ªÉ √Ω th·∫•y c√≥ resource t√™n l√† `aws_resourcegroups_group`, th·∫±ng n√†y ch·ªß y·∫øu ƒë∆∞·ª£c d√πng ƒë·ªÉ group resource l·∫°i cho ta d·ªÖ qu·∫£n l√Ω th√¥i, l√°t m√¨nh s·∫Ω show cho c√°c b·∫°n xem.

Gi·ªù b·∫°n ch·∫°y c√¢u l·ªánh `terraform plan` ƒë·ªÉ t·∫°o S3 backend, sau khi ch·∫°y xong ta s·∫Ω th·∫•y output nh∆∞ d∆∞·ªõi, ƒë√¢y l√† c√°c gi√° tr·ªã ta s·∫Ω c·∫ßn.

```
config = {
  "bucket" = "terraform-series-s3-backend"
  "dynamodb_table" = "terraform-series-s3-backend"
  "region" = "us-west-2"
  "role_arn" = "arn:aws:iam::<ACCOUNT_ID>:role/HpiS3BackendRole"
}
```

ƒê·ªÉ ki·ªÉm tra c√°c resource c·ªßa S3 backend, ta truy c·∫≠p AWS Console https://console.aws.amazon.com/resource-groups/home, b·∫°n s·∫Ω th·∫•y resource group c·ªßa ta.

![image.png](https://images.viblo.asia/db675355-5957-41e1-ad82-3fa0af5a1033.png)

B·∫•m v√†o n√≥ b·∫°n s·∫Ω th·∫•y chi ti·∫øt c·ªßa t·ª´ng resource c·ªßa S3 backend. Oke, ti·∫øp theo ta s·∫Ω ti·∫øn h√†nh s·ª≠ d·ª•ng S3 backend n√†y v√†o trong project üòÅ.

### Using S3 backend
ƒê·ªÉ s·ª≠ d·ª•ng S3 backend cho m·ªôt project, ta c·∫•u c·∫ßn c·∫•u h√¨nh nh∆∞ sau.

```main.tf
terraform {
  backend "s3" {
    bucket         = <bucket-name>
    key            = <path>
    region         = <region>
    encrypt        = true
    role_arn       = <arn-role>
    dynamodb_table = <dynamodb-table-name>
  }
}
```

Ta s·∫Ω khai b√°o m·ªôt block t√™n l√† terraform v·ªõi backend l√† s3 v·ªõi c√°c gi√° tr·ªã sau:
+ bucket: s3 bucket name.
+ key: path ta l∆∞u state trong bucket.
+ role_arn: IAM role m√† c√≥ quy·ªÅn c·∫ßn thi·∫øt.
+ dynamodb_table: table d√πng ƒë·ªÉ save lock state.

Gi·ªù ta s·∫Ω l√†m v√≠ d·ª• t·∫°o m·ªôt EC2 m√† s·ª≠ d·ª•ng S3 backend. T·∫°o m·ªôt folder v√† file `main.tf`.

```main.tf
terraform {
  backend "s3" {
    bucket         = "terraform-series-s3-backend"
    key            = "test-project"
    region         = "us-west-2"
    encrypt        = true
    role_arn       = "arn:aws:iam::<ACCOUNT_ID>:role/HpiS3BackendRole"
    dynamodb_table = "terraform-series-s3-backend"
  }
}

provider "aws" {
  region = "us-west-2"
}

data "aws_ami" "ami" {
  most_recent = true

  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"]
  }

  owners = ["099720109477"]
}

resource "aws_instance" "server" {
  ami           = data.aws_ami.ami.id
  instance_type = "t3.micro"

  lifecycle {
    create_before_destroy = true
  }

  tags = {
    Name = "Server"
  }
}

output "public_ip" {
  value = aws_instance.server.public_ip
}
```

Ch·∫°y `terraform init` sau ƒë√≥ ta ch·∫°y `terraform plan`, sau khi n√≥ ch·∫°y xong b·∫°n s·∫Ω th·∫•y `terraform.tfstate` s·∫Ω kh√¥ng c√≤n n·∫±m ·ªü local n·ªØa. M√† ta s·∫Ω c·∫ßn l√™n tr√™n S3 bucket ƒë·ªÉ xem state file c·ªßa ta.

Truy c·∫≠p AWS S3 Console https://s3.console.aws.amazon.com/s3/buckets.

![image.png](https://images.viblo.asia/42917c37-36f1-470b-9a0a-75661acc8c03.png)

B·∫•m v√†o terraform-series-s3-backend ta s·∫Ω th·∫•y state file c·ªßa ta.

![image.png](https://images.viblo.asia/01cb095a-f4ab-4682-ac7d-fbb182f477dc.png)

Oke, s3 backend c·ªßa ta ƒë√£ ƒë∆∞·ª£c implement th√†nh c√¥ng üòÅ. Github repo c·ªßa to√†n b·ªô series https://github.com/hoalongnatsu/terraform-series.git.

## K·∫øt lu·∫≠n
V·∫≠y l√† ta ƒë√£ t√¨m hi·ªÉu xong v·ªÅ S3 backend, c√°ch t·∫°o ra n√≥ v√† c√°ch s·ª≠ d·ª•ng n√≥. Khi ta l√†m vi·ªác v·ªõi team th√¨ ta n√™n s·ª≠ d·ª•ng S3 backend cho project c·ªßa ta, v·ª´a centralized ƒë∆∞·ª£c state file, v·ª´a gi·∫£i quy·∫øt ƒë∆∞·ª£c v·∫•n ƒë·ªÉ conflict khi nhi·ªÅu ng∆∞·ªùi ch·∫°y terraform project c√πng m·ªôt l√∫c.  N·∫øu c√≥ th·∫Øc m·∫Øc ho·∫∑c c·∫ßn gi·∫£i th√≠ch r√µ th√™m ch·ªó n√†o th√¨ c√°c b·∫°n c√≥ th·ªÉ h·ªèi d∆∞·ªõi ph·∫ßn comment. ·ªû b√†i ti·∫øp theo ta n√≥i v·ªÅ c√°ch config v√† tri·ªÉn khai Terraform d√πng remote backend v√† Terraform Cloud.

## M·ª•c t√¨m ki·∫øm ƒë·ªìng ƒë·ªôi

![Ho√†ng Ph√∫c](https://images.viblo.asia/9fbde6d9-5e57-4429-a903-10a961e1c96c.png)

Team c√¥ng ngh·ªá Ho√†ng Ph√∫c c·ªßa b·ªçn m√¨nh ƒë∆∞·ª£c th√†nh l·∫≠p v·ªõi nhi·ªám v·ª• l√† x√¢y d·ª±ng m·ªôt h·ªá th·ªëng c√¥ng ngh·ªá n·ªôi b·ªô cho c√¥ng ty, Ho√†ng Ph√∫c l√† m·ªôt c√¥ng ty b√°n l·∫ª trong lƒ©nh v·ª±c th·ªùi trang v√† c√≥ h∆°n 30 nƒÉm tu·ªïi ƒë·ªùi, v·ªõi chu·ªói c·ª≠a h√†ng r·∫•t nhi·ªÅu tr√™n to√†n qu·ªëc, n√™n vi·ªác v·∫≠n h√†nh c·ªßa Ho√†ng Ph√∫c l√† r·∫•t l·ªõn v√† vi·ªác x√¢y d·ª±ng ƒë∆∞·ª£c m·ªôt h·ªá th·ªëng c√¥ng ngh·ªá ƒë·ªÉ ƒë√°p ·ª©ng vi·ªác v·∫≠n h√†nh n·ªôi b·ªô cho c√¥ng ty l√† m·ªôt c√¥ng vi·ªác r·∫•t th·ª≠ th√°ch, ƒë√¢y l√† m·ªôt qu√° tr√¨nh chuy·ªÉn ƒë·ªïi s·ªë v√† team b·ªçn m√¨nh ƒë√£ l√†m ƒë∆∞·ª£c nh·ªØng b∆∞·ªõc ban ƒë·∫ßu.

Th·ª© m√† team m√¨nh th·∫•y c·∫•n duy nh·∫•t l√† c√°i website, ƒë√¢y l√† trang web m√† tr∆∞·ªõc khi team m√¨nh ƒë∆∞·ª£c th√†nh l·∫≠p ƒë√£ c√≥ m·ªôt ƒë·ªôi outsource kh√°c l√†m, v√† nh·ªØng g√¨ h·ªç ƒë·ªÉ l·∫°i cho b·ªçn m√¨nh l√† m·ªôt trang web v·ªõi ƒë·ªëng b√πi nh√πi, v·ªõi s·ªë ƒëi·ªÉm t·ª´ google l√† 1 tr√™n 100. V·∫≠y b·ªçn m√¨nh s·∫Ω l√†m g√¨ v·ªõi trang web n√†y ƒë√¢y, n·∫£n ch√≠ sao? ƒêi·ªÅu ƒë√≥ kh√¥ng c√≥ trong t·ª´ ƒëi·ªÉn c·ªßa hai s·∫øp m√¨nh, v√† v·ªõi s·ª± d·∫´n d·∫Øt c·ªßa hai s·∫øp team m√¨nh s·∫Ω bi·∫øn ƒë·ªëng website b√πi nh√πi ƒë√≥ th√†nh kim c∆∞∆°ng, nh∆∞ c√°ch b·ªçn m√¨nh ƒë√£ c·∫£i thi·ªán h·ªá th·ªëng n·ªôi b·ªô. B·ªçn m√¨nh ƒëang c·∫£i thi·ªán trang web h·∫±ng ng√†y v√† h·∫±ng ng√†y, t·ª´ 1 ƒëi·ªÉm b·ªçn m√¨nh ƒë√£ c·∫£i thi·ªán n√≥ l√™n 70 ƒëi·ªÉm, v√† m·ª•c ti√™u l√† tr√™n 90 ƒëi·ªÉm.

Hi·ªán t·∫°i team b·ªçn m√¨nh ƒëang c·∫ßn c√°c ƒë·ªìng ƒë·ªôi tham gia ƒë·ªÉ c·∫£i thi·ªán l·∫°i trang web v·ªõi s·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng truy c·∫≠p kh√° l·ªõn, ƒë√¢y l√† m·ªôt th·ª≠ th√°ch r·∫•t th√∫ v·ªã, c√≥ bao gi·ªù c√°c b·∫°n ƒë∆∞·ª£c tham gia thi·∫øt k·∫ø m·ªôt h·ªá th·ªëng l·ªõn t·ª´ ƒë·∫ßu ch∆∞a, m√¨nh kh√° ch·∫Øc l√† s·ªë l∆∞·ª£ng ƒë√≥ r·∫•t √≠t. B·ªçn m√¨nh ƒë√£ c√≥ kh√°ch h√†ng, nh·ªØng g√¨ c√≤n l·∫°i l√† c·∫ßn nh·ªØng ƒë·ªìng ƒë·ªôi ƒë·ªÉ c√πng nhau ph√°t tri·ªÉn m·ªôt h·ªá th·ªëng ƒë·ªÉ ph·ª•c v·ª• r·∫•t nhi·ªÅu ng∆∞·ªùi d√πng. M·ª•c ti√™u c·ªßa c√¥ng ty Ho√†ng Ph√∫c l√† tr·ªü th√†nh nh√† b√°n l·∫ª v·ªÅ th·ªùi trang l·ªõn nh·∫•t Vi·ªát Nam, h√£y tham gia v·ªõi b·ªçn m√¨nh nh√©. M·ªôt th√†nh vi√™n trong team m√¨nh kh√¥ng y√™u c·∫ßn ph·∫£i gi·ªèi, ch·ªâ c·∫ßn h√≤a ƒë·ªìng, h·ª£p t√°c v√† s·∫µn s√†ng h·ª£p t√°c v·ªõi nhau. C√≥ th·ªÉ b·∫°n kh√¥ng l√† gi·ªèi nh·∫•t nh∆∞ng n·∫øu gia nh·∫≠p v·ªõi b·ªçn m√¨nh th√¨ b·∫°n s·∫Ω t·∫°o ra ƒë∆∞·ª£c nh·ªØng th·ª© gi√° tr·ªã nh·∫•t.

ƒê·ªìng ƒë·ªôi [Backend Engineer (Magento - PHP)](https://tuyendung.hoang-phuc.com/job/backend-engineer-magento-php-1538).

ƒê·ªìng ƒë·ªôi [Senior Backend Engineer](https://tuyendung.hoang-phuc.com/job/senior-backend-engineer-1022).

ƒê·ªìng ƒë·ªôi [Senior Frontend Engineer](https://tuyendung.hoang-phuc.com/job/senior-frontend-engineer-1021).