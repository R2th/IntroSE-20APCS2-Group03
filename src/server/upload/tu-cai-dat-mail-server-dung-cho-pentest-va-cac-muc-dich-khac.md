## Intro

Nhiá»u lÃºc báº¡n muá»‘n cÃ³ tháº­t nhiá»u tÃ i khoáº£n mail Ä‘á»ƒ:
- ÄÄƒng kÃ½ diá»…n Ä‘Ã n hoáº·c newleters vÃ  nhá»¯ng thá»© linh tinh khÃ¡c, nÃ³i chung lÃ  email cÃ³ thá»ƒ xÃ¡c thá»±c Ä‘Æ°á»£c, khi mÃ  cÃ¡c trang email disposable nhÆ° yopmail.com bá»‹ block cÃ ng nhiá»u
- NhÆ° mÃ¬nh lÃ  pentester cáº§n cÃ³ nhiá»u email Ä‘á»ƒ Ä‘Äƒng kÃ½ nhiá»u account Ä‘á»ƒ test cÃ¡c lá»—i nhÆ° IDOR, BAC, PE...
- Khi khÃ´ng thá»ƒ sá»­ dá»¥ng mail alias vá»›i `+`
- ...cho vui :laughing:

Trong bÃ i nÃ y ta sáº½ setup thá»­ mail server vá»›i cÃ¡c yÃªu cáº§u trÃªn.

Nhá»¯ng thá»© báº¡n cáº§n cÃ³:
- Má»™t VPS cÃ³ Ä‘á»‹a chá»‰ IP tÄ©nh vÃ  public trÃªn internet. Hiá»‡n mÃ¬nh Ä‘ang dÃ¹ng dá»‹ch vá»¥ cá»§a Digital Ocean vá»›i giÃ¡ 5$/thÃ¡ng, báº¡n cÃ³ thá»ƒ dÃ¹ng báº¥t cá»© dá»‹ch vá»¥ nÃ o khÃ¡c cÅ©ng Ä‘Æ°á»£c.
- Má»™t domain mÃ  báº¡n muá»‘n thiáº¿t láº­p nháº­n mail. CÃ³ ráº¥t nhiá»u dá»‹ch vá»¥ cho phÃ©p Ä‘Äƒng kÃ½ domain free, mÃ¬nh dÃ¹ng [dot.tk](https://www.dot.tk/en/index.html?lang=en) vÃ  Ä‘Äƒng kÃ½ domain: **minhtuanact.tk**

(thá»±c ra domain vÃ  VPS Ä‘á»u lÃ  cá»§a Ä‘á»©a trong team, mÃ¬nh setup há»™ Ä‘á»ƒ láº¥y áº£nh viáº¿t bÃ i viblo write-up :satisfied: )

Let's go!

## CÃ i Ä‘áº·t cáº¥u hÃ¬nh DNS

Äá»ƒ cÃ³ thá»ƒ Ä‘Æ°á»£c mail thÃ¬ ta cáº§n thiáº¿t láº­p má»™t sá»‘ DNS record:
- Má»™t record `A` vá»›i domain/subdomain cá»§a mail server, chá»‰ Ä‘áº¿n Ä‘á»‹a chá»‰ IP cá»§a VPS. VD: trang web cá»§a báº¡n á»Ÿ Ä‘á»‹a chá»‰ **minhtuanact.tk** vÃ  báº¡n muá»‘n nháº­n mail á»Ÿ má»™t subdomain khÃ¡c, á»Ÿ Ä‘Ã¢y mÃ¬nh sá»­ dá»¥ng **mail.minhtuanact.tk** thÃ¬ Ä‘iá»n Name lÃ : `MAIL`.
- Má»™t record `MX` Ä‘á»ƒ chá»‰ rÃµ subdomain nÃ o sáº½ Ä‘áº£m nháº­n viá»‡c nháº­n vÃ  gá»­i mail.
- Má»™t record `TXT` vá»›i tÃªn lÃ  `_DMARC` dÃ¹ng Ä‘á»ƒ thÃ´ng bÃ¡o vá» cÃ¡c policy trong viá»‡c gá»­i mai: khi bá»‹ spam mail thÃ¬ nhÆ° tháº¿ nÃ o,  gá»­i thÃ´ng bÃ¡o trong cÃ¡c trÆ°á»ng há»£p lá»—i nhÆ° tháº¿ nÃ o, vÃ¢n vÃ¢n vÃ  vÃ¢n vÃ¢n... MÃ¬nh cÅ©ng ko quan tÃ¢m láº¯m Ä‘áº¿n cÃ¡i nÃ y nÃªn dÃ¹ng táº¡m cáº¥u hÃ¬nh máº·c Ä‘á»‹nh nhÆ° sau. Äiá»n email cá»§a báº¡n vÃ o pháº§n `rua` vÃ  `ruf` nhÃ©:

```
v=DMARC1; p=none; pct=100; fo=1; rua=mailto:your.email@gmail.com; ruf=mailto:your.email@gmail.com
```

Vá»› Freenom thÃ¬ báº¡n vÃ o link: [https://my.freenom.com/clientarea.php?managedns=YYYY&domainid=XXXX](https://my.freenom.com/clientarea.php?managedns=YYYY&domainid=XXXX) vÃ  cáº¥u hÃ¬nh tÆ°Æ¡ng tá»± nhÆ° dÆ°á»›i Ä‘Ã¢y. CÃ³ thá»ƒ Ä‘áº·t TTL nhá» Ä‘á»ƒ DNS nhanh chÃ³ng Ä‘Æ°á»£c cáº­p nháº­t ( tá»‘i thiá»ƒu lÃ  300).

![](https://images.viblo.asia/e93c16ca-a4d0-43a6-b404-5ffc03dce88d.png)

Sau khi Ä‘Ã£ cáº¥u hÃ¬nh xong, Ä‘á»ƒ cÃ³ thá»ƒ kiá»ƒm tra cÃ¡c record Ä‘Ã£ ok chÆ°a, ta cÃ³ thá»ƒ dÃ¹ng cÃ´ng cá»¥: [https://mxtoolbox.com/](https://mxtoolbox.com/), Ä‘iá»n domain chÃ­nh vÃ o vÃ  check. Khi record chÆ°a Ä‘Æ°á»£c sáº½ nhÆ° tháº¿ nÃ y:

![](https://images.viblo.asia/7c6d96db-515d-40d6-a69f-a82b41ddd1e4.png)

CÃ²n ngon rá»“i thÃ¬ sáº½ nhÆ° tháº¿ nÃ y:

![](https://images.viblo.asia/06301e31-c19c-4c7a-9eec-5023ae9b2005.png)

## CÃ i Ä‘áº·t mail server

### Postfix

Äá»ƒ nháº­n mail, chÃºng ta sá»­ dá»¥ng Postfix, má»™t trong nhá»¯ng mail server quÃ¡ phá»• biáº¿n vÃ  quen thuá»™c. CÃ i Ä‘áº·t thÃ¬ cÅ©ng khÃ´ng cÃ³ gÃ¬ phá»©c táº¡p cáº£.

```
sudo apt update
sudo apt install postfix
```

Khi cÃ i Ä‘áº·t sáº½ hiá»‡n lÃªn mÃ n hÃ¬nh cáº¥u hÃ¬nh nhÆ° dÆ°á»›i Ä‘Ã¢y, chá»‰ cáº§n Ä‘á»c vÃ  chá»n theo hÆ°á»›ng dáº«n lÃ  ok:

![](https://images.viblo.asia/b82f24a1-092e-4999-868e-9d981a890d99.png)

- General type of mail configuration?: **Internet Site**
- System mail name: **minhtuanact.tk**
- Root and postmaster mail recipient:  sáº½ lÃ  user chÃ­nh trÃªn server cá»§a báº¡n, trong trÆ°á»ng há»£p cá»§a mÃ¬nh lÃ : **minhtuan**

CÃ²n cá»¥ thá»ƒ chÃºng ta sáº½ cáº¥u hÃ¬nh thÃªm á»Ÿ phÃ­a sau. CÃ²n náº¿u lá»¡ lÃ m sai á»Ÿ Ä‘Ã¢u Ä‘Ã³ thÃ¬ cÃ³ thá»ƒ dÃ¹ng cÃ¢u lá»‡nh sau Ä‘á»ƒ cáº¥u hÃ¬nh láº¡i:

```
sudo dpkg-reconfigure postfix
```

### Dovecot

ChÃºng ta cáº§n cÃ i Ä‘áº·t thÃªm Dovecot: lÃ  pháº§n má»m mÃ£ nguá»“n má»Ÿ  email server dÃ¹ng cho hai giao thá»©c IMAP vÃ  POP3 dÃ¹ng Ä‘á»ƒ quáº£n lÃ½ mail tá»« mail server. Dovecot sáº½ Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ chuyá»ƒn cÃ¡c mail Ä‘áº¿n há»™p thÆ° cá»§a tá»«ng user trÃªn server.
CÃ i Ä‘áº·t thÃ¬ cÅ©ng khÃ´ng cÃ³ gÃ¬ quÃ¡ khÃ³ cáº£:

```
sudo apt update
sudo apt install dovecot-core dovecot-imapd
```

### Cáº¥u hÃ¬nh postfix

Äá»‘i vá»›i postfix, cáº¥u hÃ¬nh sáº½ náº±m á»Ÿ file `/etc/postfix/main.cf`. Má»Ÿ file nÃ y ra vÃ  chÃºng ta thÃªm cáº¥u hÃ¬nh nhÆ° dÆ°á»›i Ä‘Ã¢y:

```
smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = ubuntu-512mb-sgp1-01
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases

#myorigin = /etc/mailname
#mydestination = $myhostname, ubuntu-512mb-sgp1-01, localhost.localdomain, localhost

myorigin = localhost
mydestination = localhost

relayhost =
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all
home_mailbox = Maildir/
virtual_alias_maps = hash:/etc/postfix/virtual

smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous
smtpd_sender_restrictions = permit_sasl_authenticated

virtual_alias_domains = hash:/etc/postfix/virtual_domains
```

- `alias_maps = hash:/etc/aliases` vÃ  `alias_database = hash:/etc/aliases`: dÃ¹ng Ä‘á»ƒ chuyá»ƒn hÆ°á»›ng mail tá»« user nÃ y sang user khÃ¡c. VÃ­ dá»¥, chÃºng ta muá»‘n nhá»¯ng mail gá»­i Ä‘áº¿n `postmaster@domain.com` sáº½ Ä‘Æ°á»£c chuyá»ƒn sang cho user `root` cháº³ng háº¡n (vÃ¬ server vá»‘n khÃ´ng tá»“n táº¡i user `postmaster`).

```
# See man 5 aliases for format
postmaster:    root
root:	minhtuan
```

- Chá»‰nh `myorigin` vÃ  `mydestination` vá» localhost
- `home_mailbox = Maildir/`: Ä‘á»‹nh dáº¡ng Maildir sáº½ cho phÃ©p chia cÃ¡c email thÃ nh cÃ¡c file riÃªng biá»‡t vÃ  di chuyá»ƒn cÃ¡c file nÃ y giá»¯a cÃ¡c folder tÃ¹y thuá»™c vÃ  hÃ nh Ä‘á»™ng cá»§a ngÆ°á»i dÃ¹ng. Má»™t Ä‘á»‹nh dáº¡ng khÃ¡c lÃ  `mbox` sáº½ lÆ°u táº¥t cáº£ vÃ o má»™t file.
- `virtual_alias_domains = hash:/etc/postfix/virtual_domains` dÃ¹ng Ä‘á»ƒ setup trong trÆ°á»ng há»£p VPS nÃ y Ä‘Æ°á»£c dÃ¹ng chung cho nhiá»u domain khÃ¡c nhau, vÃ­ dá»¥ khi muá»‘n kiá»ƒm tra má»‘i liÃªn quan giá»¯a 2 domain: `example.com` vÃ  `xn--exmple-qta.com` (tá»©c lÃ  `exÃ¡mple.com` sau khi punny decode) xem web app cÃ³ thá»±c hiá»‡n viá»‡c convert domain khÃ´ng, ta cÃ³ thá»ƒ dÃ¹ng chung luÃ´n mÃ  ko cáº§n thÃªm 1 VPS khÃ¡c:

```
xn--exmple-qta.com   #domain
example.com          #domain
```

- `virtual_alias_maps = hash:/etc/postfix/virtual`: Cáº¥u hÃ¬nh gá»“m domain vÃ  user sáº½ nháº­n email cho domain Ä‘Ã³. Cáº¥u hÃ¬nh nhÆ° tháº¿ nÃ y cÃ²n cÃ³ tÃ¡c dá»¥ng lÃ  táº¥t cáº£ cÃ¡c email gá»­i Ä‘áº¿n domain dÃ¹ cho báº¥t cá»© user nÃ o, ká»ƒ cáº£ khÃ´ng tá»“n táº¡i Ä‘i ná»¯a sáº½ Ä‘á»u bá»‹ redirect vá» 1 hÃ²m mail duy nháº¥t cá»§a user Ä‘Æ°á»£c cÃ i Ä‘áº·t.

```
xn--exmple-qta.com   minhtuan
example.com          minhtuan
```

Sau khi cáº¥u hÃ¬nh cÃ¡c file nÃ y nhá»› thá»±c hiá»‡n cÃ¡c lá»‡nh sau Ä‘á»ƒ generate DB:

```
sudo postmap /etc/aliases
sudo postmap /etc/postfix/virtual_domains
sudo postmap /etc/postfix/virtual
```
vÃ  load láº¡i postfix:

```
sudo service postfix restart
```

Äá»ƒ cÃ³ thá»ƒ check mail, ta cÃ³ thá»ƒ cÃ i Ä‘áº·t thÃªm cÃ´ng cá»¥ `mailutils`:

```
sudo apt install mailutils
```

CÃ i xong ta cÃ³ thá»ƒ sá»­ dá»¥ng lá»‡nh `mail` Ä‘á»ƒ kiá»ƒm tra thÆ° cá»§a user hiá»‡n táº¡i:

```
 U 22 Twitter            Thu Jan  1 07:00 2082/106270 prin Tweeted: Me after getting bug ğŸ˜‚ :
 U 23 Cron Daemon        Thu Jan  1 07:00   51/2363  Cron <root@ubuntu-512mb-sgp1-01> certbot renew --renew-hook 'service nginx re
 U 24 Twitter            Thu Jan  1 07:00 1138/46840 Another Self, download the app today
 U 25 Takeaway           Thu Jan  1 07:00  581/42970 Jobs for you from Takeaway Talent Community
 U 26 Twitter            Thu Jan  1 07:00 1907/94689 prin Tweeted: Support âœŒï¸âœŒï¸âœŒï¸âœŒï¸
? q
Held 214 messages in /home/minhtuan/Maildir
```

### Cáº¥u hÃ¬nh dovecot

Má»Ÿ file `/etc/dovecot/conf.d/10-auth.conf` vÃ  chá»‰nh cáº¥u hÃ¬nh nhÆ°  sau:

```
disable_plaintext_auth = no
auth_mechanisms = plain login
```

vÃ  sá»­a `auth_username_format = %n` (sáº½ Ä‘Æ°á»£c dÃ¹ng khi dÃ¹ng vá»›i rainloop á»Ÿ phÃ­a sau).

Má»Ÿ `/etc/dovecot/conf.d/10-mail.conf` vÃ  chá»‰nh nhÆ° sau Ä‘á»ƒ chuyá»ƒn sang sá»­ dá»¥ng Ä‘á»‹nh dáº¡ng `Maildir`.

```
mail_location = maildir:~/Maildir
```

BÆ°á»›c cuá»‘i lÃ  chá»‰nh sá»­a `/etc/dovecot/conf.d/10-master.conf`, tÃ¬m Ä‘áº¿n block `smtp-auth` vÃ  chá»‰nh nhÆ° sau:

```
# Postfix smtp-auth
unix_listener /var/spool/postfix/private/auth {
  mode = 0666
  user = postfix
  group = postfix
}
```

VÃ  khÃ´ng quÃªn reload láº¡i dovecot

```
sudo service dovecot restart
```

## Cáº¥u hÃ¬nh mail client

Vá»›i mail client, mÃ¬nh sá»­ dá»¥ng rainloop do cáº¥u hÃ¬nh ráº¥t Ä‘Æ¡n giáº£n vÃ  nhanh gá»n, chá»‰ cáº§n cÃ i Ä‘áº·t PHP khÃ´ng yÃªu cáº§u sá»­ dá»¥ng DB gÃ¬ cáº£. Táº£i vá» táº¡i: [https://www.rainloop.net/](https://www.rainloop.net/) vÃ  unzip vÃ o `/var/html/rainloop`

```
wget https://www.rainloop.net/repository/webmail/rainloop-community-latest.zip
```

Rainloop yÃªu cáº§u PHP, á»Ÿ Ä‘Ã¢y mÃ¬nh dÃ¹ng PHP 7.2 vÃ i cÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n nhÆ° sau:

```
sudo apt install php-fpm
sudo apt install php7.2-dom
sudo apt install php7.2-curl
```

Sau khi cÃ i Ä‘áº·t theo hÆ°á»›ng dáº«n [https://www.rainloop.net/docs/installation/](https://www.rainloop.net/docs/installation/), chÃº Ã½ phÃ¢n quyá»n Ä‘Ãºng vÃ  vá»›i nginx, ta cÃ³ thá»ƒ cáº¥u hÃ¬nh nhÆ° sau:

```
server {
   listen 80;
   server_name inbox.minhtuanact.tk;

   root /var/www/rainloop/;
   index index.php index.html;

   access_log /var/log/nginx/rainloop_access.log;
   error_log /var/log/nginx/rainloop_error.log;

   location / {
       try_files $uri $uri/ /index.php?$query_string;
   }

   location ~ ^/(.+\.php)$ {
        try_files $uri =404;
        fastcgi_pass unix:/run/php/php7.2-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include /etc/nginx/fastcgi_params;
   }

   location ^~ /data {
       deny all;
   }
}
```

ChÃº Ã½ cáº¥u hÃ¬nh `server_name` vá»›i subdomain mÃ  báº¡n muá»‘n host rainloop trÃªn Ä‘Ã³, á»Ÿ vÃ­ dá»¥ trÃªn lÃ : **inbox.minhtuanact.tk** (nhá»› setup DNS record ná»¯a nhÃ©).

Ok, báº­t rainloop lÃªn vÃ  cáº¥u hÃ¬nh nÃ o, vÃ o `http://inbox.minhtuanact.tk/?admin`vÃ  Ä‘iá»n tÃ i khoáº£n:

> Default login is "admin", password is "12345".

ta cáº¥u hÃ¬nh giá»‘ng áº£nh, vÃ  Ä‘á»«ng quÃªn Ä‘á»•i password máº·c Ä‘á»‹nh cá»§a admin nha:

- Chá»‰nh domain máº·c Ä‘á»‹nh:
![](https://images.viblo.asia/8f701e44-8a1a-4b89-9cec-6801babc2680.png)

- ThÃªm domain:
![](https://images.viblo.asia/a8c8c677-a776-47d3-8deb-370731872d9d.png)

- Äá»«ng quÃªn Ä‘á»•i pass nhÃ¡:
![](https://images.viblo.asia/f6e07c86-089d-4eee-a61a-6c9b2365e873.png)

Xong xuÃ´i ta cÃ³ thá»ƒ vÃ o [http://inbox.minhtuanact.tk/#/mailbox/INBOX](http://inbox.minhtuanact.tk/#/mailbox/INBOX) vÃ  Ä‘Äƒng nháº­p vá»›i username vÃ  password trÃªn há»‡ thá»‘ng Ä‘á»ƒ check mail. Thá»­ gá»­i vÃ i cÃ¡i mail test xem cÃ³ nháº­n Ä‘Æ°á»£c khÃ´ng nÃ o :smile:

![](https://images.viblo.asia/bafa93b7-36e9-4c2c-ac9d-5ab276956d46.png)

![](https://images.viblo.asia/b0203c33-6a43-49a4-9198-951af20f6996.png)

## Káº¿t

> Äá»«ng láº¥y mail server Ä‘Äƒng kÃ½ rá»“i Ä‘i spam nha, bá»‹ block lÃ  khá»• Ä‘áº¥y :smile: 

Hiá»‡n mail server cá»§a chÃºng ta má»›i cÃ³ thá»ƒ nháº­n Ä‘Æ°á»£c email, cÃ²n Ä‘á»ƒ gá»­i mail thÃ¬ sáº½ cáº§n thÃªm chÃºt cáº¥u hÃ¬nh ná»¯a, cÃ³ láº½ sáº½ Ä‘á»ƒ dÃ nh bÃ i sau. Bye!

## Tham kháº£o

- [https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-postfix-on-ubuntu-20-04](https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-postfix-on-ubuntu-20-04)
- [https://www.digitalocean.com/community/tutorials/how-to-set-up-a-postfix-e-mail-server-with-dovecot](https://www.digitalocean.com/community/tutorials/how-to-set-up-a-postfix-e-mail-server-with-dovecot)
- [https://www.tecmint.com/install-postfix-mail-server-with-webmail-in-debian/](https://www.tecmint.com/install-postfix-mail-server-with-webmail-in-debian/)