Kháº¯c phá»¥c vÃ  ngÄƒn ngá»«a cÃ¡c váº¥n Ä‘á» vá» hiá»‡u suáº¥t lÃ  ráº¥t quan trá»ng Ä‘á»‘i vá»›i sá»± thÃ nh cÃ´ng cá»§a báº¥t ká»³ á»©ng dá»¥ng nÃ o. ChÃºng ta sá»­ dá»¥ng nhiá»u cÃ´ng cá»¥ vÃ  phÆ°Æ¡ng phÃ¡p khÃ¡c nhau Ä‘á»ƒ cung cáº¥p má»™t táº­p há»£p cÃ¡c ká»¹ thuáº­t cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ phÃ¢n tÃ­ch vÃ  tÄƒng hiá»‡u suáº¥t!

Tá»‘i Æ°u hÃ³a khiáº¿n chÃºng ta giá»‘ng nhÆ° má»™t nhÃ  trinh thÃ¡m váº­y. Nháº­n má»™t cÆ¡n Ã¡c má»™ng vá» hiá»‡u suáº¥t vÃ  Ä‘iá»u chá»‰nh nÃ³ thÃ nh má»™t thá»© gÃ¬ Ä‘Ã³ nhanh chÃ³ng vÃ  Ä‘áº¹p máº¯t mang láº¡i cáº£m giÃ¡c tuyá»‡t vá»i vÃ  cháº¯c cháº¯n sáº½ khiáº¿n ngÆ°á»i khÃ¡c hÃ i lÃ²ng. 
Amazing!
Má»™t Ä‘iá»u gÃ¬ Ä‘Ã³ khá»§ng khiáº¿p Ä‘Ã£ xáº£y ra vÃ  chÃºng ta cáº§n láº§n theo manh má»‘i Ä‘á»ƒ xÃ¡c Ä‘á»‹nh vá»‹ trÃ­ vÃ  báº¯t Ä‘Æ°á»£c thá»§ pháº¡m! Loáº¡t bÃ i viáº¿t nÃ y lÃ  sáº½ Ä‘Æ°a ra nhá»¯ng manh má»‘i, cÃ¡ch xÃ¡c Ä‘á»‹nh vÃ  sá»­ dá»¥ng chÃºng Ä‘á»ƒ tÃ¬m ra nguyÃªn nhÃ¢n gá»‘c rá»… cá»§a sá»± cá»‘ hiá»‡u suáº¥t.

TÃ¬m hiá»ƒu vá» tá»‘i Æ°u truy váº¥n vÃ  vÃ´ tÃ¬nh tÃ¬m Ä‘Æ°á»£c 1 blog ráº¥t hay nÃ y, nÃªn mÃ¬nh quyáº¿t Ä‘á»‹nh lÃ m series nÃ y Ä‘á»ƒ dá»‹ch cÃ¡c bÃ i viáº¿t hay vá» tá»‘i Æ°u truy váº¥n, giÃºp má»i ngÆ°á»i dá»… theo dÃµi vÃ  tÃ¬m hiá»ƒu hÆ¡n. BÃ i viáº¿t gá»‘c mÃ¬nh cÃ³ Ä‘á»ƒ trong danh má»¥c tÃ i liá»‡u cuá»‘i bÃ i viáº¿t, má»i ngÆ°á»i cÃ³ thá»ƒ truy cáº­p Ä‘á»ƒ hiá»ƒu rÃµ hÆ¡n.

BÃ i dá»‹ch Ä‘áº§u tiÃªn chÃºng ta sáº½ giÃºp ta nhá»› láº¡i nhá»¯ng kiáº¿n thá»©c ná»n táº£ng cÆ¡ báº£n vá» tá»‘i Æ°u hÃ³a vÃ  cÃ¡c váº¥n Ä‘á» phá»• biáº¿n liÃªn quan Ä‘áº¿n tá»‘i Æ°u hÃ³a truy váº¥n.

### Tá»‘i Æ°u hÃ³a lÃ  gÃ¬ ?
"Tá»‘i Æ°u" lÃ  gÃ¬? CÃ¢u tráº£ lá»i cho Ä‘iá»u nÃ y cÅ©ng sáº½ xÃ¡c Ä‘á»‹nh khi nÃ o chÃºng ta giáº£i quyáº¿t xong má»™t váº¥n Ä‘á» vÃ  cÃ³ thá»ƒ chuyá»ƒn sang váº¥n Ä‘á» tiáº¿p theo. ThÃ´ng thÆ°á»ng, má»™t truy váº¥n cÃ³ thá»ƒ Ä‘Æ°á»£c tÄƒng tá»‘c thÃ´ng qua nhiá»u phÆ°Æ¡ng tiá»‡n khÃ¡c nhau, má»—i phÆ°Æ¡ng tiá»‡n Ä‘á»u cÃ³ thá»i gian vÃ  chi phÃ­ tÃ i nguyÃªn liÃªn quan.

ChÃºng ta thÆ°á»ng khÃ´ng thá»ƒ dÃ nh cÃ¡c nguá»“n lá»±c cáº§n thiáº¿t Ä‘á»ƒ lÃ m cho má»™t táº­p lá»‡nh cháº¡y nhanh nháº¥t cÃ³ thá»ƒ, vÃ  chÃºng ta cÅ©ng khÃ´ng nÃªn lÃ m nhÆ° váº­y. VÃ¬ má»¥c Ä‘Ã­ch Ä‘Æ¡n giáº£n, chÃºng ta sáº½ Ä‘á»‹nh nghÄ©a *"tá»‘i Æ°u" lÃ  Ä‘iá»ƒm mÃ  táº¡i Ä‘Ã³ truy váº¥n thá»±c hiá»‡n má»™t cÃ¡ch cháº¥p nháº­n Ä‘Æ°á»£c vÃ  sáº½ tiáº¿p tá»¥c lÃ m nhÆ° váº­y trong má»™t khoáº£ng thá»i gian há»£p lÃ½ trong tÆ°Æ¡ng lai*. ÄÃ¢y lÃ  má»™t Ä‘á»‹nh nghÄ©a kinh doanh giá»‘ng nhÆ° má»™t Ä‘á»‹nh nghÄ©a ká»¹ thuáº­t. Vá»›i vÃ´ háº¡n tiá»n báº¡c, thá»i gian vÃ  tÃ i nguyÃªn mÃ¡y tÃ­nh, má»i thá»© Ä‘á»u cÃ³ thá»ƒ thá»±c hiá»‡n Ä‘Æ°á»£c, nhÆ°ng chÃºng ta khÃ´ng cÃ³ quyá»n sá»Ÿ há»¯u nguá»“n tÃ i nguyÃªn khÃ´ng giá»›i háº¡n, vÃ  do Ä‘Ã³ pháº£i xÃ¡c Ä‘á»‹nh nhá»¯ng Ä‘iá»u chÃºng ta Ä‘Ã£ lÃ m lÃ  gÃ¬ báº¥t cá»© khi nÃ o chÃºng ta theo Ä‘uá»•i báº¥t ká»³ váº¥n Ä‘á» hiá»‡u suáº¥t nÃ o.

Äiá»u nÃ y cung cáº¥p cho chÃºng ta má»™t sá»‘ Ä‘iá»ƒm kiá»ƒm tra há»¯u Ã­ch Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ láº¡i tiáº¿n trÃ¬nh tá»‘i Æ°u hÃ³a:
* Truy váº¥n hiá»‡n thá»±c hiá»‡n Ä‘áº§y Ä‘á»§.
* CÃ¡c tÃ i nguyÃªn cáº§n thiáº¿t Ä‘á»ƒ tá»‘i Æ°u hÃ³a hÆ¡n ná»¯a lÃ  ráº¥t tá»‘n kÃ©m.
* ChÃºng tÃ´i Ä‘Ã£ Ä‘áº¡t Ä‘áº¿n Ä‘iá»ƒm giáº£m dáº§n lá»£i nhuáº­n cho báº¥t ká»³ tá»‘i Æ°u hÃ³a nÃ o tiáº¿p theo.
* Má»™t giáº£i phÃ¡p hoÃ n toÃ n khÃ¡c Ä‘Æ°á»£c phÃ¡t hiá»‡n lÃ m cho Ä‘iá»u nÃ y khÃ´ng cáº§n thiáº¿t.
Tá»‘i Æ°u hÃ³a quÃ¡ má»©c cÃ³ váº» lÃ  khÃ´ng tá»‘t, vÃ¬ xÃ©t trong bá»‘i cáº£nh quáº£n lÃ½ tÃ i nguyÃªn nÃ³i chung lÃ  lÃ£ng phÃ­. Má»™t chá»‰ má»¥c bao trÃ¹m khá»•ng lá»“ (nhÆ°ng khÃ´ng cáº§n thiáº¿t) sáº½ tiÃªu tá»‘n tÃ i nguyÃªn mÃ¡y tÃ­nh cá»§a chÃºng ta báº¥t cá»© khi nÃ o chÃºng ta ghi vÃ o má»™t báº£ng trong thá»i gian dÃ i. Má»™t dá»± Ã¡n viáº¿t láº¡i mÃ£ Ä‘Ã£ Ä‘Æ°á»£c cháº¥p nháº­n cÃ³ thá»ƒ tá»‘n nhiá»u ngÃ y hoáº·c nhiá»u tuáº§n phÃ¡t triá»ƒn vÃ  thá»i gian QA. Cá»‘ gáº¯ng Ä‘iá»u chá»‰nh thÃªm má»™t truy váº¥n vá»‘n Ä‘Ã£ tá»‘t cÃ³ thá»ƒ thu Ä‘Æ°á»£c 3% hiá»‡u suáº¥t, nhÆ°ng pháº£i máº¥t má»™t tuáº§n Ä‘á»• má»“ hÃ´i má»›i Ä‘áº¡t Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³.

Do Ä‘Ã³, má»¥c tiÃªu lÃ  giáº£i quyáº¿t má»™t váº¥n Ä‘á» vÃ  khÃ´ng giáº£i quyáº¿t nÃ³ quÃ¡ má»©c.

### Truy váº¥n lÃ m gÃ¬?
CÃ¢u há»i sá»‘ 1 mÃ  chÃºng ta pháº£i luÃ´n tráº£ lá»i lÃ : Má»¥c Ä‘Ã­ch cá»§a truy váº¥n lÃ  gÃ¬?

* Má»¥c Ä‘Ã­ch cá»§a nÃ³ lÃ  gÃ¬?
* Táº­p há»£p káº¿t quáº£ sáº½ nhÆ° tháº¿ nÃ o?
* Thao tÃ¡c hoáº·c giao diá»‡n ngÆ°á»i dÃ¹ng nÃ o Ä‘ang táº¡o truy váº¥n?
Báº£n cháº¥t Ä‘áº§u tiÃªn lÃ  chÃºng ta muá»‘n lao vÃ o vá»›i má»™t thanh kiáº¿m trÃªn tay vÃ  giáº¿t con rá»“ng cÃ ng nhanh cÃ ng tá»‘t. ChÃºng tÃ´i cÃ³ trong tay má»™t dáº¥u váº¿t Ä‘ang cháº¡y, káº¿ hoáº¡ch thá»±c hiá»‡n vÃ  má»™t Ä‘á»‘ng sá»‘ liá»‡u thá»‘ng kÃª vá» thá»i gian vÃ  IO Ä‘Æ°á»£c thu tháº­p trÆ°á»›c khi nháº­n ra ráº±ng chÃºng tÃ´i khÃ´ng biáº¿t mÃ¬nh Ä‘ang lÃ m gÃ¬ ğŸ™‚

BÆ°á»›c # 1 lÃ  quay láº¡i vÃ  hiá»ƒu truy váº¥n. Má»™t sá»‘ cÃ¢u há»i há»¯u Ã­ch cÃ³ thá»ƒ há»— trá»£ tá»‘i Æ°u hÃ³a:

* Táº­p káº¿t quáº£ lá»›n Ä‘áº¿n má»©c nÃ o? CÃ³ nÃªn gá»“ng mÃ¬nh lÃªn Ä‘á»ƒ tráº£ vá» má»™t triá»‡u hÃ ng, hay chá»‰ má»™t vÃ i hÃ ng?
* CÃ³ báº¥t ká»³ tham sá»‘ nÃ o cÃ³ giÃ¡ trá»‹ giá»›i háº¡n khÃ´ng? NÃ³ cÃ³ thá»ƒ Ä‘Æ¡n giáº£n hÃ³a cÃ´ng viá»‡c cá»§a chÃºng ta báº±ng cÃ¡ch loáº¡i bá» cÃ¡c phÆ°Æ¡ng phÃ¡p nghiÃªn cá»©u.
* Truy váº¥n Ä‘Æ°á»£c thá»±c thi bao lÃ¢u má»™t láº§n? Äiá»u gÃ¬ Ä‘Ã³ xáº£y ra má»™t láº§n má»™t ngÃ y sáº½ Ä‘Æ°á»£c xá»­ lÃ½ ráº¥t khÃ¡c so vá»›i má»™t thá»© xáº£y ra má»—i giÃ¢y.
* CÃ³ giÃ¡ trá»‹ Ä‘áº§u vÃ o nÃ o khÃ´ng há»£p lá»‡ hoáº·c báº¥t thÆ°á»ng cho tháº¥y sá»± cá»‘ á»©ng dá»¥ng khÃ´ng? Má»™t input Ä‘Æ°á»£c Ä‘áº·t thÃ nh NULL, nhÆ°ng khÃ´ng bao giá» nÃªn lÃ  NULL? CÃ³ báº¥t ká»³ input nÃ o khÃ¡c Ä‘Æ°á»£c Ä‘áº·t thÃ nh cÃ¡c giÃ¡ trá»‹ khÃ´ng cÃ³ Ã½ nghÄ©a, mÃ¢u thuáº«n hoáº·c Ä‘i ngÆ°á»£c láº¡i trÆ°á»ng há»£p sá»­ dá»¥ng cá»§a truy váº¥n khÃ´ng?
* CÃ³ báº¥t ká»³ váº¥n Ä‘á» logic, cÃº phÃ¡p hoáº·c tá»‘i Æ°u hÃ³a nÃ o chÃºng ta Ä‘ang pháº£i Ä‘á»‘i máº·t? ChÃºng ta cÃ³ tháº¥y báº¥t ká»³ quáº£ bom hiá»‡u suáº¥t tá»©c thá»i nÃ o sáº½ luÃ´n hoáº¡t Ä‘á»™ng kÃ©m, báº¥t ká»ƒ giÃ¡ trá»‹ tham sá»‘ hoáº·c cÃ¡c biáº¿n nÃ o?
* Hiá»‡u suáº¥t truy váº¥n cháº¥p nháº­n Ä‘Æ°á»£c lÃ  bao nhiÃªu? Truy váº¥n pháº£i nhanh Ä‘áº¿n má»©c nÃ o Ä‘á»ƒ ngÆ°á»i tiÃªu dÃ¹ng hÃ i lÃ²ng? Náº¿u hiá»‡u suáº¥t mÃ¡y chá»§ kÃ©m, cáº§n giáº£m má»©c tiÃªu thá»¥ tÃ i nguyÃªn Ä‘áº¿n má»©c nÃ o Ä‘á»ƒ cÃ³ thá»ƒ cháº¥p nháº­n Ä‘Æ°á»£c? Cuá»‘i cÃ¹ng, hiá»‡u suáº¥t hiá»‡n táº¡i cá»§a truy váº¥n lÃ  gÃ¬? Äiá»u nÃ y sáº½ cung cáº¥p Ä‘Æ°á»ng cÆ¡ sá»Ÿ Ä‘á»ƒ chÃºng ta biáº¿t má»©c Ä‘á»™ cáº§n thiáº¿t pháº£i cáº£i thiá»‡n.
Báº±ng cÃ¡ch dá»«ng láº¡i vÃ  há»i nhá»¯ng cÃ¢u há»i nÃ y trÆ°á»›c khi tá»‘i Æ°u hÃ³a má»™t truy váº¥n, ta cÃ³ thá»ƒ trÃ¡nh Ä‘Æ°á»£c tÃ¬nh huá»‘ng khÃ³ chá»‹u khi dÃ nh hÃ ng giá» Ä‘á»ƒ thu tháº­p dá»¯ liá»‡u vá» má»™t truy váº¥n chá»‰ Ä‘á»ƒ khÃ´ng hiá»ƒu Ä‘áº§y Ä‘á»§ vá» cÃ¡ch sá»­ dá»¥ng nÃ³. Theo nhiá»u cÃ¡ch, tá»‘i Æ°u hÃ³a truy váº¥n vÃ  thiáº¿t káº¿ cÆ¡ sá»Ÿ dá»¯ liá»‡u buá»™c chÃºng ta pháº£i há»i nhiá»u cÃ¢u há»i giá»‘ng nhau.

Káº¿t quáº£ cá»§a tá»« viá»‡c tráº£ lá»i bá»• sung cÃ¡c cÃ¢u há»i nÃ y thÆ°á»ng sáº½ dáº«n chÃºng ta Ä‘áº¿n cÃ¡c giáº£i phÃ¡p sÃ¡ng táº¡o hÆ¡n. CÃ³ thá»ƒ khÃ´ng cáº§n chá»‰ má»¥c má»›i vÃ  chÃºng ta cÃ³ thá»ƒ chia má»™t truy váº¥n lá»›n thÃ nh má»™t vÃ i truy váº¥n nhá» hÆ¡n. CÃ³ thá»ƒ má»™t giÃ¡ trá»‹ tham sá»‘ khÃ´ng chÃ­nh xÃ¡c vÃ  cÃ³ sá»± cá»‘ trong mÃ£ hoáº·c giao diá»‡n ngÆ°á»i dÃ¹ng cáº§n Ä‘Æ°á»£c giáº£i quyáº¿t. CÃ³ thá»ƒ bÃ¡o cÃ¡o Ä‘Æ°á»£c cháº¡y má»—i tuáº§n má»™t láº§n, vÃ¬ váº­y chÃºng tÃ´i cÃ³ thá»ƒ lÆ°u trÆ°á»›c bá»™ dá»¯ liá»‡u vÃ o bá»™ nhá»› cache vÃ  gá»­i káº¿t quáº£ Ä‘áº¿n email, trang tá»•ng quan hoáº·c tá»‡p, thay vÃ¬ buá»™c ngÆ°á»i dÃ¹ng pháº£i Ä‘á»£i 10 phÃºt cho nÃ³ tÆ°Æ¡ng tÃ¡c.


### TrÃ¬nh Tá»‘i Æ°u hoÃ¡ Truy váº¥n lÃ m gÃ¬?
Má»i truy váº¥n Ä‘á»u tuÃ¢n theo cÃ¹ng má»™t quy trÃ¬nh cÆ¡ báº£n tá»« TSQL Ä‘áº¿n khi hoÃ n thÃ nh viá»‡c thá»±c thi trÃªn SQL Server:

![](https://images.viblo.asia/137727b6-d163-4ce0-b5bb-499d0e4f28f6.png)

**Parsing - PhÃ¢n tÃ­ch cÃº phÃ¡p** lÃ  quÃ¡ trÃ¬nh kiá»ƒm tra cÃº phÃ¡p truy váº¥n. CÃ¡c tá»« khÃ³a cÃ³ há»£p lá»‡ khÃ´ng vÃ  cÃ¡c quy táº¯c cá»§a ngÃ´n ngá»¯ TSQL cÃ³ Ä‘Æ°á»£c tuÃ¢n thá»§ má»™t cÃ¡ch chÃ­nh xÃ¡c hay khÃ´ng. Náº¿u báº¡n máº¯c lá»—i chÃ­nh táº£, Ä‘áº·t tÃªn cá»™t báº±ng tá»« dÃ nh riÃªng hoáº·c quÃªn dáº¥u cháº¥m pháº©y trÆ°á»›c biá»ƒu thá»©c báº£ng thÃ´ng thÆ°á»ng, Ä‘Ã¢y lÃ  nÆ¡i báº¡n sáº½ nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o lá»—i thÃ´ng bÃ¡o cho báº¡n vá» nhá»¯ng váº¥n Ä‘á» Ä‘Ã³.

**Binding** kiá»ƒm tra táº¥t cáº£ cÃ¡c Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c tham chiáº¿u trong TQL cá»§a báº¡n so vá»›i danh má»¥c há»‡ thá»‘ng vÃ  báº¥t ká»³ Ä‘á»‘i tÆ°á»£ng táº¡m thá»i nÃ o Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh trong code cá»§a báº¡n Ä‘á»ƒ xÃ¡c Ä‘á»‹nh xem chÃºng cÃ³ há»£p lá»‡ vÃ  Ä‘Æ°á»£c tham chiáº¿u chÃ­nh xÃ¡c hay khÃ´ng. ThÃ´ng tin vá» cÃ¡c Ä‘á»‘i tÆ°á»£ng nÃ y Ä‘Æ°á»£c truy xuáº¥t, cháº³ng háº¡n nhÆ° kiá»ƒu dá»¯ liá»‡u, rÃ ng buá»™c vÃ  liá»‡u má»™t cá»™t cÃ³ cho phÃ©p NULL hay khÃ´ng. Káº¿t quáº£ cá»§a bÆ°á»›c nÃ y lÃ  má»™t cÃ¢y truy váº¥n bao gá»“m má»™t danh sÃ¡ch cÆ¡ báº£n cá»§a cÃ¡c quy trÃ¬nh cáº§n thiáº¿t Ä‘á»ƒ thá»±c hiá»‡n truy váº¥n. Äiá»u nÃ y cung cáº¥p cÃ¡c hÆ°á»›ng dáº«n cÆ¡ báº£n, nhÆ°ng chÆ°a bao gá»“m cÃ¡c chi tiáº¿t cá»¥ thá»ƒ, cháº³ng háº¡n nhÆ° láº­p chá»‰ má»¥c hoáº·c káº¿t há»£p nÃ o Ä‘á»ƒ sá»­ dá»¥ng.

**Optimization - Tá»‘i Æ°u hÃ³a** lÃ  quÃ¡ trÃ¬nh mÃ  chÃºng ta sáº½ tham kháº£o thÆ°á»ng xuyÃªn nháº¥t á»Ÿ Ä‘Ã¢y. TrÃ¬nh tá»‘i Æ°u hÃ³a hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± nhÆ° mÃ¡y tÃ­nh chÆ¡i cá» vua (hoáº·c báº¥t ká»³ trÃ² chÆ¡i nÃ o). NÃ³ cáº§n pháº£i xem xÃ©t má»™t sá»‘ lÆ°á»£ng lá»›n cÃ¡c nÆ°á»›c Ä‘i cÃ ng nhanh cÃ ng tá»‘t, loáº¡i bá» cÃ¡c lá»±a chá»n kÃ©m vÃ  káº¿t thÃºc vá»›i nÆ°á»›c Ä‘i tá»‘t nháº¥t cÃ³ thá»ƒ. Táº¡i báº¥t ká»³ thá»i Ä‘iá»ƒm nÃ o, mÃ¡y tÃ­nh cÃ³ thá»ƒ cÃ³ hÃ ng triá»‡u tá»• há»£p cÃ¡c bÆ°á»›c di chuyá»ƒn, trong Ä‘Ã³ chá»‰ má»™t sá»‘ Ã­t cÃ¡c bÆ°á»›c di chuyá»ƒn tá»‘t nháº¥t cÃ³ thá»ƒ. Báº¥t cá»© ai Ä‘Ã£ chÆ¡i cá» vua vá»›i mÃ¡y tÃ­nh Ä‘á»u biáº¿t ráº±ng mÃ¡y tÃ­nh cÃ ng Ã­t thá»i gian thÃ¬ cÃ ng dá»… máº¯c lá»—i.

Trong tháº¿ giá»›i cá»§a SQL Server, chÃºng ta sáº½ nÃ³i vá» cÃ¡c káº¿ hoáº¡ch thá»±c thi thay vÃ¬ cÃ¡c nÆ°á»›c cá». Káº¿ hoáº¡ch thá»±c thi lÃ  táº­p há»£p cÃ¡c bÆ°á»›c cá»¥ thá»ƒ mÃ  cÃ´ng cá»¥ thá»±c thi sáº½ tuÃ¢n theo Ä‘á»ƒ xá»­ lÃ½ má»™t truy váº¥n. Má»i truy váº¥n Ä‘á»u cÃ³ nhiá»u lá»±a chá»n Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c káº¿ hoáº¡ch thá»±c thi Ä‘Ã³ vÃ  pháº£i thá»±c hiá»‡n trong má»™t khoáº£ng thá»i gian ráº¥t ngáº¯n.

Nhá»¯ng lá»±a chá»n nÃ y bao gá»“m cÃ¡c cÃ¢u há»i nhÆ°:

* Thá»© tá»± cÃ¡c báº£ng nÃªn Ä‘Æ°á»£c join?
* Nhá»¯ng phÃ©p join nÃ o nÃªn Ä‘Æ°á»£c Ã¡p dá»¥ng cho cÃ¡c báº£ng?
* Nhá»¯ng chá»‰ má»¥c nÃ o nÃªn Ä‘Æ°á»£c sá»­ dá»¥ng?
* CÃ³ lá»£i Ã­ch nÃ o trong viá»‡c lÆ°u dá»¯ liá»‡u vÃ o bá»™ nhá»› Ä‘á»‡m Ä‘á»ƒ sá»­ dá»¥ng trong tÆ°Æ¡ng lai khÃ´ng?
Báº¥t ká»³ káº¿ hoáº¡ch thá»±c thi nÃ o Ä‘Æ°á»£c trÃ¬nh tá»‘i Æ°u hÃ³a xem xÃ©t Ä‘á»u pháº£i tráº£ láº¡i káº¿t quáº£ giá»‘ng nhau, nhÆ°ng hiá»‡u suáº¥t cá»§a má»—i káº¿ hoáº¡ch cÃ³ thá»ƒ khÃ¡c nhau do nhá»¯ng cÃ¢u há»i á»Ÿ trÃªn (vÃ  nhiá»u hÆ¡n ná»¯a!).

Tá»‘i Æ°u hÃ³a truy váº¥n lÃ  má»™t hoáº¡t Ä‘á»™ng sá»­ dá»¥ng nhiá»u CPU. QuÃ¡ trÃ¬nh sÃ ng lá»c cÃ¡c káº¿ hoáº¡ch Ä‘Ã²i há»i tÃ i nguyÃªn mÃ¡y tÃ­nh Ä‘Ã¡ng ká»ƒ vÃ  Ä‘á»ƒ tÃ¬m ra káº¿ hoáº¡ch tá»‘t nháº¥t cÃ³ thá»ƒ cáº§n nhiá»u thá»i gian hÆ¡n kháº£ nÄƒng hiá»‡n cÃ³. Do Ä‘Ã³, pháº£i duy trÃ¬ sá»± cÃ¢n báº±ng giá»¯a cÃ¡c tÃ i nguyÃªn cáº§n thiáº¿t Ä‘á»ƒ tá»‘i Æ°u hÃ³a truy váº¥n, cÃ¡c tÃ i nguyÃªn cáº§n thiáº¿t Ä‘á»ƒ thá»±c hiá»‡n truy váº¥n vÃ  thá»i gian chÃºng ta pháº£i Ä‘á»£i toÃ n bá»™ quÃ¡ trÃ¬nh hoÃ n táº¥t. Do Ä‘Ã³, trÃ¬nh tá»‘i Æ°u hÃ³a khÃ´ng Ä‘Æ°á»£c xÃ¢y dá»±ng Ä‘á»ƒ chá»n káº¿ hoáº¡ch thá»±c thi tá»‘t nháº¥t mÃ  thay vÃ o Ä‘Ã³ Ä‘á»ƒ tÃ¬m kiáº¿m vÃ  tÃ¬m ra káº¿ hoáº¡ch tá»‘t nháº¥t cÃ³ thá»ƒ sau má»™t khoáº£ng thá»i gian nháº¥t Ä‘á»‹nh trÃ´i qua. NÃ³ cÃ³ thá»ƒ khÃ´ng pháº£i lÃ  káº¿ hoáº¡ch thá»±c thi hoÃ n háº£o, nhÆ°ng chÃºng ta cháº¥p nháº­n ráº±ng Ä‘Ã³ lÃ  má»™t háº¡n cháº¿ vá» cÃ¡ch má»™t quy trÃ¬nh cÃ³ ráº¥t nhiá»u kháº£ nÄƒng pháº£i hoáº¡t Ä‘á»™ng.

Chá»‰ sá»‘ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ káº¿ hoáº¡ch thá»±c thi vÃ  Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh lÃ  chi phÃ­ truy váº¥n. Chi phÃ­ khÃ´ng cÃ³ Ä‘Æ¡n vá»‹ vÃ  lÃ  má»™t thÆ°á»›c Ä‘o tÆ°Æ¡ng Ä‘á»‘i cá»§a cÃ¡c nguá»“n lá»±c cáº§n thiáº¿t Ä‘á»ƒ thá»±c hiá»‡n tá»«ng bÆ°á»›c cá»§a má»™t káº¿ hoáº¡ch thá»±c hiá»‡n. Chi phÃ­ truy váº¥n tá»•ng thá»ƒ lÃ  tá»•ng chi phÃ­ cá»§a má»—i bÆ°á»›c trong má»™t truy váº¥n. Báº¡n cÃ³ thá»ƒ xem cÃ¡c chi phÃ­ nÃ y trong báº¥t ká»³ káº¿ hoáº¡ch thá»±c hiá»‡n nÃ o:

![](https://images.viblo.asia/1fd0108f-e9d2-42a6-8054-a8842858ad0d.png)

Chi phÃ­ cÃ¢y con cho má»—i thÃ nh pháº§n cá»§a truy váº¥n Ä‘Æ°á»£c tÃ­nh toÃ¡n vÃ  sá»­ dá»¥ng Ä‘á»ƒ:

* Loáº¡i bá» káº¿ hoáº¡ch thá»±c hiá»‡n chi phÃ­ cao vÃ  báº¥t ká»³ káº¿ hoáº¡ch tÆ°Æ¡ng tá»± nÃ o khá»i nhÃ³m cÃ¡c káº¿ hoáº¡ch Ä‘Ã£ cÃ³.
* Xáº¿p háº¡ng cÃ¡c káº¿ hoáº¡ch cÃ²n láº¡i dá»±a trÃªn má»©c Ä‘á»™ tháº¥p cá»§a chi phÃ­.

Máº·c dÃ¹ chi phÃ­ truy váº¥n lÃ  má»™t sá»‘ liá»‡u há»¯u Ã­ch Ä‘á»ƒ hiá»ƒu cÃ¡ch SQL Server Ä‘Ã£ tá»‘i Æ°u hÃ³a má»™t truy váº¥n cá»¥ thá»ƒ, Ä‘iá»u quan trá»ng cáº§n nhá»› lÃ  má»¥c Ä‘Ã­ch chÃ­nh cá»§a nÃ³ lÃ  há»— trá»£ trÃ¬nh tá»‘i Æ°u hÃ³a truy váº¥n trong viá»‡c lá»±a chá»n káº¿ hoáº¡ch thá»±c thi tá»‘t. NÃ³ khÃ´ng pháº£i lÃ  thÆ°á»›c Ä‘o trá»±c tiáº¿p cá»§a IO, CPU, bá»™ nhá»›, thá»i lÆ°á»£ng hoáº·c báº¥t ká»³ sá»‘ liá»‡u nÃ o khÃ¡c mÃ  quan trá»ng Ä‘á»‘i vá»›i ngÆ°á»i dÃ¹ng á»©ng dá»¥ng khi chá» quÃ¡ trÃ¬nh thá»±c thi truy váº¥n hoÃ n táº¥t. Chi phÃ­ truy váº¥n tháº¥p cÃ³ thá»ƒ khÃ´ng chá»‰ ra má»™t truy váº¥n nhanh hoáº·c káº¿ hoáº¡ch tá»‘t nháº¥t. NgoÃ i ra, chi phÃ­ truy váº¥n cao Ä‘Ã´i khi cÃ³ thá»ƒ Ä‘Æ°á»£c cháº¥p nháº­n. Do Ä‘Ã³, tá»‘t nháº¥t lÃ  khÃ´ng nÃªn dá»±a nhiá»u vÃ o chi phÃ­ truy váº¥n lÃ m thÆ°á»›c Ä‘o hiá»‡u suáº¥t.

Khi trÃ¬nh tá»‘i Æ°u hÃ³a truy váº¥n lÆ°á»›t qua cÃ¡c káº¿ hoáº¡ch thá»±c thi á»©ng viÃªn, nÃ³ sáº½ xáº¿p háº¡ng chÃºng tá»« chi phÃ­ tháº¥p nháº¥t Ä‘áº¿n chi phÃ­ cao nháº¥t. Cuá»‘i cÃ¹ng, trÃ¬nh tá»‘i Æ°u hÃ³a sáº½ Ä‘áº¡t Ä‘Æ°á»£c má»™t trong cÃ¡c káº¿t luáº­n sau:

* Má»i káº¿ hoáº¡ch thá»±c hiá»‡n Ä‘Ã£ Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ vÃ  lá»±a chá»n tá»‘t nháº¥t.
* KhÃ´ng cÃ³ Ä‘á»§ thá»i gian Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ má»i káº¿ hoáº¡ch vÃ  káº¿ hoáº¡ch tá»‘t nháº¥t cho Ä‘áº¿n nay Ä‘Ã£ Ä‘Æ°á»£c chá»n.
Khi má»™t káº¿ hoáº¡ch thá»±c thi Ä‘Æ°á»£c chá»n, cÃ´ng viá»‡c cá»§a trÃ¬nh tá»‘i Æ°u hÃ³a truy váº¥n Ä‘Ã£ hoÃ n táº¥t vÃ  chÃºng ta cÃ³ thá»ƒ chuyá»ƒn sang bÆ°á»›c cuá»‘i cÃ¹ng cá»§a quÃ¡ trÃ¬nh xá»­ lÃ½ truy váº¥n.

**Execution - Thá»±c hiá»‡n** lÃ  bÆ°á»›c cuá»‘i cÃ¹ng. SQL Server nháº­n káº¿ hoáº¡ch thá»±c thi Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh trong bÆ°á»›c tá»‘i Æ°u hÃ³a vÃ  lÃ m theo cÃ¡c hÆ°á»›ng dáº«n Ä‘Ã³ Ä‘á»ƒ thá»±c hiá»‡n truy váº¥n.

LÆ°u Ã½ vá» viá»‡c **tÃ¡i sá»­ dá»¥ng káº¿ hoáº¡ch thá»±c thi (plan reuse)**: Bá»Ÿi vÃ¬ tá»‘i Æ°u hÃ³a lÃ  má»™t quÃ¡ trÃ¬nh vá»‘n dÄ© ráº¥t tá»‘n kÃ©m, SQL Server duy trÃ¬ má»™t bá»™ Ä‘á»‡m áº©n káº¿ hoáº¡ch thá»±c thi Ä‘á»ƒ lÆ°u trá»¯ thÃ´ng tin chi tiáº¿t vá» tá»«ng truy váº¥n Ä‘Æ°á»£c thá»±c thi trÃªn mÃ¡y chá»§ vÃ  káº¿ hoáº¡ch Ä‘Ã£ Ä‘Æ°á»£c chá»n cho nÃ³. ThÃ´ng thÆ°á»ng, cÆ¡ sá»Ÿ dá»¯ liá»‡u tráº£i qua cÃ¹ng má»™t truy váº¥n Ä‘Æ°á»£c thá»±c hiá»‡n láº·p Ä‘i láº·p láº¡i, cháº³ng háº¡n nhÆ° tÃ¬m kiáº¿m trÃªn web, vá»‹ trÃ­ Ä‘áº·t hÃ ng hoáº·c bÃ i Ä‘Äƒng trÃªn máº¡ng xÃ£ há»™i. Viá»‡c sá»­ dá»¥ng láº¡i cho phÃ©p chÃºng tÃ´i trÃ¡nh quÃ¡ trÃ¬nh tá»‘i Æ°u hÃ³a tá»‘n kÃ©m vÃ  dá»±a vÃ o cÃ´ng viá»‡c chÃºng tÃ´i Ä‘Ã£ thá»±c hiá»‡n trÆ°á»›c Ä‘Ã³ Ä‘á»ƒ tá»‘i Æ°u hÃ³a má»™t truy váº¥n.

Khi má»™t truy váº¥n Ä‘Æ°á»£c thá»±c hiá»‡n mÃ  Ä‘Ã£ cÃ³ má»™t káº¿ hoáº¡ch há»£p lá»‡ trong bá»™ nhá»› cache, thÃ¬ káº¿ hoáº¡ch Ä‘Ã³ sáº½ Ä‘Æ°á»£c chá»n, thay vÃ¬ tráº£i qua quÃ¡ trÃ¬nh xÃ¢y dá»±ng má»™t káº¿ hoáº¡ch má»›i. Äiá»u nÃ y giÃºp tiáº¿t kiá»‡m tÃ i nguyÃªn mÃ¡y tÃ­nh vÃ  tÄƒng tá»‘c Ä‘á»™ thá»±c thi truy váº¥n. 

### CÃ¡c chá»§ Ä‘á» phá»• biáº¿n trong tá»‘i Æ°u hÃ³a truy váº¥n
Vá»›i pháº§n giá»›i thiá»‡u sÆ¡ lÆ°á»£c, chÃºng ta hÃ£y Ä‘i sÃ¢u vÃ o tá»‘i Æ°u hÃ³a! Sau Ä‘Ã¢y lÃ  danh sÃ¡ch cÃ¡c sá»‘ liá»‡u phá»• biáº¿n nháº¥t sáº½ há»— trá»£ tá»‘i Æ°u hÃ³a. Khi cÃ¡c khÃ¡i niá»‡m cÆ¡ báº£n khÃ´ng thá»±c hiá»‡n Ä‘Æ°á»£c, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c quy trÃ¬nh cÆ¡ báº£n nÃ y Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡c thá»§ thuáº­t, máº¹o vÃ  cÃ¡c máº«u trong cáº¥u trÃºc truy váº¥n cÃ³ thá»ƒ chá»‰ ra hiá»‡u suáº¥t kÃ©m.

#### Index scan - QuÃ©t chá»‰ má»¥c 
Dá»¯ liá»‡u cÃ³ thá»ƒ Ä‘Æ°á»£c truy cáº­p tá»« má»™t chá»‰ má»¥c thÃ´ng qua scan hoáº·c tÃ¬m kiáº¿m. TÃ¬m kiáº¿m lÃ  má»™t lá»±a chá»n cÃ³ má»¥c tiÃªu cÃ¡c hÃ ng tá»« báº£ng dá»±a trÃªn má»™t bá»™ lá»c háº¹p (thÆ°á»ng). Scan lÃ  khi toÃ n bá»™ chá»‰ má»¥c Ä‘Æ°á»£c tÃ¬m kiáº¿m Ä‘á»ƒ tráº£ vá» dá»¯ liá»‡u Ä‘Æ°á»£c yÃªu cáº§u. Náº¿u má»™t báº£ng chá»©a má»™t triá»‡u hÃ ng, thÃ¬ quÃ¡ trÃ¬nh scan sáº½ cáº§n pháº£i duyá»‡t qua táº¥t cáº£ triá»‡u hÃ ng Ä‘á»ƒ phá»¥c vá»¥ truy váº¥n. Má»™t tÃ¬m kiáº¿m cá»§a cÃ¹ng má»™t báº£ng cÃ³ thá»ƒ duyá»‡t nhanh cÃ¢y nhá»‹ phÃ¢n cá»§a chá»‰ má»¥c Ä‘á»ƒ chá»‰ tráº£ vá» dá»¯ liá»‡u cáº§n thiáº¿t mÃ  khÃ´ng cáº§n pháº£i kiá»ƒm tra toÃ n bá»™ báº£ng.

Náº¿u cÃ³ nhu cáº§u chÃ­nh Ä‘Ã¡ng Ä‘á»ƒ tráº£ vá» má»™t lÆ°á»£ng lá»›n dá»¯ liá»‡u tá»« má»™t báº£ng, thÃ¬ scan chá»‰ má»¥c cÃ³ thá»ƒ lÃ  thao tÃ¡c chÃ­nh xÃ¡c. Náº¿u chÃºng ta cáº§n tráº£ láº¡i 950.000 hÃ ng tá»« báº£ng má»™t triá»‡u hÃ ng, thÃ¬ viá»‡c scan chá»‰ má»¥c cÃ³ Ã½ nghÄ©a. Náº¿u chÃºng ta chá»‰ cáº§n tráº£ vá» 10 hÃ ng, thÃ¬ má»™t tÃ¬m kiáº¿m sáº½ hiá»‡u quáº£ hÆ¡n nhiá»u.

QuÃ©t chá»‰ má»¥c ráº¥t dá»… phÃ¡t hiá»‡n trong cÃ¡c káº¿ hoáº¡ch thá»±c thi:
```
SELECT
	*
FROM Sales.OrderTracking
INNER JOIN Sales.SalesOrderHeader
ON SalesOrderHeader.SalesOrderID = OrderTracking.SalesOrderID
INNER JOIN Sales.SalesOrderDetail
ON SalesOrderDetail.SalesOrderID = SalesOrderHeader.SalesOrderID
WHERE OrderTracking.EventDateTime = '2014-05-29 00:00:00';
```

![](https://images.viblo.asia/5b4983ac-f45b-4950-90e2-414f692997f1.jpeg)

ChÃºng ta cÃ³ thá»ƒ nhanh chÃ³ng phÃ¡t hiá»‡n quÃ¡ trÃ¬nh quÃ©t chá»‰ má»¥c á»Ÿ gÃ³c trÃªn bÃªn pháº£i cá»§a káº¿ hoáº¡ch thá»±c thi. Viá»‡c sá»­ dá»¥ng 90% tÃ i nguyÃªn cá»§a truy váº¥n vÃ  Ä‘Æ°á»£c gáº¯n nhÃ£n lÃ  quÃ©t chá»‰ má»¥c theo cá»¥m nhanh chÃ³ng cho chÃºng tÃ´i biáº¿t Ä‘iá»u gÃ¬ Ä‘ang xáº£y ra á»Ÿ Ä‘Ã¢y. THá»NG KÃŠ IO cÅ©ng cho chÃºng ta tháº¥y má»™t sá»‘ lÆ°á»£ng lá»›n cÃ¡c láº§n Ä‘á»c so vá»›i báº£ng OrderTracking :
![](https://images.viblo.asia/4118497e-eec2-40e9-9dff-3807ff768ff1.jpeg)

Nhiá»u giáº£i phÃ¡p cÃ³ sáºµn khi chÃºng ta Ä‘Ã£ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c má»™t láº§n quÃ©t chá»‰ má»¥c khÃ´ng mong muá»‘n. DÆ°á»›i Ä‘Ã¢y lÃ  danh sÃ¡ch nhanh má»™t sá»‘ suy nghÄ© cáº§n xem xÃ©t khi giáº£i quyáº¿t sá»± cá»‘ quÃ©t chá»‰ má»¥c:

* CÃ³ index nÃ o cÃ³ thá»ƒ xá»­ lÃ½ filter trong truy váº¥n khÃ´ng?
    * Trong vÃ­ dá»¥ nÃ y, cÃ³ index trÃªn EventDateTime khÃ´ng?
* Náº¿u khÃ´ng cÃ³ index nÃ o, chÃºng ta cÃ³ nÃªn táº¡o má»™t index Ä‘á»ƒ cáº£i thiá»‡n hiá»‡u suáº¥t trÃªn truy váº¥n khÃ´ng?
    * Truy váº¥n nÃ y cÃ³ Ä‘Æ°á»£c thá»±c thi thÆ°á»ng xuyÃªn Ä‘á»§ Ä‘á»ƒ Ä‘áº£m báº£o thay Ä‘á»•i nÃ y khÃ´ng? CÃ¡c index cáº£i thiá»‡n tá»‘c Ä‘á»™ Ä‘á»c trÃªn cÃ¡c truy váº¥n, nhÆ°ng sáº½ lÃ m giáº£m tá»‘c Ä‘á»™ ghi, vÃ¬ váº­y chÃºng ta nÃªn thÃªm chÃºng má»™t cÃ¡ch tháº­n trá»ng.
* ÄÃ¢y cÃ³ pháº£i lÃ  filter há»£p lá»‡ khÃ´ng? Cá»™t nÃ y cÃ³ pháº£i lÃ  cá»™t mÃ  khÃ´ng ai nÃªn filter khÃ´ng?
    * ChÃºng ta cÃ³ nÃªn tháº£o luáº­n váº¥n Ä‘á» nÃ y vá»›i nhá»¯ng ngÆ°á»i chá»‹u trÃ¡ch nhiá»‡m vá» á»©ng dá»¥ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡ch tá»‘t hÆ¡n Ä‘á»ƒ tÃ¬m kiáº¿m dá»¯ liá»‡u nÃ y khÃ´ng?
* CÃ³ má»™t sá»‘ máº«u truy váº¥n khÃ¡c Ä‘ang gÃ¢y ra quÃ¡ trÃ¬nh quÃ©t chá»‰ má»¥c mÃ  chÃºng ta cÃ³ thá»ƒ giáº£i quyáº¿t khÃ´ng? ChÃºng ta sáº½ cá»‘ gáº¯ng tráº£ lá»i cáº·n káº½ hÆ¡n cÃ¢u há»i nÃ y dÆ°á»›i Ä‘Ã¢y. Náº¿u cÃ³ má»™t chá»‰ má»¥c trÃªn cá»™t filter ( EventDataTime trong vÃ­ dá»¥ nÃ y), thÃ¬ cÃ³ thá»ƒ cÃ³ má»™t sá»‘ trÃ² tai quÃ¡i khÃ¡c á»Ÿ Ä‘Ã¢y cáº§n chÃºng ta chÃº Ã½!
* CÃ³ pháº£i truy váº¥n mÃ  khÃ´ng cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ trÃ¡nh bá»‹ quÃ©t khÃ´ng?
    * Má»™t sá»‘ filter truy váº¥n lÃ  bao gá»“m táº¥t cáº£ vÃ  cáº§n pháº£i tÃ¬m kiáº¿m toÃ n bá»™ báº£ng. Trong vd trÃªn, náº¿u EventDateTIme xáº£y ra báº±ng â€œ5-29-2014â€ á»Ÿ má»i hÃ ng trong Sales.OrderTracking , thÃ¬ quÃ¡ trÃ¬nh quÃ©t sáº½ Ä‘Æ°á»£c mong Ä‘á»£i. TÆ°Æ¡ng tá»±, náº¿u chÃºng ta thá»±c hiá»‡n tÃ¬m kiáº¿m chuá»—i má», viá»‡c quÃ©t chá»‰ má»¥c sáº½ khÃ³ trÃ¡nh khá»i viá»‡c triá»ƒn khai Chá»‰ má»¥c toÃ n vÄƒn báº£n hoáº·c má»™t sá»‘ tÃ­nh nÄƒng tÆ°Æ¡ng tá»±.
Khi xem qua cÃ¡c vÃ­ dá»¥ khÃ¡c, chÃºng ta sáº½ tÃ¬m tháº¥y nhiá»u cÃ¡ch khÃ¡c nhau Ä‘á»ƒ xÃ¡c Ä‘á»‹nh vÃ  giáº£i quyáº¿t cÃ¡c láº§n quÃ©t chá»‰ má»¥c khÃ´ng mong muá»‘n.

#### CÃ¡c function Ä‘Æ°á»£c bá»c trong JOIN vÃ  WHERE
Má»™t chá»§ Ä‘á» trong tá»‘i Æ°u hÃ³a lÃ  táº­p trung liÃªn tá»¥c vÃ o cÃ¡c phÃ©p JOIN vÃ  má»‡nh Ä‘á» WHERE. VÃ¬ IO nÃ³i chung lÃ  chi phÃ­ lá»›n nháº¥t vÃ  Ä‘Ã¢y lÃ  nhá»¯ng thÃ nh pháº§n truy váº¥n cÃ³ thá»ƒ háº¡n cháº¿ IO nhiá»u nháº¥t, chÃºng ta thÆ°á»ng tÃ¬m tháº¥y nhá»¯ng sai láº§m tá»“i tá»‡ nháº¥t cá»§a mÃ¬nh á»Ÿ Ä‘Ã¢y. ChÃºng ta cÃ³ thá»ƒ chia nhá» táº­p dá»¯ liá»‡u cá»§a mÃ¬nh xuá»‘ng chá»‰ nhá»¯ng hÃ ng chÃºng ta cáº§n cÃ ng nhanh, thÃ¬ viá»‡c thá»±c thi truy váº¥n sáº½ cÃ ng hiá»‡u quáº£!

Khi Ä‘Ã¡nh giÃ¡ má»‡nh Ä‘á» WHERE, báº¥t ká»³ biá»ƒu thá»©c nÃ o liÃªn quan cáº§n pháº£i Ä‘Æ°á»£c giáº£i quyáº¿t trÆ°á»›c khi tráº£ láº¡i dá»¯ liá»‡u cá»§a chÃºng ta. Náº¿u má»™t cá»™t chá»©a cÃ¡c hÃ m xung quanh nÃ³, cháº³ng háº¡n nhÆ° DATEPART, SUBSTRING hoáº·c CONVERT, thÃ¬ cÃ¡c hÃ m nÃ y cÅ©ng sáº½ cáº§n Ä‘Æ°á»£c giáº£i quyáº¿t. Náº¿u hÃ m pháº£i Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ trÆ°á»›c khi thá»±c thi Ä‘á»ƒ xÃ¡c Ä‘á»‹nh táº­p káº¿t quáº£, thÃ¬ toÃ n bá»™ táº­p dá»¯ liá»‡u sáº½ cáº§n Ä‘Æ°á»£c quÃ©t Ä‘á»ƒ hoÃ n thÃ nh Ä‘Ã¡nh giÃ¡ Ä‘Ã³.

HÃ£y xem xÃ©t truy váº¥n sau:
```
SELECT
	Person.BusinessEntityID,
	Person.FirstName,
	Person.LastName,
	Person.MiddleName
FROM Person.Person
WHERE LEFT(Person.LastName, 3) = 'For';
```
Äiá»u nÃ y sáº½ tráº£ vá» báº¥t ká»³ hÃ ng nÃ o tá»« Person cÃ³ há» báº¯t Ä‘áº§u báº±ng â€œForâ€. ÄÃ¢y lÃ  cÃ¡ch truy váº¥n thá»±c hiá»‡n:
![](https://images.viblo.asia/3bab1103-4146-4ac6-b621-dc2e9963b7d8.jpeg)

![](https://images.viblo.asia/5c35f012-5d6c-4ae6-ad8d-afed0d14d679.jpeg)

Máº·c dÃ¹ chá»‰ tráº£ vá» 4 hÃ ng, toÃ n bá»™ chá»‰ má»¥c Ä‘Ã£ Ä‘Æ°á»£c quÃ©t Ä‘á»ƒ tráº£ vá» dá»¯ liá»‡u. LÃ½ do lÃ  viá»‡c sá»­ dá»¥ng LEFT trÃªn Person.LastName . Máº·c dÃ¹ truy váº¥n Ä‘Ãºng vá» máº·t logic vÃ  sáº½ tráº£ vá» dá»¯ liá»‡u chÃºng ta muá»‘n, nhÆ°ng SQL Server sáº½ cáº§n Ä‘Ã¡nh giÃ¡ LEFT so vá»›i má»i hÃ ng trong báº£ng trÆ°á»›c khi cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh hÃ ng nÃ o phÃ¹ há»£p vá»›i bá»™ lá»c. Äiá»u nÃ y buá»™c pháº£i quÃ©t chá»‰ má»¥c, nhÆ°ng may máº¯n lÃ  cÃ³ thá»ƒ trÃ¡nh Ä‘Æ°á»£c má»™t chá»‰ má»¥c!

Khi Ä‘á»‘i máº·t vá»›i cÃ¡c hÃ m trong má»‡nh Ä‘á» WHERE hoáº·c trong má»™t phÃ©p ná»‘i, hÃ£y xem xÃ©t cÃ¡c cÃ¡ch Ä‘á»ƒ chuyá»ƒn hÃ m vÃ o biáº¿n vÃ´ hÆ°á»›ng. NgoÃ i ra, hÃ£y nghÄ© cÃ¡ch viáº¿t láº¡i truy váº¥n theo cÃ¡ch mÃ  cÃ¡c cá»™t trong báº£ng cÃ³ thá»ƒ Ä‘Æ°á»£c giá»¯ sáº¡ch (nghÄ©a lÃ : khÃ´ng cÃ³ chá»©c nÄƒng nÃ o Ä‘Æ°á»£c Ä‘Ã­nh kÃ¨m vá»›i chÃºng!)

Truy váº¥n á»Ÿ trÃªn cÃ³ thá»ƒ Ä‘Æ°á»£c viáº¿t láº¡i Ä‘á»ƒ thá»±c hiá»‡n Ä‘iá»u nÃ y:
```
SELECT
	Person.BusinessEntityID,
	Person.FirstName,
	Person.LastName,
	Person.MiddleName
FROM Person.Person
WHERE Person.LastName LIKE 'For%';
```
Báº±ng cÃ¡ch sá»­ dá»¥ng LIKE vÃ  chuyá»ƒn logic kÃ½ tá»± Ä‘áº¡i diá»‡n thÃ nh chuá»—i kÃ½ tá»±, chÃºng ta Ä‘Ã£ xÃ³a cá»™t LastName , cá»™t nÃ y sáº½ cho phÃ©p SQL Server toÃ n quyá»n truy cáº­p Ä‘á»ƒ tÃ¬m kiáº¿m. ÄÃ¢y lÃ  hiá»‡u suáº¥t chÃºng ta tháº¥y trÃªn phiÃªn báº£n viáº¿t láº¡i:

![](https://images.viblo.asia/29f28b02-d549-4fa2-98da-eb363fc0b806.jpeg)

![](https://images.viblo.asia/b923405b-0e4b-49d1-8957-aa6b02f3c23e.jpeg)

Äiá»u chá»‰nh truy váº¥n tÆ°Æ¡ng Ä‘á»‘i nhá» mÃ  chÃºng ta thá»±c hiá»‡n Ä‘Ã£ cho phÃ©p trÃ¬nh tá»‘i Æ°u hÃ³a truy váº¥n sá»­ dá»¥ng tÃ¬m kiáº¿m chá»‰ má»¥c vÃ  kÃ©o dá»¯ liá»‡u chÃºng ta muá»‘n chá»‰ vá»›i 2 láº§n Ä‘á»c logic, thay vÃ¬ 117.

Chá»§ Ä‘á» cá»§a ká»¹ thuáº­t tá»‘i Æ°u hÃ³a nÃ y lÃ  Ä‘áº£m báº£o ráº±ng cÃ¡c cá»™t Ä‘Æ°á»£c giá»¯ sáº¡ch sáº½! Khi viáº¿t truy váº¥n, hÃ£y thoáº£i mÃ¡i Ä‘áº·t logic string/date/numeric phá»©c táº¡p vÃ o cÃ¡c biáº¿n hoáº·c tham sá»‘ vÃ´ hÆ°á»›ng, nhÆ°ng khÃ´ng Ä‘áº·t trÃªn cá»™t. Náº¿u báº¡n Ä‘ang kháº¯c phá»¥c sá»± cá»‘ má»™t truy váº¥n hoáº¡t Ä‘á»™ng kÃ©m vÃ  cÃ¡c chá»©c nÄƒng thÃ´ng bÃ¡o (há»‡ thá»‘ng hoáº·c do ngÆ°á»i dÃ¹ng xÃ¡c Ä‘á»‹nh) Ä‘Æ°á»£c bao bá»c xung quanh tÃªn cá»™t, thÃ¬ hÃ£y báº¯t Ä‘áº§u nghÄ© cÃ¡ch Ä‘áº©y cÃ¡c chá»©c nÄƒng Ä‘Ã³ vÃ o cÃ¡c pháº§n vÃ´ hÆ°á»›ng khÃ¡c cá»§a truy váº¥n. Äiá»u nÃ y sáº½ cho phÃ©p SQL Server tÃ¬m kiáº¿m cÃ¡c chá»‰ má»¥c, thay vÃ¬ quÃ©t vÃ  do Ä‘Ã³ Ä‘Æ°a ra cÃ¡c quyáº¿t Ä‘á»‹nh hiá»‡u quáº£ nháº¥t cÃ³ thá»ƒ khi thá»±c hiá»‡n truy váº¥n!


#### Implicit Conversions - Chuyá»ƒn Ä‘á»•i ngáº§m Ä‘á»‹nh
TrÆ°á»›c Ä‘Ã³, chÃºng ta Ä‘Ã£ trÃ¬nh bÃ y cÃ¡ch bá»c cÃ¡c hÃ m xung quanh cÃ¡c cá»™t cÃ³ thá»ƒ dáº«n Ä‘áº¿n viá»‡c quÃ©t báº£ng ngoÃ i Ã½ muá»‘n, lÃ m giáº£m hiá»‡u suáº¥t truy váº¥n vÃ  tÄƒng Ä‘á»™ trá»…. Chuyá»ƒn Ä‘á»•i ngáº§m hoáº¡t Ä‘á»™ng theo cÃ¹ng má»™t cÃ¡ch nhÆ°ng bá»‹ che khuáº¥t nhiá»u hÆ¡n.

Khi SQL Server so sÃ¡nh báº¥t ká»³ giÃ¡ trá»‹ nÃ o, nÃ³ cáº§n pháº£i *Ä‘iá»u hÃ²a* cÃ¡c kiá»ƒu dá»¯ liá»‡u. Táº¥t cáº£ cÃ¡c kiá»ƒu dá»¯ liá»‡u Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh má»™t má»©c Ä‘á»™ Æ°u tiÃªn trong SQL Server vÃ  kiá»ƒu dá»¯ liá»‡u nÃ o cÃ³ má»©c Ä‘á»™ Æ°u tiÃªn tháº¥p hÆ¡n sáº½ Ä‘Æ°á»£c tá»± Ä‘á»™ng chuyá»ƒn Ä‘á»•i thÃ nh kiá»ƒu dá»¯ liá»‡u cÃ³ má»©c Ä‘á»™ Æ°u tiÃªn cao hÆ¡n. Äá»ƒ biáº¿t thÃªm thÃ´ng tin vá» quyá»n Æ°u tiÃªn cá»§a toÃ¡n tá»­, hÃ£y xem liÃªn káº¿t á»Ÿ cuá»‘i bÃ i viáº¿t nÃ y chá»©a danh sÃ¡ch Ä‘áº§y Ä‘á»§.

Má»™t sá»‘ chuyá»ƒn Ä‘á»•i cÃ³ thá»ƒ diá»…n ra liá»n máº¡ch mÃ  khÃ´ng cÃ³ báº¥t ká»³ tÃ¡c Ä‘á»™ng nÃ o Ä‘áº¿n hiá»‡u suáº¥t. VÃ­ dá»¥: VARCHAR (50) vÃ  VARCHAR (MAX) cÃ³ thá»ƒ Ä‘Æ°á»£c so sÃ¡nh khÃ´ng cÃ³ váº¥n Ä‘á» gÃ¬. TÆ°Æ¡ng tá»±, má»™t TINYINT vÃ  BIGINT, DATE vÃ  DATETIME, hoáº·c TIME vÃ  má»™t Ä‘áº¡i diá»‡n VARCHAR cá»§a má»™t loáº¡i TIME. Tuy nhiÃªn, khÃ´ng pháº£i táº¥t cáº£ cÃ¡c kiá»ƒu dá»¯ liá»‡u Ä‘á»u cÃ³ thá»ƒ Ä‘Æ°á»£c so sÃ¡nh tá»± Ä‘á»™ng.

HÃ£y xem xÃ©t truy váº¥n SELECT sau Ä‘Ã¢y, Ä‘Æ°á»£c lá»c dá»±a trÃªn má»™t cá»™t Ä‘Æ°á»£c láº­p chá»‰ má»¥c:
```
SELECT
	EMP.BusinessEntityID,
	EMP.LoginID,
	EMP.JobTitle
FROM HumanResources.Employee EMP
WHERE EMP.NationalIDNumber = 658797903;
```
NhÃ¬n lÆ°á»›t qua vÃ  chÃºng ta giáº£ Ä‘á»‹nh ráº±ng truy váº¥n nÃ y sáº½ dáº«n Ä‘áº¿n viá»‡c tÃ¬m kiáº¿m chá»‰ má»¥c vÃ  tráº£ láº¡i dá»¯ liá»‡u cho chÃºng ta khÃ¡ hiá»‡u quáº£. ÄÃ¢y lÃ  hiá»‡u suáº¥t káº¿t quáº£:
![](https://images.viblo.asia/b64e144a-5ac8-4907-8a42-a063facc9c07.jpeg)

![](https://images.viblo.asia/0babd331-2cc8-49ff-b4e3-17f1bc6b2ed7.jpeg)

Máº·c dÃ¹ chá»‰ tÃ¬m kiáº¿m má»™t hÃ ng duy nháº¥t so vá»›i má»™t cá»™t Ä‘Æ°á»£c láº­p chá»‰ má»¥c, chÃºng ta Ä‘Ã£ scan báº£ng. Chuyá»‡n gÃ¬ Ä‘Ã£ xáº£y ra tháº¿? ChÃºng ta nháº­n Ä‘Æ°á»£c má»™t gá»£i Ã½ tá»« káº¿ hoáº¡ch thá»±c thi trong dáº¥u cháº¥m than mÃ u vÃ ng trÃªn cÃ¢u lá»‡nh SELECT:
![](https://images.viblo.asia/0fefba06-83a9-4f55-b764-fa830074b6d8.jpeg)

Di chuá»™t qua toÃ¡n tá»­ sáº½ hiá»ƒn thá»‹ cáº£nh bÃ¡o CONVERT_IMPLICIT. Báº¥t cá»© khi nÃ o chÃºng ta tháº¥y Ä‘iá»u nÃ y, Ä‘Ã³ lÃ  má»™t dáº¥u hiá»‡u cho tháº¥y ráº±ng chÃºng ta Ä‘ang so sÃ¡nh hai kiá»ƒu dá»¯ liá»‡u Ä‘á»§ khÃ¡c biá»‡t vá»›i nhau Ä‘á»ƒ chÃºng khÃ´ng thá»ƒ Ä‘Æ°á»£c chuyá»ƒn Ä‘á»•i tá»± Ä‘á»™ng. Thay vÃ o Ä‘Ã³, SQL Server chuyá»ƒn Ä‘á»•i má»i giÃ¡ trá»‹ Ä‘Æ¡n láº» trong báº£ng trÆ°á»›c khi Ã¡p dá»¥ng bá»™ lá»c.
![](https://images.viblo.asia/dfa4fc1f-7af6-4a1d-b6c7-0af1b69f11fe.png)

Khi chÃºng ta di chuá»™t qua cá»™t NationalIDNumber trong SSMS, chÃºng ta cÃ³ thá»ƒ xÃ¡c nháº­n ráº±ng thá»±c táº¿ nÃ³ lÃ  má»™t NVARCHAR (15). GiÃ¡ trá»‹ mÃ  chÃºng ta Ä‘ang so sÃ¡nh vá»›i nÃ³ lÃ  má»™t sá»‘. Giáº£i phÃ¡p cho váº¥n Ä‘á» nÃ y ráº¥t giá»‘ng vá»›i khi chÃºng ta cÃ³ má»™t hÃ m trÃªn má»™t cá»™t: chuyá»ƒn Ä‘á»•i sang giÃ¡ trá»‹ vÃ´ hÆ°á»›ng, thay vÃ¬ cá»™t. Trong trÆ°á»ng há»£p nÃ y, chÃºng ta sáº½ thay Ä‘á»•i giÃ¡ trá»‹ vÃ´ hÆ°á»›ng 658797903 thÃ nh biá»ƒu diá»…n chuá»—i, '658797903':
```
SELECT
	EMP.BusinessEntityID,
	EMP.LoginID,
	EMP.JobTitle
FROM HumanResources.Employee EMP
WHERE EMP.NationalIDNumber = '658797903'
```
Thay Ä‘á»•i Ä‘Æ¡n giáº£n nÃ y sáº½ thay Ä‘á»•i hoÃ n toÃ n cÃ¡ch trÃ¬nh tá»‘i Æ°u hÃ³a truy váº¥n xá»­ lÃ½ truy váº¥n:
![](https://images.viblo.asia/e38cc39e-3ab4-47c2-a3af-180544742311.jpeg)

![](https://images.viblo.asia/70863dd3-99de-4105-b7f8-b09355f7ec0a.jpeg)

Káº¿t quáº£ lÃ  tÃ¬m kiáº¿m chá»‰ má»¥c thay vÃ¬ quÃ©t, Ã­t IO hÆ¡n vÃ  cáº£nh bÃ¡o chuyá»ƒn Ä‘á»•i ngáº§m khÃ´ng cÃ³ trong káº¿ hoáº¡ch thá»±c thi.

Chuyá»ƒn Ä‘á»•i ngáº§m ráº¥t dá»… phÃ¡t hiá»‡n vÃ¬ báº¡n sáº½ nháº­n Ä‘Æ°á»£c má»™t cáº£nh bÃ¡o ná»•i báº­t tá»« SQL Server trong káº¿ hoáº¡ch thá»±c thi báº¥t cá»© khi nÃ o nÃ³ xáº£y ra. Khi báº¡n Ä‘Ã£ giáº£i quyáº¿t xong váº¥n Ä‘á» nÃ y, báº¡n cÃ³ thá»ƒ kiá»ƒm tra loáº¡i dá»¯ liá»‡u cá»§a cÃ¡c cá»™t Ä‘Æ°á»£c chá»‰ ra trong cáº£nh bÃ¡o vÃ  giáº£i quyáº¿t váº¥n Ä‘á».

### Káº¿t luáº­n
Tá»‘i Æ°u hÃ³a truy váº¥n lÃ  má»™t chá»§ Ä‘á» lá»›n cÃ³ thá»ƒ dá»… dÃ ng trá»Ÿ nÃªn quÃ¡ táº£i náº¿u khÃ´ng cÃ³ sá»± táº­p trung tá»‘t. CÃ¡ch tá»‘t nháº¥t Ä‘á»ƒ tiáº¿p cáº­n váº¥n Ä‘á» hiá»‡u suáº¥t lÃ  tÃ¬m cÃ¡c khu vá»±c trá»ng tÃ¢m cá»¥ thá»ƒ cÃ³ nhiá»u kháº£ nÄƒng lÃ  nguyÃªn nhÃ¢n gÃ¢y ra Ä‘á»™ trá»…. Má»™t thá»§ tá»¥c Ä‘Æ°á»£c lÆ°u trá»¯ cÃ³ thá»ƒ dÃ i 10.000 dÃ²ng, nhÆ°ng chá»‰ cáº§n má»™t dÃ²ng duy nháº¥t cáº§n Ä‘Æ°á»£c giáº£i quyáº¿t Ä‘á»ƒ giáº£i quyáº¿t váº¥n Ä‘á». Trong nhá»¯ng tÃ¬nh huá»‘ng nÃ y, viá»‡c tÃ¬m ra nhá»¯ng pháº§n Ä‘Ã¡ng ngá», tá»‘n kÃ©m, tiÃªu tá»‘n nhiá»u tÃ i nguyÃªn cá»§a táº­p lá»‡nh cÃ³ thá»ƒ nhanh chÃ³ng thu háº¹p tÃ¬m kiáº¿m vÃ  cho phÃ©p giáº£i quyáº¿t má»™t váº¥n Ä‘á» hÆ¡n lÃ  tÃ¬m kiáº¿m nÃ³.

BÃ i viáº¿t nÃ y Ä‘Ã£ cung cáº¥p má»™t Ä‘iá»ƒm khá»Ÿi Ä‘áº§u tá»‘t Ä‘á»ƒ giáº£i quyáº¿t cÃ¡c váº¥n Ä‘á» vá» Ä‘á»™ trá»… vÃ  hiá»‡u suáº¥t. Tá»‘i Æ°u hÃ³a truy váº¥n Ä‘Ã´i khi yÃªu cáº§u tÃ i nguyÃªn bá»• sung, cháº³ng háº¡n nhÆ° thÃªm má»™t chá»‰ má»¥c má»›i nhÆ°ng thÆ°á»ng cÃ³ thá»ƒ káº¿t thÃºc nhÆ° má»™t freebie. Khi cÃ³ thá»ƒ cáº£i thiá»‡n hiá»‡u suáº¥t chá»‰ báº±ng cÃ¡ch viáº¿t láº¡i má»™t truy váº¥n, chÃºng ta giáº£m tiÃªu thá»¥ tÃ i nguyÃªn miá»…n phÃ­ (ngoÃ i thá»i gian cá»§a chÃºng ta). Káº¿t quáº£ lÃ , tá»‘i Æ°u hÃ³a truy váº¥n cÃ³ thá»ƒ lÃ  má»™t nguá»“n tiáº¿t kiá»‡m chi phÃ­ trá»±c tiáº¿p! NgoÃ i viá»‡c tiáº¿t kiá»‡m tiá»n, tÃ i nguyÃªn vÃ  sá»± tá»‰nh tÃ¡o cá»§a nhá»¯ng ngÆ°á»i chá» Ä‘á»£i cÃ¡c truy váº¥n hoÃ n thÃ nh, cÃ³ ráº¥t nhiá»u sá»± hÃ i lÃ²ng Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c báº±ng cÃ¡ch cáº£i thiá»‡n quy trÃ¬nh mÃ  khÃ´ng pháº£i tráº£ thÃªm báº¥t ká»³ chi phÃ­ nÃ o cho báº¥t ká»³ ai khÃ¡c.

Cáº£m Æ¡n báº¡n Ä‘Ã£ Ä‘á»c vÃ  chÃºng ta hÃ£y tiáº¿p tá»¥c lÃ m cho má»i thá»© diá»…n ra nhanh hÆ¡n!

TÃ i liá»‡u tham kháº£o
* [Query optimization techniques in SQL Server: the basics](https://www.sqlshack.com/query-optimization-techniques-in-sql-server-the-basics/)
* [sql-query-optimization-techniques](https://www.syncfusion.com/blogs/post/top-10-sql-query-optimization-techniques.aspx)
* [sql-query-optimization-best-practices-for-improved-performance](https://www.quest.com/community/blogs/b/database-management/posts/sql-query-optimization-best-practices-for-improved-performance)
* [https://intellipaat.com/blog/sql-optimization-techniques/](https://intellipaat.com/blog/sql-optimization-techniques/)