BÃ i viáº¿t gá»‘c Ä‘Æ°á»£c Ä‘Äƒng táº£i táº¡i: [laptrinhb2a.com](https://www.laptrinhb2a.com/)

Náº¿u anh em Ä‘á»ƒ Ã½ thÃ¬ nhiá»u khi ngÃ´n ngá»¯ láº­p trÃ¬nh giá»‘ng nhÆ° ngÆ°á»i yÃªu cá»§a anh em váº­y. CÃ³ nhá»¯ng lÃºc khÃ³ hiá»ƒu vÃ´ cÃ¹ng, vÃ´ lÃ½ vÃ´ cÃ¹ng.

NhÆ°ng mÃ  thá»±c ra Ä‘Ã³ lÃ  khi anh em khÃ´ng chá»‹u hiá»ƒu ngÆ°á»i ta thÃ´i, cÃ²n khi anh em hiá»ƒu há» rá»“i thÃ¬ má»i thá»© láº¡i ráº¥t Ä‘Æ¡n giáº£n. Tháº­m chÃ­ anh em cÃ²n cÃ³ thá»ƒ thao tÃºng cáº£m xÃºc cá»§a há» ná»¯a ğŸ˜ğŸ˜ğŸ˜

Trong bÃ i viáº¿t nÃ y mÃ¬nh sáº½ cÃ¹ng anh em tÃ¬m hiá»ƒu má»™t váº¥n Ä‘á» tÆ°Æ¡ng tá»± nhÆ° váº­y trong ngÃ´n ngá»¯ láº­p trÃ¬nh Java. Tin mÃ¬nh Ä‘i, hÃ£y Ä‘á»c háº¿t bÃ i viáº¿t khÃ´ng tá»‘n 10' cá»§a anh em Ä‘Ã¢u ha!

## 1/ Sao em vÃ´ lÃ½ tháº¿!

CÃ¢u nÃ y mÃ¬nh tin cháº¯c nhiá»u anh em cÃ³ ngÆ°á»i yÃªu mÃ  yÃªu nhau Ä‘Æ°á»£c má»™t thá»i gian rá»“i thÃ¬ Ä‘á»u pháº£i thá»‘t lÃªn Ã­t nháº¥t má»™t láº§n (má»™t sá»± cay cÃº khÃ´ng há» nháº¹ ğŸ˜¤ğŸ˜¤ğŸ˜¤)

Quay láº¡i váº¥n Ä‘á» cá»§a chÃºng ta, bÃ¢y giá» náº¿u khÃ´ng Äƒn gian báº±ng cÃ¡ch cháº¡y code mÃ  dá»±a vÃ o kiáº¿n thá»©c sáºµn cÃ³ thÃ¬ anh em sáº½ chá»n Ä‘Ã¡p Ã¡n nÃ o trong áº£nh bÃªn dÆ°á»›i.

![](https://images.viblo.asia/abe7a644-ba17-48a0-ba68-d8ef04b6a105.png)

Táº¥t nhiÃªn lÃ  vá»›i cÃ¡i tiÃªu Ä‘á» to lÃ¹ lÃ¹ cá»§a bÃ i viáº¿t thÃ¬ cháº¯c anh em cÅ©ng Ä‘oÃ¡n Ä‘Æ°á»£c Ä‘Ã¡p Ã¡n lÃ  C. CÆ¡ mÃ  ká»ƒ cáº£ khi Ä‘oÃ¡n Ä‘Æ°á»£c Ä‘Ã¡p Ã¡n thÃ¬ mÃ¬nh tin cháº¯c nhiá»u anh em váº«n tháº¯c máº¯c sao láº¡i lÃ  C (ai Ä‘Ã³ giáº£i thÃ­ch giÃ¹m tÃ´i vá»›i ğŸ™ƒ)

Äáº¿n Ä‘Ã¢y anh em tháº¥y tÃ´i nÃ³i Ä‘Ãºng chÆ°a, váº­y hÃ£y Ä‘á»c tiáº¿p Ä‘á»ƒ biáº¿t táº¡i sao láº¡i lÃ  C nha.

## 2/ Em khÃ´ng vÃ´ lÃ½, anh má»›i vÃ´ lÃ½!

á»¦a, tÃ´i lÃ m gÃ¬ sai Ä‘Ã¢u mÃ  bÃ  kÃªu tÃ´i vÃ´ lÃ½, má»™t vá»«a hai pháº£i thÃ´i nhÃ© ğŸ˜¤ Rá»“i xong, khi anh em buÃ´ng cÃ¢u nÃ y thÃ¬ xÃ¡c Ä‘á»‹nh Ã´m gá»‘i ra sofa ngá»§ (cÃ²n Ã´m Ä‘Æ°á»£c gá»‘i khÃ´ng thÃ¬ tÃ´i khÃ´ng biáº¿t Ä‘Ã¢u ğŸ˜)

Quay láº¡i vá»›i váº¥n Ä‘á» cá»§a chÃºng ta, Ä‘Ã¡p Ã¡n lÃ  C nghe cÃ³ váº» vÃ´ lÃ½ nhÆ°ng thá»±c ra ngÆ°á»i sai láº¡i chÃ­nh lÃ  anh em láº­p trÃ¬nh viÃªn chÃºng ta. Váº­y chÃºng ta Ä‘Ã£ sai á»Ÿ Ä‘Ã¢u?

**Vá»›i nhá»¯ng anh em chá»n A:** cÃ³ láº½ váº«n chÆ°a náº¯m cháº¯c vá» cÃ¡c kiá»ƒu dá»¯ liá»‡u trong Java, trong Java cÃ³ 2 nhÃ³m kiá»ƒu dá»¯ liá»‡u lÃ  Primitive Types vÃ  Reference Types

Primitive Types (long, int, short, byte, float, double, char, boolean): vá»›i cÃ¡c biáº¿n cÃ³ kiá»ƒu dá»¯ liá»‡u nÃ y thÃ¬ chÃºng ta cÃ³ thá»ƒ so sÃ¡nh giÃ¡ trá»‹ thÃ´ng qua toÃ¡n tá»­ "==" (vÃ¬ giÃ¡ trá»‹ Ä‘Æ°á»£c lÆ°u trá»±c tiáº¿p dÆ°á»›i dáº¡ng cÃ¡c bit nhá»‹ phÃ¢n)

Reference Types (Classes, Interfaces, Enums, Arrays...):

+ Vá»›i cÃ¡c biáº¿n cÃ³ kiá»ƒu dá»¯ liá»‡u nÃ y thÃ¬ báº£n cháº¥t chÃºng khÃ´ng lÆ°u giÃ¡ trá»‹ dÆ°á»›i dáº¡ng bit nhá»‹ phÃ¢n mÃ  chÃºng lÆ°u Ä‘á»‹a chá»‰ vÃ¹ng nhá»› cá»§a Ä‘á»‘i tÆ°á»£ng cÃ³ giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng.

+ VÃ­ dá»¥: Integer x = new Integer(21) vÃ  Integer y = new Integer(21) thÃ¬ báº£n cháº¥t x vÃ  y sáº½ lÆ°u Ä‘á»‹a chá»‰ vÃ¹ng nhá»› nÆ¡i mÃ  hai Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c táº¡o ra thÃ´ng qua hai lá»‡nh new Integer(21)

Váº­y lÃ  anh em chá»n A biáº¿t mÃ¬nh sai á»Ÿ Ä‘Ã¢u rá»“i, cÃ¡c biáº¿n mÃ¬nh dÃ¹ng á»Ÿ Ä‘Ã¢y lÃ  kiá»ƒu Reference Types nÃªn viá»‡c anh em sá»­ dá»¥ng toÃ¡n tá»­ "==" Ä‘á»ƒ so sÃ¡nh lÃ  anh em Ä‘ang so sÃ¡nh hai Ä‘á»‹a chá»‰ Ã´ nhá»› khÃ¡c nhau. VÃ  rÃµ rÃ ng chÃºng sáº½ khÃ´ng thá»ƒ nÃ o báº±ng nhau Ä‘Æ°á»£c.

Náº¿u muá»‘n Ä‘Ãºng anh em pháº£i so sÃ¡nh báº±ng hÃ m equals() nhÆ° sau:

```JAVA
Integer a = 500, b = 500;
System.out.println(a.equals(b)); // true

Integer x = 100, y = 100;
System.out.println(x.equals(y)); // true
```

Váº­y táº¡i sao so sÃ¡nh báº±ng hÃ m equals() láº¡i Ä‘Ãºng thÃ¬ má»i anh em xem code cá»§a hÃ m Ä‘Ã³, báº£n cháº¥t hÃ m nÃ y sáº½ láº¥y ra giÃ¡ trá»‹ cá»§a Ä‘á»‘i tÆ°á»£ng thÃ´ng qua hÃ m intValue() rá»“i Ä‘em so sÃ¡nh hai giÃ¡ trá»‹ Ä‘Ã³ thÃ´i.

```JAVA
public boolean equals(Object obj) {
    if (obj instanceof Integer) {
        return value == ((Integer)obj).intValue();
    }
    return false;
}
```

**Vá»›i nhá»¯ng anh em chá»n B**: mÃ¬nh tin cháº¯c sáº½ ngá»“i rung Ä‘Ã¹i vÃ  nghÄ©:"DÄƒm ba cÃ¢u nÃ y khÃ´ng lÃ m khÃ³ Ä‘Æ°á»£c anh Ä‘Ã¢u ğŸ˜‚ğŸ˜‚ğŸ˜‚"

Äá»ƒ rá»“i khi nghe Ä‘Ã¡p Ã¡n lÃ  C thÃ¬ khÃ´ng phá»¥c, má»Ÿ mÃ¡y lÃªn code rá»“i cháº¡y thá»­... vÃ ... oh no... Sao láº¡i tháº¿ nhá»‰? Sao láº¡i lÃ  C Ä‘Æ°á»£c nhá»‰?

ğŸ‘‰CÃ¢u há»i cá»§a nhá»¯ng anh em chá»n B cÅ©ng chÃ­nh lÃ  chá»§ Ä‘á» mÃ¬nh muá»‘n nÃ³i trong bÃ i viáº¿t nÃ y. Anh em rÃ¡ng Ä‘á»c Ä‘áº¿n cuá»‘i bÃ i Ä‘á»ƒ biáº¿t táº¡i sao nha.

**Vá»›i nhá»¯ng anh em chá»n D**: cháº¯c anh em nhÃ³m nÃ y cÃ³ há» hÃ ng vá»›i TÃ o ThÃ¡o vÃ¬ cÃ³ kiáº¿n thá»©c Ä‘á»ƒ loáº¡i A nhÆ°ng láº¡i Ä‘a nghi vÃ¬ náº¿u chá»n B thÃ¬ game dá»… quÃ¡. ThÃ nh ra 50-50 C vÃ  D, nhÆ°ng láº¡i Ä‘en chá»n Ä‘Ãºng Ä‘Ã¡p Ã¡n sai ğŸ˜†

**Vá»›i nhá»¯ng anh em chá»n C**: trá»« máº¥y anh em khoanh lá»¥i ra thÃ¬ xá»©ng Ä‘Ã¡ng cÃ³ 10 ny háº¿t, Ä‘á»ƒ chá»n Ä‘Æ°á»£c C mÃ¬nh tin lÃ  anh em cÅ©ng pháº£i náº¯m Ä‘Æ°á»£c Java á»Ÿ má»™t má»©c nÃ o Ä‘Ã³.

## 3/ Anh xin lá»—i, anh sai rá»“i!

Khi anh em nháº­n ra:"*NgÆ°á»i yÃªu khÃ´ng sai, anh em sai!*" thÃ¬ mÃ¬nh tin cháº¯c anh em cÅ©ng Ä‘Ã£ hiá»ƒu Ä‘Æ°á»£c táº¡i sao chá»n B láº¡i sai.

CÃ¢u há»i lÃ  náº¿u káº¿t quáº£ Ä‘áº§u tiÃªn tráº£ vá» false vÃ¬ chÃºng Ä‘ang trá» Ä‘áº¿n hai object khÃ¡c nhau. Váº­y thÃ¬ káº¿t quáº£ thá»© 2 tráº£ vá» true vÃ¬ chÃºng Ä‘ang trá» Ä‘áº¿n cÃ¹ng má»™t object?

Äá»ƒ tráº£ lá»i Ä‘Æ°á»£c cÃ¢u há»i nÃ y chÃºng ta pháº£i má»• xáº» lá»›p Integer.java má»™t chÃºt. Trong lá»›p nÃ y cÃ³ má»™t lá»›p lÃ  IntegerCache nhÆ° sau:

```JAVA
/**
 * Cache to support the object identity semantics of autoboxing for values between
 * -128 and 127 (inclusive) as required by JLS.
 *
 * The cache is initialized on first usage.  The size of the cache
 * may be controlled by the {@code -XX:AutoBoxCacheMax=<size>} option.
 * During VM initialization, java.lang.Integer.IntegerCache.high property
 * may be set and saved in the private system properties in the
 * jdk.internal.misc.VM class.
 */
	 
private static class IntegerCache {
    static final int low = -128;
    static final int high;
    static final Integer cache[];

    static {
        // high value may be configured by property
        int h = 127;
        String integerCacheHighPropValue =
                VM.getSavedProperty("java.lang.Integer.IntegerCache.high");
        if (integerCacheHighPropValue != null) {
            try {
                int i = parseInt(integerCacheHighPropValue);
                i = Math.max(i, 127);
                // Maximum array size is Integer.MAX_VALUE
                h = Math.min(i, Integer.MAX_VALUE - (-low) -1);
            } catch( NumberFormatException nfe) {
                // If the property cannot be parsed into an int, ignore it.
            }
        }
        high = h;

        cache = new Integer[(high - low) + 1];
        int j = low;
        for(int k = 0; k < cache.length; k++)
            cache[k] = new Integer(j++);

        // range [-128, 127] must be interned (JLS7 5.1.7)
        assert Integer.IntegerCache.high >= 127;
    }

    private IntegerCache() {}
}
```

CÃ¡c báº¡n hÃ£y Ä‘á»ƒ Ã½ mÃ´ táº£ cá»§a lá»›p nÃ y: "***Cache to support the object identity semantics of autoboxing for values between -128 and 127 (inclusive) as required by JLS***"

CÃ³ nghÄ©a lÃ  khi báº¡n khai bÃ¡o cÃ¡c sá»‘ nguyÃªn (kiá»ƒu Integer) trong khoáº£ng tá»« **-128 tá»›i 127** thÃ¬ chÃºng sáº½ Ä‘Æ°á»£c lÆ°u vÃ o cache.

Cá»¥ thá»ƒ lÃ  náº¿u nhÆ° báº¡n khai bÃ¡o Integer x = 100 thÃ¬ báº£n cháº¥t nÃ³ lÃ  Integer x = Integer.valueOf(100). Tá»± dÆ°ng lÃ²i Ä‘Ã¢u ra cÃ¡i hÃ m valueOf() váº­y? ThÃ¬ cÅ©ng á»Ÿ trong lá»›p Integer.java luÃ´n:

```JAVA
@HotSpotIntrinsicCandidate
public static Integer valueOf(int i) {
    if (i >= Integer.IntegerCache.low && i <= Integer.IntegerCache.high)
        return Integer.IntegerCache.cache[i + (-Integer.IntegerCache.low)];
    return new Integer(i);
}
```

NhÃ¬n vÃ o hÃ m nÃ y ta tháº¥y ráº±ng cÃ¡c sá»‘ nguyÃªn trong vÃ¹ng cache (máº·c Ä‘á»‹nh lÃ  tá»« -128 Ä‘áº¿n 127) sáº½ Ä‘Æ°á»£c tráº£ vá» cÃ¹ng má»™t Ä‘á»‘i tÆ°á»£ng. VÃ  Ä‘Ã³ cÅ©ng lÃ  lÃ½ do táº¡i sao káº¿t quáº£ thá»© 2 láº¡i tráº£ vá» true.

CÆ¡ mÃ  cache lÃ m chá»‹ váº­y? Sao láº¡i cache tá»« -128 Ä‘áº¿n 127 mÃ  khÃ´ng pháº£i khoáº£ng khÃ¡c?

Tráº£ lá»i cho cÃ¢u há»i "lÃ m chá»‹ váº­y?" thÃ¬ anh em cháº¯c cÅ©ng biáº¿t tÃ¡c dá»¥ng cá»§a viá»‡c cache rá»“i. NÃ³ giÃºp chÃºng ta tiáº¿t kiá»‡m khÃ´ng gian bá»™ nhá»› khi pháº£i táº¡o ra quÃ¡ nhiá»u Ä‘á»‘i tÆ°á»£ng cÃ³ giÃ¡ trá»‹ giá»‘ng nhau.

CÃ²n vá» viá»‡c sao láº¡i chá»‰ cache tá»« -128 Ä‘áº¿n 127 thÃ¬ nguyÃªn nhÃ¢n Ä‘Ã¢y lÃ  khoáº£ng giÃ¡ trá»‹ Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u vá»›i kiá»ƒu sá»‘ nguyÃªn (cháº¯c máº¥y bÃ¡c thá»‘ng kÃª tháº¥y váº­y!) nÃªn chá»n máº·c Ä‘á»‹nh khoáº£ng nÃ y. 

HÆ¡n ná»¯a náº¿u cache toÃ n bá»™ khoáº£ng sá»‘ nguyÃªn thÃ¬ cÅ©ng pháº£i sá»­ dá»¥ng quÃ¡ nhiá»u bá»™ nhá»›. ChÃ­nh vÃ¬ váº­y chá»n cache má»™t khoáº£ng cÃ³ cÃ¡c giÃ¡ trá»‹ Ä‘Æ°á»£c dÃ¹ng nhiá»u lÃ  má»™t Ã½ tÆ°á»Ÿng ráº¥t hay.

Note: vá»›i cÃ¡c kiá»ƒu dá»¯ liá»‡u tham chiáº¿u khÃ¡c (Long, Short...) thÃ¬ cÅ©ng cÃ³ cÆ¡ cháº¿ cache tÆ°Æ¡ng tá»± (khoáº£ng cache cÃ³ thá»ƒ nhau). Anh em tá»± tÃ¬m hiá»ƒu thÃªm nhÃ©!

## 4/ Tháº¿ Ä‘á»ƒ trÃ  sá»¯a nÃ³i thay lá»i anh váº­y!

Okay, biáº¿t mÃ¬nh sai, nháº­n sai rá»“i thÃ¬ anh em pháº£i hÃ nh Ä‘á»™ng Ä‘á»ƒ ngÆ°á»i ta thá»±c sá»± háº¿t giáº­n. MÃ  cÃ¡ch tá»‘t nháº¥t lÃ  Ä‘Ã¡nh vÃ o cáº£m xÃºc, váº­y cÃ¡i gÃ¬ táº¡o ra cáº£m xÃºc? Äá»“ Äƒn chá»© gÃ¬ ná»¯a ğŸ˜ğŸ˜ğŸ˜

TÆ°Æ¡ng tá»± vá»›i váº¥n Ä‘á» cá»§a chÃºng ta, á»Ÿ Ä‘Ã¢y mÃ¬nh cÃ³ thá»ƒ sá»­ dá»¥ng Reflection API trong Java Ä‘á»ƒ thay Ä‘á»•i káº¿t quáº£ cá»§a phÃ©p tÃ­nh nhÆ° sau:

```JAVA
public static void main(String[] args) {
    try {
        Class cache = Integer.class.getDeclaredClasses()[0]; // (1)
        Field fieldCache = cache.getDeclaredField("cache"); // (2)
        fieldCache.setAccessible(true); // (3)
        Integer[] newCache = (Integer[]) fieldCache.get(cache); // (4)

        // (5)
        int idx0 = 128; // index cá»§a 0
        int idx1 = 129; // index cá»§a 1
        newCache[idx0] = newCache[idx1];

        Integer a = 0;
        Integer b = 1;

        System.out.println(a + b);
    }catch (NoSuchFieldException | IllegalAccessException ex ) {
        ex.printStackTrace();
    }
}
```

Káº¿t quáº£ khi cÃ¡c báº¡n cháº¡y chÆ°Æ¡ng trÃ¬nh sáº½ lÃ : 2 (áº£o tháº­t Ä‘Ãºng khÃ´ng!). Giáº£i thÃ­ch chÃºt ha!

(1) -  MÃ¬nh dÃ¹ng biáº¿n cache tham chiáº¿u tá»›i lá»›p IntegerCache bÃªn trong lá»›p Integer.java

(2) -  Sau Ä‘Ã³ táº¡o field cÃ³ tÃªn lÃ  fieldCache tham chiáº¿u tá»›i field cÃ³ tÃªn lÃ  cache trong class IntegerCache.

(3) -  Tiáº¿p Ä‘Ã³ mÃ¬nh set quyá»n truy cáº­p cho field nÃ y.

(4) -  VÃ  rá»“i mÃ¬nh láº¥y Ä‘Æ°á»£c máº£ng cÃ¡c sá»‘ nguyÃªn Ä‘Æ°á»£c cache (lÃ  máº£ng sá»‘ nguyÃªn tá»« -128 Ä‘áº¿n 127)

(5) -  Cuá»‘i cÃ¹ng mÃ¬nh chá»‰ viá»‡c thay Ä‘á»•i giÃ¡ trá»‹ cá»§a hai pháº§n tá»­ mÃ¬nh mong muá»‘n thÃ´ng qua index cá»§a chÃºng trong máº£ng.

Trong Ä‘oáº¡n code bÃªn trÃªn thá»±c ra khai bÃ¡o Integer a = 0 nhÆ°ng báº£n cháº¥t biáº¿n a Ä‘Ã£ khÃ´ng cÃ²n trá» Ä‘áº¿n vÃ¹ng nhá»› cÃ³ chá»© giÃ¡ trá»‹ lÃ  0 ná»¯a mÃ  bá»‹ trá» Ä‘áº¿n vÃ¹ng nhá»› cÃ³ giÃ¡ trá»‹ lÃ  1. Dáº«n Ä‘áº¿n káº¿t quáº£ cá»§a phÃ©p tÃ­nh lÃ  2 chá»© khÃ´ng pháº£i lÃ  1.

## 5/ Káº¿t luáº­n?

Hi vá»ng qua bÃ i viáº¿t ngáº¯n nÃ y cÃ¹ng vá»›i má»™t chÃºt liÃªn tÆ°á»Ÿng nháº¹ nhÃ ng mÃ  thá»±c táº¿ cÃ³ thá»ƒ giÃºp anh em rÃºt ra nhiá»u Ä‘iá»u thÃº vá»‹.

Náº¿u tháº¥y bÃ i viáº¿t hay vÃ  bá»• Ã­ch thÃ¬ hÃ£y comment cho mÃ¬nh biáº¿t vÃ  chia sáº» cho báº¡n bÃ¨ cá»§a anh em cÃ¹ng Ä‘á»c nha.

BÃ i viáº¿t cÃ³ tham kháº£o má»™t sá»‘ nguá»“n trong nÆ°á»›c vÃ  nÆ°á»›c ngoÃ i:

https://dzone.com/articles/java-integer-cache-why-integervalueof127-integerva

https://tubean.github.io/2018/11/magical-1000-vs-100/

Thanks all!ğŸ’—ğŸ’—ğŸ’—