![](https://images.viblo.asia/eefa2e94-8230-4f25-a1a3-204e682efe93.jpg)

Xin chÃ o táº¥t cáº£ má»i ngÆ°á»i. CÃ´ng nghá»‡ Blockchain Ä‘Ã£ cÃ³ tá»« ráº¥t lÃ¢u, vá»›i sá»± dáº«n Ä‘áº§u ná»•i tiáº¿ng lÃ  Blockchain cá»§a Bitcoin vÃ  cá»§a Ethereum. Má»™t vÃ i nÄƒm trá»Ÿ láº¡i Ä‘Ã¢y, cÃ³ 1 há»‡ sinh thÃ¡i blockchain ná»•i lÃªn nhÆ° 1 Ä‘á»‘i trá»ng cá»§a Ethereum, Ä‘Ã³ lÃ  [Há»‡ sinh thÃ¡i Solana](https://solana.com/). Äá»‘i vá»›i anh em Developer, náº¿u má»i ngÆ°á»i Ä‘Ã£ quÃ¡ quen vá»›i viá»‡c táº¡o ra cÃ¡c Smart Contract trÃªn máº¡ng lÆ°á»›i Ethereum, thÃ¬ hÃ£y thá»­ cÃ¹ng tÃ¬m hiá»ƒu vá» blockchain Solana, vÃ  viáº¿t program trÃªn Ä‘Ã³ xem sao ğŸ˜‰ğŸ˜‰

# 1. Táº¡i sao láº¡i lÃ  Blockchain cá»§a Solana

![](https://images.viblo.asia/30c36142-db42-4166-a67f-86f71a149469.jpg)


NÄƒm 2020, Solana ná»•i lÃªn lÃ  1 dá»± Ã¡n cÃ³ vai trÃ² há»— trá»£ cÃ¡c á»©ng dá»¥ng tÃ i chÃ­nh phi táº­p trung (DeFi), tÄƒng kháº£ nÄƒng má»Ÿ rá»™ng máº¡ng lÆ°á»›i vÃ  táº¡o cÃ¡c há»£p Ä‘á»“ng thÃ´ng minh vá»›i hiá»‡u suáº¥t cao. Äá»‘i vá»›i nhá»¯ng ngÆ°á»i Ä‘Ã£ vÃ  Ä‘ang Ä‘áº§u tÆ° tiá»n ká»¹ thuáº­t sá»‘, cháº¯c háº³n má»i ngÆ°á»i khÃ´ng cÃ²n láº¡ gÃ¬ vá»›i Ä‘á»“ng coin SOL. Má»™t dá»± Ã¡n cÃ³ Ä‘á»™i ngÅ© Developers cháº¥t lÆ°á»£ng vá»›i ngÆ°á»i Ä‘á»©ng Ä‘áº§u lÃ  [Anatoly Yakovenko](https://www.topionetworks.com/people/anatoly-yakovenko-5d4bb4c71dedae48dc39811d) Ä‘Ã£ tá»«ng ráº¥t ná»•i tiáº¿ng á»Ÿ Qualcomm.

Solana lÃ  há»‡ sinh thÃ¡i Ä‘áº§u tiÃªn Ã¡p dá»¥ng cÆ¡ cháº¿ Ä‘á»“ng thuáº­n Proof of History (PoH - báº±ng chá»©ng lá»‹ch sá»­), káº¿t há»£p vá»›i cÆ¡ cháº¿ Proof of Stake (PoS - báº±ng chá»©ng cá»• pháº§n), giÃºp tá»‘c Ä‘á»™ xá»­ lÃ½ giao dá»‹ch lÃªn tá»›i 1600 TPS (transactions per second) vÃ o thá»i gian Ä‘áº§u, cao hÆ¡n ráº¥t nhiá»u so vá»›i chá»‰ 30 TPS cá»§a Ethereum vÃ  5-7 TPS cá»§a Bitcoin. Hiá»‡n táº¡i thÃ¬ con sá»‘ Ä‘Ã³ Ä‘Ã£ lÃªn tá»›i gáº§n 2400 TPS, vÃ  theo Whitepaper cá»§a há»‡ sinh thÃ¡i, náº¿u á»Ÿ Ä‘iá»u kiá»‡n lÃ½ tÆ°á»Ÿng thÃ¬ cÃ³ thá»ƒ xá»­ lÃ½ tá»›i 700.000 transactions/s. Äá»ƒ báº¡n dá»… hÃ¬nh dung, thÃ¬ cÃ¡c há»‡ thá»‘ng thanh toÃ¡n quá»‘c táº¿ nhÆ° Visa hay Mastercard chá»‰ Ä‘áº¡t khoáº£ng 1700 TPS, nghÄ©a lÃ  vá» tÆ°Æ¡ng lai Solana cÃ³ thá»ƒ xá»­ lÃ½ nhanh hÆ¡n gáº¥p nhiá»u láº§n cÃ¡c há»‡ thá»‘ng nÃ y. NgoÃ i ra, chi phÃ­ cho má»—i giao dá»‹ch trong máº¡ng Solana ráº¥t tháº¥p chá»‰ khoáº£ng 0.00005 Ä‘Ã´ la.

Äiá»ƒm yáº¿u cá»§a Solana Ä‘Æ°á»£c nhÃ¬n tháº¥y rÃµ nháº¥t Ä‘Ã³ lÃ  sá»± kiá»‡n ngÃ y 14/9/2021. Khi Ä‘á»“ng loáº¡t cÃ¡c Validators Ä‘á»u ngá»«ng hoáº¡t Ä‘á»™ng. GiÃ¡n Ä‘oáº¡n kÃ©o dÃ i 17h cho Ä‘áº¿n khi Ä‘Æ°á»£c hoáº¡t Ä‘á»™ng láº¡i. NguyÃªn nhÃ¢n Ä‘Æ°á»£c cho lÃ  [Raydium](https://raydium.io/) - Má»™t blockchain layer 2 cháº¡y trÃªn ná»n cá»§a Solana, thá»±c hiá»‡n Ä‘á»£t IDO vá»›i 300.000 transactions/s. Äiá»u Ä‘Ã³ lÃ m cho cÃ¡c Validators bá»‹ trÃ n bá»™ nhá»› khi gáº·p pháº£i lÆ°á»£ng giao dá»‹ch Ä‘á»™t biáº¿n nhÆ° váº­y, trong khi cÃ¡c Validators cÅ©ng Ä‘Ã£ Ä‘Æ°á»£c Solana khuyáº¿n cÃ¡o vá» sá»©c máº¡nh tÃ­nh toÃ¡n tá»‘i thiá»ƒu lÃ  128 GB Ram. CÃ¢u há»i Ä‘áº·t ra lÃ : Viá»‡c xÃ¡c thá»±c cÃ¡c Block bá»‹ phá»¥ thuá»™c quÃ¡ nhiá»u vÃ o sá»©c máº¡nh tÃ­nh toÃ¡n cá»§a táº­p cÃ¡c Validators thÃ¬ blockchain cá»§a há» cÃ³ thá»±c sá»± phi táº­p trung  ğŸ™ƒğŸ™ƒ

Tá»« trÆ°á»›c Ä‘áº¿n nay, háº§u háº¿t cÃ¡c Smart Contract (cá»§a Ethereum) Ä‘á»u Ä‘Æ°á»£c xÃ¢y dá»±ng vá»›i ngÃ´n ngá»¯ Solidity. NhÆ°ng trong thá»i gian tá»›i, Solidity cÃ³ thá»ƒ sáº½ máº¥t Ä‘i vá»‹ tháº¿ cá»§a mÃ¬nh vá» tay Rust. VÃ¬ má»©c Ä‘á»™ linh hoáº¡t cá»§a Rust cÃ³ thá»ƒ "Äƒn Ä‘á»©t" Solidity, vÃ  sá»± háº¡n cháº¿ ná»¯a lÃ  Solidity chá»‰ táº¡o Ä‘Æ°á»£c Smart Contract. Vá»›i Rust thÃ¬ cÃ³ thá»ƒ lÃ m Ä‘Æ°á»£c ráº¥t nhiá»u thá»©. Ráº¥t nhiá»u blockchain má»›i ná»•i Ä‘á»u há»— trá»£ Developer vá»›i ngÃ´n ngá»¯ Rust nhÆ°: Solana, [Near Protocol](https://near.org/), [Há»‡ sinh thÃ¡i Polkadot](https://polkadot.network/), [Casper Network](https://casper.network/en/network), ... Tuy nhiÃªn, Rust lÃ  má»™t ngÃ´n ngá»¯ khÃ¡ khÃ³ Ä‘á»‘i vá»›i ngÆ°á»i má»›i báº¯t Ä‘áº§u, Ä‘áº·c biá»‡t lÃ  vá»›i nhá»¯ng ngÆ°á»i chÆ°a thÃ nh tháº¡o C/C++. VÃ¬ tháº¿, náº¿u báº¡n chÆ°a há»c Rust, thÃ¬ trÆ°á»›c tiÃªn hÃ£y bá» chÃºt thá»i gian Ä‘á»ƒ há»c Rust cÆ¡ báº£n, cÃ²n khÃ´ng thÃ¬ mÃ¬nh tin cháº¯c sáº½ khÃ¡ khÃ³ á»Ÿ cÃ¡c pháº§n dÆ°á»›i náº¿u báº¡n chÆ°a thÃ nh tháº¡o Rust ğŸ˜…ğŸ˜…
# 2. Cáº¥u trÃºc 1 program trong Solana

Trong Solana, khÃ´ng cÃ³ thuáº­t ngá»¯ Smart Contract nhÆ° cá»§a Ethereum, mÃ  thay vÃ o Ä‘Ã³ lÃ  thuáº­t ngá»¯ program. Khi cÃ³ 1 á»©ng dá»¥ng muá»‘n tÆ°Æ¡ng tÃ¡c vá»›i Cluster trong máº¡ng Solana, nÃ³ sáº½ gá»­i Ä‘i cÃ¡c transactions lÃªn máº¡ng, má»—i transaction sáº½ cÃ³ 1 hoáº·c vÃ i instruction. Solana sau Ä‘Ã³ sáº½ Ä‘iá»u hÆ°á»›ng cÃ¡c transaction tÆ°Æ¡ng tÃ¡c trá»±c tiáº¿p vá»›i program mÃ  Developer Ä‘Ã£ deploy trÆ°á»›c Ä‘Ã³. Äá»ƒ hiá»ƒu rÃµ hÆ¡n vá» cÃ¡ch tÆ°Æ¡ng tÃ¡c vá»›i máº¡ng blockchain Solana, hay cáº¥u táº¡o 1 transaction gá»­i lÃªn tháº¿ nÃ o, báº¡n cÃ³ thá»ƒ tham kháº£o á»Ÿ [Programming Model](https://docs.solana.com/developing/programming-model/overview).

## CÃ i Ä‘áº·t Rust

Äá»ƒ táº¡o 1 program, trÆ°á»›c tiÃªn chÃºng ta pháº£i cÃ i Ä‘áº·t mÃ´i trÆ°á»ng láº­p trÃ¬nh ngÃ´n ngá»¯ Rust, viá»‡c cÃ i Ä‘áº·t ráº¥t Ä‘Æ¡n giáº£n, báº¡n cÃ³ thá»ƒ tham kháº£o cÃ¡ch cÃ i Ä‘áº·t [Rust Installation](https://www.rust-lang.org/tools/install). Táº¡o 1 project má»›i vá»›i Rust báº±ng cÃ¢u lá»‡nh `cargo new project_name --lib`

Cáº¥u trÃºc ban Ä‘áº§u cá»§a project sáº½ nhÆ° tháº¿ nÃ y:
```
project_name
|----src
         |-----lib.rs
|----target
         ...
|----Cargo.lock
|----Cargo.toml
```
- Code sáº½ Ä‘Æ°á»£c build tá»« file `lib.rs`
- Cháº¡y lá»‡nh `cargo run` Ä‘á»ƒ run project, khi Ä‘Ã³ thÆ° má»¥c target má»›i Ä‘Æ°á»£c táº¡o ra
- File Cargo.toml quáº£n lÃ½ cÃ¡c thÃ´ng tin project, cÃ¡c thÆ° viá»‡n phá»¥ thuá»™c. Hiá»ƒu tÆ°Æ¡ng tá»± nhÆ° package.json trong Javascript.
- Lá»‡nh `cargo build-bpf` sáº½ biÃªn dá»‹ch code táº¡o file `.so` vÃ  keypair. Táº¥t cáº£ á»Ÿ thÆ° má»¥c `target/deploy/`

## CÃ i Ä‘áº·t Solana

Tiáº¿p theo lÃ  chÃºng ta cáº§n cÃ i Ä‘áº·t cÃ´ng cá»¥ Solana, trÃ¬nh tá»± cÃ i Ä‘áº·t khÃ¡ Ä‘Æ¡n giáº£n, báº¡n cÃ³ thá»ƒ xem hÆ°á»›ng dáº«n [Solana CLI Tool](https://docs.solana.com/cli/install-solana-cli-tools). Kiá»ƒm tra xem chÃºng ta cÃ³ cÃ i Ä‘áº·t thÃ nh cÃ´ng hay chÆ°a báº±ng lá»‡nh `solana`, náº¿u khÃ´ng cÃ³ lá»—i gÃ¬ thÃ¬ ngon rá»“i. ğŸ˜ƒğŸ˜ƒ

ChÃºng ta cÅ©ng cáº§n pháº£i táº¡o 1 vÃ­ cho Solana ngay dÆ°á»›i local báº±ng lá»‡nh:
```
solana-keygen pubkey /home/solana/my_wallet.json
```
Lá»‡nh nÃ y sáº½ hiá»ƒn thá»‹ ngay trÃªn terminal 1 public key cho báº¡n, báº¡n cÃ³ thá»ƒ kiá»ƒm tra Ä‘á»‹a chá»‰ vÃ­ vá»›i lá»‡nh `solana address`, vÃ­ nÃ y cÃ³ private key Ä‘Æ°á»£c lÆ°u dÆ°á»›i dáº¡ng keypair. Tá»« giá» trá»Ÿ Ä‘i, vÃ­ nÃ y sáº½ Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ kÃ½ lÃªn cÃ¡c giao dá»‹ch mÃ  deploy á»Ÿ mÃ¡y chÃºng ta lÃªn máº¡ng blockchain Solana.

Báº¡n cháº¡y lá»‡nh `solana config get` Ä‘á»ƒ kiá»ƒm tra cÃ¡c config trong mÃ¡y. LÃºc nÃ y, chÃºng ta sáº½ tháº¥y `RPC URL: https://api.mainnet.solana.com`. TrÆ°á»ng RPC Ä‘ang Ä‘á»ƒ lÃ  mainnet, Ä‘Ã³ lÃ  mÃ´i trÆ°á»ng thá»±c cá»§a Solana, khi deploy sáº½ máº¥t phÃ­ giao dá»‹ch. VÃ¬ tháº¿ chÃºng ta cáº§n Ä‘Æ°a vá» mÃ´i trÆ°á»ng devnet Ä‘á»ƒ pháº£i triá»ƒn sau nÃ y, vá»›i lá»‡nh: `solana config set --url https://api.devnet.solana.com`. Báº¡n cÅ©ng cáº§n set láº¡i trÆ°á»ng Key Pair thÃ nh Ä‘Æ°á»ng dáº«n Ä‘áº¿n file keypair mÃ  chÃºng ta Ä‘Ã£ táº¡o phÃ­a trÃªn.

ChÃºng ta cáº§n cÃ i Ä‘áº·t `spl-token-cli` vá»›i lá»‡nh `cargo install spl-token-cli` Ä‘á»ƒ thuáº­n lá»£i cho viá»‡c sá»­ dá»¥ng cÃ¡c token sau nÃ y.

Cuá»‘i cÃ¹ng, thÃ¬ vÃ­ cá»§a chÃºng ta pháº£i cÃ³ 1 lÆ°á»£ng coin SOL Ä‘á»ƒ lÃ m phÃ­ giao dá»‹ch deploy pháº£i khÃ´ng nÃ o ? ğŸ˜…ğŸ˜… Báº¡n chá»‰ cáº§n cháº¡y lá»‡nh `solana airdrop 1 your_publickey`. Kiá»ƒm tra xem vÃ­ báº¡n cÃ³ bao nhiÃªu coin SOL báº±ng lá»‡nh `solana balance your_publickey --url https://api.devnet.solana.com`.

Váº­y lÃ  xong, vÃ­ chÃºng ta Ä‘Ã£ cÃ³ lÆ°á»£ng coin lÃ  1 SOL Ä‘á»ƒ giao dá»‹ch sau nÃ y. Giá» thÃ¬ thoáº£i mÃ¡i code thÃ´i ğŸ˜‰ğŸ˜‰ğŸ˜‰

## Cáº¥u trÃºc 1 program

Trong Solana, há» Ä‘Æ°a ra cáº¥u táº¡o chuáº©n Ä‘á»ƒ táº¡o ra 1 program, Ä‘Ã³ lÃ  [Repo template](https://github.com/mvines/solana-bpf-program-template). TrÆ°á»›c tiÃªn, báº¡n cáº§n xÃ³a bá» háº¿t nhá»¯ng gÃ¬ cÃ³ trong file `src/lib.rs`, vÃ  thÃªm 2 dÃ²ng lá»‡nh sau vÃ o cuá»‘i file Cargo.toml:
```
[lib]
crate-type = ["cdylib", "lib"]
```
> LÆ°u Ã½: ÄÃ¢y sáº½ lÃ  template cho táº¥t cáº£ cÃ¡c program chuáº©n trong Solana, cho tá»›i khi Solana cÃ³ báº£n cáº­p nháº­t template má»›i. HÃ£y ngÃ³ qua template Ä‘Ã³ má»™t chÃºt nhÃ© ğŸ˜‰

ChÃºng ta sáº½ sá»­ dá»¥ng Macro `entrypoint!` Ä‘á»ƒ khai bÃ¡o hÃ m `process_instruction` cho chÆ°Æ¡ng trÃ¬nh. Entrypoint lÃ  cá»•ng vÃ o duy nháº¥t mÃ  má»™t lá»i gá»i cÃ³ thá»ƒ gá»i Ä‘áº¿n program cá»§a Solana.

> Khi cÃ³ lá»i gá»i Ä‘áº¿n, chÆ°Æ¡ng trÃ¬nh sáº½ Ä‘Æ°á»£c náº¡p vÃ o [BPF Loader](https://docs.solana.com/developing/on-chain-programs/overview). Má»—i BPF Loader sáº½ cÃ³ 1 hoáº·c nhiá»u Entrypoint.

Trong hÃ m `process_instruction`, cÃ¡c Ä‘á»‘i sá»‘ lÃ  `program_id` lÃ  ID cá»§a chÆ°Æ¡ng trÃ¬nh sau khi deploy, má»i biáº¿n state trong chÆ°Æ¡ng trÃ¬nh sáº½ Ä‘Ã­nh kÃ¨m á»Ÿ `accounts`, dá»¯ liá»‡u truyá»n lÃªn theo lá»i gá»i sáº½ Ä‘á»ƒ á»Ÿ trong `instruction_data`.

Quay láº¡i vá»›i Solidity trong Ethereum má»™t chÃºt, cÃ³ 2 loáº¡i address trong Solidity Ä‘Ã³ lÃ :

- User Address: Äá»ƒ lÆ°u trá»¯ cÃ¡c token, kÃ½ lÃªn cÃ¡c giao dá»‹ch, táº¡o Smart Contract má»›i
- Contract Address: Chá»‰ cÃ³ thá»ƒ lÆ°u trá»¯ cÃ¡c token vÃ  tÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Smart Contract khÃ¡c

Trong Solana thÃ¬ chia lÃ m 3 loáº¡i Account (cÃ³ thá»ƒ hiá»ƒu Ä‘Æ¡n giáº£n lÃ  public address):

- Account Ä‘Æ°á»£c sá»Ÿ há»¯u bá»Ÿi System program. ÄÃ³ chÃ­nh lÃ  cÃ¡c Ä‘á»‹a chá»‰ cá»§a chÃºng ta dÃ¹ng Ä‘á»ƒ kÃ½ lÃªn cÃ¡c giao dá»‹ch tÆ°Æ¡ng tá»± nhÆ° User Address trong Solidity, vÃ­ dá»¥ lÃ  Ä‘á»‹a chá»‰ mÃ¬nh Ä‘Ã£ táº¡o trÃªn mÃ¡y local.
- Account Ä‘Æ°á»£c sá»Ÿ há»¯u bá»Ÿi Token Program. ÄÃ³ lÃ  cÃ¡c Ä‘á»‹a chá»‰ cÃ³ thá»ƒ chá»©a coin hoáº·c token mÃ  thuá»™c sá»Ÿ há»¯u cá»§a 1 chÆ°Æ¡ng trÃ¬nh nÃ o Ä‘Ã³. Tuy nhiÃªn, khi cÃ³ giao dá»‹ch thÃ¬ ngÆ°á»i kÃ½ lÃªn giao dá»‹ch váº«n lÃ  chÃºng ta
> Loáº¡i Account thá»© 2 nÃ y thuá»™c sá»Ÿ há»¯u cá»§a Token Program, nhÆ°ng ngÆ°á»i táº¡o ra nÃ³ sáº½ lÃ  chÃºng ta (Account owned by system program).
- Account Ä‘Æ°á»£c sá»Ÿ há»¯u bá»Ÿi chÃ­nh chÆ°Æ¡ng trÃ¬nh cá»§a chÃºng ta, nÃ³ sáº½ lÆ°u trá»¯ cÃ¡c biáº¿n state cá»§a chÆ°Æ¡ng trÃ¬nh.

> Káº¿t luáº­n: Táº¥t cáº£ cÃ¡c Account chá»‰ Ä‘Æ°á»£c sá»Ÿ há»¯u bá»Ÿi cÃ¡c chÆ°Æ¡ng trÃ¬nh.

NhÆ°ng chá» chÃºt, káº¿t luáº­n trÃªn cÃ³ váº» mÃ¢u thuáº«n vá»›i cÃ¡c phÃ¢n chia loáº¡i Account phÃ­a trÃªn, khÃ´ng láº½ Account cá»§a mÃ¬nh sá»Ÿ há»¯u coin SOL láº¡i khÃ´ng pháº£i thuá»™c sá»Ÿ há»¯u cá»§a mÃ¬nh ğŸ˜†ğŸ˜†. TrÃªn thá»±c táº¿, táº¥t cáº£ cÃ¡c giao dá»‹ch trÃªn Solana Ä‘á»u Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi 1 chÆ°Æ¡ng trÃ¬nh nÃ o Ä‘Ã³. HÃ£y nhá»› lÃ  cÃ¡c dá»¯ liá»‡u state Ä‘á»u Ä‘Æ°á»£c lÆ°u trong Account, mÃ  táº¥t cáº£ Account Ä‘á»u Ä‘Æ°á»£c sá»Ÿ há»¯u bá»Ÿi BPF Loader. Chá»‰ cÃ³ 1 chÆ°Æ¡ng trÃ¬nh duy nháº¥t lÃ  khÃ´ng thuá»™c sá»Ÿ há»¯u cá»§a BPF Loader Ä‘Ã³ lÃ  System Program.

TrÃªn phÃ­a trÃªn lÃ  giáº£i thÃ­ch cho cÃ¡c biáº¿n `accounts` Ä‘Æ°á»£c truyá»n vÃ o hÃ m `process_instruction`ğŸ˜‰

Tiáº¿p theo lÃ  trong file `instruction.rs`, nhÃ¬n tÃªn thÃ¬ báº¡n cÃ³ thá»ƒ Ä‘oÃ¡n Ä‘Æ°á»£c Ä‘Ã³ lÃ  cÃ¡c `instruction` Ä‘Æ°á»£c nÃ³i Ä‘áº¿n trong docs cá»§a Solana. NÃ³ sáº½ xÃ¡c Ä‘á»‹nh lá»i gá»i báº¡n truyá»n lÃªn lÃ  gÃ¬, phÃ¢n tÃ­ch nÃ³ vÃ  Ä‘iá»u hÆ°á»›ng Ä‘áº¿n cÃ¡c hÃ m phÃ­a sau Ä‘Ã³.

> Instruction Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a lÃ  "API" cá»§a chÆ°Æ¡ng trÃ¬nh

File `error.rs` sáº½ Ä‘á»‹nh nghÄ©a cÃ¡c lá»—i xáº£y ra trong chÆ°Æ¡ng trÃ¬nh.

Cuá»‘i cÃ¹ng lÃ  file `state.rs` sáº½ khai bÃ¡o cÃ¡c biáº¿n state lÆ°u trá»¯ trong chÆ°Æ¡ng trÃ¬nh

> Káº¿t luáº­n luá»“ng cháº¡y:
> - CÃ³ ngÆ°á»i gá»i vÃ o program (Ä‘Æ°a ra 1 caller)
> - Cá»•ng vÃ o Entrypoint sáº½ chuyá»ƒn cÃ¡c Ä‘á»‘i sá»‘ Ä‘áº¿n bá»™ xá»­ lÃ½ processor
> - Bá»™ xá»­ lÃ½ yÃªu cáº§u `instruction.rs` giáº£i mÃ£ `instruction_data` truyá»n lÃªn.
> - Dá»±a vÃ o dá»¯ liá»‡u giáº£i mÃ£, `instruction.rs` sáº½ quyáº¿t Ä‘á»‹nh gá»i tiáº¿p Ä‘áº¿n hÃ m nÃ o
> - Bá»™ xá»­ lÃ½ sáº½ dÃ¹ng `state.rs` Ä‘á»ƒ mÃ£ hÃ³a hoáº·c giáº£i mÃ£ state cá»§a 1 tÃ i khoáº£n

TrÃªn Ä‘Ã¢y lÃ  toÃ n bá»™ luá»“ng cháº¡y khi cÃ³ 1 giao dá»‹ch gá»i Ä‘áº¿n 1 chÆ°Æ¡ng trÃ¬nh trong Solana ğŸ˜‰

# 3. ChÆ°Æ¡ng trÃ¬nh Escrow (kÃ½ quá»¹)

![](https://images.viblo.asia/6ff23fec-993e-418e-8032-a945b3e81970.gif)

Má»™t program khÃ´ng quÃ¡ khÃ³ cÅ©ng khÃ´ng quÃ¡ dá»… Ä‘á»ƒ má»i ngÆ°á»i hiá»ƒu vÃ  thá»±c hÃ nh, Ä‘Ã³ lÃ  1 chÆ°Æ¡ng trÃ¬nh kÃ½ quá»¹.

Khi báº¡n muá»‘n trao Ä‘á»•i 1 tÃ i sáº£n X láº¥y 1 tÃ i sáº£n Y cá»§a ngÆ°á»i khÃ¡c. Báº¡n giao cho ngÆ°á»i ta X trÆ°á»›c vÃ  há» giao láº¡i cho báº¡n Y sau. Tháº¿ lÃ  xong rá»“i, cáº§n gÃ¬ Ä‘áº¿n blockchain nhá»‰ ğŸ˜‚ğŸ˜‚. NhÆ°ng náº¿u há»c khÃ´ng giao Y cho báº¡n vÃ  rá»i Ä‘i thÃ¬ sao, lÃºc nÃ y báº¡n sáº½ cáº§n 1 ngÆ°á»i lÃ m trung gian mÃ  cáº£ 2 tin tÆ°á»Ÿng, má»—i ngÆ°á»i sáº½ giao tÃ i sáº£n cá»§a mÃ¬nh cho há», rá»“i há» sáº½ giao tÃ i sáº£n tÆ°Æ¡ng á»©ng cho 2 bÃªn. NhÆ°ng náº¿u cáº£ bÃªn trung gian cÅ©ng gian láº­n thÃ¬ sao. LÃºc nÃ y lÃ  lÃºc blockchain thá»ƒ hiá»‡n, nÃ³ sáº½ lÃ  trung gian, báº¡n cÃ³ thá»ƒ kiá»ƒm tra xem blockchain cÃ³ gian láº­n hay khÃ´ng báº±ng cÃ¡ch xem code cá»§a nÃ³ ğŸ˜‰ğŸ˜‰

![image.png](https://images.viblo.asia/f6115a43-3b8c-4037-99b2-4f89f4ed3047.png)

NhÃ¬n vÃ o sÆ¡ Ä‘á»“ phÃ­a trÃªn, mÃ¬nh cÃ³ thá»ƒ phÃ¢n tÃ­ch nhÆ° sau:

- 2 ngÆ°á»i Alice vÃ  Bob, má»—i ngÆ°á»i sáº½ táº¡o 1 account chÃ­nh cá»§a mÃ¬nh, Ä‘Ã³ lÃ  account mÃ  há» dÃ¹ng Ä‘á»ƒ kÃ½ lÃªn cÃ¡c giao dá»‹ch. ChÃ­nh lÃ  loáº¡i Account thá»© nháº¥t mÃ¬nh Ä‘Ã£ nÃ³i bÃªn trÃªn.
- Sau khi giao dá»‹ch thÃ nh cÃ´ng, cáº£ Alice vÃ  Bob Ä‘á»u sá»Ÿ há»¯u token X vÃ  token Y. VÃ¬ tháº¿, chÃºng ta sáº½ yÃªu cáº§u cáº£ 2 ngÆ°á»i, má»—i ngÆ°á»i pháº£i táº¡o 2 Account Ä‘á»ƒ lÆ°u trá»¯ X vÃ  Y. Loáº¡i Account nÃ y chÃ­nh lÃ  loáº¡i thá»© 2 mÃ¬nh Ä‘Ã£ nÃ³i. NÃ³ thuá»™c sá»Ÿ há»¯u cá»§a Token Program X vÃ  Token Program Y.
- Cuá»‘i cÃ¹ng lÃ  Escrow State Account, chÃ­nh lÃ  loáº¡i thá»© 3, dÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c biáº¿n state trong chÆ°Æ¡ng trÃ¬nh.

![image.png](https://images.viblo.asia/a5157e0a-c4fb-4ac2-af3a-70e30662428e.png)

TrÃªn Ä‘Ã¢y lÃ  tÃ­nh sá»Ÿ há»¯u cho má»—i loáº¡i Account, tÆ°Æ¡ng á»©ng lÃ  3 loáº¡i mÃ¬nh Ä‘Ã£ nÃ³i phÃ­a trÃªn.

![image.png](https://images.viblo.asia/009b6bc6-63cc-4d41-8673-a3b972165fab.png)

NhÃ¬n sÆ¡ Ä‘á»“ phÃ­a trÃªn, chÃºng ta cÃ³ thÃªm 1 Account ná»¯a Ä‘Ã³ lÃ  `Alice temp token acc X`, Ä‘Ã³ lÃ  account sáº½ chá»‰ chá»©a lÆ°á»£ng token X mÃ  Alice muá»‘n trao Ä‘á»•i. Alice sáº½ pháº£i cáº¥p quyá»n cho `Escrow State Account` trÃªn `Alice temp token acc X` Ä‘á»ƒ nÃ³ cÃ³ thá»ƒ tá»± Ä‘á»™ng láº¥y token X trong vÃ­ Ä‘Ã³ vÃ  chuyá»ƒn Ä‘i. ÄÆ°Æ¡ng nhiÃªn nÃ³ cÅ©ng lÃ  1 Account loáº¡i 2 vÃ  hiá»ƒu nÃ³ nhÆ° lÃ  vÃ­ phá»¥ Ä‘á»ƒ chá»©a token X.

# 4. Viáº¿t chÆ°Æ¡ng trÃ¬nh kÃ½ quá»¹

## CÃ¡c Dependencies

Trong file `Cargo.toml`, chÃºng ta sáº½ cáº§n pháº£i khai bÃ¡o má»™t sá»‘ Dependencies, Ä‘Ã³ chÃ­nh lÃ  cÃ¡c thÆ° viá»‡n mÃ  chÃºng ta náº¡p vÃ o project Escrow nÃ y. Táº¥t cáº£ cÃ¡c dependencies nÃ y báº¡n cÃ³ thá»ƒ tÃ¬m kiá»ƒm trÃªn [Crate.io](https://crates.io/)

```
[dependencies]
solana-program = "1.9.5"
thiserror = "1.0.30"
spl-token = {version = "3.3.0", features = ["no-entrypoint"]}
arrayref = "0.3.6"
```
Giáº£i thÃ­ch 1 chÃºt:

- `solana-program` lÃ  1 thÆ° viá»‡n Solana Ä‘Ã£ viáº¿t Ä‘á»ƒ há»— trá»£ táº¡o program. MÃ¬nh sáº½ pháº£i sá»­ dá»¥ng nÃ³ ráº¥t nhiá»u khi táº¡o program
- `thiserror` lÃ  thÆ° viá»‡n giÃºp táº¡o cÃ¡c lá»—i Ä‘Æ°á»£c raise lÃªn, náº¿u khÃ´ng dÃ¹ng nÃ³, chÃºng ta sáº½ pháº£i khai bÃ¡o cá»¥ thá»ƒ cÃ¡c lá»—i nhÆ° tháº¿ nÃ o
- `spl-token` lÃ  thÆ° viá»‡n giÃºp Ã­ch ráº¥t nhiá»u trong viá»‡c kiá»ƒm tra cÃ¡c Account thuá»™c sá»Ÿ há»¯u cá»§a Token Program
- `arrayref` giÃºp mÃ£ hÃ³a vÃ  giáº£i mÃ£ dá»¯ liá»‡u tá»« `instruction_data` gá»­i lÃªn

## Khai bÃ¡o Error

```
use thiserror::Error;

use solana_program::program_error::ProgramError;

#[derive(Error, Debug, Copy, Clone)]
pub enum EscrowError {
    /// Invalid instruction
    #[error("Invalid Instruction")]
    InvalidInstruction,
    /// Not Rent Exempt
    #[error("Not Rent Exempt")]
    NotRentExempt,
    /// Expected Amount Mismatch
    #[error("Expected Amount Mismatch")]
    ExpectedAmountMismatch,
    /// Amount Overflow
    #[error("Amount Overflow")]
    AmountOverflow,
}
```

Trong Ä‘oáº¡n code trÃªn, mÃ¬nh khi bÃ¡o 4 loáº¡i lá»—i cÃ³ thá»ƒ xáº£y ra:

- `InvalidInstruction`: Khi `instruction_data` gá»­i lÃªn program vá»›i Ä‘á»‹nh dáº¡ng khÃ´ng há»£p lá»‡
- `NotRentExempt`: Khi Account dÃ¹ng Ä‘á»ƒ deploy chÆ°Æ¡ng trÃ¬nh khÃ´ng Ä‘á»§ sá»‘ dÆ° Ä‘á»ƒ 'thuÃª' khÃ´ng gian lÆ°u trá»¯ dá»¯ liá»‡u trÃªn Solana
- `ExpectedAmountMismatch`: Xáº£y ra khi Bob gá»­i sá»‘ token Y lÃªn program lÃ  khÃ´ng tÆ°Æ¡ng á»©ng vá»›i token X mÃ  Alice Ä‘Ã£ gá»­i
- `AmountOverflow`: Khi Alice trao Ä‘á»•i 1 lÆ°á»£ng token X vÆ°á»£t quÃ¡ sá»‘ token mÃ  Alice Ä‘Ã£ sá»Ÿ há»¯u.

4 loáº¡i lá»—i trÃªn mÃ¬nh Ä‘á»ƒ vÃ o 1 enum.

Táº¥t cáº£ cÃ¡c lá»—i trong program Ä‘á»u chá»‰ Ä‘Æ°á»£c phÃ©p Ä‘Æ°a vá» dáº¡ng `ProgramError`. Ráº¥t Ä‘Æ¡n giáº£n, chÃºng ta dÃ¹ng hÃ m from Ä‘á»ƒ Ã©p kiá»ƒu `enum` vá» `ProgramErro`

```
impl From<EscrowError> for ProgramError {
    fn from(e: EscrowError) -> Self {
        ProgramError::Custom(e as u32)
    }
}
```

Cuá»‘i cÃ¹ng lÃ  import file `error.rs` vÃ  file `lib.rs`:

```
pub mod error;
```

## Khai bÃ¡o Entrypoint

Tiáº¿p theo lÃ  chÃºng ta pháº£i khai bÃ¡o Entrypoint cho chÆ°Æ¡ng trÃ¬nh:

```
use solana_program::{
    account_info::AccountInfo, entrypoint, entrypoint::ProgramResult, pubkey::Pubkey,
};

use crate::processor::Processor;

entrypoint!(process_instruction);
fn process_instruction(
    program_id: &Pubkey,
    accounts: &[AccountInfo],
    instruction_data: &[u8],
) -> ProgramResult {
    Processor::process(program_id, accounts, instruction_data)
}
```

Macro `entrypoint!` vÃ  hÃ m `process_instruction` mÃ¬nh Ä‘Ã£ giáº£i thÃ­ch á»Ÿ pháº§n phÃ­a trÃªn. ÄÃ³ chá»‰ Ä‘Æ¡n giáº£n lÃ  nháº­n vÃ o 3 Ä‘á»‘i sá»‘ `program_id`, `accounts` vÃ  `instruction_data`. VÃ  hÃ m xá»­ lÃ½ tiáº¿p theo lÃ  `process` trong file `processor.rs`

TÆ°Æ¡ng tá»± chÃºng ta cÅ©ng import file trÃªn vÃ o file `lib.rs` vÃ  táº¡o 1 file má»›i `processor.rs`:
```
pub mod error;
pub mod instruction;
pub mod processor;

#[cfg(not(feature = "no-entrypoint"))]
pub mod entrypoint;
```

## Khai bÃ¡o Instruction

NhÆ° mÃ¬nh Ä‘Ã£ nÃ³i á»Ÿ trÃªn, `instruction.rs` nhÆ° lÃ  API cá»§a chÆ°Æ¡ng trÃ¬nh. á» trong Ä‘Ã³, chÃºng ta sáº½ khai bÃ¡o cÃ¡c 'lá»‘i Ä‘i' cho luá»“ng cháº¡y
```
use solana_program::program_error::ProgramError;
use std::convert::TryInto;

use crate::error::EscrowError::InvalidInstruction;

pub enum EscrowInstruction {
    InitEscrow {
        amount: u64,
    },
    Exchange {
        /// the amount the taker expects to be paid in the other token, as a u64 because that's the max possible supply of a token
        amount: u64,
    },
}
```

TrÃªn Ä‘Ã¢y mÃ¬nh khai bÃ¡o 2 lá»‘i Ä‘i cho luá»“ng cháº¡y, Ä‘Ã³ lÃ  `InitEscrow` vÃ  `Exchange`. `InitEscrow` dÃ¹ng Ä‘á»ƒ khá»Ÿi táº¡o kÃ½ quá»¹. `Exchange` dÃ¹ng Ä‘á»ƒ thá»±c hiá»‡n trao Ä‘á»•i token

Tiáº¿p theo lÃ  mÃ¬nh pháº£i khai bÃ¡o pháº§n giáº£i mÃ£ dá»¯ liá»‡u mÃ  luá»“ng cháº¡y gá»­i lÃªn:
```
impl EscrowInstruction {
    /// Unpacks a byte buffer into a [EscrowInstruction](enum.EscrowInstruction.html).
    pub fn unpack(input: &[u8]) -> Result<Self, ProgramError> {
        let (tag, rest) = input.split_first().ok_or(InvalidInstruction)?;

        Ok(match tag {
            0 => Self::InitEscrow {
                amount: Self::unpack_amount(rest)?,
            },
            1 => Self::Exchange {
                amount: Self::unpack_amount(rest)?,
            },
            _ => return Err(InvalidInstruction.into()),
        })
    }

    fn unpack_amount(input: &[u8]) -> Result<u64, ProgramError> {
        let amount = input
            .get(..8)
            .and_then(|slice| slice.try_into().ok())
            .map(u64::from_le_bytes)
            .ok_or(InvalidInstruction)?;
        Ok(amount)
    }
}
```

ChÃºng ta sáº½ "bÃ³c gÃ³i" dá»¯ liá»‡u gá»­i lÃªn program, pháº§n tá»­ Ä‘áº§u tiÃªn trong máº£ng `instruction_data` lÃ  Ä‘á»ƒ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»ng Ä‘i xem Init hay Exchange. CÃ¡c pháº§n tá»­ cÃ²n láº¡i sáº½ Ä‘Æ°á»£c `unpack` Ä‘á»ƒ giáº£i mÃ£ cÃ¡c Ä‘á»‘i sá»‘.

Cuá»‘i cÃ¹ng chÃºng ta cÅ©ng pháº£i import nÃ³ vÃ o `lib.rs`:
```
pub mod error;
pub mod instruction;

#[cfg(not(feature = "no-entrypoint"))]
pub mod entrypoint;
```

## Khai bÃ¡o Processor

File `processor.rs` sáº½ lÃ  file xá»­ lÃ½ dá»¯ liá»‡u sau khi nÃ³ Ä‘Ã£ Ä‘Æ°á»£c `unpack` trong Instruction
```
use solana_program::{
    account_info::{next_account_info, AccountInfo},
    entrypoint::ProgramResult,
    msg,
    program::{invoke, invoke_signed},
    program_error::ProgramError,
    program_pack::{IsInitialized, Pack},
    pubkey::Pubkey,
    sysvar::{rent::Rent, Sysvar},
};
use spl_token::state::Account as TokenAccount;
use crate::{error::EscrowError, instruction::EscrowInstruction, state::Escrow};

pub struct Processor;

impl Processor {
    pub fn process(
        program_id: &Pubkey,
        accounts: &[AccountInfo],
        instruction_data: &[u8],
    ) -> ProgramResult {
        let instruction = EscrowInstruction::unpack(instruction_data)?;

        match instruction {
            EscrowInstruction::InitEscrow { amount } => {
                msg!("Instruction: InitEscrow");
                Self::process_init_escrow(accounts, amount, program_id)
            }
            EscrowInstruction::Exchange { amount } => {
                msg!("Instruction: Exchange");
                Self::process_exchange(accounts, amount, program_id)
            }
        }
    }
}
```

2 hÃ m chÃºng ta cáº§n khai bÃ¡o tiáº¿p theo lÃ  `process_init_escrow` vÃ  `process_exchange`

```
...
fn process_init_escrow(
    accounts: &[AccountInfo],
    amount: u64,
    program_id: &Pubkey,
) -> ProgramResult {
    let account_info_iter = &mut accounts.iter();
    let initializer = next_account_info(account_info_iter)?;

    if !initializer.is_signer {
        return Err(ProgramError::MissingRequiredSignature);
    }

    let temp_token_account = next_account_info(account_info_iter)?;

    let token_to_receive_account = next_account_info(account_info_iter)?;
    if *token_to_receive_account.owner != spl_token::id() {
        return Err(ProgramError::IncorrectProgramId);
    }
    ...
    Ok(())
}
...
```

Trong hÃ m nay, chÃºng ta sáº½ khai bÃ¡o 1 iter Ä‘á»ƒ duyá»‡t qua táº¥t cáº£ cÃ¡c Accounts mÃ  chÃºng ta truyá»n lÃªn. Account Ä‘áº§u tiÃªn chÃ­nh lÃ  Account cá»§a Alice, ngÆ°á»i sáº½ kÃ½ lÃªn giao dá»‹ch Ä‘áº§u tiÃªn.

Tiáº¿p theo lÃ  Account phá»¥ cá»§a Alice Ä‘á»ƒ chá»©a token X, vÃ  cuá»‘i cÃ¹ng lÃ  Account nháº­n token X cá»§a Bob.

ChÃºng ta sáº½ pháº£i thá»±c hiá»‡n kiá»ƒm tra `token_to_receive_account` cÃ³ owner cÃ³ pháº£i lÃ  1 Token Program hay khÃ´ng.

ChÃºng ta cÃ³ thá»ƒ tháº¯c máº¯c: táº¡i sao `token_to_receive_account` cáº§n kiá»ƒm tra há»£p lá»‡ mÃ  `temp_token_account` láº¡i khÃ´ng kiá»ƒm tra ? ğŸ˜„ğŸ˜„
CÃ¢u tráº£ lá»i lÃ  phÃ­a sau mÃ¬nh sáº½ thá»±c hiá»‡n Alice sáº½ cáº¥p quyá»n cho PDA. Viá»‡c chuyá»ƒn nÃ y sáº½ tá»± Ä‘á»™ng tháº¥t báº¡i náº¿u `temp_token_account` khÃ´ng thuá»™c sá»Ÿ há»¯u cá»§a Token Program. CÃ²n `token_to_receive_account` thÃ¬ chÃºng ta sáº½ pháº£i tá»± kiá»ƒm tra.

```
...
fn process_init_escrow(
    accounts: &[AccountInfo],
    amount: u64,
    program_id: &Pubkey,
) -> ProgramResult {
    ...
        let escrow_account = next_account_info(account_info_iter)?;
        let rent = &Rent::from_account_info(next_account_info(account_info_iter)?)?;

        if !rent.is_exempt(escrow_account.lamports(), escrow_account.data_len()) {
            return Err(EscrowError::NotRentExempt.into());
        }

        let mut escrow_info = Escrow::unpack_unchecked(&escrow_account.try_borrow_data()?)?;
        if escrow_info.is_initialized() {
            return Err(ProgramError::AccountAlreadyInitialized);
        }

        escrow_info.is_initialized = true;
        escrow_info.initializer_pubkey = *initializer.key;
        escrow_info.temp_token_account_pubkey = *temp_token_account.key;
        escrow_info.initializer_token_to_receive_account_pubkey = *token_to_receive_account.key;
        escrow_info.expected_amount = amount;

        Escrow::pack(escrow_info, &mut escrow_account.try_borrow_mut_data()?)?;
        let (pda, _nonce) = Pubkey::find_program_address(&[b"escrow"], program_id);
    ...
    Ok(())
}
...
```

Tiáº¿p theo trong hÃ m `process_init_escrow` chÃºng ta sáº½ pháº£i láº¥y Account `escrow_program` vÃ  Account `rent`. Sau Ä‘Ã³, thá»±c hiá»‡n `unpack` dá»¯ liá»‡u Ä‘Æ°á»£c Ä‘Ã­nh kÃ©m trong Account `escrow_program`, kiá»ƒm tra xem `escrow_info` Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o chÆ°a. Chá»— nÃ y sáº½ raise ra lá»—i náº¿u nÃ³ Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o, mÃ  chÃºng ta láº¡i khá»Ÿi táº¡o 1 láº§n ná»¯a. ChÃºng ta sáº½ truyá»n dá»¯ liá»‡u Ä‘á»‘i sá»‘ vÃ o vÃ  Ä‘Ã³ng gÃ³i dá»¯ liá»‡u má»›i vÃ o dá»¯ liá»‡u Ä‘Ã£ Ä‘Ã­nh kÃ¨m trong Account `escrow_program`.

PhÃ­a trÃªn mÃ¬nh cÃ³ nháº¯c tá»›i PDA, váº­y nÃ³ lÃ  cÃ¡i gÃ¬ váº­y ? ğŸ¤£ğŸ¤£ÄÃ³ chÃ­nh lÃ  1 public key trong Solana theo chuáº©n [ED25519](http://ed25519.cr.yp.to/). Trong Solana, táº¥t cáº£ cÃ¡c public key Ä‘á»u pháº£i tuÃ¢n thá»§ theo Ä‘Æ°á»ng cong Eliptic, PDA sinh ra tá»« `program_id` vÃ  `seeds`, nhÆ°ng `seeds` láº¡i khÃ´ng náº±m trÃªn Ä‘Æ°á»ng cong, nÃªn PDA sáº½ khÃ´ng tuÃ¢n theo Ä‘Æ°á»ng cong Eliptic. Chi tiáº¿t báº¡n cÃ³ thá»ƒ Ä‘á»c [Program Derived Address](https://docs.solana.com/developing/programming-model/calling-between-programs#program-derived-addresses).

![image.png](https://images.viblo.asia/1dfcb112-b07d-4d1b-b094-ca95cdb0a576.png)

Alice sáº½ pháº£i cáº¥p quyá»n sá»Ÿ há»¯u token X tá»« Account temp sang cho PDA. ChÃºng ta táº¡o nÃ³ báº±ng hÃ m `find_program_address` vÃ  truyá»n Ä‘á»‘i sá»‘ `program_id` vÃ  máº£ng cÃ¡c `seeds` vÃ o.

PDA gáº§n nhÆ° lÃ  thu Ä‘Æ°á»£c cháº¯c cháº¯n, tá»· lá»‡ tháº¥t báº¡i cá»§a hÃ m táº¡o PDA nÃ y khoáº£ng `1/2^255`, Ä‘iá»u nÃ y lÃ  gáº§n nhÆ° khÃ´ng thá»ƒ. 1 PDA cÃ³ thá»ƒ sá»Ÿ há»¯u nhiá»u Account temp token.

Äá»ƒ thá»±c hiá»‡n cáº¥p quyá»n chÃºng ta sáº½ pháº£i sá»­ dá»¥ng [Cross-Program Invocation](https://docs.solana.com/developing/programming-model/calling-between-programs#cross-program-invocations) vÃ  thá»±c thi `invoke` (cho Alice) hoáº·c `invoke_signed` (cho Bob). Chi tiáº¿t vá» sá»± khÃ¡c nhau thÃ¬ mÃ¬nh sáº½ giáº£i thÃ­ch sau.

```
...
fn process_init_escrow(
    accounts: &[AccountInfo],
    amount: u64,
    program_id: &Pubkey,
) -> ProgramResult {
    ...
        let token_program = next_account_info(account_info_iter)?;
        let owner_change_ix = spl_token::instruction::set_authority(
            token_program.key,
            temp_token_account.key,
            Some(&pda),
            spl_token::instruction::AuthorityType::AccountOwner,
            initializer.key,
            &[&initializer.key],
        )?;

        msg!("Calling the token program to transfer token account ownership...");
        invoke(
            &owner_change_ix,
            &[
                temp_token_account.clone(),
                initializer.clone(),
                token_program.clone(),
            ],
        )?;
    Ok(())
}
...
```

Vá» pháº§n táº¡o chá»¯ kÃ½, cÃ¡c báº¡n cÃ³ thá»ƒ tÃ¬m hiá»ƒu [Instructions that require privileges](https://docs.solana.com/developing/programming-model/calling-between-programs#instructions-that-require-privileges).

## Deploy chÆ°Æ¡ng trÃ¬nh

ToÃ n bá»™ code phÃ­a trÃªn mÃ¬nh Ä‘Ã£ giáº£i thÃ­ch cho lá»i gá»i khá»Ÿi táº¡o `InitEscrow`, chÃºng ta cÃ³ thá»ƒ hoÃ n toÃ n deploy ngay bÃ¢y giá». MÃ¬nh sáº½ giáº£i thÃ­ch chá»©c nÄƒng Exchange á»Ÿ bÃ i viáº¿t sau.

Compile toÃ n bá»™ project báº±ng cÃ¢u lá»‡nh:
```
cargo build-bpf
```

LÃºc nÃ y, trong thÆ° má»¥c `target/deploy/` sáº½ cÃ³ 2 file `.so` vÃ  file keypair.

ChÃºng ta cháº¡y lá»‡nh sau Ä‘á»ƒ deploy lÃªn máº¡ng devnet:

```
solana program deploy target/deploy/file_name.so
```

Blockchain Solana cÃ³ 2 site Ä‘á»ƒ chÃºng ta xem Ä‘Æ°á»£c má»i giao dá»‹ch diá»…n ra trong máº¡ng: [Explorer Solana](https://explorer.solana.com/) vÃ  [Solscan.io](https://solscan.io/). Báº¡n cÃ³ thá»ƒ paste Id cá»§a Program Ä‘Ã£ deploy, lÃªn pháº§n search cá»§a 2 site trÃªn.

# 5. TÃ i liá»‡u tham kháº£o

- Trang chá»§ cá»§a Blockchain Solana: https://solana.com
- Kiáº¿n trÃºc chÆ°Æ¡ng trÃ¬nh trong Solana: https://docs.solana.com/developing/programming-model/overview
- ThÆ° viá»‡n láº­p trÃ¬nh Solana: https://spl.solana.com
- Solana vÃ  Ethereum: https://www.fool.com/investing/2022/01/04/is-solana-a-better-buy-than-ethereum-in-2022
- Äiá»ƒm yáº¿u cá»§a Solana: https://solana.com/news/9-14-network-outage-initial-overview
- Code cho bÃ i viáº¿t: https://github.com/kobby-pentangeli/solana-escrow

> Trong bÃ i viáº¿t tá»›i, mÃ¬nh sáº½ cá»‘ gáº¯ng hoÃ n thiá»‡n chá»©c nÄƒng Exchange. CÅ©ng nhÆ° sáº½ táº¡o 1 giao diá»‡n UI báº±ng React Typescript vÃ  thÆ° viá»‡n [Solana Web3](https://solana-labs.github.io/solana-web3.js) Ä‘á»ƒ cÃ³ thá»ƒ káº¿t ná»‘i vÃ­ vÃ  tÆ°Æ¡ng tÃ¡c vá»›i Blockchain. ğŸ˜‰ğŸ˜‰

Cáº£m Æ¡n má»i ngÆ°á»i Ä‘Ã£ theo dÃµi Ä‘áº¿n Ä‘Ã¢y. ChÃºc má»i ngÆ°á»i nÄƒm má»›i An khang thá»‹nh vÆ°á»£ng, Váº¡n sá»± nhÆ° Ã½. ğŸ¤©ğŸ¤©