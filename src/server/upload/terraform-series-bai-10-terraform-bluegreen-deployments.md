## Gi·ªõi thi·ªáu
Ch√†o c√°c b·∫°n t·ªõi v·ªõi series v·ªÅ Terraform, ·ªü b√†i tr∆∞·ªõc ch√∫ng ta t√¨m hi·ªÉu v·ªÅ Zero-downtime deployments, nh∆∞ng ta ch·ªâ m·ªõi t√¨m hi·ªÉu c√°ch th·ª±c hi·ªán ZDD cho m·ªôt resource ƒë∆°n gi·∫£n l√† EC2. ·ªû b√†i n√†y ta s·∫Ω t√¨m hi·ªÉu c√°ch th·ª±c hi·ªán ZDD cho m·ªôt resource ph·ª©c t·∫°p h∆°n l√† Autoscaling Group b·∫±ng ph∆∞∆°ng ph√°p Blue/Green deployments.

![](https://images.viblo.asia/66d5204c-526a-4766-a4a0-71a2d778406e.jpg)

B√†i n√†y m√¨nh tham kh·∫£o t·ª´ cu·ªën Terraform in Action, c√°c b·∫°n n√™n ƒë·ªçc th·ª≠ cu·ªën n√†y v√¨ n√≥ r·∫•t hay üòÅ.

## Blue/Green deployments
Blue/Green deployments l√† m·ªôt ph∆∞∆°ng ph√°p gi√∫p ta th·ª±c hi·ªán Zero-downtime khi tri·ªÉn khai m·ªôt version m·ªõi c·ªßa ·ª©ng d·ª•ng. ƒê√¢y l√† ph∆∞∆°ng ph√°p c≈© nh·∫•t nh∆∞ng l·∫°i ƒë∆∞·ª£c s·ª≠ d·ª•ng nhi·ªÅu nh·∫•t, c√°c ph∆∞∆°ng ph√°p c·∫£i ti·∫øn h∆°n c·ªßa Blue/Green deployments l√† Rolling Blue/Green ho·∫∑c Canary deployments.

ƒê·ªÉ th·ª±c hi·ªán Blue/Green deployment th√¨ ·ª©ng d·ª•ng c·ªßa ta s·∫Ω c√≥ hai m√¥i tr∆∞·ªùng production, m·ªôt th·∫±ng s·∫Ω ƒë∆∞·ª£c g·ªçi l√† Blue v√† m·ªôt th·∫±ng ƒë∆∞·ª£c g·ªçi l√† Green, ch·ªâ m·ªôt trong hai th·∫±ng n√†y s·∫Ω ·ªü tr·∫°ng th√°i **live** ƒë·ªÉ nh·∫≠n request c·ªßa user, c√≤n m·ªôt th·∫±ng con l·∫°i s·∫Ω ·ªü tr·∫°ng th√°i **idle** (kh√¥ng l√†m vi·ªác).

Khi ta mu·ªën tri·ªÉn khai version m·ªõi c·ªßa ·ª©ng d·ª•ng, ta s·∫Ω tri·ªÉn khai tr√™n m√¥i tr∆∞·ªùng ƒëang ·ªü tr·∫°ng th√°i idle (c√≥ th·ªÉ l√† Blue ho·∫∑c Green), sau ƒë√≥ ta ki·ªÉm ta m·ªçi th·ª© tr√™n m√¥i tr∆∞·ªùng idle ƒë√£ ho·∫°t ƒë·ªông ·ªïn h·∫øt th√¨ ta chuy·ªÉn router t·ª´ m√¥i tr∆∞·ªùng live sang idle.

![](https://images.viblo.asia/280fc352-93a7-4af7-b86e-6271943d1c76.jpg)

### Blue/Green deployments with Autoscaling Group
Trong b√†i n√†y ch√∫ng ta s·∫Ω l√†m v√≠ d·ª• Blue/Green deployments cho resource Autoscaling Group tr√™n AWS. Ki·∫øn tr√∫c c·ªßa ta s·∫Ω bao g·ªìm:
+ Virtual Private Cloud (VPC).
+ Application Load Balancer (ALB).
+ 2 Autoscaling Group (Blue/Green).

![](https://images.viblo.asia/dd438d8a-1c1c-4916-8ee1-b18c2b5a4b36.jpg)

### Base resource and Application resource
Khi th·ª±c hi·ªán Blue/Green deployments, vi·ªác ƒë·∫ßu ti√™n ta c·∫ßn l√†m l√† x√°c ƒë·ªãnh resource n√†o l√† base resource v√† resource n√†o l√† application resource. V·ªõi base resource l√† c√°c th√†nh ph·∫ßn ƒë∆∞·ª£c s·ª≠ d·ª•ng chung v√† s·∫Ω kh√¥ng thay ƒë·ªïi nhi·ªÅu trong qu√° tr√¨nh deploy, c√≤n application resource c√≥ th·ªÉ thay ƒë·ªïi nhi·ªÅu trong qu√° tr√¨nh deploy, th·∫≠m ch√≠ c√≥ th·ªÉ x√≥a n√≥ lu√¥n v√† t·∫°o l·∫°i th·∫±ng m·ªõi m√† kh√¥ng ·∫£nh h∆∞·ªüng g√¨ t·ªõi h·ªá th·ªëng c·ªßa ta.

V√≠ d·ª• v·ªõi m√¥ h√¨nh Autoscaling Group ·ªü tr√™n th√¨ c√°c th√†nh ph·∫ßn thu·ªôc base resource l√† VPC v√† ALB, c√≤n application resource l√† Autoscaling Group. Khi ta tri·ªÉn khai m·ªôt version m·ªõi c·ªßa ·ª©ng d·ª•ng th√¨ ch·∫Øc ch·∫Øn l√† VPC c·ªßa ta s·∫Ω gi·ªØ nguy√™n kh√¥ng thay ƒë·ªïi g√¨ (b·ªüi v√¨ ch·∫£ c√≥ l√Ω do g√¨ m√† ta c·∫ßn ph·∫£i t·∫°o m·ªõi VPC ƒë·ªÉ deploy version m·ªõi c·ªßa ·ª©ng d·ª•ng c·∫£), c√≤n ALB th√¨ c√≥ th·ªÉ thay ƒë·ªïi m·ªôt ch√∫t. C√≤n Autoscaling Group th√¨ ta c√≥ th·ªÉ x√≥a th·∫±ng c≈© v√† t·∫°o l·∫°i th·∫±ng m·ªõi c≈©ng ƒë∆∞·ª£c.

> ƒê·ªëi v·ªõi c√°c resource d√πng ƒë·ªÉ l∆∞u d·ªØ li·ªáu nh∆∞ l√† database, th√¨ ƒë·ªÉ chuy·ªÉn ƒë·ªïi database gi·ªØa c√°c m√¥i tr∆∞·ªùng l√† m·ªôt v·∫•n ƒë·ªÅ r·∫•t ph·ª©c t·∫°p n√™n th√¥ng th∆∞·ªùng ta s·∫Ω x·∫øp database v√†o trong base resource.

![image.png](https://images.viblo.asia/3656e57e-6da1-4248-bf23-1b818b26597a.png)

V√† khi deploy ta ch·ªâ c·∫ßn t√°c ƒë·ªông t·ªõi application resource, sau ƒë√≥ ta s·∫Ω ti·∫øn h√†nh th·ª±c hi·ªán chuy·ªÉn traffic c·ªßa application resource t·ª´ m√¥i tr∆∞·ªùng live sang idle, c√≥ th·ªÉ l√† t·ª± ƒë·ªông ho·∫∑c l√†m b·∫±ng tay.

### Implement
Ta s·∫Ω c√≥ m·ªôt Autoscaling Group cho version 1.0, v√† ta g√°n cho n√≥ l√† Green. Sau ƒë√≥ ·ª©ng d·ª•ng c·ªßa ta s·∫Ω c√≥ version m·ªõi l√† 2.0, ta s·∫Ω t·∫°o th√™m m·ªôt Autoscaling Group cho version 2.0 v√† g√°n cho n√≥ l√† Blue. Hi·ªán t·∫°i th√¨ Green s·∫Ω l√† m√¥i tr∆∞·ªùng live, c√≤n Blue s·∫Ω l√† m√¥i tr∆∞·ªùng idle.

V√† sau ƒë√≥ ta s·∫Ω ti·∫øn h√†nh chuy·ªÉn router cho traffic t·ª´ Green sang Blue b·∫±ng tay (vi·ªác chuy·ªÉn router nh∆∞ v·∫≠y ƒë∆∞·ª£c g·ªçi l√† **cutover**). T·∫°o m·ªôt file t√™n l√† `main.tf` v·ªõi ƒëo·∫°n code sau.

```main.tf
provider "aws" {
  region  = "us-west-2"
}

variable "production" {
  default = "green"
}

module "base" {
  source     = "terraform-in-action/aws/bluegreen//modules/base"
  production = var.production
}

module "green" {
  source      = "terraform-in-action/aws/bluegreen//modules/autoscaling"
  app_version = "v1.0"
  label       = "green"
  base        = module.base
}

output "lb_dns_name" {
  value = module.base.lb_dns_name
}
```

·ªû tr√™n ta s·∫Ω s·ª≠ d·ª•ng module l√† `terraform-in-action/aws/bluegreen` cho v√≠ d·ª• n√†y, trong module tr√™n s·∫Ω c√≥ base resource l√† VPC v·ªõi ALB t·ª´ submodule `modules/autoscaling`, c√≤n application resource l√† Autoscaling Group t·ª´ submodule `modules/autoscaling`.

·ª®ng d·ª•ng version 1.0 c·ªßa ta ƒë∆∞·ª£c deploy b·∫±ng submodule `terraform-in-action/aws/bluegreen//modules/autoscaling` v√† ta ƒë·∫∑t t√™n cho n√≥ l√† green.

Oke, gi·ªù ti·∫øn h√†nh deploy version 1.0 n√†o.

```
$ terraform apply -auto-approve
...
Plan: 34 to add, 0 to change, 0 to destroy.
...
Apply complete! Resources: 34 added, 0 changed, 0 destroyed.

Outputs:

lb_dns_name = "terraforminaction-ovgcpc-lb-909615962.us-west-2.elb.amazonaws.com"
```

ƒê·ª£i khi terraform ch·∫°y xong th√¨ n√≥ s·∫Ω in ra cho ta domain c·ªßa ALB, ta truy c·∫≠p v√†o domain ƒë√≥.

![image.png](https://images.viblo.asia/a4f199c3-f2ab-4599-b43e-75e5da694d09.png)

Ti·∫øp theo ta s·∫Ω deploy version 2.0 c·ªßa ·ª©ng d·ª•ng v√† ƒë·∫∑t t√™n cho n√≥ l√† blue.

```main.tf
...
module "green" {
  source      = "terraform-in-action/aws/bluegreen//modules/autoscaling"
  app_version = "v1.0"
  label       = "green"
  base        = module.base
}

module "blue" {
  source      = "terraform-in-action/aws/bluegreen//modules/autoscaling"
  app_version = "v2.0"
  label       = "blue"
  base        = module.base
}
...
```

Ch·∫°y c√¢u l·ªánh.

```
$ terraform apply -auto-approve
...
Plan: 5 to add, 0 to change, 0 to destroy.
...
Apply complete! Resources: 5 added, 0 changed, 0 destroyed.

Outputs:

lb_dns_name = "terraforminaction-ovgcpc-lb-909615962.us-west-2.elb.amazonaws.com"
```

Sau khi ta ki·ªÉm tra m·ªçi th·ª© ·ªü m√¥i tr∆∞·ªùng blue ƒë·ªÅu ·ªïn h·∫øt, ta ti·∫øn h√†nh ƒë·ªïi router c·ªßa traffic v√†o ·ª©ng d·ª•ng.

### Blue/Green cutover
C√°c b·∫°n l√†m vi·ªác n√†y b·∫±ng m·ªôt c√°ch ƒë∆°n gi·∫£n l√† thay ƒë·ªïi gi√° tr·ªã c·ªßa bi·∫øn `production` trong file `main.tf`.

Chuy·ªÉn gi√° tr·ªã t·ª´ green.

```main.tf
...
variable "production" {
  default = "green"
}
...
```

Th√†nh blue.

```main.tf
provider "aws" {
  region  = "us-west-2"
}

variable "production" {
  default = "blue" // change here
}

module "base" {
  source     = "terraform-in-action/aws/bluegreen//modules/base"
  production = var.production
}

module "green" {
  source      = "terraform-in-action/aws/bluegreen//modules/autoscaling"
  app_version = "v1.0"
  label       = "green"
  base        = module.base
}

module "blue" {
  source      = "terraform-in-action/aws/bluegreen//modules/autoscaling"
  app_version = "v2.0"
  label       = "blue"
  base        = module.base
}

output "lb_dns_name" {
  value = module.base.lb_dns_name
}
```

Ch·∫°y c√¢u l·ªánh apply.

```
$ terraform apply -auto-approve
...
Plan: 0 to add, 2 to change, 0 to destroy.
...
Apply complete! Resources: 0 added, 2 changed, 0 destroyed.

Outputs:

lb_dns_name = "terraforminaction-ovgcpc-lb-909615962.us-west-2.elb.amazonaws.com"
```

Sau khi terraform ch·∫°y xong, n√≥ s·∫Ω chuy·ªÉn target group c·ªßa ALB t·ª´ Autoscaling Group Green sang Blue. Ta t·∫£i l·∫°i trang v√† c√°c b·∫°n s·∫Ω th·∫•y n√≥ chuy·ªÉn th√†nh blue v·ªõi version 2.0.

![image.png](https://images.viblo.asia/7c4b12da-dd0d-4ab8-b226-0f2131e56066.png)

Oke, ta l√†m m·ªôt v√≠ d·ª• ƒë∆°n gi·∫£n v·ªÅ Blue/Green deployments th√†nh c√¥ng üòÅ. Khi ta th·ª±c hi·ªán Blue/Green deployments th·∫ø n√†y th√¨ ta c√≥ th·ªÉ gi·∫£m th·ªùi gian down time c·ªßa ·ª©ng d·ª•ng nhi·ªÅu nh·∫•t c√≥ th·ªÉ.

B√¢y gi·ªù th√¨ ta ƒëang c√≥ hai m√¥i tr∆∞·ªùng production l√† Green v√† Blue, n·∫øu ta l·∫°i c√≥ m·ªôt version m·ªõi c·ªßa ·ª©ng d·ª•ng l√† 3.0, ta ch·ªâ vi·ªác c·∫≠p nh·∫≠t gi√° tr·ªã app_version c·ªßa `module green` l·∫°i th√†nh 3.0 v√† chuy·ªÉn gi√° tr·ªã c·ªßa bi·∫øn `production` l·∫°i th√†nh green.

**Ta nh·ªõ ch·∫°y c√¢u l·ªánh destroy ƒë·ªÉ x√≥a resource nh√©.**

## K·∫øt lu·∫≠n
V·∫≠y l√† ta ƒë√£ t√¨m hi·ªÉu xong v·ªÅ Blue/Green deployments, ƒë√¢y ch·ªâ l√† m·ªôt trong nh·ªØng ph∆∞∆°ng ph√°p ƒë·ªÉ th·ª±c hi·ªán Zero-downtime deployments, c√°c b·∫°n c√≥ th·ªÉ t√¨m hi·ªÉu th√™m v·ªÅ Rolling Blue/Green deployments v√† Canary deployments ƒë·ªÉ ta c√≥ th√™m nhi·ªÅu s·ª± l·ª±a ch·ªçn n·ªØa khi ti·∫øn h√†nh deploy ·ª©ng d·ª•ng v·ªõi version m·ªõi. N·∫øu c√≥ th·∫Øc m·∫Øc ho·∫∑c c·∫ßn gi·∫£i th√≠ch r√µ th√™m ch·ªó n√†o th√¨ c√°c b·∫°n c√≥ th·ªÉ h·ªèi d∆∞·ªõi ph·∫ßn comment. H·∫πn g·∫∑p m·ªçi ng∆∞·ªùi ·ªü b√†i ti·∫øp theo ta s·∫Ω t√¨m hi·ªÉu v·ªÅ m·ªôt ph∆∞∆°ng ph√°p deployment ti·∫øp theo l√† **A/B Testing Deployment**.

## M·ª•c t√¨m ki·∫øm ƒë·ªìng ƒë·ªôi

![Ho√†ng Ph√∫c](https://images.viblo.asia/9fbde6d9-5e57-4429-a903-10a961e1c96c.png)

Team c√¥ng ngh·ªá Ho√†ng Ph√∫c c·ªßa b·ªçn m√¨nh ƒë∆∞·ª£c th√†nh l·∫≠p v·ªõi nhi·ªám v·ª• l√† x√¢y d·ª±ng m·ªôt h·ªá th·ªëng c√¥ng ngh·ªá n·ªôi b·ªô cho c√¥ng ty, Ho√†ng Ph√∫c l√† m·ªôt c√¥ng ty b√°n l·∫ª trong lƒ©nh v·ª±c th·ªùi trang v√† c√≥ h∆°n 30 nƒÉm tu·ªïi ƒë·ªùi, v·ªõi chu·ªói c·ª≠a h√†ng r·∫•t nhi·ªÅu tr√™n to√†n qu·ªëc, n√™n vi·ªác v·∫≠n h√†nh c·ªßa Ho√†ng Ph√∫c l√† r·∫•t l·ªõn v√† vi·ªác x√¢y d·ª±ng ƒë∆∞·ª£c m·ªôt h·ªá th·ªëng c√¥ng ngh·ªá ƒë·ªÉ ƒë√°p ·ª©ng vi·ªác v·∫≠n h√†nh n·ªôi b·ªô cho c√¥ng ty l√† m·ªôt c√¥ng vi·ªác r·∫•t th·ª≠ th√°ch, ƒë√¢y l√† m·ªôt qu√° tr√¨nh chuy·ªÉn ƒë·ªïi s·ªë v√† team b·ªçn m√¨nh ƒë√£ l√†m ƒë∆∞·ª£c nh·ªØng b∆∞·ªõc ban ƒë·∫ßu.

Th·ª© m√† team m√¨nh th·∫•y c·∫•n duy nh·∫•t l√† c√°i website, ƒë√¢y l√† trang web m√† tr∆∞·ªõc khi team m√¨nh ƒë∆∞·ª£c th√†nh l·∫≠p ƒë√£ c√≥ m·ªôt ƒë·ªôi outsource kh√°c l√†m, v√† nh·ªØng g√¨ h·ªç ƒë·ªÉ l·∫°i cho b·ªçn m√¨nh l√† m·ªôt trang web v·ªõi ƒë·ªëng b√πi nh√πi, v·ªõi s·ªë ƒëi·ªÉm t·ª´ google l√† 1 tr√™n 100. V·∫≠y b·ªçn m√¨nh s·∫Ω l√†m g√¨ v·ªõi trang web n√†y ƒë√¢y, n·∫£n ch√≠ sao? ƒêi·ªÅu ƒë√≥ kh√¥ng c√≥ trong t·ª´ ƒëi·ªÉn c·ªßa hai s·∫øp m√¨nh, v√† v·ªõi s·ª± d·∫´n d·∫Øt c·ªßa hai s·∫øp team m√¨nh s·∫Ω bi·∫øn ƒë·ªëng website b√πi nh√πi ƒë√≥ th√†nh kim c∆∞∆°ng, nh∆∞ c√°ch b·ªçn m√¨nh ƒë√£ c·∫£i thi·ªán h·ªá th·ªëng n·ªôi b·ªô. B·ªçn m√¨nh ƒëang c·∫£i thi·ªán trang web h·∫±ng ng√†y v√† h·∫±ng ng√†y, t·ª´ 1 ƒëi·ªÉm b·ªçn m√¨nh ƒë√£ c·∫£i thi·ªán n√≥ l√™n 70 ƒëi·ªÉm, v√† m·ª•c ti√™u l√† tr√™n 90 ƒëi·ªÉm.

Hi·ªán t·∫°i team b·ªçn m√¨nh ƒëang c·∫ßn c√°c ƒë·ªìng ƒë·ªôi tham gia ƒë·ªÉ c·∫£i thi·ªán l·∫°i trang web v·ªõi s·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng truy c·∫≠p kh√° l·ªõn, ƒë√¢y l√† m·ªôt th·ª≠ th√°ch r·∫•t th√∫ v·ªã, c√≥ bao gi·ªù c√°c b·∫°n ƒë∆∞·ª£c tham gia thi·∫øt k·∫ø m·ªôt h·ªá th·ªëng l·ªõn t·ª´ ƒë·∫ßu ch∆∞a, m√¨nh kh√° ch·∫Øc l√† s·ªë l∆∞·ª£ng ƒë√≥ r·∫•t √≠t. B·ªçn m√¨nh ƒë√£ c√≥ kh√°ch h√†ng, nh·ªØng g√¨ c√≤n l·∫°i l√† c·∫ßn nh·ªØng ƒë·ªìng ƒë·ªôi ƒë·ªÉ c√πng nhau ph√°t tri·ªÉn m·ªôt h·ªá th·ªëng ƒë·ªÉ ph·ª•c v·ª• r·∫•t nhi·ªÅu ng∆∞·ªùi d√πng. M·ª•c ti√™u c·ªßa c√¥ng ty Ho√†ng Ph√∫c l√† tr·ªü th√†nh nh√† b√°n l·∫ª v·ªÅ th·ªùi trang l·ªõn nh·∫•t Vi·ªát Nam, h√£y tham gia v·ªõi b·ªçn m√¨nh nh√©. M·ªôt th√†nh vi√™n trong team m√¨nh kh√¥ng y√™u c·∫ßn ph·∫£i gi·ªèi, ch·ªâ c·∫ßn h√≤a ƒë·ªìng, h·ª£p t√°c v√† s·∫µn s√†ng h·ª£p t√°c v·ªõi nhau. C√≥ th·ªÉ b·∫°n kh√¥ng l√† gi·ªèi nh·∫•t nh∆∞ng n·∫øu gia nh·∫≠p v·ªõi b·ªçn m√¨nh th√¨ b·∫°n s·∫Ω t·∫°o ra ƒë∆∞·ª£c nh·ªØng th·ª© gi√° tr·ªã nh·∫•t.

ƒê·ªìng ƒë·ªôi [Backend Engineer (Magento - PHP)](https://tuyendung.hoang-phuc.com/job/backend-engineer-magento-php-1538).

ƒê·ªìng ƒë·ªôi [Senior Backend Engineer](https://tuyendung.hoang-phuc.com/job/senior-backend-engineer-1022).

ƒê·ªìng ƒë·ªôi [Senior Frontend Engineer](https://tuyendung.hoang-phuc.com/job/senior-frontend-engineer-1021).