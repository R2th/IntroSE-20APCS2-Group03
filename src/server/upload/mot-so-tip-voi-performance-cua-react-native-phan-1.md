## How React native applications work?

React Native l√† m·ªôt framework cho ph√©p developer build m·ªôt native app s·ª≠ d·ª•ng JS. C√≥ v·∫ª t·ª´ **cross platform** b·∫°n ƒë√£ t·ª´ng nghe qua ho·∫∑c c√≥ th·ªÉ ƒë√£ s·ª≠ d·ª•ng nh∆∞ Cordova. S·ª± th·∫≠t ƒëau bu·ªìn thay Cordova ƒë√£ g·∫ßn nh∆∞ r∆°i v√†o l√£ng qu√™n. V·∫≠y l√Ω do g√¨ mu·ªën b·∫°n l·∫°i mu·ªën s·ª≠ d·ª•ng React Native ?

ƒêi·ªÉm kh√°c bi·ªát ch√≠nh gi·ªØa React Native v√† Cordova l√† Cordova ch·∫°y tr√™n m·ªôt webview, trong khi RN l·∫°i render tr√™n Native view. ·ª®ng d·ª•ng Rn truy c·∫≠p tr·ª±c ti·∫øp v√†o c√°c Native api v√† view ƒë∆∞·ª£c cung c·∫•p b·ªüi c√°c platfrom c·ª• th·ªÉ th√¥ng qua bridge gi·ªØa JS v√† native code. V√¨ v·∫≠y ·ª©ng d·ª•ng RN cho c·∫£m gi√°c gi·ªëng v√† hi·ªáu nƒÉng kh√° t·ªët v·ªõi m·ªôt ·ª©ng d·ª•ng Native

Ban ƒë·∫ßu, c√≥ nhi·ªÅu gi·∫£ ƒë·ªãnh r·∫±ng React Native c√≥ th·ªÉ compile JS code sang native m·ªôt c√°ch tr·ª±c ti·∫øp. Nh∆∞ng ƒëi·ªÅu ƒë√≥ th·ª±c s·ª± kh√≥ c√≥ th·ªÉ x·∫£y ra khi m√† Java l·∫´n obj-c l√† nh·ªØng ng√¥n ng·ªØ d·∫°ng **strongly typed** trong khi JS th√¨ kh√°c ( d√πng c·∫£ **dynamically** l·∫´n **weakly typed** ) v√¨ v·∫≠y RN s·∫Ω x·ª≠ l√Ω th√¥ng minh h∆°n, ch√∫ng ta s·∫Ω t√¨m hi·ªÉu React Native d√£ l√†m nh∆∞ th·∫ø n√†o (?)

> Ok! This looks like black magic üôÑ.

### Architecture ü§ñ

V·ªÅ c∆° b·∫£n React Native ƒë∆∞·ª£c coi l√† t·∫≠p h·ª£p c√°c react component c·∫•u th√†nh n√™n, m·ªói m·ªôt component s·∫Ω ƒë·∫°i di·ªán cho m·ªôt native view t∆∞∆°ng ·ª©ng. V√≠ d·ª• Textinput s·∫Ω t∆∞∆°ng ·ª©ng v·ªõi EditText trong Android hay TextField trong IOS .

![](https://images.viblo.asia/3bcc1b1d-d194-441d-80b2-1439f1b230b4.png)

**1. Native Code/ Modules** : H·∫ßu h·∫øt c√°c native code trong IOS ƒë∆∞·ª£c vi·∫øt b·∫±ng obj-c ho·∫∑c swift, trong Android b·∫±ng Java ho·∫∑c Kotlin. ƒê√¥i khi m·ªôt ·ª©ng d·ª•ng c·∫ßn truy c·∫≠p c√°c platform API v√† RN kh√¥ng c√≥ c√°c module t∆∞∆°ng ·ª©ng. C√≥ th·ªÉ b·∫°n c·∫ßn t√°i s·ª≠ d·ª•ng native code ho·∫∑c c√≥ th·ªÉ vi·∫øt c√°c ƒëo·∫°n code c√≥ performance cao, x·ª≠ l√Ω multi thread nh∆∞ image processing, I/O database‚Ä¶
RN cho ph√©p b·∫°n vi·∫øt native code th·ª±c s·ª± ƒë·ªÉ truy c·∫≠p t·ªëi ƒëa platform API. ƒê√¢y l√† ƒëi·ªÉm n·ªïi b·∫≠t c·ªßa RN so v·ªõi c√°c platform cross tr∆∞·ªõc ƒë√¢y, tuy kh√¥ng ph·∫£i l√† ƒëi·ªÅu m√† RN mu·ªën, nh∆∞ng n·∫øu RN kh√¥ng th·ªÉ h·ªó tr·ª£ b·∫°n ho√†n to√†n, b·∫°n c√≥ th·ªÉ [l√†m ƒëi·ªÅu ƒë√≥ v·ªõi native code](https://reactnative.dev/docs/native-modules-android.html) 

**2. JVM** : c√≥ th·ªÉ l√∫c ƒë·ªçc trong ƒë·∫ßu b·∫°n s·∫Ω c√≥ suy nghƒ© Java virtual machine trong Java (yaoming) 
![](https://images.viblo.asia/69215212-9275-481d-a364-453f7ec81e19.jpg)
Th·ª±c t·∫ø n√≥ l√† javascript virtual machine n∆°i th·ª±c thi JS code . Trong android/iOS, RN s·∫Ω dung JavaScriptCore, ƒë√¢y l√† opensource javascript engine th∆∞·ªùng ƒë∆∞·ª£c build cho Webkit. Trong TH c·ªßa IOS, RN s·∫Ω d√πng JavaScriptCore cung c·∫•p b·ªõi IOS platformm, n√≥ ƒë∆∞·ª£c gi·ªõi thi·ªáu l·∫ßn ƒë·∫ßu ti√™n trong iOS 7 c√πng v·ªõi OS X Mavericks. C√≤n ƒë·ªëi v·ªõi Android, RN s·∫Ω build k√®m g√≥i JavascriptCore trong ·ª©ng d·ª•ng => d·∫´n ƒë·∫øn size application c·ªßa ·ª©ng d·ª•ng tƒÉng l√™n m·ªôt √≠t. 

> Do ƒë√≥, ·ª©ng d·ª•ng Hello World c·ªßa RN s·∫Ω m·∫•t kho·∫£ng 3 ƒë·∫øn 4 megabyte cho Android.

Tr∆∞·ªùng h·ª£p Chrome Debug Mode , JS code s·∫Ω ch·∫°y tr·ª±c ti·∫øp tr√™n ch√≠nh chrome v√† giao ti·∫øp v·ªõi native code th√¥ng qua Websocket => ƒëi·ªÅu n√†y show cho ch√∫ng ta m·ªôt ƒë·ªëng th√¥ng tin nh∆∞ network request, console logs, etc. üòé

**3.  React Native Bridge:** 

![](https://images.viblo.asia/2bf1c0a1-0098-4ee3-b876-5550b0db6dbe.png)
![](https://images.viblo.asia/0f642be7-fd85-4522-a773-33ba769faa16.png)
B·∫°n c√≥ th·∫•y s·ª± kh√°c bi·ªát gi·ªØa RN v√† Flutter kh√¥ng :stuck_out_tongue_winking_eye:

L√† m·ªôt c·∫ßu n·ªëi C++/Java c√≥ tr√°ch nhi·ªám giao ti·∫øp gi·ªØa c√°c Native thread v√† JS thread. M·ªôt custom protocol ƒë∆∞·ª£c d√πng ƒë·ªÉ trao ƒë·ªïi message. 

Trong h·∫ßu h·∫øt c√°c tr∆∞·ªùng h·ª£p, m·ªôt developer s·∫Ω vi·∫øt ·ª©ng d·ª•ng RN b·∫±ng JS, ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng s·ª≠ d·ª•ng command CLI *react-native run-ios* ho·∫∑c* run-android*. ·ªû ƒë√¢y react-native CLI s·∫Ω sinh ra m·ªôt ***packager/bundler***  ƒë·ªÉ ƒë√≥ng g√≥i to√†n b·ªô JS code v√† m·ªôt file g·ªçi l√† **main.bundle.js**

Packager c√≥ th·ªÉ xem t∆∞∆°ng t·ª± nh∆∞ m·ªôt Webpack. B√¢y gi·ªù, b·∫•t c·ª© khi n√†o ·ª©ng d·ª•ng kh·ªüi ch·∫°y, item ƒë·∫ßu ti√™n ƒë∆∞·ª£c t·∫£i l√† Native entry point (hay AppRegistry). Native thread sinh ra JS VM thread m√† s·∫Ω d√πng ƒë·ªÉ ch·∫°y code JS k√®m theo.

Code JS s·∫Ω ch·ª©a t·∫•t c·∫£ c√°c business logic c·ªßa ·ª©ng d·ª•ng. Native thread g·ª≠i message th√¥ng qua RN Bridge ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng JS. L√∫c n√†y, JS thread ƒë∆∞·ª£c sinh ra s·∫Ω b·∫Øt ƒë·∫ßu ƒë∆∞a ra c√°c instruction (h∆∞·ªõng d·∫´n) cho Native thread th√¥ng qua RN Bridge. C√°c instruction n√†y bao g·ªìm View n√†o ƒë·ªÉ kh·ªüi ch·∫°y, th√¥ng tin n√†o ƒë∆∞·ª£c l·∫•y ra t·ª´ ph·∫ßn c·ª©ng ... V√≠ d·ª•, n·∫øu JS thread mu·ªën m·ªôt View v√† Text ƒë∆∞·ª£c t·∫°o, n√≥ s·∫Ω g·ª≠i y√™u c·∫ßu v√†o m·ªôt message ƒë∆°n v√† g·ª≠i n√≥ ƒë·∫øn Native thread ƒë·ªÉ render ch√∫ng.

> [ [2,3,[2,'Text',{...}]] [2,3,[3,'View',{...}]] ]

Native thread s·∫Ω th·ª±c thi nh·ªØng t√°c v·ª• n√†y v√† g·ªüi k·∫øt qu·∫£ ng∆∞·ª£c tr·ªü l·∫°i JS ƒë·∫£m b·∫£o r·∫±ng c√°c t√°c v·ª• ƒë√£ ƒë∆∞·ª£c th·ª±c hi·ªán.

### Threading Model üöß

**1. Main Thread (Native Queue):** ƒë∆∞·ª£c sinh ra ngay l√∫c ·ª©ng d·ª•ng kh·ªüi ch·∫°y. N√≥ s·∫Ω load app v√† start JS thread ƒë·ªÉ th·ª±c thi JS code. Native thread c≈©ng l·∫Øng nghe c√°c s·ª± ki·ªán UI nh∆∞ click, touch... Nh·ªØng s·ª± ki·ªán (event) n√†y s·∫Ω truy·ªÅn sang JS thread th√¥ng qua RN Bridge. M·ªôt khi JS load, JS thread g·ªüi th√¥ng tin c·∫ßn render l√™n m√†n h√¨nh. Nh·ªØng th√¥ng tin n√†y ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi shadow node thread ƒë·ªÉ t√≠nh to√°n layout. Shadow thread c∆° b·∫£n gi·ªëng nh∆∞ b·ªô m√°y t√≠nh to√°n ƒë·ªÉ ƒë∆∞a ra quy·∫øt ƒë·ªãnh cu·ªëi c√πng v·ªÅ c√°c v·ªã tr√≠ c·ªßa View trong layout. C√°c instruction n√†y sau ƒë√≥ s·∫Ω tr·∫£ ng∆∞·ª£c v·ªÅ Main thread ƒë·ªÉ render l√™n View.

**2. Javascript thread (JS Queue):** l√† thread queue l√† n∆°i c√°c JS thread ch·∫°y. JS thread ch·∫°y t·∫•t c·∫£ c√°c business logic c·ªßa ·ª©ng d·ª•ng.

**3. Custom Native Modules:** M·ªôt ph·∫ßn thread sinh ra b·ªüi React Native, ch√∫ng ta c≈©ng c√≥ th·ªÉ sinh ra nh·ªØng thread n√†y tr√™n m·ªôt custom native module ƒë·ªÉ tƒÉng t·ªëc performance c·ªßa ·ª©ng d·ª•ng. V√≠ d·ª•, Animation ƒë∆∞·ª£c handle trong React Native b·∫±ng m·ªôt native thread ƒë·ªÉ gi·∫£m t·∫£i cho JS thread.

### View Managers üëì

L√† m·ªôt native module d√πng map c√°c JSX View sang c√°c Native Views.

> To√†n b·ªô g√≥i View Managers v√† c√°c th√†nh ph·∫ßn kh√°c c·ªßa react ƒë∆∞·ª£c ch·ª©a trong package com.facebook.react, b·∫°n c√≥ th·ªÉ decompile 1 file apk b·∫•t k√¨.

```
import React, { Component } from 'react';
import { Text, View, AppRegistry } from 'react-native';

class HelloWorldApp extends Component {
  render() {
    return (
      <View style={{padding:40}}>
        <Text>Hello world!</Text>
      </View>
    );
  }
}

export default HelloWorldApp;
AppRegistry.registerComponent('HelloWorldApp', () => HelloWorldApp);
```

·ªû ƒë√¢y khi ch√∫ng ta t·∫°o <Text/>, TextViewManager s·∫Ω g·ªçi new TextView(getContext()) trong tr∆∞·ªùng h·ª£p android. View Manager c∆° b·∫£n l√† c√°c class extend t·ª´ ViewManager trong android ho·∫∑c RCTViewManager trong iOS.

### Development mode üî®

Khi ·ª©ng d·ª•ng ch·∫°y ·ªü DEV mode, JS thread ƒë∆∞·ª£c sinh ra tr√™n development machine. M·∫∑c d√π JS code ƒëang ch·∫°y tr√™n m·ªôt m√°y m·∫°nh h∆°n so v·ªõi m·ªôt chi·∫øc ƒëi·ªán tho·∫°i, b·∫°n v·∫´n s·∫Ω c·∫£m nh·∫≠n ƒë∆∞·ª£c t·ªëc ƒë·ªô ch·∫°y c·ªßa n√≥ s·∫Ω ch·∫≠m h∆°n so v·ªõi khi build ·ªü *PRODUCTION* mode. ƒêi·ªÅu n√†y l√† kh√¥ng th·ªÉ tr√°nh v√¨ r·∫•t nhi·ªÅu c√¥ng vi·ªác ƒë∆∞·ª£c th·ª±c thi ·ªü DEV mode l√∫c runtime ƒë·ªÉ cung c·∫•p nh·ªØng c·∫£nh b√°o, th√¥ng b√°o l·ªói nh∆∞ validate propTypes v√† m·ªôt s·ªë assertion kh√°c. Ngo√†i ra, ƒë·ªô tr·ªÖ c·ªßa giao ti·∫øp gi·ªØa thi·∫øt b·ªã v√† JS thread c≈©ng l√† 1 nguy√™n nh√¢n.

## Hunting memory leaks in React Native apps

![](https://images.viblo.asia/46abbe33-5ca3-463c-bb12-a92824528eb8.jpg)

Trong JS, memory ƒë∆∞·ª£c qu·∫£n l√Ω t·ª± ƒë·ªông b·ªüi [Garbage Collector (GC)] (https://en.wikipedia.org/wiki/Garbage_collection_(computer_science)) . GC l√† m·ªôt backgroud process , m·ªôt anh qu·∫£n l√Ω ƒë√¥ th·ªã c√≥ nh·ªØng chuy·∫øn ki·ªÉm tra ƒë·ªãnh k·ª≥ b·∫£n ƒë·ªì quy ho·∫°nh nh√† c·ª≠a ƒë·∫•t c√°t c·ªßa c√°c h·ªô d√¢n ( objects ). N·∫øu t√¨nh c·ªù g·∫∑p m·ªôt ng√¥i nh√† hay m·ªôt m·∫£nh ƒë·∫•t kh√¥ng c√≥ ch·ªß s·ªü h·ªØu tr·ª±c ti·∫øp hay gi√°n ti·∫øp s·∫Ω b·ªã ban qu·∫£n l√Ω thu l·∫°i v√† b√°n cho c√°c h·ªô d√¢n c·∫ßn n√≥ ( gi·∫£i ph√≥ng b·ªô nh·ªõ cho c√°c object kh√°c c·∫ßn d√πng).

> Nhi·ªÅu b·∫°n s·∫Ω l·∫ßm t∆∞·ªüng r·∫±ng c√°c ng√¥n ng·ªØ d·ª±a tr√™n Garbage Collection (GC) ƒë·ªÉ qu·∫£n l√Ω b·ªô nh·ªõ ( nh∆∞ Java, Javascript ) c√≥ kh·∫£ nƒÉng ngƒÉn c·∫£n memory leaks

ƒê·ªÉ m√¨nh ch·ªâ cho b·∫°n m·ªôt v√≠ d·ª•, trong m·ªôt ng√¥i nh√† c√≥ b·∫°n v√† b·ªë m·∫π , c√≥ th·ªÉ coi ƒë√¢y 2 reference cho 1 ƒë·ªëi t∆∞·ª£ng l√† ng√¥i nh√†. Khi b·∫°n l·ªõn l√™n v√† s·ªëng t·ª± l·∫≠p, b·∫°n r·ªùi kh·ªèi ng√¥i nh√† ( reference c·ªßa b·∫°n ƒë·∫øn ƒë·ªëi t∆∞·ª£ng nh√† b·ªã x√≥a b·ªè ) nh∆∞ng v·∫´n c√≤n reference l√† b·ªë m·∫π b·∫°n. V·∫≠y n√™n khi anh qu·∫£n l√Ω ƒë√¥ th·ªã (GC) ƒëi ki·ªÉm tra v·∫´n th·∫•y object c√≤n reference ƒë·∫øn n√≥ d·∫´n ƒë·∫øn object ƒë√≥ kh√¥ng ƒë∆∞·ª£c gi·∫£i ph√≥ng

D∆∞·ªõi ƒë√¢y l√† m·ªôt s·ªë l·ªói ph·ªï bi·∫øn trong m·ªôt ·ª©ng d·ª•ng React native d·∫´n ƒë·∫øn memory leaks:
### 1. Unreleased timers/listeners added in componentDidMount

```
class Composer extends Component {
  state = { showAccessory: false }
  componentDidMount() {
    Keyboard.addListener('keyboardDidShow', () => this.setState({ showAccessory: true }));
    Keyboard.addListener('keyboardDidHide', () => this.setState({ showAccessory: false }));
  }

  render() {
    return (
      <View>
        <EditTextComponent />
        {this.state.showAccessory && <AccessoryView />}
      </View>
    );
  }
}
```

Trong v√≠ d·ª• tr√™n, ch√∫ng ta l·∫Øng nghe s·ª± ki·ªán **keyboardDidShow** v√† **keyboardDidHide** ƒë·ªÉ l∆∞u gi·ªØ tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa keyboard nh∆∞ l√† m·ªôt state c·ªßa component. S·ª± ki·ªán ƒë∆∞·ª£c ƒëƒÉng k√Ω khi component ƒë∆∞·ª£c render xong, nh∆∞ng d∆∞·ªùng nh∆∞ ·ªü v√≠ d·ª• tr√™n s·ª± ki·ªán tr√™n s·∫Ω kh√¥ng bao gi·ªù b·ªã remove ƒëi. Do ƒë√≥, ch√∫ng ta v·∫´n nh·∫≠n ƒë∆∞·ª£c c√°c event ngay c·∫£ khi component unmounted. ƒê·ªìng th·ªùi, Keyboard module s·∫Ω gi·ªØa l·∫°i c√°c danh s√°ch c√°c active listeners trong global scope. C·ª• th·ªÉ trong TH n√†y n√≥ s·∫Ω gi·ªØ nh·ªØng th√¥ng tin trong arrows function ƒë∆∞·ª£c truy·ªÅn th√¥ng qua ph∆∞∆°ng th·ª©c addListener. L·∫ßn l∆∞·ª£t, arrow functions gi·ªØ *this* -   reference c·ªßa Composer component. ƒê·ªÉ l·∫ßn l∆∞·ª£t truy c·∫≠p properties c·ªßa n√≥ th√¥ng qua this.props. Con c·ªßa n√≥ this.props.children, con c·ªßa con n√≥, etc... L·ªói n√†y ƒë∆°n gi·∫£n d·∫´n ƒë·∫øn v√πng nh·ªõ r·∫•t b·ªã gi·ªØ l·∫°i r·∫•t l·ªõn do c√°c reference gi·ªØ l·∫°i. Trong TH tr√™n ch√∫ng ta c√≥ th·ªÉ remove listeners trong **componentWillUnmount**

```
class Composer extends Component {
  state = { showAccessory: false };

  componentDidMount() {
    this.keyboardDidShowListener = Keyboard.addListener('keyboardDidShow', () =>
      this.setState({ showAccessory: true })
    );
    this.keyboardDidHideListener = Keyboard.addListener('keyboardDidHide', () =>
      this.setState({ showAccessory: false })
    );
  }

  componentWillUnmount() {
    this.keyboardDidShowListener.remove();
    this.keyboardDidHideListener.remove();
  }

  render() {
    return (
      <View>
        <EditTextComponent />
        {this.state.showAccessory && <AccessoryView />}
      </View>
    );
  }
}}
```

**Lu√¥n lu√¥n nh·ªõ r·∫±ng :**

> N·∫øu component c·ªßa b·∫°n c√≥ ƒëƒÉng k√Ω l·∫Øng nghe ho·∫∑c s·ª≠ d·ª•ng setTimeOut, setInterval ho·∫∑c s·ª≠ d·ª•ng nh·ªØng method d∆∞·ªõi d·∫°ng m·ªôt callback funtion. H√£y ch·∫Øc ch·∫Øn r·∫±ng nh∆∞ng listener v√† callback ƒë∆∞·ª£c xo√° b·ªè ho√†n to√†n khi m√† component unmounts.

ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ tr√™n ch√∫ng ta c√≥ th·ªÉ tham kh·∫£o [HOC ( Higher-Order Components )](https://medium.com/@bosung90/use-higher-order-component-in-react-native-df44e634e860).

### 2. Closure scope leaks

M·ªôt c√°ch ƒë∆°n gi·∫£n,** Closure scope** c√≥ nghƒ©a l√† h√†m n·∫±m trong ph·∫°m vi c·ªßa h√†m kh√°c c√≥ th·ªÉ tham chi·∫øu t·ªõi c√°c bi·∫øn c·ªßa h√†m bao n√≥. V·∫≠y t·∫°i sao closure c√≥ th·ªÉ g√¢y ra memory lake, h√£y xem v√≠ d·ª• d∆∞·ªõi ƒë√¢y:

```
var theThing = null;
var replaceThing = function () {
  var originalThing = theThing;
  var unused = function () {
    if (originalThing)
      console.log("hi");
  };
  theThing = {
    longStr: new Array(1000000).join('*'),
    someMethod: function () {
      console.log(someMessage);
    }
  };
};
setInterval(replaceThing, 1000);
```

Trong v√≠ d·ª• tr√™n m·ªói khi replaceThing ƒë∆∞·ª£c g·ªçi, theThing s·∫Ω t·∫°o ra m·ªôt m·∫£ng ch∆∞a 1.000.000 ph·∫ßn t·ª´ * v√† m·ªôt closures ( someMethod ). C√πng l√∫c ƒë√≥ bi·∫øn unused c≈©ng ch∆∞a m·ªôt closure gi·ªØa tham chi·∫øu ƒë·∫øn originaThing ( l√† obj theThing ƒë∆∞·ª£c t·∫°o ra t·ª´ l√∫c replaceThing ƒë∆∞·ª£c kh·ªüi t·∫°o tr∆∞·ªõc ƒë√≥.
M·ªôt ƒëi·ªÅu quan tr·ªçng l√† khi m·ªôt scope ƒë∆∞·ª£c t·∫°o ra, c√°c closure c√≥ c√πng scope cha s·∫Ω chia s·∫ª chung scope ƒë√≥. ·ªû tr√™n unused v√† someMethod c√πng chia s·∫ª m·ªôt scope. M·∫∑c d√π unused kh√¥ng ƒë∆∞·ª£c g·ªçi ƒë·∫øn nh∆∞ng n√≥ c√≥ gi·ªØ tham chi·∫øu ƒë·∫øn originalThing ( instance c·ªßa originalThing ) n√™n GC coi n√≥ v·∫´n ƒëang ho·∫°t ƒë·ªông v√† kh√¥ng th·ªÉ gi·∫£i ph√≥ng b·ªô nh·ªõ ƒë∆∞·ª£c. Khi ƒëo·∫°n code n√†y ch·∫°y b·ªô nh·ªõ s·∫Ω ƒë∆∞·ª£c c·∫•p ph√°t li√™n t·ª•c sau m·ªói 1000 milisecond , v·ªÅ b·∫£n ch·∫•t n√≥ s·∫Ω t·∫°o m·ªôt linked-list c√°c closure (root l√† theThing) .

### Does my app leak memory?

Th√¥ng th∆∞·ªùng, kh√° kh√≥ ƒë·ªÉ bi·∫øt ·ª©ng d·ª•ng c√≥ b·ªã r√≤ r·ªâ hay kh√¥ng - ƒë·∫∑c bi·ªát l√† ƒë√¥i khi c√°c r√≤ r·ªâ qu√° nh·ªè ƒë·∫øn m·ª©c h·∫ßu nh∆∞ kh√¥ng th·ªÉ nh·∫≠n th·∫•y. C√°ch ti·∫øp c·∫≠n t·ªët nh·∫•t l√† ph√¢n t√≠ch m·ªôt quy tr√¨nh c√¥ng vi·ªác trong ·ª©ng d·ª•ng c·ªßa b·∫°n m√† b·∫°n mong ƒë·ª£i l√† trung t√≠nh b·ªô nh·ªõ, t·ª©c l√†, m·ªôt chu·ªói c√°c b∆∞·ªõc kh√¥ng n√™n d·∫´n ƒë·∫øn b·∫•t k·ª≥ ƒë·ªëi t∆∞·ª£ng m·ªõi n√†o ƒë∆∞·ª£c gi·ªØ l·∫°i. V√≠ d·ª•: ƒëi·ªÅu h∆∞·ªõng ƒë·∫øn m·ªôt m√†n h√¨nh m·ªõi v√† quay l·∫°i m√†n h√¨nh tr∆∞·ªõc ƒë√≥, ho·∫∑c th√™m v√† x√≥a c√°c m·ª•c kh·ªèi danh s√°ch l√† c·∫£ hai t√¨nh hu·ªëng m√† trong h·∫ßu h·∫øt c√°c tr∆∞·ªùng h·ª£p kh√¥ng n√™n tƒÉng m·ª©c s·ª≠ d·ª•ng b·ªô nh·ªõ. N·∫øu m·ªôt quy tr√¨nh c√¥ng vi·ªác nh∆∞ v·∫≠y d·∫´n ƒë·∫øn r√≤ r·ªâ, b·∫°n s·∫Ω nh·∫≠n th·∫•y m·ª©c ti√™u th·ª• b·ªô nh·ªõ c·ªßa ·ª©ng d·ª•ng c·ªßa b·∫°n s·∫Ω tƒÉng l√™n sau khi b·∫°n l·∫∑p l·∫°i n√≥ nhi·ªÅu l·∫ßn.

C√°ch d·ªÖ nh·∫•t ƒë·ªÉ quan s√°t ƒëi·ªÅu ƒë√≥ l√† b·∫±ng c√°ch s·ª≠ d·ª•ng *Instruments* tr√™n iOS ho·∫∑c Android Studio Profiler cho Android. C·∫£ hai c√¥ng c·ª• n√†y ƒë·ªÅu hi·ªÉn th·ªã t·ªïng m·ª©c s·ª≠ d·ª•ng b·ªô nh·ªõ c·ªßa ·ª©ng d·ª•ng - bao g·ªìm c·∫£ b·ªô nh·ªõ ƒë∆∞·ª£c c·∫•p ph√°t b·ªüi JS, c≈©ng nh∆∞ b·ªô nh·ªõ ƒë∆∞·ª£c ph√¢n b·ªï b·ªüi modules v√† views. H√£y c√πng xem c√°ch s·ª≠ d·ª•ng ch√∫ng:

**I. Monitoring memory usage on iOS**
Sau khi kh·ªüi ch·∫°y ·ª©ng d·ª•ng t·ª´ Xcode, ch·ªçn "Debug navigator" (b∆∞·ªõc 1) v√† ch·ªçn ph·∫ßn Memory (b∆∞·ªõc 2):

![](https://images.viblo.asia/4fdce569-b314-4f68-a1fe-16fb0507021d.png)

S·ª≠ d·ª•ng ·ª©ng d·ª•ng c·ªßa b·∫°n trong m·ªôt th·ªùi gian v√† xem c√°ch s·ª≠ d·ª•ng b·ªô nh·ªõ, vi·ªác tracking th√¥ng qua debug navigator kh√¥ng h·∫≥n ƒë√£ ch√≠nh x√°c nh∆∞ng c≈©ng l√† m·ªôt th√¥ng tin ƒë·ªÉ ch√∫ng ta tham kh·∫£o m√†n h√¨nh ƒë√≥ c√≥ kh·∫£ nƒÉng ƒëang b·ªã memory leak.
Tham kh·∫£o h√¨nh ·ªü v√≠ d·ª• tr√™n, th·ª±c hi·ªán open screen B t·ª´ screen A, t·∫°i screen B th·ª±c hi·ªán call api ƒë·ªï d·ªØ li·ªáu v√†o m·ªôt Flatlist. Tr·ª±c quan ta c√≥ th·ªÉ th·∫ø memory khi v√†o screen B ƒë·ªÅu tƒÉng l√™n do c√≥ th·ª±c hi·ªán thay ƒë·ªïi b·ªô nh·ªõ, memory s·∫Ω gi·∫£m ƒëi khi back l·∫°i m√†n h√¨nh A n·∫øu ·ªü ƒë√¢y kh√¥ng c√≥ hi·ªán t∆∞·ª£ng memory leak, c·ª© nh∆∞ v·∫≠y tƒÉng r·ªìi l·∫°i gi·∫£m. T·ª´ ƒë√≥ ta c√≥ th·ªÉ ƒëo√°n ƒë·ªãnh m√†n h√¨nh n√†y kh√¥ng c√≥ kh·∫£ nƒÉng b·ªã memory leak

![](https://images.viblo.asia/810349b2-12f4-4d7f-b201-924fe3b59081.png)

N·∫øu m·ª©c s·ª≠ d·ª•ng b·ªô nh·ªõ tƒÉng sau m·ªôt chu·ªói c√°c h√†nh ƒë·ªông ra v√†o m√†n h√¨nh ƒë√≥, ·ª©ng d·ª•ng c√≥ kh·∫£ nƒÉng b·ªã r√≤ r·ªâ b·ªô nh·ªõ.

**2. Monitoring memory usage in Android Studio**

Khi ki·ªÉm tra ·ª©ng d·ª•ng c·ªßa b·∫°n tr√™n Android, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng c√°c c√¥ng c·ª• Android Studio Profiler. ƒê·∫ßu ti√™n, m·ªü project c·ªßa b·∫°n v·ªõi studio Android. Khi b·∫°n ƒë√£ k·∫øt n·ªëi thi·∫øt b·ªã ho·∫∑c simulator v√† ·ª©ng d·ª•ng c·ªßa b·∫°n ƒë∆∞·ª£c kh·ªüi ch·∫°y, b·∫°n n√™n ƒëi·ªÅu h∆∞·ªõng ƒë·∫øn tab Prof Profiler ·ªü ph√≠a d∆∞·ªõi c√πng v√† ch·ªçn ph·∫ßn MEMORY:

![](https://images.viblo.asia/5f199d7f-5b8f-46a7-9db7-92b9b61c2554.png)

Khi back t·ª´ screen B v·ªÅ A b·ªô nh·ªõ kh√¥ng ƒë∆∞·ª£c gi·∫£m m√† v·∫´n tƒÉng, ·ªü ƒë√¢y c√≥ th·ªÉ g√¢y ra memory leak 

## MUST READ!!!
- S·ª≠ d·ª•ng b·∫£n build prod ( staging ) v·ªõi ·ª©ng d·ª•ng RN c·ªßa b·∫°n. ·ªû ch·∫ø ƒë·ªô dev, m·ªôt s·ªë module c·ªßa RN s·∫Ω gi·ªØ l·∫°i c√°c objects ƒë·ªÉ cung c·∫•p c√°c c·∫£nh b√°o khi c·∫ßn thi·∫øt. M·ªôt v√≠ d·ª• , event pool c·ªßa RN s·∫Ω gi·ªØ l·∫°i c√°c touch event ƒë√£ ƒë∆∞·ª£c dispatched ƒë·∫øn c√°c component, n√≥ s·∫Ω gi·ªØ l·∫°i c√°c reference ƒë·∫øn c√°c th√†nh ph·∫ßn tr∆∞·ªõc ƒë√≥ c·ªßa component. ƒêi·ªÅu n√†y kh√¥ng x·∫£y ratreen b·∫£n prod ( staging ), v√¨ th·∫ø s·ª≠ d·ª•ng b·∫£n prod (staging) s·∫Ω gi√∫p b·∫°n tr√°nh ƒë∆∞·ª£c issues n√†y 
- S·ª≠ d·ª•ng c√¢u l·ªánh console.log. Khi b·∫°n truy·ªÅn m·ªôt ƒë·ªëi t∆∞·ª£ng ƒë·∫øn console.log v√† k·∫øt n·ªëi Web Inspector, UI constroller s·∫Ω gi·ªØ l·∫°i object ƒë·ªÉ sau n√†y b·∫°n c√≥ th·ªÉ m·ªü r·ªông v√† ki·ªÉm tra n√≥.
- Nh∆∞ ·ªü tr√™n , vi·ªác in ra m·ªôt object t·ª´ snapshot v√† th·ª±c hi·ªán hot reload , gi√° tr·ªã c·ªßa n√≥ ƒë∆∞·ª£c gi·ªØ l·∫°i ·ªü tr∆∞·ªõc th·ªùi ƒëi·ªÉm hot reload, do c√≥ th·ªÉ n√≥ v·∫´n c√≤n b·ªã gi·ªØ reference ch∆∞a b·ªã xo√° b·ªè. ƒê·ªÉ snapshot v√† in ra ƒë√∫ng , b·∫°n n√™n reload l·∫°i app v√† reconnect ƒë·∫øn web inspector.

## Unnecessary Renders

M·ª•c ti√™u: chia s·∫ª d∆∞·ªõi ƒë√¢y nh·∫±m m·ª•c ƒë√≠ch l√†m r√µ c√°ch ho·∫°t ƒë·ªông c·ªßa *React render()* v√† c√°ch b·∫°n c√≥ th·ªÉ d·ªÖ d√†ng gi·∫£m s·ªë l·∫ßn render() m√† c√°c component() c·ªßa b·∫°n th·ª±c hi·ªán v√† t·ª± ƒë·ªông c·∫£i thi·ªán hi·ªáu su·∫•t ·ª©ng d·ª•ng / UI c·ªßa b·∫°n.

L∆∞u √Ω: b·∫°n kh√¥ng c·∫ßn ph·∫£i t·ªëi ∆∞u h√≥a qu√° s·ªõm ho·∫∑c n·∫øu b·∫°n nghƒ© r·∫±ng b·∫°n kh√¥ng c·∫ßn thi·∫øt ph·∫£i l√†m n√≥. T·∫°i sao l·∫°i v·∫≠y , b·∫°n c√≥ th·ªÉ tham kh·∫£o th√™m ·ªü [ƒë√¢y](https://stackify.com/premature-optimization-evil/#:~:text=%E2%80%9CPremature%20optimization%20is%20the%20root,famous%20saying%20among%20software%20developers.&text=%E2%80%9CThe%20real%20problem%20is%20that,of%20it) nha 

> The real problem is that programmers have spent far too much time worrying about efficiency in the wrong places and at the wrong times; premature optimization is the root of all evil (or at least most of it) in programming.

nh∆∞ng ch√∫ng ta ph·∫£i n·∫Øm v·ªØng ƒë∆∞·ª£c c√°ch React render () ho·∫°t ƒë·ªông. C√≥ m·ªôt s·ªë c√°ch t·ªëi ∆∞u kh√° d·ªÖ ƒë·ªÉ l√†m, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng ch√∫ng trong d·ª± √°n c·ªßa m√¨nh

### V·∫≠y, React render () ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o?

**render()** ƒë∆∞·ª£c g·ªçi nh∆∞ ch√∫ng ta bi·∫øt m·ªói l·∫ßn props ho·∫∑c state c√≥ thay ƒë·ªïi tr√™n component. ƒêi·ªÅu n√†y ngay l·∫≠p t·ª©c h√†m render() s·∫Ω render l·∫°i component v√† t·∫•t c·∫£ c√°c con c·ªßa n√≥. 
React s·∫Ω √°p d·ª•ng thu·∫≠t to√°n ƒë·ªëi chi·∫øu ( [reconciliation algorithm](https://reactjs.org/docs/reconciliation.html) ) v√† x√°c ƒë·ªãnh xem c√≥ component m·ªõi c·∫ßn render kh√¥ng, c√°c component kh√¥ng c·∫ßn thi·∫øt n·ªØa v√† c√≥ c·∫ßn render l·∫°i c√°c component ƒëang t·ªìn t·∫°i kh√¥ng. 

Khi component ƒë∆∞·ª£c kh·ªüi t·∫°o, h√†m render() ƒë∆∞·ª£c g·ªçi s·∫Ω th·ª±c hi·ªán t·∫°o m·ªôt c√¢y tr√™n React elements. V·ªõi m·ªói nextState v√† update props, render() s·∫Ω t·∫°o ra m·ªôt c√¢y kh√°c v·ªõi c√°c component kh√°c. Sau ƒë√≥ React s·∫Ω t√¨m ra c√°ch ƒë·ªÉ c·∫≠p nh·∫≠t UI hi·ªáu qu·∫£ ƒë·ªÉ ph√π h·ª£p v·ªõi c√¢y m·ªõi ƒë∆∞·ª£c t·∫°o.

Ch√≠nh vi·ªác t·∫°o th√†nh m·ªôt c√¢y m·ªõi s·∫Ω g√¢y t·ªën hi·ªáu nƒÉng v√† t√†i nguy√™n c·ªßa app. V·∫•n ƒë·ªÅ ƒë·∫∑t ra l√† ph·∫£i t·ªëi thi·ªáu thao t√°c chuy·ªÉn ƒë·ªïi th√†nh m·ªôt c√¢y kh√°c. Tuy nhi√™n ƒë·ªô ph·ª©c t·∫°p c·ªßa thu·∫≠t to√°n c√≥ th·ªÉ ƒë·∫°t ƒë·∫øn m·ª©c O(n^3) v·ªõi n l√† s·ªë ph·∫ßn t·ª≠ tr√™n c√¢y.

N·∫øu s·ª≠ d·ª•ng vi·ªác so s√°nh gi·ªØa 2 c√¢y c√≥ s·ª± kh√°c nhau gi·ªØa c√°c element sau ƒë√≥ ƒë∆∞a ra quy·∫øt ƒë·ªãnh render , v√≠ d·ª• c√≥ 1000 ph·∫ßn t·ª≠ c·∫ßn th·ª±c hi·ªán 1 t·ª∑ ph√©p so s√°nh. ƒêi·ªÅu th·∫≠t crazy. Thay v√†o ƒë√≥ React s·∫Ω th·ª±c hi·ªán thu·∫≠t to√°n Heuristic O(n) d·ª±a tr√™n 2 gi·∫£ ƒë·ªãnh:

- 2 ph·∫ßn t·ª≠ c√≥ ki·ªÉu kh√°c nhau s·∫Ω t·∫°o ra c√°c c√¢y kh√°c nhau
- Dev c√≥ th·ªÉ g·ª£i √Ω cho RN bi·∫øt ƒë√≥ l√† c√°c elements con n√†o ·ªïn ƒë·ªãnh qua c√°c l·∫ßn render v·ªõi prop key

**The Diffing Algorithm**

RN s·∫Ω so s√°nh 2 c√¢y kh√°c nhau. Tr∆∞·ªõc ti√™n RN s·∫Ω so s√°nh hai root elements tr∆∞·ªõc. B·∫•t c·ª© root element c·ªßa 2 c√¢y c√≥ ki·ªÉu kh√°c nhau, RN s·∫Ω xo√° b·ªè c√¢y c≈© v√† build m·ªôt c√¢y m·ªõi t·ª´ ƒë·∫ßu. V√≠ d·ª• 

```
<View>
  <Counter />
</View>

<span>
  <Counter />
</span>
```
N·∫øu so s√°nh th·∫•y 2 elements c√≥ c√πng ki·ªÉu th√¨ RN s·∫Ω so s√°nh c√°c thu·ªôc t√≠nh c·ªßa n√≥ t·ª´ ƒë√≥ quy·∫øt ƒë·ªãnh ch·ªâ update l·∫°i c√°c thu·ªôc t√≠nh ƒë√≥.

**Component Elements Of The Same Type**

Khi m·ªôt component ƒë∆∞·ª£c update, instance c·ªßa n√≥ v·∫´n ƒë∆∞·ª£c gi·ªØ nguy√™n, ƒë·ªÉ gi·ªØa ƒë∆∞·ª£c state c·ªßa component trong qu√° tr√¨nh renders. RN c·∫≠p nh·∫≠t props c·ªßa instance sao cho match v·ªõi element m·ªõi v√† g·ªçi componentWillReceiveProps(), componentWillUpdate() ƒë·ªÉ c·∫≠p nh·∫≠t prop cho instance.

**Recursing On Children**

M·∫∑c ƒë·ªãnh RN s·∫Ω duy·ªát danh s√°ch c√°c child component b√™n trong component cha cho ƒë·∫øn ph√°t hi·ªán c√≥ s·ª± thay ƒë·ªïi
Ex: trong m·ªôt v√≠ d·ª• d∆∞·ªõi ƒë√¢y, th√™m m·ªôt element v√†o cu·ªëi children, vi·ªác render c·ªßa n√≥ v·∫´n cho hi·ªáu nƒÉng t·ªët

```
#Before:
<View>
  <Text>first</lText>
  <Text>second</Text>
</View>

#After: 
<View>
  <Text>first</Text>
  <Text>second</Text>
  <Text>third</Text>
</View>
```

React s·∫Ω match 2 ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n v√† insert ph·∫ßn t·ª≠ th·ª© 3 v√†o tree. Nh∆∞ng n·∫øu th·ª±c hi·ªán add v√†o ƒë·∫ßu ti√™n hi·ªáu su·∫•t s·∫Ω gi·∫£m

```
Before:
<View>
  <Text>first</lText>
  <Text>second</Text>
</View>

After: 
<View>
  <Text>third</Text>
  <Text>first</Text>
  <Text>second</Text>
</View>
```
RN s·∫Ω ph·∫£i c·∫≠p nh·∫≠t t·∫•t c·∫£ thay v√¨ ph√°t hi·ªán ph·∫ßn t·ª≠ tr√πng kh·ªõp

**Keys**

ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y, React h·ªó tr·ª£ m·ªôt thu·ªôc t√≠nh quan tr·ªçng. Khi child c√≥ key, React s·ª≠ d·ª•ng key ƒë·ªÉ match chilrden. V√≠ d·ª•: th√™m key s·∫Ω d√¢n ƒë·∫øn vi·ªác chuy·ªÉn ƒë·ªïi key hi·ªáu qu·∫£

```
Before:
<View>
  <Text key=‚Äù1234‚Äù>first</lText>
  <Text key=‚Äú5678‚Äù>second</Text>
</View>

After: 
<View>
  <Text key=‚Äú2468‚Äù>third</Text>
  <Text key=‚Äù1234‚Äù>first</lText>
  <Text key=‚Äú5678‚Äù>second</Text>
</View>
```

Vi·ªác s·ª≠ d·ª•ng key s·∫Ω gi√∫p RN nh·∫≠n bi·∫øt ƒë∆∞·ª£c s·ª± thay ƒë·ªïi c·ªßa view n√†o t·ª´ ƒë√≥ ƒë∆∞a ra quy·∫øt ƒë·ªãnh c√≥ hay kh√¥ng render l·∫°i n√≥.

**NOTE:**
V√¨ v·∫≠y, nh∆∞ b·∫°n c√≥ th·ªÉ t∆∞·ªüng t∆∞·ª£ng, n·∫øu b·∫°n c√≥ m·ªôt h·ªá th·ªëng ph√¢n c·∫•p v·ªõi views ph·ª©c t·∫°p v√† c≈©ng c√≥ nhi·ªÅu c·∫≠p nh·∫≠t State van props, ƒë∆∞·ª£c k√≠ch ho·∫°t b·ªüi c√°c event kh√°c nhau ho·∫∑c c·∫≠p nh·∫≠t trong store redux, ƒëi·ªÅu n√†y c√≥ th·ªÉ d·∫´n ƒë·∫øn nhi·ªÅu render v√† t√≠nh to√°n kh√¥ng c·∫ßn thi·∫øt.

ƒê·ªÉ l√†m cho ƒëi·ªÅu n√†y r√µ r√†ng h∆°n, h√£y ƒë·ªÉ m·ªôt v√≠ d·ª• ƒë∆°n gi·∫£n. L√†m m·ªôt ·ª©ng d·ª•ng counter c∆° b·∫£n
```
export class Counters extends Component {
  state = {
    counter1: 0,
    counter2: 0
  };
  render() {
    return (
      <View>
        <Button
          title={"Increase counter 1"}
          onPress={() => {
            this.setState({ counter1: this.state.counter1 + 1 });
          }}
        />
        <Button
          title={"Increase counter 2"}
          onPress={() => {
            this.setState({ counter2: this.state.counter2 + 1 });
          }}
        />
        <CounterDisplay value={this.state.counter1} />
        <CounterDisplay value={this.state.counter2} />
      </View>
    );
  }
}

class CounterDisplay extends Component {
  render() {
    return (
      <View>
        <Text>{this.props.value}</Text>
      </View>
    );
  }
}
```
·ªû v√≠ d·ª• tr√™n nhi·ªÅu b·∫°n s·∫Ω nghƒ© r·∫±ng khi click v√†o button ƒë·∫ßu ti√™n, ch·ªâ duy nh·∫•t couter1 thay ƒë·ªïi state n√™n khi render ch·ªâ c√≥ m√¨nh counter 1 b·ªã render l·∫°i, nh∆∞ng th·ª±c t·∫ø ·ªü ƒë√¢y c·∫£ hai CouterDisplay ƒë·ªÅu ƒë∆∞·ª£c render l·∫°i, couter1 c·∫≠p nh·∫≠t gi√° tr·ªã m·ªõi c√≤n couter2 th√¨ v·∫´n gi·ªØ nguy√™n. L√Ω do l√† state ƒë∆∞·ª£c c·∫≠p nh·∫≠t h√†m render() ƒë∆∞·ª£c k√≠ch ho·∫°t, c√°c child component trong ƒë√≥ ƒë·ªÅu b·ªã render l·∫°i
N·∫øu v·ªõi m·ªôt small component nh∆∞ v√≠ d·ª• tr√™n th√¨ hi·ªáu nƒÉng ch·∫£ th·∫•m v√†o ƒë√¢u. Nh∆∞ng hay t∆∞·ªüng t∆∞·ª£ng m·ªôt m√†n h√¨nh v·ªõi kho·∫£ng 20 component vi·ªác render l·∫°i to√†n b·ªô ch√∫ng s·∫Ω down hi·ªáu nƒÉng c·ªßa app nh∆∞ th·∫ø n√†o.

**V·∫≠y l√†m th·∫ø n√†o ƒë·ªÉ t·ªëi ∆∞u ho√° code tr√°nh nh·ªØng render kh√¥ng c·∫ßn thi·∫øt ?**

·ªû ph·∫ßn ti·∫øp theo m√¨nh s·∫Ω gi·ªõi thi·ªáu v·ªÅ m·ªôt s·ªë tip ƒë·ªÉ tr√°nh render l·∫°i code nh∆∞ 
- S·ª≠ d·ª•ng shouldComponentUpdate trong component hay s·ª≠ d·ª•ng React Hook
-Khi n√†o n√™n s·ª≠ d·ª•ng PureComponent ho·∫∑c Component