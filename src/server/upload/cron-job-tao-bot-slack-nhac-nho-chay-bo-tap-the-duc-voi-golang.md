**HÃ  Ná»™i, Chá»§ nháº­t, 21/08/2022... VÃ i lá»i gá»­i gáº¯m thá»i gian**

Nháº¡c sÄ© : [Trá»‹nh CÃ´ng SÆ¡n](https://vi.wikipedia.org/wiki/Tr%E1%BB%8Bnh_C%C3%B4ng_S%C6%A1n)

*HÃ  Ná»™i mÃ¹a thu, mÃ¹a thu HÃ  Ná»™i<br>
MÃ¹a hoa sá»¯a vá» thÆ¡m tá»«ng cÆ¡n giÃ³<br>
MÃ¹a cá»‘m xanh vá» thÆ¡m bÃ n tay nhá»<br>
Cá»‘m sá»¯a vá»‰a hÃ¨ thÆ¡m bÆ°á»›c chÃ¢n qua...*

![image.png](https://images.viblo.asia/0df77cca-bc2d-4a7f-97a6-5766ffbb2faf.png)

TÃ´i nhá»› thu *HÃ  Ná»™i* quÃ¡, nhá»¯ng Ä‘Ãªm nghÃªu ngao hÃ¡t cÃ¹ng em trÃªn nhá»¯ng con phá»‘ thu váº¯ng giÃ³ thu kháº½ luá»“n qua tÃ  Ã¡o em bay. Tay Ä‘an vÃ o nhau, em nÃ³i yÃªu tÃ´i ğŸ˜

MÃ¹i rÆ°á»£u thoang thoáº£ng quyá»‡n theo tá»«ng cÆ¡n giÃ³. Em Ä‘á»• vÃ o lÃ²ng tÃ´i, mÃ¡ hÃ¢y hÃ¢y há»“ng, miá»‡ng thÆ¡m mÃ¹i rÆ°á»£u, máº¯t em kháº½ cong. *HÃ  Ná»™i* Ä‘áº¹p nháº¥t vÃ o ngÃ y áº¥y - ngÃ y *Thu* cÃ³ em...

![hi.gif](https://images.viblo.asia/51d1e3d5-2d62-4c94-ba80-a2094bd7a34d.gif)

# 1. Giá»›i thiá»‡u tá»•ng quan

Táº­p **thá»ƒ dá»¥c** cÃ³ thá»ƒ ngÄƒn tÃ­ch tá»¥ má»¡ thá»«a vÃ  duy trÃ¬ giáº£m cÃ¢n. Khi hoáº¡t Ä‘á»™ng thá»ƒ cháº¥t, Ä‘á»‘t chÃ¡y calo, hoáº¡t Ä‘á»™ng cÃ ng máº¡nh, cÃ ng nhiá»u calo bá»‹ Ä‘á»‘t chÃ¡y.

Hoáº¡t Ä‘á»™ng thá»ƒ cháº¥t tÃ­ch cá»±c thÃºc Ä‘áº©y lÆ°á»£ng **Lipoprotein** tá»· trá»ng cao **(HDL)** â€“ má»¡ mÃ¡u tá»‘t vÃ  giáº£m **triglyceride, Lipoprotein** tá»· trá»ng tháº¥p **(LDLc)** khÃ´ng lÃ nh máº¡nh, tÃ¡c dá»¥ng kÃ©p nÃ y giÃºp mÃ¡u lÆ°u thÃ´ng dá»… dÃ ng vÃ  giáº£m nguy cÆ¡ bá»‡nh tim máº¡ch.

![running.gif](https://images.viblo.asia/3808f219-2a08-41b4-9cbf-bd626f418066.gif)

Hiá»‡n táº¡i, mÃ¬nh lÃ  má»™t **developer** nÃªn pháº£i ngá»“i mÃ¡y tÃ­nh 8h má»™t ngÃ y. VÃ¬ váº­y táº­p thá»ƒ dá»¥c, thá»ƒ thao Ä‘á»‘i vá»›i mÃ¬nh lÃ  viá»‡c ráº¥t cáº§n thiáº¿t sau ngÃ y lÃ m cÄƒng tháº³ng. Tuy Ä‘Ã£ trang bá»‹ ráº¥t nhiá»u Ä‘á»“ cÃ´ng nghá»‡ phá»¥c vá»¥ cho viá»‡c nÃ y nhÆ°: Äá»“ng há»“ thÃ´ng minh, app [Strava](https://www.strava.com/) Ä‘Ã£ mua license ğŸ˜ƒ, google fit,... nhÆ°ng viá»‡c thá»ƒ dá»¥c cá»§a mÃ¬nh váº«n khÃ´ng Ä‘Æ°á»£c Ä‘á»u Ä‘áº·n khi cÃ³ nhiá»u lÃ½ do Ä‘áº¿n tá»« chá»§ quan láº«n khÃ¡ch quan.

MÃ¬nh váº«n luÃ´n Æ°á»›c ao sáº½ cÃ³ má»™t ngÆ°á»i nÃ o Ä‘Ã³ sáº½ luÃ´n nháº¯c nhá»Ÿ báº£n thÃ¢n mÃ¬nh Ä‘Ãºng giá» trong má»—i ngÃ y: *" Äá»©ng lÃªn ! Äi thá»ƒ dá»¥c Ä‘i. "* vÃ  cuá»‘i thÃ¡ng tá»•ng káº¿t láº¡i káº¿t quáº£ mÃ¬nh Ä‘áº¡t Ä‘Æ°á»£c cá»§a thÃ¡ng Ä‘Ã³: sá»‘ liá»‡u, thÃ nh tá»±u biá»ƒu diá»…n dÆ°á»›i dáº¡ng biá»ƒu Ä‘á»“ cháº³ng háº¡n. Viá»‡c thuÃª má»™t ngÆ°á»i lÃ m viá»‡c Ä‘Ã³ thÃ¬ cÅ©ng lÃ  má»™t cÃ¡ch khÃ´ng tá»“i nhÆ°ng Ä‘á»‘i vá»›i má»™t ngÆ°á»i lÃ m nghá» **Dev** thÃ¬ viá»‡c tá»± táº¡o ra má»™t con **Bot** tháº­t sá»± lÃ  má»™t cÃ¡ch thÃº vá»‹ vÃ  cÃ³ tÃ­nh chÃ­nh xÃ¡c gáº§n nhÆ° tuyá»‡t Ä‘á»‘i ğŸ˜ƒğŸ˜ƒğŸ˜ƒ

MÃ¬nh lÃ m viá»‡c tá»« **8h-8h30** cho Ä‘áº¿n **18h-18h30** hÃ ng ngÃ y. CÃ´ng cá»¥ trao Ä‘á»•i vá»›i má»i ngÆ°á»i trong team Ä‘a pháº§n dÃ¹ng [Slack](https://slack.com/) nÃªn á»Ÿ Ä‘Ã¢y mÃ¬nh táº¡o **bot** trÃªn Slack Ä‘á»ƒ alert nháº¯c nhá»Ÿ vÃ  tá»•ng káº¿t thÃ nh biá»ƒu Ä‘á»“ hÃ ng thÃ¡ng. CÃ¡c chá»©c nÄƒng chÃ­nh cá»§a **bot** nhÆ° sau:

1. **9h hÃ ng ngÃ y**, bot crawl thÃ´ng tin trÃªn account [Strava](https://www.strava.com/) cá»§a mÃ¬nh rá»“i alert thÃ´ng tin mÃ¬nh cháº¡y Ä‘Æ°á»£c ngÃ y hÃ´m qua. VD: **Sá»‘ km, thá»i gian cháº¡y, tá»‘c Ä‘á»™ cháº¡y,...**
2. **9h30 NgÃ y Ä‘áº§u tiÃªn cá»§a hÃ ng thÃ¡ng**, bot thá»‘ng sá»‘ liá»‡u tá»«ng ngÃ y mÃ¬nh cháº¡y rá»“i generate ra biá»ƒu Ä‘á»“ alert láº¡i cho mÃ¬nh.
3. **17h30 hÃ ng ngÃ y**, bot kiá»ƒm tra thá»i tiáº¿t hÃ´m nay rá»“i alert cho mÃ¬nh thÃ´ng tin Ä‘Ã³ vÃ  dá»±a vÃ o Ä‘Ã³ Ä‘á»ƒ gá»£i Ã½ xem cÃ³ nÃªn ra ngoÃ i cháº¡y thá»ƒ dá»¥c khÃ´ng?

# 2. Sequence diagram

![sync-data.png](https://images.viblo.asia/0174c195-5d2e-4954-ba7e-511eb190cf93.png)

**Note** : [App Zepp](https://play.google.com/store/apps/details?id=com.huami.watch.hmwatchmanager&hl=vi&gl=US) - á»©ng dá»¥ng lÆ°u trá»¯ thÃ´ng tin sá»©c khoáº» Ä‘Æ°á»£c Ä‘o tá»« smart watch. Dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c tá»± Ä‘á»“ng bá»™ tá»« smart watch -> app **Zepp** -> app **Strava**

![bot-notify-run.png](https://images.viblo.asia/26aa1d1d-40cf-49c4-9db0-c1a26cb48dc2.png)

**Note** : [Open Weather Map](https://openweathermap.org/api) - cung cáº¥p api miá»…n phÃ­ Ä‘á»ƒ láº¥y thÃ´ng tin thá»i tiáº¿t theo **vá»‹ trÃ­, khu vá»±c**.

![bot-notify-summary.png](https://images.viblo.asia/272d232a-2e48-4bdd-95d6-85f741b8027e.png)

**Note** : [Strava](https://developers.strava.com/docs/reference/) - lÆ°u trá»¯, chia sáº» hoáº¡t Ä‘á»™ng thá»ƒ dá»¥c, thá»ƒ thao dá»… hiá»ƒu hÆ¡n lÃ  máº¡ng xÃ£ há»™i dÃ nh cho ngÆ°á»i chÆ¡i thá»ƒ thao

![bot-notify-statistical.png](https://images.viblo.asia/22f91f2d-cbb6-4b38-ba4e-189b96d46ddf.png)

# 3. Táº¡o bot Slack
![bot.gif](https://images.viblo.asia/b03f1591-718b-4849-aa13-411c35d9f344.gif)

Äá»ƒ táº¡o má»™t con **bot** cÃ³ thá»ƒ gá»­i tin nháº¯n vÃ o channel thÃ¬ cáº§n táº¡o má»™t webhook trong Slack. Khi cÃ³ trigger hÃ nh Ä‘á»™ng thÃ¬ con **bot** sáº½ tá»± Ä‘á»™ng post message tá»›i channel thÃ´ng qua webhook nÃ y. CÃ¡ch táº¡o thÃ¬ má»i ngÆ°á»i tham kháº£o link [Incoming Webhook](https://team-tbo7018.slack.com/apps/new/A0F7XDUAZ-incoming-webhooks) cá»§a Slack.

Äá»ƒ implement code báº±ng Go thÃ¬ cÅ©ng Ä‘Æ¡n giáº£n thÃ´i chá»‰ cáº§n generate theo format cá»§a Slack rá»“i gá»i webhook. Slack cÃ³ hÆ°á»›ng dáº«n tá»«ng bÆ°á»›c má»i ngÆ°á»i [tham kháº£o Ä‘Ã¢y nhÃ©](https://api.slack.com/messaging/webhooks#:~:text=Incoming%20Webhooks%20are%20a%20simple,make%20the%20messages%20stand%20out.)

```Go
func sendMessage(webhook string, message *model.SlackMessage) error {
	logrus.Info("Send message to webhook ", webhook)

	payload, err := json.Marshal(message)
	if err != nil {
		return err
	}
	req, err := http.NewRequest("POST", webhook, bytes.NewReader(payload))
	if err != nil {
		return err
	}

	req.Header.Add("Content-Type", "application/json")
	req.Header.Set("Accept", "application/json")
	res, err := http.DefaultClient.Do(req)

	if err != nil {
		return err
	}

	defer func(Body io.ReadCloser) {
		err = Body.Close()
		if err != nil {
			return
		}
	}(res.Body)
	if res.StatusCode != http.StatusOK {
		if res != nil {
			bodyBytes, err := ioutil.ReadAll(res.Body)
			if err != nil {
				logrus.Warnf("response %v", string(bodyBytes))
				return err
			}
			return errors.New("notification failure")
		}
	}
	logrus.Info("successfully sent notification...")
	return nil
}
``` 

# 4. Táº¡o cron job vá»›i Golang

## 4.1. TÃ i liá»‡u cho cron job

á» pháº§n nÃ y nhanh thÃ¬ mÃ¬nh dÃ¹ng luÃ´n thÆ° viá»‡n trÃªn github [robfig/cron/v3](https://github.com/robfig/cron/) Ä‘Æ°á»£c vote **10k starts** Ä‘á»ƒ táº¡o cron job cá»§a Golang.

CÃ²n náº¿u tá»± build pháº§n cron job thÃ¬ trong tÆ°Æ¡ng lai gáº§n hy vá»ng mÃ¬nh cÃ³ thá»i gian Ä‘á»ƒ ra bÃ i vá» pháº§n nÃ y ğŸ˜„ğŸ˜„ğŸ˜„. CÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o thuáº­t toÃ¡n [Round-robin scheduling](https://en.wikipedia.org/wiki/Round-robin_scheduling) Ä‘á»ƒ hiá»ƒu rÃµ cÃ¡ch má»™t **Scheduler** hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o nhÃ©.

## 4.2. Cáº¥u hÃ¬nh cron job

Cron job cÃ³ dáº¡ng

```
cron = "X X X X X" (5 kÃ­ tá»±)
``` 
TÆ°Æ¡ng á»©ng

```
<phÃºt> <giá»> <ngÃ y trong thÃ¡ng> <thÃ¡ng> <ngÃ y trong tuáº§n>
``` 
CÃ¡c báº¡n cÃ³ thá»ƒ Ä‘á»c thÃªm [cron job á»Ÿ Ä‘Ã¢y nhÃ©](https://en.wikipedia.org/wiki/Cron)

Dá»±a vÃ o Ä‘á»‹nh nghÄ©a trÃªn ta implement ra Ä‘Æ°á»£c cáº¥u hÃ¬nh cho **bot** Ä‘á»ƒ gá»­i message

1. **9h hÃ ng ngÃ y** -> CRON_NOTIFY_SUMMARY=0 9 * * *
2. **9h30 NgÃ y Ä‘áº§u tiÃªn cá»§a hÃ ng thÃ¡ng** -> CRON_NOTIFY_STATISTICAL=30 9 1 * *
3. **17h30 hÃ ng ngÃ y** -> CRON_NOTIFY_RUN=30 17 * * *

## 4.3. Implement code

```Go
func main() {
	cfg, err := config.LoadConfig("build")
	if err != nil {
		logrus.Warnf("cannot load config: %v", err)
		return
	}

	logrus.Info("Create new cron")
	c := cron.New()

	// Notify run at 17:30 every day
	notifyRun, err := c.AddFunc(cfg.CronNotifyRun, func() {
		err = notifyBot.ProcessNotifyRun()
		if err != nil {
			logrus.Warnf("send message for run is failed %v", err)
		}
	})

	// Notify summary 09:00 every day
	notifySummary, err := c.AddFunc(cfg.CronNotifySummary, func() {
		err = notifyBot.ProcessNotifySummary()
		if err != nil {
			logrus.Warnf("send message for summary is failed %v", err)
		}
	})

	// Notify statistical 09:30 on day-of-month 1
	notifyStatistical, err := c.AddFunc(cfg.CronNotifyStatistical, func() {
		err = notifyBot.ProcessNotifyStatistical()
		if err != nil {
			logrus.Warnf("send message for statistical is failed %v", err)
		}
	})
	if err != nil {
		c.Remove(notifyRun)
		c.Remove(notifySummary)
		c.Remove(notifyStatistical)
		return
	}

	// Start cron with one scheduled job
	logrus.Info("Start cron")
	c.Run()
}
``` 

# 5. Bot nháº¯c nhá»Ÿ cháº¡y thá»ƒ dá»¥c

**17h30 hÃ ng ngÃ y**, bot kiá»ƒm tra thá»i tiáº¿t hÃ´m nay rá»“i alert cho mÃ¬nh thÃ´ng tin Ä‘Ã³ vÃ  dá»±a vÃ o Ä‘Ã³ Ä‘á»ƒ gá»£i Ã½ xem cÃ³ nÃªn ra ngoÃ i cháº¡y thá»ƒ dá»¥c khÃ´ng?

## 5.1. Kiá»ƒm tra thá»i tiáº¿t hiá»‡n táº¡i

Äá»ƒ láº¥y cÃ¡c thÃ´ng tin vá» thá»i tiáº¿t hiá»‡n táº¡i theo khu vá»±c mÃ¬nh sá»­ dá»¥ng API cá»§a 
[openweathermap](https://openweathermap.org) - NÃ³ cho **1,000 API calls per day for free** váº­y lÃ  quÃ¡ Ä‘á»§ dÃ¹ng rá»“i Ä‘Ãºng khÃ´ng nÃ o ğŸ˜„ğŸ˜„ğŸ˜„. CÃ¡c báº¡n cÃ³ thá»ƒ Ä‘á»c tÃ i liá»‡u api á»Ÿ Ä‘Ã¢y nhÃ© -> [Document API](https://openweathermap.org/api/one-call-3) openweathermap

```Go
func GetWeatherInfo(url string, params *model.ParamOpenWeather) (*model.OpenWeather, error) {
	logrus.Info("Get weather information")

	req, err := http.NewRequest("GET", url, nil)
	if err != nil {
		return nil, err
	}

	q := req.URL.Query()
	q.Add("lat", params.Lat)
	q.Add("lon", params.Lon)
	q.Add("units", params.Units)
	q.Add("appid", params.Appid)
	q.Add("exclude", params.Exclude)
	req.URL.RawQuery = q.Encode()

	req.Header.Add("Content-Type", "application/json")
	req.Header.Set("Accept", "application/json")
	res, err := http.DefaultClient.Do(req)

	if err != nil {
		return nil, err
	}

	defer func(Body io.ReadCloser) {
		err = Body.Close()
		if err != nil {
			logrus.Errorf("Close body fail %v", err)
		}
	}(res.Body)
	body, err := ioutil.ReadAll(res.Body)
	if res.StatusCode != http.StatusOK {
		if res != nil {
			bodyBytes, err := ioutil.ReadAll(res.Body)
			if err != nil {
				logrus.Warnf("response %v", string(bodyBytes))
				return nil, err
			}
			return nil, errors.New("get weather information failure")
		}
	}

	openWeather := &model.OpenWeather{}
	err = json.Unmarshal(body, openWeather)
	if err != nil {
		return nil, err
	}
	logrus.Info("successfully get weather information...")

	return openWeather, nil
}
``` 
á» Ä‘Ã¢y táº¡m thá»i mÃ¬nh chá»‰ cáº§n quan tÃ¢m tá»›i nhiá»‡t Ä‘á»™ vÃ  thá»i tiáº¿t: **MÆ°a, náº¯ng, nhiá»u mÃ¢y**. Dá»±a vÃ o cÃ¡c thÃ´ng tin Ä‘Ã³ Ä‘á»ƒ alert cÃ³ nÃªn cháº¡y bá»™ khÃ´ng.

## 5.2. Implement code

Káº¿t há»£p code api láº¥y thÃ´ng tin thá»i tiáº¿t vÃ  bot gá»­i message vÃ o channel báº±ng **Slack Webhook** Ä‘á»ƒ xá»­ lÃ½ alert nháº¯c nhá»Ÿ cháº¡y thá»ƒ dá»¥c

```Go
func (b *BotNotify) ProcessNotifyRun() error {
	weatherInfo, err := weather.GetWeatherInfo("https://openweathermap.org/data/2.5/onecall", &model.ParamOpenWeather{
		Lat:     Latitude,
		Lon:     Longitude,
		Units:   Units,
		Appid:   b.cfg.AppID,
		Exclude: Exclude,
	})
	if err != nil {
		logrus.Errorf("get weather information from open-weather fail %v", err)
		return err
	}
	textMessage := &model.TextMessageNotifyRun{
		CurrentTime: time.Now().Format(FormatDateTime),
		Location:    Location,
		Temperature: fmt.Sprintf("%v %v feels like %v %v", weatherInfo.Current.Temp, Celsius, weatherInfo.Current.FeelsLike, Celsius),
		Weather:     weatherInfo.Current.Weather[0].Description,
		IsRunning:   "Yes",
		Note:        fmt.Sprintf("HÃ´m nay %v, trá»i khÃ´ng mÆ°a nÃªn cháº¡y Ä‘i nhÃ©", time.Now().Format(FormatDate)),
	}
	if weatherInfo.Current.Weather[0].Main == "Rain" {
		textMessage.IsRunning = "No"
		textMessage.Note = fmt.Sprintf("HÃ´m nay %v, trá»i mÆ°a rá»“i nÃªn á»Ÿ nhÃ  Ä‘i nhÃ©", time.Now().Format(FormatDate))
	}
	message := &model.SlackMessage{
		Text:        Text,
		IconEmoji:   client.DefaultEmoji,
		Attachments: textMessage.ToAttachment(),
	}
	return client.SendMessageSlack(b.cfg.WebhookSlack, message)
}
``` 

Káº¿t quáº£ nháº­n Ä‘Æ°á»£c sau khi tá»›i **17h30 hÃ ng ngÃ y**

![image.png](https://images.viblo.asia/16c75e44-df21-42f1-98f6-007d2a722985.png)

# 6. Bot thÃ´ng bÃ¡o thÃ´ng tin cháº¡y bá»™

**9h hÃ ng ngÃ y**, bot crawl thÃ´ng tin trÃªn account [Strava](https://www.strava.com/) cá»§a mÃ¬nh rá»“i alert thÃ´ng tin mÃ¬nh cháº¡y Ä‘Æ°á»£c ngÃ y hÃ´m qua. VD: **Sá»‘ km, thá»i gian cháº¡y, tá»‘c Ä‘á»™ cháº¡y,...**

## 6.1. Crawl thÃ´ng tin Strava

MÃ¬nh cÃ³ smart watch Ä‘á»ƒ Ä‘o thÃ´ng tin cháº¡y thá»ƒ dá»¥c. Má»—i láº§n cháº¡y xong sáº½ tá»± sync dá»¯ liá»‡u lÃªn [Strava](https://www.strava.com/). Äá»ƒ láº¥y cÃ¡c thÃ´ng tin vá» chi tiáº¿t hoáº¡t Ä‘á»™ng cá»§a ngÃ y hÃ´m Ä‘Ã³ mÃ¬nh dÃ¹ng API cá»§a Strava -> [Docment API](https://developers.strava.com/docs/reference/#api-Activities-getLoggedInAthleteActivities)

Video tham kháº£o thÃªm ***Intro and accessing Strava API***

{@embed: https://www.youtube.com/watch?v=sgscChKfGyg}

```Go
func GetStravaActivityInfo(params *model.ParamStrava) ([]*model.StravaActivity, error) {
	logrus.Info("Get strava activity information")

	stravaToken, err := GetStravaTokenInfo(UrlGetStravaToken, params)
	req, err := http.NewRequest("GET", UrlGetStravaActivity, nil)
	if err != nil {
		return nil, err
	}

	q := req.URL.Query()
	q.Add("page", "1")
	q.Add("per_page", "3")
	req.URL.RawQuery = q.Encode()

	req.Header.Add("Content-Type", "application/json")
	req.Header.Set("Accept", "application/json")
	req.Header.Set("Authorization", strings.Join([]string{"Bearer ", stravaToken.AccessToken}, ""))
	res, err := http.DefaultClient.Do(req)

	if err != nil {
		return nil, err
	}

	defer func(Body io.ReadCloser) {
		err = Body.Close()
		if err != nil {
			logrus.Errorf("Close body fail %v", err)
			return
		}
	}(res.Body)
	body, err := ioutil.ReadAll(res.Body)
	if res.StatusCode != http.StatusOK {
		if res != nil {
			bodyBytes, err := ioutil.ReadAll(res.Body)
			if err != nil {
				logrus.Warnf("response %v", string(bodyBytes))
				return nil, err
			}
			return nil, errors.New("get strava activity information failure")
		}
	}

	stravaActivity := make([]*model.StravaActivity, 0)
	err = json.Unmarshal(body, &stravaActivity)
	if err != nil {
		return nil, err
	}
	logrus.Info("successfully get strava activity information...")

	return stravaActivity, nil
}
``` 
MÃ¬nh sáº½ láº¥y 3 hoáº¡t Ä‘á»™ng gáº§n nháº¥t trÃªn **Strava** bá»Ÿi vÃ¬ 1 ngÃ y cháº¯c mÃ¬nh thá»ƒ dá»¥c nhiá»u nháº¥t lÃ  3 láº§n : **SÃ¡ng, Chiá»u, Tá»‘i** nhÆ°ng thÆ°á»ng lÃ  1 láº§n 1 ngÃ y vÃ o buá»•i tá»‘i thÃ´i :LOL: ğŸ˜„ğŸ˜„ğŸ˜„

## 6.2. Implement code

Káº¿t há»£p code api láº¥y thÃ´ng tin hoáº¡t Ä‘á»™ng trÃªn **Strava** vÃ  **bot** gá»­i message vÃ o channel báº±ng **Slack Webhook** Ä‘á»ƒ xá»­ lÃ½ alert nháº¯c nhá»Ÿ cháº¡y thá»ƒ dá»¥c.

Trong pháº§n xá»­ lÃ½ alert nÃ y khi láº¥y Ä‘Æ°á»£c thÃ´ng tin hoáº¡t Ä‘á»™ng trÃªn Strava **bot** báº¯n message vÃ  Ä‘á»“ng thá»i lÆ°u láº¡i thÃ´ng tin nÃ y Ä‘á»ƒ tiá»‡n háº¿t 1 thÃ¡ng mÃ¬nh sáº½ thá»‘ng kÃª láº¡i káº¿t quáº£ vÃ o **generate ra chart** ğŸ˜„ğŸ˜„ğŸ˜„

Table **statisticals** lÆ°u thÃ´ng tin thá»‘ng kÃª dá»¯ liá»‡u
```sql
CREATE TABLE `statisticals` (
  `id` int NOT NULL AUTO_INCREMENT,
  `time_chart` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL,
  `metadata` json DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb3 COLLATE=utf8_unicode_ci;
``` 

```Go
func (b *BotNotify) ProcessNotifySummary() error {
	stravaActivities, err := strava.GetStravaActivityInfo(&model.ParamStrava{
		ClientId:     b.cfg.ClientId,
		ClientSecret: b.cfg.ClientSecret,
		RefreshToken: b.cfg.RefreshToken,
		GrantType:    b.cfg.GrantType,
	})
	if err != nil || len(stravaActivities) == 0 {
		return errors.New("strava activities information empty")
	}

	distanceGoal, err := strconv.ParseFloat(b.cfg.DistanceGoal, 64)
	timeChart, messageActives, chartsInfo := time.Now().AddDate(0, 0, -1).Format(FormatDate), make([]*model.TextMessageNotifySummary, 0), make([]*internalModel.ChartInfo, 0)
	for _, activity := range stravaActivities {
		if timeChart != activity.StartDateLocal.Format(FormatDate) {
			continue
		}
		textMessage := &model.TextMessageNotifySummary{
			CurrentTime:  time.Now().Format(FormatDateTime),
			Distance:     fmt.Sprintf("%v km", math.Round((activity.Distance/float64(1000))*100)/100),
			MovingTime:   time.Duration(activity.MovingTime * 1000000000).String(),
			AverageSpeed: fmt.Sprintf("%.2f km/h", activity.AverageSpeed*60*60/float64(1000)),
			MaxSpeed:     fmt.Sprintf("%.2f km/h", activity.MaxSpeed*60*60/float64(1000)),
			Note:         fmt.Sprintf("ChÃºc má»«ng báº¡n Ä‘Ã£ hoÃ n thÃ nh má»¥c tiÃªu cháº¡y %v km ngÃ y hÃ´m qua %v nhÃ©", distanceGoal, time.Now().AddDate(0, 0, -1).Format(FormatDate)),
		}
		if activity.Distance < distanceGoal*1000 {
			textMessage.Note = fmt.Sprintf("Báº¡n Ä‘Ã£ khÃ´ng hoÃ n thÃ nh má»¥c tiÃªu cháº¡y %v km ngÃ y hÃ´m qua %v rá»“i :sleepy: ", distanceGoal, time.Now().AddDate(0, 0, -1).Format(FormatDate))
		}
		messageActives = append(messageActives, textMessage)
		chartsInfo = append(chartsInfo, &internalModel.ChartInfo{
			Day:   timeChart,
			Value: math.Round((activity.Distance/float64(1000))*100) / 100,
		})
	}

	if len(messageActives) == 0 {
		messageActives = append(messageActives, &model.TextMessageNotifySummary{
			CurrentTime:  time.Now().Format(FormatDateTime),
			Distance:     fmt.Sprintf("%v km", 0),
			MovingTime:   "0h0m0s",
			AverageSpeed: fmt.Sprintf("%v km/h", 0),
			MaxSpeed:     fmt.Sprintf("%v km/h", 0),
			Note:         fmt.Sprintf("HÃ´m qua %v, báº¡n khÃ´ng cháº¡y Ã  :rage:", time.Now().AddDate(0, 0, -1).Format(FormatDate)),
		})
	}

	err = b.statisticalDomain.UpsertStatistical(chartsInfo)
	for _, messageActivity := range messageActives {
		message := &model.SlackMessage{
			Text:        "Activity Information",
			IconEmoji:   client.DefaultEmoji,
			Attachments: messageActivity.ToAttachment(),
		}
		err = client.SendMessageSlack(b.cfg.WebhookSlack, message)
		if err != nil {
			return err
		}
	}
	return nil
}
``` 

Káº¿t quáº£ nháº­n Ä‘Æ°á»£c sau khi tá»›i **9h hÃ ng ngÃ y**

![image.png](https://images.viblo.asia/13b8963d-c4b2-4478-9e3a-cffc204e9a73.png)

# 7. Bot thá»‘ng kÃª dá»¯ liá»‡u hÃ ng thÃ¡ng

**9h30 NgÃ y Ä‘áº§u tiÃªn cá»§a hÃ ng thÃ¡ng**, bot thá»‘ng sá»‘ liá»‡u tá»«ng ngÃ y mÃ¬nh cháº¡y rá»“i generate ra biá»ƒu Ä‘á»“ alert láº¡i cho mÃ¬nh.

Äá»ƒ generate Ä‘á»‘ng dá»¯ liá»‡u thu tháº­p Ä‘Æ°á»£c thÃ nh biá»ƒu Ä‘á»“ mÃ¬nh dÃ¹ng thÆ° viá»‡n [wcharczuk/go-chart/v2](https://github.com/wcharczuk/go-chart/) trÃªn github Ä‘Æ°á»£c vote gáº§n 4k stars.

Äá»ƒ bot gá»­i vÃ o Slack biá»ƒu Ä‘á»“ thá»‘ng kÃª mÃ¬nh cáº§n upload áº£nh chart lÃªn host nÃ o Ä‘Ã³ Ä‘á»ƒ láº¥y link áº£nh Ä‘á»ƒ bot cÃ³ thá»ƒ báº¯n message vÃ o channel Slack. MÃ¬nh cÃ³ search google vÃ  tÃ¬m Ä‘Æ°á»£c má»™t [freeimage.host](https://freeimage.host/page/api?lang=en) - host free mÃ  láº¡i cÃ²n cho lÆ°u áº£nh full-size ğŸ˜„ğŸ˜„ğŸ˜„

## 7.1. Xá»­ lÃ½ upload áº£nh

```Go
func UploadImage(params *model.ParamUploadImage) (*model.ImageInfo, error) {
	logrus.Info("Get link upload image")

	payload := &bytes.Buffer{}
	writer := multipart.NewWriter(payload)
	_ = writer.WriteField("source", params.Base64StringImage)
	_ = writer.WriteField("key", params.ApiKey)
	err := writer.Close()
	if err != nil {
		return nil, err
	}

	req, err := http.NewRequest("POST", UrlHost, payload)

	if err != nil {
		return nil, err
	}

	req.Header.Set("Content-Type", writer.FormDataContentType())
	res, err := http.DefaultClient.Do(req)
	if err != nil {
		return nil, err
	}
	defer func(Body io.ReadCloser) {
		err = Body.Close()
		if err != nil {
			return
		}
	}(res.Body)

	body, err := ioutil.ReadAll(res.Body)
	if err != nil {
		return nil, err
	}
	if res.StatusCode != http.StatusOK {
		if res != nil {
			bodyBytes, err := ioutil.ReadAll(res.Body)
			if err != nil {
				logrus.Warnf("response %v", string(bodyBytes))
				return nil, err
			}
			return nil, errors.New("link upload image failure")
		}
	}

	imgInfo := &model.ImageInfo{}
	err = json.Unmarshal(body, imgInfo)
	if err != nil {
		return nil, err
	}
	logrus.Info("successfully link upload image...")

	return imgInfo, nil
}
``` 
Sau khi gá»i api Ä‘á»ƒ lÆ°u áº£nh mÃ¬nh sáº½ nháº­n Ä‘Æ°á»£c url cá»§a áº£nh má»›i Ä‘Æ°á»£c upload Ä‘Ã³ tá»« api tráº£ vá».

## 7.2. Generate biá»ƒu Ä‘á»“ thá»‘ng kÃª dá»¯ liá»‡u

```Go
func (s *StatisticalDomain) GetBase64StringChart(queries map[string]interface{}) (string, float64, error) {
	statistical, err := s.statisticalRepo.GetByQueries(queries)
	if err != nil {
		return "", 0, err
	}

	chartInfo, sumKilometers := make([]*model.ChartInfo, 0), float64(0)
	err = json.Unmarshal([]byte(statistical.Metadata), &chartInfo)
	if err != nil {
		return "", 0, err
	}

	// Generate chart
	graph := chart.BarChart{
		Width:  2560,
		Height: 1440,
		Title:  strings.Join([]string{"Statistical Chart", time.Now().Month().String(), fmt.Sprintf("%v", time.Now().Year())}, "-"),
		XAxis: chart.Style{
			Hidden:              false,
			TextRotationDegrees: 45.0,
		},
	}

	bars := make([]chart.Value, 0)
	for _, value := range chartInfo {
		bars = append(bars, chart.Value{
			Label: value.Day,
			Value: value.Value,
		})
		sumKilometers += value.Value
	}
	graph.Bars = bars

	var buf bytes.Buffer
	err = graph.Render(chart.PNG, &buf)
	if err != nil {
		return "", 0, err
	}

	// Encode as base64.
	return base64.StdEncoding.EncodeToString(buf.Bytes()), sumKilometers, nil
}
``` 
Sau khi, mÃ¬nh thá»±c hiá»‡n generate chart tá»« dá»¯ liá»‡u lÆ°u Ä‘Æ°á»£c á»Ÿ database Ä‘Æ°á»£c file cá»§a hÃ¬nh áº£nh -> encodebase64 image -> truyá»n encode base64 string vÃ o api upload áº£nh Ä‘Æ°á»£c xá»­ lÃ½ á»Ÿ bÆ°á»›c 7.1 Ä‘á»ƒ láº¥y Ä‘Æ°á»£c link Ä‘Æ°á»ng dáº«n cá»§a hÃ¬nh áº£nh.

## 7.3. Implement code

Káº¿t há»£p code api láº¥y Ä‘Æ°á»£c Ä‘Æ°á»£c link Ä‘Æ°á»ng dáº«n hÃ¬nh áº£nh vÃ  **bot** gá»­i message vÃ o channel báº±ng **Slack Webhook** Ä‘á»ƒ xá»­ lÃ½ alert thá»‘ng kÃª dá»¯ liá»‡u mÃ¬nh Ä‘áº¡t Ä‘Æ°á»£c sau 1 thÃ¡ng ná»— lá»±c táº­p luyá»‡n, cháº¡y bá»™ ğŸ˜„ğŸ˜„ğŸ˜„

```Go
func (b *BotNotify) ProcessNotifyStatistical() error {
	timeChart := strings.Join([]string{time.Now().Month().String(), fmt.Sprintf("%v", time.Now().Year())}, "-")
	base64StringImage, sumKilometers, err := b.statisticalDomain.GetBase64StringChart(map[string]interface{}{
		"time_chart": timeChart,
	})
	if err != nil {
		return err
	}

	imageInfo, err := upload_images.UploadImage(&model.ParamUploadImage{
		Base64StringImage: base64StringImage,
		ApiKey:            b.cfg.ApiKeyUploadImage,
	})
	if err != nil {
		logrus.Errorf("get weather information from open-weather fail %v", err)
		return err
	}

	// Send message to slack
	textMessage := &model.TextMessageNotifyStatistical{
		ImageUrl: imageInfo.Image.Url,
	}

	message := &model.SlackMessage{
		Text:        strings.Join([]string{"Statistical Chart", timeChart, ". Tá»•ng sá»‘:", fmt.Sprintf("%.2f km", sumKilometers)}, " "),
		IconEmoji:   client.DefaultEmoji,
		Attachments: textMessage.ToAttachment(),
	}
	return client.SendMessageSlack(b.cfg.WebhookSlack, message)
}
``` 
Káº¿t quáº£ nháº­n Ä‘Æ°á»£c sau khi tá»›i **9h30 NgÃ y Ä‘áº§u tiÃªn cá»§a hÃ ng thÃ¡ng**. Hiá»‡n táº¡i, cÅ©ng Ä‘áº¿n khi ngá»“i viáº¿t bÃ i nÃ y thÃ¬ mÃ¬nh váº«n chÆ°a thu tháº­p Ä‘Æ°á»£c 1 thÃ¡ng data nÃªn mÃ¬nh fake data gen táº¡m chart cho má»i ngÆ°á»i dá»… hÃ¬nh dung nhÃ© ğŸ˜„

![image.png](https://images.viblo.asia/9d48ed79-6a22-44de-998f-1f701a519ed8.png)

# 8. Káº¿t luáº­n

Sau quÃ¡ trÃ¬nh giá»›i thiá»‡u cÅ©ng nhÆ° hÆ°á»›ng dáº«n lÃ m má»™t con **bot** Ä‘Æ¡n giáº£n phá»¥c vá»¥ cho cuá»™c sá»‘ng cÃ¡ nhÃ¢n hÃ ng ngÃ y, mÃ¬nh hi vá»ng má»i ngÆ°á»i sáº½ tháº¥y thÃº vá»‹ vÃ  bá»›t nhÃ m chÃ¡n sau nhá»¯ng ngÃ y code cÄƒng tháº³ng, má»‡t má»i.

Source code : https://github.com/nguyenvantuan2391996/be-topsis

BÃ i viáº¿t Ä‘Æ°á»£c trÃ­ch tá»« blog cá»§a mÃ¬nh : https://tuannguyenhust.hashnode.dev/

Tiá»‡n thá»ƒ **Tiki** Ä‘ang cÃ³ chÆ°Æ¡ng trÃ¬nh [Ä‘i bá»™ lÃªn máº·t trÄƒng sÄƒn thÆ°á»Ÿng 1 tá»· Ä‘á»“ng](https://tiki.vn/khuyen-mai/di-bo-nhan-thuong/?utm_source=tiki360_homepage). Má»i ngÆ°á»i tham giÃ¡ há»‘t xu nÃ o ğŸ˜„ğŸ˜„ğŸ˜„

Link tham gia: [Äi bá»™ sÄƒn thÆ°á»Ÿng cÃ¹ng Tiki](https://tiki.vn/khuyen-mai/di-bo-nhan-thuong/?utm_source=tiki360_homepage)

![image.png](https://images.viblo.asia/3cba23c9-a5eb-4ea5-b95f-814ac69734d1.png)