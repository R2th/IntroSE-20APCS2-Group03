**H√† N·ªôi, Ch·ªß nh·∫≠t, 21/08/2022... V√†i l·ªùi g·ª≠i g·∫Øm th·ªùi gian**

Nh·∫°c sƒ© : [Tr·ªãnh C√¥ng S∆°n](https://vi.wikipedia.org/wiki/Tr%E1%BB%8Bnh_C%C3%B4ng_S%C6%A1n)

*H√† N·ªôi m√πa thu, m√πa thu H√† N·ªôi<br>
M√πa hoa s·ªØa v·ªÅ th∆°m t·ª´ng c∆°n gi√≥<br>
M√πa c·ªëm xanh v·ªÅ th∆°m b√†n tay nh·ªè<br>
C·ªëm s·ªØa v·ªâa h√® th∆°m b∆∞·ªõc ch√¢n qua...*

![image.png](https://images.viblo.asia/0df77cca-bc2d-4a7f-97a6-5766ffbb2faf.png)

T√¥i nh·ªõ thu *H√† N·ªôi* qu√°, nh·ªØng ƒë√™m ngh√™u ngao h√°t c√πng em tr√™n nh·ªØng con ph·ªë thu v·∫Øng gi√≥ thu kh·∫Ω lu·ªìn qua t√† √°o em bay. Tay ƒëan v√†o nhau, em n√≥i y√™u t√¥i üòç

M√πi r∆∞·ª£u thoang tho·∫£ng quy·ªán theo t·ª´ng c∆°n gi√≥. Em ƒë·ªï v√†o l√≤ng t√¥i, m√° h√¢y h√¢y h·ªìng, mi·ªáng th∆°m m√πi r∆∞·ª£u, m·∫Øt em kh·∫Ω cong. *H√† N·ªôi* ƒë·∫πp nh·∫•t v√†o ng√†y ·∫•y - ng√†y *Thu* c√≥ em...

![hi.gif](https://images.viblo.asia/51d1e3d5-2d62-4c94-ba80-a2094bd7a34d.gif)

# 1. Gi·ªõi thi·ªáu t·ªïng quan

T·∫≠p **th·ªÉ d·ª•c** c√≥ th·ªÉ ngƒÉn t√≠ch t·ª• m·ª° th·ª´a v√† duy tr√¨ gi·∫£m c√¢n. Khi ho·∫°t ƒë·ªông th·ªÉ ch·∫•t, ƒë·ªët ch√°y calo, ho·∫°t ƒë·ªông c√†ng m·∫°nh, c√†ng nhi·ªÅu calo b·ªã ƒë·ªët ch√°y.

Ho·∫°t ƒë·ªông th·ªÉ ch·∫•t t√≠ch c·ª±c th√∫c ƒë·∫©y l∆∞·ª£ng **Lipoprotein** t·ª∑ tr·ªçng cao **(HDL)** ‚Äì m·ª° m√°u t·ªët v√† gi·∫£m **triglyceride, Lipoprotein** t·ª∑ tr·ªçng th·∫•p **(LDLc)** kh√¥ng l√†nh m·∫°nh, t√°c d·ª•ng k√©p n√†y gi√∫p m√°u l∆∞u th√¥ng d·ªÖ d√†ng v√† gi·∫£m nguy c∆° b·ªánh tim m·∫°ch.

![running.gif](https://images.viblo.asia/3808f219-2a08-41b4-9cbf-bd626f418066.gif)

Hi·ªán t·∫°i, m√¨nh l√† m·ªôt **developer** n√™n ph·∫£i ng·ªìi m√°y t√≠nh 8h m·ªôt ng√†y. V√¨ v·∫≠y t·∫≠p th·ªÉ d·ª•c, th·ªÉ thao ƒë·ªëi v·ªõi m√¨nh l√† vi·ªác r·∫•t c·∫ßn thi·∫øt sau ng√†y l√†m cƒÉng th·∫≥ng. Tuy ƒë√£ trang b·ªã r·∫•t nhi·ªÅu ƒë·ªì c√¥ng ngh·ªá ph·ª•c v·ª• cho vi·ªác n√†y nh∆∞: ƒê·ªìng h·ªì th√¥ng minh, app [Strava](https://www.strava.com/) ƒë√£ mua license üòÉ, google fit,... nh∆∞ng vi·ªác th·ªÉ d·ª•c c·ªßa m√¨nh v·∫´n kh√¥ng ƒë∆∞·ª£c ƒë·ªÅu ƒë·∫∑n khi c√≥ nhi·ªÅu l√Ω do ƒë·∫øn t·ª´ ch·ªß quan l·∫´n kh√°ch quan.

M√¨nh v·∫´n lu√¥n ∆∞·ªõc ao s·∫Ω c√≥ m·ªôt ng∆∞·ªùi n√†o ƒë√≥ s·∫Ω lu√¥n nh·∫Øc nh·ªü b·∫£n th√¢n m√¨nh ƒë√∫ng gi·ªù trong m·ªói ng√†y: *" ƒê·ª©ng l√™n ! ƒêi th·ªÉ d·ª•c ƒëi. "* v√† cu·ªëi th√°ng t·ªïng k·∫øt l·∫°i k·∫øt qu·∫£ m√¨nh ƒë·∫°t ƒë∆∞·ª£c c·ªßa th√°ng ƒë√≥: s·ªë li·ªáu, th√†nh t·ª±u bi·ªÉu di·ªÖn d∆∞·ªõi d·∫°ng bi·ªÉu ƒë·ªì ch·∫≥ng h·∫°n. Vi·ªác thu√™ m·ªôt ng∆∞·ªùi l√†m vi·ªác ƒë√≥ th√¨ c≈©ng l√† m·ªôt c√°ch kh√¥ng t·ªìi nh∆∞ng ƒë·ªëi v·ªõi m·ªôt ng∆∞·ªùi l√†m ngh·ªÅ **Dev** th√¨ vi·ªác t·ª± t·∫°o ra m·ªôt con **Bot** th·∫≠t s·ª± l√† m·ªôt c√°ch th√∫ v·ªã v√† c√≥ t√≠nh ch√≠nh x√°c g·∫ßn nh∆∞ tuy·ªát ƒë·ªëi üòÉüòÉüòÉ

M√¨nh l√†m vi·ªác t·ª´ **8h-8h30** cho ƒë·∫øn **18h-18h30** h√†ng ng√†y. C√¥ng c·ª• trao ƒë·ªïi v·ªõi m·ªçi ng∆∞·ªùi trong team ƒëa ph·∫ßn d√πng [Slack](https://slack.com/) n√™n ·ªü ƒë√¢y m√¨nh t·∫°o **bot** tr√™n Slack ƒë·ªÉ alert nh·∫Øc nh·ªü v√† t·ªïng k·∫øt th√†nh bi·ªÉu ƒë·ªì h√†ng th√°ng. C√°c ch·ª©c nƒÉng ch√≠nh c·ªßa **bot** nh∆∞ sau:

1. **9h h√†ng ng√†y**, bot crawl th√¥ng tin tr√™n account [Strava](https://www.strava.com/) c·ªßa m√¨nh r·ªìi alert th√¥ng tin m√¨nh ch·∫°y ƒë∆∞·ª£c ng√†y h√¥m qua. VD: **S·ªë km, th·ªùi gian ch·∫°y, t·ªëc ƒë·ªô ch·∫°y,...**
2. **9h30 Ng√†y ƒë·∫ßu ti√™n c·ªßa h√†ng th√°ng**, bot th·ªëng s·ªë li·ªáu t·ª´ng ng√†y m√¨nh ch·∫°y r·ªìi generate ra bi·ªÉu ƒë·ªì alert l·∫°i cho m√¨nh.
3. **17h30 h√†ng ng√†y**, bot ki·ªÉm tra th·ªùi ti·∫øt h√¥m nay r·ªìi alert cho m√¨nh th√¥ng tin ƒë√≥ v√† d·ª±a v√†o ƒë√≥ ƒë·ªÉ g·ª£i √Ω xem c√≥ n√™n ra ngo√†i ch·∫°y th·ªÉ d·ª•c kh√¥ng?

# 2. Sequence diagram

![sync-data.png](https://images.viblo.asia/0174c195-5d2e-4954-ba7e-511eb190cf93.png)

**Note** : [App Zepp](https://play.google.com/store/apps/details?id=com.huami.watch.hmwatchmanager&hl=vi&gl=US) - ·ª©ng d·ª•ng l∆∞u tr·ªØ th√¥ng tin s·ª©c kho·∫ª ƒë∆∞·ª£c ƒëo t·ª´ smart watch. D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªìng b·ªô t·ª´ smart watch -> app **Zepp** -> app **Strava**

![bot-notify-run.png](https://images.viblo.asia/26aa1d1d-40cf-49c4-9db0-c1a26cb48dc2.png)

**Note** : [Open Weather Map](https://openweathermap.org/api) - cung c·∫•p api mi·ªÖn ph√≠ ƒë·ªÉ l·∫•y th√¥ng tin th·ªùi ti·∫øt theo **v·ªã tr√≠, khu v·ª±c**.

![bot-notify-summary.png](https://images.viblo.asia/272d232a-2e48-4bdd-95d6-85f741b8027e.png)

**Note** : [Strava](https://developers.strava.com/docs/reference/) - l∆∞u tr·ªØ, chia s·∫ª ho·∫°t ƒë·ªông th·ªÉ d·ª•c, th·ªÉ thao d·ªÖ hi·ªÉu h∆°n l√† m·∫°ng x√£ h·ªôi d√†nh cho ng∆∞·ªùi ch∆°i th·ªÉ thao

![bot-notify-statistical.png](https://images.viblo.asia/22f91f2d-cbb6-4b38-ba4e-189b96d46ddf.png)

# 3. T·∫°o bot Slack
![bot.gif](https://images.viblo.asia/b03f1591-718b-4849-aa13-411c35d9f344.gif)

ƒê·ªÉ t·∫°o m·ªôt con **bot** c√≥ th·ªÉ g·ª≠i tin nh·∫Øn v√†o channel th√¨ c·∫ßn t·∫°o m·ªôt webhook trong Slack. Khi c√≥ trigger h√†nh ƒë·ªông th√¨ con **bot** s·∫Ω t·ª± ƒë·ªông post message t·ªõi channel th√¥ng qua webhook n√†y. C√°ch t·∫°o th√¨ m·ªçi ng∆∞·ªùi tham kh·∫£o link [Incoming Webhook](https://team-tbo7018.slack.com/apps/new/A0F7XDUAZ-incoming-webhooks) c·ªßa Slack.

ƒê·ªÉ implement code b·∫±ng Go th√¨ c≈©ng ƒë∆°n gi·∫£n th√¥i ch·ªâ c·∫ßn generate theo format c·ªßa Slack r·ªìi g·ªçi webhook. Slack c√≥ h∆∞·ªõng d·∫´n t·ª´ng b∆∞·ªõc m·ªçi ng∆∞·ªùi [tham kh·∫£o ƒë√¢y nh√©](https://api.slack.com/messaging/webhooks#:~:text=Incoming%20Webhooks%20are%20a%20simple,make%20the%20messages%20stand%20out.)

```Go
func sendMessage(webhook string, message *model.SlackMessage) error {
	logrus.Info("Send message to webhook ", webhook)

	payload, err := json.Marshal(message)
	if err != nil {
		return err
	}
	req, err := http.NewRequest("POST", webhook, bytes.NewReader(payload))
	if err != nil {
		return err
	}

	req.Header.Add("Content-Type", "application/json")
	req.Header.Set("Accept", "application/json")
	res, err := http.DefaultClient.Do(req)

	if err != nil {
		return err
	}

	defer func(Body io.ReadCloser) {
		err = Body.Close()
		if err != nil {
			return
		}
	}(res.Body)
	if res.StatusCode != http.StatusOK {
		if res != nil {
			bodyBytes, err := ioutil.ReadAll(res.Body)
			if err != nil {
				logrus.Warnf("response %v", string(bodyBytes))
				return err
			}
			return errors.New("notification failure")
		}
	}
	logrus.Info("successfully sent notification...")
	return nil
}
``` 

# 4. T·∫°o cron job v·ªõi Golang

## 4.1. T√†i li·ªáu cho cron job

·ªû ph·∫ßn n√†y nhanh th√¨ m√¨nh d√πng lu√¥n th∆∞ vi·ªán tr√™n github [robfig/cron/v3](https://github.com/robfig/cron/) ƒë∆∞·ª£c vote **10k starts** ƒë·ªÉ t·∫°o cron job c·ªßa Golang.

C√≤n n·∫øu t·ª± build ph·∫ßn cron job th√¨ trong t∆∞∆°ng lai g·∫ßn hy v·ªçng m√¨nh c√≥ th·ªùi gian ƒë·ªÉ ra b√†i v·ªÅ ph·∫ßn n√†y üòÑüòÑüòÑ. C√°c b·∫°n c√≥ th·ªÉ tham kh·∫£o thu·∫≠t to√°n [Round-robin scheduling](https://en.wikipedia.org/wiki/Round-robin_scheduling) ƒë·ªÉ hi·ªÉu r√µ c√°ch m·ªôt **Scheduler** ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o nh√©.

## 4.2. C·∫•u h√¨nh cron job

Cron job c√≥ d·∫°ng

```
cron = "X X X X X" (5 k√≠ t·ª±)
``` 
T∆∞∆°ng ·ª©ng

```
<ph√∫t> <gi·ªù> <ng√†y trong th√°ng> <th√°ng> <ng√†y trong tu·∫ßn>
``` 
C√°c b·∫°n c√≥ th·ªÉ ƒë·ªçc th√™m [cron job ·ªü ƒë√¢y nh√©](https://en.wikipedia.org/wiki/Cron)

D·ª±a v√†o ƒë·ªãnh nghƒ©a tr√™n ta implement ra ƒë∆∞·ª£c c·∫•u h√¨nh cho **bot** ƒë·ªÉ g·ª≠i message

1. **9h h√†ng ng√†y** -> CRON_NOTIFY_SUMMARY=0 9 * * *
2. **9h30 Ng√†y ƒë·∫ßu ti√™n c·ªßa h√†ng th√°ng** -> CRON_NOTIFY_STATISTICAL=30 9 1 * *
3. **17h30 h√†ng ng√†y** -> CRON_NOTIFY_RUN=30 17 * * *

## 4.3. Implement code

```Go
func main() {
	cfg, err := config.LoadConfig("build")
	if err != nil {
		logrus.Warnf("cannot load config: %v", err)
		return
	}

	logrus.Info("Create new cron")
	c := cron.New()

	// Notify run at 17:30 every day
	notifyRun, err := c.AddFunc(cfg.CronNotifyRun, func() {
		err = notifyBot.ProcessNotifyRun()
		if err != nil {
			logrus.Warnf("send message for run is failed %v", err)
		}
	})

	// Notify summary 09:00 every day
	notifySummary, err := c.AddFunc(cfg.CronNotifySummary, func() {
		err = notifyBot.ProcessNotifySummary()
		if err != nil {
			logrus.Warnf("send message for summary is failed %v", err)
		}
	})

	// Notify statistical 09:30 on day-of-month 1
	notifyStatistical, err := c.AddFunc(cfg.CronNotifyStatistical, func() {
		err = notifyBot.ProcessNotifyStatistical()
		if err != nil {
			logrus.Warnf("send message for statistical is failed %v", err)
		}
	})
	if err != nil {
		c.Remove(notifyRun)
		c.Remove(notifySummary)
		c.Remove(notifyStatistical)
		return
	}

	// Start cron with one scheduled job
	logrus.Info("Start cron")
	c.Run()
}
``` 

# 5. Bot nh·∫Øc nh·ªü ch·∫°y th·ªÉ d·ª•c

**17h30 h√†ng ng√†y**, bot ki·ªÉm tra th·ªùi ti·∫øt h√¥m nay r·ªìi alert cho m√¨nh th√¥ng tin ƒë√≥ v√† d·ª±a v√†o ƒë√≥ ƒë·ªÉ g·ª£i √Ω xem c√≥ n√™n ra ngo√†i ch·∫°y th·ªÉ d·ª•c kh√¥ng?

## 5.1. Ki·ªÉm tra th·ªùi ti·∫øt hi·ªán t·∫°i

ƒê·ªÉ l·∫•y c√°c th√¥ng tin v·ªÅ th·ªùi ti·∫øt hi·ªán t·∫°i theo khu v·ª±c m√¨nh s·ª≠ d·ª•ng API c·ªßa 
[openweathermap](https://openweathermap.org) - N√≥ cho **1,000 API calls per day for free** v·∫≠y l√† qu√° ƒë·ªß d√πng r·ªìi ƒë√∫ng kh√¥ng n√†o üòÑüòÑüòÑ. C√°c b·∫°n c√≥ th·ªÉ ƒë·ªçc t√†i li·ªáu api ·ªü ƒë√¢y nh√© -> [Document API](https://openweathermap.org/api/one-call-3) openweathermap

```Go
func GetWeatherInfo(url string, params *model.ParamOpenWeather) (*model.OpenWeather, error) {
	logrus.Info("Get weather information")

	req, err := http.NewRequest("GET", url, nil)
	if err != nil {
		return nil, err
	}

	q := req.URL.Query()
	q.Add("lat", params.Lat)
	q.Add("lon", params.Lon)
	q.Add("units", params.Units)
	q.Add("appid", params.Appid)
	q.Add("exclude", params.Exclude)
	req.URL.RawQuery = q.Encode()

	req.Header.Add("Content-Type", "application/json")
	req.Header.Set("Accept", "application/json")
	res, err := http.DefaultClient.Do(req)

	if err != nil {
		return nil, err
	}

	defer func(Body io.ReadCloser) {
		err = Body.Close()
		if err != nil {
			logrus.Errorf("Close body fail %v", err)
		}
	}(res.Body)
	body, err := ioutil.ReadAll(res.Body)
	if res.StatusCode != http.StatusOK {
		if res != nil {
			bodyBytes, err := ioutil.ReadAll(res.Body)
			if err != nil {
				logrus.Warnf("response %v", string(bodyBytes))
				return nil, err
			}
			return nil, errors.New("get weather information failure")
		}
	}

	openWeather := &model.OpenWeather{}
	err = json.Unmarshal(body, openWeather)
	if err != nil {
		return nil, err
	}
	logrus.Info("successfully get weather information...")

	return openWeather, nil
}
``` 
·ªû ƒë√¢y t·∫°m th·ªùi m√¨nh ch·ªâ c·∫ßn quan t√¢m t·ªõi nhi·ªát ƒë·ªô v√† th·ªùi ti·∫øt: **M∆∞a, n·∫Øng, nhi·ªÅu m√¢y**. D·ª±a v√†o c√°c th√¥ng tin ƒë√≥ ƒë·ªÉ alert c√≥ n√™n ch·∫°y b·ªô kh√¥ng.

## 5.2. Implement code

K·∫øt h·ª£p code api l·∫•y th√¥ng tin th·ªùi ti·∫øt v√† bot g·ª≠i message v√†o channel b·∫±ng **Slack Webhook** ƒë·ªÉ x·ª≠ l√Ω alert nh·∫Øc nh·ªü ch·∫°y th·ªÉ d·ª•c

```Go
func (b *BotNotify) ProcessNotifyRun() error {
	weatherInfo, err := weather.GetWeatherInfo("https://openweathermap.org/data/2.5/onecall", &model.ParamOpenWeather{
		Lat:     Latitude,
		Lon:     Longitude,
		Units:   Units,
		Appid:   b.cfg.AppID,
		Exclude: Exclude,
	})
	if err != nil {
		logrus.Errorf("get weather information from open-weather fail %v", err)
		return err
	}
	textMessage := &model.TextMessageNotifyRun{
		CurrentTime: time.Now().Format(FormatDateTime),
		Location:    Location,
		Temperature: fmt.Sprintf("%v %v feels like %v %v", weatherInfo.Current.Temp, Celsius, weatherInfo.Current.FeelsLike, Celsius),
		Weather:     weatherInfo.Current.Weather[0].Description,
		IsRunning:   "Yes",
		Note:        fmt.Sprintf("H√¥m nay %v, tr·ªùi kh√¥ng m∆∞a n√™n ch·∫°y ƒëi nh√©", time.Now().Format(FormatDate)),
	}
	if weatherInfo.Current.Weather[0].Main == "Rain" {
		textMessage.IsRunning = "No"
		textMessage.Note = fmt.Sprintf("H√¥m nay %v, tr·ªùi m∆∞a r·ªìi n√™n ·ªü nh√† ƒëi nh√©", time.Now().Format(FormatDate))
	}
	message := &model.SlackMessage{
		Text:        Text,
		IconEmoji:   client.DefaultEmoji,
		Attachments: textMessage.ToAttachment(),
	}
	return client.SendMessageSlack(b.cfg.WebhookSlack, message)
}
``` 

K·∫øt qu·∫£ nh·∫≠n ƒë∆∞·ª£c sau khi t·ªõi **17h30 h√†ng ng√†y**

![image.png](https://images.viblo.asia/16c75e44-df21-42f1-98f6-007d2a722985.png)

# 6. Bot th√¥ng b√°o th√¥ng tin ch·∫°y b·ªô

**9h h√†ng ng√†y**, bot crawl th√¥ng tin tr√™n account [Strava](https://www.strava.com/) c·ªßa m√¨nh r·ªìi alert th√¥ng tin m√¨nh ch·∫°y ƒë∆∞·ª£c ng√†y h√¥m qua. VD: **S·ªë km, th·ªùi gian ch·∫°y, t·ªëc ƒë·ªô ch·∫°y,...**

## 6.1. Crawl th√¥ng tin Strava

M√¨nh c√≥ smart watch ƒë·ªÉ ƒëo th√¥ng tin ch·∫°y th·ªÉ d·ª•c. M·ªói l·∫ßn ch·∫°y xong s·∫Ω t·ª± sync d·ªØ li·ªáu l√™n [Strava](https://www.strava.com/). ƒê·ªÉ l·∫•y c√°c th√¥ng tin v·ªÅ chi ti·∫øt ho·∫°t ƒë·ªông c·ªßa ng√†y h√¥m ƒë√≥ m√¨nh d√πng API c·ªßa Strava -> [Docment API](https://developers.strava.com/docs/reference/#api-Activities-getLoggedInAthleteActivities)

Video tham kh·∫£o th√™m ***Intro and accessing Strava API***

{@embed: https://www.youtube.com/watch?v=sgscChKfGyg}

```Go
func GetStravaActivityInfo(params *model.ParamStrava) ([]*model.StravaActivity, error) {
	logrus.Info("Get strava activity information")

	stravaToken, err := GetStravaTokenInfo(UrlGetStravaToken, params)
	req, err := http.NewRequest("GET", UrlGetStravaActivity, nil)
	if err != nil {
		return nil, err
	}

	q := req.URL.Query()
	q.Add("page", "1")
	q.Add("per_page", "3")
	req.URL.RawQuery = q.Encode()

	req.Header.Add("Content-Type", "application/json")
	req.Header.Set("Accept", "application/json")
	req.Header.Set("Authorization", strings.Join([]string{"Bearer ", stravaToken.AccessToken}, ""))
	res, err := http.DefaultClient.Do(req)

	if err != nil {
		return nil, err
	}

	defer func(Body io.ReadCloser) {
		err = Body.Close()
		if err != nil {
			logrus.Errorf("Close body fail %v", err)
			return
		}
	}(res.Body)
	body, err := ioutil.ReadAll(res.Body)
	if res.StatusCode != http.StatusOK {
		if res != nil {
			bodyBytes, err := ioutil.ReadAll(res.Body)
			if err != nil {
				logrus.Warnf("response %v", string(bodyBytes))
				return nil, err
			}
			return nil, errors.New("get strava activity information failure")
		}
	}

	stravaActivity := make([]*model.StravaActivity, 0)
	err = json.Unmarshal(body, &stravaActivity)
	if err != nil {
		return nil, err
	}
	logrus.Info("successfully get strava activity information...")

	return stravaActivity, nil
}
``` 
M√¨nh s·∫Ω l·∫•y 3 ho·∫°t ƒë·ªông g·∫ßn nh·∫•t tr√™n **Strava** b·ªüi v√¨ 1 ng√†y ch·∫Øc m√¨nh th·ªÉ d·ª•c nhi·ªÅu nh·∫•t l√† 3 l·∫ßn : **S√°ng, Chi·ªÅu, T·ªëi** nh∆∞ng th∆∞·ªùng l√† 1 l·∫ßn 1 ng√†y v√†o bu·ªïi t·ªëi th√¥i :LOL: üòÑüòÑüòÑ

## 6.2. Implement code

K·∫øt h·ª£p code api l·∫•y th√¥ng tin ho·∫°t ƒë·ªông tr√™n **Strava** v√† **bot** g·ª≠i message v√†o channel b·∫±ng **Slack Webhook** ƒë·ªÉ x·ª≠ l√Ω alert nh·∫Øc nh·ªü ch·∫°y th·ªÉ d·ª•c.

Trong ph·∫ßn x·ª≠ l√Ω alert n√†y khi l·∫•y ƒë∆∞·ª£c th√¥ng tin ho·∫°t ƒë·ªông tr√™n Strava **bot** b·∫Øn message v√† ƒë·ªìng th·ªùi l∆∞u l·∫°i th√¥ng tin n√†y ƒë·ªÉ ti·ªán h·∫øt 1 th√°ng m√¨nh s·∫Ω th·ªëng k√™ l·∫°i k·∫øt qu·∫£ v√†o **generate ra chart** üòÑüòÑüòÑ

Table **statisticals** l∆∞u th√¥ng tin th·ªëng k√™ d·ªØ li·ªáu
```sql
CREATE TABLE `statisticals` (
  `id` int NOT NULL AUTO_INCREMENT,
  `time_chart` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL,
  `metadata` json DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb3 COLLATE=utf8_unicode_ci;
``` 

```Go
func (b *BotNotify) ProcessNotifySummary() error {
	stravaActivities, err := strava.GetStravaActivityInfo(&model.ParamStrava{
		ClientId:     b.cfg.ClientId,
		ClientSecret: b.cfg.ClientSecret,
		RefreshToken: b.cfg.RefreshToken,
		GrantType:    b.cfg.GrantType,
	})
	if err != nil || len(stravaActivities) == 0 {
		return errors.New("strava activities information empty")
	}

	distanceGoal, err := strconv.ParseFloat(b.cfg.DistanceGoal, 64)
	timeChart, messageActives, chartsInfo := time.Now().AddDate(0, 0, -1).Format(FormatDate), make([]*model.TextMessageNotifySummary, 0), make([]*internalModel.ChartInfo, 0)
	for _, activity := range stravaActivities {
		if timeChart != activity.StartDateLocal.Format(FormatDate) {
			continue
		}
		textMessage := &model.TextMessageNotifySummary{
			CurrentTime:  time.Now().Format(FormatDateTime),
			Distance:     fmt.Sprintf("%v km", math.Round((activity.Distance/float64(1000))*100)/100),
			MovingTime:   time.Duration(activity.MovingTime * 1000000000).String(),
			AverageSpeed: fmt.Sprintf("%.2f km/h", activity.AverageSpeed*60*60/float64(1000)),
			MaxSpeed:     fmt.Sprintf("%.2f km/h", activity.MaxSpeed*60*60/float64(1000)),
			Note:         fmt.Sprintf("Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh m·ª•c ti√™u ch·∫°y %v km ng√†y h√¥m qua %v nh√©", distanceGoal, time.Now().AddDate(0, 0, -1).Format(FormatDate)),
		}
		if activity.Distance < distanceGoal*1000 {
			textMessage.Note = fmt.Sprintf("B·∫°n ƒë√£ kh√¥ng ho√†n th√†nh m·ª•c ti√™u ch·∫°y %v km ng√†y h√¥m qua %v r·ªìi :sleepy: ", distanceGoal, time.Now().AddDate(0, 0, -1).Format(FormatDate))
		}
		messageActives = append(messageActives, textMessage)
		chartsInfo = append(chartsInfo, &internalModel.ChartInfo{
			Day:   timeChart,
			Value: math.Round((activity.Distance/float64(1000))*100) / 100,
		})
	}

	if len(messageActives) == 0 {
		messageActives = append(messageActives, &model.TextMessageNotifySummary{
			CurrentTime:  time.Now().Format(FormatDateTime),
			Distance:     fmt.Sprintf("%v km", 0),
			MovingTime:   "0h0m0s",
			AverageSpeed: fmt.Sprintf("%v km/h", 0),
			MaxSpeed:     fmt.Sprintf("%v km/h", 0),
			Note:         fmt.Sprintf("H√¥m qua %v, b·∫°n kh√¥ng ch·∫°y √† :rage:", time.Now().AddDate(0, 0, -1).Format(FormatDate)),
		})
	}

	err = b.statisticalDomain.UpsertStatistical(chartsInfo)
	for _, messageActivity := range messageActives {
		message := &model.SlackMessage{
			Text:        "Activity Information",
			IconEmoji:   client.DefaultEmoji,
			Attachments: messageActivity.ToAttachment(),
		}
		err = client.SendMessageSlack(b.cfg.WebhookSlack, message)
		if err != nil {
			return err
		}
	}
	return nil
}
``` 

K·∫øt qu·∫£ nh·∫≠n ƒë∆∞·ª£c sau khi t·ªõi **9h h√†ng ng√†y**

![image.png](https://images.viblo.asia/13b8963d-c4b2-4478-9e3a-cffc204e9a73.png)

# 7. Bot th·ªëng k√™ d·ªØ li·ªáu h√†ng th√°ng

**9h30 Ng√†y ƒë·∫ßu ti√™n c·ªßa h√†ng th√°ng**, bot th·ªëng s·ªë li·ªáu t·ª´ng ng√†y m√¨nh ch·∫°y r·ªìi generate ra bi·ªÉu ƒë·ªì alert l·∫°i cho m√¨nh.

ƒê·ªÉ generate ƒë·ªëng d·ªØ li·ªáu thu th·∫≠p ƒë∆∞·ª£c th√†nh bi·ªÉu ƒë·ªì m√¨nh d√πng th∆∞ vi·ªán [wcharczuk/go-chart/v2](https://github.com/wcharczuk/go-chart/) tr√™n github ƒë∆∞·ª£c vote g·∫ßn 4k stars.

ƒê·ªÉ bot g·ª≠i v√†o Slack bi·ªÉu ƒë·ªì th·ªëng k√™ m√¨nh c·∫ßn upload ·∫£nh chart l√™n host n√†o ƒë√≥ ƒë·ªÉ l·∫•y link ·∫£nh ƒë·ªÉ bot c√≥ th·ªÉ b·∫Øn message v√†o channel Slack. M√¨nh c√≥ search google v√† t√¨m ƒë∆∞·ª£c m·ªôt [freeimage.host](https://freeimage.host/page/api?lang=en) - host free m√† l·∫°i c√≤n cho l∆∞u ·∫£nh full-size üòÑüòÑüòÑ

## 7.1. X·ª≠ l√Ω upload ·∫£nh

```Go
func UploadImage(params *model.ParamUploadImage) (*model.ImageInfo, error) {
	logrus.Info("Get link upload image")

	payload := &bytes.Buffer{}
	writer := multipart.NewWriter(payload)
	_ = writer.WriteField("source", params.Base64StringImage)
	_ = writer.WriteField("key", params.ApiKey)
	err := writer.Close()
	if err != nil {
		return nil, err
	}

	req, err := http.NewRequest("POST", UrlHost, payload)

	if err != nil {
		return nil, err
	}

	req.Header.Set("Content-Type", writer.FormDataContentType())
	res, err := http.DefaultClient.Do(req)
	if err != nil {
		return nil, err
	}
	defer func(Body io.ReadCloser) {
		err = Body.Close()
		if err != nil {
			return
		}
	}(res.Body)

	body, err := ioutil.ReadAll(res.Body)
	if err != nil {
		return nil, err
	}
	if res.StatusCode != http.StatusOK {
		if res != nil {
			bodyBytes, err := ioutil.ReadAll(res.Body)
			if err != nil {
				logrus.Warnf("response %v", string(bodyBytes))
				return nil, err
			}
			return nil, errors.New("link upload image failure")
		}
	}

	imgInfo := &model.ImageInfo{}
	err = json.Unmarshal(body, imgInfo)
	if err != nil {
		return nil, err
	}
	logrus.Info("successfully link upload image...")

	return imgInfo, nil
}
``` 
Sau khi g·ªçi api ƒë·ªÉ l∆∞u ·∫£nh m√¨nh s·∫Ω nh·∫≠n ƒë∆∞·ª£c url c·ªßa ·∫£nh m·ªõi ƒë∆∞·ª£c upload ƒë√≥ t·ª´ api tr·∫£ v·ªÅ.

## 7.2. Generate bi·ªÉu ƒë·ªì th·ªëng k√™ d·ªØ li·ªáu

```Go
func (s *StatisticalDomain) GetBase64StringChart(queries map[string]interface{}) (string, float64, error) {
	statistical, err := s.statisticalRepo.GetByQueries(queries)
	if err != nil {
		return "", 0, err
	}

	chartInfo, sumKilometers := make([]*model.ChartInfo, 0), float64(0)
	err = json.Unmarshal([]byte(statistical.Metadata), &chartInfo)
	if err != nil {
		return "", 0, err
	}

	// Generate chart
	graph := chart.BarChart{
		Width:  2560,
		Height: 1440,
		Title:  strings.Join([]string{"Statistical Chart", time.Now().Month().String(), fmt.Sprintf("%v", time.Now().Year())}, "-"),
		XAxis: chart.Style{
			Hidden:              false,
			TextRotationDegrees: 45.0,
		},
	}

	bars := make([]chart.Value, 0)
	for _, value := range chartInfo {
		bars = append(bars, chart.Value{
			Label: value.Day,
			Value: value.Value,
		})
		sumKilometers += value.Value
	}
	graph.Bars = bars

	var buf bytes.Buffer
	err = graph.Render(chart.PNG, &buf)
	if err != nil {
		return "", 0, err
	}

	// Encode as base64.
	return base64.StdEncoding.EncodeToString(buf.Bytes()), sumKilometers, nil
}
``` 
Sau khi, m√¨nh th·ª±c hi·ªán generate chart t·ª´ d·ªØ li·ªáu l∆∞u ƒë∆∞·ª£c ·ªü database ƒë∆∞·ª£c file c·ªßa h√¨nh ·∫£nh -> encodebase64 image -> truy·ªÅn encode base64 string v√†o api upload ·∫£nh ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü b∆∞·ªõc 7.1 ƒë·ªÉ l·∫•y ƒë∆∞·ª£c link ƒë∆∞·ªùng d·∫´n c·ªßa h√¨nh ·∫£nh.

## 7.3. Implement code

K·∫øt h·ª£p code api l·∫•y ƒë∆∞·ª£c ƒë∆∞·ª£c link ƒë∆∞·ªùng d·∫´n h√¨nh ·∫£nh v√† **bot** g·ª≠i message v√†o channel b·∫±ng **Slack Webhook** ƒë·ªÉ x·ª≠ l√Ω alert th·ªëng k√™ d·ªØ li·ªáu m√¨nh ƒë·∫°t ƒë∆∞·ª£c sau 1 th√°ng n·ªó l·ª±c t·∫≠p luy·ªán, ch·∫°y b·ªô üòÑüòÑüòÑ

```Go
func (b *BotNotify) ProcessNotifyStatistical() error {
	timeChart := strings.Join([]string{time.Now().Month().String(), fmt.Sprintf("%v", time.Now().Year())}, "-")
	base64StringImage, sumKilometers, err := b.statisticalDomain.GetBase64StringChart(map[string]interface{}{
		"time_chart": timeChart,
	})
	if err != nil {
		return err
	}

	imageInfo, err := upload_images.UploadImage(&model.ParamUploadImage{
		Base64StringImage: base64StringImage,
		ApiKey:            b.cfg.ApiKeyUploadImage,
	})
	if err != nil {
		logrus.Errorf("get weather information from open-weather fail %v", err)
		return err
	}

	// Send message to slack
	textMessage := &model.TextMessageNotifyStatistical{
		ImageUrl: imageInfo.Image.Url,
	}

	message := &model.SlackMessage{
		Text:        strings.Join([]string{"Statistical Chart", timeChart, ". T·ªïng s·ªë:", fmt.Sprintf("%.2f km", sumKilometers)}, " "),
		IconEmoji:   client.DefaultEmoji,
		Attachments: textMessage.ToAttachment(),
	}
	return client.SendMessageSlack(b.cfg.WebhookSlack, message)
}
``` 
K·∫øt qu·∫£ nh·∫≠n ƒë∆∞·ª£c sau khi t·ªõi **9h30 Ng√†y ƒë·∫ßu ti√™n c·ªßa h√†ng th√°ng**. Hi·ªán t·∫°i, c≈©ng ƒë·∫øn khi ng·ªìi vi·∫øt b√†i n√†y th√¨ m√¨nh v·∫´n ch∆∞a thu th·∫≠p ƒë∆∞·ª£c 1 th√°ng data n√™n m√¨nh fake data gen t·∫°m chart cho m·ªçi ng∆∞·ªùi d·ªÖ h√¨nh dung nh√© üòÑ

![image.png](https://images.viblo.asia/9d48ed79-6a22-44de-998f-1f701a519ed8.png)

# 8. K·∫øt lu·∫≠n

Sau qu√° tr√¨nh gi·ªõi thi·ªáu c≈©ng nh∆∞ h∆∞·ªõng d·∫´n l√†m m·ªôt con **bot** ƒë∆°n gi·∫£n ph·ª•c v·ª• cho cu·ªôc s·ªëng c√° nh√¢n h√†ng ng√†y, m√¨nh hi v·ªçng m·ªçi ng∆∞·ªùi s·∫Ω th·∫•y th√∫ v·ªã v√† b·ªõt nh√†m ch√°n sau nh·ªØng ng√†y code cƒÉng th·∫≥ng, m·ªát m·ªèi.

Source code : https://github.com/nguyenvantuan2391996/be-topsis

B√†i vi·∫øt ƒë∆∞·ª£c tr√≠ch t·ª´ blog c·ªßa m√¨nh : https://tuannguyenhust.hashnode.dev/

Ti·ªán th·ªÉ **Tiki** ƒëang c√≥ ch∆∞∆°ng tr√¨nh [ƒëi b·ªô l√™n m·∫∑t trƒÉng sƒÉn th∆∞·ªüng 1 t·ª∑ ƒë·ªìng](https://tiki.vn/khuyen-mai/di-bo-nhan-thuong/?utm_source=tiki360_homepage). M·ªçi ng∆∞·ªùi tham gi√° h·ªët xu n√†o üòÑüòÑüòÑ

Link tham gia: [ƒêi b·ªô sƒÉn th∆∞·ªüng c√πng Tiki](https://tiki.vn/khuyen-mai/di-bo-nhan-thuong/?utm_source=tiki360_homepage)

![image.png](https://images.viblo.asia/3cba23c9-a5eb-4ea5-b95f-814ac69734d1.png)