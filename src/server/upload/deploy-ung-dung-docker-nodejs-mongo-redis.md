Ch√†o m·ª´ng c√°c b·∫°n ƒë√£ quay tr·ªü l·∫°i v·ªõi series [H·ªçc Docker v√† CICD](https://viblo.asia/s/series-hoc-docker-cicd-tu-co-ban-den-ap-dung-vao-thuc-te-jeZ103QgKWz) c·ªßa m√¨nh üëãüëã

·ªû b√†i tr∆∞·ªõc ch√∫ng ta ƒë√£ c√πng nhau t√¨m hi·ªÉu v·ªÅ [c√°ch ch·∫°y container v·ªõi non-root user](https://viblo.asia/p/tai-sao-nen-chay-ung-dung-container-voi-non-root-user-jvEla3VNKkw). T·ª´ b√†i n√†y ch√∫ng ta s·∫Ω b·∫Øt ƒë·∫ßu deploy c√°c ·ª©ng d·ª•ng Docker ch·∫°y tr√™n server th·∫≠t, cu·ªëi c√πng l√† d√πng CICD ƒë·ªÉ auto deploy v√† ch√∫ng ta k·∫øt th√∫c series n√†y nh√© :)

·ªû b√†i n√†y ch√∫ng ta s·∫Ω c√πng nhau deploy ·ª©ng d·ª•ng Docker, NodeJS, MongoDB, Redis tr√™n server th·∫≠t, c√πng v·ªõi ƒë√≥ l√† setup domain, HTTPS nh√©. Cu·ªëi b√†i ta s·∫Ω c√πng so s√°nh v·ªõi c√°ch deploy ki·ªÉu truy·ªÅn th·ªëng ng√†y x∆∞a khi kh√¥ng c√≥ Docker s·∫Ω nh∆∞ th·∫ø n√†o nh√© ;)

# ƒêi·ªÅu ki·ªán ti√™n quy·∫øt
> Nghe v·∫´n nom nh∆∞ ƒë√°m h·ªçc sinh c·∫•p 3 :rofl::rofl:

V√¨ b√†i n√†y ta deploy ·ªü tr√™n server th·∫≠t n√™n ƒë∆∞∆°ng nhi√™n ƒëi·ªÅu ki·ªán c·∫ßn c√≥ l√† c√°c b·∫°n c√≥ 1 VPS c·ªßa ri√™ng m√¨nh, nh·ªõ l√† VPS ch·ª© kh√¥ng ph·∫£i Hosting nh√©. N√™n ch·ªçn Ubuntu nh√© c√°c b·∫°n (Centos, Redhat c≈©ng kh√¥ng sao).

# Setup
ƒê·∫ßu ti√™n c√°c b·∫°n clone source code c·ªßa m√¨nh [·ªü ƒë√¢y](https://gitlab.com/maitrungduc1410/learning-docker) (nh√°nh `master`). B√†i n√†y ch√∫ng ta ch·ªâ quan t√¢m t·ªõi folder `deploy-docker-node` nh√©.

T·ªïng quan project:
- V·ªÅ ch·ª©c nƒÉng th√¨ project n√†y v·∫´n gi·ªëng c√°c project NodeJS ·ªü c√°c b√†i tr∆∞·ªõc g·ªìm c√≥: login, logout, th√™m s·∫£n ph·∫©m, l∆∞u user session,...
- T·∫•t c·∫£ c√°c container ƒë·ªÅu ƒë∆∞·ª£c ch·∫°y v·ªõi non-root user

Ti·∫øp theo c√°c b·∫°n copy folder `deploy-docker-node` n√†y ra 1 n∆°i ri√™ng bi·ªát n√†o ƒë√≥ ƒë·ªÉ l√°t n·ªØa ta push l√™n Repository nh√©

Sau ƒë√≥ c√°c b·∫°n t·∫°o 1 repository tr√™n Gitlab v·ªõi t√™n l√† `deploy-docker-node` ƒë·ªÉ t·∫πo n·ªØa ch·∫°y ·ªü local ngon ngh·∫ª xong ta s·∫Ω push code l√™n repository, r·ªìi l√™n server pull v·ªÅ v√† build image nh√©.
# Ch·∫°y ·ªü local
Nh∆∞ th∆∞·ªùng l·ªá, vi·ªác ƒë·∫ßu ti√™n ta c·∫ßn l√†m l√† build Docker image v√† ch·∫°y th·ª≠ ·ªü local tr∆∞·ªõc ƒë·ªÉ ƒë·∫£m b·∫£o m·ªçi th·ª© v·∫´n ·ªïn ƒë·ªãnh tr∆∞·ªõc khi ta l√™n server nh√©.

B·ªüi v√¨ t·∫•t c·∫£ c√°c container c·ªßa ta ƒë·ªÅu ch·∫°y v·ªõi non-root user n√™n tr∆∞·ªõc khi ch·∫°y ta c·∫ßn x√°c ƒë·ªãnh UserID + Group ID c·ªßa user ·ªü m√¥i tr∆∞·ªùng g·ªëc c·ªßa ta l√† g√¨ nh√© (n·∫øu c√°c b·∫°n kh√¥ng hi·ªÉu t·∫°i s·∫°o l·∫°i l√†m th·∫ø th√¨ ƒë·ªçc l·∫°i b√†i [Ch·∫°y ·ª©ng d·ª•ng container b·∫±ng non-root user](https://viblo.asia/p/tai-sao-nen-chay-ung-dung-container-voi-non-root-user-jvEla3VNKkw) c·ªßa m√¨nh nh√©).

·ªû m√¥i tr∆∞·ªùng g·ªëc c√°c b·∫°n ch·∫°y command sau:
```
id -u
----> 501

id -g
----> 20
```
 Nh∆∞ c√°c b·∫°n th·∫•y User ID ·ªü m√¥i tr∆∞·ªùng g·ªëc c·ªßa m√¨nh l√† `501` v√† Group ID l√† `20`. 

Ch√∫ √Ω quan tr·ªçng r·∫±ng: n·∫øu UserID + Group ID c·ªßa c√°c b·∫°n l√† `1000:1000` th√¨ ·ªü Dockerfile b√™n d∆∞·ªõi c√≥ ch√∫t kh√°c, v√¨ tr√πng v·ªõi user `node` trong container NodeJS ·ªü [b√†i tr∆∞·ªõc](https://viblo.asia/p/tai-sao-nen-chay-ung-dung-container-voi-non-root-user-jvEla3VNKkw) m√¨nh ƒë√£ n√≥i r·∫•t kƒ© r·ªìi nh√©.

Sau ƒë√≥ c√°c b·∫°n m·ªü `Dockerfile` v√† ta c√πng s·ª≠a l·∫°i ph·∫ßn user nh∆∞ sau nh√©:
```Dockerfile
FROM node:12.18-alpine

WORKDIR /app

RUN npm install -g pm2

COPY ["package.json", "package-lock.json*", "./"]

RUN npm install --production --silent

COPY . .


# ----- N·∫øu UID:GID l√† 1000:1000
# USER node
# RUN chown -R node:node /app
# ----- N·∫øu kh√¥ng th√¨
RUN addgroup -g 20 appgroup
RUN adduser -D -u 501 appuser -G appgroup
RUN chown -R appuser:appgroup /app
USER appuser
# ---------------------------------------


CMD ["pm2-runtime", "ecosystem.config.js", "--env", "production"]
```
·ªû tr√™n `UID:GID` c·ªßa m√¨nh l√† `501:20` nh√©.

Sau ƒë√≥ ta ti·∫øn h√†nh build image nh√©:
```
docker build -t learning-docker:deploy-node .
```
B√ôMMMM :boom::boom:, L·ªói @@:

![](https://images.viblo.asia/766f635e-240c-4ca5-977f-04e2b1837b84.png)

L·ªói b√°o `group v·ªõi ID l√† 20` ƒë∆∞·ª£c ƒë∆∞·ª£c s·ª≠ d·ª•ng m·∫•t r·ªìi. Kh·∫£ nƒÉng l√† Group m√† ta ƒëang t·∫°o v·ªõi ID 20 ƒë√£ b·ªã tr√πng v·ªõi 1 group n√†o ƒë√≥ c√≥ s·∫µn trong container.

C√°c b·∫°n s·ª≠a l·∫°i Dockerfile th√™m v√†o cho m√¨nh 1 d√≤ng sau ƒë·ªÉ li·ªát k√™ ra c√°c group c√≥ s·∫µn trong container nh√©:
```Dockerfile
FROM node:12.18-alpine

WORKDIR /app

RUN npm install -g pm2

COPY ["package.json", "package-lock.json*", "./"]

RUN npm install --production --silent

COPY . .

# ----- N·∫øu UID:GID l√† 1000:1000
# USER node
# RUN chown -R node:node /app
# ----- N·∫øu kh√¥ng th√¨
RUN cat /etc/group # +++++++++++++++++ TH√äM V√ÄO D√íNG N√ÄY
RUN addgroup -g 20 appgroup
RUN adduser -D -u 501 appuser -G appgroup
RUN chown -R appuser:appgroup /app
USER appuser
# ---------------------------------------

CMD ["pm2-runtime", "ecosystem.config.js", "--env", "production"]
```
Sau ƒë√≥ ta ti·∫øn h√†nh build l·∫°i image:
```
docker build -t learning-docker:deploy-node .
```
Xem ·ªü c·ª≠a s·ªï Terminal c√°c b·∫°n s·∫Ω th·∫•y in ra nh∆∞ sau:
```
....

dialout:x:20:root ->>>>>>>>>>>>>> Ch√∫ √Ω d√≤ng n√†y

....
```
·ªí v·∫≠y l√† GroupID 20 ƒë√£ b·ªã tr√πng v·ªõi 1 group t√™n l√† `dialout` trong container, v·∫≠y th√¨ ·ªü Dockerfile thay v√¨ t·∫°o group m·ªõi ta ƒë∆°n gi·∫£n l√† d√πng lu√¥n group n√†y, c√°c b·∫°n s·ª≠a l·∫°i Dockerfile nh∆∞ sau nh√©:
```Dockerfile
FROM node:12.18-alpine

WORKDIR /app

RUN npm install -g pm2

COPY ["package.json", "package-lock.json*", "./"]

RUN npm install --production --silent

COPY . .

RUN adduser -D -u 501 appuser -G dialout

RUN chown -R appuser:dialout /app

USER appuser

CMD ["pm2-runtime", "ecosystem.config.js", "--env", "production"]
```
Sau ƒë√≥ ta ti·∫øn h√†nh build l·∫°i image v√† s·∫Ω kh√¥ng th·∫•y b·ªã l·ªói n·ªØa nh√©:
```
docker build -t learning-docker:deploy-node .
```
Ti·∫øp theo ta c·∫≠p nh·∫≠t l·∫°i file `docker-compose.yml` ƒë·ªÉ ch·∫°y `MongoDB` v√† `Redis` v·ªõi c√πng `UID:GID` nh∆∞ ·ªü m√¥i tr∆∞·ªùng g·ªëc nh√©:
```yaml
...
db:
    image: mongo
    volumes:
      - .docker/data/db:/data/db
    restart: unless-stopped
    user: "501:20"
    
redis:
    image: redis:5-alpine
    volumes:
      - .docker/data/redis:/data
    restart: unless-stopped
    user: "501:20"
```
Cu·ªëi c√πng l√† ta ti·∫øn h√†nh ch·∫°y project l√™n nh√©:
```
docker-compose up -d
```
Sau ƒë√≥ ta m·ªü tr√¨nh duy·ªát ·ªü `localhost:3000` th·∫•y nh∆∞ sau l√† cu·ªôc ƒë·ªùi t∆∞∆°i s√°ng r·ªìi nh√© :grinning::grinning::

![](https://images.viblo.asia/18abae24-a190-4fa2-a703-e0fa5d358480.png)

C√°c b·∫°n th·ª≠ t·∫°o account, login v√† th√™m m·ªõi th·ª≠ v√†i s·∫£n ph·∫©m xem sao nh√©.

**Note cho b·∫°n n√†o ƒëang d√πng Windows**: c√°c b·∫°n xem l·∫°i ph·∫ßn ch√∫ √Ω l√∫c mount volume cho MongoDB m√¨nh ƒë√£ n√≥i ·ªü b√†i [Dockerize ·ª©ng d·ª•ng NodeJS, Mongo](https://viblo.asia/p/dockerize-project-nodejs-mongodb-redis-passport-4P856NXW5Y3#_chay-project-11) r·ªìi nh√©

V·∫≠y l√† ƒë√£ ·ªïn r·ªìi ƒë√≥, c√°c b·∫°n ta ti·∫øn h√†nh push code l√™n Gitlab repository nh√©:
```
git init
git add .
git commit -m "first commit"
git remote add origin https://gitlab.com/maitrungduc1410/deploy-docker-node.git
git push -u origin master
```
Note: ·ªû tr√™n c√°c b·∫°n thay t√™n account c·ªßa c√°c b·∫°n v√†o nh√© (nh∆∞ c·ªßa m√¨nh l√† `maitrungduc1410`)

√Çu c√¢y ti·∫øp theo ta s·∫Ω b∆∞·ªõc t·ªõi c√¥ng ƒëo·∫°n deploy tr√™n server nh√© :)
# Deploy
ƒê·∫ßu ti√™n c√°c b·∫°n nh·ªõ SSH v√†o server nh√©.

ƒêi·ªÉm hay ho v√† c≈©ng l√† th·ª© tuy·ªát v·ªùi nh·∫•t khi l√†m vi·ªác v·ªõi ·ª©ng d·ª•ng Docker ƒë√≥ l√† vi·ªác √≠t (hay th·∫≠m ch√≠ l√† kh√¥ng) b·ªã ·∫£nh h∆∞·ªüng b·ªüi m√¥i tr∆∞·ªùng ngo√†i, v√† 1 khi ta ƒë√£ Dockerize th√†nh c√¥ng ·ªü local th√¨ l√™n server deploy s·∫Ω r·∫•t ƒë∆°n gi·∫£n. Th·ª© ta c·∫ßn ch·ªâ l√† `Docker` v√† `Docker Compose` (t·∫•t nhi√™n :joy::joy:).

B·∫Øt ƒë·∫ßu th√¥i n√†o :D

ƒê·∫ßu ti√™n c√°c b·∫°n ki·ªÉm tra xem tr√™n server ƒë√£ c√≥ Docker v√† Docker compose ch∆∞a nh√©:
```
docker --version
docker-compose --version
```
N·∫øu ch∆∞a c√≥ c√°c b·∫°n c√†i ƒë·∫∑t b·∫±ng h∆∞·ªõng d·∫´n [·ªü ƒë√¢y](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-18-04)(Docker) v√† [·ªü ƒë√¢y](https://www.digitalocean.com/community/tutorials/how-to-install-docker-compose-on-ubuntu-18-04)(Docker compose) nh√©

Sau ƒë√≥ c√°c b·∫°n chuy·ªÉn t·ªõi 1 folder b·∫•t k√¨ tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu nh√©, ·ªü ƒë√¢y m√¨nh ch·ªçn `/var/www/html`
```
cd /var/www/html
```
Sau ƒë√≥ ta clone source code t·ª´ Gitlab v·ªÅ nh√©:
```
git clone https://gitlab.com/maitrungduc1410/deploy-docker-node
```
Note: ·ªü tr√™n c√°c b·∫°n thay t√™n account Gitlab c·ªßa c√°c b·∫°n v√†o nh√©.

N·∫øu ƒë∆∞·ª£c h·ªèi username + pass th√¨ c√°c b·∫°n nh·∫≠p email + pass t√†i kho·∫£n Gitlab.

V√† c≈©ng gi·ªëng nh∆∞ ·ªü local, tr∆∞·ªõc khi ch·∫°y ta c·∫ßn check xem User ID v√† Groupd ID c·ªßa user ·ªü m√¥i tr∆∞·ªùng g·ªëc c·ªßa ch√∫ng ta l√† g√¨ nh√©:
```
id -u
--->> 1000

id -g
--->> 1000
```
·ªû tr√™n m√¨nh c√≥ `UID:GID` l√† `1000:1000` (yeah, l√°t n·ªØa vi·∫øt Dockerfile cho nh√†n :D)

C√°c b·∫°n s·ª≠a l·∫°i Dockerfile v·ªõi n·ªôi dung nh∆∞ sau nh√©:
```Dockerfile
FROM node:12.18-alpine

WORKDIR /app

RUN npm install -g pm2

COPY ["package.json", "package-lock.json*", "./"]

RUN npm install --production --silent

COPY . .

USER node

CMD ["pm2-runtime", "ecosystem.config.js", "--env", "production"]
```
**Note quan tr·ªçng**: v√¨ ·ªü tr√™n UID:GID c·ªßa m√¨nh l√† 1000:1000 n√™n m√¨nh d√πng lu√¥n user `node`, c√≤n kh√¥ng th√¨ c√°c b·∫°n l·∫°i l√†m nh∆∞ ·ªü local v·ª´a n√£y nh√©.

Ti·∫øp theo ta c·∫ßn update l·∫°i user cho MongoDB v√† Redis trong `docker-compose.yml` n·ªØa:
```yaml
db:
    image: mongo
    volumes:
      - .docker/data/db:/data/db
    restart: unless-stopped
    user: "1000:1000"

redis:
    image: redis:5-alpine
    volumes:
      - .docker/data/redis:/data
    restart: unless-stopped
    user: "1000:1000"
```
·ªîn r·ªìi ƒë√≥ ta ti·∫øn h√†nh build image nh√©:
```
docker build -t learning-docker:deploy-node .
```
Sau khi build xong th√¨ ta ch·∫°y project l√™n th√¥i:
```
docker-compose up -d
```
ƒê·ª£i t·∫ßm 1 ph√∫t ƒë·ªÉ MongoDB kh·ªüi ƒë·ªông ho√†n to√†n, ta m·ªü tr√¨nh duy·ªát ·ªü ƒë·ªãa ch·ªâ `<server_IP>:3000` nh√©.

V√†..............B√ôM...

![](https://images.viblo.asia/5f3e685b-9a58-4e31-9b72-ba57ecf25ba4.png)

Sao v·∫≠y nh·ªâ?? :thinking::thinking:

Th·ª≠ ki·ªÉm tra xem container ƒë√£ ch·∫°y ch∆∞a nh√©:
```
docker-compose ps

           Name                         Command               State           Ports         
--------------------------------------------------------------------------------------------
deploy-docker-node_app_1     docker-entrypoint.sh pm2-r ...   Up      0.0.0.0:3000->3000/tcp
deploy-docker-node_db_1      docker-entrypoint.sh mongod      Up      27017/tcp             
deploy-docker-node_redis_1   docker-entrypoint.sh redis ...   Up      6379/tcp 
```
·ªîn r·ªìi m√† nh·ªâ :thinking::thinking:

V·∫•n ƒë·ªÅ l√† v·ªõi c√°c VPS ta mua, th√¨ th∆∞·ªùng ban ƒë·∫ßu s·∫Ω kh√¥ng c√≥ port n√†o ƒë∆∞·ª£c m·ªü ƒë·ªÉ cho traffic t·ª´ th·∫ø gi·ªõi b√™n ngo√†i ƒëi v√†o, m√† ta ph·∫£i t·ª± tay m·ªü. C√≥ 2 c√°ch: 1 l√† ta d√πng `UFW` (Firewall) nh∆∞ 1 s·ªë tutorial c√≥ l√†m, nh∆∞ng c√°ch n√†y kh√¥ng hay, n·∫øu c√°c b·∫°n mua VPS ·ªü c√°c nh√† cung c·∫•p l·ªõn (Google, AWS, Azure, Digital Ocean,...) th√¨ h·ªç cho ph√©p ta c√≥ th·ªÉ m·ªü port tr√™n giao di·ªán web qu·∫£n l√Ω ri√™ng. M√¨nh th·∫•y ƒëi·ªÅu n√†y t·ªët h∆°n, ta ch·ªâ c·∫ßn ch·ªâ ƒë·ªãnh port n√†o c·∫ßn m·ªü, vi·ªác c√≤n l·∫°i th√¨ nh√† cung c·∫•p h·ªç lo, c≈©ng ƒë·ª° lo c√°c v·∫•n ƒë·ªÅ b·∫£o m·∫≠t h∆°n. D√πng `UFW` kh√¥ng ƒë·ªçc kƒ© h∆∞·ªõng d·∫´n l√∫c `enable` l√™n kh√©o l·∫°i b·ªã terminate v√† kh√¥ng SSH l·∫°i ƒë∆∞·ª£c :rofl::rofl:

V√≠ d·ª• nh∆∞ m√¨nh d√πng Azure th√¨ giao di·ªán nom nh∆∞ sau:

![](https://images.viblo.asia/f860d014-9ccc-4269-adf2-03e031c64474.png)

Nh∆∞ng n·∫øu n∆°i c√°c b·∫°n mua VPS kh√¥ng h·ªó tr·ª£ vi·ªác n√†y ho·∫∑c b·∫°n c·ª© mu·ªën m·ªü b·∫±ng "UFW" th√¨ ta ch·∫°y command sau nh√©:
```
sudo ufw allow 3000
```
V√† ngay sau khi ta m·ªü port ƒë·ªÉ traffic b√™n ngo√†i c√≥ th·ªÉ ƒëi v√†o server, quay tr·ªü l·∫°i tr√¨nh duy·ªát F5 ta s·∫Ω th·∫•y k·∫øt qu·∫£:

![](https://images.viblo.asia/17d55a9e-bbec-4561-9193-0778939cf7a7.png)

Sau ƒë√≥ ta th·ª≠ t·∫°o t√†i kho·∫£n, login v√† th√™m m·ªõi v√†i s·∫£n ph·∫©m s·∫Ω th·∫•y m·ªçi th·ª© ho·∫°t ƒë·ªông tr∆°n tru nh∆∞ local :D

Qu√° ƒë∆°n gi·∫£n khi deploy ·ª©ng d·ª•ng Container v·ªõi Docker ph·∫£i kh√¥ng n√†o ;)
# HTTPS
## Tr·ªè Domain v·ªÅ Server
Khi ta ch·∫°y project ·ªü production th∆∞·ªùng ta s·∫Ω d√πng domain ƒë·ªÉ tr√¥ng cho chuy√™n nghi·ªáp, c√≥ th∆∞∆°ng hi·ªáu h∆°n m√† c√≤n c√≥ nh·ªØng l·ª£i √≠ch to l·ªõn nh∆∞ sau:
- D√πng domain l·∫•y HTTPS r·∫•t d·ªÖ
- Kh√¥ng ph·∫£i m·ªü port v√¥ t·ªôi v·∫° khi s·ªë project tr√™n server c·ªßa ta tƒÉng l√™n nhi·ªÅu, khi ƒë√≥ m·ªói project ta ph·∫£i ch·∫°y ·ªü port kh√°c nhau.
- D√πng domain ta ch·ªâ c·∫ßn m·ªü duy nh·∫•t 2 port: 80 cho HTTP v√† 443 cho HTTPS, d√π s·ªë l∆∞·ª£ng project c√≥ nhi·ªÅu th·∫ø n√†o. ;)

·ªû ƒë√¢y m√¨nh kh√¥ng khuy·∫øn kh√≠ch c√°c b·∫°n d√πng Self-signed certificate ƒë·ªÉ l·∫•y HTTPS cho IP nh√©, v√¨ g·∫ßn nh∆∞ ch·∫≥ng bao gi·ªù ta d√πng c√°i ƒë√≥ ·ªü production v√¨ c√°c tr√¨nh duy·ªát b√¢y gi·ªù ƒë√£ kh√¥ng cho ph√©p Self-Signed Certificate v√† s·∫Ω hi·ªÉn th·ªã m√†n h√¨nh ƒë·ªè l√≤m. :stuck_out_tongue_winking_eye:

V·∫≠y n√™n ƒëi·ªÅu ki·ªán c·∫ßn c√≥ ƒë·ªÉ l·∫•y HTTPS ·ªü b√†i n√†y l√† c√°c b·∫°n c·∫ßn ph·∫£i c√≥ 1 t√™n mi·ªÅn (domain name) nh√©. M√¨nh khuy·∫øn kh√≠ch c√°c b·∫°n mua ·ªü nh·ªØng nh√† cung c·∫•p l·ªõn nh∆∞ Goddady, ch·ªçn 1 t√™n c√πi c√πi ƒë·ªÉ h·ªçc t·∫≠p (loanh quanh 100K VND l√† c√πng :D)

Sau khi c√°c b·∫°n c√≥ domain th√¨ c√°c b·∫°n v√†o trang qu·∫£n tr·ªã c·ªßa domain ƒë√≥, s·ª≠a l·∫°i ƒë·ªãa ch·ªâ IP c·ªßa b·∫£n ghi `A` m√† ƒë∆∞·ª£c t·∫°o s·∫µn ƒë·ªÉ tr·ªè v·ªÅ server IP c·ªßa ch√∫ng ta nh√©:

![](https://images.viblo.asia/0f1655ff-af5b-481b-b89c-fe0935d777ff.png)

Ngay sau ƒë√≥ c√°c b·∫°n quay tr·ªü l·∫°i tr√¨nh duy·ªát truy c·∫≠p l·∫°i app c·ªßa ch√∫ng ta b·∫±ng domain xem sao nh√©, v√≠ d·ª• nh∆∞ c·ªßa m√¨nh ·ªü ƒë√¢y l√† `xoixeotv.com:3000`

![](https://images.viblo.asia/343e41a7-fe56-46a9-8531-82e9ad9d980e.png)

√Çu c√¢y v·∫≠y l√† gi·ªù app c·ªßa ch√∫ng ta ƒë√£ c√≥ domain r·ªìi, vi·ªác ti·∫øp theo l√† l·∫•y HTTPS n·ªØa th√¥i :D

> Note: ·ªû tr√™n c√°c b·∫°n th·∫•y m√¨nh c√≥ t·∫°o 1 b·∫£n ghi `CNAME` l√† `www` v√† tr·ªè v·ªÅ `@` t·ª©c l√† tr·ªè v·ªÅ c√πng IP v·ªõi b·∫£n ghi `A` ƒë·ªÉ l√°t n·ªØa ta c√≥ th·ªÉ truy c·∫≠p theo c·∫£ 2 ki·ªÉu `xoixeotv.com` ho·∫∑c `www.xoixeotv.com` nh√©

## C√°ch l·∫•y HTTPS
 ·ªû production, ng∆∞·ªùi ta th∆∞·ªùng d√πng 1 webserver ƒë·ª©ng tr∆∞·ªõc app c·ªßa ch√∫ng ta ƒë√≥ng vai tr√≤ v·ª´a l√† t·∫ßng b·∫£o m·∫≠t, load balancing, caching ho·∫∑c proxy cho request nh·∫≠n t·ª´ ph√≠a user gi√∫p tƒÉng hi·ªáu su·∫•t cho ·ª©ng d·ª•ng c·ªßa ch√∫ng ta.
 
 V√† 1 trong nh·ªØng webserver m√¨nh th·∫•y ng∆∞·ªùi ta d√πng nhi·ªÅu nh·∫•t b√¢y gi·ªù l√† Nginx. ·ªû b√†i n√†y ta s·∫Ω d√πng n√≥ nh√©. C√πng v·ªõi ƒë√≥, ƒë·ªÉ l·∫•y ch·ª©ng ch·ªâ HTTPS free th√¨ ta d√πng Certbot nh√©.
 
 T·ª´ ƒë√¢y ta c√≥ lu·ªìng x·ª≠ l√Ω nh∆∞ sau:
 
![](https://images.viblo.asia/06fe6506-4e02-4fa4-93a0-b76f45b4641f.png)

Nom c≈©ng nh∆∞ deploy ki·ªÉu truy·ªÅn th·ªëng tr∆∞·ªõc gi·ªù v·∫´n l√†m ·∫•y nh·ªâ :D

V·∫≠y v·∫•n ƒë·ªÅ ·ªü ƒë√¢y l√†: th·∫ø Nginx kia ta ƒë·∫∑t ·ªü m√¥i tr∆∞·ªùng ngo√†i hay m√¥i tr∆∞·ªùng b√™n trong Docker? :thinking::thinking:

√î hay ƒëang l√†m Docker, mu·ªën gi·ªØ m√¥i tr∆∞·ªùng ngo√†i "nguy√™n trinh" m√†, t·∫•t nhi√™n ƒë·∫∑t Nginx ch·∫°y trong container lu√¥n ch·ª©, v·∫≠y n√™n chi ti·∫øt design nom s·∫Ω nh∆∞ sau:

![](https://images.viblo.asia/38994ec0-1e0d-46c6-99da-2764944c621b.png)

V·ªõi c√°ch design b√™n tr√™n, khi ta c√≥ nhi·ªÅu project th√¨ tr√¥ng s·∫Ω nh∆∞ sau:

![](https://images.viblo.asia/a77c30b5-6571-47f1-a15e-de289a14147d.png)

V√† v·ªõi m·ªói project th∆∞·ªùng ta s·∫Ω ƒë·∫∑t ch√∫ng ·ªü nh·ªØng n∆°i ri√™ng bi·ªát:
- 1 folder cho project NodeJS + MongoDB + Redis
- Project Laravel + MySQL + Redis ƒë·∫∑t ·ªü folder kh√°c
- ... N project kh√°c

C√≤n ri√™ng container Nginx + Certbot ta s·∫Ω ƒë·∫∑t ·ªü 1 n∆°i kh√°c v√¨ ƒë√¢y l√† th·ª© d√πng chung cho t·∫•t c·∫£ project. V√† m√¨nh nh·∫≠n th·∫•y l√† vi·ªác ch·∫°y Nginx + Certbot trong Docker container n√†y c√≥ 1 s·ªë nh∆∞·ª£c ƒëi·ªÉm nh∆∞ sau:
- Vi·ªác l·∫•y HTTPS trong container h∆°i l·∫±ng nh·∫±ng h∆°n 1 ch√∫t khi ph·∫£i map volume, ch·∫°y script b·∫±ng tay. C√°c b·∫°n c√≥ th·ªÉ xem [·ªü ƒë√¢y](https://medium.com/@pentacent/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71)
- Trong tr∆∞·ªùng h·ª£p ta c√≥ 1 s·ªë app ch·∫°y trong Docker, 1 s·ªë app kh√°c l·∫°i l√†m theo ki·ªÉu truy·ªÅn th·ªëng kh√¥ng c√≥ Docker (c√†i tr·ª±c ti·∫øp v√†o m√¥i tr∆∞·ªùng g·ªëc), v√† khi l·∫•y HTTPS cho ch√∫ng s·∫Ω "h∆°i b·ªã ƒëau ƒë·∫ßu" :D
- C√πng v·ªõi ƒë√≥ m√¨nh hay d√πng Wildcard Certificate (d·∫°ng ki·ªÉu `*.example.com`) th√¨ h∆°i kh√≥ l·∫•y h∆°n

Do v·∫≠y sau 1 th·ªùi gian l√†m m√¨nh ƒë√£ chuy·ªÉn qua c√°ch kh√°c, ƒë√≥ l√† ƒë∆∞a Nginx + Certbot ra m√¥i tr∆∞·ªùng ngo√†i, l√†m nhi·ªám v·ª• chuy√™n tr√°ch nh∆∞ 1 t·∫ßng b·∫£o m·∫≠t ch·ª© kh√¥ng ch·∫°y trong container n·ªØa. Design m·ªõi nom s·∫Ω nh∆∞ sau:

![](https://images.viblo.asia/3db69cae-5f32-4997-b4c7-d6a8a7484a4b.png)

V√† ·ªü b√†i n√†y m√¨nh s·∫Ω h∆∞·ªõng d·∫´n c√°c b·∫°n l√†m theo ki·ªÉu design n√†y nh√©. M√¥i tr∆∞·ªùng ngo√†i "m·∫•t trinh" ch√∫t kh√¥ng sao c√°c b·∫°n nh√© :joy::joy. 

> M·ª•c ƒë√≠ch ch√≠nh nh·∫•t khi m√¨nh l·ª±a ch·ªçn c√°ch ti·∫øp c·∫≠n n√†y l√† v√¨ ta c√≥ th·ªÉ l·∫•y HTTPS r·∫•t d·ªÖ, d√π ch√∫ng c√≥ ch·∫°y trong Docker hay ƒë∆∞·ª£c deploy theo ki·ªÉu truy·ªÅn th·ªëng

> C√°c b·∫°n ho√†n to√†n c√≥ th·ªÉ ch·∫°y c·∫£ Nginx + Certbot trong container c≈©ng ƒë∆∞·ª£c nh√©, nh·ªØng c√°i nh∆∞·ª£c ƒëi·ªÉm b√™n tr√™n c√≥ th·ªÉ ch·ªâ v·ªõi m√¨nh, v·ªõi c√°c b·∫°n l·∫°i kh√¥ng sao. C√°c b·∫°n th·ª≠ xem v√† comment cho m√¨nh nh√© ;)

B·∫Øt ƒë·∫ßu th√¥i n√†o :rocket::rocket:

ƒê·∫ßu ti√™n ·ªü m√¥i tr∆∞·ªùng g·ªëc c√°c b·∫°n c√†i Nginx:
```
sudo apt update
sudo apt install nginx
```
Sau khi c√†i xong c√°c b·∫°n ki·ªÉm tra xem Nginx ch·∫°y ch∆∞a nh√©:
```
sudo service nginx status
```
Sau ƒë√≥ ta s·∫Ω c·∫ßn m·ªü port 80 cho HTTP v√† 443 HTTPS cho traffic b√™n ngo√†i truy c·∫≠p v√†o ƒë∆∞·ª£c nh√©. Ch√∫ √Ω r·∫±ng d√π ta ch·ªâ mong mu·ªën user truy c·∫≠p b·∫±ng HTTPS nh∆∞ng port 80 v·∫´n c·∫ßn ƒë∆∞·ª£c m·ªü v√¨ khi user g√µ tr·ª±c ti·∫øp v√†o tr√¨nh duy·ªát `http://...` (kh√¥ng c√≥ S) m√† port 80 ta kh√¥ng ƒë∆∞·ª£c m·ªü l√† user s·∫Ω kh√¥ng truy c·∫≠p ƒë∆∞·ª£c ƒë√¢u nh√©. V√† ƒë·ªÉ m·ªü port th√¨ c√°c b·∫°n l·∫°i d√πng 1 trong 2 c√°ch: qua trang qu·∫£n tr·ªã nh√† cung c·∫•p VPS (n√™n d√πng) ho·∫∑c d√πng UFW. N·∫øu d√πng UFW th√¨ c√°c b·∫°n l√†m nh∆∞ sau:
```
sudo ufw allow 'Nginx Full'
```

ƒê·∫øn ƒë√¢y c√°c b·∫°n quay l·∫°i tr√¨nh duy·ªát truy c·∫≠p ·ªü ƒë·ªãa ch·ªâ domain c·ªßa c√°c b·∫°n (c·ªïng 80) th·∫•y nh∆∞ sau l√† oke nh√©:

![](https://images.viblo.asia/65a27a8c-bdd2-447f-bb1d-b68751dc923d.png)


Ti·∫øp theo ta c√†i Certbot:
```
sudo add-apt-repository ppa:certbot/certbot
sudo apt-get update
sudo apt-get install python-certbot-nginx
```
Ti·∫øp theo c√°c b·∫°n xo√° file c·∫•u h√¨nh cho domain m·∫∑c ƒë·ªãnh c·ªßa Nginx ƒëi nh√©.
```
sudo rm /etc/nginx/sites-available/default
sudo rm /etc/nginx/sites-enabled/default
```
Sau ƒë√≥ ta t·∫°o 1 file c·∫•u h√¨nh cho domain c·ªßa ch√∫ng ta nh∆∞ sau (nh·ªõ ƒë·ªïi t√™n th√†nh t√™n domain c·ªßa c√°c b·∫°n cho ph√π h·ª£p nh√©):
```
sudo touch /etc/nginx/sites-available/xoixeotv.com
```
N·ªôi dung th√¨ c√°c b·∫°n ƒë·ªÉ nh∆∞ sau nh√©:
```
server {
        listen [::]:80;
        listen 80;
        
        # allow upload file with size upto 500MB
        client_max_body_size 500M;

        server_name xoixeotv.com www.xoixeotv.com;

        location / {
                proxy_pass http://localhost:3000;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header x-forwarded-for $remote_addr;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
        }
}
```
·ªû tr√™n c√°c b·∫°n th·∫•y r·∫±ng ta s·∫Ω proxy request v√†o c·ªïng `3000` n∆°i m√† app NodeJS c·ªßa ch√∫ng ta ƒëang ch·∫°y, nh·ªõ l√† c·ªïng 3000 l√† c·ªïng m√† ta ƒë√£ map port nh√©.

Sau ƒë√≥ c√°c b·∫°n l∆∞u l·∫°i, ti·∫øp theo ta c·∫ßn t·∫°o symbolic link t·ªõi folder `/etc/nginx/sites-enabled` nh√©:
```
sudo ln -s /etc/nginx/sites-available/xoixeotv.com /etc/nginx/sites-enabled/
```
Note: c√°c b·∫°n thay t√™n domain c·ªßa c√°c b·∫°n v√†o cho ph√π h·ª£p nh√©.

Sau ƒë√≥ ta ki·ªÉm tra xem c·∫•u h√¨nh Nginx ƒë√£ ƒë√∫ng hay ch∆∞a b·∫±ng command:
```
sudo nginx -t

->>>>>
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```
N·∫øu c·∫•u h√¨nh ƒë√£ ƒë√∫ng ta ti·∫øn h√†nh kh·ªüi ƒë·ªông l·∫°i Nginx:
```
sudo service nginx restart
```
Ngay sau ƒë√≥ ta quay l·∫°i tr√¨nh duy·ªát truy c·∫≠p ·ªü ƒë·ªãa ch·ªâ `http://<t√™n mi·ªÅn>` (kh√¥ng c·∫ßn n√≥i c·ªïng bao nhi√™u n·ªØa nh√©):

![](https://images.viblo.asia/76f7fef7-9c64-49aa-b94e-a4d1bfe7446f.png)

Cu·ªëi c√πng ta l·∫•y HTTPS v·ªõi 1 command ƒë∆°n gi·∫£n nh∆∞ sau:
```
sudo certbot --nginx -d xoixeotv.com -d www.xoixeotv.com 
```
Khi ƒë∆∞·ª£c h·ªèi c√≥ `Redirect HTTP to HTTPS` hay kh√¥ng th√¨ c√°c b·∫°n ch·ªçn option 2 (YES), ƒë·ªÉ chuy·ªÉn h∆∞·ªõng to√†n b·ªô HTTP sang HTTPS nh√©.

> C√°c b·∫°n ƒë·ªÉ √Ω r·∫±ng khi l·∫•y ch·ª©ng ch·ªâ HTTPS ta l·∫•y cho ƒë·ªìng th·ªùi 2 `xoixeotv.com` v√† `www.xoixeotv.com`

Cu·ªëi c√πng l√† quay l·∫°i tr√¨nh duy·ªát F5 v√† xem k·∫øt qu·∫£ n√†o:

![](https://images.viblo.asia/f8abbe8c-96c8-4113-993c-89b6d308f8c1.png)

V·∫≠y l√† ch√∫ng ta ƒë√£ ho√†n th√†nh vi·ªác l·∫•y HTTPS, c√°c b·∫°n c√≥ th·ªÉ ƒë√≥ng l·∫°i c·ªïng 3000, kh√¥ng cho traffic t·ª´ th·∫ø gi·ªõi ngo√†i g·ªçi v√†o v√¨ gi·ªù ta d√πng domain truy c·∫≠p qua c·ªïng 80 v√† 443 r·ªìi nh√©. C√°c b·∫°n c√≥ th·ªÉ ƒë√≥ng c·ªïng th√¥ng qua giao di·ªán Web c·ªßa nh√† cung c·∫•p nh∆∞ m√¨nh ƒë√£ n√≥i ·ªü tr√™n ho·∫∑c b·∫±ng `UFW` nh∆∞ sau:
```
sudo ufw delete 3000
```
# So s√°nh v·ªõi c√°ch deploy truy·ªÅn th·ªëng
Ta c√πng h·ªìi ·ª©c l·∫°i c√°ch deploy ng√†y x∆∞a nh√©:
- ƒê·∫ßu ti√™n ta c·∫ßn c√†i NodeJS
- Sau ƒë√≥ ta c·∫ßn c√†i MongoDB, setup authentication
- C√†i Redis

C·ª© m·ªói khi deploy tr√™n 1 server m·ªõi ta ƒë·ªÅu ph·∫£i l√†m l·∫°i nh·ªØng b∆∞·ªõc nh∆∞ v·∫≠y, n·∫øu c√°c b·∫°n c√≥ xem b√†i [Deploy ·ª©ng d·ª•ng chat realtime Laravel](https://viblo.asia/p/deploy-ung-dung-chat-realtime-laravel-vuejs-sockerio-redis-tren-ubuntu-63vKjboRK2R) c·ªßa m√¨nh s·∫Ω th·∫•y r·∫±ng ta ph·∫£i c√†i m·ªát ngh·ªâ m·ªõi ƒë·ªß ƒë·ªÉ ch·∫°y project l√™n.

C√πng v·ªõi ƒë√≥ 1 ƒëi·ªÅu v√¥ c√πng ƒë√°ng s·ª£ ƒë√≥ l√† khi ta c√≥ nhi·ªÅu project v√† ta c·∫ßn update, v√≠ d·ª• update MySQL ch·∫≥ng h·∫°n, kh√¥ng may x·∫£y ra l·ªói v√† DB "t·∫Øt ƒëi·ªán", B√ôM, t·∫•t c·∫£ project xong phim :D.

Th·ª© n·ªØa l√† v·ªõi nh·ªØng project c·∫ßn c√†i nhi·ªÅu th·ª©, nh∆∞ project realtime chat kia c·ªßa m√¨nh ch·∫≥ng h·∫°n, vi·ªác nh·ªõ c√†i t·∫•t c·∫£ m·ªçi th·ª© l·∫Øm l√∫c l√† 1 ƒëi·ªÅu kh√≥ khƒÉn, ƒë·∫∑c bi·ªát nh·ªØng h√¥m n√†o c√£i nhau v·ªõi ng∆∞·ªùi y√™u :rofl::rofl:

Ngo√†i ra c√≤n N + 1 n·ªói s·ª£ n·ªØa :D

Khi c√°c b·∫°n xem l·∫°i ph·∫ßn deploy ·ªü b√†i n√†y, ta th·∫•y r·∫±ng r·∫•t nhanh ƒë∆°n gi·∫£n v√† ti·ªán l·ª£i, th√≠ch th√¨ update phi√™n b·∫£n b·∫±ng t√™n image m·ªõi, th√≠ch th√¨ xo√°, thay m·ªõi, v√¥ c√πng d·ªÖ. ƒêi·ªÅu m√† n·∫øu ta deploy theo ki·ªÉu truy·ªÅn th·ªëng kh√≥ m√† c√≥ ƒë∆∞·ª£c. V√† ƒë√≥ c≈©ng l√† ƒëi·ªÅu tuy·ªát v·ªùi nh·∫•t m√¨nh mu·ªën truy·ªÅn t·∫£i v·ªõi c√°c b·∫°n trong series n√†y.
# ƒê√≥ng m√°y
Qua b√†i n√†y ta ƒë√£ ho√†n th√†nh deploy ho√†n ch·ªânh 1 ·ª©ng d·ª•ng NodeJS c√πng v·ªõi ƒë√≥ l√† l·∫•y HTTPS x·ªãn x√≤ cho app c·ªßa ch√∫ng ta.

C·∫£m nh·∫≠n ƒë∆∞·ª£c s·ª± ƒë∆°n gi·∫£n khi deploy ·ª©ng d·ª•ng Docker so v·ªõi ki·ªÉu deploy truy·ªÅn th·ªëng. B·∫±ng c√°ch ch·∫°y app trong Docker container, ta ƒë√£ c√≥ th·ªÉ t·ª± tin h∆°n trong vi·ªác deploy, th√™m s·ª≠a xo√°, update th√†nh ph·∫ßn b·∫•t k√¨ m√† kh√¥ng c√≤n nh·ªØng l·ªói lo "em xo√° ƒëi r·ªìi kh√¥ng c√†i l·∫°i ƒë∆∞·ª£c" hay "th√¥i ƒë·ª´ng update, ƒëang ch·∫°y ngon update l√™n ch·∫øt c·∫£ ƒë·∫•y" :rofl::rofl:

Mong r·∫±ng c√°c b·∫°n s·∫Ω √°p d·ª•ng th·∫≠t t·ªët v√†o c√¥ng vi·ªác c·ªßa ri√™ng m√¨nh.

C√°m ∆°n c√°c b·∫°n ƒë√£ theo d√µi, h·∫πn g·∫∑p l·∫°i c√°c b·∫°n v√†o nh·ªØng b√†i sau ^^