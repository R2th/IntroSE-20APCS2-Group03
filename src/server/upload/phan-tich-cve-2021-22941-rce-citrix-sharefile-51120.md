CÃ¡i bÃ i nÃ y mÃ¬nh Ä‘á»‹nh lÃªn tá»« nÄƒm ngoÃ¡i rá»“i, mÃ  phÃ¢n tÃ­ch xong láº¡i Ä‘á»ƒ Ä‘áº¥y, tháº­t ra lÃ  lÆ°á»i viáº¿t láº¡i nÃªn tá»“n Ä‘á»ng Ä‘áº¿n bÃ¢y giá» chÆ°a viáº¿t bÃ i phÃ¢n tÃ­ch lÃªn blog ğŸ¥². ThÃ´i thÃ¬ ngá»“i viáº¿t láº¡i vá»«a Ä‘á»ƒ cÃ³ chá»— lÆ°u láº¡i, vá»«a Ä‘á»ƒ nhá»› xem mÃ¬nh Ä‘Ã£ phÃ¢n tÃ­ch nhá»¯ng cÃ¡i gÃ¬, biáº¿t Ä‘Ã¢u sau nÃ y láº¡i sá»­ dá»¥ng láº¡i thÃ¬ sao :D 

BÃ i nÃ y mÃ¬nh dá»±a theo bÃ i viáº¿t gá»‘c cá»§a code white, cÅ©ng chÃ­nh lÃ  nhÃ³m phÃ¡t hiá»‡n ra CVE nÃ y, báº¡n Ä‘á»c cÃ³ thá»ƒ Ä‘á»c bÃ i viáº¿t gá»‘c táº¡i https://codewhitesec.blogspot.com/2021/09/citrix-sharefile-rce-cve-2021-22941.html

# Setup
á» Ä‘Ã¢y mÃ¬nh setup trÃªn 1 Windows Server 2019, sá»­ dá»¥ng Hyper-V cho nÃ³ nhanh, cÃ¡c báº¡n cá»© táº£i cÃ¡i file VHD kia vá» rá»“i import vÃ o Hyper-V Manager lÃ  cháº¡y lÃªn luÃ´n nhÃ©, nhanh láº¯m.  
https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019
![image.png](https://images.viblo.asia/b80ace3c-bc6e-4ca5-b38d-7fc7a25725c0.png)

CÃ i Ä‘áº·t Citrix Sharefile thÃ¬ Ä‘Æ¡n giáº£n láº¯m, táº£i phiÃªn báº£n [StorageCenter_5.11.19](https://downloads.citrix.com/8343/StorageCenter_5.11.19.msi?__gda__=exp=1644550798~acl=/*~hmac=ecaa08d61b409dbdc40dfdd53df7271ff455837ce7b1ec987fce3215bea0e2bc), sau Ä‘Ã³ báº¥m next next next, cho Ä‘áº¿n khi nÃ o nÃ³ hiá»ƒn thá»‹ lÃªn trang configure lÃ  Ä‘Æ°á»£c

![image.png](https://images.viblo.asia/deb2d041-2005-4f99-9338-db88e50078a0.png)

# Debug
Xong pháº§n cÃ i Ä‘áº·t, Ä‘áº¿n pháº§n debug thÃ¬ á»Ÿ Ä‘Ã¢y mÃ¬nh sá»­ dá»¥ng JetBrains Rider Ä‘á»ƒ debug, cÃ¡c báº¡n cÅ©ng cÃ³ thá»ƒ sá»­ dá»¥ng thÃªm cáº£ DnsSpy Ä‘á»ƒ váº½ map Ä‘i trace chain cho dá»… dÃ ng hÆ¡n :D 

Má»Ÿ Rider lÃªn rá»“i Attach to Process tá»›i process `w3wp`
![image.png](https://images.viblo.asia/a276683a-7462-48d0-bbcc-b9944ba58f32.png)

Äá»£i 1 tÃ½ lÃ  nÃ³ load nhá»¯ng thÃ nh pháº§n cáº§n thiáº¿t vÃ o, chÃº Ã½ nÃªn sá»­ dá»¥ng SSD Ä‘á»ƒ load project cho nhanh nhÃ©, chá»© HDD load lÃ¢u láº¯m :(

![image.png](https://images.viblo.asia/377c1bf5-5292-423d-8569-3ba1b984e271.png)

# PhÃ¢n tÃ­ch
NhÆ° á»Ÿ bÃ i viáº¿t gá»‘c cÃ³ thá»ƒ tháº¥y tÃ¡c giáº£ Ä‘Ã£ chá»‰ ra ráº±ng Citrix Sharefile cÃ³ sá»­ dá»¥ng [NeatUpload](https://github.com/joeaudette/neatupload/tree/NeatUpload-1.2) cÃ³ niÃªn Ä‘áº¡i tá»›i hÃ ng chá»¥c nÄƒm, vÃ¬ nÃ³ lÃ  thÆ° viá»‡n sá»­ dá»¥ng Ä‘á»ƒ upload nÃªn tÃ¡c giáº£ Ä‘Ã£ tÃ¬m Ä‘Æ°á»£c chá»— sá»­ dá»¥ng Ä‘á»ƒ ghi file lÃªn há»‡ thá»‘ng

![image.png](https://images.viblo.asia/b0654b29-d7d4-4710-a07d-ad96f0c7735d.png)

Báº±ng cÃ¡ch sá»­ dá»¥ng tÃ­nh nÄƒng `Analyzer` trÃªn DnSpy chÃºng ta cÃ³ thá»ƒ tÃ¬m nhanh chÃ³ng tá»« Sink Ä‘áº¿n Source nhÆ° sau (trÃªn Rider cÅ©ng cÃ³ tÃ­nh nÄƒng `Find Usages` hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»±, nhÆ°ng mÃ  mÃ¬nh thÃ­ch sá»­ dá»¥ng cÃ¡i Analyzer trÃªn DnSpy hÆ¡n vÃ¬ nÃ³ váº½ cÃ¡i map cho mÃ¬nh nhÃ¬n cho nÃ³ trá»±c quan) 

![image.png](https://images.viblo.asia/a388d929-055b-4963-8d6f-dc36a64a6621.png)

Váº­y chÃºng ta cÃ³ thá»ƒ tháº¥y ráº±ng, Ä‘á»ƒ upload file lÃªn server thÃ¬ cÃ³ thá»ƒ sá»­ dá»¥ng `Brettle.Web.NeatUpload.UploadHttpModule.Init (HttpApplication)`, lÃ  phÆ°Æ¡ng thá»©c khá»Ÿi táº¡o cho `System.Web.IHttpModule`

![image.png](https://images.viblo.asia/44afe287-858d-4acb-b321-1c4230daa2df.png)

Sau khi kiá»ƒm tra file `Web.config` thÃ¬ cÃ³ thá»ƒ tháº¥y ráº±ng `UploadHttpModule` Ä‘Æ°á»£c náº¡p trá»±c tiáº¿p vÃ o danh sÃ¡ch Module trong webapp

![image.png](https://images.viblo.asia/85f5bc14-68c7-4c01-8a6a-c4f012ecf5fa.png)

Váº­y ta cÃ³ thá»ƒ tÃ¬m Ä‘Æ°á»£c endpoint upload file trá»±c tiáº¿p lÃªn há»‡ thá»‘ng thÃ´ng qua `Application_BeginRequest()`

![image.png](https://images.viblo.asia/651add4c-0e61-40df-83df-2331f43f141c.png)

![image.png](https://images.viblo.asia/40ac6759-83b5-4a2d-a2f8-60a3ab8d37bc.png)

NhÆ° hÃ¬nh trÃªn ta cÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c source sáº½ cÃ³ dáº¡ng
```http
POST /upload.aspx HTTP/1.1
Host: localhost
Content-Length: 0
```

CÃ³ endpoint rá»“i thÃ¬ data truyá»n vÃ o sáº½ lÃ  gÃ¬ bÃ¢y giá» nhá»Ÿ
á» `Brettle.Web.NeatUpload.FilteringWorkerRequest.ParseOfThrow` chÃºng ta cÃ³ 1 Ä‘oáº¡n nhÆ° nÃ y

![image.png](https://images.viblo.asia/3da4c629-1e1b-48f3-94d5-a21263c9b6f2.png)

CÃ³ thá»ƒ tháº¥y Ä‘á»ƒ uploadContext thÃ¬ chÃºng ta cáº§n sá»­ dá»¥ng `Content-Type: multipart/form-data` sá»­ dá»¥ng `bonudary`. VÃ­ dá»¥: 
```http
POST /upload.aspx HTTP/1.1
Host: localhost
Content-Type: multipart/form-data; boundary=xxx
--xxx
<cÃ¡i gÃ¬ Ä‘áº¥y>
--xxx--
```
CÅ©ng váº«n á»Ÿ `Brettle.Web.NeatUpload.FilteringWorkerRequest.ParseOfThrow` ta cÃ³ thá»ƒ tháº¥y GetAttribute name vÃ  filename, sá»­ dá»¥ng `Content-Disposition attachment`

![image.png](https://images.viblo.asia/9380e33f-36f6-45d1-964d-3ed0e09d1766.png)

Váº­y request sáº½ lÃ : 
```http
POST /upload.aspx HTTP/1.1
Host: localhost
Content-Type: multipart/form-data; boundary=xxx
--xxx
Content-Disposition: form-data; name="name"; filename="filename"
<cÃ¡i gÃ¬ Ä‘áº¥y ná»¯a>
--xxx--
```
Tuy nhiÃªn, váº«n táº¡i Ä‘Ã³, chÃºng ta cáº§n thÃªm nhá»¯ng `paramsFromQueryString` nhÆ° `uploadtool`, `bd`, `accountid` nhÆ°ng sau nhá»¯ng láº§n test cá»§a mÃ¬nh thÃ¬ chÃºng ta chá»‰ cáº§n thÃªm 2 param `bp` vá»›i `accountid` mÃ  thÃ´i
![image.png](https://images.viblo.asia/a88e4739-eaf8-4eb7-8c46-45ba480e643f.png)

Máº·t khÃ¡c, chÃºng ta cÃ³ má»™t dÃ²ng 
```cs
bool flag1 = fieldNameTranslator.PostBackID.Contains("rsu");
```
á» Ä‘Ã¢y chÃºng ta cáº§n pháº£i chÃ¨n thÃªm giÃ¡ trá»‹ `PostBackID`, sau má»™t há»“i debug thÃ¬ hoÃ¡ ra lÃ  nÃ³ náº±m trong config cá»§a webapp, láº§n mÃ² 1 há»“i thÃ¬ cÅ©ng Ä‘áº¿n Ä‘Æ°á»£c chá»— cáº§n tÃ¬m `Brettle.Web.NeatUpload.FieldNameTranslator`

![image.png](https://images.viblo.asia/0b5dae68-59f4-4492-a74e-6a97b46e8ae4.png)

Cuá»‘i cÃ¹ng sau má»™t há»“i debug, thÃ¬ request cuá»‘i cÃ¹ng cÃ³ láº½ sáº½ lÃ  nhÆ° nÃ y: 
```http
POST /upload.aspx?id=foo&bp=bp&accountId=accountid HTTP/1.1
Host: localhost
Content-Type: multipart/form-data; boundary=xxx
--xxx
Content-Disposition: form-data; name="name"; filename="filename"

<cÃ¡i gÃ¬ Ä‘áº¥y ná»¯a>
--xxx--
```

Post thá»­ request lÃªn rá»“i check pháº§n sink xem sao

![image.png](https://images.viblo.asia/e6358a1d-8488-417a-841e-745f93811b4a.png)

CÃ³ thá»ƒ tháº¥y ráº±ng pháº§n `PostBackID` hiá»‡n táº¡i váº«n Ä‘ang lÃ  `null`, cÃ³ váº» nhÆ° mÃ¬nh váº«n chÆ°a truyá»n Ä‘Æ°á»£c param `id=foo`. Sau má»™t há»“i debug, thÃ¬ hoÃ¡ ra do cÃ¡i Ä‘oáº¡n nÃ y, mÃ¬nh váº«n chÆ°a Ä‘á»c ká»¹ xem táº¡i sao pháº£i truyá»n sá»‘ byte > 4096 bytes ná»¯a thÃ¬ nÃ³ má»›i Äƒn, cá»© Ä‘oÃ¡n váº­y thÃ´i.

![image.png](https://images.viblo.asia/c61af592-9ad2-414a-848d-d0c72e802e49.png)

Sau khi truyá»n Ä‘Æ°á»£c `PostBackID` vÃ o `FileStream` rá»“i thÃ¬ cÃ³ thá»ƒ tháº¥y ráº±ng file `foo` Ä‘Ã£ Ä‘Æ°á»£c ghi vÃ o trong folder `C:\inetpub\wwwroot\Citrix\StorageCenter\context` vá»›i ná»™i dung nhÆ° hÃ¬nh dÆ°á»›i.

![image.png](https://images.viblo.asia/f2d72e3b-f0d8-4235-a72c-3a9c22d0b7ca.png)

Váº­y lÃ m tháº¿ nÃ o Ä‘á»ƒ RCE bÃ¢y giá» ğŸ¤”  
á» Ä‘oáº¡n code
```C
FileStream fileStream = new FileStream(str + this.PostBackID, FileMode.Create, FileAccess.ReadWrite, FileShare.None);
```
CÃ³ thá»ƒ tháº¥y ráº±ng, path Ä‘Æ°á»£c ghÃ©p bá»Ÿi `str=C:\inetpub\wwwroot\Citrix\StorageCenter\context` + `PostBackID`. Biáº¿n `PostBackID` thÃ¬ cÃ³ thá»ƒ control Ä‘Æ°á»£c, váº­y thá»­ path travesal xem sao :D 

```http
POST /upload.aspx?id=../foo&bp=bp&accountId=123 HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.81 Safari/537.36 Edg/94.0.992.47
Accept-Encoding: gzip, deflate
Accept: */*
Connection: close
Content-Length: 4240
Content-Type: multipart/form-data; boundary=b74bf37b7d0548a0280c058e21597abd

--b74bf37b7d0548a0280c058e21597abd
Content-Disposition: form-data; name="name"; filename="filename"

<4096 chá»¯ A á»Ÿ Ä‘Ã¢y nhÃ©>
--b74bf37b7d0548a0280c058e21597abd--

```

![image.png](https://images.viblo.asia/193044a8-79f7-4ef3-a21e-ba645f64268d.png)

VÃ  ta nháº­n Ä‘Æ°á»£c file `foo` Ä‘Ã£ nháº£y ra bÃªn ngoÃ i folder `content` vá»›i ná»™i dung nhÆ° trÃªn hÃ¬nh.

á»œ thÃ¬ giá» path travesal Ä‘Æ°á»£c rá»“i thÃ¬ lÃ m sao nhá»Ÿ, sau Ä‘á»c bÃ i cá»§a code white, há» Ä‘Ã£ cÃ³ gá»£i Ã½ cho mÃ¬nh lÃ  sá»­ dá»¥ng ghi Ä‘Ã¨ lÃªn file template cá»§a mÃ´ hÃ¬nh MVC `.cshtml` Ä‘á»ƒ cÃ³ thá»ƒ kÃ­ch hoáº¡t lÃªn shell
```http
POST /upload.aspx?id=..%2FConfigService%2FViews%2FShared%2FError.cshtml&bp=bp&accountId=123z HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.81 Safari/537.36 Edg/94.0.992.47
Accept-Encoding: gzip, deflate
Accept: */*
Connection: close
Content-Length: 4240
Content-Type: multipart/form-data; boundary=4b6955d42c8c6d258f047410fbb3fc12

--4b6955d42c8c6d258f047410fbb3fc12
Content-Disposition: form-data; name="name"; filename="filename"

<4096 chá»¯ A á»Ÿ Ä‘Ã¢y nhÃ©>
--4b6955d42c8c6d258f047410fbb3fc12--

```
![image.png](https://images.viblo.asia/0a7b51b5-25c8-4727-bd86-149d0caa5f63.png)

Ngon roÃ i, váº­y giá» mÃ¬nh cÃ³ thá»ƒ ghi Ä‘Ã¨ lÃªn file `Error.cshtml`, tuy nhiÃªn giá» data mÃ¬nh truyá»n vÃ o duy nháº¥t lÃ  biáº¿n `id` mÃ  thÃ´i, sau má»™t há»“i Ä‘á»c gá»£i Ã½ cá»§a code white mÃ  mÃ¬nh mÆ¡ mÆ¡ mÃ ng mÃ ng cháº³ng hiá»ƒu gÃ¬ cáº£. NhÆ°ng mÃ  sau váº«n lÄ©nh há»™i Ä‘Æ°á»£c ğŸ˜

### Táº¡o payload
Giáº£i thÃ­ch tháº¿ nÃ y má»™t chÃºt cho dá»… hiá»ƒu, trÃªn Linux vÃ  Windows, viá»‡c chuáº©n hoÃ¡ PATH lÃ  khÃ¡c nhau. VÃ­ dá»¥: 
- Linux: `cd a/b/c/`  thÃ¬ Linux sáº½ kiá»ƒm tra path `a`, path `a/b`, path `a/b/c` cÃ³ tá»“n táº¡i hay khÃ´ng, náº¿u cÃ³ thÃ¬ thá»±c hiá»‡n lá»‡nh thÃ nh cÃ´ng.
- Windows: `cd a/b/c` thÃ¬ Windows sáº½ thá»±c hiá»‡n chuáº©n hoÃ¡ path `a/b/c` xem cÃ³ tá»“n táº¡i hay khÃ´ng, náº¿u cÃ³ thÃ¬ thá»±c hiá»‡n lá»‡nh thÃ nh cÃ´ng.

Váº­y báº¡n thá»­ `cd aaa/../a/b/c` trÃªn Linux vÃ  Windows xem, trÃªn Windows thÃ¬ cháº¡y Ä‘Æ°á»£c lá»‡nh nÃ y cÃ²n Linux bÃ¡o k cÃ³ directory nÃ o tá»“n táº¡i ngay ğŸ˜‚. VÃ¬ Linux nÃ³ sáº½ kiá»ƒm tra folder `aaa/` cÃ³ tá»“n táº¡i khÃ´ng Ä‘Ã£, rá»“i nÃ³ má»›i cháº¡y tiáº¿p, náº¿u k tá»“n táº¡i thÃ¬ thÃ´i, Windows láº¡i khÃ¡c, `aaa/.../a/b/c => a/b/c` cÃ³ tá»“n táº¡i thÃ¬ cháº¡y Ä‘Æ°á»£c bÃ¬nh thÆ°á»ng.

BÃ¢y giá» chÃºng ta cáº§n viáº¿t ra 1 cÃ¡i template file `.cshtml` Ä‘á»ƒ cÃ³ thá»ƒ cháº¡y shell trÃªn nÃ y, khÃ´ng Ä‘Æ°á»£c chá»©a cÃ¡c kÃ½ tá»± 
```C
< (less than)
> (greater than)
: (colon)
" (double quote)
/ (forward slash)
\ (backslash)
| (vertical bar or pipe)
? (question mark)
* (asterisk)
```
> Theo https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file#naming-conventions

MÃ¬nh cÃ³ viáº¿t 1 mÃ£ PoC á»Ÿ Ä‘Ã¢y, cÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o qua nhÃ© :D  
https://github.com/sun-asterisk-research/cybersec-pocs/tree/master/citrix_sharefile

# Tham kháº£o
- https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file#naming-conventions
- https://codewhitesec.blogspot.com/2021/09/citrix-sharefile-rce-cve-2021-22941.html
- https://github.com/hoavt184/CVE-2021-22941