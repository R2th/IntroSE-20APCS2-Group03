ThÃ´ng thÆ°á»ng trÃªn cÃ¡c box chat cá»§a cÃ¡c há»™i nhÃ³m á»Ÿ trÃªn Chatwork, ngÆ°á»i ta thÆ°á»ng Ä‘Æ°a ra cÃ¡c thÃ´ng bÃ¡o tá»›i toÃ n bá»™ thÃ nh viÃªn báº±ng viá»‡c gá»­i tin nháº¯n toall. Tuy nhiÃªn thÃ´ng bÃ¡o toall cÅ©ng chá»‰ lÃ  má»™t tin nháº¯n, vÃ  nÃ³ cÃ³ thá»ƒ trÃ´i Ä‘i xa tÃ­t táº¯p náº¿u cÃ¡i box Ä‘Ã³ ngÆ°á»i ta chÃ©m giÃ³ nhiá»u (Ä‘iá»ƒn hÃ¬nh lÃ  box Group vÃ  box CLB cá»§a mÃ¬nh). Váº¥n náº¡n xáº£y ra lÃ  nhá»¯ng ngÆ°á»i báº­n sáº¥p máº·t Ã­t cÃ³ thá»ƒ lÃªn box thÃ¬ ráº¥t dá»… bá»‹ miss thÃ´ng bÃ¡o vÃ¬ lÆ°á»£ng tin nháº¯n spam pháº£i lá»™i qua quÃ¡ nhiá»u, Ä‘Ã´i khi tráº£i qua 1 ngÃ y lÃ  cÃ¡i box CLB mÃ¬nh cÃ³ thá»ƒ lÃªn tá»›i 500 cÃ¡i tin nháº¯n ğŸ¤¦â€


-----


CÃ³ má»™t solution Ä‘Æ°á»£c thá»±c hiá»‡n bÃªn box Group cá»§a mÃ¬nh nhÆ° sau: 
Má»i ngÆ°á»i láº­p 1 box khÃ¡c gá»i lÃ  box "Breaking News" vÃ  box nÃ y chá»‰ chuyÃªn Ä‘Äƒng thÃ´ng bÃ¡o, cÃ²n box kia lÃ  Ä‘á»ƒ chÃ©m giÃ³. OK phÆ°Æ¡ng phÃ¡p nÃ y nghe chá»«ng cÃ³ váº» á»•n vÃ  hiá»‡n váº«n Ä‘ang thá»±c thi ráº¥t á»•n á»Ÿ Group mÃ¬nh.

Tuy nhiÃªn khi mÃ¬nh Ã¡p dá»¥ng phÆ°Æ¡ng thá»©c nÃ y á»Ÿ box CLB thÃ¬ cÃ³ má»™t váº¥n Ä‘á» xáº£y ra Ä‘Ã³ lÃ  viá»‡c giá»›i háº¡n box cá»§a Chatwork. NgÃ y xÆ°a cÃ³ váº» dá»… dÃ£i hÆ¡n khi cho phÃ©p ngÆ°á»i dÃ¹ng cÃ³ tá»‘i Ä‘a 14 box, ta chá»‰ cáº§n Ä‘Æ¡n giáº£n lÃ  out 1 box nÃ o Ä‘Ã³ lÃ  cÃ³ thá»ƒ join 1 box má»›i ğŸ‘. 

NhÆ°ng giá» thÃ¬ mÆ¡ Ä‘i, vá»›i giá»›i háº¡n chá»‰ Ä‘Æ°á»£c phÃ©p join box 14 láº§n, ráº¥t nhiá»u tÃ i khoáº£n hiá»‡n nay Ä‘Ã£ bá»‹ limit box vÃ  muá»‘n thá»±c hiá»‡n giáº£i phÃ¡p trÃªn báº¯t buá»™c pháº£i up lÃªn premium Ä‘á»ƒ cÃ³ thá»ƒ join vÃ o box má»›i. 
VÃ  táº¥t nhiÃªn lÃ  vá»›i táº§m vÃ³c nhá» bÃ© cá»§a má»™t CLB, khÃ´ng mang láº¡i lá»£i nhuáº­n cho cÃ´ng ty, thÃ¬ cÅ©ng cháº³ng thá»ƒ Ä‘Ã²i há»i viá»‡c cÃ´ng ty cáº§n pháº£i cáº¥p premium cho táº¥t cáº£ thÃ nh viÃªn.


-----


Do Ä‘Ã³ mÃ¬nh má»›i thá»±c hiá»‡n má»™t solution khÃ¡c cho CLB cá»§a mÃ¬nh, Ä‘Ã³ lÃ  má»—i khi gá»­i 1 tin nháº¯n thÃ´ng bÃ¡o toall tá»›i box, mÃ¬nh sáº½ tá»± Ä‘á»™ng gá»­i tin nháº¯n Ä‘Ã³ tá»›i riÃªng tá»«ng thÃ nh viÃªn. NhÆ° váº­y nÆ¡i chÃ©m giÃ³ váº«n á»Ÿ trÃªn box chung, cÃ²n nÆ¡i tÃ¬m láº¡i tin nháº¯n thÃ´ng bÃ¡o cho nhá»¯ng thÃ nh viÃªn báº­n rá»™n khÃ´ng cÃ³ thá»i gian hÃ³ng chÃ­nh lÃ  box chat riÃªng vá»›i mÃ¬nh. CÃ³ váº» khÃ¡ lÃ  hiá»‡u quáº£ Ä‘áº¥y. Äá»ƒ thá»±c hiá»‡n viá»‡c nÃ y mÃ¬nh chá»‰ cáº§n hai Ä‘iá»u kiá»‡n sau:
- Chatwork cá»§a mÃ¬nh pháº£i káº¿t báº¡n vá»›i táº¥t cáº£ cÃ¡c thÃ nh viÃªn.
- MÃ¬nh pháº£i code tÃ­nh nÄƒng tá»± Ä‘á»™ng cho nÃ³.


-----


OK luyÃªn thuyÃªn Ä‘á»§ rá»“i, chÃºng ta báº¯t Ä‘áº§u vÃ o thá»±c hiá»‡n nhÃ©.
# Input
- Má»™t tÃ i khoáº£n chatwork náº±m á»Ÿ trong chatbox CLB, vÃ  káº¿t báº¡n vá»›i táº¥t cáº£ thÃ nh viÃªn.
- CÃ¡c cÃ´ng cá»¥ Ä‘á»ƒ lÃ m viá»‡c vá»›i má»™t project ReactJS (mÃ¬nh quen xÃ i React, cÃ¡c bÃ¡c cÃ³ dÃ¹ng code front-end nÃ o khÃ¡c thÃ¬ triá»ƒn khai tÆ°Æ¡ng tá»±).
- Má»™t tÃ i khoáº£n Firebase (cÃ¡i nÃ y má»¥c Ä‘Ã­ch lÃ  Ä‘á»ƒ xÃ i cÃ¡i hosting vÃ  domain free cá»§a Firebase, code xong mÃ¬nh deploy lÃªn Ä‘áº¥y Ä‘á»ƒ dÃ¹ng, cÃ¡c bÃ¡c cÃ³ thá»ƒ xÃ i domain vÃ  hosting riÃªng vÃ  triá»ƒn khai tÆ°Æ¡ng tá»±)

# Output
- Má»™t trang web vá»›i giao diá»‡n cÃ³ thá»ƒ nháº­p tin nháº¯n vÃ o vÃ  áº¥n nÃºt má»™t cÃ¡i sáº½ gá»­i tin nháº¯n tá»›i box vÃ  toÃ n bá»™ thÃ nh viÃªn.

# Thá»±c hiá»‡n
## Setup
- Láº¥y Chatwork API Token: https://www.chatwork.com/service/packages/chatwork/subpackages/api/token.php
> ChÃº Ã½ náº¿u tÃ i khoáº£n cá»§a báº¡n lÃ  tÃ i khoáº£n thuá»™c cÃ´ng ty thÃ¬ sáº½ cáº§n pháº£i request vá»›i cÃ´ng ty, cÃ²n náº¿u khÃ´ng request Ä‘Æ°á»£c thÃ¬ tá»‘t nháº¥t lÃ  táº¡o luÃ´n 1 account má»›i mÃ  dÃ¹ng.
- Táº¡o project ReactJS, mÃ¬nh Ä‘áº·t tÃªn lÃ  `demo-chat-tool`: 
```
$ create-react-app demo-chat-tool
```

- ThÃªm thÆ° viá»‡n `axios` Ä‘á»ƒ lÃ m viá»‡c vá»›i http-request

```
$ yarn add axios
```

Sau Ä‘Ã³ má»Ÿ project lÃªn báº±ng editor yÃªu thÃ­ch cá»§a báº¡n lÃªn vÃ  báº¯t Ä‘áº§u code thÃ´i.

## Code
Äáº§u tiÃªn lÃ  má»™t chÃºt UI, á»Ÿ Ä‘Ã¢y gá»“m 2 pháº§n tá»­:
- 1 textarea Ä‘á»ƒ nháº­p tin nháº¯n
- 1 button Ä‘á»ƒ báº¥m gá»­i message

`App.js`
```
import React, { Component } from 'react';
import './App.css';

class App extends Component {
  state = {
    message: "",
  }
  
  sendMessage = () => {
      // TODO: Handle send message here
  }

  onTextAreaChange = (event) => {
    this.setState({ message: event.target.value })
  }

  render() {
    return (
      <div className="container">
        <textarea
          className="text-area"
          onChange={this.onTextAreaChange}
          placeholder="Nháº­p tin nháº¯n vÃ o Ä‘Ã¢y..."
          value={this.state.message}
        />
        <button className="button" onClick={this.sendMessage}>Send Message</button>
      </div>
    );
  }
}

export default App;
```
`App.css`
```
.container {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  height: 100vh;
}

.text-area {
  flex: 1;
}

.button {
  height: 50px;
}
```
Tiáº¿p theo lÃ  triá»ƒn khai API services:
- TÃ i liá»‡u: http://developer.chatwork.com/vi/index.html
- á» Ä‘Ã¢y mÃ¬nh chá»‰ triá»ƒn khai 3 API bao gá»“m:
    - Láº¥y list contact cá»§a báº£n thÃ¢n
    - Láº¥y danh sÃ¡ch member trong má»™t room
    - Gá»­i tin nháº¯n.

`services/apis/index.js`
```
export default {
  getContacts: () => ({
    method: 'get',
    url: '/contacts'
  }),
  getMembers: (roomId) => ({
    method: 'get',
    url: `/rooms/${roomId}/members`
  }),
  addMessages: (roomId, message) => ({
    method: 'post',
    url: `/rooms/${roomId}/messages`,
    data: `body=${message}`
  }),
}
```

`services/index.js`
```
import axios from 'axios';
import API from './apis';

const BASE_URL = 'https://api.chatwork.com/v2';
const CHATWORK_TOKEN = 'YOUR_CHATWORK_TOKEN';

const baseAxios = axios.create({
  baseURL: BASE_URL,
  headers: {
    'X-ChatWorkToken': CHATWORK_TOKEN,
  },
  validateStatus: status => status >= 200 && status < 500
});

const request = async (api) => {
  const response = await baseAxios.request(api);
  const { data, status } = response
  if (status && status === 200) {
    return data;
  }
  throw new Error(JSON.stringify(data.errors) || 'Response Format Error');
}

export default {
  getContacts: () => request(API.getContacts()),
  getMembers: (roomId) => request(API.getMembers(roomId)),
  addMessages: (roomId, message) => request(API.addMessages(roomId, message))
}
```
Cuá»‘i cÃ¹ng lÃ  gáº¯n API vÃ o vá»›i UI:

- Define má»™t vÃ i constants cáº§n thiáº¿t:

`App.js`
```
// ...
import Service from './services';

const GROUP_CHATROOM_ID = 0; // TODO: Nháº­p chatroom ID cá»§a nhÃ³m chat cá»§a báº¡n.
const IGNORE_ACCOUNT_IDS = []; // TODO: Nháº­p cÃ¡c account mÃ  báº¡n muá»‘n bá» qua khÃ´ng gá»­i tin nháº¯n, cÃ³ thá»ƒ lÃ  ID cá»§a chÃ­nh báº¡n cháº³ng háº¡n

class App extends Component {
// ...
```
- Viáº¿t hÃ m gá»i API vÃ  xá»­ lÃ½ logic:

`App.js`
```
// ...
class App extends Component {
  // ...
}

const fetchMemberRoomIds = async () => {
  // Láº¥y contacts
  const contacts = await Service.getContacts();
  const contactIds = contacts
    .map(contact => ({ accountId: contact.account_id, roomId: contact.room_id }))

  // Láº¥y members
  const members = await Service.getMembers(GROUP_CHATROOM_ID)
  const memberIds = members
    .map(member => member.account_id)
    .filter((memberId) => !IGNORE_ACCOUNT_IDS.includes(memberId) )

  // Lá»c káº¿t quáº£ vÃ  map vá» máº£ng roomId
  return contactIds
    .filter(contactId => memberIds.includes(contactId.accountId))
    .map(contactId => contactId.roomId)
}

export default App;
```
- Viáº¿t hÃ m gá»­i message:

`App.js`
```
class App extends Component {
  // ...
  
  sendMessage = async () => {
    if (this.state.message === "") {
      alert('Nháº­p tin nháº¯n vÃ o Ä‘Ã£!');
      return
    }
    const roomIds = await fetchMemberRoomIds();
    roomIds.push(GROUP_CHATROOM_ID)
    await Promise.all(roomIds.map(id => Service.addMessages(id, this.state.message)))
  }
  
  // ...
}
```

## Deploy
### Táº¡o firebase project
- Truy cáº­p https://console.firebase.google.com vÃ  tá»± táº¡o cho mÃ¬nh má»™t project trÃªn Ä‘Ã³:
![](https://images.viblo.asia/704e5990-06b1-465f-890e-3d4418c73dc4.png)
- VÃ o project, má»Ÿ pháº§n Hosting ra coi, báº¥m Get started vÃ  lÃ m theo hÆ°á»›ng dáº«n:
![](https://images.viblo.asia/8fff7d18-cb3a-474b-a39c-b497ab35ddf4.png)

- Äáº¡i thá»ƒ thÃ¬ ta sáº½ cáº§n pháº£i cÃ i firebase-tools Ä‘á»ƒ xÃ i
```
$ yarn global add firebase-tools
```
- Sau khi cÃ³ tool, viá»‡c tiáº¿p theo lÃ  login vÃ o firebase báº±ng lá»‡nh:
```
$ firebase login
```
- Login xong thÃ¬ giá» táº¡o má»™t cÃ¡i thÆ° má»¥c vÃ  vÃ o Ä‘Ã³ init má»™t cÃ¡i firebase project:
```
$ firebase init
```
- á» má»¥c Ä‘áº§u tiÃªn cáº§n Ä‘i qua ta chá»n Hosting
![](https://images.viblo.asia/0d41b061-f165-46f3-a79d-babb1edb7f9c.png)

- Tiáº¿p theo:
![](https://images.viblo.asia/6cc566fe-1c61-4f4b-805d-97d61181fd84.png)

- Tiáº¿p theo:
![](https://images.viblo.asia/36b3fe2b-9a0b-4fcb-ba55-20417f8f29e6.png)

- Tiáº¿p theo:
![](https://images.viblo.asia/77960147-e6b3-47cf-a3e1-cc62e219cd2f.png)

- Cuá»‘i cÃ¹ng tháº¥y cÃ¡i Ä‘á»‘ng nÃ y lÃ  ta Ä‘Ã£ init xong cÃ¡i firebase:
![](https://images.viblo.asia/3c029b65-1dec-4677-ad8c-1cddd41c97f6.png)

### Build web app
- Quay vá» thÆ° má»¥c ReactJS project vÃ  cháº¡y
```
$ yarn build
```
- Sau Ä‘Ã³ copy cÃ¡i Ä‘á»‘ng build ra trong thÆ° má»¥c build vÃ  dÃ¡n Ä‘Ã¨ vÃ o thÆ° má»¥c public trong firebase project vá»«a táº¡o.

### Chá»‘t háº¡
- Quay vá» thÆ° má»¥c firebase project vÃ  cháº¡y:
```
$ firebase deploy --project <ProjectID cá»§a báº¡n>
```
- Äá»£i xong xuÃ´i vÃ  táº­n hÆ°á»Ÿng thÃ nh quáº£ thÃ´i.

# Káº¿t
Má»i thá»© trong bÃ i viáº¿t nÃ y tá»« code Ä‘áº¿n setup, config Ä‘á»u á»Ÿ má»©c cÆ¡ báº£n vÃ  tinh giáº£n nháº¥t, báº¡n nÃªn tá»± má»Ÿ rá»™ng, cáº¥u trÃºc project vÃ  cÃ³ cÃ¡c config phÃ¹ há»£p vÃ  chuyÃªn nghiá»‡p hÆ¡n cho project cá»§a mÃ¬nh. Hy vá»ng bÃ i viáº¿t Ä‘em láº¡i nhá»¯ng Ä‘iá»u bá»• Ã­ch cho báº¡n Ä‘á»c.