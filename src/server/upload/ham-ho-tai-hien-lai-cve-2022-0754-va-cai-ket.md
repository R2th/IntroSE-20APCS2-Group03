# Intro

V√†o m·ªôt ng√†y ƒë·∫πp tr·ªùi, trong l√∫c l∆∞·ªõt qua danh s√°ch tweets th√¨ m√¨nh b·∫Øt g·∫∑p c√°i n√†y:

![image.png](https://images.viblo.asia/1d6a874c-edbe-4241-b31b-af9421c71c04.png)

·ªí, m·ªôt l·ªói SQLi v·ªõi s·ªë ƒëi·ªÉm r·∫•t cao, target l√†: https://github.com/salesagility/SuiteCRM v·ªõi g·∫ßn 2.9k star tr√™n Github:

> SuiteCRM is the award-winning open-source, enterprise-ready Customer Relationship Management (CRM) software application.

ch·∫Øc l√† c√≥ g√¨ hay ho ƒë√¢y, v·∫≠y l√† m√¨nh b·∫Øt tay v√†o th·ª≠ t√¨m c√°ch t√°i hi·ªán.

# CVE Details
Tr∆∞·ªõc h·∫øt l√† t√¨m th√¥ng tin v·ªÅ l·ªói n√†y th√¨ c√≥ ngay k·∫øt qu·∫£ ·ªü: https://huntr.dev/bounties/8afb7991-c6ed-42d9-bd9b-1cc83418df88/

> In SuiteCRM v7.12.4, a malicious user can inject SQL query in order to affect the execution of predefined SQL commands impacting database leakage.

M·ªôt ch√∫t v·ªÅ huntr.dev, ƒë√¢y l√† platform bug bounty nh∆∞ng d√†nh ri√™ng cho c√°c repo open source, c√°c researcher c≈©ng s·∫Ω t√¨m c√°c l·ªó h·ªïng, submit v√† ƒë∆∞·ª£c maintainer c·ªßa repo triage v√† th∆∞·ªüng c√°c **fix bounty** cho reporter. ƒê·ªìng th·ªùi huntr.dev c≈©ng s·∫Ω l√† b√™n ƒë√°nh CVE cho l·ªói lu√¥n. L·ªói n√†y ƒë∆∞·ª£c ƒë√°nh l√† **CVE-2022-0754**.

>  We fund open source security. We pay security researchers for finding vulnerabilities in any GitHub repository and maintainers for fixing them.
> 
> **huntr.dev**

ƒê·ªçc qua report th√¨ c≈©ng kh√¥ng th·∫•y reporter ƒë√≠nh k√®m PoC, ta ch·ªâ bi·∫øt l√† payload truy·ªÅn v√†o ·ªü `$_POST['record']`.

# Setup
ƒê·ªÉ setup debug th√¨ m·ªôt trong nh·ªØng l·ª±a ch·ªçn m√¨ ƒÉn li·ªÅn v√† ƒë·ª° t·ªën c√¥ng nh·∫•t ƒë·∫•y ch√≠nh l√† s·ª≠ d·ª•ng docker. R·∫•t may m·∫Øn l√† SuiteCRM ƒë∆∞·ª£c bitnami ƒë√≥ng g√≥i th√†nh docker s·∫µn s√†ng, n√™n v·ªõi file `docker-compose.yml` d∆∞·ªõi ƒë√¢y, m√¨nh ƒë√£ nhanh ch√≥ng c√≥ m√¥i tr∆∞·ªùng ƒë·ªÉ debug. ·ªû ƒë√¢y m√¨nh ch·ªçn docker tag l√† `7.12.4`, l√† phi√™n b·∫£n tr∆∞·ªõc khi fix l·ªói.

```docker-compose.yaml
version: '2'
services:
  mariadb:
    image: docker.io/bitnami/mariadb:10.3
    environment:
      # ALLOW_EMPTY_PASSWORD is recommended only for development.
      - ALLOW_EMPTY_PASSWORD=yes
      - MARIADB_USER=bn_suitecrm
      - MARIADB_DATABASE=bitnami_suitecrm
    volumes:
      - 'mariadb_data:/bitnami/mariadb'
  suitecrm:
    image: docker.io/bitnami/suitecrm:7.12.4-debian-10-r17
    ports:
      - '8880:8080'
      - '8443:8443'
    environment:
      - SUITECRM_DATABASE_HOST=mariadb
      - SUITECRM_DATABASE_PORT_NUMBER=3306
      - SUITECRM_DATABASE_USER=bn_suitecrm
      - SUITECRM_DATABASE_NAME=bitnami_suitecrm
      # ALLOW_EMPTY_PASSWORD is recommended only for development.
      - ALLOW_EMPTY_PASSWORD=yes
    volumes:
      - 'suitecrm_data:/bitnami/suitecrm'
    depends_on:
      - mariadb
volumes:
  mariadb_data:
    driver: local
  suitecrm_data:
    driver: local
```

Ch·∫°y `docker-compose up`:

![image.png](https://images.viblo.asia/c3b72c36-9db3-423b-b616-8bb43a06fd2b.png)

 v√† truy c·∫≠p v√†o: https://localhost:8443/index.php l√† ƒë√£ hi·ªán l√™n giao di·ªán login r·ªìi:

![image.png](https://images.viblo.asia/036e0d2f-5665-479a-a179-f08470c6796f.png)

Login b·∫±ng account `user:bitnami`. Source code ·ªü `/bitnami/suitecrm`.

## Debug

ƒê·ªÉ debug code PHP th√¨ c√≥ 2 c√°ch:

1. hi·ªán ƒë·∫°i chuy√™n nghi·ªáp d√πng X-Debug v√† ƒë·∫∑t break point.
2. Th·ªß c√¥ng old-school b·∫±ng ƒë·∫∑t console log, `var_dump`, `die`,...

M√¨nh ch·ªçn c√°ch 2 cho n√≥...nhanh. V·∫≠y l√†m sao ƒë·ªÉ c√≥ th·ªÉ debug trong docker, ƒë·ªìng th·ªùi l√† c√≥ th·ªÉ search source code lu√¥n t·ª´ trong docker, thay v√¨ d√πng grep ho·∫∑c ph·∫£i clone l·∫°i? VSCode g·∫ßn ƒë√¢y ƒë√£ c√≥ h·ªó tr·ª£ extension **Remote - Containers** (hi·ªán ƒëang l√† b·∫£n Preview), cho ph√©p ch√∫ng ta c√†i ƒë·∫∑t m·ªôt VSCode server v√† t·ª´ ƒë√≥ remote access v√†o trong docker, ch·ªânh s·ª≠a file, source code d·ªÖ d√†ng h∆°n r·∫•t nhi·ªÅu (t∆∞∆°ng t·ª± nh∆∞ remote v√†o WSL t·ª´ Windows ho·∫∑c remote SSH l√™n server v·∫≠y). 

![image.png](https://images.viblo.asia/2bd6b4bb-56ed-432a-ad54-041a33a9ecbe.png)

C√†i ƒë·∫∑t: t·ª´ https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers v√† ch·ªçn "Attach to Running Container..." v√† th·∫ø l√† *"I'm in"* :detective: 

![image.png](https://images.viblo.asia/e8b80d58-71b1-4002-953f-b30e4e129ff2.png)

# Vulnerable Code

![](https://images.viblo.asia/89539bc2-12c7-4746-a075-72c3f0725b8e.png)

OK, c√πng xem l·∫°i ƒëo·∫°n code l·ªói, ƒë√∫ng l√† ·ªü d√≤ng 62, input c·ªßa ng∆∞·ªùi d√πng ƒë∆∞·ª£c truy·ªÅn th·∫≥ng v√†o c√¢u truy v·∫•n, nh∆∞ nh·ªØng g√¨ report m√¥ t·∫£.

# Analysis

## How to call a function?

Sau khi ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n admin  `user:bitnami`, m√¨nh nh·∫≠n th·∫•y t·∫•t c·∫£ ch·ª©c nƒÉng ƒë·ªÅu g·ªçi th√¥ng qua file `index.php` truy·ªÅn v√†o tham s·ªë `module` v√† `action`
VD: URL sau khi login l√†: https://localhost:8443/index.php?module=Home&action=index

Do ƒë√≥, v·ªõi l·ªói n·∫±m ·ªü ƒë∆∞·ªùng d·∫´n: `modules/ProspectLists/Duplicate.php` th√¨ t∆∞∆°ng ·ª©ng URL s·∫Ω l√†

```
&module=ProspectLists&action=Duplicate
```

Tr∆∞·ªõc h·∫øt, th·ª≠ v·ªõi action `index` ƒë∆∞a ta ƒë·∫øn v·ªõi ch·ª©c nƒÉng b·ªã l·ªói: https://localhost:8443/index.php?module=ProspectLists&action=index

![image.png](https://images.viblo.asia/7a7d6db6-143c-486c-ad13-be6e37341ffc.png)


## Good Payload

Sau khi t·∫°o th·ª≠ v√†i Target List v√† th·ª±c hi·ªán duplicate th√¨ v·ªõi m·ªôt payload th√¥ng th∆∞·ªùng

```
POST /index.php HTTP/1.1
Host: localhost:8443
Cookie: PHPSESSID=ol7snc52ilfoe5du9r7kr2dulb; sugar_user_theme=SuiteP; ProspectLists_divs=ProspectLists_prospects_v%3Dfalse%23undefined%3D%23
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 67
Origin: https://localhost:8443
Dnt: 1
Referer: https://localhost:8443/index.php
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
X-Pwnfox-Color: green
Te: trailers
Connection: close

module=ProspectLists&record=12121&isDuplicate=true&action=Duplicate
```
th√¨ response l√†:
```
Location: index.php?action=DetailView&module=ProspectLists&record=49ca2900-f0e5-9c46-2b68-622816080bf6
```

so s√°nh v·ªõi n·ªôi dung file `Duplicate.php` ta c√≥ th·ªÉ confirm l√† trigger v√†o ƒë√∫ng file c·∫ßn t√¨m.

## Evil Payload

Th·ª≠ truy·ªÅn v√†o `abc'`  ƒë·ªÉ escape kh·ªèi SQL

```php
$query = "select * from prospect_lists_prospects where prospect_list_id = '".$_POST['record']."'";
```

k·∫øt qu·∫£ payload b·ªã block lu√¥n:

```
HTTP/1.1 200 OK
Date: Wed, 09 Mar 2022 02:56:41 GMT
Server: Apache/2.4.52 (Unix) OpenSSL/1.1.1d PHP/7.4.28
X-Content-Type-Options: nosniff
Content-Length: 65
Connection: close
Content-Type: text/html; charset=UTF-8

Bad data passed in; <a href="http://localhost">Return to Home</a>
```

Why? why? why? Sau m·ªôt ƒë·ªçc code v√† debug m√¨nh c≈©ng t√¨m th·∫•y nguy√™n nh√¢n:

## First Block

T·ª´ error `Bad data passed` ta truy ng∆∞·ª£c ra flow nh∆∞ sau:

Trong file `index.php` c√≥ ƒëo·∫°n:

```php
require_once 'include/entryPoint.php';
```

·ªû file `include/entryPoint.php` :

```php
///////////////////////////////////////////////////////////////////////////////
////	DATA SECURITY MEASURES
require_once 'include/utils.php';
require_once 'include/clean.php';
clean_special_arguments();
clean_incoming_data();
////	END DATA SECURITY MEASURES
///////////////////////////////////////////////////////////////////////////////
```

Ch√∫ √Ω ƒë·∫øn h√†m n√†y `clean_incoming_data` n·∫±m trong file `include/utils.php`

```php
function clean_incoming_data()
{
    global $sugar_config;
    global $RAW_REQUEST;

    $RAW_REQUEST = $_REQUEST;

    $req = array_map('securexss', $_REQUEST);
    $post = array_map('securexss', $_POST);
    $get = array_map('securexss', $_GET);
	...
}
```

T·ª©c l√† t·∫•t c·∫£ c√°c param truy·ªÅn v√†o s·∫Ω b·ªã filter xss th√¥ng qua h√†m `securexss`

```php
function securexss($uncleanString)
{
    if (is_array($uncleanString)) {
        $new = [];
        foreach ($uncleanString as $key => $val) {
            $new[$key] = securexss($val);
        }

        return $new;
    }

    static $xss_cleanup = [
        '&quot;' => '&#38;',
        '"' => '&quot;',
        "'" => '&#039;',
        '<' => '&lt;',
        '>' => '&gt;',
        '`' => '&#96;'
    ];

    $uncleanString = preg_replace(array('/javascript:/i', '/\0/', '/javascript:/i'),
        array('java script:', '', 'java script:'), $uncleanString);

    $partialString = str_replace(array_keys($xss_cleanup), $xss_cleanup, $uncleanString);
    error_log("\npartialString = " . $partialString . "\n", 3, "/tmp/my-errors.log");
    $antiXss = new AntiXSS();
    $antiXss->removeEvilAttributes(['style']);

    return $antiXss->xss_clean($partialString);
}
```

Qua h√†m n√†y th√¨ payload c·ªßa ta s·∫Ω thay ƒë·ªïi

```
abc' -> abc&#039;
```

V·∫´n ·ªü trong h√†m `clean_incoming_data` c√≥ ƒëo·∫°n:

```php
    if (isset($_REQUEST['record'])) {
        clean_string($_REQUEST['record'], 'STANDARDSPACE');
    }
```
ƒêo·∫°n n√†y ƒë∆∞·ª£c th√™m v√†o t·ª´ **6 nƒÉm tr∆∞·ªõc**, nghƒ©a l√† ƒë·ªëi v·ªõi tham s·ªë `record` th√¨ c√≤n b·ªã ƒëi qua m·ªôt b∆∞·ªõc filter n·ªØa:

![image.png](https://images.viblo.asia/1973ebbb-5bdd-48dc-b969-7d1b6a4c142c.png)

Xem ti·∫øp trong h√†m `clean_string`:

```php
function clean_string($str, $filter = 'STANDARD', $dieOnBadData = true)
{
    global $sugar_config;

    $filters = array(
        'STANDARD' => '#[^A-Z0-9\-_\.\@]#i',
        'STANDARDSPACE' => '#[^A-Z0-9\-_\.\@\ ]#i',
        'FILE' => '#[^A-Z0-9\-_\.]#i',
        'NUMBER' => '#[^0-9\-]#i',
        'SQL_COLUMN_LIST' => '#[^A-Z0-9\(\),_\.]#i',
        'PATH_NO_URL' => '#://#i',
        'SAFED_GET' => '#[^A-Z0-9\@\=\&\?\.\/\-_~+]#i', /* range of allowed characters in a GET string */
        'UNIFIED_SEARCH' => '#[\\x00]#', /* cn: bug 3356 & 9236 - MBCS search strings */
        'AUTO_INCREMENT' => '#[^0-9\-,\ ]#i',
        'ALPHANUM' => '#[^A-Z0-9\-]#i',
    );

    if (preg_match($filters[$filter], $str)) {
	    error_log("\n-- clean_string -- \nfilter = " . $filter . "\n data=" . $str . "\n", 3, "/tmp/my-errors.log");
        if (isset($GLOBALS['log']) && is_object($GLOBALS['log'])) {
            $GLOBALS['log']->fatal("SECURITY[$filter]: bad data passed in; string: {$str}");
        }
        if ($dieOnBadData) {
            die("Bad data passed in; <a href=\"{$sugar_config['site_url']}\">Return to Home</a>");
        }

        return false;
    }
    return $str;
}
```

nh∆∞ v·∫≠y `record` s·∫Ω ƒë∆∞·ª£c filter qua regex: `'#[^A-Z0-9\-_\.\@\ ]#i'`
nghƒ©a l√† block h·∫øt c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát tr·ª´ k√Ω t·ª± alphabet, s·ªë v√† `_`, `-`, `.`, `@`, ` `. V·ªõi filter n√†y th√¨ hi·ªán t·∫°i m√¨nh ch∆∞a nghƒ© ra c√°ch n√†o c√≥ th·ªÉ trigger ƒë∆∞·ª£c SQLi c·∫£ :cold_sweat: 

## Another Block

K·ªÉ c·∫£ b·∫±ng 1 c√°ch th·∫ßn k·ª≥ n√†o ƒë√≥, ch√∫ng ta pass qua ƒë∆∞·ª£c c√°c b∆∞·ªõc filter v√† ƒë·∫øn ƒë∆∞·ª£c ƒëo·∫°n:

```php
$focus = BeanFactory::newBean('ProspectLists');

$focus->retrieve($_POST['record']);
```

ti·∫øp t·ª•c flow ·ªü file: `data/BeanFactory.php`

```php
    public static function newBean($module)
    {
        return self::getBean($module);
    }
	
     *   
     * @return SugarBean|bool
     */
    public static function getBean($module, $id = null, $params = [], $deleted = true)
```

T√∫m l·∫°i l√† ƒë∆∞·ª£c extend t·ª´ `SugarBean`

xem ti·∫øp h√†m `retrieve` ·ªü `data/SugarBean.php`

```php
    public function retrieve($id = -1, $encode = true, $deleted = true)
    {
        $custom_logic_arguments['id'] = $id;
        $this->call_custom_logic('before_retrieve', $custom_logic_arguments);

        if ($id == -1) {
            $id = $this->id;
        }
        $custom_join = $this->getCustomJoin();

        $query = "SELECT $this->table_name.*" . $custom_join['select'] . " FROM $this->table_name ";

        $query .= $custom_join['join'];
        $query .= " WHERE $this->table_name.id = " . $this->db->quoted($id);
```

n√™n `$id` truy·ªÅn v√†o ƒë√£ ƒë∆∞·ª£c quote tr∆∞·ªõc khi SELECT. Th√™m m·ªôt th·ª≠ th√°ch kh√≥ khƒÉn n·ªØa.

## Conclusion?

> The `$_POST['record']` [1] parameter is controllable by a user and it is concatenated into SQL query [2] without validating them.

l√† ƒë√∫ng (m·ªôt ph·∫ßn) nh∆∞ng th·ª±c t·∫ø th√¨ kh√¥ng c√≥ c√°ch n√†y ƒë·ªÉ trigger ƒë∆∞·ª£c SQLi c·∫£, l·ªói n√†y c√≥ th·ªÉ coi nh∆∞ l√† kh√¥ng t·ªìn t·∫°i?

Th·∫ø nh∆∞ng dev c·ªßa SuiteCRM v·∫´n confirmed v√† fix bug, khi·∫øn m√¨nh v·∫´n kh√° hoang mang ƒë·∫øn t·∫≠n b√¢y gi·ªù, ko bi·∫øt ph·∫£i l√† bug hay kh√¥ng :sweat_smile:. Th√¥i th√¨ c·∫©n th·∫≠n th√¨ kh√¥ng bao gi·ªù l√† th·ª´a :smile: 

![image.png](https://images.viblo.asia/421c8dcd-0159-43eb-a909-741705fe23a1.png)

# Bonus

ƒê·ªçc code SuiteCRM m√¨nh th·∫•y h·ªá th·ªëng th·ª±c s·ª± ƒë√£ c√≥ kh√° nhi·ªÅu c∆° ch·∫ø ƒë·ªÉ ch·ªëng l·ªói, tuy nhi√™n n·∫øu kh√¥ng ph·∫£i param `record` th√¨ li·ªáu c√≥ c√°ch n√†o trigger SQLi kh√¥ng, th√¨ m√¨nh ƒë√£ t√¨m th·∫•y c√¢u tr·∫£ l·ªùi ·ªü m·ªôt CVE kh√°c: **CVE-2021-45041** (l·∫ßn n√†y th√¨ c√≥ PoC sqlmap ƒë·∫ßy ƒë·ªß lu√¥n, c·ª±c k·ª≥ uy t√≠n :smiley:)

Link PoC: https://github.com/manuelz120/CVE-2021-45041

L·∫ßn n√†y param ƒë√£ kh√°c, `resource_id` n√™n s·∫Ω kh√¥ng c√≤n b·ªã filter `STANDARDSPACE` n·ªØa, s·ªë k√Ω t·ª± kh·∫£ d·ª•ng ƒë√£ tƒÉng l√™n tr√¥ng th·∫•y nh∆∞ng s·ª≠ d·ª•ng single-quote ƒë·ªÉ escape th√¨ v·∫´n l√† b·∫•t kh·∫£ thi (v√¨ HTML-Entity encoding nh∆∞ ·ªü h√†m `securexss` ·ªü tr√™n). Tuy nhi√™n, trong c√¢u truy v·∫•n ch√∫ng ta ƒë∆∞·ª£c ch√®n payload nhi·ªÅu l·∫ßn (multiple injection points) n√™n t√°c gi·∫£ ƒë√£ nghƒ© ƒë·∫øn vi·ªác s·ª≠ d·ª•ng backslash `\`  ·ªü cu·ªëi ƒë·ªÉ bi·∫øn k√≠ t·ª± `'` tr·ªü th√†nh k√≠ t·ª± th∆∞·ªùng trong  c√¢u truy v·∫•n, t·ª´ ƒë√≥ ƒë·ªÉ escape v√† inject ·ªü bi·∫øn `start_date`:

![image.png](https://images.viblo.asia/873d9b6d-7cac-4754-a42a-14a4593a2b15.png)

B√¨nh th∆∞·ªùng c√¢u truy v·∫•n s·∫Ω ki·ªÉu ki·ªÉu nh∆∞ sau:

```sql
SELECT * FROM xxx WHERE (project_task.assigned_user_id = 'AAA' AND ( ( project_task.date_start BETWEEN 'BBB'  AND 'CCC' ) OR ( project_task.date_finish BETWEEN 'BBB' AND 'CCC' ) OR ( 'BBB' BETWEEN project_task.date_start  AND project_task.date_finish ) OR ( 'CCC' BETWEEN project_task.date_start AND project_task.date_finish ) ) AND (project_id is not null AND project_id <> '') ...
```

Nh∆∞ng khi `resource_id` c√≥ gi√° tr·ªã l√† `test\`:

```sql
SELECT * FROM xxx WHERE (project_task.assigned_user_id = 'test\' AND ( ( project_task.date_start BETWEEN ') UNION SELECT 0, 1, 2, 3, 4, (SELECT user_hash from users limit 1), 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43 from dual; #'  AND 'CCC' ) OR ( project_task.date_finish BETWEEN 'BBB' AND 'CCC' ) OR ( 'BBB' BETWEEN project_task.date_start  AND project_task.date_finish ) OR ( 'CCC' BETWEEN project_task.date_start AND project_task.date_finish ) ) AND (project_id is not null AND project_id <> '') ...
```

v·∫≠y l√† escape v√† trigger th√†nh c√¥ng :clap: 

# End 
Ai ƒë√≥ n√≥i r·∫±ng: "Trong cu·ªôc vui ba ng∆∞·ªùi th√¨ s·∫Ω lu√¥n c√≥ m·ªôt ng∆∞·ªùi bu·ªìn..." qu·∫£ l√† kh√¥ng sai...ü•≤