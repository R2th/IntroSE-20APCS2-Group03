Ch√†o m·ª´ng c√°c b·∫°n ƒë√£ quay tr·ªü l·∫°i v·ªõi series [h·ªçc Docker v√† CICD](https://viblo.asia/s/series-hoc-docker-cicd-tu-co-ban-den-ap-dung-vao-thuc-te-jeZ103QgKWz) c·ªßa m√¨nh üëãüëã

·ªû b√†i tr∆∞·ªõc m√¨nh ƒë√£ h∆∞·ªõng d·∫´n c√°c b·∫°n c√°ch [**dockerize** m·ªôt ·ª©ng d·ª•ng NodeJS](https://viblo.asia/p/dockerize-ung-dung-nodejs-RnB5pxEG5PG), ƒë·ªìng th·ªùi c√πng v·ªõi ƒë√≥ l√† m·ªôt s·ªë kh√°i ni·ªám v√† c√¢u h·ªèi li√™n quan trong b√†i.

·ªû b√†i n√†y ch√∫ng ta s·∫Ω ti·∫øp t·ª•c series b·∫±ng c√°ch th·ª±c h√†nh dockerize m·ªôt ·ª©ng d·ª•ng Python Flask nh√©. ;)

"D·ª™NG D·ª™NG D·ª™NG, NEXT, NEXT, chuy·ªÉn b√†i √¥ng ∆°iiiii... T√¥i dev NodeJS PHP ch·ª© c√≥ ph·∫£i Python ƒë√¢u m√† care" :D :D

M·ª•c ƒë√≠ch c·ªßa series n√†y l√† m√¨nh s·∫Ω h∆∞·ªõng d·∫´n c√°c b·∫°n h·ªçc Docker, trong b√†i n√†y m√¨nh nghƒ© c√°c b·∫°n ho√†n to√†n c√≥ th·ªÉ hi·ªÉu ƒë∆∞·ª£c d√π b·∫°n ch∆∞a bao gi·ªù code Python. Do ƒë√≥ m√¨nh hi v·ªçng r·∫±ng c√°c b·∫°n v·∫´n s·∫Ω theo s√°t ƒë∆∞·ª£c series n√†y, t·ª´ng b√†i t·ª´ng b√†i, v√¨ trong m·ªói b√†i s·∫Ω c√≥ nh·ªØng v·∫•n ƒë·ªÅ li√™n quan ƒë·∫øn Docker m√¨nh mu·ªën g·ª≠i t·ªõi c√°c b·∫°n.

B·∫Øt tay v√†o l√†m th√¥i n√†o

# Ti·ªÅn Setup

Nh·ªõ check l√† c√°c b·∫°n ƒë√£ c√†i Docker v√† Docker-compose r·ªìi nh√©. N·∫øu ch∆∞a th√¨ nh·ªõ check l·∫°i [ph·∫ßn cu·ªëi b√†i tr∆∞·ªõc](https://viblo.asia/p/li-do-toi-yeu-docker-ORNZqxRMK0n) c·ªßa m√¨nh ƒë·ªÉ bi·∫øt c√°ch c√†i ƒë·∫∑t nh√©.

# Setup
C√°c b·∫°n clone source code [·ªü ƒë√¢y](https://gitlab.com/maitrungduc1410/learning-docker) v·ªÅ nh√©.

·ªû b√†i n√†y ta s·∫Ω ch·ªâ quan t√¢m t·ªõi folder **docker-python** sau khi clone nh√© ;). ·ªû ƒë√≥ m√¨nh c√≥ setup cho c√°c b·∫°n m·ªôt ·ª©ng d·ª•ng Python d√πng Flask framework nh√© (b·∫°n n√†o dev PHP c√≥ th·ªÉ coi n√≥ nh∆∞ Laravel c·ªßa PHP v·∫≠y ;))

N·∫øu c√°c b·∫°n c√≥ c√†i Python ·ªü m√°y th√¨ c√≥ th·ªÉ ch·∫°y command sau ƒë·ªÉ ch·∫°y project nh√©:
```
pip install -r requirements.txt
python app.py
```
M·ªü tr√¨nh duy·ªát ·ªü ƒë·ªãa ch·ªâ **localhost:5000** v√† c√°c b·∫°n s·∫Ω th·∫•y d√≤ng Hello World

C√≤n n·∫øu m√°y c√°c b·∫°n kh√¥ng c√≥ Python, th√¨ v·∫´n tuy·ªát v·ªùi √¥ s·ªù k√™ nh√©. Ch·ªâ c·∫ßn c√°c b·∫°n ƒë√£ c√†i Docker v√† Docker compose, nh·ªØng th·ª© kh√°c c√≥ hay kh√¥ng c√≥, kh√¥ng quan tr·ªçng :rofl::rofl:

# Build Docker Image
V·∫´n nh∆∞ ·ªü [b√†i tr∆∞·ªõc](https://viblo.asia/p/dockerize-ung-dung-nodejs-RnB5pxEG5PG), ƒë·∫ßu ti√™n ta c·∫ßn t·∫°o file c·∫•u h√¨nh Dockerfile v√† ƒë·ªãnh nghƒ©a m√¥i tr∆∞·ªùng ch√∫ng ta mong mu·ªën, sau ƒë√≥ ta s·∫Ω build image v√† ch·∫°y nh√© :)
## C·∫•u h√¨nh Dockerfile
·ªû th∆∞ m·ª•c **docker-python** c√°c b·∫°n t·∫°o file t√™n l√† **Dockerfile**, b√™n trong c√≥ n·ªôi dung nh∆∞ sau:
```dockerfile
FROM python:3.6-alpine

WORKDIR /app

COPY . .

RUN pip install -r requirements.txt

CMD ["python", "app.py"]
```
Gi·∫£i th√≠ch:
- D√≤ng ƒë·∫ßu ti√™n **FROM**: ta b·∫Øt ƒë·∫ßu t·ª´ 1 Image c√≥ m√¥i tr∆∞·ªùng Alpint v√† ƒë√£ c√†i s·∫µn Python phi√™n b·∫£n 3.6. Xem danh s√°ch Image Python ·ªü ƒë√¢u, c√°c b·∫°n check ·ªü [link ch√≠nh th·ª©c](https://hub.docker.com/_/python) n√†y nh√©
- L√≠ do sao l·∫°i ch·ªçn Alpine m√† kh√¥ng ph·∫£i Ubuntu hay Debian, CentOS,.... Th√¨ ·ªü [b√†i tr∆∞·ªõc ·ªü m·ª•c n√†y](https://viblo.asia/p/dockerize-ung-dung-nodejs-RnB5pxEG5PG#_cac-ban-phan-phoi-linux-va-cach-chon-image-sao-cho-dung-8) m√¨nh ƒë√£ ph√¢n t√≠ch r·ªìi nh√©. ƒê·ªìng th·ªùi xuy√™n su·ªët series n√†y m√¨nh s·∫Ω lu√¥n d√πng m√¥i tr∆∞·ªùng h·ªá ƒëi·ªÅu h√†nh Alpine Linux nh√©
- Ti·∫øp theo trong file Dockerfile ta c√≥ **WORKDIR**: √Ω l√† ta s·∫Ω chuy·ªÉn ƒë·∫øn ƒë∆∞·ªùng d·∫´n l√† **/app** b√™n trong Image, n·∫øu ƒë∆∞·ªùng d·∫´n n√†y kh√¥ng t·ªìn t·∫°i th√¨ s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c t·∫°o lu√¥n nh√©
- Ti·∫øp theo ta **COPY** to√†n b·ªô file t·ª´ folder ·ªü m√¥i tr∆∞·ªùng g·ªëc (b√™n ngo√†i - folder **docker-python**) v√† ƒë∆∞a v√†o trong ƒë∆∞·ªùng d·∫´n **/app** b√™n trong Image
- Ti·∫øp t·ªõi l√† ta c√†i ƒë·∫∑t dependencies, c·∫ßn c√†i nh·ªØng th·ª© g√¨ th√¨ ta ƒë·ªÅ c·∫≠p s·∫µn ·ªü file **requirements.txt** r·ªìi (c√¢u l·ªánh n√†y c√°c b·∫°n c√≥ th·ªÉ xem n√≥ x√™m x√™m nh∆∞ **npm install** trong NodeJS nh√©)
- Cu·ªëi c√πng l√† ta d√πng **CMD** ƒë·ªÉ ch·ªâ command m·∫∑c ƒë·ªãnh khi m·ªôt container ƒë∆∞·ª£c kh·ªüi t·∫°o t·ª´ Image: ·ªü ƒë√¢y ta s·∫Ω kh·ªüi ƒë·ªông file **app.py**

## Build Docker Image
Sau khi c·∫•u h√¨nh nhi·ªÖn nh·∫∑n ngon r·ªìi, b∆∞·ªõc ti·∫øp theo l√† ta build Image th√¥i. C√°c b·∫°n ch·∫°y command sau ƒë·ªÉ build Image nh√©:
```
docker build -t learning-docker/python:v1 .
```
·ªû [b√†i tr∆∞·ªõc](https://viblo.asia/p/dockerize-ung-dung-nodejs-RnB5pxEG5PG#_build-docker-image-4) m√¨nh ƒë√£ gi·∫£i th√≠ch cho c√°c b·∫°n command tr√™n l√†m g√¨ r·ªìi, c√°c b·∫°n c√≥ th·ªÉ xem l·∫°i nh√©.

Gi·∫£i th√≠ch nhanh: command tr√™n s·∫Ω build 1 image t√™n l√† **learning-docker/python** v·ªõi tag l√† **v1**, c·∫£ t√™n v√† tag ta ƒë·ªÅu c√≥ th·ªÉ ch·ªçn t√πy √Ω, n·∫øu ta kh√¥ng ƒë·ªÉ tag th√¨ s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c l·∫•y l√† **latest**. D·∫•u "ch·∫•m" ·ªü cu·ªëi √Ω b·∫£o Docker l√† "t√¨m file Dockerfile ·ªü th∆∞ m·ª•c hi·ªán t·∫°i v√† build" nh√© ;)

Sau khi qu√° tr√¨nh build Image th√†nh c√¥ng, c√°c b·∫°n c√≥ th·ªÉ ki·ªÉm tra b·∫±ng command:
```
docker images
```
S·∫Ω th·∫•y hi·ªÉn th·ªã nh∆∞ sau nh√©:

![Docker python](https://images.viblo.asia/7959921d-db8f-406e-a2c5-de145d8be96c.png)

# Ch·∫°y Project
Sau khi ta ƒë√£ build th√†nh c√¥ng Image r·ªìi th√¨ b∆∞·ªõc ti·∫øp theo l√† ch·∫°y project l√™n v√† xem th√†nh qu·∫£ th√¥i nh√© ;).

V·∫´n ·ªü folder **docker-python**, c√°c b·∫°n t·∫°o file **docker-compose.yml**, v·ªõi n·ªôi dung nh∆∞ sau:
```yaml
version: "3.7"

services:
  app:
    image: learning-docker/python:v1
    ports:
      - "5000:5000"
    restart: unless-stopped
```
·ªû [b√†i tr∆∞·ªõc ph·∫ßn ch·∫°y project](https://viblo.asia/p/dockerize-ung-dung-nodejs-RnB5pxEG5PG#_chay-project-tu-docker-image-5) m√¨nh ƒë√£ gi·∫£i th√≠ch cho c√°c b·∫°n nh·ªØng th·ª© b√™n tr√™n. N·∫øu c√°c b·∫°n ch∆∞a ƒë·ªçc th√¨ n√™n xem qua nh√© ;).

Gi·∫£i th√≠ch nhanh:
- Ta ƒë·ªãnh nghƒ©a 1 service t√™n l√† **app**, service n√†y khi ch·∫°y s·∫Ω t·∫°o ra 1 container t∆∞∆°ng ·ª©ng, container ƒë∆∞·ª£c t·∫°o t·ª´ image v·ªõi t√™n ch√∫ng ta ƒë√£ ch·ªçn.
- Ta **map port** t·ª´ c·ªïng 5000 ·ªü m√°y g·ªëc (b√™n ngo√†i) v√†o c·ªïng 5000 b√™n trong container, v√¨ project c·ªßa ch√∫ng ta ƒë∆∞·ª£c ch·∫°y ·ªü c·ªïng 5000 (m·∫∑c ƒë·ªãnh c·ªßa Flask)

Nom ch·ª´ng c√°ch setup ch·∫£ kh√°c cho b√†i tr∆∞·ªõc l√†m v·ªõi NodeJS l√† m·∫•y nh·ªâ :-D.

ƒê·ªÉ kh·ªüi ƒë·ªông project c√°c b·∫°n ch·∫°y command sau:
```
docker-compose up
```
Sau ƒë√≥ c√°c b·∫°n s·∫Ω th·∫•y ·ªü terminal hi·ªÉn th·ªã nh∆∞ sau

![docker compose python flask](https://images.viblo.asia/6519e1f4-1c9a-4045-8884-d617f681a0fb.png)

Qu√° ·ªïn, test th·ª≠ th√¥i n√†o. C√°c b·∫°n m·ªü tr√¨nh duy·ªát ·ªü ƒë·ªãa ch·ªâ **localhost:5000** nh√©.

V√† B√ôM :boom: 

![Docker python](https://images.viblo.asia/706737fb-1422-4846-aa64-4b61e016c989.png)

Kh√¥ng c√≥ g√¨ x·∫£y ra :sob::sob:

Th·ª≠ review l·∫°i code xem nh√©:
- File app.py kh√° ƒë∆°n gi·∫£n, kh√¥ng c√≥ g√¨ ƒë√°ng g·ªùm
- ƒê√£ c√≥ command ch·∫°y app ·ªü file Dockerfile
- Port c≈©ng ƒë√£ map ·ªü file docker-compose.yml

Th·∫ø v·∫•n ƒë·ªÅ l√† ·ªü ƒë√¢u nh·ªâ??

R√µ r√†ng n·∫øu m√¨nh ch·∫°y tr·ª±c ti·∫øp t·ª´ m√¥i tr∆∞·ªùng ngo√†i, m√°y g·ªëc c·ªßa m√¨nh (n·∫øu ·ªü m√°y g·ªëc c√°c b·∫°n c√≥ c√†i Python), kh√¥ng d√πng Docker n·ªØa, th√¨ m·ªçi th·ª© v·∫´n oke m√† nh·ªâ... :confounded::confounded:

Th·ª≠ review l·∫°i [docs c·ªßa Flask ·ªü ƒë√¢y](https://flask.palletsprojects.com/en/1.1.x/quickstart/), v√† ta ƒë√£ t√¨m ra ch√¢n l√Ω, ch√∫ng ta ƒë·ªÉ √Ω m·ª•c **Externally Visible Server**. M√¨nh s·∫Ω d·ªãch lu√¥n cho c√°c b·∫°n:
```
N·∫øu b·∫°n ch·∫°y ·ª©ng d·ª•ng l√™n th√¨ b·∫°n s·∫Ω ƒë·ªÉ √Ω th·∫•y r·∫±ng ·ª©ng d·ª•ng c·ªßa b·∫°n ch·ªâ c√≥ th·ªÉ truy c·∫≠p ƒë∆∞·ª£c trong ph·∫°m vi m√°y c·ªßa b·∫°n (localhost), ƒëi·ªÅu n√†y ƒë∆∞·ª£c c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh
```
Do ƒë√≥ khi ch·∫°y project c·ªßa ch√∫ng ta trong container th√¨ ch·ªâ m√¥i tr∆∞·ªùng trong container m·ªõi truy c·∫≠p ƒë∆∞·ª£c v√†o project, project c·ªßa ch√∫ng ta coi m√¥i tr∆∞·ªùng ƒë√≥ m·ªõi l√† **localhost**, c√≤n t·ª´ m√¥i tr∆∞·ªùng g·ªëc (b√™n ngo√†i) truy v·∫•n th√¨ s·∫Ω kh√¥ng ƒë∆∞·ª£c g·ªçi l√† localhost n·ªØa.

> Note: c√°c b·∫°n ch√∫ √Ω ƒëi·ªÅu n√†y v√¨ sau n√†y khi dockerize project Nuxt c≈©ng s·∫Ω b·ªã t∆∞∆°ng t·ª±

Do ƒë√≥ ƒë·ªÉ fix ƒëi·ªÅu n√†y ta l√†m nh∆∞ sau.

C√°c b·∫°n s·ª≠a l·∫°i file app.py m·ªôt ch√∫t nh∆∞ sau nh√©:
```python
from flask import Flask, render_template

app = Flask(__name__)

@app.route("/")
def hello():
    return render_template('index.html', title='Docker Python', name='James')

if __name__ == "__main__":
    app.run(host="0.0.0.0")
```
·ªû tr√™n ta ch·ªâ th√™m v√†o duy nh·∫•t **host=0.0.0.0** ƒë·ªÉ n√≥i v·ªõi project ch√∫ng ta l√† "ch·∫•p nh·∫≠n cho t·∫•t c·∫£ m·ªçi IP truy c·∫≠p"

·ªîn r·ªìi ƒë√≥ ch√∫ng ta build l·∫°i image nh√©:
```
docker build -t learning-docker/python:v1 .
```
Sau khi build xong th√¨ ta c·∫ßn kh·ªüi ƒë·ªông l·∫°i project nh√©, c√°c b·∫°n ch·∫°y command sau:
```
docker-compose down
docker-compose up
```

V√† cu·ªëi c√πng l√† m·ªü tr√¨nh duy·ªát v√† test th√¥i n√†o:

![Docker python](https://images.viblo.asia/cff7d79a-228b-485e-875e-e9a16d0d6b36.png)

Tuy·ªát v·ªùi :clap::clap:
# Bi·∫øn m√¥i tr∆∞·ªùng (ENV)
B√†i tr∆∞·ªõc v√† b√†i c√°c b·∫°n c√≥ th·ªÉ th·∫•y l√† project khi ch·∫°y ƒë·ªÅu ƒë∆∞·ª£c fix c·ª©ng 1 c·ªïng (b√†i tr∆∞·ªõc l√† 3000, b√†i n√†y l√† 5000), th·∫ø n·∫øu ta mu·ªën container ch·∫°y ·ªü m·ªôt c·ªïng kh√°c th√¨ ta l·∫°i ph·∫£i s·ª≠a code hay sao??

L√∫c ƒë√≥ ta s·∫Ω nghƒ© t·ªõi **bi·∫øn m√¥i tr∆∞·ªùng (environment variable)**, trong qu√° tr√¨nh dev v√† khi ch·∫°y th·∫≠t t·∫ø s·ª≠ d·ª•ng bi·∫øn m√¥i tr∆∞·ªùng s·∫Ω gi√∫p ta r·∫•t nhi·ªÅu trong vi·ªác gi·∫£m t·ªëi thi·ªÉu vi·ªác ph·∫£i s·ª≠a code
## Bi·∫øn m√¥i tr∆∞·ªùng ·ªü Dockerfile
ƒê·∫ßu ti√™n l√† ta s·∫Ω th·ª≠ d√πng bi·∫øn m√¥i tr∆∞·ªùng khai b√°o ·ªü Dockerfile ƒë·ªÉ thi·∫øt l·∫≠p Port(c·ªïng) cho project ch·∫°y trong container nh√© (√Ω l√† container s·∫Ω kh√¥ng ch·∫°y ·ªü port 5000 n·ªØa)

·ªû file **app.py** ta s·ª≠a l·∫°i nh∆∞ sau:
```python
from flask import Flask, render_template
import os

app = Flask(__name__)

@app.route("/")
def hello():
    return render_template('index.html', title='Docker Python', name='James')

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=os.environ['PORT']) # Ch·∫°y project ·ªü PORT nh·∫≠n v√†o t·ª´ bi·∫øn m√¥i tr∆∞·ªùng
```
Sau ƒë√≥ ·ªü file Dockerfile ta s·ª≠a l·∫°i nh∆∞ sau:
```dockerfile
FROM python:3.6-alpine

WORKDIR /app

# T·∫°o ra bi·∫øn m√¥i tr∆∞·ªùng t√™n l√† PORT v·ªõi gi√° tr·ªã 5555
ENV PORT 5555

COPY . .

RUN pip install -r requirements.txt

CMD ["python", "app.py"]
```
·ªû file **docker-compose.yml** ta s·ª≠a l·∫°i ch√∫t nh∆∞ sau nh√©:
```yaml
version: "3.7"

services:
  app:
    image: learning-docker/python:v1
    ports:
      - "5000:5555"
    restart: unless-stopped
```

C√°c b·∫°n ƒë·ªÉ √Ω ·ªü tr√™n khi ta map port ta ch·ªâ chuy·ªÉn m·ªói v·∫ø b√™n ph·∫£i, v·∫ø b√™n ph·∫£i l√† port c·ªßa project ch·∫°y **·ªü trong container** nh√©, v·∫ø b√™n tr√°i l√† port ·ªü m√¥i tr∆∞·ªùng g·ªëc (b√™n ngo√†i, ta c√≥ th·ªÉ ch·ªçn t√πy √Ω, v√† ƒë√¢y, port 5000 ch√≠nh l√† port m√† user s·∫Ω d√πng ƒë·ªÉ truy c·∫≠p ·ªü tr√¨nh duy·ªát)

Ti·∫øp theo ta ti·∫øn h√†nh build l·∫°i image nh√©:
```
docker build -t learning-docker/python:v1 .
```
V√† kh·ªüi ƒë·ªông l·∫°i project:
```
docker-compose down
docker-compose up
```
M·ªü tr√¨nh duy·ªát ·ªü ƒë·ªãa ch·ªâ **localhost:5000** (v·∫´n nh∆∞ c≈©), c√°c b·∫°n s·∫Ω th·∫•y m·ªçi th·ª© ch·∫°y b√¨nh th∆∞·ªùng, nh∆∞ng ng√≥ qua Terminal th√¨ s·∫Ω th·∫•y nh∆∞ sau:

![Docker python](https://images.viblo.asia/9046e9a7-299b-4f0e-a788-9ff9b048d796.png)

·ªû h√¨nh tr√™n ta th·∫•y r·∫±ng ·ªü b√™n trong container, project c·ªßa ch√∫ng ta ƒë√£ ƒë∆∞·ª£c ch·∫°y ·ªü port 5555 r·ªìi nh√© ;)

Th·∫ø n·∫øu b√¢y gi·ªù ta mu·ªën ƒë·ªïi port c·ªßa project trong container th√†nh 6666 th√¨ sao, ta l·∫°i ph·∫£i build l·∫°i Image?

V·ªõi nh·ªØng d·∫°ng bi·∫øn m√¥i tr∆∞·ªùng m√† d·ªÖ thay ƒë·ªïi th√¨ ta c√≥ s·ª± l·ª±a ch·ªçn kh√°c ƒë∆°n gi·∫£n h∆°n ƒë√≥ l√† khai b√°o ·ªü file **docker-compose.yml** nh√©

## Bi·∫øn m√¥i tr∆∞·ªùng ·ªü docker-compose
ƒê·ªÉ kh√¥ng ph·∫£i build l·∫°i image m·ªói l·∫ßn ta ƒë·ªïi port, ta s·∫Ω khai b√°o bi·∫øn m√¥i tr∆∞·ªùng ·ªü **docker-compose.yml** nh√©. T·∫°i sao:
- Bi·∫øn m√¥i tr∆∞·ªùng ·ªü file Dockerfile s·∫Ω ƒë∆∞·ª£c khai b√°o khi ta build image
- Bi·∫øn m√¥i tr∆∞·ªùng ·ªü file docker-compose.yml s·∫Ω ƒë∆∞·ª£c kh·ªüi t·∫°o **khi container ƒë∆∞·ª£c kh·ªüi t·∫°o**, t·ª©c l√† khi ta ch·∫°y **docker-compose up**. Do ƒë√≥ ƒë·ªÉ thay ƒë·ªïi bi·∫øn m√¥i tr∆∞·ªùng ta ch·ªâ c·∫ßn **down v√† up** l√† xong ;)

Th·ª≠ nghi·ªám th√¥i n√†o...

·ªû file Dockerfile ta x√≥a d√≤ng **ENV PORT 5555** ƒëi nh√©.

Sau ƒë√≥ ·ªü file **docker-compose.yml** ta s·ª≠a l·∫°i nh∆∞ sau:
```yaml
version: "3.7"

services:
  app:
    image: learning-docker/python:v1
    ports:
      - "5000:6666"
    restart: unless-stopped
    environment:
      PORT: 6666
```

B√¢y gi·ªù ta v·∫´n c·∫ßn build l·∫°i image 1 l·∫ßn ƒë·ªÉ c·∫≠p nh·∫≠t m·ªõi ƒë∆∞·ª£c √°p d·ª•ng:
```
docker build -t learning-docker/python:v1 .
```
Sau ƒë√≥ ta kh·ªüi ƒë·ªông l·∫°i project nh√©:
```
docker-compose down
docker-compose up
```
Sau ƒë√≥ F5 l·∫°i tr√¨nh duy·ªát ƒë·ªÉ ch·∫Øc ch·∫Øn m·ªçi th·ª© v·∫´n ·ªïn, v√† xem ·ªü terminal:

![Docker python](https://images.viblo.asia/53cfd224-ea10-4b3c-99a2-890d8ede9d10.png)

V·∫≠y l√† ta ƒë√£ c√≥ th·ªÉ d·ªÖ d√†ng thay ƒë·ªïi c·ªïng c·ªßa project trong container khi d√πng bi·∫øn m√¥i tr∆∞·ªùng r·ªìi. C√°c b·∫°n th·ª≠ ƒë·ªïi l·∫°i th√†nh 7777 th·ª≠ xem (nh·ªõ **down v√† up** docker-compose nh√© ;))

## C√°ch t·ªët h∆°n ƒë·ªÉ t·∫°o bi·∫øn m√¥i tr∆∞·ªùng
·ªû v√≠ d·ª• tr√™n n·∫øu ta mu·ªën ƒë·ªïi PORT th√†nh 7777 ch·∫≥ng h·∫°n, ta ph·∫£i s·ª≠a ·ªü 2 n∆°i trong file **docker-compose.yml**, v·∫≠y n·∫øu bi·∫øn ƒë√≥ d√πng ·ªü 100 n∆°i trong file **docker-compose.yml** th√¨ sao?

**docker-compose** support ta m·ªôt c√°ch ƒë∆°n gi·∫£n h∆°n, ti·ªán h∆°n ƒë·ªÉ kh·ªüi t·∫°o bi·∫øn m√¥i tr∆∞·ªùng, ƒë√≥ l√† ƒë·∫∑t ·ªü file **.env** (gi·ªëng y nh∆∞ Laravel :sunglasses:, c≈©ng ƒë·ªìng nghƒ©a v·ªõi vi·ªác n·∫øu ta dockerize project Laravel th√¨ ta ch·ªâ c·∫ßn duy nh·∫•t 1 file chung l√† **.env**). Khi ch·∫°y project th√¨ **docker-compose** s·∫Ω t·ª± t√¨m xem c√≥ file **.env** hay kh√¥ng v√† load c√°c bi·∫øn trong ƒë√≥.

C√πng th·ª≠ nh√© :)

·ªû folder **docker-python** ta t·∫°o file **.env** v·ªõi n√¥i dung nh∆∞ sau:
```
PORT=8888
PUBLIC_PORT=9999
```
Gi·∫£i th√≠ch:
- bi·∫øn **PORT**: ch·ªâ port c·ªßa project ch·∫°y **b√™n trong** container
- bi·∫øn **PUBLIC_PORT**: ch·ªâ port m√† "th·∫ø gi·ªõi b√™n ngo√†i" d√πng ƒë·ªÉ truy c·∫≠p v√†o project ;) (√Ω l√† port ta g·ªçi ·ªü tr√¨nh duy·ªát)

Ta s·ª≠a l·∫°i file **docker-compose.yml** nh∆∞ sau:
```yaml
version: "3.4"

services:
  app:
    image: learning-docker/python:v1
    ports:
      - "${PUBLIC_PORT}:${PORT}"
    restart: unless-stopped
    environment:
      PORT: ${PORT}
```
Sau ƒë√≥ ta kh·ªüi ƒë·ªông l·∫°i project nh√©:
```
docker-compose down
docker-compose up
```
Check ·ªü terminal ta s·∫Ω th·∫•y:

![Docker python](https://images.viblo.asia/0650dba4-55bd-4b0c-88a2-ff54738d1f89.png)

Tuy·ªát v·ªùi, project ƒë√£ ch·∫°y th√†nh c√¥ng ·ªü c·ªïng 8888 trong container. Gi·ªù check tr√™n tr√¨nh duy·ªát th√¥i n√†o.

Ta m·ªü tr√¨nh duy·ªát ·ªü ƒë·ªãa ch·ªâ **localhost:xxxx** (c√°c b·∫°n t·ª± ƒëi·ªÅn xxxx xem l√† g√¨ nh√© ;))

# Push Image l√™n registry
·ªû b√†i tr∆∞·ªõc d√†i qu√° m√¨nh ch∆∞a n√≥i th√™m v√†o c√°c ƒë∆∞a image l√™n registry v√† l√†m ng∆∞·ªùi kh√°c c√≥ th·ªÉ ch·∫°y ƒë∆∞·ª£c project c·ªßa b·∫°n t·ª´ image nh∆∞ th·∫ø n√†o. ·ªû b√†i n√†y th√¨ ta c√≥ ƒë·∫•t di·ªÖn r·ªìi ;)

Docker build ch·∫°y ngon ngh·∫ª ·ªü m√°y c·ªßa ta r·ªìi th√¨ th·ª≠ ƒë∆∞a cho ng∆∞·ªùi kh√°c xem h·ªç ch·∫°y th·∫ø n√†o ch·ª© nh·ªâ :-D

> **registry** l√† n∆°i ta l∆∞u Docker image (gi·ªëng nh∆∞ github ƒë·ªÉ l∆∞u code, nh∆∞ng ƒë√¢y l√† l∆∞u Docker image), c√≥ r·∫•t nhi·ªÅu registry, c√≥ public c√≥ private.

·ªû trong series n√†y ta s·∫Ω d√πng Gitlab ƒë·ªÉ l∆∞u code v√† c·∫£ l∆∞u image tr√™n registry c·ªßa h·ªç nh√©. Gitlab cho ta unlimited image ·ªü private registry cho **t·ª´ng** repository (qu√° tuy·ªát v·ªùi m√† c√≤n free l·∫°i c√≤n private)

## T·∫°o account v√† repository tr√™n Gitlab
ƒê·∫ßu ti√™n c√°c b·∫°n c·∫ßn t·∫°o 1 t√†i kho·∫£n tr√™n Gitlab.com (n·∫øu ch∆∞a c√≥). Sau ƒë√≥ ta t·∫°o m·ªôt repository t√™n l√† **learning-docker** cho to√†n b·ªô series n√†y nh√© ;)

Sau ƒë√≥ click ch·ªçn repository ta v·ª´a t·∫°o, ƒë·ªÉ √Ω ·ªü ph·∫ßn sidebar b√™n tay tr√°i, hover chu·ªôt v√†o **Packages**, sau ƒë√≥ click ch·ªçn **Container Registry**, ƒë√¢y ch√≠nh l√† n∆°i ta s·∫Ω d√πng ƒë·ªÉ l∆∞u tr·ªØ image nh√© ;)

C√°c b·∫°n s·∫Ω th·∫•y hi·ªÉn th·ªã nh∆∞ sau:

![Gitlab registry](https://images.viblo.asia/fe79e055-bfa2-4205-a529-b12965d3350f.png)


## B·∫Øt ƒë·∫ßu
Gi·ªù ta s·∫Ω c√πng th·ª±c h√†nh ƒë·∫©y image registry c·ªßa gitlab nha :)

ƒê·∫ßu ti√™n nh∆∞ ·ªü h√¨nh tr√™n, ta c·∫ßn login v√†o registry c·ªßa Gitlab tr∆∞·ªõc (v√¨ registry n√†y l√† private m√† ;)). Ta ch·∫°y command sau ƒë·ªÉ login:
```
docker login registry.gitlab.com
```
Ta s·∫Ω th·∫•y ·ªü terminal h·ªèi email v√† password t√†i kho·∫£n gitlab, c√°c b·∫°n nh·∫≠p th√¥ng s·ªë c·ªßa c√°c b·∫°n v√†o nh√©. 

Sau ƒë√≥ b∆∞·ªõc ti·∫øp theo nh∆∞ ·ªü h√¨nh tr√™n ta c·∫ßn build image. Nh∆∞ng v√¨ image ta ƒë√£ c√≥ s·∫µn ·ªü local r·ªìi n√™n ta kh√¥ng c·∫ßn thi·∫øt build l·∫°i n·ªØa.

"Ok v·∫≠y l√† t√¥i c√≥ th·ªÉ ƒë·∫©y lu√¥n l√™n Gitlab r·ªìi ·∫•y g√¨?" - Ch∆∞a ƒÉn ngay ƒë∆∞·ª£c ƒë√¢u c√°c b·∫°n :-D

Khi ƒë·∫©y image l√™n registry c·ªßa gitlab ta c·∫ßn ph·∫£i ƒë·∫∑t t√™n image theo chu·∫©n c·ªßa h·ªç, tag c√≥ th·ªÉ ƒë·∫∑t t√πy √Ω nh∆∞ng t√™n ph·∫£i ƒë√∫ng, theo format sau:
```
registry.gitlab.com/<username>/<t√™n repo>
```
·ªû h√¨nh tr√™n c√°c b·∫°n copy paste c√¢u l·ªánh docker push ƒë·ªÉ xem b·∫°n c·∫ßn ph·∫£i ƒë·∫∑t t√™n image th·∫ø n√†o nh√©

Sau khi bi·∫øt c·∫ßn ƒë·∫∑t t√™n nh∆∞ n√†o r·ªìi th√¨ ta c√≥ 2 l·ª±a ch·ªçn:
1. Build l·∫°i image nh∆∞ command th·ª≠ 2 ·ªü trong h√¨nh tr√™n ƒë·ªÉ ƒë∆∞·ª£c image v·ªõi t√™n theo format
2. ƒê·ªïi t√™n Image hi·ªán t·∫°i ƒë√£ c√≥ ·ªü local 

·ªû ƒë√¢y m√¨nh s·∫Ω ch·ªçn c√°ch s·ªë 2 l√† ƒë·ªïi t√™n ƒë·ªÉ ta kh·ªèi ph·∫£i build l·∫°i image nh√© ;)

Ta ch·∫°y command sau ƒë·ªÉ li·ªát k√™ danh s√°ch image:
```
docker images
```
ta s·∫Ω th·∫•y nh∆∞ sau:

![docker](https://images.viblo.asia/10862513-49c6-4846-84c1-d1b27b48a2dc.png)

Ti·∫øp theo ta s·∫Ω ti·∫øn h√†nh ch·∫°y command sau:
```
docker tag learning-docker/python:v1 registry.gitlab.com/maitrungduc1410/learning-docker
```
Note: ph·∫ßn t√™n image gitlab b√™n tr√™n c√°c b·∫°n thay cho kh·ªõp v·ªõi c·ªßa b·∫°n nh√©, ƒë·ªìng th·ªùi n·∫øu c√°c b·∫°n th·ª≠ li·ªát k√™ danh s√°ch image l·∫°i s·∫Ω th·∫•y ta c√≥ 1 image m·ªõi l√† b·∫£n sao c·ªßa image c≈©, image c≈© v·∫´n c√≤n ƒë√≥, c√°c b·∫°n c√≥ th·ªÉ x√≥a image c≈© n·∫øu c·∫ßn nh√©

Cu·ªëi c√πng l√† ta ƒë·∫©y image l√™n registry th√¥i n√†o:
```
docker push registry.gitlab.com/maitrungduc1410/learning-docker  ## thay t√™n image cho kh·ªõp v·ªõi c·ªßa c√°c b·∫°n nh√©
```
Sau khi upload th√†nh c√¥ng ta quay l·∫°i trang Container Registry tr√™n gitlab v√† check:

![Gitlab registry](https://images.viblo.asia/13885dc1-3668-43d4-ba9a-082f903c1e88.png)

C√°c b·∫°n c√≥ th·ªÉ th·∫•y l√† ta ƒë√£ c√≥ 1 image tr√™n registry v·ªõi tag l√† **latest** (v√¨ khi n√£y l√∫c ƒë·ªïi t√™n v√† khi push ta kh√¥ng n√≥i tag l√† g√¨ n√™n docker m·∫∑c ƒë·ªãnh tag l√† **latest**)

## Pull Image v·ªÅ v√† ch·∫°y th·ª≠
L·∫°i ƒë·∫øn gi·ªù ph√∫t c·ªßa s·ª± th·∫≠t, kh√¥ng bi·∫øt khi ƒëem image qua m√°y kh√°c ch·∫°y ho·∫∑c m·ªôt n∆°i n√†o ƒë√≥ th√¨ m·ªçi th·ª© c√≥ c√≤n ·ªïn hay  kh√¥ng??

B√¢y gi·ªù c√°c b·∫°n s·∫Ω d√πng m·ªôt m√°y kh√°c, ho·∫∑c n·∫øu kh√¥ng c√≥ th√¨ ta chuy·ªÉn qua m·ªôt folder n√†o ƒë√≥ ƒë·ªÉ test, n·∫øu d√πng m√°y kh√°c th√¨ nh·ªõ l√† m√°y ƒë√≥ **ph·∫£i c√†i Docker v√† Docker compose** nh√©.

Ta t·∫°o m·ªôt folder test l√† **test-docker** ·ªü b·∫•t k√¨ ƒë√¢u b·∫°n mu·ªën. Trong ƒë√≥ ta c√≥ c√°c file nh∆∞ sau:
- **.env** ƒë·ªÉ t·∫°o bi·∫øn m√¥i tr∆∞·ªùng
- **docker-compose.yml** ƒë·ªÉ kh·ªüi ch·∫°y project

File **.env** ta gi·ªØ nguy√™n n·ªôi dung, nh∆∞ng file **docker-compose.yml** ta s·ª≠a l·∫°i nh∆∞ sau:
```yaml
version: "3.4"

services:
  app:
    # ƒë·ªïi t√™n image ·ªü ƒë√¢y cho ƒë√∫ng v·ªõi c·ªßa b·∫°n (kh√¥ng n√≥i g√¨ v·ªÅ tag th√¨ m·∫∑c ƒë·ªãnh l√† 'latest')
    image: registry.gitlab.com/maitrungduc1410/learning-docker 
    ports:
      - "${PUBLIC_PORT}:${PORT}"
    restart: unless-stopped
    environment:
      PORT: ${PORT}
```
Sau ƒë√≥ ta l·∫°i ch·ªâ c·∫ßn ch·∫°y command sau ƒë·ªÉ kh·ªüi ƒë·ªông project:
```
docker-compose up
```
V√¨ image ta ƒë·ªÉ l√† ·ªü tr√™n m·ªôt private gitlab ch·ªâ c√≥ ta m·ªõi ƒë∆∞·ª£c l·∫•y image v·ªÅ, n√™n do ƒë√≥ n·∫øu th·∫•y b√°o l·ªói x√°c th·ª±c th√¨ c√°c b·∫°n ch·∫°y l·∫°i command sau ƒë·ªÉ login nh√©:
```
docker login registry.gitlab.com
# Ch·∫°y xong ta l·∫°i docker-compose up l√† ƒë∆∞·ª£c nh√©
```

V√† m·ªçi th·ª© s·∫Ω ch·∫°y nh∆∞ b√¨nh th∆∞·ªùng ;), ta s·∫Ω c√≥ k·∫øt qu·∫£ h·ªát nh∆∞ ·ªü m√°y g·ªëc c·ªßa ch√∫ng ta, d√π ta ƒë∆∞a image ƒëi ch·∫°y ·ªü m√°y n√†o c≈©ng v·∫≠y.

# K·∫øt b√†i
M√¨nh bi·∫øt l√† b√†i n√†y l·∫°i l√†m cho c√°c b·∫°n ƒëau m·∫Øt v√¨ ƒë·ªô d√†i, v√¨ c√≥ nhi·ªÅu th·ª© m√¨nh mu·ªën n√≥i t·ªõi, nh∆∞ng d·∫ßn d·∫ßn nh·ªØng kh√°i ni·ªám m·ªõi s·∫Ω h·∫øt v√† ta s·∫Ω t·∫≠p trung nhi·ªÅu v√†o vi·ªác th·ª±c h√†nh h∆°n nh√©, s·ª± ƒëau m·∫Øt m√¨nh hi v·ªçng v√¨ th·∫ø c≈©ng gi·∫£m ƒëi :rofl::rofl:

Qua b√†i n√†y c√°c b·∫°n ƒë√£ th·∫•y ƒë∆∞·ª£c c√°ch ƒë·ªÉ dockerize m·ªôt ·ª©ng d·ª•ng Python nh∆∞ n√†o, kh√° gi·ªëng b√†i tr∆∞·ªõc cho NodeJS ph·∫£i kh√¥ng ;). Ta v·∫´n kh√¥ng c·∫ßn ph·∫£i c√†i tr·ª±c ti·∫øp Python v√†o m√¥i tr∆∞·ªùng g·ªëc (b√™n ngo√†i), v·∫´n ch·ªâ c√≥ duy nh·∫•t **docker v√† docker-compose** <3

·ªû b√†i n√†y c√≥ 2 n·ªôi dung quan tr·ªçng m√¨nh mu·ªën n√≥i t·ªõi:
- C√°ch d√πng bi·∫øn m√¥i tr∆∞·ªùng
- C√°ch ƒë∆∞a image l√™n registry ƒë·ªÉ sau n√†y ta c√≥ th·ªÉ t·∫£i v·ªÅ v√† c√°ch t·∫£i xu·ªëng image ƒë·ªÉ ch·∫°y nh∆∞ th·∫ø n√†o

C√°m ∆°n c√°c b·∫°n ƒë√£ theo d√µi, n·∫øu c√≥ g√¨ th·∫Øc m·∫Øc c√°c b·∫°n c·ª© comment b√™n d∆∞·ªõi cho m√¨nh ƒë∆∞·ª£c bi·∫øt nh√© ;).

Source code b√†i n√†y m√¨nh ƒë·ªÉ [·ªü ƒë√¢y](https://gitlab.com/maitrungduc1410/learning-docker) (nh√°nh **complete-tutorial** nh√©)

H·∫πn g·∫∑p l·∫°i c√°c b·∫°n ·ªü c√°c b√†i sau ^^