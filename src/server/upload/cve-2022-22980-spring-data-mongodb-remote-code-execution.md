## 1. Prerequisites
![image.png](https://images.viblo.asia/d34f9181-c0b0-4ed1-87de-deebee8cb54d.png)
- Ubuntu GNOME
- Spring Boot
- MongoDB
## 2. Overview

![image.png](https://images.viblo.asia/8ed65357-91b9-4f5c-9ccf-71b7c533245a.png)

CVE-2022-22980 là một lỗ hổng bảo mật của thư viện [`spring-data-mongodb`](https://mvnrepository.com/artifact/org.springframework.data/spring-data-mongodb) có thể khiến attacker chạy bất kì câu lệnh nào trên máy chủ bằng việc truyền một đoạn mã độc vào user input để trigger thư viện thực thi nếu như ứng dụng `Spring Boot` + `MongoDB` sử dụng [JSON based query methods](https://docs.spring.io/spring-data/mongodb/docs/1.2.0.RELEASE/reference/html/mongo.repositories.html#d0e4055) với `@Query`,  `@Aggregation` annotaion có chứa parameter expression [SpEL - Spring Expression Language](https://spring.io/blog/2014/07/15/spel-support-in-spring-data-jpa-query-definitions) tương tự như sau:

```
	@Query("{ 'firstName' : ?#{?0} }")
	Customer findByFirstName(String firstName);
```

Đến đây bạn có thể thực hiện mở ứng dụng `gnome-calculator` trên Ubuntu GNOME bằng cách thực thi câu lệnh truy vấn như thế này:
```
    repository.findByFirstName("T(java.lang.Runtime).getRuntime().exec(\"gnome-calculator\")");
```

Do lổ hổng bảo mật này đã được report từ hơn 1 tháng trước (13/06/2022) nên nếu bạn sử dụng `spring-data-mongodb` depedency mới release gần đây (v.**3.3**.5 hay v**3.4**.1 trở lên) thì sẽ không khai thác được lỗ hổng này.

![spring-data-mongodb-impacted-version.png](https://images.viblo.asia/b4c3585a-e460-465d-bb3d-113c0a7fdd13.png)

## 3. Exploitation Explain
Trước khi đi vào chi tiết, các bạn có thể xem toàn bộ source code ở [đây](https://github.com/logbasex/a-little-bit-about-spring/tree/master/spring-vulnerability/CVE-2022-22980)

Vì lỗ hổng này liên quan trực tiếp đến cách Spring Boot framework xử lý SpEL query parameter của MongoDB interface repository, nên để hiểu chúng ta cần phải biết quá trình một câu truy vấn được xử lý ra sao.

1. Khai báo CustomerRepository

![image.png](https://images.viblo.asia/1a39733e-bd32-4ecf-8941-6bfaf69569f6.png)


2. Tiến hành gọi câu truy vấn

![image.png](https://images.viblo.asia/09eac19d-9a2d-430c-a045-c98308f18386.png)

Step into:

![image.png](https://images.viblo.asia/cc5ee555-99bd-490b-b8d0-93f43f3c6779.png)

Bạn có thể thấy, CustomerRepository là một proxy class (JdkDynamicAopProxy), có nghĩa rằng tại runtime (dynamic), Spring Boot framework đã tiến hành proxy CustomerRepository bean và khi bạn bạn tiến hành gọi câu truy vấn thì bạn phải gọi qua proxy class trước. 

![image.png](https://images.viblo.asia/5c963f4e-8ce7-426b-8115-1ae25bd984b0.png)

Khi tiến hành debug, nhìn qua callstack bạn sẽ thấy khá loạn vì Spring Boot framework gọi qua nhiều proxy class khác nhau, nhưng thực sự để mà nói thì source code quá lớn và phức tạp để chúng ta có thể hiểu một cách tường tận một workflows hoàn chỉnh nhưng có thể hiểu nôm na như sau (theo cách hiểu của mình):

Khi gọi đến phương thức `findByFirstName()` trong CustomerRepository, thì tất cả mọi lời gọi phương thức đều phải đi qua một `handler` duy nhất - đó chính là phương thức [`invoke()`](https://www.baeldung.com/java-dynamic-proxies). 

![image.png](https://images.viblo.asia/e6ca68c4-e518-4b88-b52d-b3798f56ec57.png)

![image.png](https://images.viblo.asia/b0725f28-44c7-4950-90ac-e88efe48b757.png)

Bên trong phương thức `invoke()` này, chúng ta sẽ thực thi các bước tiền xử lý trước khi tiến hành chọc thẳng vào database truy vấn dữ liệu, đơn cử như là `StringBasedMongoQuery#createQuery()`. Tuy nhiên trước khi gọi `#createQuery()` thì Spring Boot framework cần binding paramter vào câu query trước thông qua phương thức `getBindingContext()`:

![image.png](https://images.viblo.asia/d4ece08e-2041-4ffb-8f47-73867468609f.png)

Tiếp theo là bước phân tích câu query và gán giá trị từ tham số.

![image.png](https://images.viblo.asia/f03546e3-e7a4-47d4-b162-9324bf72e698.png)

![image.png](https://images.viblo.asia/a4bee9fb-b33a-4f19-a9e0-6e423c5250b7.png)

Bạn có thể thấy, với parameter expression đầu vào là `T(java.lang.Runtime).getRuntime().exec(\"gnome-calculator\")` thì sau khi được xử lý giá trị của biến `expression` vẫn như thế, điều đó có nghĩa là phương thức `ParameterBindingJsonReader#bindableValueFor()` không phát hiện ra được đây là một đoạn mã được truyền vào thay vì một giá trị thông thường.

![image.png](https://images.viblo.asia/ca7aee4d-63be-43f9-b332-baf4da5ccf09.png)

Và lỗ hổng bảo mật xảy ra ở đây chính là khi gọi phương thức `ParameterBindingJsonReader#evaluateExpression()`, `expression` truyền vào được covert thành một `UUNIXProcess` và tiến hành việc mở ứng dụng `gnome-calculator` ngay sau đó. 

![image.png](https://images.viblo.asia/9aafb1b7-841c-41d2-8dad-84ed90424b7b.png)

![image.png](https://images.viblo.asia/36af907c-ae7d-440a-bb3b-2ded25597fb9.png)

[Parse expression](https://docs.spring.io/spring-framework/docs/3.0.x/reference/expressions.html#d0e11977):

![image.png](https://images.viblo.asia/5244227b-4c30-477f-a93b-7b017790c2f0.png)

Debug callstack:
```
bindableValueFor:389, ParameterBindingJsonReader (org.springframework.data.mongodb.util.json)
readBsonType:304, ParameterBindingJsonReader (org.springframework.data.mongodb.util.json)
decode:227, ParameterBindingDocumentCodec (org.springframework.data.mongodb.util.json)
decode:180, ParameterBindingDocumentCodec (org.springframework.data.mongodb.util.json)
createQuery:121, StringBasedMongoQuery (org.springframework.data.mongodb.repository.query)
doExecute:122, AbstractMongoQuery (org.springframework.data.mongodb.repository.query)
execute:107, AbstractMongoQuery (org.springframework.data.mongodb.repository.query)
invoke:-1, 1601756706 (org.springframework.data.repository.core.support.RepositoryMethodInvoker$RepositoryQueryMethodInvoker$$Lambda$580)
doInvoke:137, RepositoryMethodInvoker (org.springframework.data.repository.core.support)
invoke:121, RepositoryMethodInvoker (org.springframework.data.repository.core.support)
doInvoke:159, QueryExecutorMethodInterceptor (org.springframework.data.repository.core.support)
invoke:138, QueryExecutorMethodInterceptor (org.springframework.data.repository.core.support)
proceed:186, ReflectiveMethodInvocation (org.springframework.aop.framework)
invoke:80, DefaultMethodInvokingMethodInterceptor (org.springframework.data.projection)
proceed:186, ReflectiveMethodInvocation (org.springframework.aop.framework)
invoke:97, ExposeInvocationInterceptor (org.springframework.aop.interceptor)
proceed:186, ReflectiveMethodInvocation (org.springframework.aop.framework)
invoke:215, JdkDynamicAopProxy (org.springframework.aop.framework)
findByFirstName:-1, $Proxy44 (com.sun.proxy)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
invokeJoinpointUsingReflection:344, AopUtils (org.springframework.aop.support)
invokeJoinpoint:198, ReflectiveMethodInvocation (org.springframework.aop.framework)
proceed:163, ReflectiveMethodInvocation (org.springframework.aop.framework)
invoke:137, PersistenceExceptionTranslationInterceptor (org.springframework.dao.support)
proceed:186, ReflectiveMethodInvocation (org.springframework.aop.framework)
invoke:215, JdkDynamicAopProxy (org.springframework.aop.framework)
findByFirstName:-1, $Proxy44 (com.sun.proxy)
run:65, AccessingDataMongodbApplication (com.logbasex.accessingdatamongodb)
callRunner:777, SpringApplication (org.springframework.boot)
callRunners:761, SpringApplication (org.springframework.boot)
run:310, SpringApplication (org.springframework.boot)
run:1312, SpringApplication (org.springframework.boot)
run:1301, SpringApplication (org.springframework.boot)
main:34, AccessingDataMongodbApplication (com.logbasex.accessingdatamongodb)
```

Vào một tuần sau khi lỗ hổng được report (20/06/2022), Spring Boot framework tung ra hai bản vá mới cho `spring-data-mongodb` dependency là `v3.3.6`  và `v3.4.2`. 
Vậy chúng ta hãy cùng xem source code đã thay đổi như thế nào nhé.

![image.png](https://images.viblo.asia/1359c7d3-a2f9-405f-ba59-d88dd3ee0dec.png)

Biến `expression` không còn mang giá trị cũ nữa:  `#_QVar0`, qua đó thì lỗ hổng đã được vá.

![image.png](https://images.viblo.asia/79a860dc-327f-4d1c-a63e-9d66fd953bd4.png)

Fixed commit:
![image.png](https://images.viblo.asia/bd8210ac-e765-41dc-81f1-74ef94a95e7e.png)

![image.png](https://images.viblo.asia/51b64d53-e7d9-4e42-93ad-fc9befb971ee.png)

![image.png](https://images.viblo.asia/f6f7cc48-a267-4b05-843a-a2cd19cb462e.png)

## 4. Workaround
1. Sử dụng parameter array syntax: 
    ```
    @Query("{ 'firstName' : ?#{?[0]} }")
    Customer findByFirstName(String firstName);
    ```
2. Sử dụng custom repository.

## 5. Demo
![](https://images.viblo.asia/450a2c1e-803b-4531-addb-dc3423c61be2.gif)

## 6. References
1. [Spring Data MongoDB SpEL Expression Injection Vulnerability (CVE-2022-22980)](https://spring.io/blog/2022/06/20/spring-data-mongodb-spel-expression-injection-vulnerability-cve-2022-22980)
2. [CVE-2022-22980: Spring Data MongoDB SpEL Expression injection vulnerability through annotated repository query methods](https://tanzu.vmware.com/security/cve-2022-22980)
3. [PoC CVE-2022-22980](https://github.com/trganda/CVE-2022-22980)
4. [[CVE-2022-22980] Spring Data MongoDB SpEL Expression injection](https://github.com/murataydemir/CVE-2022-22980)
5. [Code difference between vulnerable version and fixed version](https://github.com/spring-projects/spring-data-mongodb/commit/30a417d810c43dd097e117beb24ca49074c5b04d?diff=split)

```
 ____________________
< Thanks for reading >
 --------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     |
```