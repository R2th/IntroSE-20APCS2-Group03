# 1. Giới thiệu
CVE-2019-8942 lợi dụng lỗi hổng LFI + File Upload để thực hiện RCE đến máy chủ web với quyền author. Phiên bản bị ảnh hưởng bao gồm trước 4.9.9 và từ 5.0.0 đến 5.0.1.

Tại các phiên bản này  hàm `wp_update_post` lấy trực tiếp biến `$post_data` mà không cần kiểm tra các trường dữ liệu không được phép. Do đó, người dùng với quyền author có thể thay đổi dữ liệu của bài đăng bằng cách ghi đè tham số `meta_input` và thực hiện khai thác.
![](https://images.viblo.asia/4fdc74b2-0c65-4541-a20e-8ce6c842f127.png)

# 2. Setup môi trường
##  Bước 1. Tải phiên bản
### Phiên bản Wordpress 4.9.8
Các bạn có thể tải về [tại đây](https://wordpress.org/download/releases/)

Tiến hành cài đặt bình thường:
![](https://images.viblo.asia/c68aaa48-b260-48bf-88b6-72ee265bf087.png)

Thực hiện tạo database:

![](https://images.viblo.asia/6cd63d5c-482e-448c-bbc2-04461c632bd2.png)

Trước khi install wordpress, ta thêm 2 dòng sau vào wp-config.php:
```
define('AUTOMATIC_UPDATER_DISABLED',true);
define('WP_AUTO_UPDATE_CORE',false);
```

Thực hiện install:
![](https://images.viblo.asia/8404aa27-ea4d-4349-ae26-5762beeee320.png)

### Kiểm tra phiên bản
![](https://images.viblo.asia/f4c8cb84-5bdd-4d4d-afca-33d33bee14a2.png)

## Bước 2.Tạo user quyền author
 ![](https://images.viblo.asia/afb0a636-2d4b-4f6e-b3ea-b53234348160.png)

#  2. Khai thác và phân tích:
## Bước 1.Tạo hình ảnh chứa mã khai thác
Ở đây mình sử dụng exiftool để truyền mã php vào:

gõ lệnh
```
exiftool ISP.jpg -documentname="<?php phpinfo(); ?>"
```
![](https://images.viblo.asia/4096231d-2d65-4fc5-80f9-737785501255.png)

## Bước 2. Tải tệp hình ảnh:
Vào Media -> Add New để tải ảnh lên. 

Chọn hình ảnh đã tải lên và nhấp vào Edit more details- Update.

Sau khi tải ảnh lên, ảnh sẽ được chứa trong thư mục: wp-content/uploads

Việc tải ảnh lên sẽ gọi đến hàm `wp_insert_post()`. kiểm tra trong source code `/wp-admin/includes/post.php` tại dòng 3526 ta có:

Hàm  `wp_insert_post()` lấy hầu hết các biến `$post_data` mà không kiểm tra trong đó có `meta_input`. Để thực hiện khai thác, ta sẽ chèn thêm tham số `meta_input[_wp_attached_file]`, đây là tham số nhằm thay đổi một tên tệp bất kỳ. Tên tệp này sẽ được gọi khi một yêu cầu chỉnh sửa hình ảnh được gửi đến server (ta sẽ thực hiện ở bước sau). Thực hiện thêm như sau `&meta_input[_wp_attached_file]=2021/05/ISP.jpg#/../../../../themes/twentyseventeen/ISP.jpg` vào `/wp-admin/post.php` ta được:
![](https://images.viblo.asia/d4e19f54-9c0f-4497-b299-cedadafc740e.png)


Kiểm tra trong database sẽ thấy dữ liệu đã được cập nhật.
![](https://images.viblo.asia/5e72c977-27f0-4245-a20a-9ff54d98fd25.png)

##  Bước 3. Sử dụng chức năng cắt ảnh wp_crop_image()
Chức năng `wp_crop_image()` sẽ cố gắng truy xuất 1 hình ảnh thông qua` get_attached_file` để thực hiện việc xử lí ảnh:
 ![](https://images.viblo.asia/e65d64dc-8b88-4c8e-8e37-b6b3b14dac06.png)

![](https://images.viblo.asia/5c509c3d-ccb0-4c5c-9783-53a9a9cc3bfb.png)

Máy chủ truy xuất thông tin qua 2 phương thức là: thông qua tập tin gốc và thông qua HTTP URL.

Tuy nhiên khi ta thay đổi đường dẫn thì giá trị truy xuất tập tin gốc là: `/wp-content/uploads/2021/05/ISP.jpg#/../../../../themes/twentyseventeen/ISP.jpg` không tồn tại.

Do đó mà máy chủ sẽ sử dụng phương thức thứ hai là truy xuất thông qua HTTP URL.
Giá trị truy xuất sẽ là `/wp-content/uploads/2021/05/ISP.jpg#/../../../../themes/twentyseventeen/ISP.jpg` .  Giá trị này hợp lệ vì với URL trên thì phần sau ký tự ? sẽ được bỏ qua.


Thực hiện:
Đi tới Media và chọn hình ảnh đã tải lên.

Bấm Edit Image để cắt hình ảnh và sau đó bấm vào Save.

Kiểm tra trong Burp, bạn sẽ thấy một yêu cầu POST `/wp-admin/admin-ajax.php`. Ta sẽ thực hiện gửi lại yêu cầu. Khi đó phản hồi có dạng:
![](https://images.viblo.asia/29726e90-784f-461f-b082-2c0670bc7e7e.png)

Phân tích: 
 Sau khi thực hiện crop ảnh, máy chủ sẽ thực hiện lưu ảnh. Tuy nhiên sau khi cắt máy chủ không còn sử dụng hai phương thức truy xuất vị trí tệp hoặc tên tệp như trên mà mặc định sử dụng tên tệp cục bộ như giá trị gốc truyền vào từ `meta_input[_wp_attached_file] là wp-content/uploads/2021/05/ISP.jpg#/../../../../themes/twentyseventeen/ISP.jpg` . Điều này dẫn đến lỗ hổng LFI(local file include) có thể được khai thác.
Bởi vì tệp hình ảnh hiện đi kèm với siêu dữ liệu đã sửa đổi, một bản sao với tên được sửa đổi sẽ tự động được lưu trong thư mục `themes/twentyseventeen`. Ta sẽ vào thư mục trong máy để kiểm tra:
 ![](https://images.viblo.asia/6e2424ac-00ab-4767-8d56-a848ce7c9ed3.png)

Như vậy là LFI thành công. Bây giờ ta sẽ POST 1 bài để thực hiện RCE
Nhấp vào Posts -> Add New để tạo một bài viết mới và nhấp vào Publish:
![](https://images.viblo.asia/3bff78ad-0372-482f-bf16-d2e9dc380ad1.png)

Kiểm tra trong Burp, bạn sẽ thấy một yêu cầu POST `/wp-admin/post.php` tương tự như bên dưới
Thêm `&meta_input[_wp_page_template]= [tên bản sao]` và thực hiện gửi:
![](https://images.viblo.asia/1b1310e0-dc78-4895-9d88-e346975ca1e4.png)

Lúc này ta chỉ cần vào xem bài đăng mới là sẽ thấy kết quả của mã PHP được thực thi.
![](https://images.viblo.asia/7d3b2a04-fd02-4d48-acad-111b0645a52b.png)


Vậy là khai thác thành công.

# 3. Kết Luận:
Những lỗ hổng trên nằm tại những nơi mà nếu chỉ khai thác riêng rẽ thì gần như không có nhiều tác động. Tuy nhiên CVE trên đã xâu chuỗi các lỗ hổng lại và tạo nên 1 lỗ hổng vô cùng nguy hiểm.

Tại những phiên bản sau wordpress đã thực hiện loại bỏ Loại bỏ các tham số đầu vào như `meta_input,file,… `
Đồng thời có đoạn mã kiểm tra nếu đầu vào có tồn tại `../` hoặc`..` hay không.
=> Điều này đã vá thành công CVE-2019-8942.

Cuối cùng hãy luôn cập nhật cài đặt WordPress của bạn lên phiên bản mới nhất để đảm bảo an toàn nhé.