![](https://images.viblo.asia/cc6a0668-895c-4a12-abde-09c3325a69a3.png)

NoOne lÃ  bÃ i crypto Ä‘áº§u tiÃªn vá» 100 Ä‘iá»ƒm trong vÃ²ng loáº¡i SV ATTT 2021. BÃ i nÃ y cÃ³ sá»± pha trá»™n giá»¯a web vÃ  crypto, cÅ©ng yÃªu cáº§u ngÆ°á»i chÆ¡i cáº§n cÃ³ kháº£ nÄƒng Ä‘á»c Ä‘Æ°á»£c code Python vÃ  hiá»ƒu Ä‘Æ°á»£c luá»“ng xá»­ lÃ½ cá»§a web.

ChÃ­nh vÃ¬ cáº§n cÃ³ sá»± hiá»ƒu biáº¿t cÆ¡ báº£n vá» cáº£ 2 máº£ng web vÃ  crypto, nÃªn nhiá»u báº¡n tháº¥y cÃ¡i lÃ  quay xe luÃ´n ğŸ˜…ğŸ˜‚. Sau cuá»™c thi, khi mÃ¬nh Ä‘Æ°a bÃ i cho 1 sá»‘ báº¡n lÃ m thÃ¬: cÃ¡c báº¡n chá»‰ hay chÆ¡i crypto nhÃ¬n khÃ´ng hiá»ƒu gÃ¬, cÃ¡c báº¡n chá»‰ táº­p trung chÆ¡i máº£ng web thÃ¬ khÃ´ng biáº¿t giáº£i tháº¿ nÃ o.

Tuy nhiÃªn bÃ i nÃ y khÃ´ng há» khÃ³, chá»‰ á»Ÿ má»©c dá»… cá»§a web vÃ  dá»… cá»§a crypto thÃ´i.

# 1. PhÃ¢n tÃ­ch bÃ i
Äá» bÃ i chá»‰ cho Ä‘Æ°á»ng link Ä‘áº¿n 1 trang web vá»›i giao diá»‡n gá»“m 2 chá»©c nÄƒng cÆ¡ báº£n lÃ : **Ä‘Äƒng kÃ½** vÃ  **Ä‘Äƒng nháº­p**. Khi Ä‘Äƒng kÃ½ tÃ i khoáº£n cáº§n Ä‘iá»n: username, password vÃ  email.

Sau khi Ä‘Äƒng kÃ½ tÃ i khoáº£n thÃ nh cÃ´ng vÃ  Ä‘Äƒng nháº­p thÃ¬ chÃºng ta sáº½ Ä‘Æ°á»£c tháº¥y giao diá»‡n chÃ­nh cá»§a trang web. Táº¡i Ä‘Ã¢y thá»‰ cÃ³ 2 bÃ i blog dá»±ng táº¡m cho cÃ³, kÃ¨m 1 trang **/about** vÃ  1 trang **/flag**:
- /about: chá»©a source code cá»§a trang web.
- /flag: sáº½ hiá»ƒn thá»‹ flag khi Ä‘Äƒng nháº­p vá»›i quyá»n admin.

NhÆ° váº­y chÃºng ta sáº½ cáº§n phÃ¢n tÃ­ch source code cá»§a trang web, Ä‘á»ƒ tá»« Ä‘Ã³ cÃ³ Ä‘Æ°á»£c quyá»n admin.

Source code cÃ³ thá»ƒ táº£i táº¡i Ä‘Ã¢y: [source code noone](https://drive.google.com/file/d/1NlarbWaUt-DerzE8I-p0rUO-UE2WvIR8/view?usp=sharing)

# 2. PhÃ¢n tÃ­ch source code
Äá»ƒ dá»… theo dÃµi, mÃ¬nh Ä‘Ã£ váº½ láº¡i sÆ¡ Ä‘á»“ cÃ¡c pháº§n cáº§n chÃº Ã½ nhÆ° sau:
- SÆ¡ Ä‘á»“ cÃ¡c bÆ°á»›c Ä‘á»ƒ láº¥y flag:

![](https://images.viblo.asia/96611e64-e579-4c21-8006-798f4ae5a880.png)

- SÆ¡ Ä‘á»“ xá»­ lÃ½ cá»§a Server:

![](https://images.viblo.asia/2ab7bb4e-0708-40ef-908e-5158e488b434.png)

TrÃªn sÆ¡ Ä‘á»“ xá»­ lÃ½ cá»§a Server mÃ¬nh Ä‘Ã£ phÃ¢n tÃ­ch cÃ¡c chá»©c nÄƒng cáº§n phÃ¢n tÃ­ch, cÃ¹ng vá»›i cÃ¡c tham sá»‘, giÃ¡ trá»‹,... CÃ¡c thÃ´ng tin trÃªn sÆ¡ Ä‘á»“ Ä‘á»u Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u mÃ u, chia thÃ nh 3 loáº¡i:
- MÃ u xanh lá»¥c: cÃ¡c giÃ¡ trá»‹ do chÃºng ta nháº­p vÃ o, hoáº·c giÃ¡ trá»‹ chÃºng ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t, thay Ä‘á»•i.
- MÃ u vÃ ng: cÃ¡c giÃ¡ trá»‹ sinh ra do quÃ¡ trÃ¬nh xá»­ lÃ½ cá»§a Server
- MÃ u Ä‘á»: cÃ¡c giÃ¡ trá»‹ do server kiá»ƒm soÃ¡t, chÃºng ta khÃ´ng thá»ƒ thay Ä‘á»•i hay tÃ¡c Ä‘á»™ng vÃ o.

CÃ¡c báº¡n cÃ³ thá»ƒ láº¥y cÃ¡i sÆ¡ Ä‘á»“ nÃ y Ä‘á»ƒ 1 bÃªn, code Ä‘á»ƒ 1 bÃªn. Vá»«a Ä‘á»c code vá»«a nhÃ¬n sÆ¡ Ä‘á»“ thÃ¬ sáº½ dá»… hiá»ƒu hÆ¡n ğŸ˜€.

**Khá»‘i chá»©c nÄƒng Ä‘Äƒng kÃ½:**
```python
ROLE_ADMIN = 0
ROLE_USER = 1

@app.route("/register", methods=('GET', 'POST'))
def register():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        email = request.form['email']
        role = ROLE_USER

        if not username or not password:
            flash('Username and Password is required!')
        else:
            do_register(username, password, email, role)

            return redirect(url_for('login'))

    return render_template('register.html')
    
    
def do_register(username, password, email, role):
    key = base64.b64encode(Random.new().read(AES.block_size))
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute('INSERT INTO users (username, password, email, role, encryptkey ) VALUES (%s, %s, %s, %s, %s)',
                    (username, password, email, role, key))
    conn.commit()
    cur.close()
    conn.close()
```

**Khá»‘i chá»©c nÄƒng Ä‘Äƒng nháº­p:**
```python
@app.route("/", methods=('GET', 'POST'))
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']

        if not username or not password:
            flash('Username and Password is required!')
        else:
            # verify login
            user = verify_login(username, password)

            if not user:
                flash('Username and Password is not correct!')
            else:
                
                userid = user[0]
                username = user[1]
                role = user[5]

                # get key
                key = base64.b64decode(user[4])

                # create authtoken
                usernamebytes = username.encode('utf-8')
                usernamelen = len(usernamebytes)
                plainbytes = len(usernamebytes).to_bytes(2, "little") + usernamebytes + role.to_bytes(1, "little")

                ciphertext = encrypt(plainbytes, key)

                response = make_response(redirect(url_for('index')))

                response.set_cookie('userid', str(userid))
                response.set_cookie('authtoken', ciphertext)

                return response

    return render_template('login.html')
    
def verify_login(username, password):
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute('SELECT id, username, password, email, encryptkey, role from users WHERE username = %s AND password = %s',
                    (username, password))
    user = cur.fetchone()
    
    cur.close()
    conn.close()

    return user
```

**Khá»‘i chá»©c nÄƒng kiá»ƒm tra quyá»n vÃ  Ä‘á»c flag:**
```python
@app.route("/flag")
@login_required
def flag():
    flag = "You are not admin"
    if g.role == ROLE_ADMIN:
        flag = "xxxxxxxxxxxxxxxxxxxxxxx"
    return render_template('flag.html', flag=flag)
    
def login_required(f):
    @wraps(f)
    def wrap(*args, **kwargs):

        try:
        
            ciphertext = request.cookies.get('authtoken')

            userid = request.cookies.get('userid')

            if not ciphertext or not userid:
                return redirect(url_for('login'))

            encryptkey = get_encryptkey(userid)

            plainbytes = decrypt(ciphertext, encryptkey)

            usernamelen = int.from_bytes(plainbytes[:2], "little")
            usernameencoded = plainbytes[2:usernamelen+2]
            username = usernameencoded.decode("utf-8")
            role = plainbytes[usernamelen+2]
            
            g.username = username
            g.role = role

        except:
            abort(401)
        
        return f(*args, **kwargs)
   
    return wrap
```

**Khá»‘i chá»©c nÄƒng mÃ£ hÃ³a:**
```python
# input: bytes, output: base64 text
def encrypt(plainbytes, key):
    
    iv = Random.new().read(AES.block_size)
    
    cipher = AES.new(key, AES.MODE_CFB, iv)
    
    cipherbytes = cipher.encrypt(plainbytes)

    ciphertext = base64.b64encode(iv + cipherbytes)

    return ciphertext


# input: base64 text, output: bytes
def decrypt(ciphertext, key):

    cipherbytes = base64.b64decode(ciphertext)

    iv = cipherbytes[:AES.block_size]

    cipher = AES.new(key, AES.MODE_CFB, iv)

    plainbytes = cipher.decrypt(cipherbytes[AES.block_size:])

    return plainbytes
```

# 3. TÃ¬m hÆ°á»›ng lÃ m
Tá»« cÃ¡c sÆ¡ Ä‘á»“ vÃ  source code, chÃºng ta cÃ³ thá»ƒ phÃ¢n tÃ­ch nhÆ° sau:
- Khi truy cáº­p Ä‘Æ°á»ng dáº«n **/flag**, Server sáº½ thá»±c thi hÃ m **login_required()** Ä‘á»ƒ kiá»ƒm tra quyá»n cá»§a user. Náº¿u lÃ  admin thÃ¬ sáº½ tráº£ vá» **FLAG**.
- Äá»ƒ kiá»ƒm tra quyá»n, Server sáº½ thá»±c hiá»‡n hÃ m **decrypt(ciphertext, key)**. Vá»›i ciphertext lÃ  **authtoken** tráº£ vá» sau khi login thÃ nh cÃ´ng, vÃ  key lÃ  giÃ¡ trá»‹ **encryptkey** láº¥y trong CSDL.
- Do **encryptkey** Ä‘Æ°á»£c sinh ngáº«u nhiÃªn khi Ä‘Äƒng kÃ½ tÃ i khoáº£n, nÃªn chÃºng ta chá»‰ cáº§n quan tÃ¢m tá»›i cÃ¡ch Server táº¡o ra **authtoken**.
- ```python
  plainbytes = len(usernamebytes).to_bytes(2, "little") + usernamebytes + role.to_bytes(1, "little")
  authtoken = encrypt(plainbytes) = encode base64 cá»§a [IV (16 bytes sinh ngáº«u nhiÃªn) + ciphertext (mÃ£ hÃ³a AES mode CFB cá»§a plainbytes)]
- NhÆ° váº­y thÃ¬ quyá»n cá»§a user Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh bá»Ÿi **1 byte cuá»‘i** cá»§a authtoken.
- Do khi Ä‘Äƒng kÃ½ thÃ¬ máº·c Ä‘á»‹nh chÃºng ta Ä‘Æ°á»£c gÃ¡n quyá»n user, nÃªn byte cuá»‘i sáº½ cÃ³ giÃ¡ trá»‹ lÃ  **1**.
- Äá»ƒ cÃ³ quyá»n admin, chÃºng ta cáº§n sá»­a byte cuá»‘i cá»§a **authtoken** tráº£ vá» client tá»« **1** thÃ nh **0**, sao cho server váº«n cÃ³ thá»ƒ giáº£i mÃ£ Ä‘Æ°á»£c authtoken vá»›i khÃ³a mÃ£ hÃ³a lÆ°u trong CSDL (lÆ°u Ã½ lÃ  chÃºng ta khÃ´ng biáº¿t giÃ¡ trá»‹ cá»§a khÃ³a nÃ y, do nÃ³ Ä‘Æ°á»£c sinh ngáº«u nhiÃªn vÃ  lÆ°u trÃªn Server).

HÆ°á»›ng lÃ m Ä‘Ã£ cÃ³ rá»“i, giá» thÃ¬ chÃºng ta sáº½ cáº§n phÃ¢n tÃ­ch vá» thuáº­t toÃ¡n mÃ£ hÃ³a mÃ  Server xá»­ dá»¥ng.

# 4. PhÃ¢n tÃ­ch thuáº­t toÃ¡n mÃ£ hÃ³a
Server sá»­ dá»¥ng thuáº­t toÃ¡n mÃ£ hÃ³a AES mode CFB, cÃ³ cÃ¡c tÃ­nh cháº¥t sau:
- **LÃ  mÃ£ hÃ³a khÃ³a bÃ­ máº­t:** quÃ¡ trÃ¬nh mÃ£ hÃ³a vÃ  giáº£i mÃ£ Ä‘á»u **dÃ¹ng chung khÃ³a**.
- **LÃ  dáº¡ng mÃ£ hÃ³a khá»‘i (block cipher):** dá»¯ liá»‡u Ä‘áº§u vÃ o sáº½ Ä‘Æ°á»£c chia thÃ nh tá»«ng **khá»‘i cÃ³ kÃ­ch thÆ°á»›c Ä‘á»u nhau**, sau Ä‘Ã³ má»›i tiáº¿n hÃ nh xá»­ lÃ½. Äá»‘i vá»›i thuáº­t toÃ¡n AES thÃ¬ cÃ¡c khá»‘i cÃ³ kÃ­ch thÆ°á»›c lÃ  **16 bytes**.
- **Mode CFB**: khá»‘i Ä‘áº§u tiÃªn Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng cÃ¡ch **```Khá»‘i mÃ£ hÃ³a 1 = (IV vÃ  Key) xor (Khá»‘i rÃµ 1)```**. Tá»« khá»‘i thá»© 2 trá»Ÿ Ä‘i Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng cÃ¡ch: **```Khá»‘i mÃ£ hÃ³a thá»© n = (Khá»‘i mÃ£ hÃ³a thá»© n-1 vÃ  Key) xor (Khá»‘i rÃµ thá»© n)```**. Sau khi táº¥t cáº£ cÃ¡c khá»‘i Ä‘Ã£ Ä‘Æ°á»£c mÃ£ hÃ³a xong thÃ¬ sáº½ ghÃ©p cÃ¡c khá»‘i láº¡i thÃ nh báº£n mÃ£ hÃ³a hoÃ n chá»‰nh.  
**QuÃ¡ trÃ¬nh giáº£i mÃ£:** Ä‘Æ°á»£c thá»±c hiá»‡n ngÆ°á»£c láº¡i vá»›i quÃ¡ trÃ¬nh mÃ£ hÃ³a.

HÃ¬nh áº£nh minh há»a mode CFB (*nguá»“n: wikipedia*):

![](https://images.viblo.asia/a16a0810-608b-41df-87d7-9d4c24ef1b61.png)

![](https://images.viblo.asia/76cce55f-e9ad-4aac-99f9-27d30e06339a.png)

# 5. Hecker mode: ON ğŸ˜ğŸ‘¾ğŸ¤–ğŸ’»ğŸ–±ï¸

Quay láº¡i vá»›i bÃ i toÃ¡n cá»§a chÃºng ta, giáº£ sá»­ toÃ n bá»™ Ä‘oáº¡n **```plainbytes = len(usernamebytes).to_bytes(2, "little") + usernamebytes + role.to_bytes(1, "little")```** chá»‰ cÃ³ Ä‘á»™ dÃ i 16 bytes thÃ¬ chÃºng ta sáº½ khÃ´ng bao giá» cáº§n mÃ£ hÃ³a tá»›i block thá»© 2.

Trong Ä‘oáº¡n plainbytes nÃ y thÃ¬ Ä‘Ã£ cá»‘ Ä‘á»‹nh 3 byte (2 bytes Ä‘áº§u tiÃªn lÃ  Ä‘á»™ dÃ i username, 1 byte cuá»‘i lÃ  role user/admin) rá»“i. Chá»‰ cáº§n username cá»§a chÃºng ta gá»“m 13 kÃ½ tá»± thÃ¬ cháº¯c cháº¯n plainbytes  sáº½ cÃ³ Ä‘á»™ dÃ i lÃ  16 bytes, vá»›i 1 byte cuá»‘i xÃ¡c Ä‘á»‹nh role user/admin.

Viá»‡c láº¥y username cÃ³ Ä‘á»™ dÃ i Ä‘Ãºng báº±ng 13 kÃ½ tá»± sáº½ giÃºp chÃºng ta khÃ´ng cáº§n quan tÃ¢m xem thuáº­t toÃ¡n AES sáº½ xá»­ lÃ½ tháº¿ nÃ o khi block cÃ³ Ä‘á»™ dÃ i < 16 bytes.

VÃ¬ chÃºng ta Ä‘Ã£ biáº¿t:
- **Plaintext:** Ä‘Æ°á»£c táº¡o thÃ nh tá»« username, Ä‘á»™ dÃ i username vÃ  role = 1.  
vÃ 
- **Ciphertext:** 16 bytes cuá»‘i cá»§a authtoken sau khi decode base64.

Ta cÃ³:
```
    Ciphertext = (IV vÃ  Key) xor Plaintext
<=> (IV vÃ  Key) = Ciphertext xor Plaintext    (1)
```

Tá»« **(1)** ta cÃ³:
```
    New_Ciphertext = (IV vÃ  Key) xor New_Plaintext
<=> New_Ciphertext = (Ciphertext xor Plaintext) xor New_Plaintext
```

NhÆ° váº­y lÃ  khÃ´ng cáº§n quan tÃ¢m tá»›i IV, khÃ´ng cáº§n quan tÃ¢m tá»›i Key, chÃºng ta cÃ³ thá»ƒ táº¡o ra Ciphertext má»›i, tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i **authtoken má»›i** chá»‰ tá»« nhá»©ng thÃ´ng tin Ä‘Ã£ biáº¿t.

# 6. Láº¥y Flag ğŸš©
Váº­y thÃ¬ chá»‰ cáº§n viáº¿t 1 Ä‘oáº¡n script Ä‘á»ƒ táº¡o ra authtoken má»›i, sau Ä‘Ã³ thay tháº¿ vá»›i giÃ¡ trá»‹ authtoken cÅ© trong cookie cá»§a trang web. Rá»“i táº£i láº¡i trang **/flag** lÃ  chÃºng ta sáº½ cÃ³ cá» cá»§a bÃ i No One.

![](https://images.viblo.asia/9a025d21-1fe3-4f71-a021-15b9816cd195.png)

Script python:
```python
import base64

# Python ngu khÃ´ng trá»±c tiáº¿p xor bytes vá»›i bytes Ä‘Æ°á»£c nÃªn cáº§n viáº¿t 1 hÃ m riÃªng (copy trÃªn máº¡ng vá»)
def bitwise_xor_bytes(a, b):
    result_int = int.from_bytes(a, byteorder="big") ^ int.from_bytes(b, byteorder="big")
    return result_int.to_bytes(max(len(a), len(b)), byteorder="big")
    
authtoken = 'iHVcYuCO7VXUmvo+pb4XTs1NgMF6GhNkP+pCJ4aSYxU='
username  = 'iamabear11111'    # 13 kÃ½ tá»± cho tiá»‡n, gá»™p vÃ o Ä‘á»§ 16 bytes
role      = 1    # role user
new_role  = 0    # role admin

usernamebytes  = username.encode('utf-8')
# Plaintext cÅ© cÃ³ role lÃ  user
plainbytes     = len(usernamebytes).to_bytes(2, "little") + usernamebytes + role.to_bytes(1, "little")
# Plaintext má»›i cÃ³ role lÃ  admin
new_plainbytes = len(usernamebytes).to_bytes(2, "little") + usernamebytes + new_role.to_bytes(1, "little")

# Láº¥y ra IV vÃ  ciphertext
iv     = base64.b64decode(authtoken)[:16]
cipher = base64.b64decode(authtoken)[16:]

key_and_iv    = bitwise_xor_bytes(cipher, plainbytes)
new_cipher    = bitwise_xor_bytes(key_and_iv, new_plainbytes)
new_authtoken = base64.b64encode(iv + new_cipher)
```

Sá»­a cookie vÃ  táº£i láº¡i trang sáº½ cÃ³ Flag lÃ : **ASCIS{z3r0_l0g0n_1s_H3re}**

![](https://images.viblo.asia/61dc35e7-8948-432f-8e68-b6f80dd23298.png)