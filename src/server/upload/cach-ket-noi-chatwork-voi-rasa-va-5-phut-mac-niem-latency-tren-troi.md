**TL;DR**: Code ƒë√¢y. https://github.com/ngoctnq-1957/rasa-chatwork-echo

## M·ªü b√†i
N·∫øu b·∫°n l√† ng∆∞·ªùi ƒëi l√†m chatbot nh∆∞ m√¨nh, ch·∫Øc h·∫≥n b·∫°n ƒë√£ d√πng Rasa. V·ªõi c√°c ∆∞u ƒëi·ªÉm v∆∞·ª£t tr·ªôi nh∆∞ l√† ho√†n to√†n local kh√¥ng s·ª£ m·∫•t th√¥ng tin, m·ªôt dialog handler x·ªãn c√πng c√°c connector (cho d√π b·∫Øt entity h∆°i ngu), Rasa l√† s·ª± l·ª±a ch·ªçn s·ªë 1 c·ªßa c√°c d·ª± √°n c·∫ßn t√≠nh b·∫£o m·∫≠t/hay c·∫ßn m·ªçi th·ª© trong 1 g√≥i. ƒê·ªìng th·ªùi, n·∫øu b·∫°n l√†m ·ªü m·ªôt c√¥ng ty s·ª≠ d·ª•ng Chatwork nh∆∞ m√¨nh, b·∫°n s·∫Ω c·∫ßn t√¨m c√°ch sao cho Chatwork li√™n h·ªá ƒë∆∞·ª£c v·ªõi Rasa ƒë·ªÉ n√≥ c√≥ th·ªÉ thay th·∫ø b·∫°n tr·∫£ l·ªùi tin nh·∫Øn c·ªßa s·∫øp :D V·∫≠y b√†i n√†y m√¨nh s·∫Ω h∆∞·ªõng d√¢n b·∫°n l√†m v·∫≠y nh√©. Bonus th√™m c√°ch l√†m m·ªôt con chatbot chuy√™n ƒëi nh·∫°i l·∫°i ƒë√∫ng l·ªùi b·∫°n n√≥i lu√¥n.

*Ch√∫ th√≠ch: post n√†y s·ª≠ d·ª•ng Rasa<1.8.0 v√¨ n√≥ t∆∞∆°ng th√≠ch v·ªõi TensorFlow 1.x, do kinh nghi·ªám l√† b·∫£n TF2.0 v·∫´n c√≤n n√°t l·∫Øm.*

## C√°ch ƒë·ªÉ Rasa nh·∫°i l·∫°i b·∫°n
ƒê·∫±ng n√†o m√¨nh c≈©ng ph·∫£i x√¢y d·ª±ng m·ªôt con bot c∆° b·∫£n ƒë·ªÉ demo cho c√°c b·∫°n m√†, n√™n ti·ªán m√¨nh gi·ªõi thi·ªáu lu√¥n: h√†nh ƒë·ªông nh·∫°i l·∫°i b·∫°n s·∫Ω ƒë·ªãnh nghƒ©a trong file `actions.py`:

```python
from typing import Any, Text, Dict, List
from rasa_sdk import Action, Tracker
from rasa_sdk.executor import CollectingDispatcher

class ActionHelloWorld(Action):

    def name(self) -> Text:
        return "action_echo"

    def run(self, dispatcher: CollectingDispatcher,
            tracker: Tracker,
            domain: Dict[Text, Any]) -> List[Dict[Text, Any]]:
        
        dispatcher.utter_message(text=tracker.latest_message["text"])

        return []
```

V√† b·∫°n ƒë·ªÉ m·∫∑c ƒë·ªãnh l√† s·∫Ω ch·∫°y action ƒë√≥ trong `config.yml`:

```yaml
policies:
  - name: "FallbackPolicy"
    nlu_threshold: 1.0
    core_threshold: 1.0
    fallback_action_name: 'action_echo'
```

H·∫øt :D

## C√°ch ƒë·ªÉ Rasa k·∫øt n·ªëi v·ªõi Chatwork
### Vi·ªác ƒë·∫ßu ti√™n l√† b·∫°n ƒë·ªãnh nghƒ©a webhook nh·∫≠n tin nh·∫Øn v√†o cho Rasa.
C·∫•u tr√∫c c·ªßa c√°c class extend `InputChannel` c·∫ßn c√≥ c√°c methods sau: b·∫Øt ƒë·∫ßu l√† `name`, s·∫Ω quy·∫øt ƒë·ªãnh webhook URL c·ªßa b·∫°n.
```python
class ChatworkInput(InputChannel):
    @classmethod
    def name(cls) -> Text:
        return "chatwork"
```
V√≠ d·ª• c·ªßa m√¨nh ƒë·ªÉ return `chatwork` th√¨ URL s·∫Ω l√† `/webhooks/chatwork/webhook`.

Ti·∫øp theo l√† method ƒë·ªÉ l·∫•y c√°c settings v·ªÅ token trong file `credentials.yml`. Ph·∫ßn n√†y c≈©ng s·∫Ω ƒë∆∞·ª£c n√≥i sau ·ªü cu·ªëi m·ª•c n√†y.
```python
@classmethod
def from_credentials(cls, credentials):
    if not credentials:
        cls.raise_missing_credentials_exception()
    return cls(credentials.get("api_token"), credentials.get("secret_token"))

def __init__(self, api_token: Text, secret_token: Text) -> None:
    self.api_token = api_token
    self.secret_token = secret_token
```

Ti·∫øp theo l√† m·ªôt method kh√¥ng b·∫Øt bu·ªôc, nh∆∞ng m√¨nh ƒë∆∞a v√†o ƒë·ªÉ g·ª° c√°c lo·∫°i To/Reply kh·ªèi tin nh·∫Øn ƒë·∫ßu v√†o cho n√≥ s·∫°ch.
```python
@staticmethod
def _sanitize_user_message(text):
    """
    Remove all tags.
    """
    for regex, replacement in [
        # to messages
        (r"\[[Tt][Oo]:\d+\]", ""),
        # reply messages
        (r"\[[Rr][Pp] aid=[^]]+\]", ""),
        (r"\[Reply aid=[^]]+\]", ""),
    ]:
        text = re.sub(regex, replacement, text)

    return text.strip()
```

Quan tr·ªçng nh·∫•t trong c√°c ƒëo·∫°n code l√† `blueprint` cho `sanic` server c·ªßa Rasa. Trong ƒë√≥, Rasa y√™u c·∫ßu b·∫°n c·∫ßn implement 2 route ƒë√≥ l√† `/` v·ªõi t√™n method `health`, v√† `webhook` v·ªõi t√™n method `receive`.
```python
def blueprint(
    self, on_new_message: Callable[[UserMessage], Awaitable[None]]
) -> Blueprint:
    custom_webhook = Blueprint("chatwork_webhook", "chatwork"
    )

    @custom_webhook.route("/", methods=["GET"])
    async def health(request: Request) -> HTTPResponse:
        return response.json({"signature_tag": "o' kawaii koto."})
```

ƒê·ªÉ tr√°nh vi·ªác m·ªôt ai ƒë√≥ b·∫Øn request l√°o v√†o webhook c·ªßa b·∫°n (m√† kh√¥ng t·ª´ Chatwork), b·∫°n c·∫ßn ki·ªÉm tra tin nh·∫Øn ƒë√≥ c√≥ ph·∫£i t·ª´ Chatwork kh√¥ng.
```python
def validate_request(request):
    # Check the X-Hub-Signature header to make sure this is a valid request.
    chatwork_signature = request.headers.get('X-ChatWorkWebhookSignature', '')
    signature = hmac.new(base64.b64decode(bytes(self.secret_token, encoding='utf-8')),
                         request.body,
                         hashlib.sha256)
    expected_signature = base64.b64encode(signature.digest())

    return hmac.compare_digest(bytes(chatwork_signature, encoding='utf-8'),
                               expected_signature)
```
V·ªÅ c∆° b·∫£n, header c·ªßa request ƒë∆∞·ª£c g·ª≠i ƒë·∫øn webhook s·∫Ω bao g·ªìm hash c·ªßa n·ªôi dung tin nh·∫Øn, k√Ω v·ªõi secret token c·ªßa b·∫°n. So s√°nh th·∫•y ok l√† ok üëå

V√† t√¢m ƒëi·ªÉm c·ªßa b√†i n√†y ch√≠nh l√† webhook. Code c√≥ m·ªôt s·ªë callback kh√° l√† c∆° b·∫£n th√¥i.
```python
@custom_webhook.route("/webhook", methods=["POST"])
async def receive(request: Request) -> HTTPResponse:

    if not validate_request(request):
        return response.json("you've been a very bad boy!", status=400)

    content = request.json["webhook_event"]

    sender_id = content["from_account_id"]
    room_id = content["room_id"]
    message_id = content["message_id"]
    text = content["body"]
    metadata = {
        "sender_id": sender_id,
        "room_id": room_id,
        "message_id": message_id,
        "text": self._sanitize_user_message(text)
    }

    out_channel = self.get_output_channel(room_id)
    try:
        await on_new_message(
            UserMessage(
                text,
                out_channel,
                sender_id,
                input_channel=room_id,
                metadata=metadata,
            )
        )
    except CancelledError:
        logger.error(
            "Message handling timed out for "
            "user message '{}'.".format(text)
        )
    except Exception:
        logger.exception(
            "An exception occured while handling "
            "user message '{}'.".format(text)
        )
    return response.json("alles gut üëå")

return custom_webhook
```

V√† cu·ªëi c√πng l√† method kh√¥ng b·∫Øt bu·ªôc, d√πng ƒë·ªÉ t·∫°o ra `OutputChannel` ƒë·ªÉ b·∫°n c√≥ th·ªÉ g·ª≠i tr·∫£ l·∫°i tin nh·∫Øn cho ng∆∞·ªùi d√πng.
```python
def get_output_channel(self, room_id) -> OutputChannel:
    return ChatworkOutput(self.api_token, room_id)
```

### Sau ƒë√≥, b·∫°n ƒë·ªãnh nghƒ©a tin nh·∫Øn g·ª≠i tr·∫£ s·∫Ω nh∆∞ th·∫ø n√†o.
```python
class ChatworkOutput(OutputChannel):
    @classmethod
    def name(cls):
        return "chatwork"

    def __init__(self, token_api: Text, room_id: int) -> None:
        self.room_id = room_id
        self.header = {"X-ChatWorkToken": token_api}

    async def send_text_message(
        self, recipient_id: Optional[Text], text: Text, **kwargs: Any
    ) -> None:
        uri = "https://api.chatwork.com/v2/rooms/" + str(self.room_id) + "/messages"
        data = {"body": text}
        requests.post(uri, headers=self.header, data=data)
```
V·ªÅ c∆° b·∫£n, class n√†y ch·ªâ b·∫Øn m·ªôt POST request l√™n server Chatwork theo ƒë√∫ng c√∫ ph√°p v√†o ƒë√∫ng ph√≤ng th√¥i. N·∫øu b·∫°n mu·ªën th√™m m·ªôt ph√°t reply ng∆∞·ªùi g·ª≠i g·ªëc cho ng·∫ßu, h√£y s·ª≠a th√™m nh∆∞ sau:

```python
class ChatworkOutput(OutputChannel):
    @classmethod
    def name(cls):
        return "chatwork"

    def __init__(self,
            token_api: Text,
            sender_id: int,
            room_id: int,
            message_id: int
        ) -> None:
        self.room_id = room_id
        self.sender_id = sender_id
        self.message_id = message_id
        self.header = {"X-ChatWorkToken": token_api}

    async def send_text_message(
        self, recipient_id: Optional[Text], text: Text, **kwargs: Any
    ) -> None:
        uri = "https://api.chatwork.com/v2/rooms/" + str(self.room_id) + "/messages"
        name = 'Ng∆∞·ªùi l·∫°'
        for contact in requests.get("https://api.chatwork.com/v2/contacts",
                                    headers=self.header).json():
            if contact["account_id"] == self.sender_id:
                name = contact["name"]
                break
        text = f'[rp aid={self.sender_id} to={self.room_id}-{self.message_id}]{name}\n' + text
        data = {"body": text}
        requests.post(uri, headers=self.header, data=data)
```

Nh·ªõ thay code t·∫°o `ChatworkOutput` object trong `ChatworkInput` class nh√©.

### Ti·∫øp ƒë·∫øn, b·∫°n c·∫ßn c√†i ƒë·∫∑t c√°c API c·∫ßn thi·∫øt.
C·∫£ 2 ƒë·ªÅu c√≥ th·ªÉ v√†o ƒë∆∞·ª£c t·ª´ m·ª•c API Setting c·ªßa Chatwork:

![](https://images.viblo.asia/ef5cd7a6-6468-4072-8dcb-e085cbce9b4c.png)

V·ªõi API key, nh·∫≠p password v√†o m·ª•c sau v√† b·∫°n s·∫Ω l·∫•y ƒë∆∞·ª£c flag:

![](https://images.viblo.asia/0dcf77d5-c66c-475d-81f6-8c1b82f4062d.png)

C√≤n v·ªõi webhook secret token, click v√†o Webhook v√† t·∫°o m·ªõi m·ªôt m·ª•c:

![](https://images.viblo.asia/6d47af20-6e9b-4e26-a3bb-084166809280.png)

trong ƒë√≥ secret token l√† m·ª•c Token, nh∆∞ ƒë√£ ƒë∆∞·ª£c m√¨nh highlight. Th√™m n·ªØa, b·∫°n c·∫ßn ƒëi·ªÅn v√†o m·ª•c Webhook URL theo nh∆∞ c·∫•u tr√∫c m√¨nh ƒë√£ ƒë·∫∑t trong ·∫£nh. V√≠ d·ª•, n·∫øu b·∫°n ch·∫°y Rasa v√† kh√¥ng c√≥ port proxy pass g√¨ (nh∆∞ v·ªõi `nginx` ch·∫≥ng h·∫°n) th√¨ link ƒë√≥ s·∫Ω l√†

```
https://<server_ip>:5005/webhooks/chatwork/webhook
```

### Cu·ªëi c√πng, b·∫°n c·∫ßn c√†i ƒë·∫∑t c√°c settings v·ªÅ API.
H√£y v√†o file `credentials.yml` v√† th√™m 3 d√≤ng n√†y v√†o d∆∞·ªõi c√πng
```yaml
chatwork_connector.ChatworkInput:
  api_token: "put_your_api_token_here"
  secret_token: "your_secret_token_too"
```
v·ªõi c√°c gi√° tr·ªã token ƒë∆∞·ª£c l·∫•y t·ª´ b∆∞·ªõc tr∆∞·ªõc.

## V√† v·∫•n ƒë·ªÅ c·ªßa Chatwork Webhook
Ch∆∞a k·ªÉ vi·ªác Chatwork ƒë·ªïi theme l√†m m√π m·∫Øt t√¥i ƒëi, th√¨ Chatwork webhook nhi·ªÅu l√∫c ch·∫°y v√¥ c√πng d·ªü. ƒêi·ªÉn h√¨nh l√† vi·ªác m√¨nh ƒë√£ th·ª≠ g·ª≠i m·ªôt tin nh·∫Øn v√† ƒë·∫øn 5' sau th√¨ Rasa m·ªõi nh·∫≠n l√† ƒë·∫øn :(

![](https://images.viblo.asia/c2f7b71d-83b0-434a-bb6f-5868661129a0.png)<br><sub>Sau khi t√¨m l·∫°i ƒë∆∞·ª£c ·∫£nh th√¨ m√¨nh x√°c nh·∫≠n l√† 16' ch·ª© kh√¥ng ph·∫£i 5' nh√©!</sub>

ƒê·ªÉ ch·ª©ng minh ƒë√¢y kh√¥ng ph·∫£i l√† v·∫•n ƒë·ªÅ c·ªßa Rasa hay l√† internet, m√¨nh ƒë√£ th·ª≠ b·∫Øn replay l·∫°i ƒë√∫ng payload c·ªßa Chatwork v√†o c√°i webhook, v√† m·ªçi th·ª© x·∫£y ra b√¨nh th∆∞·ªùng nh∆∞ ch∆∞a h·ªÅ c√≥ cu·ªôc chia ly:

Trong file `chatwork_connector.py` nh∆∞ tr√™n, trong h√†m `receive` c·ªßa Sanic blueprint, b·∫°n h√£y s·ª≠a m·ªôt ch√∫t ƒë·ªÉ l·∫•y ƒë∆∞·ª£c payload c·ªßa Chatwork (5' sau khi b·∫°n g·ª≠i):

```python
async def receive(request: Request) -> HTTPResponse:
    print(request.body.decode('utf-8'))
    print(request.headers.get('X-ChatWorkWebhookSignature', ''))
```

T·ª´ ƒë√≥, b·∫°n ƒë√£ c√≥ payload ƒë·ªÉ replay attack server r·ªìi :D ƒê·ª´ng lo, b·∫°n s·∫Ω kh√¥ng th·ªÉ b·ªã hack nh∆∞ th·∫ø n√†y ngo√†i ƒë·ªùi th·∫≠t ƒë√¢u, v√¨ Chatwork y√™u c·∫ßu HTTPS n√™n s·∫Ω kh√¥ng th·ªÉ c√≥ Man-in-the-Middle (MITM) attack nh∆∞ m√¨nh ƒëang l√†m b√¢y gi·ªù. B·∫≠t Postman l√™n v√† g·ª≠i v√†o webhook URL -- nh·ªõ bao g·ªìm c·∫£ header ƒë·ªÉ tin nh·∫Øn c·ªßa b·∫°n ƒë∆∞·ª£c validate nh√©:

![](https://images.viblo.asia/d6330346-899d-4b05-a51b-b3c0c57dc5b5.png)

M·∫•t c√≥ 1.5s th√¥i nh√© ch·ª© kh√¥ng ph·∫£i 5' ƒë√¢u, bi·∫øt r·ªìi nh√©. M√¨nh c≈©ng b·∫Øn request n√†y t·ª´ m√°y m√¨nh ƒë·∫øn server EC2 d√πng ƒë·ªÉ host con bot n√†y, n√™n kh√¥ng ph·∫£i latency localhost ƒë√¢u.

## K·∫øt lu·∫≠n
N·∫øu b·∫°n c√≥ th·ªÉ, h√£y v·∫≠n ƒë·ªông s·∫øp ƒë·ªïi sang Slack. N·∫øu b·∫°n kh√¥ng th·ªÉ, h√£y c·ªë g·∫Øng cam ch·ªãu v·ªõi n√≥, v√† s·ª≠ d·ª•ng code n√†y ƒë·ªÉ cho cu·ªôc ƒë·ªùi b·∫°n d·ªÖ th·ªü h∆°n m·ªôt t√≠ t·∫πo :D C·∫£m ∆°n b·∫°n ƒë√£ ƒë·ªçc b√†i n√†y, v√† ch√∫c b·∫°n may m·∫Øn.