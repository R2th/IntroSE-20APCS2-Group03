![image.png](https://images.viblo.asia/d4e9f5af-10eb-4cf9-b017-49d1d624bc78.png)

M√¨nh l√† TU·∫§N hi·ªán ƒëang l√† m·ªôt Full-stack Developer t·∫°i Tokyo üòâ.
N·∫øu b·∫°n th·∫•y Blog n√†y hay xin h√£y cho m√¨nh m·ªôt `upvote` v√† `ƒëƒÉng k√Ω` ƒë·ªÉ ·ªßng h·ªô m√¨nh nh√© üòä.

_**Error Handling**_ ƒë·ªÅ c·∫≠p ƒë·∫øn c√°ch **Express** b·∫Øt v√† x·ª≠ l√Ω c√°c l·ªói x·∫£y ra **synchronous** v√† **asynchronous**. **Express** ƒëi k√®m v·ªõi m·ªôt tr√¨nh x·ª≠ l√Ω **L·ªói** m·∫∑c ƒë·ªãnh, v√¨ v·∫≠y b·∫°n kh√¥ng c·∫ßn ph·∫£i vi·∫øt n√≥ ƒë·ªÉ b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng.

Catching Errors
-------

ƒêi·ªÅu quan tr·ªçng l√† ƒë·∫£m b·∫£o r·∫±ng **Express** n·∫Øm b·∫Øt ƒë∆∞·ª£c t·∫•t c·∫£ c√°c l·ªói x·∫£y ra trong khi **route handlers** v√† **middleware** ƒë∆∞·ª£c run.

C√°c l·ªói x·∫£y ra trong code **synchronous** `ƒê·ªìng b·ªô` b√™n trong **route handlers** v√† **middleware** kh√¥ng c·∫ßn th·ª±c hi·ªán th√™m c√¥ng vi·ªác n√†o. N·∫øu code **synchronous** t·∫°o ra l·ªói, th√¨ **Express** s·∫Ω b·∫Øt v√† x·ª≠ l√Ω n√≥. V√≠ d·ª•:

```javascript
app.get('/', (req, res) => {
  throw new Error('BROKEN') // Express will catch this on its own.
})
```
    

ƒê·ªëi v·ªõi c√°c l·ªói tr·∫£ v·ªÅ t·ª´ c√°c h√†m **asynchronous** `B·∫•t ƒë·ªìng b·ªô` ƒë∆∞·ª£c g·ªçi b·ªüi **route handlers** v√† **middleware**, b·∫°n ph·∫£i chuy·ªÉn ch√∫ng cho h√†m `next()`, n∆°i **Express** s·∫Ω b·∫Øt v√† x·ª≠ l√Ω ch√∫ng. V√≠ d·ª•:

```javascript
app.get('/', (req, res, next) => {
  fs.readFile('/file-does-not-exist', (err, data) => {
    if (err) {
      next(err) // Pass errors to Express.
    } else {
      res.send(data)
    }
  })
})
```
    

B·∫Øt ƒë·∫ßu v·ªõi **Express 5**, c√°c **route handlers** v√† **middleware** tr·∫£ v·ªÅ m·ªôt `Promise` s·∫Ω t·ª± ƒë·ªông g·ªçi `next(value)` khi ch√∫ng b·ªã `reject` ho·∫∑c `g·∫∑p l·ªói`. V√≠ d·ª•:

```javascript
app.get('/user/:id', async (req, res, next) => {
  const user = await getUserById(req.params.id)
  res.send(user)
})
```
    

N·∫øu `getUserById` n√©m l·ªói ho·∫∑c `reject`, `next` s·∫Ω ƒë∆∞·ª£c g·ªçi v·ªõi `l·ªói` ƒë√£ n√©m ho·∫∑c `value` b·ªã `reject`. N·∫øu kh√¥ng cung c·∫•p `value` b·ªã `reject`, `next` s·∫Ω ƒë∆∞·ª£c g·ªçi v·ªõi ƒë·ªëi t∆∞·ª£ng `L·ªói` m·∫∑c ƒë·ªãnh do **Router Express** cung c·∫•p.

N·∫øu b·∫°n chuy·ªÉn b·∫•t k·ª≥ th·ª© g√¨ v√†o h√†m `next()` (ngo·∫°i tr·ª´ string `'route'`), **Express** coi **request** hi·ªán t·∫°i l√† m·ªôt `l·ªói` v√† s·∫Ω b·ªè qua m·ªçi **route handlers** v√† **middleware** ti·∫øp theo v√† t·ªõi th·∫≥ng x·ª≠ l√Ω l·ªói.

N·∫øu l·ªánh `callback` trong m·ªôt chu·ªói kh√¥ng cung c·∫•p d·ªØ li·ªáu, ch·ªâ c√≥ l·ªói, b·∫°n c√≥ th·ªÉ ƒë∆°n gi·∫£n h√≥a code n√†y nh∆∞ sau:

```js
app.get('/', [
  function (req, res, next) {
    fs.writeFile('/inaccessible-path', 'data', next)
  },
  function (req, res) {
    res.send('OK')
  }
])
```
    

Trong v√≠ d·ª• tr√™n `next` ƒë∆∞·ª£c cung c·∫•p d∆∞·ªõi d·∫°ng `callback` cho `fs.writeFile`, ƒë∆∞·ª£c g·ªçi c√≥ ho·∫∑c kh√¥ng c√≥ l·ªói. N·∫øu kh√¥ng c√≥ l·ªói, tr√¨nh x·ª≠ l√Ω th·ª© hai s·∫Ω ƒë∆∞·ª£c th·ª±c thi, ng∆∞·ª£c l·∫°i **Express** s·∫Ω b·∫Øt v√† x·ª≠ l√Ω l·ªói.

B·∫°n ph·∫£i b·∫Øt l·ªói x·∫£y ra trong code **asynchronous** ƒë∆∞·ª£c g·ªçi b·ªüi `route handlers` ho·∫∑c `middleware` v√† chuy·ªÉn ch√∫ng cho **Express** ƒë·ªÉ x·ª≠ l√Ω. V√≠ d·ª•:

```js
app.get('/', (req, res, next) => {
  setTimeout(() => {
    try {
      throw new Error('BROKEN')
    } catch (err) {
      next(err)
    }
  }, 100)
})
```
    

V√≠ d·ª• tr√™n s·ª≠ d·ª•ng m·ªôt kh·ªëi `try...catch` ƒë·ªÉ b·∫Øt l·ªói trong code `asynchronous` v√† chuy·ªÉn ch√∫ng cho `Express`. N·∫øu kh·ªëi `try...catch` ƒë∆∞·ª£c b·ªè qua, `Express` s·∫Ω kh√¥ng b·∫Øt l·ªói v√¨ n√≥ kh√¥ng ph·∫£i l√† m·ªôt ph·∫ßn c·ªßa code x·ª≠ l√Ω `synchronous`.

S·ª≠ d·ª•ng c√°c **`promise`** ƒë·ªÉ thay th·∫ø cho kh·ªëi `try...catch` ho·∫∑c khi s·ª≠ d·ª•ng c√°c h√†m tr·∫£ v·ªÅ `promise`. V√≠ d·ª•:

```javascript
app.get('/', (req, res, next) => {
  Promise.resolve().then(() => {
    throw new Error('BROKEN')
  }).catch(next) // Errors will be passed to Express.
})
```
    

V√¨ c√°c **promise** t·ª± ƒë·ªông b·∫Øt c·∫£ l·ªói `synchronous` v√† c√°c **promise** b·ªã `reject`, b·∫°n c√≥ th·ªÉ ch·ªâ c·∫ßn cung c·∫•p l√†m `next` tr√¨nh x·ª≠ l√Ω b·∫Øt cu·ªëi c√πng v√† **Express** s·∫Ω b·∫Øt l·ªói, v√¨ tr√¨nh x·ª≠ l√Ω b·∫Øt ƒë∆∞·ª£c cung c·∫•p l·ªói l√†m ƒë·ªëi s·ªë ƒë·∫ßu ti√™n.

B·∫°n c≈©ng c√≥ th·ªÉ s·ª≠ d·ª•ng m·ªôt chu·ªói c√°c tr√¨nh x·ª≠ l√Ω ƒë·ªÉ d·ª±a v√†o vi·ªác b·∫Øt l·ªói `synchronous`, b·∫±ng c√°ch gi·∫£m code `asynchronous` th√†nh m·ªôt c√°i g√¨ ƒë√≥ nh·ªè. V√≠ d·ª•:

```javascript
app.get('/', [
  function (req, res, next) {
    fs.readFile('/maybe-valid-file', 'utf-8', (err, data) => {
      res.locals.data = data
      next(err)
    })
  },
  function (req, res) {
    res.locals.data = res.locals.data.split(',')[1]
    res.send(res.locals.data)
  }
])
```
    

V√≠ d·ª• tr√™n s·ª≠ d·ª•ng c√¢u l·ªánh ph·ªï bi·∫øn t·ª´ ƒë·ªëi t∆∞∆°ng `readFile`. N·∫øu `readFile` g√¢y ra l·ªói, th√¨ n√≥ s·∫Ω chuy·ªÉn l·ªói cho **Express**, n·∫øu kh√¥ng, b·∫°n s·∫Ω nhanh ch√≥ng quay l·∫°i `Global Error Handling synchronous` trong tr√¨nh x·ª≠ l√Ω ti·∫øp theo trong chu·ªói. Sau ƒë√≥, n√≥ s·∫Ω c·ªë g·∫Øng x·ª≠ l√Ω d·ªØ li·ªáu. N·∫øu ƒëi·ªÅu n√†y kh√¥ng th√†nh c√¥ng th√¨ tr√¨nh `Error Handling synchronous` s·∫Ω b·∫Øt n√≥. N·∫øu b·∫°n ƒë√£ th·ª±c hi·ªán qu√° tr√¨nh x·ª≠ l√Ω n√†y b√™n trong l·ªánh `readFile` **callback** th√¨ ·ª©ng d·ª•ng c√≥ th·ªÉ tho√°t v√† tr√¨nh `Error Handling Express` s·∫Ω kh√¥ng ch·∫°y.

Cho d√π b·∫°n s·ª≠ d·ª•ng h√†m n√†o, n·∫øu b·∫°n mu·ªën c√°c tr√¨nh `Error Handling Express` ƒë∆∞·ª£c g·ªçi ƒë·∫øn v√† ·ª©ng d·ª•ng v·∫´n c√≥ th·ªÉ t·ªìn t·∫°i, b·∫°n ph·∫£i ƒë·∫£m b·∫£o r·∫±ng `Express` nh·∫≠n ƒë∆∞·ª£c l·ªói.
> ƒêo·∫°n n√†y gi·∫£i th√≠ch h∆°i kh√≥ hi·ªÉu nh∆∞ng ko sao b·∫°n ƒë·ªçc h·∫øt b√†i n√†y s·∫Ω hi·ªÉu ƒëo·∫°n n√†y m√¨nh mu·ªën n√≥i g√¨.

Default Error handler
------------------------

**Express** t√≠ch h·ª£p m·ªôt tr√¨nh x·ª≠ l√Ω `l·ªói` gi√∫p x·ª≠ l√Ω m·ªçi l·ªói c√≥ th·ªÉ g·∫∑p ph·∫£i trong ·ª©ng d·ª•ng. `Middleware function Error Handling` m·∫∑c ƒë·ªãnh n√†y ƒë∆∞·ª£c th√™m v√†o cu·ªëi ngƒÉn x·∫øp `Middleware`.

N·∫øu b·∫°n chuy·ªÉn m·ªôt l·ªói ƒë·∫øn `next()` v√† b·∫°n kh√¥ng x·ª≠ l√Ω n√≥ trong m·ªôt tr√¨nh x·ª≠ l√Ω `l·ªói` t√πy ch·ªânh, n√≥ s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi tr√¨nh x·ª≠ l√Ω `l·ªói` t√≠ch h·ª£p s·∫µn; l·ªói s·∫Ω ƒë∆∞·ª£c ghi cho `Client` v·ªõi `Stack Trace`. **Stack Trace** kh√¥ng ƒë∆∞·ª£c cung c·∫•p trong m√¥i tr∆∞·ªùng `production environment`.

ƒê·∫∑t bi·∫øn m√¥i tr∆∞·ªùng `NODE_ENV`th√†nh `production`, ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng ·ªü ch·∫ø ƒë·ªô `production environment`.

Khi m·ªôt l·ªói ƒë∆∞·ª£c ghi, th√¥ng tin sau s·∫Ω ƒë∆∞·ª£c th√™m v√†o `response`:

*   ƒê·∫∑t `res.statusCode` t·ª´ `err.status` (ho·∫∑c `err.statusCode`). N·∫øu `value` n√†y n·∫±m ngo√†i ph·∫°m vi `4xx` ho·∫∑c `5xx`, n√≥ s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t th√†nh 500.
*   ƒê·∫∑t `res.statusMessage` theo code tr·∫°ng th√°i.
*   Ph·∫ßn n·ªôi dung s·∫Ω l√† `HTML` c·ªßa th√¥ng b√°o code tr·∫°ng th√°i khi ·ªü trong m√¥i tr∆∞·ªùng `production`, n·∫øu kh√¥ng s·∫Ω l√† `err.stack`.
*   B·∫•t k·ª≥ headers n√†o ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh trong m·ªôt ƒë·ªëi t∆∞·ª£ng `err.headers`.

N·∫øu b·∫°n g·ªçi `next()` g·∫∑p l·ªói sau khi b·∫Øt ƒë·∫ßu `response` (v√≠ d·ª•: n·∫øu b·∫°n g·∫∑p l·ªói khi truy·ªÅn `response` t·ªõi `Client`), tr√¨nh x·ª≠ l√Ω `l·ªói` m·∫∑c ƒë·ªãnh **Express** s·∫Ω ƒë√≥ng k·∫øt n·ªëi v√† kh√¥ng th·ª±c hi·ªán ƒë∆∞·ª£c **request**.

V√¨ v·∫≠y, khi b·∫°n th√™m tr√¨nh x·ª≠ l√Ω `l·ªói` t√πy ch·ªânh, b·∫°n ph·∫£i ·ªßy quy·ªÅn cho tr√¨nh x·ª≠ l√Ω `l·ªói` **Express** m·∫∑c ƒë·ªãnh, khi c√°c **headers** ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn **Client**:

```javascript
function errorHandler (err, req, res, next) {
  if (res.headersSent) {
    return next(err)
  }
  res.status(500)
  res.render('error', { error: err })
}
```
    

L∆∞u √Ω r·∫±ng tr√¨nh x·ª≠ l√Ω `l·ªói` m·∫∑c ƒë·ªãnh c√≥ th·ªÉ ƒë∆∞·ª£c k√≠ch ho·∫°t n·∫øu b·∫°n g·ªçi `next()` nhi·ªÅu l·∫ßn v·ªõi l·ªói trong code c·ªßa m√¨nh, ngay c·∫£ khi c√≥ s·∫µn `middleware Error Handling` t√πy ch·ªânh.

Vi·∫øt m·ªôt tr√¨nh x·ª≠ l√Ω `L·ªói`
--------------------

X√°c ƒë·ªãnh c√°c `Middleware function Error Handling` theo c√°ch t∆∞∆°ng t·ª± nh∆∞ c√°c `Middleware function` kh√°c, ngo·∫°i tr·ª´ c√°c `function Error Handling` c√≥ b·ªën ƒë·ªëi s·ªë thay v√¨ ba. V√≠ d·ª•:`(err, req, res, next)`.

```javascript
app.use((err, req, res, next) => {
  console.error(err.stack)
  res.status(500).send('Something broke!')
})
```
    

B·∫°n x√°c ph·∫£i khai b√°o `middleware Error Handling` cu·ªëi c√πng, sau c√°c vi·ªác g·ªçi c√°c `app.use()` kh√°c v√† `Router`; V√≠ d·ª•:

```javascript
const bodyParser = require('body-parser')
const methodOverride = require('method-override')

app.use(bodyParser.urlencoded({
  extended: true
}))
app.use(bodyParser.json())
app.use(methodOverride())
app.use((err, req, res, next) => {
  // logic
})
```
    

`Response` t·ª´ b√™n trong m·ªôt **Middleware function** c√≥ th·ªÉ ·ªü b·∫•t k·ª≥ ƒë·ªãnh d·∫°ng n√†o, ch·∫≥ng h·∫°n nh∆∞ trang l·ªói `HTML`, th√¥ng b√°o ƒë∆°n gi·∫£n ho·∫∑c l√† m·ªôt `string JSON`.

ƒê·ªëi v·ªõi `organizational` (v√† framework c·∫•p cao h∆°n - `higher-level framework`), b·∫°n c√≥ th·ªÉ x√°c ƒë·ªãnh m·ªôt s·ªë `Middleware function Error Handling`, gi·ªëng nh∆∞ c√°ch b·∫°n l√†m vi·ªác v·ªõi c√°c `Middleware function` th√¥ng th∆∞·ªùng. V√≠ d·ª•: ƒë·ªÉ x√°c ƒë·ªãnh m·ªôt tr√¨nh x·ª≠ l√Ω `l·ªói` cho c√°c `request` ƒë∆∞·ª£c th·ª±c hi·ªán b·∫±ng c√°ch s·ª≠ d·ª•ng `XHR` v√† nh·ªØng `request` kh√¥ng c√≥:

```javascript
const bodyParser = require('body-parser')
const h√†mOverride = require('h√†m-override')

app.use(bodyParser.urlencoded({
  extended: true
}))
app.use(bodyParser.json())
app.use(h√†mOverride())
app.use(logErrors)
app.use(clientErrorHandler)
app.use(errorHandler)
```
    

Trong v√≠ d·ª• n√†y, th√¥ng tin chung `logErrors` c√≥ th·ªÉ ghi `request` v√† th√¥ng tin l·ªói `stderr`, v√≠ d·ª•:

```javascript
function logErrors (err, req, res, next) {
  console.error(err.stack)
  next(err)
}
```
    

C≈©ng trong v√≠ d·ª• n√†y, `clientErrorHandler` ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a nh∆∞ sau: L·ªói ƒë∆∞·ª£c chuy·ªÉn m·ªôt c√°ch r√µ r√†ng cho l·ªói ti·∫øp theo.

L∆∞u √Ω r·∫±ng khi _kh√¥ng_ g·ªçi `next` trong m·ªôt h√†m `Error Handling`, b·∫°n c√≥ tr√°ch nhi·ªám ph·∫£i vi·∫øt (v√† k·∫øt th√∫c) `response`. N·∫øu kh√¥ng, nh·ªØng `request` ƒë√≥ s·∫Ω "**`treo`**" v√† d·∫ßn d·∫ßn s·∫Ω tr√†n b·ªô nh·ªõ :D.

```javascript
function clientErrorHandler (err, req, res, next) {
  if (req.xhr) {
    res.status(500).send({ error: 'Something failed!' })
  } else {
    next(err)
  }
}
```
    

Implement function "`catch-all`" c√≥ t√™n `errorHandler` nh∆∞ sau (v√≠ d·ª•):

```python
function errorHandler (err, req, res, next) {
  res.status(500)
  res.render('error', { error: err })
}
```
    

N·∫øu b·∫°n c√≥ m·ªôt tr√¨nh x·ª≠ l√Ω `Route` v·ªõi nhi·ªÅu h√†m `callback`, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng tham s·ªë `route` ƒë·ªÉ chuy·ªÉn sang tr√¨nh x·ª≠ l√Ω tuy·∫øn ti·∫øp theo. V√≠ d·ª•:

```javascript
app.get('/a_route_behind_paywall',
  (req, res, next) => {
    if (!req.user.hasPaid) {
      // continue handling this request
      next('route')
    } else {
      next()
    }
  }, (req, res, next) => {
    PaidContent.find((err, doc) => {
      if (err) return next(err)
      res.json(doc)
    })
  })

app.get('/a_route_behind_paywall',
  (req, res, next) => {
    // N·∫øu ko c√≥ next('route') th√¨ route n√†y s·∫Ω ko bao gi·ªù ƒë∆∞·ª£c th·ª±c thi
    next()
  })
```
    

Trong v√≠ d·ª• n√†y, tr√¨nh x·ª≠ l√Ω `getPaidContent` s·∫Ω b·ªã b·ªè qua nh∆∞ng b·∫•t k·ª≥ tr√¨nh x·ª≠ l√Ω n√†o c√≤n l·∫°i trong `app` x·ª≠ l√Ω cho `Route` cho `/a_route_behind_paywall` s·∫Ω ti·∫øp t·ª•c ƒë∆∞·ª£c th·ª±c thi.

Vi·ªác g·ªçi ƒë·∫øn `next()` v√† `next(err)` cho bi·∫øt r·∫±ng tr√¨nh x·ª≠ l√Ω hi·ªán t·∫°i ƒë√£ ho√†n t·∫•t v√† ·ªü giai ƒëo·∫°n n√†o. `next(err)` s·∫Ω b·ªè qua t·∫•t c·∫£ c√°c tr√¨nh x·ª≠ l√Ω c√≤n l·∫°i trong chu·ªói ngo·∫°i tr·ª´ nh·ªØng tr√¨nh x·ª≠ l√Ω ƒë∆∞·ª£c thi·∫øt l·∫≠p ƒë·ªÉ `Error Handling` nh∆∞ ƒë∆∞·ª£c m√¥ t·∫£ ·ªü tr√™n.

Roudup
-------
Nh∆∞ m·ªçi khi, m√¨nh hy v·ªçng b·∫°n th√≠ch b√†i vi·∫øt n√†y v√† h·ªçc th√™m ƒë∆∞·ª£c ƒëi·ªÅu g√¨ ƒë√≥ m·ªõi.

C·∫£m ∆°n v√† h·∫πn g·∫∑p l·∫°i c√°c b·∫°n trong nh·ªØng b√†i vi·∫øt ti·∫øp theo! üòç

N·∫øu b·∫°n th·∫•y Blog n√†y hay xin h√£y cho m√¨nh m·ªôt like v√† ƒëƒÉng k√Ω ƒë·ªÉ ·ªßng h·ªô m√¨nh nh√©. Thank you.üòâ

Ref
-----
* https://tuan200tokyo.blogspot.com/2022/11/blog34-error-handling-trong-nodejs.html