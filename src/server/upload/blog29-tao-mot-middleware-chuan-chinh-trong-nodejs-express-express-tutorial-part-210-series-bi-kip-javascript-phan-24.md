![image.png](https://images.viblo.asia/9f0cd74c-2072-4317-b68c-9df0b76b846d.png)

M√¨nh l√† TU·∫§N hi·ªán ƒëang l√† m·ªôt Full-stack Developer t·∫°i Tokyo üòâ.
N·∫øu b·∫°n th·∫•y Blog n√†y hay xin h√£y cho m√¨nh m·ªôt like v√† ƒëƒÉng k√Ω ƒë·ªÉ ·ªßng h·ªô m√¨nh nh√© üòä.

T·ªïng quan
---------

_C√°c_ h√†m `middleware` l√† c√°c h√†m c√≥ quy·ªÅn truy c·∫≠p v√†o ƒë·ªëi t∆∞·ª£ng request (`req`), ƒë·ªëi t∆∞·ª£ng response(`res`) v√† h√†m `next` trong chu tr√¨nh `request-response` c·ªßa ·ª©ng d·ª•ng. H√†m `next` n√†y l√† m·ªôt h√†m trong `Routing Express`, khi ƒë∆∞·ª£c g·ªçi, s·∫Ω th·ª±c thi `middleware` k·∫ø ti·∫øp ngay sau `middleware` hi·ªán t·∫°i trong `stack`.

C√°c h√†m `middleware` c√≥ th·ªÉ th·ª±c hi·ªán c√°c t√°c v·ª• sau:

*   Th·ª±c thi b·∫•t k·ª≥ `logic code` n√†o m√† b·∫°n mu·ªën.
*   Th·ª±c hi·ªán c√°c thay ƒë·ªïi ƒë·ªëi v·ªõi c√°c ƒë·ªëi t∆∞·ª£ng `request` v√† c√°c ƒë·ªëi t∆∞·ª£ng `response`.
*   K·∫øt th√∫c chu k·ª≥ `request-response`.
*   G·ªçi `middleware` ti·∫øp theo trong `call-stack` (ngƒÉn x·∫øp).

N·∫øu h√†m `middleware` hi·ªán t·∫°i kh√¥ng k·∫øt th√∫c chu k·ª≥ `request-response`, n√≥ ph·∫£i g·ªçi h√†m `next()` ƒë·ªÉ chuy·ªÉn quy·ªÅn ƒëi·ªÅu khi·ªÉn cho h√†m `middleware` ti·∫øp theo. N·∫øu kh√¥ng, `request` s·∫Ω b·ªã treo. **(C√°i n√†y r·∫•t quan tr·ªçng n√™n c√°c b·∫°n ch√∫ √Ω nh√©)**

H√¨nh sau cho th·∫•y c√°c ph·∫ßn t·ª≠ c·ªßa h√†m middleware:

![](https://miro.medium.com/max/1042/1*uwNmNlj_t6NSVLULu3R5ug.png)

B·∫Øt ƒë·∫ßu v·ªõi `Express 5`, c√°c h√†m `middleware` tr·∫£ v·ªÅ m·ªôt `Promise` s·∫Ω g·ªçi `next(value)` khi ch√∫ng t·ª´ ch·ªëi ho·∫∑c g·∫∑p l·ªói. H√†m `next` s·∫Ω ƒë∆∞·ª£c g·ªçi v·ªõi `value` b·ªã t·ª´ ch·ªëi ho·∫∑c L·ªói ƒë∆∞·ª£c n√©m ra.

M·ªôt s·ªë v√≠ d·ª• `KINH ƒêI·ªÇN`
------

ƒê√¢y l√† m·ªôt v√≠ d·ª• v·ªÅ ·ª©ng d·ª•ng `Express` ‚Äú`Hello World`‚Äù ƒë∆°n gi·∫£n. Ph·∫ßn c√≤n l·∫°i c·ªßa b√†i vi·∫øt n√†y s·∫Ω gi·ªõi thi·ªáu v√† th√™m ba h√†m `middleware kinh ƒëi·ªÉn`: h√†m ƒë·∫ßu ti√™n ƒë∆∞·ª£c g·ªçi l√† `myLogger` s·∫Ω in m·ªôt th√¥ng b√°o nh·∫≠t k√Ω ƒë∆°n gi·∫£n, m·ªôt c√°i kh√°c ƒë∆∞·ª£c g·ªçi l√† `requestTime` s·∫Ω hi·ªÉn th·ªã d·∫•u th·ªùi gian c·ªßa `request HTTP` v√† h√†m c√≤n l·∫°i ƒë∆∞·ª£c g·ªçi l√† `validateCookies` authentication c√°c `cookie` ƒë∆∞·ª£c g·ª≠i ƒë·∫øn `server`. 

```javascript
const express = require('express')
const app = express()

app.get('/', (req, res) => {
  res.send('Hello World!')
})

app.listen(3000)
```


### H√†m middleware: myLogger

ƒê√¢y l√† m·ªôt v√≠ d·ª• ƒë∆°n gi·∫£n v·ªÅ h√†m `middleware` ƒë∆∞·ª£c g·ªçi l√† ‚Äú`myLogger`‚Äù. H√†m n√†y ch·ªâ in ƒëo·∫°n text ‚Äú`LOGGED`‚Äù khi m·ªôt `request` ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ·ª©ng d·ª•ng. H√†m `middleware` ƒë∆∞·ª£c g√°n cho m·ªôt bi·∫øn c√≥ t√™n `myLogger`.

```javascript
const myLogger = function (req, res, next) {
  console.log('LOGGED')
  next()
}
```


> L∆∞u √Ω ·ªü tr√™n vi·ªác g·ªçi t·ªõi h√†m `next()` n√†y s·∫Ω g·ªçi h√†m `middleware` ti·∫øp theo trong ·ª©ng d·ª•ng. H√†m `next()` kh√¥ng ph·∫£i l√† m·ªôt ph·∫ßn c·ªßa `Node.js` ho·∫∑c `Express API`, nh∆∞ng l√† ƒë·ªëi s·ªë th·ª© ba ƒë∆∞·ª£c chuy·ªÉn cho h√†m `middleware`. H√†m `next()` c√≥ th·ªÉ ƒë∆∞·ª£c ƒë·∫∑t t√™n t√πy √Ω c√≥ th·ªÉ l√† b·∫•t k·ª≥ th·ª© g√¨, nh∆∞ng theo quy ∆∞·ªõc, n√≥ lu√¥n ƒë∆∞·ª£c ƒë·∫∑t t√™n l√† ‚Äú`next`‚Äù. ƒê·ªÉ tr√°nh nh·∫ßm l·∫´n, h√£y lu√¥n s·ª≠ d·ª•ng quy ∆∞·ªõc n√†y.

ƒê·ªÉ s·ª≠ d·ª•ng h√†m `middleware`, h√£y g·ªçi `app.use()` v√† ch·ªâ ƒë·ªãnh h√†m `middleware` l√†m ƒë·ªëi s·ªë. V√≠ d·ª•, ƒëo·∫°n code sau t·∫£i h√†m middleware `myLogger` tr∆∞·ªõc khi `Routing` ƒë·∫øn ƒë∆∞·ªùng d·∫´n g·ªëc (`/`).

```javascript
const express = require('express')
const app = express()

const myLogger = function (req, res, next) {
  console.log('LOGGED')
  next()
}

app.use(myLogger)

app.get('/', (req, res) => {
  res.send('Hello World!')
})

app.listen(3000)
```


M·ªói khi ·ª©ng d·ª•ng nh·∫≠n ƒë∆∞·ª£c m·ªôt `request`, n√≥ s·∫Ω in ƒëo·∫°n text ‚Äú`LOGGED`‚Äù l√™n `terminal`.

> L∆∞u √Ω: Th·ª© t·ª± t·∫£i `middleware` r·∫•t quan tr·ªçng: c√°c h√†m `middleware` ƒë∆∞·ª£c t·∫£i tr∆∞·ªõc c≈©ng ƒë∆∞·ª£c th·ª±c thi tr∆∞·ªõc.

N·∫øu `myLogger` ƒë∆∞·ª£c t·∫£i sau `route` d·∫´n ƒë·∫øn ƒë∆∞·ªùng d·∫´n g·ªëc (`/`), `request` s·∫Ω kh√¥ng bao gi·ªù in ‚Äú`LOGGED`‚Äù, v√¨ `route handler` c·ªßa ƒë∆∞·ªùng d·∫´n g·ªëc ch·∫•m d·ª©t chu k·ª≥ `request-response` tr∆∞·ªõc khi `load` `middleware` `myLogger` :D.

H√†m middleware `myLogger` ch·ªâ ƒë∆°n gi·∫£n l√† in m·ªôt ƒëo·∫°n `text`, sau ƒë√≥ chuy·ªÉn `request` ƒë·∫øn h√†m `middleware` ti·∫øp theo trong ngƒÉn x·∫øp b·∫±ng c√°ch g·ªçi h√†m `next()`.

### H√†m middleware: requestTime

Ti·∫øp theo, ch√∫ng ta s·∫Ω t·∫°o m·ªôt h√†m `middleware` ƒë∆∞·ª£c g·ªçi l√† ‚Äú`requestTime`‚Äù v√† th√™m m·ªôt thu·ªôc t√≠nh ƒë∆∞·ª£c g·ªçi `requestTime` v√†o `ƒë·ªëi t∆∞·ª£ng request`. *ƒê√¢y l√† m·ªôt t√≠nh nƒÉng m·∫°nh m·∫Ω c·ªßa Middleware gi√∫p ta th√™m b·∫•t k·ª≥ `data` g√¨ v√†o `req` v√† `res` v√† c·ª© th·∫ø g·ª≠i n√≥ th√¥ng qua `callback` c·ªßa c√°c `middleware` ti·∫øp theo v√†o th·∫ø l√† d·ªØ li·ªáu c√≥ th·ªÉ ƒëi t·ªõi m·ªçi n·ª£i m√† ch√∫ng ta mu√¥n (Qu√° ƒë·ªânh).*

```javascript
const requestTime = function (req, res, next) {
  req.requestTime = Date.now()
  next()
}
```

·ª®ng d·ª•ng hi·ªán s·ª≠ d·ª•ng h√†m middleware `requestTime`. Ngo√†i ra, h√†m `callback` c·ªßa route (`/`) s·ª≠ d·ª•ng thu·ªôc t√≠nh m√† h√†m `middleware` ƒë√£ th√™m v√†o `req` (`ƒë·ªëi t∆∞·ª£ng request`).

```javascript
const express = require('express')
const app = express()

const requestTime = function (req, res, next) {
  req.requestTime = Date.now()
  next()
}

app.use(requestTime)

app.get('/', (req, res) => {
  let responseText = 'Hello World!<br>'
  responseText += `<small>Requested at: ${req.requestTime}</small>`
  res.send(responseText)
})

app.listen(3000)
```


Khi b·∫°n th·ª±c hi·ªán `request` t·ªõi (`/`), ·ª©ng d·ª•ng hi·ªán hi·ªÉn th·ªã d·∫•u th·ªùi gian `request` c·ªßa b·∫°n trong tr√¨nh duy·ªát.

### H√†m middleware: validateCookies

Cu·ªëi c√πng, ch√∫ng ta s·∫Ω t·∫°o m·ªôt h√†m `middleware` ƒë·ªÉ `validate` c√°c `Cookies` ƒë·∫øn v√† g·ª≠i ph·∫£n h·ªìi `status 400` n·∫øu `cookie` kh√¥ng h·ª£p l·ªá.

ƒê√¢y l√† m·ªôt v√≠ d·ª• v·ªÅ h√†m `validateCookies` v·ªõi m·ªôt `service asynchronous` b√™n ngo√†i. (c·ª© v√≠ d·ª• nh∆∞ m√¨nh d√πng h√†m externallyValidateCookie c·ªßa m·ªôt √¥ng n√†o ƒë·ªë code ho·∫∑c c·ªßa m·ªôt b√™n th·ª© 3 c≈©ng ƒë∆∞·ª£c)

```javascript
async function cookieValidator (cookies) {
  try {
    await externallyValidateCookie(cookies);
    // N·∫øu c√°c b·∫°n mu·ªën ch·∫°y th·ª≠ c√≥ th·ªÉ thay th·∫ø b·∫±ng 1 Promise b·∫•t k·ª≥
    // await new Promise((resolve) => resolve(cookies)); 
  } catch {
throw new Error('Invalid cookies')
  }
}
```


·ªû ƒë√¢y ch√∫ng ta s·ª≠ d·ª•ng middleware `cookie-parser` (n·∫øu b·∫°n ch∆∞a c√†i th√¨ c·ª©: `npm i cookie-parser` l√† s·∫Ω c√†i ƒë·∫∑t ƒë∆∞·ª£c `middleware` n√†y) ƒë·ªÉ ph√¢n t√≠ch c√°c `cookie` ƒë·∫øn t·ª´ ƒë·ªëi t∆∞·ª£ng `req` v√† chuy·ªÉn ch√∫ng ƒë·∫øn h√†m `cookieValidator` c·ªßa ch√∫ng ta. Middleware `validateCookies` tr·∫£ v·ªÅ m·ªôt `Promise` m√† khi b·ªã Reject s·∫Ω t·ª± ƒë·ªông k√≠ch ho·∫°t tr√¨nh `error Handling` c·ªßa ch√∫ng ta.

```javascript
const express = require("express");
const app = express();
const cookieParser = require("cookie-parser");

app.use(cookieParser());

// Hi·ªán t·∫°i m√¨nh MOCK ƒë∆°n gi·∫£n h√†m n√†y nh∆∞ v·∫≠y.
// Trong th·ª±c t·∫ø n√≥ c√≥ th·ªÉ l√† m·ªôt th∆∞ vi·ªán ho·∫∑c m·ªôt c√°i g√¨ g√¨ ƒë·∫•y tr·∫£ v·ªÅ 1 Promoise.v.v.
const externallyValidateCookie = (cookies) => new Promise((resolve) => resolve(cookies));

async function cookieValidator(cookies) {
  try {
    await externallyValidateCookie(cookies);
  } catch {
    throw new Error("Invalid cookies");
  }
}

async function validateCookies(req, res, next) {
  await cookieValidator(req.cookies || "cookies");
  console.log("req.cookies :>> ", req.cookies);
  next();
}

app.use(validateCookies);

app.get("/", (req, res) => {
  let responseText = "Hello World!<br>";
  responseText += `<small>Requested at: ${req.requestTime}</small>`;
  res.send(responseText);
});

// error handler
app.use((err, req, res, next) => {
  res.status(400).send(err.message)
})

app.listen(3000);
```


L∆∞u √Ω c√°ch g·ªçi `next()` sau `block-code` `await cookieValidator(req.cookies)`: ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o r·∫±ng n·∫øu `cookieValidator` ƒë∆∞·ª£c gi·∫£i quy·∫øt, `middleware` ti·∫øp theo trong ngƒÉn x·∫øp s·∫Ω ƒë∆∞·ª£c g·ªçi. N·∫øu b·∫°n chuy·ªÉn b·∫•t k·ª≥ th·ª© g√¨ v√†o l√†m ƒë·ªëi s·ªë cho h√†m `next()` (ngo·∫°i tr·ª´ string `'route'`ho·∫∑c `'router'`), `Express` s·∫Ω coi nh∆∞ `request` hi·ªán t·∫°i h·∫∑p l·ªói v√† s·∫Ω b·ªè qua m·ªçi `function Routing` v√† `middleware` ƒëi th·∫≥ng ƒë·∫øn v·ªã tr√≠ `error handler`.

> B·ªüi v√¨ ch√∫ng ta c√≥ quy·ªÅn truy c·∫≠p v√†o `ƒë·ªëi t∆∞·ª£ng request`, `ƒë·ªëi t∆∞·ª£ng response` v√† c√°c `h√†m middleware` ti·∫øp theo trong `ngƒÉn x·∫øp` v√† `to√†n b·ªô API Node.js` => kh·∫£ nƒÉng c·ªßa h√†m middleware l√† v√¥ t·∫≠n v√† n√≥ c√≥ th·ªÉ l√†m m·ªçi th·ª©. NAI S∆† :D


Configurable middleware
----------------------------------------

N·∫øu b·∫°n c·∫ßn `middleware` c·ªßa m√¨nh c√≥ th·ªÉ ƒë·ªãnh c√°c `configure` m·ªôt c√°ch linh ho·∫°t, h√£y `exports` m·ªôt h√†m ch·∫•p nh·∫≠n m·ªôt ƒë·ªëi t∆∞·ª£ng t√πy ch·ªçn ho·∫∑c c√°c tham s·ªë kh√°c, sau ƒë√≥ tr·∫£ v·ªÅ m·ªôt `middleware` d·ª±a tr√™n c√°c tham s·ªë `input`. (N√≥ g·∫ßn g·∫ßn nh∆∞ `Abstract Factory Design Pattern`)

V√≠ d·ª• m√¨nh t·∫°o 1 file: `my-middleware.js`

```javascript
module.exports = function (options) {
  return function (req, res, next) {
// Implement the middleware function based on the options object
next()
  }
}
```


Middleware b√¢y gi·ªù c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng nh∆∞ h√¨nh d∆∞·ªõi ƒë√¢y.

```javascript
const mw = require('./my-middleware.js')

app.use(mw({ option1: '1', option2: '2' }))
```

Roundup
------
Nh∆∞ m·ªçi khi, m√¨nh hy v·ªçng b·∫°n th√≠ch b√†i vi·∫øt n√†y v√† h·ªçc th√™m ƒë∆∞·ª£c ƒëi·ªÅu g√¨ ƒë√≥ m·ªõi.

C·∫£m ∆°n v√† h·∫πn g·∫∑p l·∫°i c√°c b·∫°n trong nh·ªØng b√†i vi·∫øt ti·∫øp theo! üòç

N·∫øu b·∫°n th·∫•y Blog n√†y hay xin h√£y cho m√¨nh m·ªôt like v√† ƒëƒÉng k√Ω ƒë·ªÉ ·ªßng h·ªô m√¨nh nh√©. Thank you.üòâ2

Ref
----
* https://tuan200tokyo.blogspot.com/2022/11/blog29-tao-mot-middleware-chuan-chinh.html