M√¨nh l·∫°i ch√†o c√°c b·∫°n üëãüëã. Mong l√† ch√†o ho√†i c√°c b·∫°n kh√¥ng ch√°n üòÇ


Ti·∫øp t·ª•c v·ªõi [series h·ªçc Kubernetes](https://viblo.asia/s/hoc-kubernetes-tu-co-ban-den-gan-nang-cao-aAY4qQ6w4Pw), ·ªü [b√†i tr∆∞·ªõc](https://viblo.asia/p/deploy-app-tren-kubernetes-cluster-voi-deployment-Yym40ZdWL91) ta ƒë√£ h·ªçc c√°c Deploy app l√™n K8S Cluster, scale, update,... C≈©ng g·ªçi l√† t·ª± deploy tr√™n K8S ƒë∆∞·ª£c r·ªìi ƒë·∫•y, c∆° m√† m·ªôt trong nh·ªØng th·ª© m√† h·∫ßu nh∆∞ ta lu√¥n c·∫ßn khi deploy ƒë√≥ l√† c·∫•u h√¨nh, secret, bi·∫øn m√¥i tr∆∞·ªùng,... nh·ªØng th·ª© m√† ta c·∫ßn c·∫•u h√¨nh tu·ª≥ bi·∫øn theo t·ª´ng m√¥i tr∆∞·ªùng kh√°c nhau (dev, staging, production),...·ªû b√†i n√†y ch√∫ng ta s·∫Ω c√πng nhau t√¨m hi·ªÉu c√°ch d√πng ConfigMap v√† Secret ƒë·ªÉ l√†m ƒëi·ªÅu ƒë√≥ nh√© (v√† c√≤n h∆°n th·∫ø n·ªØa ;)).

> N·∫øu c√°c b·∫°n ƒë√£ quen v·ªõi Docker, Docker Compose, c√°ch d√πng `environment` hay `env_from` ƒë·ªÉ truy·ªÅn bi·∫øn m√¥i tr∆∞·ªùng v√†o container th√¨ b√†i n√†y s·∫Ω r·∫•t d·ªÖ x∆°i ƒë·∫•y ;) 

L√™n thuy·ªÅn c√πng m√¨nh n√†o anh em ‚õµÔ∏è‚õµÔ∏è
# L·∫•y K8S Session
V·∫´n nh∆∞ th∆∞·ªùng l·ªá, tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu c√°c b·∫°n ƒë·∫£m gi√∫p m√¨nh l√† ƒë√£ l·∫•y ƒë∆∞·ª£c K8S Session ƒë·ªÉ truy c·∫≠p v√†o cluster c·ªßa m√¨nh ƒë·∫ª l√°t n·ªØa ta th·ª±c h√†nh nh√©. Xem l·∫°i [b√†i c≈© gi√∫p m√¨nh nh√©](https://viblo.asia/p/mo-dau-voi-pod-tren-kubernetes-2oKLn2ryLQO#_setup-0)
# ConfigMap
Gi·ªõi thi·ªáu qua ch√∫t th√¨ ConfigMap l√† 1 object l∆∞u data d·∫°ng key-value, d√πng cho c√°c d·∫°ng data kh√¥ng b·∫£o m·∫≠t, kh√¥ng "nh·∫°y c·∫£m".

Ta c√≥ th·ªÉ l∆∞u string, number, boolean v√†o ƒë√≥ ho·∫∑c c√≥ th·ªÉ l∆∞u n·ªôi dung c·ªßa c·∫£ 1 file text v√†o c≈©ng ƒë∆∞·ª£c. 1 trong nh·ªØng tr∆∞·ªùng h·ª£p ph·ªï bi·∫øn nh·∫•t l√† ta d√πng n√≥ ƒë·ªÉ l∆∞u bi·∫øn m√¥i tr∆∞·ªùng. Nghe ƒë∆°n gi·∫£n nh·ªâ ? :D, ta c√πng nhau ƒëi v√†o v√≠ d·ª• cho d·ªÖ hi·ªÉu h∆°n nh√©.

·ªû b√†i n√†y m√¨nh ƒë√£ chu·∫©n b·ªã cho c√°c b·∫°n v√≠ d·ª• l√† 1 webapp r·∫•t ƒë∆°n gi·∫£n nh∆∞ sau:
- c√≥ 2 m√†n: login v√† main
- Sau khi login xong th√¨ user ƒë∆∞·ª£c ƒë∆∞a v√†o m√†n main

V√≠ d·ª• v·ªÅ Configmap ta s·∫Ω t·∫≠p trung v√†o m√†n login n∆°i ta c·∫•u h√¨nh 1 s·ªë th√¥ng tin kh√¥ng "nh·∫°y c·∫£m":

![Screenshot 2022-10-30 at 7.57.39 PM.png](https://images.viblo.asia/9cb51045-ddd6-47f2-a9ec-9cf60bafeeca.png)

·ªû tr√™n ta c√≥ app title v√† Introduction l√† nh·ªØng th·ª© public, v√† c√≥ th·ªÉ config ƒë∆∞·ª£c, v√† ta s·∫Ω d√πng ConfigMap nh√©.

ƒê·∫ßu ti√™n c√°c b·∫°n t·∫°o cho m√¨nh file `configmap.yml` v·ªõi n·ªôi dung nh∆∞ sau:
```yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp-config
data:
  app_name: "Hello World"
  introduction.txt: |
    My Introduction
```
Xem xem ·ªü ƒë√¢y ta c√≥ g√¨ n√†o: :)
- ƒë·ªÉ t·∫°o configmap th√¨ `kind` ta ph·∫£i ƒë·ªÉ l√† `ConfigMap`
- b√™n trong `data` l√† n∆°i ta ƒë·ªÉ config c·ªßa ch√∫ng ta
- ta c√≥ th·ªÉ ƒë·ªÉ key-value ƒë∆°n gi·∫£n nh∆∞ `app_name`, value l√† string ƒë∆°n gi·∫£n l√† `Hello world`
- ho·∫∑c ta c≈©ng c√≥ th·ªÉ ƒë·ªÉ c·∫£ 1 file r·∫•t d√†i v√†o ƒë√¢y, ƒë·ªÉ √Ω d·∫•u `|` nh√©

R·∫•t ƒë∆°n gi·∫£n ph·∫£i kh√¥ng nh·ªØng ng∆∞·ªùi anh em thi·ªán l√†nh ;)

Sau ƒë√¢y ta `apply` ƒë·ªÉ t·∫°o Configmap nh√©:
```
kubectl apply -f configmap.yml  --kubeconfig=kubernetes-config
```
Ta th·∫•y in ra:
```
configmap/myapp-config created
```
ƒê·ªÉ `get configmap` th√¨ ta c≈©ng l√†m nh∆∞ ta th∆∞·ªùng l√†m v·ªõi Pod, service,...
```
kubectl get configmap --kubeconfig=kubernetes-config

--->>

myapp-config       2      4m39s
```
ƒê·ªÉ xem c·ª• th·ªÉ b√™n trong Configmap c√≥ ƒë√∫ng nh∆∞ ·ªü trong file manifest ta vi·∫øt hay kh√¥ng c√°c b·∫°n l√†m nh∆∞ sau:
```
kubectl get configmap myapp-config -o yaml --kubeconfig=kubernetes-config
```
Ta s·∫Ω th·∫•y in ra ki·ªÉu ki·∫ªu nh∆∞ sau:

![Screenshot 2022-10-31 at 6.27.06 PM.png](https://images.viblo.asia/b0ec7270-25ed-4bc6-b630-44d0ae709bdb.png)

Nom ·ªïn √°p r·ªìi ƒë√≥ üòé

Ti·∫øp sau ƒë√¢y ta t·∫°o deployment nh√©, c√°c b·∫°n t·∫°o cho m√¨nh file `myapp.yml` nh∆∞ sau:
```yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deployment
  labels:
    app: myapp
spec:
  selector:
    matchLabels:
      app: myapp-pod
  template:
    metadata:
      labels:
        app: myapp-pod
    spec:
      securityContext:
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
      containers:
      - name: myapp-container
        image: maitrungduc1410/configmap-and-secret
        ports:
        - containerPort: 3000
          name: http
        resources:
          requests:
            memory: "128Mi"
            cpu: "64m"
          limits:
            memory: "750Mi"
            cpu: "500m"
        env:
          - name: APP_NAME
            valueFrom:
              configMapKeyRef:
                name: myapp-config
                key: app_name
        volumeMounts:
        - name: config
          mountPath: "/app/storage"
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: myapp-config
          items:
          - key: "introduction.txt"
            path: "introduction.txt"

---
apiVersion: v1
kind: Service
metadata:
  name: myapp-svc
spec:
  type: LoadBalancer
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: http
  selector:
    app: myapp-pod
```

·ªû b√™n tr√™n nom kh√° gi·ªëng v·ªõi [b√†i tr∆∞·ªõc v·ªÅ Deployment](https://viblo.asia/p/deploy-app-tren-kubernetes-cluster-voi-deployment-Yym40ZdWL91) ·∫•y nh·ªâ ü§î

C√πng ƒëi·ªÉm qua 1 s·ªë ƒëi·ªÉm ch√≠nh m·ªõi nh√©:
- ƒê·∫ßu ti√™n ta c√≥ `env`l√† danh s√°ch c√°c bi·∫øn m√¥i tr∆∞·ªùng ta mu·ªën truy·ªÅn v√†o container khi start, gi·ªëng v·ªõi `environment` m√† ta v·∫´n d√πng v·ªõi `docker compose`. ·ªû ƒë√≥ ta ƒë·ªãnh nghƒ©a 1 bi·∫øn t√™n l√† `APP_NAME`, l·∫•y gi√° tr·ªã t·ª´ ConfigMap (`valueFrom` -> `configMapKeyRef`), ti·∫øp ƒë√≥ ta c√≥ t√™n c·ªßa configmap `myapp-config` v√† c√°i key trong configmap m√† ta mu·ªën l·∫•y ra `app_name`
- Ti·∫øp theo ta ƒë·ªãnh nghƒ©a 1 `volumes` t√™n l√† `config` (t√™n l√† g√¨ tu·ª≥ √Ω c√°c b·∫°n nh√©), l·∫•y t·ª´ configmap t∆∞∆°ng ·ª©ng, `items` l√† danh s√°ch c√°c key ta mu·ªën l·∫•y ra, ·ªü ƒë√¢y ta ch·ªâ mu·ªën l·∫•y ra 1 key trong configmap t√™n l√† `introduction.txt` v√† map n√≥ v√†o file c√πng t√™n `introduction.txt`
- Sau khi ƒë√£ ƒë·ªãnh nghƒ©a `volumes` th√¨ vi·ªác c·ªßa ta l√† s·ª≠ d·ª•ng n√≥
- B√™n trong ph·∫ßn c·∫•u h√¨nh `containers` ta c√≥ `volumeMounts`, ƒë√¢y l√† n∆°i ta s·∫Ω tham chi·∫øu t·ªõi `volumes` kia. `name` l√† t√™n c·ªßa volumes ta v·ª´a ƒë·ªãnh nghƒ©a, `mountPath` l√† ta mu·ªën mount c√°i volume kia v√†o ƒë∆∞·ªùng d·∫´n n√†o, cu·ªëi c√πng l√† ta c√≥ `readOnly: true` √Ω l√† ta kh√¥ng cho ph√©p container ghi ƒë√® v√†o file

√∫i x·ªìi nhi·ªÅu kh√°i ni·ªám qu√°, nom `volumes` r·ªìi `volumeMounts` c·ª© lo·∫°n h·∫øt c·∫£ l√™n üò™üò™ l·∫±ng nh√† l·∫±ng nh·∫±ng (c√°i n√†y ta s·∫Ω l√†m r√µ h∆°n ·ªü b√†i v·ªÅ volume nh√©)


> B√™n c·∫°nh ƒë√≥ m√¨nh c≈©ng c√≥ th√™m `securityContext`, ƒë·ªÉ ch·ªâ ƒë·ªãnh ta mu·ªën ch·∫°y container b·∫±ng user n√†o, group n√†o, n√≥ s·∫Ω override lu√¥n c√°i `USER` m√† ta ƒë·ªãnh nghƒ©a ·ªü Dockerfile n·∫øu c√≥, ph·∫ßn n√†y ta s·∫Ω n√≥i th√™m ·ªü c√°c b√†i sau nh√© ;)

N·∫øu c√°c b·∫°n ƒë·ªÉ √Ω th√¨ s·∫Ω th·∫•y l√† `volumes` v√† `containers` ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ngang h√†ng (level) v·ªõi nhau:

![Screenshot 2022-10-31 at 11.24.08 PM.png](https://images.viblo.asia/b036f0d7-46c0-4628-98b8-85b487e92f89.png)

T·ª©c l√† `volumes` kh√¥ng b·ªã ph·ª• thu·ªôc v√†o 1 container n√†o m√† n√≥ c√≥ th·ªÉ ƒë∆∞·ª£c d√πng chung gi·ªØa nhi·ªÅu container

√Çu c√¢y r·ªìi ƒë√≥, ta c√πng deploy nh√©:

```
kubectl apply -f myapp.yml --kubeconfig=kubernetes-config
```
Sau ƒë√≥ trong th·ªùi gian ch·ªù LoadBalancer ƒë∆∞·ª£c kh·ªüi t·∫°o (m·∫•t v√†i ph√∫t ƒë·ªÉ b√™n cloud provider t·∫°o LB) th√¨ tranh th·ªß ta v·ªçc v·∫°ch ch√∫t nh√©.

C√πng chui z√¥ container xem c√≥ g√¨ n√†o üëÅÔ∏èüëÅÔ∏è

√Ä t·ª´ t·ª´ ph·∫£i `get` xem c√≥ pod n√†o m·ªõi chui z√¥ ƒë∆∞·ª£c ch·ª© üòÇüòÇ:

```
kubectl get po --kubeconfig=kubernetes-config


---->>>
NAME                               READY   STATUS    RESTARTS   AGE
myapp-deployment-995b4d567-8p4fr   1/1     Running   0          18m
```
G√≤i g√≤i, gi·ªù m·ªõi chui z√¥ container ƒë∆∞·ª£c l√® ü§™
```
kubectl exec -it myapp-deployment-995b4d567-8p4fr --kubeconfig=kubernetes-config -- sh
```
> ƒë·ªïi t√™n pod sao cho kh·ªõp v·ªõi c·ªßa c√°c b·∫°n nh√©

Th·ª≠ check user id v√† group id t√≠ xem `securityContext` ƒë√£ ƒë∆∞·ª£c set ƒë√∫ng ch∆∞a nh√©:
```
whoami
id -u
id -g
id
```
Ta th·∫•y in ra nh∆∞ sau:
![Screenshot 2022-10-31 at 11.33.20 PM.png](https://images.viblo.asia/737d6afb-49a6-49d1-960f-4bc6ff866c0c.png)

Nom c√≥ v·∫ª ƒë√∫ng r·ªìi ƒë·∫•y nh·ªâ :)
> App ch√∫ng ta ch·∫°y ·ªü b√†i n√†y l√† app NextJS. Anh em React ƒë√¢u gi∆° tay xem c√°i n√†o üñêÔ∏èüñêÔ∏è

Ti·∫øp theo ta s·∫Ω ki·ªÉm tra xem bi·∫øn m√¥i tr∆∞·ªùng v√† volume c·ªßa ta ƒë√£ c√≥ ch∆∞a nh√©:
```
ls -la

echo $APP_NAME

ls -la storage

cat storage/introduction.txt
```

Ta s·∫Ω th·∫•y in ra nh∆∞ sau:

![Screenshot 2022-10-31 at 11.36.26 PM.png](https://images.viblo.asia/7abc0c29-3664-4b03-8347-9f2524c0df47.png)

Nom xinh t∆∞∆°i r·ªìi ƒë√≥ nh·ªâ, c√≥ h·∫øt r·ªìi üòéüòé

> N·∫øu c√°c b·∫°n ƒë·ªÉ √Ω th√¨ folder `storage` n∆°i ta mount volume v√†o n√≥ ƒëang n·∫±m d∆∞·ªõi user `root`, m·∫∑c d√π group th√¨ v·∫´n ƒë√∫ng `nodejs`. C√°i n√†y ta s·∫Ω n√≥i ·ªü c√°c b√†i sau nh√©

·ªîn r·ªìi ƒë√≥, gi·ªù chui l·∫°i ra ngo√†i v√† `get service` ƒë·ªÉ l·∫•y EXTERNAL-IP n√†o (b·∫•m CTRL + D ƒë·ªÉ chui ra nh√©):
```
kubectl get svc --kubeconfig=kubernetes-config

--->>>

NAME        TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)          AGE
myapp-svc   LoadBalancer   10.245.64.155   167.99.30.23   8080:32101/TCP   3m20s
```
Nh∆∞ ·ªü tr√™n th√¨ Service c·ªßa m√¨nh c√≥ EXTERNAL-IP l√† `167.99.30.23`. Gi·ªù ta quay l·∫°i tr√¨nh duy·ªát v√† ki·ªÉm tra nh√©, c√°c b·∫°n m·ªü tr√¨nh duy·ªát ·ªü ƒë·ªãa ch·ªâ `167.99.30.23:8080` xem nh√©:

![Screenshot 2022-10-31 at 11.41.44 PM.png](https://images.viblo.asia/25ae96da-1be5-4bb1-91a9-2bdfb65a550f.png)

yeah, app name ƒë√£ ƒë∆∞·ª£c set th√†nh Hello World, b·∫•m th·ª≠ n√∫t `Download Introduction` ta s·∫Ω th·∫•y k·∫øt qu·∫£ nh∆∞ mong ƒë·ª£i ü•∞ü•∞:

![Screenshot 2022-10-31 at 11.41.59 PM.png](https://images.viblo.asia/b7039329-4e0e-47f3-b545-e72a85a8e940.png)

tuy·ªát v·ªùi √¥ng m·∫∑t tr·ªùi, c·∫£m gi√°c nh∆∞ v·ª´a gi·∫£i c·ª©u th·∫ø gi·ªõi v·∫≠y ü§©ü§©ü§©ü§©


Gi·ªù ta th·ª≠ update l·∫°i Configmap xem nh√©:
```yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp-config
data:
  app_name: "My Kubernetes App"
  introduction.txt: |
    This is to demo how to update Configmap
```
Sau ƒë√≥ ta `apply` l·∫°i Configmap nh√©:

```
kubectl apply -f configmap.yml --kubeconfig=kubernetes-config

---->>>

configmap/myapp-config configured
```
ƒêo·∫°n n√†y m·ªõi vi di·ªáu n√†y. Ta quay tr·ªü l·∫°i tr√¨nh duy·ªát, b·∫•m F5, v√† b·∫•m `Download Introduction`, m·ªü file download ta s·∫Ω th·∫•y gi√° tr·ªã ƒë√£ ƒë∆∞·ª£c update:

![Screenshot 2022-10-31 at 11.46.46 PM.png](https://images.viblo.asia/d90980bf-e336-4b40-8273-41024efbd584.png)

U·∫ßy, nom x·ªãn ph·∫øt nh·ªù, update ngay c·∫£ khi container ƒëang ch·∫°y lu√¥n, kh√¥ng c·∫ßn restart l·∫°i deployment....

Chuy·ªán, h√†ng x·ªãn m√† l·∫°i üòéüòé

Th·∫ø nh∆∞ng c√°c b·∫°n ƒë·ªÉ th√¨ APP_NAME v·∫´n kh√¥ng thay ƒë·ªïi, ta v·∫´n th·∫•y `Hello world`

Volume ƒë∆∞·ª£c update ngay l·∫≠p t·ª©c l√† v√¨ b·∫£n ch·∫•t n√≥ ch·∫±ng kh√°c g√¨ c√°i volume m√† ta v·∫´n  d√πng b√™n Docker su·ªët r·ªìi, m·ªçi thay ƒë·ªïi ·ªü volume ƒë·ªÅu s·∫Ω ƒë∆∞·ª£c mount tr·ª±c ti·∫øp v√†o container l√∫c runtime (ƒëang ch·∫°y). C√≤n v·ªõi bi·∫øn m√¥i tr∆∞·ªùng th√¨ ta s·∫Ω ph·∫£i restart l·∫°i deployment ƒë·∫•y. Ta ch·∫°y command `rollout restart` nh√©:
```
kubectl rollout restart deploy myapp-deployment --kubeconfig=kubernetes-config
```
Ch·ªù m·ªôt t·∫πo cho Pod m·ªõi ƒë∆∞·ª£c deploy xong xu√¥i (c√°c b·∫°n t·ª± `get pod` ki·ªÉm tra bao gi·ªù th·∫•y RUNNING l√† ƒë∆∞·ª£c nh√©), v√† gi·ªù ta quay l·∫°i tr√¨nh duy·ªát F5:

![Screenshot 2022-10-31 at 11.50.56 PM.png](https://images.viblo.asia/22fbe27a-b726-45b7-a56d-83208d2b88db.png)

Tuy·ªát v·ªùi, `APP_NAME` ƒë√£ ƒë∆∞·ª£c update ü•≥ü•≥ü•≥. S·ª≠ d·ª•ng ConfigMap kh√° ƒë∆°n gi·∫£n √Ω nh·ªâ ;) Ta tri·ªÉn ti·∫øp ph·∫ßn sau nh√©

# Secret
V·ªõi c√°c d·∫°ng config chung chung, kh√¥ng ri√™ng t∆∞ th√¨ ta c√≥ th·ªÉ d√πng Configmap nh∆∞ tr√™n, nh∆∞ng c√≤n v·ªõi c√°c d·∫°ng th√¥ng tin c·∫ßn b·∫£o m·∫≠t: th√¥ng tin k·∫øt n·ªëi data, password, API key/secret, JWT secret, docker secret ƒë·ªÉ pull image t·ª´ private registry,... V·ªõi nh·ªØng th·ª© ri√™ng t∆∞ nh∆∞ v·∫≠y th√¨ ta c·∫ßn 1 th·ª© t·ªët h∆°n, K8S mang t·ªõi cho ch√∫ng ta Secret.

Secret th√¨ c√≥ nhi·ªÅu lo·∫°i Secret, nh∆∞ng ph·ªï bi·∫øn v√† ta hay l√†m vi·ªác nh·∫•t l√† `type=Opaque`, c√°ch d√πng th√¨ nom c≈©ng kh√¥ng kh√°c g√¨ ConfigMap, r·∫•t d·ªÖ. Ta c√πng xem nh√© ;)

## T·∫°o v√† s·ª≠ d·ª•ng secret
·ªû c√°i app NextJS c·ªßa m√¨nh th√¨ ta c√≤n c√≥ th·ªÉ login v·ªõi email v√† password c·ªßa admin (ƒë∆∞·ª£c config t·ª´ ph√≠a backend), login th√†nh c√¥ng v√†o trong th√¨ ta s·∫Ω c√≥ th·ªÉ download ƒë∆∞·ª£c file secret. V√† b·ªüi v√¨ nh·ªØng th√¥ng tin nh∆∞ username/password, v√† file secret c·∫ßn b·∫£o m·∫≠t h∆°n n√™n ta s·∫Ω ƒë∆∞a n√≥ v√†o secret nh√©.

C√°c b·∫°n t·∫°o cho m√¨nh file `secret.yml` v·ªõi n·ªôi dung nh∆∞ sau:
```yml
apiVersion: v1
kind: Secret
metadata:
  name: myapp-secret
type: Opaque
stringData:
  EMAIL: "admin@test.com"
  PASSWORD: "123456"
  secret.txt: |
    My supersecret
```
Nh√¨n v√†o secret ta v·ª´a ƒë·ªãnh nghƒ©a b√™n tr√™n nom kh√° l√† gi·ªëng v·ªõi ConfigMap lu√¥n √Ω nh·ªâ? ƒë∆°n gi·∫£n gh√™.

Th√¨ nh∆∞ m√¨nh ƒë√£ n√≥i ·ªü tr√™n ƒë√¢y l√† lo·∫°i secret ph·ªï bi·∫øn nh·∫•t `type=Opaque` c√°ch d√πng r·∫•t ƒë∆°n gi·∫£n. Ta c√≥ th·ªÉ truy·ªÅn v√†o tr·ª±c ti·∫øp `stringData` l√† d·∫°ng data thu·∫ßn, raw data. Ho·∫∑c ta c≈©ng c√≥ th·ªÉ truy·ªÅn v√†o base64. V√≠ d·ª• v·ªõi file secret b√™n tr√™n m√† ta mu·ªën d√πng base64 th√¨ s·∫Ω nh∆∞ sau:
```yml
...
type: Opaque
data:
  EMAIL: YWRtaW5AdGVzdC5jb20K
  PASSWORD: MTIzNDU2Cg==
  secret.txt: TXkgc3VwZXJzZWNyZXQK
```
> ch√∫ √Ω r·∫±ng v·ªõi data d·∫°ng base64 th√¨ ta ph·∫£i d√πng `data` thay v√¨ `stringData` nh√©

> c√≤n n·ªØa l√† n·∫øu ta d√πng `stringData`, th√¨ l√°t n·ªØa sau khi `apply` xong v√† `get` th√¨ K8S s·∫Ω show data d·∫°ng base64 th√¥i.

Gi·ªù ta l∆∞u file `secret.yml` l·∫°i (b·∫£n raw, d√πng `stringData` √Ω nh√©). V√† `apply` ƒë·ªÉ t·∫°o secret nh√©:

```
kubectl apply -f secret.yml --kubeconfig=kubernetes-config

--->>>

secret/myapp-secret created
```
ta th·ª≠ get danh s√°ch c√°c secret hi·ªán c√≥ ·ªü namespace nh√©:
```
kubectl get secret --kubeconfig=kubernetes-config

--->>>

NAME                  TYPE                                  DATA   AGE
default-token-4lggr   kubernetes.io/service-account-token   3      10m
myapp-secret          Opaque                                3      41s
```
√¢u c√¢y secret c·ªßa ta ƒë∆∞·ª£c t·∫°o ngon r·ªìi ƒë√≥. Gi·ªù ta th·ª≠ `get` detail xem b√™n trong secret c·ªßa ta sau khi t·∫°o n√≥ nom nh∆∞ th·∫ø n√†o nh√©:

```
kubectl get secret myapp-secret -o yaml --kubeconfig=kubernetes-config
```
Ta s·∫Ω th·∫•y d·∫°ng d·∫°ng nh∆∞ sau:

![Screenshot 2022-11-01 at 12.58.27 PM.png](https://images.viblo.asia/43d9d3af-682a-4ffb-91f5-5307b92912b7.png)

Nh∆∞ c√°c b·∫°n th·∫•y th√¨ d√π file manifest c·ªßa ta ƒë·ªÉ l√† `stringData` nh∆∞ng sau khi `apply` th√¨ K8S ƒë√£ ƒë·ªïi th√†nh `data` v√† d√πng d·∫°ng base64. Ph·∫ßn n√†y K8S l√†m t·ª± ƒë·ªông ta kh√¥ng c·∫ßn quan t√¢m, l√°t n·ªØa d√πng ta c≈©ng kh√¥ng c·∫ßn convert ng∆∞·ª£c l·∫°i m√† c·ª© th·∫ø d√πng th√¥i nh√©.

Gi·ªù ta quay l·∫°i file deployment `myapp.yml` v√† update l·∫°i 1 ch√∫t nh∆∞ sau ƒë·ªÉ `inject` (truy·ªÅn) bi·∫øn m√¥i tr∆∞·ªùng v√†o cho ph·∫ßn login v√† c·∫£ file secret sau khi login ƒë·ªÉ user c√≥ th·ªÉ download nh√©. Ta m·ªü file `myapp.yml`:
```yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deployment
  labels:
    app: myapp
spec:
  selector:
    matchLabels:
      app: myapp-pod
  template:
    metadata:
      labels:
        app: myapp-pod
    spec:
      securityContext:
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
      containers:
      - name: myapp-container
        image: maitrungduc1410/configmap-and-secret
        ports:
        - containerPort: 3000
          name: http
        resources:
          requests:
            memory: "128Mi"
            cpu: "64m"
          limits:
            memory: "750Mi"
            cpu: "500m"
        env:
          - name: APP_NAME
            valueFrom:
              configMapKeyRef:
                name: myapp-config
                key: app_name
          - name: EMAIL
            valueFrom:
              secretKeyRef:
                name: myapp-secret
                key: EMAIL
          - name: PASSWORD
            valueFrom:
              secretKeyRef:
                name: myapp-secret
                key: PASSWORD
        volumeMounts:
        - name: config
          mountPath: "/app/storage/introduction.txt"
          subPath: introduction.txt
          readOnly: true
        - name: secret
          mountPath: "/app/storage/secret.txt"
          subPath: secret.txt
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: myapp-config
          items:
          - key: "introduction.txt"
            path: "introduction.txt"
      - name: secret
        secret:
          secretName: myapp-secret
          items:
            - key: secret.txt
              path: secret.txt
---
apiVersion: v1
kind: Service
metadata:
  name: myapp-svc
spec:
  type: LoadBalancer
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: http
  selector:
    app: myapp-pod
```
C√≥ m·ªôt s·ªë thay ƒë·ªïi ·ªü Deployment, (Service th√¨ gi·ªØ nguy√™n). Ta c√πng xem nh√©:
- ƒë·∫ßu ti√™n l√† ·ªü `volumes` t∆∞∆°ng t·ª± nh∆∞ configMap ta ƒë·ªãnh nghƒ©a th√™m 1 volume d√†nh cho secret ƒë·ªÉ mount file `secret.txt` v√†o, c√°c b·∫°n ƒë·ªÉ √Ω nh·ªØng keyword, c√∫ ph√°p c·ªßa n√≥ nh√©, g·∫ßn nh∆∞ t∆∞∆°ng t·ª± config map, kh√°c m·ªói c√°i b√™n configmap ƒë·ªÉ l√† `name` th√¨ b√™n secret ta ƒë·ªÉ l√† `secretName`
- ·ªû `env` ta ƒë·ªãnh nghƒ©a th√™m 2 bi·∫øn n·ªØa l√† `EMAIL` v√† `PASSWORD` l·∫•y t·ª´ secret, v·∫´n t∆∞∆°ng t·ª± nh∆∞ configmap ;)
- cu·ªëi c√πng l√† ƒëo·∫°n c√≥ v·∫ª "thay ƒë·ªïi nhi·ªÅu nh·∫•t" l√† ph·∫ßn `volumeMounts`
- ·ªü ƒë√≥ gi·ªëng nh∆∞ configmap, ta mount th√™m volume c·ªßa secret v√†o, nh∆∞ng c√≥ 1 ƒëi·ªÅu l√† c√°i `mountPath` c·ªßa c·∫£ 2 ta v·ª´a update l·∫°i ƒë·ªÉ d√πng ƒë∆∞·ªùng d·∫´n c√≥ ch·ª©a c·∫£ t√™n file, v√† ta c≈©ng th√™m c·∫£ `subPath` l√† t√™n file n·ªØa
- `subPath` ch√≠nh l√† c√°i `path` m√† ta ƒë·ªãnh nghƒ©a ·ªü ph·∫ßn `volumes` b√™n d∆∞·ªõi
- c√≤n l√≠ do c√°i `mountPath` ta ph·∫£i th√™m c·∫£ t√™n file l√† b·ªüi v√¨ hi·ªán t·∫°i ta mu·ªën mount 2 volumes v√†o chung 1 ƒë∆∞·ªùng d·∫´n `/app/storage` m√† K8S kh√¥ng cho ph√©p `mountPath` tr√πng nhau gi·ªØa c√°c `volumeMounts`, n·∫øu ta ƒë·ªÉ 2 c√°i `mountPath` ƒë·ªÅu l√† `/app/storage` nh∆∞ c≈© th√¨ l√∫c `apply` s·∫Ω c√≥ l·ªói, n√™n ta ph·∫£i th√™m t√™n file v√†o cho n√≥ kh√°c nhau ƒëi, v√† b·ªüi v√¨ ta d√πng tr·ª±c ti·∫øp ƒë∆∞·ªùng d·∫´n c√≥ c·∫£ t√™n file n√™n ta ph·∫£i d√πng chung v·ªõi `subPath` ƒë·ªÉ l·∫•y ra ƒë√∫ng file ta mong mu·ªën t·ª´ `volumes`

> ·ªëi d·ªìi √¥i nghe lo·∫°n c·∫£ √≥c, kh√≥c r√≤ngü§£ü§£, n·∫øu c√°c b·∫°n th·∫•y kh√≥ nu·ªët qu√° th√¨ d√†nh ra ƒë√¥i ph√∫t thi·ªÅn ƒë·ªÉ c√≥ th·ªÉ th·∫©m th·∫•u d·ªÖ h∆°n nh√© ;)

Oke r·ªìi ƒë√≥ gi·ªù ta apply l·∫°i deployment n√†o:
```
kubectl apply -f myapp.yml --kubeconfig=kubernetes-config
```
Sau ƒë√≥ ta ch·ªù 1 l√∫c ƒë·ªÉ Pod m·ªõi ƒë∆∞·ª£c deploy (c√°c b·∫°n t·ª´ `get pod` ƒë·ªÉ check status nh√©), sau ƒë√≥ ta quay l·∫°i tr√¨nh duy·ªát, b·∫•m F5 v√† login v·ªõi `EMAIL` v√† `PASSWORD` nh∆∞ ta ƒë·ªãnh nghƒ©a trong file secret. Login th√†nh c√¥ng v√†o trong ta b·∫•m n√∫t Get Secret:

![Screenshot 2022-11-01 at 4.42.37 PM.png](https://images.viblo.asia/af929fae-252b-442a-8fce-63d09d149bc1.png)

M·ªü file download l√™n v√† ta th·∫•y ƒë∆∞·ª£c n·ªôi dung file secret c·ªßa ch√∫ng ta:

![Screenshot 2022-11-01 at 4.43.12 PM.png](https://images.viblo.asia/c8237510-9a5c-47b9-8b01-3d6e0b0271f7.png)

Oke v·∫≠y l√† ta ƒë√£ ho√†n th√†nh setup Secret v√† Configmap r·ªìi ƒë√≥ :).
# V·ªçc v·∫°ch
Th·ª≠ v·ªçc th√™m t√≠ n·ªØa nh√©. B√¢y gi·ªù ta th·ª≠ update l·∫°i `secret.yml`:
```yml
apiVersion: v1
kind: Secret
metadata:
  name: myapp-secret
type: Opaque
stringData:
  EMAIL: "newadmin@gmail.com"
  PASSWORD: "abcdefg"
  secret.txt: |
    This is new secret
```
Sau ƒë√≥ ta `apply` l·∫°i:
```
kubectl apply -f secret.yml --kubeconfig=kubernetes-config
```
Ngay b√¢y gi·ªù, ƒë·ª´ng restart deployment v·ªôi nh√©, ta chui lu√¥n v√¥ container ƒë·ªÉ xem c√°i file `secret.txt` ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ch∆∞a:
```
kubectl exec -it myapp-deployment-6dcc8b9b68-gpnvk --kubeconfig=kubernetes-config -- sh
```
> ƒë·ªïi t√™n pod khi `exec` cho gi·ªëng v·ªõi c·ªßa c√°c b·∫°n nh√©

Sau khi v√†o trong ta xem file `secret.txt` c√≥ g√¨ nh√©:
```
/app $ cat storage/secret.txt 

--->>>

My supersecret
```

√î, c√°i g√¨ n√≥ n·ªï √Ω nh·ªÅ? üß®üß®, ·ªßa sao file secret l·∫°i kh√¥ng update n·ªØa r·ªìi. Khi n√£y ·ªü b√™n Configmap update volume c√°i th√¨ b√™n trong n√≥ t·ª± ƒë·ªông ƒë·ªïi lu√¥n kh√¥ng c·∫ßn restart m√†??? ü§îü§îü§î

L√≠ do volume c·ªßa ta **kh√¥ng ƒë∆∞·ª£c update "realtime" v√†o trong container** n·ªØa l√† b·ªüi v√¨ hi·ªán t·∫°i ta d√πng `subPath` ƒë·ªÉ mount, v√† nh∆∞ v·∫≠y ta s·∫Ω kh√¥ng nh·∫≠n ƒë∆∞·ª£c update m·ªõi n·ªØa m√† ph·∫£i restart l·∫°i deployment. ƒê√¢y l√† K8S quy ƒë·ªãnh ch·ª© kh√¥ng ph·∫£i m√¨nh t·ª± v·∫Ω ra nh√© c√°c b·∫°n ü§£ü§£ü§£. 

B√¢y gi·ªù c√°i configmap v√† secret ta ƒë·ªÅu ƒëang d√πng `subPath` n√™n khi thay ƒë·ªïi ch√∫ng th√¨ ta ph·∫£i restart l·∫°i deployment, c√°c b·∫°n th·ª≠ check v·ªõi Configmap xem nh√© ;)¬†

Gi·ªù ta restart l·∫°i deployment l√† ƒë∆∞·ª£c nh√©:
```
kubectl rollout restart deploy myapp-deployment --kubeconfig=kubernetes-config
```

Sau ƒë√≥ ta quay l·∫°i tr√¨nh duy·ªát F5, th·ª≠ login v·ªõi EMAIL v√† PASSWORD m·ªõi, v√¥ trong ta download file secret m·ªõi ƒë∆∞·ª£c r·ªìi ƒë√≥. C√°c b·∫°n t·ª± l√†m ph·∫ßn n√†y nh√© ;)

√Ä t√≠ qu√™n, n·∫øu c√°c b·∫°n ƒë·ªÉ √Ω khi ta chui v√†o container v√† list file:

![Screenshot 2022-11-01 at 4.58.03 PM.png](https://images.viblo.asia/07644846-615a-46ff-b135-00c878e5b178.png)

![Screenshot 2022-11-01 at 4.58.12 PM.png](https://images.viblo.asia/b7b74d5e-d69c-43f5-8c19-c3ee236278cc.png)

Ta ƒë·ªÉ √Ω th·∫•y r·∫±ng, khi ta d√πng `subPath`, th√¨ ta ch·ªâ mount file v√†o b√™n trong folder `storage` s·∫µn c√≥ t·ª´ tr∆∞·ªõc (t·ª´ build image, trong Dockerfile), do v·∫≠y permission c·ªßa folder storage v·∫´n ƒë∆∞·ª£c b·∫£o to√†n `nextjs:nodejs`, ch·ªâ l√† 2 file ƒë∆∞·ª£c mount v√†o b√™n trong th√¨ c·ªßa `root:nodejs`.

N√≥ h∆°i kh√°c 1 ch√∫t so v·ªõi ·ªü ƒë·∫ßu b√†i ƒëo·∫°n l√†m v·ªõi Configmap, ta mount c·∫£ volume v√†o th·∫≥ng ƒë∆∞·ªùng d·∫´n `/app/storage`, t·ª©c l√† mount ƒë√® l√™n folder storage s·∫µn c√≥ c·ªßa image, v√† l√†m cho c·∫£ folder `storage` b·ªã ƒë·∫∑t d∆∞·ªõi quy·ªÅn `root:nodejs`

V·ªÅ permission th√¨ ta s·∫Ω th·∫£o lu·∫≠n d·∫ßn d·∫ßn ·ªü c√°c b√†i sau ƒë·ªÉ l√†m r√µ h∆°n nh√© :)

# C√¢u h·ªèi li√™n quan
## C√≥ n√™n push c·∫£ ConfigMap v√† Secret l√™n Git?
C√¢u tr·∫£ l·ªùi l√† kh√¥ng, √† tu·ª≥ :). nh∆∞ng best pratice l√† ta kh√¥ng bao gi·ªù ƒë∆∞a th√¥ng tin "nh·∫°y c·∫£m" l√™n git, v√† secret c≈©ng v·∫≠y.

V√≠ d·ª• ConfigMap c·ªßa b·∫°n ch∆∞a th√¥ng tin c√≥ th·ªÉ public, kh√¥ng ri√™ng t∆∞ th√¨ c√≥ th·ªÉ ƒë∆∞a l√™n ƒë∆∞·ª£c, c√≤n Secret th√¨ h·∫ßu nh∆∞ kh√¥ng.

Th√¥ng th∆∞·ªùng m√¨nh v·∫´n mu·ªën push file `secret.yml` l√™n Git ƒë·ªÉ m·ªçi ng∆∞·ªùi c√≥ th·ªÉ track ƒë∆∞·ª£c file ƒë√≥ l√† g√¨, c·∫•u tr√∫c nh∆∞ n√†o. Th√¨ tr∆∞·ªõc khi `git push` m√¨nh s·∫Ω s·ª≠a l·∫°i nh∆∞ sau:
```yml
apiVersion: v1
kind: Secret
metadata:
  name: myapp-secret
type: Opaque
stringData:
  EMAIL: <PLACEHOLDER>
  PASSWORD: <PLACEHOLDER>
  secret.txt: <PLACEHOLDER>
```
## Secret c√≥ nh·ªØng Type n√†o?
·ªû trong b√†i n√†y ta m·ªõi ch·ªâ n√≥i v·ªÅ `Type=Opaque` l√† type ph·ªï bi·∫øn v√† hay d√πng nh·∫•t cho Secret, nh∆∞ng Secret c√≤n c√≥ 1 s·ªë type kh√°c, nh∆∞ h√¨nh d∆∞·ªõi:

![Screenshot 2022-11-01 at 5.05.49 PM.png](https://images.viblo.asia/fd844e3a-ae81-47a1-ac8b-9e416d1c89e9.png)

v√≠ d·ª• type `dockercfg/dockerconfigjson` d√πng ƒë·ªÉ k·∫øt n·ªëi t·ªõi private registry ƒë·ªÉ pull image, hi·ªán t·∫°i ta pull tr·ª±c ti·∫øp t·ª´ Dockerhub Public n√™n kh√¥ng c·∫ßn c√°i ƒë√≥. Hay type `service-account-token` d√†nh cho ServiceAccount, v√† m·ªôt s·ªë type kh√°c.

C√°c type n√†y h·∫ßu nh∆∞ ta kh√° √≠t ph·∫£i t·ª± tay tr·ª±c ti·∫øp t·∫°o ch√∫ng, ch√∫ng th∆∞·ªùng ƒë∆∞·ª£c t·∫°o lu√¥n b·∫±ng c√°c tool nh∆∞ Helm hay nh∆∞ l√∫c ta d√πng package d·∫°ng `cert-manager` n√≥ c≈©ng t·ª± t·∫°o cho ch√∫ng ta. C√≤n m·∫•y type v·ªÅ docker config ƒë·ªÉ pull image t·ª´ private registry th√¨ v√≠ d·ª• nh∆∞ m√¨nh d√πng Digital Ocean th√¨ h·ªç c√≥ option ƒë·ªÉ t·ª± ƒë·ªông inject (truy·ªÅn) config v√†o lu√¥n K8S cluster c·ªßa m√¨nh n·∫øu nh∆∞ m√¨nh d√πng Registry c·ªßa h·ªç
## T·∫°o Secret b·∫±ng command?
N·∫øu c√°c b·∫°n mu·ªën ƒëi "t√†u nhanh" d√πng Terminal ƒë·ªÉ t·∫°o secret th√¨ c≈©ng ƒë∆∞·ª£c. Ta d√πng c√°c command d·∫°ng nh∆∞ sau:
```
kubectl create secret generic prod-db-secret --from-literal=EMAIL=admin@test.com --from-literal=PASSWORD=123456
```
Nh∆∞ng nh∆∞ m√¨nh v·∫´n n√≥i, th√¨ ta lu√¥n ∆∞u ti√™n d√πng file manifest t·∫°o t·∫•t c·∫£ m·ªçi resource tr√™n K8S nh√©, ƒë·ªÉ sau n√†y c√≥ th·ªÉ puhs l√™n Git, d·ªÖ d√†ng cho vi·ªác xem l·∫°i v√† track thay ƒë·ªïi
## Nom Secret c√≥ kh√°c g√¨ ConfigMap ƒë√¢u???
ƒê·ªÉ √Ω th·∫•y r·∫±ng t·ª´ l√∫c ta ƒë·ªãnh nghƒ©a secret (type=Opaque) ƒë·∫øn l√∫c ta d√πng n√≥ ·ªü `env` hay mount n√≥ v√†o b·∫±ng `volumes` th√¨ c√≥ kh√°c g√¨ ConfigMap ƒë√¢u??? Ch·∫£ nh·∫Ω n√≥ ƒë∆∞·ª£c b·∫£o m·∫≠t h∆°n v√¨ ƒë∆∞·ª£c hash th√†nh base64 √†, m√† base64 th√¨ l√†m g√¨ c√≥ b·∫£o m·∫≠t v√¨ n√≥ c√≥ th·ªÉ ƒë∆∞·ª£c revert 1 c√°ch r·∫•t d·ªÖ d√†ng?? ü§îü§îü§î

C√°c b·∫°n n√≥i ƒë√∫ng suy nghƒ© c·ªßa m√¨nh l√∫c m·ªõi h·ªçc K8S r·ªìi ƒë√≥, m√¨nh ƒë√£ r·∫•t bƒÉn khoƒÉn l√† ·ªßa ch√∫ng c√≥ c√°i g√¨ kh√°c nhau nh·ªâ, m·∫•y c√°i m√¨nh hay d√πng b√™n secret th√¨ configmap c≈©ng c√≥ ƒë·ªß c·∫£, ch·∫£ thi·∫øu g√¨. Sao ng∆∞·ªùi ta l·∫°i ph·∫£i b√†y v·∫Ω ra th√™m 1 lo·∫°i l√†m g√¨ c∆° ch·ª©?, sao kh√¥ng d√πng 1 c√°i th√¥i????

Th√¨ t√¨m ƒë∆∞·ª£c c√¢u tr·∫£ l·ªùi [·ªü tr√™n StackOverflow](https://stackoverflow.com/a/36925553/7569705) t·ª´ tr·ª±c ti·∫øp author (ng∆∞·ªùi tham gia v√†o ph√°t tri·ªÉn) c·ªßa 2 t√≠nh n√†y nƒÉng n√†y.

ƒê∆°n gi·∫£n √¥ √Ω c≈©ng ch·ªâ n√≥i l√†:
- d√πng secret cho data "nh·∫°y c·∫£m"
- c√≤n configmap d√πng cho nh·ªØng th·ª© kh√¥ng nh·∫°y c·∫£m
- t∆∞∆°ng lai th√¨ h·ªç s·∫Ω th√™m nhi·ªÅu feature v√†o cho secret h∆°n n·ªØa

Nh∆∞ng th·∫≠t s·ª± v·ªõi m√¨nh th√¨ gi·∫£i th√≠ch nh∆∞ v·∫≠y ch∆∞a l√†m m√¨nh "tho·∫£ m√£n" v√¨ s·ª± kh√°c nhau gi·ªØa ch√∫ng v·∫´n ch∆∞a ƒë∆∞·ª£c n√≥i r√µ l√™n:
- v·∫≠y sao ta kh√¥ng d√πng lu√¥n secret cho r·ªìi??
- secret g·ªçi l√† l√†"b·∫£o m·∫≠t h∆°n" v√¨ n√≥ ƒë∆∞·ª£c m√£ ho√° base64 √†? base64 th√¨ l√†m g√¨ c√≥ b·∫£o m·∫≠t v√¨ n√≥ c√≥ th·ªÉ ƒë∆∞·ª£c revert (ƒë·∫£o ng∆∞·ª£c d·ªÖ d√†ng)??

·ªû th·ªùi ƒëi·ªÉm hi·ªán t·∫°i (2022), t·ª´ g√≥c ƒë·ªô c·ªßa c·ªßa m√¨nh th√¨ n√≥ v·∫´n h∆°i gi·ªëng ki·ªÉu "best pratice", ƒë√≥ l√† "·ª´, c·ª© c√°i n√†o nh·∫°y c·∫£m th√¨ n√™n d√πng secret, th·∫ø th√¥i" üòÖüòÖ
## L·∫•y to√†n b·ªô secret v√†o truy·ªÅn th·∫≥ng v√†o bi·∫øn m√¥i tr∆∞·ªùng
·ªû b√™n `Docker Compose` ta c√≥ th·ªÉ khai b√°o `env_file` ƒë·ªÉ truy·ªÅn to√†n b·ªô bi·∫øn ·ªü trong 1 file env n√†o ƒë√≥ v√†o bi·∫øn m√¥i tr∆∞·ªùng, ki·ªÉu nh∆∞ sau:
```
APP_NAME="Hello World"
EMAIL=admin@test.com
PASSWORD=123456
```

T∆∞∆°ng t·ª± ·ªü b√™n K8S th√¨ ta c≈©ng c√≥ th·ªÉ truy·ªÅn to√†n b·ªô ConfigMap hay Secret v√†o l√†m bi·∫øn m√¥i tr∆∞·ªùng, ·ªü file `myapp.yml` ph·∫ßn khai b√°o `containers` ta th√™m v√†o nh∆∞u sau l√† ƒë∆∞·ª£c:
```yml
      containers:
      - name: myapp-container
        image: maitrungduc1410/configmap-and-secret
        envFrom:
        - secretRef:
            name: myapp-secret
        - configMapRef:
            name: myapp-config
```
Ki·ªÉu n√†y m√¨nh kh√° l√† hay d√πng, v√¨ ƒë∆°n gi·∫£n v√† ti·ªán l·ª£i, m√¨nh th∆∞·ªùng t·ªï ch·ª©c c√°c file secret/configmap ki·ªÉu:
- file ch·ªâ ch·ª©a bi·∫øn m√¥i tr∆∞·ªùng ra 1 ki·ªÉu:
```yml
apiVersion: v1
kind: Secret
metadata:
  name: myapp-secret
type: Opaque
stringData:
  EMAIL: "newadmin@gmail.com"
  PASSWORD: "abcdefg"
```
- c√≤n l·∫°i n·∫øu file c√≥ ch·ª©a n·ªôi dung d√†i, d·∫°ng text b·∫•t k√¨ th√¨ ƒë∆∞a ra th√†nh c√°c configmap/secret ri√™ng:
```yml
apiVersion: v1
kind: Secret
metadata:
  name: myapp-secret
type: Opaque
stringData:
  file1.txt: |
    This is new secret
  file2.txt: |
    This is new secret
```

V√† nh∆∞ v·∫≠y th√¨ khi m√¨nh mu·ªën truy·ªÅn to√†n b·ªô configmap hay secret v√†o `env` s·∫Ω ti·ªán h∆°n, ƒë·ª° b·ªã mix gi·ªØa bi·∫øn m√¥i tr∆∞·ªùng v√† nh·ªØng d·∫°ng text ki·ªÉu file. ƒê√¢y l√† h∆∞·ªõng ƒëi c√° nh√¢n th√¥i nh√©, c√≤n ho√†n to√†n tu·ª≥ c√°c b·∫°n :D

## V·ªõi secret n√™n d√πng `stringData` hay `data`

C√¢u tr·∫£ l·ªùi l√† tu·ª≥ c√°c b·∫°n nh√©, v√¨ `stringData` th√¨ sau khi `apply` n√≥ c≈©ng ƒë∆∞·ª£c K8S convert th√†nh `data`, v√† gi·ªØa 2 c√°i ch·∫≥ng c√°i n√†o b·∫£o m·∫≠t h∆°n v√¨ base64 c·ªßa `data` th√¨ c≈©ng d·ªÖ d√†ng ƒë∆∞·ª£c revert :)
## Th√¥i b·ªè qua ConfigMap, c·ª© d√πng Secret cho l√†nh
Nh∆∞ ·ªü ph·∫ßn tr√™n m√¨nh n√≥i v·ªÅ s·ª± kh√°c bi·ªát gi·ªØa ConfigMap v√† Secret. Th√¨ v·ªõi nh·ªØng d·ªØ li·ªáu d·∫°ng kh√¥ng "nh·∫°y c·∫£m" th√¨ ta c√≥ th·ªÉ d√πng ConfigMap thay v√¨ Secret.

Nh∆∞ng th·∫≠t s·ª± n·∫øu c√°c b·∫°n n√≥i l√† th√¥i c·ª© d√πng Secret cho l√†nh th√¨ c≈©ng kh√¥ng sao c·∫£ :)

> M√† k·ªÉ ra n·∫øu c√°c b·∫°n bi·∫øt chia ƒë√¢u l√† configmap ƒë√¢u l√† secret, n√≥ c≈©ng cho th·∫•y c√°ch b·∫°n t·ªï ch·ª©c project, config,... t·ªët th·∫ø n√†o v√† b·∫°n hi·ªÉu project c·ªßa b·∫°n ra sao: c√°i n√†o nh·∫°y c·∫£m, c√°i n√†o kh√¥ng,.... ;), v·∫≠y n√™n c·ªë g·∫Øng ƒë·ª´ng m√°y m√≥c nh√©

# Ch·∫•m h·∫øt
Ph√πu...... b√†i t∆∞·ªüng ng·∫Øn m√† d√£i qu√° ƒë√°ng üòÇüòÇ

Mong l√† qua b√†i n√†y c√°c b·∫°n ƒë√£ bi·∫øt v·ªÅ ConfigMap v√† Secret tr√™n K8S, c√°c t·∫°o, s·ª≠ d·ª•ng, update,...Th·∫≠t ra n√≥i th√¨ nhi·ªÅu v·∫≠y ch·ª© th·ª±c t·∫ø th√¨ m√¨nh th·∫•y c√°ch d√πng n√≥ kh√° ƒë∆°n gi·∫£n. Ph·ªï bi·∫øn nh·∫•t l√† d√πng n√≥ ƒë·ªÉ truy·ªÅn bi·∫øn m√¥i tr∆∞·ªùng v√†o container, ƒë∆°n gi·∫£n nh∆∞ ƒëan r·ªï üòéüòé

Ch√∫c c√°c b·∫°n th·ª±c h√†nh vui v·∫ª. H·∫πn g·∫∑p l·∫°i c√°c b·∫°n ·ªü nh·ªØng b√†i sau ^^