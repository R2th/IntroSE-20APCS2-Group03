# Má»Ÿ Ä‘áº§u

![image.png](https://images.viblo.asia/f1b4437a-eaed-4fe1-b94a-9a39eca70673.png)

Bonobo Git Server lÃ  má»™t Git Server dÃ nh cho mÃ¡y chá»§ Windows, khi mÃ  Linux Ä‘Ã£ cÃ³ ráº¥t nhiá»u cÃ¡c giáº£i phÃ¡p xá»‹n xÃ² nhÆ° Git Lab, thÃ¬ cÃ³ váº» Ä‘á»‘i vá»›i ná»n táº£ng Windows, ngÆ°á»i dÃ¹ng khÃ´ng cÃ³ nhiá»u lá»±a chá»n. Bonobo Git Server hiá»‡n Ä‘ang cÃ³ hÆ¡n 1.7K star trÃªn Github vÃ  version hiá»‡n táº¡i Ä‘ang lÃ  6.5. PhiÃªn báº£n bá»‹ lá»—i lÃ  6.3. TrÆ°á»›c tiÃªn mÃ¬nh sáº½ Ä‘i vÃ o setup trÆ°á»›c Ä‘Ã£. BÃ i nÃ y mÃ¬nh sáº½ ghi cá»¥ thá»ƒ cÃ¡c bÆ°á»›c, coi nhÆ° lÃ  note láº¡i vá» cÃ¡ch debug .NET cho khá»i quÃªn vÃ  luyá»‡n skill debug .NET :joy:.

## CÃ i Ä‘áº·t

### IIS

TrÆ°á»›c tiÃªn lÃ  chÃºng ta cáº§n mÃ¡y áº£o, MÃ¬nh Ä‘Ã£ chuáº©n bá»‹ sáºµn má»™t mÃ¡y áº£o Win10, vÃ  báº¯t Ä‘áº§u cÃ i. ChÃºng ta vÃ o pháº§n **Turn Windows features on or off** tá»« *Control Panel* vÃ  báº­t cÃ¡c tÃ­nh nÄƒng sau Ä‘á»ƒ cÃ³ thá»ƒ cháº¡y Ä‘Æ°á»£c á»©ng dá»¥ng:

- Internet Information Services
- IIS Management Console
- ASP.NET 4.8
- Static Content

![image.png](https://images.viblo.asia/4878bee2-8861-4fc9-a282-f5b7e9111011.png)

Sau khi cÃ i xong vÃ  khá»Ÿi Ä‘á»™ng láº¡i chÃºng ta Ä‘Ã£ cÃ³ thá»ƒ truy cáº­p vÃ o mÃ n hÃ¬nh quáº£n lÃ½ cá»§a IIS.

### CÃ i Ä‘áº·t app

TrÃªn trang chá»§ Ä‘ang lÃ  phiÃªn báº£n má»›i nháº¥t, chÃºng ta táº£i phiÃªn báº£n lá»—i tá»« link sau: https://bonobogitserver.com/resources/releases/6_3_0.zip vÃ  giáº£i nÃ©n. Äá»ƒ Ä‘Æ°á»£c thÆ° má»¥c **Bonobo.Git.Server**. Copy thÆ° má»¥c nÃ y vÃ´ **C:\inetpub\wwwroot**

![image.png](https://images.viblo.asia/283da24e-c3d8-475b-b306-8778cab159e0.png)

á» Ä‘Ã¢y ta cáº§n Ä‘iá»u chá»‰nh quyá»n thÆ° má»¥c Ä‘á»ƒ user cá»§a IIS cÃ³ thá»ƒ chá»‰nh sá»­a Ä‘Æ°á»£c. Báº­t cáº¥u hÃ¬nh *Properties* cá»§a thÆ° má»¥c **App_Data** lÃªn, vÃ o chá»‰nh full quyá»n cho **IIS_IUSRS**:

![image.png](https://images.viblo.asia/6f812c08-ae7a-4b44-a717-83ebb24c1a21.png)

Giá» chuyá»ƒn qua mÃ n hÃ¬nh cá»§a **Internet Information Services (IIS) Manager**:

![image.png](https://images.viblo.asia/2381b3f9-2463-4639-8eef-ff51466840ea.png)

Chá»n *Convert to Application*, OK vá»›i cáº¥u hÃ¬nh máº·c Ä‘á»‹nh. Giá» vÃ o pháº§n **Authentication** cá»§a IIS vÃ  Ä‘áº£m báº£o lÃ  *Anonymous Authentication* Ä‘Æ°á»£c Enabled:

![image.png](https://images.viblo.asia/eeb20a74-20dd-4a08-98a5-7c7d82277ec0.png)

Truy cáº­p vÃ o http://localhost/Bonobo.Git.Server tháº¥y hiá»‡n ra giao diá»‡n vÃ  setup user admin nhÆ° váº§y lÃ  xong. Náº¿u Ä‘áº¿n Ä‘Ã¢y báº¡n váº«n chÆ°a cháº¡y Ä‘Æ°á»£c thÃ¬ cÃ³ thá»ƒ tham kháº£o thÃªm video: https://www.youtube.com/watch?v=S3Dm2Z-hc1o

![image.png](https://images.viblo.asia/ce0eded4-709c-4905-b530-8ed4758f557a.png)

### CÃ i Ä‘áº·t debug

Khi vÃ o thÆ° má»¥c bin ta cÃ³ thá»ƒ tháº¥y cÃ¡c file dll:

![image.png](https://images.viblo.asia/7b225286-ca2a-4643-b1d6-4d8ddc4aaa24.png)

File mÃ¬nh cáº§n quan tÃ¢m lÃ : **Bonobo.Git.Server.dll**. Báº­t [DnSpy](https://github.com/dnSpy/dnSpy) lÃªn, clear all táº¥t cáº£ cÃ¡c dll hiá»‡n cÃ³ vÃ  load dll nÃ y vÃ o:

![image.png](https://images.viblo.asia/31e0d545-17ba-4d31-8064-bd38351da616.png)

Tuy nhiÃªn, hiá»‡n giá» váº«n chÆ°a debug Ä‘Æ°á»£c do code Ä‘ang Ä‘Æ°á»£c precompiled, nÃªn dÃ¹ Ä‘áº·t breakpoint á»Ÿ file nÃ y, cÅ©ng sáº½ khÃ´ng hit breakpoint (vÃ¬ server dÃ¹ng file precompiled vÃ  cÃ³ dÃ¹ng file dll nÃ y Ä‘Ã¢u :joy:). Äá»ƒ cÃ³ thá»ƒ debug Ä‘Æ°á»£c thÃ¬ mÃ¬nh cáº§n disable tÃ­nh nÄƒng nÃ y, chi tiáº¿t tham kháº£o á»Ÿ Ä‘Ã¢y: https://blog.richardszalay.com/2019/06/14/debugging-sitecore-assemblies/

Sau khi táº£i file **IISAssemblyDebugging.psm1** tá»« link gist trong bÃ i, báº­t powershell má»›i vá»›i quyá»n admin vÃ  cháº¡y:

```powershell
Set-ExecutionPolicy -ExecutionPolicy Unrestricted
Import-Module .\IISAssemblyDebugging.psm1
Enable-IISAssemblyDebugging C:\inetpub\wwwroot\Bonobo.Git.Server\
```

Giá» chÃºng ta Ä‘Ã£ cÃ³ thá»ƒ Ä‘áº·t breakpoint vÃ  debug Ä‘Æ°á»£c rá»“i, báº¥m **Ctrl + Alt + P** hoáº·c tá»« menu Debug > Attach to Process, vÃ  chá»n **w3wp.exe**:

![image.png](https://images.viblo.asia/3dc833fb-7403-4d26-9a9a-da89ef2194ef.png)


## CVE 2019-11217

>  NgoÃ i ra cÃ²n cÃ³ CVE 2019-11218 liÃªn quan Ä‘áº¿n leo quyá»n tá»« auth user lÃªn admin, mÃ¬nh sáº½ Ä‘á»ƒ sau.

### TÃ¬m sink vÃ  source

Xem thÃ´ng tin trÃªn https://nvd.nist.gov/vuln/detail/CVE-2019-11217:

> The GitController in Jakub Chodounsky Bonobo Git Server before 6.5.0 allows execution of arbitrary commands in the context of the web server via a crafted http request.

Váº­y Ä‘Ã¢y lÃ  má»™t lá»—i RCE vÃ  cÃ³ váº» nhÆ° lÃ  unauthenticated. Tuy nhiÃªn thÃ´ng tin chÆ°a Ä‘Æ°á»£c Ä‘áº§y Ä‘á»§ láº¯m, tÃ¬m thÃªm á»Ÿ link https://flab.cesnet.cz/advisories/cve-2019-11217 cho chÃºng ta cÃ¡i nhÃ¬n chi tiáº¿t hÆ¡n:

> `Bonobo.Git.Server/Controllers/GitController.cs` at `private ActionResult GetInfoRefs(String repositoryName, String service)` calls `GitService.ExecuteServiceByName(â€¦)` without sanitizing user supplied string `serviceName`. Succesfull exploitation process involves creation of the new repository, management of repository configuration and executing arbitrary command through `core.editor` setting.

Chi tiáº¿t Ä‘Ã£ cÃ³, nhÆ°ng thay vÃ¬ Ä‘á»c patch thÃ¬ mÃ¬nh sáº½ Ä‘á»c code trÆ°á»›c, tÃ¬m Ä‘áº¿n file `GitController.cs`:

![image.png](https://images.viblo.asia/362e1db1-ad5f-4503-bfdd-41312cfc6201.png)

ChÃºng ta chÃº Ã½ Ä‘áº¿n dÃ²ng:

```
string serviceName = service.Substring(4);
```

Váº­y tham sá»‘ cáº§n cÃ³ Ä‘á»™ dÃ i tá»‘i thiá»ƒu 4 kÃ½ tá»±:

chá»n **Analyze**:

![image.png](https://images.viblo.asia/bd859898-bacb-4b69-8297-6db08bf5bcff.png)

method `GetInfoRefs` Ä‘Æ°á»£c dÃ¹ng duy nháº¥t bá»Ÿi `SecureGetInfoRefs`

![image.png](https://images.viblo.asia/45ce838e-cd60-40e9-b62d-767c7647940f.png)

ChÃºng ta tháº¥y Ä‘Ã£ xuáº¥t hiá»‡n tham sá»‘ `service` nhÆ° trong thÃ´ng tin. Äá»c nhanh qua hÃ m nÃ y ta cÃ³ thá»ƒ hiá»ƒu flow nhÆ° sau:
- Tham sá»‘ `service` sáº½ Ä‘Æ°á»£c kiá»ƒm tra vá»›i `git-receive-pack`, náº¿u Ä‘Ãºng lÃ  service nÃ y thÃ¬ sáº½ kiá»ƒm tra xem User hiá»‡n táº¡i cÃ³ quyá»n push Ä‘á»‘i vá»›i repo hay khÃ´ng. Náº¿u khÃ´ng thÃ¬ vÄƒng 401.
- TrÆ°á»ng há»£p cÃ²n láº¡i, náº¿u user (Ä‘Ã£ Ä‘Äƒng nháº­p hoáº·c anonymous) cÃ³ quyá»n xem repo thÃ¬ sáº½ Ä‘i vÃ o case trigger lá»—i.

Tuy nhiÃªn hÃ m nÃ y Ä‘Æ°á»£c gá»i tá»« Ä‘Ã¢u hoáº·c endpoint lÃ  gÃ¬ thÃ¬ chÃºng ta chÆ°a biáº¿t. Thá»­ tÃ¬m nhanh trÃªn github ta phÃ¡t hiá»‡n ra endpoint:

![image.png](https://images.viblo.asia/68ed9947-2aaa-42c2-bdfa-4f51b44cc3bf.png)


NhÆ° váº­y, Ä‘á»ƒ trigger Ä‘Æ°á»£c bug unauth thÃ¬ ta cáº§n GET Ä‘áº¿n link http://localhost/Bonobo.Git.Server/{repositoryName}.git/info/refs?service=xxxx vÃ  nhÆ° váº­y, server cáº§n pháº£i cÃ³ repo Ä‘Æ°á»£c public ra bÃªn ngoÃ i (chá»‰ cáº§n xem, khÃ´ng cáº§n push code). MÃ¬nh setup má»™t repo má»›i `public-repo` nhÆ° sau:

![image.png](https://images.viblo.asia/28db4810-99ca-4435-b738-3be837bb603d.png)

Giá» Ä‘áº·t breakpoint á»Ÿ Ä‘áº§u method `SecureGetInfoRefs` vÃ  truy cáº­p vÃ o link: http://localhost/Bonobo.Git.Server/public-repo.git/info/refs?service=git-receive-pack thÃ¬ hit breakpoint:

![image.png](https://images.viblo.asia/a6712eeb-4f0d-4758-880c-aee6854956c7.png)

OK, váº­y lÃ  xong pháº§n source, giá» chÃºng ta sáº½ xem tiáº¿p pháº§n sink. TÃ¬m Ä‘áº¿n `GitService.ExecuteServiceByName`, Ä‘áº·t breakpoint á»Ÿ dÃ²ng 31 vÃ  continue:

![image.png](https://images.viblo.asia/600bbc1e-ae15-47e3-a279-de7ebe6a7ca4.png)

ChÃºng ta cÃ³ thá»ƒ tháº¥y ráº¥t rÃµ cÃ¡c tham sá»‘ Ä‘Æ°á»£c truyá»n vÃ o. Tham sá»‘ `serviceName` Ä‘Ã£ bá»‹ cáº¯t Ä‘i 4 kÃ½ tá»± Ä‘áº§u vÃ  chá»‰ cÃ²n `receive-pack` vÃ  Ä‘Æ°á»£c ná»‘i chuá»—i vá»›i cÃ¡c tham sá»‘ khÃ¡c Ä‘á»ƒ Ä‘Æ°a vÃ o lÃ m tham sá»‘ cho `git.exe` (náº±m á»Ÿ **C:\inetpub\wwwroot\Bonobo.Git.Server\App_Data\Git**) vÃ  thá»±c thi.

VÃ  Ä‘Ãºng lÃ  báº£n patch Ä‘Ã£ confirm format cá»§a tham sá»‘ nhÆ° váº­y: https://github.com/jakubgarfield/Bonobo-Git-Server/commit/2e547948f394e78e4cd03c46543b33059ff444cd#diff-45dd4dd61d7c23aa8787e129094a7ba2842de4ea2067538a9f685f6c2cc2e7ef

![image.png](https://images.viblo.asia/002371c4-3a8d-45b6-8ca4-c7b5c18f26f6.png)

Setup Process Monitor vÃ  filter cÃ¡c process `git.exe`:

![image.png](https://images.viblo.asia/9fe24c3f-3e56-4265-97cc-f67ee89255f4.png)

sau Ä‘Ã³ continue, ta sáº½ tháº¥y `git.exe` Ä‘Æ°á»£c thá»±c thi, sau Ä‘Ã³ spawn `git-receive-pack.exe` vÃ  thá»±c thi:

![image.png](https://images.viblo.asia/9b0ebc4f-345f-4b04-a7c5-4a34c96f2fbe.png)

### Báº¿ Stuck

Sau má»™t há»“i thá»­ cÃ¡c tham sá»‘ khÃ¡c nhau thÃ¬ mÃ¬nh nháº­n tháº¥y:

- ChÃºng ta chá»‰ cÃ³ thá»ƒ execute cÃ¡c sub command cá»§a git chá»© khÃ´ng break out ra ngoÃ i vÃ  cháº¡y cÃ¡c cmd tÃ¹y Ã½ Ä‘Æ°á»£c (cÅ©ng giá»‘ng nhÆ° trong miÃªu táº£ cá»§a CVE). LÃ½ do lÃ  payload cá»§a chÃºng ta Ä‘Ã£ Ä‘Æ°á»£c Ä‘Æ°a vÃ o lÃ m tham sá»‘ cá»§a `ProcessStartInfo`:

```csharp
var info = new ProcessStartInfo(gitPath, args)
```

- CÃ¡c cÃ¢u lá»‡nh thá»±c thi Ä‘á»u sáº½ cÃ³ 2 tham sá»‘ `--stateless-rpc` vÃ  `--advertise-refs` vÃ  cáº£ nhá»¯ng tham sá»‘ Ä‘áº±ng sau ná»¯a, nÃªn khÃ´ng pháº£i command nÃ o cÅ©ng cháº¡y Ä‘Æ°á»£c, thÆ°á»ng sáº½ vÄƒng ra exit code 129 hoáº·c 128, do dÃ¹ng sai hÆ°á»›ng dáº«n sá»­ dá»¥ng ğŸ˜¥ vÃ  mÃ¬nh Ä‘ang stuck á»Ÿ Ä‘Ã¢y.
- Thá»­ thÃªm hÆ°á»›ng add thÃªm config thÃ´ng qua `git config` Ä‘á»ƒ thÃªm cáº¥u hÃ¬nh `core.editor` vÃ o cÅ©ng váº«n Ä‘ang chÆ°a lÃ m sao Ä‘á»ƒ ignore Ä‘á»‘ng param cá»§ chuá»‘i Ä‘áº±ng sau Ä‘Æ°á»£c.

![image.png](https://images.viblo.asia/b2c258a4-86de-4d1f-9660-2204e9708b13.png)

### Update 1

Nhá» sá»± trá»£ giÃºp cá»§a ngÆ°á»i em @minhtuan.nguy , mÃ¬nh Ä‘Ã£ cÃ³ thá»ƒ update Ä‘Æ°á»£c setting cá»§a `core.editor` thÃ nh binary mong muá»‘n. 

![image.png](https://images.viblo.asia/cd3c668c-0439-46c1-9846-1c68975b780c.png)

@minhtuan.nguy sá»­ dá»¥ng trick thÃªm `"` vÃ o trÆ°á»›c binary Ä‘á»ƒ Ä‘Æ°a toÃ n bá»™ pháº§n Ä‘áº±ng sau thÃ nh cmd, vÃ  vá»›i `calc.exe` khÃ´ng nháº­n tham sá»‘ thÃ¬ khi trigger RCE sáº½ khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng:
Vá»›i cÃ¡ch nÃ y, cmd ban Ä‘áº§u:

```shell
"C:\inetpub\wwwroot\Bonobo.Git.Server\App_Data\Git\git.exe" {payload} --stateless-rpc --advertise-refs C:\inetpub\wwwroot\Bonobo.Git.Server\App_Data\Repositories\public-repo                    
```

Sáº½ trá»Ÿ thÃ nh

```shell
"C:\inetpub\wwwroot\Bonobo.Git.Server\App_Data\Git\git.exe" "{payload} --stateless-rpc --advertise-refs C:\inetpub\wwwroot\Bonobo.Git.Server\App_Data\Repositories\public-repo"
```
vÃ  káº¿t quáº£

![image.png](https://images.viblo.asia/51ed207f-156e-4c07-bcf1-78c6aa8f65e5.png)

BÆ°á»›c tiáº¿p theo lÃ  trigger RCE thÃ´ng qua viá»‡c invoke `core.editor`, theo mÃ¬nh biáº¿t thÃ¬ cÃ³ thá»ƒ thÃ´ng qua má»™t sá»‘ lá»‡nh

- `git config -e -f {tÃªn báº¥t ká»³}`
- `git commit`
- `git commit --amend`

Tuy nhiÃªn váº«n lÃ  váº¥n Ä‘á» cáº§n Ä‘iá»u chá»‰nh Ä‘Æ°a pháº§n param thá»«a Ä‘áº±ng sau `--stateless-rpc...` lÃ m sao cho thÃ nh cÃ¢u lá»‡nh há»£p lá»‡ :joy: 
 
Updating... (náº¿u tÃ¬m ra Ä‘Æ°á»£c cÃ¡ch trigger RCE)

## The End

ğŸ‡»ğŸ‡³ğŸ‡»ğŸ‡³ğŸ‡»ğŸ‡³