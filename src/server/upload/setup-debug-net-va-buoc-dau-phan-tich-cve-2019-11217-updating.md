# Mở đầu

![image.png](https://images.viblo.asia/f1b4437a-eaed-4fe1-b94a-9a39eca70673.png)

Bonobo Git Server là một Git Server dành cho máy chủ Windows, khi mà Linux đã có rất nhiều các giải pháp xịn xò như Git Lab, thì có vẻ đối với nền tảng Windows, người dùng không có nhiều lựa chọn. Bonobo Git Server hiện đang có hơn 1.7K star trên Github và version hiện tại đang là 6.5. Phiên bản bị lỗi là 6.3. Trước tiên mình sẽ đi vào setup trước đã. Bài này mình sẽ ghi cụ thể các bước, coi như là note lại về cách debug .NET cho khỏi quên và luyện skill debug .NET :joy:.

## Cài đặt

### IIS

Trước tiên là chúng ta cần máy ảo, Mình đã chuẩn bị sẵn một máy ảo Win10, và bắt đầu cài. Chúng ta vào phần **Turn Windows features on or off** từ *Control Panel* và bật các tính năng sau để có thể chạy được ứng dụng:

- Internet Information Services
- IIS Management Console
- ASP.NET 4.8
- Static Content

![image.png](https://images.viblo.asia/4878bee2-8861-4fc9-a282-f5b7e9111011.png)

Sau khi cài xong và khởi động lại chúng ta đã có thể truy cập vào màn hình quản lý của IIS.

### Cài đặt app

Trên trang chủ đang là phiên bản mới nhất, chúng ta tải phiên bản lỗi từ link sau: https://bonobogitserver.com/resources/releases/6_3_0.zip và giải nén. Để được thư mục **Bonobo.Git.Server**. Copy thư mục này vô **C:\inetpub\wwwroot**

![image.png](https://images.viblo.asia/283da24e-c3d8-475b-b306-8778cab159e0.png)

Ở đây ta cần điều chỉnh quyền thư mục để user của IIS có thể chỉnh sửa được. Bật cấu hình *Properties* của thư mục **App_Data** lên, vào chỉnh full quyền cho **IIS_IUSRS**:

![image.png](https://images.viblo.asia/6f812c08-ae7a-4b44-a717-83ebb24c1a21.png)

Giờ chuyển qua màn hình của **Internet Information Services (IIS) Manager**:

![image.png](https://images.viblo.asia/2381b3f9-2463-4639-8eef-ff51466840ea.png)

Chọn *Convert to Application*, OK với cấu hình mặc định. Giờ vào phần **Authentication** của IIS và đảm bảo là *Anonymous Authentication* được Enabled:

![image.png](https://images.viblo.asia/eeb20a74-20dd-4a08-98a5-7c7d82277ec0.png)

Truy cập vào http://localhost/Bonobo.Git.Server thấy hiện ra giao diện và setup user admin như vầy là xong. Nếu đến đây bạn vẫn chưa chạy được thì có thể tham khảo thêm video: https://www.youtube.com/watch?v=S3Dm2Z-hc1o

![image.png](https://images.viblo.asia/ce0eded4-709c-4905-b530-8ed4758f557a.png)

### Cài đặt debug

Khi vào thư mục bin ta có thể thấy các file dll:

![image.png](https://images.viblo.asia/7b225286-ca2a-4643-b1d6-4d8ddc4aaa24.png)

File mình cần quan tâm là: **Bonobo.Git.Server.dll**. Bật [DnSpy](https://github.com/dnSpy/dnSpy) lên, clear all tất cả các dll hiện có và load dll này vào:

![image.png](https://images.viblo.asia/31e0d545-17ba-4d31-8064-bd38351da616.png)

Tuy nhiên, hiện giờ vẫn chưa debug được do code đang được precompiled, nên dù đặt breakpoint ở file này, cũng sẽ không hit breakpoint (vì server dùng file precompiled và có dùng file dll này đâu :joy:). Để có thể debug được thì mình cần disable tính năng này, chi tiết tham khảo ở đây: https://blog.richardszalay.com/2019/06/14/debugging-sitecore-assemblies/

Sau khi tải file **IISAssemblyDebugging.psm1** từ link gist trong bài, bật powershell mới với quyền admin và chạy:

```powershell
Set-ExecutionPolicy -ExecutionPolicy Unrestricted
Import-Module .\IISAssemblyDebugging.psm1
Enable-IISAssemblyDebugging C:\inetpub\wwwroot\Bonobo.Git.Server\
```

Giờ chúng ta đã có thể đặt breakpoint và debug được rồi, bấm **Ctrl + Alt + P** hoặc từ menu Debug > Attach to Process, và chọn **w3wp.exe**:

![image.png](https://images.viblo.asia/3dc833fb-7403-4d26-9a9a-da89ef2194ef.png)


## CVE 2019-11217

>  Ngoài ra còn có CVE 2019-11218 liên quan đến leo quyền từ auth user lên admin, mình sẽ để sau.

### Tìm sink và source

Xem thông tin trên https://nvd.nist.gov/vuln/detail/CVE-2019-11217:

> The GitController in Jakub Chodounsky Bonobo Git Server before 6.5.0 allows execution of arbitrary commands in the context of the web server via a crafted http request.

Vậy đây là một lỗi RCE và có vẻ như là unauthenticated. Tuy nhiên thông tin chưa được đầy đủ lắm, tìm thêm ở link https://flab.cesnet.cz/advisories/cve-2019-11217 cho chúng ta cái nhìn chi tiết hơn:

> `Bonobo.Git.Server/Controllers/GitController.cs` at `private ActionResult GetInfoRefs(String repositoryName, String service)` calls `GitService.ExecuteServiceByName(…)` without sanitizing user supplied string `serviceName`. Succesfull exploitation process involves creation of the new repository, management of repository configuration and executing arbitrary command through `core.editor` setting.

Chi tiết đã có, nhưng thay vì đọc patch thì mình sẽ đọc code trước, tìm đến file `GitController.cs`:

![image.png](https://images.viblo.asia/362e1db1-ad5f-4503-bfdd-41312cfc6201.png)

Chúng ta chú ý đến dòng:

```
string serviceName = service.Substring(4);
```

Vậy tham số cần có độ dài tối thiểu 4 ký tự:

chọn **Analyze**:

![image.png](https://images.viblo.asia/bd859898-bacb-4b69-8297-6db08bf5bcff.png)

method `GetInfoRefs` được dùng duy nhất bởi `SecureGetInfoRefs`

![image.png](https://images.viblo.asia/45ce838e-cd60-40e9-b62d-767c7647940f.png)

Chúng ta thấy đã xuất hiện tham số `service` như trong thông tin. Đọc nhanh qua hàm này ta có thể hiểu flow như sau:
- Tham số `service` sẽ được kiểm tra với `git-receive-pack`, nếu đúng là service này thì sẽ kiểm tra xem User hiện tại có quyền push đối với repo hay không. Nếu không thì văng 401.
- Trường hợp còn lại, nếu user (đã đăng nhập hoặc anonymous) có quyền xem repo thì sẽ đi vào case trigger lỗi.

Tuy nhiên hàm này được gọi từ đâu hoặc endpoint là gì thì chúng ta chưa biết. Thử tìm nhanh trên github ta phát hiện ra endpoint:

![image.png](https://images.viblo.asia/68ed9947-2aaa-42c2-bdfa-4f51b44cc3bf.png)


Như vậy, để trigger được bug unauth thì ta cần GET đến link http://localhost/Bonobo.Git.Server/{repositoryName}.git/info/refs?service=xxxx và như vậy, server cần phải có repo được public ra bên ngoài (chỉ cần xem, không cần push code). Mình setup một repo mới `public-repo` như sau:

![image.png](https://images.viblo.asia/28db4810-99ca-4435-b738-3be837bb603d.png)

Giờ đặt breakpoint ở đầu method `SecureGetInfoRefs` và truy cập vào link: http://localhost/Bonobo.Git.Server/public-repo.git/info/refs?service=git-receive-pack thì hit breakpoint:

![image.png](https://images.viblo.asia/a6712eeb-4f0d-4758-880c-aee6854956c7.png)

OK, vậy là xong phần source, giờ chúng ta sẽ xem tiếp phần sink. Tìm đến `GitService.ExecuteServiceByName`, đặt breakpoint ở dòng 31 và continue:

![image.png](https://images.viblo.asia/600bbc1e-ae15-47e3-a279-de7ebe6a7ca4.png)

Chúng ta có thể thấy rất rõ các tham số được truyền vào. Tham số `serviceName` đã bị cắt đi 4 ký tự đầu và chỉ còn `receive-pack` và được nối chuỗi với các tham số khác để đưa vào làm tham số cho `git.exe` (nằm ở **C:\inetpub\wwwroot\Bonobo.Git.Server\App_Data\Git**) và thực thi.

Và đúng là bản patch đã confirm format của tham số như vậy: https://github.com/jakubgarfield/Bonobo-Git-Server/commit/2e547948f394e78e4cd03c46543b33059ff444cd#diff-45dd4dd61d7c23aa8787e129094a7ba2842de4ea2067538a9f685f6c2cc2e7ef

![image.png](https://images.viblo.asia/002371c4-3a8d-45b6-8ca4-c7b5c18f26f6.png)

Setup Process Monitor và filter các process `git.exe`:

![image.png](https://images.viblo.asia/9fe24c3f-3e56-4265-97cc-f67ee89255f4.png)

sau đó continue, ta sẽ thấy `git.exe` được thực thi, sau đó spawn `git-receive-pack.exe` và thực thi:

![image.png](https://images.viblo.asia/9b0ebc4f-345f-4b04-a7c5-4a34c96f2fbe.png)

### Bế Stuck

Sau một hồi thử các tham số khác nhau thì mình nhận thấy:

- Chúng ta chỉ có thể execute các sub command của git chứ không break out ra ngoài và chạy các cmd tùy ý được (cũng giống như trong miêu tả của CVE). Lý do là payload của chúng ta đã được đưa vào làm tham số của `ProcessStartInfo`:

```csharp
var info = new ProcessStartInfo(gitPath, args)
```

- Các câu lệnh thực thi đều sẽ có 2 tham số `--stateless-rpc` và `--advertise-refs` và cả những tham số đằng sau nữa, nên không phải command nào cũng chạy được, thường sẽ văng ra exit code 129 hoặc 128, do dùng sai hướng dẫn sử dụng 😥 và mình đang stuck ở đây.
- Thử thêm hướng add thêm config thông qua `git config` để thêm cấu hình `core.editor` vào cũng vẫn đang chưa làm sao để ignore đống param củ chuối đằng sau được.

![image.png](https://images.viblo.asia/b2c258a4-86de-4d1f-9660-2204e9708b13.png)

### Update 1

Nhờ sự trợ giúp của người em @minhtuan.nguy , mình đã có thể update được setting của `core.editor` thành binary mong muốn. 

![image.png](https://images.viblo.asia/cd3c668c-0439-46c1-9846-1c68975b780c.png)

@minhtuan.nguy sử dụng trick thêm `"` vào trước binary để đưa toàn bộ phần đằng sau thành cmd, và với `calc.exe` không nhận tham số thì khi trigger RCE sẽ không bị ảnh hưởng:
Với cách này, cmd ban đầu:

```shell
"C:\inetpub\wwwroot\Bonobo.Git.Server\App_Data\Git\git.exe" {payload} --stateless-rpc --advertise-refs C:\inetpub\wwwroot\Bonobo.Git.Server\App_Data\Repositories\public-repo                    
```

Sẽ trở thành

```shell
"C:\inetpub\wwwroot\Bonobo.Git.Server\App_Data\Git\git.exe" "{payload} --stateless-rpc --advertise-refs C:\inetpub\wwwroot\Bonobo.Git.Server\App_Data\Repositories\public-repo"
```
và kết quả

![image.png](https://images.viblo.asia/51ed207f-156e-4c07-bcf1-78c6aa8f65e5.png)

Bước tiếp theo là trigger RCE thông qua việc invoke `core.editor`, theo mình biết thì có thể thông qua một số lệnh

- `git config -e -f {tên bất kỳ}`
- `git commit`
- `git commit --amend`

Tuy nhiên vẫn là vấn đề cần điều chỉnh đưa phần param thừa đằng sau `--stateless-rpc...` làm sao cho thành câu lệnh hợp lệ :joy: 
 
Updating... (nếu tìm ra được cách trigger RCE)

## The End

🇻🇳🇻🇳🇻🇳