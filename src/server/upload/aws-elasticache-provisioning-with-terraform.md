## Gi·ªõi thi·ªáu
Ch√†o c√°c b·∫°n, ·ªü b√†i tr∆∞·ªõc ch√∫ng ta ƒë√£ t√¨m hi·ªÉu v·ªÅ nh·ªØng m√¥ h√¨nh tri·ªÉn khai c·ªßa Elasticache tr√™n AWS. ·ªû b√†i n√†y ch√∫ng ta s·∫Ω t√¨m hi·ªÉu c√°ch d√πng Terraform ƒë·ªÉ tri·ªÉn khai c√°c m√¥ h√¨nh c·ªßa Elasticache, bao g·ªìm:

1. [Memcached: cluster](https://viblo.asia/p/aws-elasticache-cache-deployment-options-LzD5dR2OZjY#_memcached-cluster-1).
2. [Redis: single node](https://viblo.asia/p/aws-elasticache-cache-deployment-options-LzD5dR2OZjY#_redis-single-node-cluster-2).
3. [Redis: cluster mode disabled](https://viblo.asia/p/aws-elasticache-cache-deployment-options-LzD5dR2OZjY#_redis-cluster-mode-disabled-4).
4. [Redis: cluster mode enabled](https://viblo.asia/p/aws-elasticache-cache-deployment-options-LzD5dR2OZjY#_redis-cluster-mode-enabled-5).

C√°c b·∫°n n√™n ƒë·ªçc b√†i tr∆∞·ªõc ƒë·ªÉ hi·ªÉu r√µ l√Ω thuy·∫øt c·ªßa t·ª´ng d·∫°ng.

![](https://images.viblo.asia/aaa3aabe-a27e-42b7-934b-da35b14fb1b1.png)

## Prepare
ƒê·ªëi v·ªõi Elasticache th√¨ ƒë·∫ßu ti√™n ta ph·∫£i t·∫°o cho n√≥ m·ªôt *subnet group* tr∆∞·ªõc.

![](https://images.viblo.asia/8b6596e9-459b-4ed5-8853-3fc1da0e2d08.png)

Subnet group s·∫Ω bao g·ªìm c√°c subnet m√† ta mu·ªën Elasticache ƒë∆∞·ª£c tri·ªÉn khai tr√™n ƒë√≥. T·∫°o m·ªôt file t√™n l√† `main.tf` v·ªõi ƒëo·∫°n code sau.

```main.tf
provider "aws" {
  region  = "us-west-2"
}

data "aws_subnets" "all" {}

resource "aws_elasticache_subnet_group" "group_name" {
  name       = "elasticache"
  subnet_ids = data.aws_subnets.all.ids
}
```

Ta d√πng resource `aws_elasticache_subnet_group` ƒë·ªÉ t·∫°o *subnet group* b·∫±ng Terraform. Ch·∫°y c√¢u l·ªánh sau ƒë·ªÉ Terraform t·∫°o subnet group.

```
terraform init && terraform apply -auto-approve
```

Ti·∫øp theo ta s·∫Ω b·∫Øt ƒë·∫ßu v·ªõi d·∫°ng tri·ªÉn khai ƒë·∫ßu ti√™n c·ªßa Elasticache l√† Memcached Cluster.

## Memcached Cluster
·ªû d·∫°ng deploy n√†y, ta s·∫Ω c√≥ m·ªôt Memcached Cluster bao g·ªìm 1-20 node.

![image.png](https://images.viblo.asia/119facb6-33c9-43df-b14f-0bed24c17b08.png)

T·∫°o m·ªôt file t√™n l√† `memcached.tf`.

```memcached.tf
resource "aws_elasticache_cluster" "memcached" {
  cluster_id           = "memcached-single-node"
  engine               = "memcached"
  node_type            = "cache.m4.large"
  num_cache_nodes      = 1
  parameter_group_name = "default.memcached1.6"

  subnet_group_name  = aws_elasticache_subnet_group.group_name.name
  security_group_ids = [aws_security_group.allow_memcached.id]
}

resource "aws_security_group" "allow_memcached" {
  name = "allow-memcached"

  ingress {
    from_port   = 11211
    to_port     = 11211
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

output "memcached" {
  value = aws_elasticache_cluster.memcached.cache_nodes
}
```

Ta s·∫Ω d√πng resource `aws_elasticache_cluster` ƒë·ªÉ t·∫°o m·ªôt Elasticache Cluster, v√† ƒë·ªÉ ch·ªçn lo·∫°i Elasticache m√† ta s·∫Ω t·∫°o l√† *memcached* th√¨ ·ªü thu·ªôc t√≠nh `engine` ta ƒë·ªÉ l√† `memcached`.

Thu·ªôc t√≠nh *nodetype* ta d√πng ƒë·ªÉ ch·ªçn s·ªë l∆∞·ª£ng CPU v√† Memory ta mu·ªën c·∫•p cho con memcached n√†y, v√≠ d·ª• `cache.m4.large` l√† 2 vCPU v√† 6.42 GiB Memory.

Thu·ªôc t√≠nh `num_cache_nodes` ta d√πng ƒë·ªÉ ch·ªâ ƒë·ªãnh c√≥ bao nhi√™u *node* s·∫Ω ƒë∆∞·ª£c t·∫°o, ·ªü ƒë√¢y ta ch·ªâ ƒë·ªãnh l√† 1.

·ªû thu·ªôc t√≠nh `subnet_group_name` ta truy·ªÅn v√†o t√™n subnet group ta v·ª´a t·∫°o khi n√£y, cu·ªëi c√πng ƒë·ªÉ c√≥ th·ªÉ truy c·∫≠p ƒë∆∞·ª£c con memcached n√†y ·ªü trong VPC th√¨ ta ph·∫£i m·ªü port 11211 b·∫±ng Security Group cho n√≥, n√™n ·ªü d∆∞·ªõi ta c√≥ th√™m m·ªôt resource l√† `aws_security_group`.

Ch·ªâ v·ªõi v√†i d√≤ng code ƒë∆°n gi·∫£n v·∫≠y th√¥i, ti·∫øp theo ta ch·∫°y c√¢u l·ªánh Terraform ƒë·ªÉ t·∫°o Elasticache lo·∫°i Memcached.

```
terraform apply -auto-approve
```

Con n√†y t·∫°o kh√° t·ªën th·ªùi gian n√™n c√°c b·∫°n ƒë·ª£i n√≥ t·∫°o xong nh√© üòÅ.

```
...
Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

Outputs:

memcached = tolist([
  {
    "address" = "memcached-single-node.gupsag.0001.usw2.cache.amazonaws.com"
    "availability_zone" = "us-west-2b"
    "id" = "0001"
    "port" = 11211
  },
])
```

Ti·∫øp theo ta s·∫Ω t·∫°o Elasticache d·∫°ng Redis Single Node.

## Redis Single Node
·ªû d·∫°ng deploy n√†y ta s·∫Ω ch·ªâ c√≥ 1 node l√† redis, sharding v√† high availability s·∫Ω kh√¥ng c√≥ trong mode redis single node.

![image.png](https://images.viblo.asia/b0524533-014f-4811-85c8-b50cafab2076.png)

T·∫°o m·ªôt file t√™n l√† `redis-sn.tf`.

```redis-sn.tf
resource "aws_elasticache_cluster" "redis" {
  cluster_id           = "redis-single-node"
  engine               = "redis"
  node_type            = "cache.m4.large"
  num_cache_nodes      = 1
  parameter_group_name = "default.redis6.x"
  engine_version       = "6.x"

  subnet_group_name  = aws_elasticache_subnet_group.group_name.name
  security_group_ids = [aws_security_group.allow_redis.id]
}

resource "aws_security_group" "allow_redis" {
  name = "allow-redis"

  ingress {
    from_port   = 6379
    to_port     = 6379
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

output "redis" {
  value = aws_elasticache_cluster.redis.cache_nodes
}
```

ƒê·ªÉ t·∫°o Elasticache d·∫°ng redis th√¨ ta v·∫´n d√πng resource `aws_elasticache_cluster`, ta ch·ªâ c·∫ßn thay ƒë·ªïi thu·ªôc t√≠nh `engine` th√†nh `redis` l√† ƒë∆∞·ª£c, v√† ·ªü thu·ªôc t√≠nh `parameter_group_name` ta thay ƒë·ªïi th√†nh `default.redis6.x`.

C√°c b·∫°n ch·∫°y c√¢u l·ªánh Terraform ƒë·ªÉ t·∫°o Elasticache d·∫°ng redis single node.

```
terraform apply -auto-approve
```

K·∫øt qu·∫£.

```
...
Apply complete! Resources: 2 added, 0 changed, 0 destroyed.

Outputs:

memcached = tolist([
  {
    "address" = "memcached-single-node.gupsag.0001.usw2.cache.amazonaws.com"
    "availability_zone" = "us-west-2b"
    "id" = "0001"
    "port" = 11211
  },
])
redis = tolist([
  {
    "address" = "redis-single-node.gupsag.0001.usw2.cache.amazonaws.com"
    "availability_zone" = "us-west-2b"
    "id" = "0001"
    "port" = 6379
  },
])
```

## Redis Cluster Mode Disabled
·ªû d·∫°ng deploy n√†y, ta s·∫Ω c√≥ m·ªôt Redis Cluster ch·ªâ c√≥ 1 Shard v·ªõi s·ªë l∆∞·ª£ng node c·ªßa Shard l√† 1 t·ªõi 6 node.

![image.png](https://images.viblo.asia/76eed7e0-fbf4-4eb8-a518-750cb9375535.png)

T·∫°o m·ªôt file t√™n l√† `redis-cluster-disable.tf`.

```redis-cluster-disable.tf
resource "aws_elasticache_replication_group" "redis_cluster_disable" {
  replication_group_id = "redis-cluster-mode-disable"
  engine               = "redis"
  num_cache_clusters   = 2
  parameter_group_name = "default.redis6.x"
  engine_version       = "6.x"
  node_type            = "cache.t2.micro"
  description          = "Redis cluster mode disable"

  subnet_group_name  = aws_elasticache_subnet_group.group_name.name
  security_group_ids = [aws_security_group.allow_redis.id]
}

output "redis-cluster-mode-disable" {
  value = aws_elasticache_replication_group.redis_cluster_disable.primary_endpoint_address
}
```

ƒê·ªÉ t·∫°o Elasticache d·∫°ng Redis Cluster Mode th√¨ ta s·∫Ω d√πng resource `aws_elasticache_replication_group`. V√† ƒë·ªÉ x√°c ƒë·ªãnh c√≥ b·∫≠t ch·∫ø ƒë·ªô Cluster hay kh√¥ng, ta s·∫Ω d√πng 3 thu·ªôc t√≠nh sau:

+ num_cache_clusters
+ num_node_groups
+ replicas_per_node_group

V·ªõi d·∫°ng Cluster Mode Disbale th√¨ ta s·∫Ω s·ª≠ d·ª•ng thu·ªôc t√≠nh `num_cache_clusters`. C√°c b·∫°n ch·∫°y c√¢u l·ªánh Terraform ƒë·ªÉ t·∫°o Elasticache d·∫°ng redis cluster mode disbale.

```
terraform apply -auto-approve
```

K·∫øt qu·∫£.

```
...
Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

Outputs:
...
redis-cluster-mode-disable = "redis-cluster-mode-disable.gupsag.ng.0001.usw2.cache.amazonaws.com"
```

## Redis Cluster Mode Enabled
ƒê√¢y l√† d·∫°ng tri·ªÉn khai cu·ªëi c√πng c·ªßa Elasticache, ·ªü d·∫°ng deploy n√†y Redis Cluster c·ªßa ta s·∫Ω c√≥ nhi·ªÅu shards v√† m·ªói shard c≈©ng s·∫Ω c√≥ 1 t·ªõi 6 node. V√† s·ªë l∆∞·ª£ng Shard ta c√≥ th·ªÉ deploy l√† 500 => Maximun node c·ªßa d·∫°ng Redis cluster mode enabled l√† 3000 node.

![image.png](https://images.viblo.asia/b40bfbf5-e067-47ad-af2c-1ffd628574ec.png)

T·∫°o m·ªôt file t√™n l√† `redis-cluster-enable.tf`.

```redis-cluster-enable.tf
resource "aws_elasticache_replication_group" "redis_cluster_enable" {
  replication_group_id       = "redis-cluster-mode-enable"
  engine                     = "redis"
  num_node_groups            = 2
  replicas_per_node_group    = 1
  parameter_group_name       = "default.redis6.x.cluster.on"
  automatic_failover_enabled = true
  engine_version             = "6.x"
  node_type                  = "cache.t2.micro"
  description                = "Redis cluster mode enable"

  subnet_group_name  = aws_elasticache_subnet_group.group_name.name
  security_group_ids = [aws_security_group.allow_redis.id]
}

output "redis-cluster-mode-disable" {
  value = aws_elasticache_replication_group.redis_cluster_enable.primary_endpoint_address
}
```

ƒê·ªÉ ch·ªâ ƒë·ªãnh d·∫°ng Cluster Mode Enbale th√¨ ta ch·ªâ c·∫ßn b·ªè thu·ªôc t√≠nh `num_cache_clusters` v√† thay b·∫±ng thu·ªôc t√≠nh `num_node_groups` v·ªõi `replicas_per_node_group`. V·ªõi `num_node_groups` s·∫Ω ch·ªâ ƒë·ªãnh s·ªë l∆∞·ª£ng shard v√† `replicas_per_node_group` s·∫Ω ch·ªânh ƒë·ªãnh s·ªë l∆∞·ª£ng node trong m·ªói share.

Thu·ªôc t√≠nh `parameter_group_name` ta c≈©ng c·∫ßn thay ƒë·ªïi th√†nh gi√° tr·ªã `default.redis6.x.cluster.on`.

C√°c b·∫°n ch·∫°y c√¢u l·ªánh Terraform ƒë·ªÉ t·∫°o Elasticache d·∫°ng redis cluster mode enbale.

```
terraform apply -auto-approve
```

Done, c√°c b·∫°n nh·ªõ x√≥a resource nha =)).

```
terraform destroy -auto-approve
```

C√°c b·∫°n like page [DevOps VN](https://www.facebook.com/profile.php?id=100085570585155) ƒë·ªÉ nh·∫≠n th√¥ng b√°o v·ªÅ b√†i vi·∫øt s·ªõm nh·∫•t nh√© üòÅ.

## K·∫øt lu·∫≠n
V·∫≠y l√† ta ƒë√£ t√¨m hi·ªÉu xong c√°ch s·ª≠ d·ª•ng Terraform ƒë·ªÉ t·∫°o Elasticache v·ªõi c√°c d·∫°ng tri·ªÉn khai kh√°c nhau. N·∫øu c√≥ th·∫Øc m·∫Øc ho·∫∑c c·∫ßn gi·∫£i th√≠ch r√µ th√™m ch·ªó n√†o th√¨ c√°c b·∫°n c√≥ th·ªÉ h·ªèi d∆∞·ªõi ph·∫ßn comment.

## M·ª•c t√¨m ki·∫øm ƒë·ªìng ƒë·ªôi

![](https://images.viblo.asia/9fbde6d9-5e57-4429-a903-10a961e1c96c.png)

Team c√¥ng ngh·ªá Ho√†ng Ph√∫c c·ªßa b·ªçn m√¨nh ƒë∆∞·ª£c th√†nh l·∫≠p v·ªõi nhi·ªám v·ª• l√† x√¢y d·ª±ng m·ªôt h·ªá th·ªëng c√¥ng ngh·ªá n·ªôi b·ªô cho c√¥ng ty, Ho√†ng Ph√∫c l√† m·ªôt c√¥ng ty b√°n l·∫ª trong lƒ©nh v·ª±c th·ªùi trang v√† c√≥ h∆°n 30 nƒÉm tu·ªïi ƒë·ªùi, v·ªõi chu·ªói c·ª≠a h√†ng r·∫•t nhi·ªÅu tr√™n to√†n qu·ªëc, n√™n vi·ªác v·∫≠n h√†nh c·ªßa Ho√†ng Ph√∫c l√† r·∫•t l·ªõn v√† vi·ªác x√¢y d·ª±ng ƒë∆∞·ª£c m·ªôt h·ªá th·ªëng c√¥ng ngh·ªá ƒë·ªÉ ƒë√°p ·ª©ng vi·ªác v·∫≠n h√†nh n·ªôi b·ªô cho c√¥ng ty l√† m·ªôt c√¥ng vi·ªác r·∫•t th·ª≠ th√°ch, ƒë√¢y l√† m·ªôt qu√° tr√¨nh chuy·ªÉn ƒë·ªïi s·ªë v√† team b·ªçn m√¨nh ƒë√£ l√†m ƒë∆∞·ª£c nh·ªØng b∆∞·ªõc ban ƒë·∫ßu.

Th·ª© m√† team m√¨nh th·∫•y c·∫•n duy nh·∫•t l√† c√°i website, ƒë√¢y l√† trang web m√† tr∆∞·ªõc khi team m√¨nh ƒë∆∞·ª£c th√†nh l·∫≠p ƒë√£ c√≥ m·ªôt ƒë·ªôi outsource kh√°c l√†m, v√† nh·ªØng g√¨ h·ªç ƒë·ªÉ l·∫°i cho b·ªçn m√¨nh l√† m·ªôt trang web v·ªõi ƒë·ªëng b√πi nh√πi, v·ªõi s·ªë ƒëi·ªÉm t·ª´ google l√† 1 tr√™n 100. V·∫≠y b·ªçn m√¨nh s·∫Ω l√†m g√¨ v·ªõi trang web n√†y ƒë√¢y, n·∫£n ch√≠ sao? ƒêi·ªÅu ƒë√≥ kh√¥ng c√≥ trong t·ª´ ƒëi·ªÉn c·ªßa hai s·∫øp m√¨nh, v√† v·ªõi s·ª± d·∫´n d·∫Øt c·ªßa hai s·∫øp team m√¨nh s·∫Ω bi·∫øn ƒë·ªëng website b√πi nh√πi ƒë√≥ th√†nh kim c∆∞∆°ng, nh∆∞ c√°ch b·ªçn m√¨nh ƒë√£ c·∫£i thi·ªán h·ªá th·ªëng n·ªôi b·ªô. B·ªçn m√¨nh ƒëang c·∫£i thi·ªán trang web h·∫±ng ng√†y v√† h·∫±ng ng√†y, t·ª´ 1 ƒëi·ªÉm b·ªçn m√¨nh ƒë√£ c·∫£i thi·ªán n√≥ l√™n 70 ƒëi·ªÉm, v√† m·ª•c ti√™u l√† tr√™n 90 ƒëi·ªÉm.

Hi·ªán t·∫°i team b·ªçn m√¨nh ƒëang c·∫ßn c√°c ƒë·ªìng ƒë·ªôi tham gia ƒë·ªÉ c·∫£i thi·ªán l·∫°i trang web v·ªõi s·ªë l∆∞·ª£ng ng∆∞·ªùi d√πng truy c·∫≠p kh√° l·ªõn, ƒë√¢y l√† m·ªôt th·ª≠ th√°ch r·∫•t th√∫ v·ªã, c√≥ bao gi·ªù c√°c b·∫°n ƒë∆∞·ª£c tham gia thi·∫øt k·∫ø m·ªôt h·ªá th·ªëng l·ªõn t·ª´ ƒë·∫ßu ch∆∞a, m√¨nh kh√° ch·∫Øc l√† s·ªë l∆∞·ª£ng ƒë√≥ r·∫•t √≠t. B·ªçn m√¨nh ƒë√£ c√≥ kh√°ch h√†ng, nh·ªØng g√¨ c√≤n l·∫°i l√† c·∫ßn nh·ªØng ƒë·ªìng ƒë·ªôi ƒë·ªÉ c√πng nhau ph√°t tri·ªÉn m·ªôt h·ªá th·ªëng ƒë·ªÉ ph·ª•c v·ª• r·∫•t nhi·ªÅu ng∆∞·ªùi d√πng. M·ª•c ti√™u c·ªßa c√¥ng ty Ho√†ng Ph√∫c l√† tr·ªü th√†nh nh√† b√°n l·∫ª v·ªÅ th·ªùi trang l·ªõn nh·∫•t Vi·ªát Nam, h√£y tham gia v·ªõi b·ªçn m√¨nh nh√©. M·ªôt th√†nh vi√™n trong team m√¨nh kh√¥ng y√™u c·∫ßn ph·∫£i gi·ªèi, ch·ªâ c·∫ßn h√≤a ƒë·ªìng, h·ª£p t√°c v√† s·∫µn s√†ng h·ª£p t√°c v·ªõi nhau. C√≥ th·ªÉ b·∫°n kh√¥ng l√† gi·ªèi nh·∫•t nh∆∞ng n·∫øu gia nh·∫≠p v·ªõi b·ªçn m√¨nh th√¨ b·∫°n s·∫Ω t·∫°o ra ƒë∆∞·ª£c nh·ªØng th·ª© gi√° tr·ªã nh·∫•t.

ƒê·ªìng ƒë·ªôi [Senior Backend Engineer](https://tuyendung.hoang-phuc.com/job/senior-backend-engineer-1022).

ƒê·ªìng ƒë·ªôi [Senior Frontend Engineer](https://tuyendung.hoang-phuc.com/job/senior-frontend-engineer-1021).