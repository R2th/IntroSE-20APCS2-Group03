![image.png](https://images.viblo.asia/7661cddb-cb7c-4f1e-96d2-e1feb0917d16.png)

## Stack & Heap

Nhi·ªÅu ng√¥n ng·ªØ l·∫≠p tr√¨nh kh√¥ng y√™u c·∫ßu b·∫°n ph·∫£i hi·ªÉu v·ªÅ **stack** v√† **heap** qu√° r√µ r√£ng. Tuy nhi√™n, v·ªõi m·ªôt ng√¥n ng·ªØ l·∫≠p tr√¨nh h·ªá th·ªëng nh∆∞ **Rust**, m·ªôt gi√° tr·ªã n·∫±m tr√™n **stack** hay **heap** s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn c√°ch n√≥ ho·∫°t ƒë·ªông v√† t∆∞∆°ng t√°c v·ªõi c√°c th√†nh ph·∫ßn kh√°c trong ch∆∞∆°ng tr√¨nh. ƒê·ªÉ n·∫Øm r√µ c√°c kh√°i ni·ªám nh∆∞ **owership** hay **reference** y√™u c·∫ßu b·∫°n hi·ªÉu r√µ v·ªÅ 2 ph√¢n v√πng nh·ªõ n√†y.

C·∫£ **stack** v√† **heap** ƒë·ªÅu l√† nh·ªØng v√πng nh·ªõ c√≥ s·∫µn gi√∫p l∆∞u tr·ªØ gi√° tr·ªã khi th·ª±c thi ch∆∞∆°ng tr√¨nh. 
- **Stack** ho·∫°t ƒë·ªông theo c∆° ch·∫ø **Last In, First Out (LIFO)**, c√°c gi√° tr·ªã l∆∞u tr√™n **stack** ƒë·ªÅu c√≥ k√≠ch th∆∞·ªõc c√≥ ƒë·ªãnh.
- **Heap** l√† v√πng nh·ªõ m√† c√°c gi√° tr·ªã ƒë∆∞·ª£c l∆∞u tr√™n ƒë√≥ kh√¥ng x√°c ƒë·ªãnh k√≠ch th∆∞·ªõc (d√πng ƒë·ªÉ l∆∞u nh·ªØng ph·∫ßn t·ª≠ c√≥ k√≠ch th∆∞·ªõc thay ƒë·ªïi). Khi l∆∞u gi√° tr·ªã tr√™n **heap**, ch√∫ng ta y√™u c·∫ßu m·ªôt l∆∞·ª£ng b·ªô nh·ªõ nh·∫•t ƒë·ªãnh, m·ªôt ph·∫ßn v·ªã tr√≠ tr·ªëng ƒë·ªß l·ªõn trong **heap** s·∫Ω ƒë∆∞·ª£c c·∫•p ph√°t c√πng v·ªõi ƒë√≥ l√† tr·∫£ v·ªÅ 1 con tr·ªè (pointer) l∆∞u ƒë·ªãa ch·ªâ c·ªßa v·ªã tr√≠ v·ª´a ƒë∆∞·ª£c c·∫•p ph√°t. Khi t∆∞∆°ng t√°c v·ªõi d·ª± li·ªáu trong **heap**, ch√∫ng ta s·∫Ω ph·∫£i t∆∞∆°ng t√°c qua con tr·ªè ƒë∆∞·ª£c tr·∫£ v·ªÅ tr∆∞·ªõc ƒë√≥. Con tr·ªè ch·ª©a ƒë·ªãa ch·ªâ √¥ nh·ªõ v·ªõi k√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh, t·∫•t nhi√™n s·∫Ω ƒë∆∞·ª£c l∆∞u ·ªü b·ªô nh·ªõ **stack** :D

![image.png](https://images.viblo.asia/7d2aa4f0-dcad-4868-8b08-3e123993e1e4.png)

L∆∞u tr·ªØ d·ªØ li·ªáu tr√™n **stack** nhanh h∆°n tr√™n **heap** do tr√¨nh c·∫•p ph√°t kh√¥ng bao gi·ªù ph·∫£i t√¨m ki·∫øm n∆°i l∆∞u tr·ªØ d·ªØ li·ªáu m·ªõi, v√¨ n√≥ lu√¥n ·ªü tr√™n ƒë·ªânh c·ªßa **stack**. V·ªõi **heap** s·∫Ω ƒë√≤i h·ªèi nhi·ªÅu c√¥ng vi·ªác h∆°n khi ph·∫£i t√¨m m·ªôt kh√¥ng gian b·ªô nh·ªõ tr·ªëng ƒë·ªß l·ªõn ƒë·ªÉ ch·ª©a d·ªØ li·ªáu. C√πng v·ªõi ƒë√≥, vi·ªác l·∫•y d·ªØ li·ªáu ra tr√™n **stack** s·∫Ω ƒë∆°n gi·∫£n h∆°n r·∫•t nhi·ªÅu so v·ªõi vi·ªác ph·∫£i th√¥ng qua con tr·ªè ƒë·ªÉ truy c·∫≠p ƒë∆∞·ª£c t·ªõi gi√° tr·ªã ƒë∆∞·ª£c l∆∞u tr√™n **heap**.

D·ªØ li·ªáu tr√™n **stack** s·∫Ω ƒë∆∞·ª£c gi·∫£i ph√≥ng sau khi ƒë∆∞·ª£c l·∫•y ra kh·ªèi ngƒÉn x·∫øp. Nh∆∞ng v·ªõi v√πng nh·ªõ **heap**, vi·ªác c·∫•p ph√°t v√† thu h·ªìi sao cho nh·ªØng d·ªØ li·ªáu kh√¥ng c√≤n ƒë∆∞·ª£c s·ª≠ d·ª•ng s·∫Ω ƒë∆∞·ª£c gi·∫£i ph√≥ng, tr√°nh g√¢y l√£ng ph√≠ b·ªô nh·ªõ l√† m·ªôt ƒëi·ªÅu r·∫•t quan tr·ªçng.

Theo d√µi nh·ªØng ƒëo·∫°n m√£ n√†o ƒëang s·ª≠ d·ª•ng d·ªØ li·ªáu n√†o tr√™n **heap**, gi·∫£m thi·ªÉu s·ªë l∆∞·ª£ng d·ªØ li·ªáu tr√πng l·∫∑p c≈©ng nh∆∞ d·ªçn d·∫πp d·ªØ li·ªáu kh√¥ng s·ª≠ d·ª•ng tr√™n **heap** ƒë·ªÉ t·ªëi ∆∞u kh√¥ng gian l∆∞u tr·ªØ l√† nh·ªØng g√¨ kh√°i ni·ªám **ownership** s·∫Ω gi·∫£i quy·∫øt. Khi hi·ªÉu ƒë∆∞·ª£c **ownership** l√† g√¨, ch√∫ng ta s·∫Ω kh√¥ng c·∫ßn ph·∫£i suy nghƒ© v·ªÅ **stack** v√† **heap** m·ªôt c√°ch th∆∞·ªùng xuy√™n.

## Ownership

**Ownership** l√† m·ªôt kh√°i ni·ªám ho√†n to√†n m·ªõi ƒë∆∞·ª£c **Rust** gi·ªõi thi·ªáu, c√≥ ch·ª©c nƒÉng ƒë·∫£m b·∫£o t√≠nh an to√†n, t·ªëi ∆∞u cho b·ªô nh·ªõ m√† kh√¥ng c·∫ßn ƒë·∫øn tr√¨nh d·ªçn r√°c (garbage collector) nh∆∞ c√°c ng√¥n ng·ªØ kh√°c. 

C√°c ng√¥n ng·ªØ l·∫≠p tr√¨nh kh√°c nhau th√¨ c√≥ nh·ªØng c√°ch ti·∫øp c·∫≠n kh√°c nhau ƒë·ªÉ qu·∫£n l√Ω b·ªô nh·ªõ (memory). M·ªôt s·ªë ng√¥n ng·ªØ nh∆∞ **Java, Golang ...**, th√¨ s·ª≠ d·ª•ng **garbage collection** s·∫Ω t·ª± ƒë·ªông gi·∫£i ph√≥ng c√°c √¥ nh·ªõ kh√¥ng c√≤n ƒë∆∞·ª£c s·ª≠ d·ª•ng, c√°c ng√¥n ng·ªØ kh√°c th√¨ y√™u c·∫ßu ng∆∞·ªùi d√πng ph·∫£i t·ª± gi·∫£i ph√≥ng b·ªô nh·ªõ b·∫±ng tay (ƒëi·ªÉn h√¨nh l√† C/C++). V·ªõi **Rust**, ƒë·ªôi ng≈© ph√°t tri·ªÉn ƒë√£ ƒë·ªÅ xu·∫•t m·ªôt c√°ch ti·∫øp c·∫≠n m·ªõi cho v·∫•n ƒë·ªÅ qu·∫£n l√Ω b·ªô nh·ªõ, ƒë√≥ l√† **ownership**. **Ownership** ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a l√† m·ªôt b·ªô c√°c quy t·∫Øc ch·ªâ ƒë·ªãnh c√°ch qu·∫£n l√Ω b·ªô nh·ªõ trong **Rust**, n·∫øu b·∫•t k·ª≥ quy t·∫Øc n√†o b·ªã vi ph·∫°m, ch∆∞∆°ng tr√¨nh s·∫Ω kh√¥ng ƒë∆∞·ª£c bi√™n d·ªãch.

**C√°c quy t·∫Øc ownership**
- M·ªói gi√° tr·ªã trong Rust c√≥ m·ªôt bi·∫øn ƒë∆∞·ª£c g·ªçi l√† ch·ªß s·ªü h·ªØu (ownership) c·ªßa n√≥.
- Ch·ªâ c√≥ th·ªÉ c√≥ m·ªôt ch·ªß s·ªü h·ªØu t·∫°i m·ªôt th·ªùi ƒëi·ªÉm.
- Khi ch·ªß s·ªü h·ªØu ƒëi ra kh·ªèi ph·∫°m vi, b·ªô nh·ªõ l∆∞u gi√° tr·ªã ƒë√≥ s·∫Ω ƒë∆∞·ª£c gi·∫£i ph√≥ng.

Khi ch√∫ng ta hi·ªÉu **ownership**, ch√∫ng ta s·∫Ω c√≥ m·ªôt n·ªÅn t·∫£ng v·ªØng ch·∫Øc ƒë·ªÉ hi·ªÉu c√°c t√≠nh nƒÉng l√†m cho Rust tr·ªü n√™n ƒë·ªôc ƒë√°o. Ch√∫ng ta s·∫Ω t√¨m hi·ªÉu **ownership** qua c√°c v√≠ d·ª• v·ªÅ c·∫•u tr√∫c d·ªØ li·ªáu **strings** d∆∞·ªõi ƒë√¢y.

### Ph·∫°m vi c·ªßa bi·∫øn (Variable Scope)

```rust
#![allow(unused)]

fn main() {            // Bi·∫øn s ch∆∞a h·ª£p l·ªá, v√¨ ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
    let s = "hello";     // s c√≥ gi√° tr·ªã t·ª´ th·ªùi ƒëi·ªÉm n√†y
                                                
}                      // ph·∫°m vi n√†y hi·ªán ƒë√£ k·∫øt th√∫c v√† s kh√¥ng c√≤n h·ª£p l·ªá
```

T·∫°i th·ªùi ƒëi·ªÉm n√†y, m·ªëi quan h·ªá gi·ªØa ph·∫°m vi v√† th·ªùi ƒëi·ªÉm c√°c bi·∫øn c√≥ gi√° tr·ªã t∆∞∆°ng t·ª± nh∆∞ trong c√°c ng√¥n ng·ªØ l·∫≠p tr√¨nh kh√°c. Ti·∫øp theo ƒë√¢y l√† v√≠ d·ª• v·ªõi ki·ªÉu **String**.

### Ki·ªÉu String

ƒê·ªÉ minh h·ªça cho c√°c quy t·∫Øc **ownership**, ch√∫ng ta c·∫ßn m·ªôt ki·ªÉu d·ªØ li·ªáu ph·ª©c t·∫°p h∆°n c√°c ki·ªÉu d·ªØ li·ªáu nguy√™n th·ªßy. C√°c ki·ªÉu d·ªØ li·ªáu nguy√™n th·ªßy ƒë·ªÅu c√≥ k√≠ch th∆∞·ªõc x√°c ƒë·ªãnh, ƒë∆∞·ª£c l∆∞u tr·ªØ tr√™n **stack**, l·∫•y ra kh·ªèi **stack** khi ph·∫°m vi c·ªßa ch√∫ng k·∫øt th√∫c v√† c√≥ th·ªÉ ƒë∆∞·ª£c sao ch√©p nhanh ch√≥ng ƒë·ªÉ t·∫°o m·ªôt ra bi·∫øn m·ªõi, trong m·ªôt ph·∫°m vi kh√°c. 

V·ªõi c√°c d·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr√™n **heap**, m√† trong c√°c v√≠ d·ª• c·ª• th·ªÉ d∆∞·ªõi ƒë√¢y s·∫Ω l√† ki·ªÉu **String** s·∫Ω gi√∫p ch√∫ng ta kh√°m ph√° c√°ch **Rust** bi·∫øt khi n√†o c·∫ßn d·ªçn d·∫πp b·ªô nh·ªõ.


```rust
#![allow(unused)]

fn main() {
    // T·∫°o m·ªõi bi·∫øn s ki·ªÉu String c√≥ gi√° tr·ªã kh·ªüi t·∫°o l√† "hello"
    let s = String::from("hello");
}
```

```rust
fn main() {
    let mut s = String::from("hello");

    s.push_str(", world!"); // push_str() s·∫Ω th√™m chu·ªói ", world" v√†o s

    println!("{}", s); // K·∫øt qu·∫£ in ra: `hello, world!`
}
```

V·ªõi bi·∫øn **s** ki·ªÉu **String** ƒë∆∞·ª£c c·∫•p ph√°t tr√™n **heap**, ta c√≥ th·ªÉ thay ƒë·ªïi n·ªôi dung, ƒë·ªô d√†i t√πy √Ω. N√≥ r·∫•t ph√π h·ª£p d√πng ƒë·ªÉ l∆∞u tr·ªØ c√°c chu·ªói kh√¥ng x√°c ƒë·ªãnh tr∆∞·ªõc k√≠ch th∆∞·ªõc c·ª• th·ªÉ ch·∫≥ng h·∫°n nh∆∞ th√¥ng tin ƒë·∫ßu v√†o ng∆∞·ªùi d√πng nh·∫≠p ch·∫≥ng h·∫°n.

V·ªõi ki·ªÉu **&str** (string literal) nh∆∞ ·ªü ph·∫ßn tr√™n, gi√° tr·ªã chu·ªói ƒë∆∞·ª£c l∆∞u ·ªü **stack** v·ªõi k√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh s·∫Ω kh√¥ng th·ªÉ thay ƒë·ªïi n·ªôi dung sau khi kh·ªüi t·∫°o.

```rust
fn main() {
   let mut a = "conglt";
   println!("{}", a);
}
```


```
Compiling playground v0.0.1 (/playground)
warning: variable does not need to be mutable
 --> src/main.rs:2:8
  |
2 |    let mut a = "conglt";
  |        ----^
  |        |
  |        help: remove this `mut`
  |
```

### B·ªô nh·ªõ v√† C·∫•p ph√°t (Memory and Allocation)

Nh∆∞ ch√∫ng ta ƒë√£ bi·∫øt, khi m·ªôt bi·∫øn ki·ªÉu **String** ƒë∆∞·ª£c kh·ªüi t·∫°o th√¨ bi·∫øn ƒë√≥ s·∫Ω ƒë∆∞·ª£c c·∫•p ph√°t b·ªô nh·ªõ tr√™n **heap**. V√† khi thao t√°c xong,  b·ªô nh·ªõ s·∫Ω c·∫ßn ƒë∆∞·ª£c gi·∫£i ph√≥ng kh√¥ng gian l∆∞u tr·ªØ gi√° tr·ªã.

·ªû m·ªôt s·ªë ng√¥n ng·ªØ s·ª≠ d·ª•ng garbage collector (GC), GC s·∫Ω theo d√µi v√† t·ª± ƒë·ªông d·ªçn d·∫πp b·ªô nh·ªõ kh√¥ng c√≤n ƒë∆∞·ª£c s·ª≠ d·ª•ng n·ªØa,  do ƒë√≥ ch√∫ng ta kh√¥ng c·∫ßn ph·∫£i suy nghƒ© qu√° nhi·ªÅu. Trong h·∫ßu h·∫øt c√°c ng√¥n ng·ªØ kh√¥ng c√≥ GC, tr√°ch nhi·ªám c·ªßa ch√∫ng ta l√† x√°c ƒë·ªãnh khi n√†o b·ªô nh·ªõ kh√¥ng c√≤n ƒë∆∞·ª£c s·ª≠ d·ª•ng n·ªØa v√† g·ªçi l·ªánh ƒë·ªÉ tr·∫£ l·∫°i b·ªô nh·ªõ. Th·ª±c hi·ªán ƒëi·ªÅu n√†y m·ªôt c√°ch ch√≠nh x√°c vi·ªác gi·∫£i ph√≥ng l√† m·ªôt v·∫•n ƒë·ªÅ kh√¥ng h·ªÅ ƒë∆°n gi·∫£n ch√∫t n√†o üòÖ. N·∫øu ch√∫ng ta qu√™n, s·∫Ω g√¢y l√£ng ph√≠ b·ªô nh·ªõ. N·∫øu ch√∫ng ta l√†m gi·∫£i ph√≥ng b·ªô nh·ªõ qu√° s·ªõm, ch√∫ng ta s·∫Ω c√≥ m·ªôt bi·∫øn kh√¥ng h·ª£p l·ªá. N·∫øu ch√∫ng ta l√†m ƒëi·ªÅu ƒë√≥ hai l·∫ßn, ƒë√≥ c≈©ng l√† m·ªôt l·ªói. Trong m√¥n l·∫≠p tr√¨nh C/C++ ·ªü th·ªùi ƒë·∫°i h·ªçc, c√¥ gi√°o ƒë√£ t·ª´ng than th·ªü v·ªõi t·ª•i sinh vi√™n ch√∫ng t√¥i r·∫±ng: d√π c√¥ lu√¥n c·ª±c k·ª≥ c·∫©n th·∫≠n trong vi·ªác c·∫•p ph√°t v√† gi·∫£i ph√≥ng b·ªô nh·ªõ khi vi·∫øt C/C++, nh∆∞ng ch·∫≥ng khi n√†o h·∫øt ƒë∆∞·ª£c l·ªói v√† t·ªëi ∆∞u ch∆∞∆°ng tr√¨nh. V·ªõi c√°c ·ª©ng d·ª•ng nh·ªè th√¨ c≈©ng ko ph·∫£i v·∫•n ƒë·ªÅ q√∫a l·ªõn nh∆∞ng v·ªõi nh·ªØng ph·∫ßn m·ªÅm l·ªõn, c·∫ßn s·ª± t·ªëi ∆∞u b·ªô nh·ªõ t·ªëc ƒë·ªô ƒë·∫øn t·ª´ng mili, micro th√¨ c≈©ng l√† m·ªôt v·∫•n ƒë·ªÅ l√†m ƒëau ƒë·∫ßu nhi·ªÅu th·∫ø h·ªá l·∫≠p tr√¨nh vi√™n C/C++ x∆∞a.

**Rust** ƒëi theo m·ªôt con ƒë∆∞·ªùng kh√°c: b·ªô nh·ªõ s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c gi·∫£i ph√≥ng khi bi·∫øn v∆∞·ª£t ra kh·ªèi ph·∫°m vi.

```rust
fn main() {
    {
        let s = String::from("hello"); // s c√≥ gi√° tr·ªã t·ª´ th·ªùi ƒëi·ªÉm n√†y tr·ªü ƒëi

        // l√†m vi·ªác v·ªõi s
        
    } // ph·∫°m vi n√†y hi·ªán ƒë√£ k·∫øt th√∫c, b·ªô nh·ªõ c·ªßa bi·∫øn s ƒë∆∞·ª£c gi·∫£i ph√≥ng 
    
    println!("{}", s);
}
```

```
   Compiling playground v0.0.1 (/playground)
error[E0425]: cannot find value `s` in this scope
  --> src/main.rs:10:20
   |
10 |     println!("{}", s);
   |                    ^ not found in this scope
```

Khi bi·∫øn s ra kh·ªèi ph·∫°m v·ªã, **Rust** s·∫Ω t·ª± ƒë·ªông g·ªçi m·ªôt h√†m [drop](https://doc.rust-lang.org/std/ops/trait.Drop.html#tymethod.drop) ƒë·ªÉ gi·∫£i ph√≥ng b·ªô nh·ªõ.

Tr√¥ng m·ªçi th·ª© c≈©ng ƒëang r·∫•t ƒë∆°n gi·∫£n ph·∫£i kh√¥ng ? Nh∆∞ ki·ªÉu ph·∫°m vi bi·∫øn b√¨nh th∆∞·ªùng th√¥i m√† nh·ªâ ü§î Ch√∫ng ta h√£y c√πng ƒë·∫øn v·ªõi c√°c v√≠ d·ª• ph·ª©c t·∫°p h∆°n nh√©.

### Ways Variables and Data Interact: Move

```rust
fn main() {
    let x = 5;
    let y = x;
}
```

·ªû v√≠ d·ª• tr√™n, bi·∫øn x ƒë∆∞·ª£c g√°n b·∫±ng 5, sau ƒë√≥ copy gi√° tr·ªã c·ªßa x v√† g√°n v√†o y. Ch√∫ng ta s·∫Ω c√≥ 2 bi·∫øn x, y ƒë·ªÅu c√≥ gi√° tr·ªã l√† 5. 

=> Kh√° l√† c∆° b·∫£n ph·∫£i kh√¥ng üòÖ V√¨ x v√† y ƒë·ªÅu l√† ki·ªÉu d·ªØ li·ªáu nguy√™n th·ªßy, ƒë∆∞·ª£c x√°c ƒë·ªãnh k√≠ch th∆∞·ªõc v√† l∆∞u tr√™n **stack**. Nh∆∞ng n·∫øu l·∫∑p l·∫°i thao t√°c tr√™n v·ªõi c√°c bi·∫øn ki·ªÉu **String** th√¨ s·∫Ω kh√°c r·∫•t nhi·ªÅu ƒë·∫•y üòâ

```rust
fn main() {
    let s1 = String::from("hello");
    let s2 = s1;
}
```

Tr∆∞·ªõc ti√™n, ch√∫ng ta h√£y c√πng xem c√°c gi√° tr·ªã l∆∞u tr·ªØ tr√™n bi·∫øn **s1**

![](https://doc.rust-lang.org/book/img/trpl04-01.svg)

Bi·∫øn **s1** l∆∞u tr·ªØ 3 th√¥ng tin, t·∫•t nhi√™n l√† ph·∫ßn d·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr√™n **stack**:
- con tr·ªè **ptr** tr·ªè ƒë·∫øn n·ªôi dung c·ªßa chu·ªói tr√™n heap
- **len** l∆∞u ƒë·ªô d√†i c·ªßa chu·ªói (t√≠nh b·∫±ng bytes)
- **capacity** l∆∞u k√≠ch th∆∞·ªõc b·ªô nh·ªõ ƒëang ƒë∆∞·ª£c c·∫•p ph√°t cho chu·ªói (t√≠nh b·∫±ng bytes)


Khi g√°n s2 b·∫±ng s1, th·ª±c ch·∫•t l√† vi·ªác copy con tr·ªè, len v√† capacity tr√™n **stack** ch·ª© kh√¥ng ph·∫£i copy gi√° tr·ªã chu·ªói ·ªü tr√™n **heap**.

![](https://doc.rust-lang.org/book/img/trpl04-02.svg)



N·∫øu khi g√°n s2 = s1th√¨ tr√¨nh bi√™n d·ªãch s·∫Ω t·ª± hi·ªÉu l√† copy n√¥ng (shalllow copy) thay v√¨ copy s√¢u (deep copy). Do ƒë√≥, ch·ªâ ph·∫ßn con tr·ªè, len v√† capacity ƒë∆∞·ª£c copy thay v√¨ d·ªØ li·ªáu tr√™n **heap** t·ª´ ƒë√≥ ti·∫øt ki·ªám ƒë∆∞·ª£c 1 l∆∞·ª£ng b·ªô nh·ªõ tr√™n **heap**.

![](https://doc.rust-lang.org/book/img/trpl04-03.svg)


```rust
fn main() {
    let s1 = String::from("hello");
    let s2 = s1;

    println!("{}, world!", s1);
}
```

```
 Compiling playground v0.0.1 (/playground)
warning: unused variable: `s2`
 --> src/main.rs:3:9
  |
3 |     let s2 = s1;
  |         ^^ help: if this is intentional, prefix it with an underscore: `_s2`
  |
  = note: `#[warn(unused_variables)]` on by default

error[E0382]: borrow of moved value: `s1`
 --> src/main.rs:5:28
  |
2 |     let s1 = String::from("hello");
  |         -- move occurs because `s1` has type `String`, which does not implement the `Copy` trait
3 |     let s2 = s1;
  |              -- value moved here
4 | 
5 |     println!("{}, world!", s1);
  |                            ^^ value borrowed here after move
  |
  = note: this error originates in the macro `$crate::format_args_nl` (in Nightly builds, run with -Z macro-backtrace for more info)

For more information about this error, try `rustc --explain E0382`.
warning: `playground` (bin "playground") generated 1 warning
error: could not compile `playground` due to previous error; 1 warning emitted
```

Hummm ü§î, sao l·∫°i l·ªói nh·ªâ ? Bi·∫øn s1 l·∫´n s2 v·∫´n ƒëang trong ph·∫°m vi m√† ü§®

Ch√∫ng ta h√£y ƒë·ªÉ √Ω r·∫±ng, khi copy bi·∫øn s2 t·ª´ s1 th√¨ 2 con tr·ªè ƒëang tr·ªè ƒë·∫øn 1 v√πng nh·ªõ **heap** l∆∞u tr·ªØ gi√° tr·ªã c·ªßa chu·ªói.  V·∫≠y s·∫Ω c√≥ 1 v·∫•n ƒë·ªÅ l·ªõn ·ªü ƒë√¢y l√† khi c·∫£ 2 bi·∫øn s1, s2 ƒë·ªÅu ra kh·ªèi ph·∫°m vi t·ªìn t·∫°i c√πng m·ªôt ch·ªó, s·∫Ω d·∫´n ƒë·∫øn vi·ªác gi·∫£i ph√≥ng b·ªô nh·ªõ 2 l·∫ßn => L·ªói  **double free error**

·ªû ƒë√¢y, ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n cho b·ªô nh·ªõ th√¨ Rust s·∫Ω x·ª≠ l√Ω v·∫•n ƒë·ªÅ b·∫±ng c√°ch v√¥ hi·ªáu h√≥a s1 khi bi·∫øn s2 ƒë∆∞·ª£c g√°n b·∫±ng s1. Cho n√™n khi ch√∫ng ta in bi·∫øn s1 ra s·∫Ω b·ªã th√¥ng b√°o l·ªói.

```rust
#[warn(unused_variables)]
fn main() {
    let s1 = String::from("hello");
    let s2 = s1;
    
    // B√¢y gi·ªù ch·ªâ c√≥ th·ªÉ truy c·∫≠p ƒë·∫øn n·ªôi dung c·ªßa chu·ªói b·∫±ng s2
    println!("{}, world!", s2); // hello, world!
}
```

![](https://doc.rust-lang.org/book/img/trpl04-04.svg)

### Deep Copy

Ch√∫ng ta s·∫Ω s·∫Ω d·ª•ng h√†m `clone` khi mu·ªën copy s√¢u d·ªØ li·ªáu tr√™n **heap**.

```rust
fn main() {
    let s1 = String::from("hello");
    let s2 = s1.clone();

    println!("s1 = {}, s2 = {}", s1, s2); // s1 = hello, s2 = hello
}
```

### Ownership v√† Functions

Ch√∫ng ta c√πng xem v√≠ d·ª• d∆∞·ªõi ƒë√¢y

```rust
fn main() {
    let s = String::from("hello");  // s ƒë∆∞·ª£c kh·ªüi t·∫°o
    takes_ownership(s);            // gi√° tr·ªã c·ªßa s ƒë∆∞·ª£c truy·ªÅn v√†o h√†m takes_ownership

    let x = 5;                     // kh·ªüi t·∫°o bi·∫øn x
    makes_copy(x);                // truy·ªÅn x v√†o h√†m makes_copy
    
    println!("s is {}", s);
    println!("x is {}", x);

} // H·∫øt ph·∫°m vi c·ªßa 2 bi·∫øn s, x

fn takes_ownership(some_string: String) {
    println!("{}", some_string);
}

fn makes_copy(some_integer: i32) {
    println!("{}", some_integer);
}
```

Output k·ª≥ v·ªçng c·ªßa ch√∫ng ta s·∫Ω l√†:
```
hello
5
s is hello
x is 5
```

N√†o, c√πng th·ª≠ ch·∫°y ƒëo·∫°n code n√†y xem sao :D

```
error[E0382]: borrow of moved value: `s`
 --> src/main.rs:8:25
  |
2 |     let s = String::from("hello");  // s ƒë∆∞·ª£c kh·ªüi t·∫°o
  |         - move occurs because `s` has type `String`, which does not implement the `Copy` trait
3 |     takes_ownership(s);            // gi√° tr·ªã c·ªßa s ƒë∆∞·ª£c truy·ªÅn v√†o h√†m takes_ownership
  |                     - value moved here
...
8 |     println!("s is {}", s);
  |                         ^ value borrowed here after move
  |
  = note: this error originates in the macro `$crate::format_args_nl` (in Nightly builds, run with -Z macro-backtrace for more info)
```

·ªí l·ªói k√¨a üòì, ·ªü d√≤ng th·ª© 8 `println!("s is {}", s);`. T·∫°i sao nh·ªâ, bi·∫øn s ƒëang c√≤n trong ph·∫°m vi m√†, hay vi·ªác truy·ªÅn s v√†o h√†m `takes_ownership` ƒë√£ l√†m thay ƒë·ªïi g√¨ ƒë√≥ üßê Ch√∫ng ta th·ª≠ comment d√≤ng ƒë√≥ l·∫°i v√† ch·∫°y l·∫°i th·ª≠ xem c√≥ b·ªã l·ªói d√≤ng th·ª© 9 `println!("x is {}", x);` ƒë√≥ kh√¥ng ?

```
hello
5
x is 5
```

Ch∆∞∆°ng tr√¨nh ho√†n to√†n b√¨nh th∆∞·ªùng, ch√∫ng ta v·∫´n in x ra ƒë∆∞·ª£c b√¨nh th∆∞·ªùng.

S·ª± kh√°c bi·ªát ·ªü ƒë√¢y gi·ªØa **s** v√† **x** l√† ki·ªÉu d·ªØ li·ªáu **String** v√† **i32**. V·ªõi c√°c bi·∫øn c√≥ ki·ªÉu d·ªØ li·ªáu nguy√™n th·ªßy nh∆∞ x, khi truy·ªÅn d∆∞·ªõi d·∫°ng tham s·ªë v√†o h√†m, n√≥ s·∫Ω copy gi√° tr·ªã sang 1 bi·∫øn kh√°c v√† s·ª≠ d·ª•ng n√≥ trong h√†m (v√¨ vi·ªác copy tr√™n stack r·∫•t ƒë∆°n gi·∫£n). V·ªõi c√°c ki·ªÉu d·ªØ li·ªáu nh∆∞ **String** th√¨ khi truy·ªÅn tham s·ªë v√†o h√†m s·∫Ω truy·ªÅn ch√≠nh con tr·ªè li√™n k·∫øt v·ªõi d·ªØ li·ªáu trong **heap**, khi h√†m x·ª≠ l√Ω xong (·ªü cu·ªëi scope) th√¨ b·ªô nh·ªõ tr√™n heap s·∫Ω ƒë∆∞·ª£c gi·∫£i ph√≥ng lu√¥n.

=> Do ƒë√≥, sau khi g·ªçi h√†m `takes_ownership` th√¨ bi·∫øn s ƒë√£ kh√¥ng c√≤n h·ª£p l·ªá n√™n kh√¥ng th·ªÉ in ra m√†n h√¨nh. Trong khi ƒë√≥, x ch·ªâ truy·ªÅn gi√° tr·ªã copy sang h√†m n√™n ƒë·∫øn h·∫øt `fn main` th√¨ x m·ªõi kh√¥ng c√≤n h·ª£p 


### Return Values and Scope

```rust
fn main() {
    let s1 = gives_ownership();        
    let s2 = String::from("hello"); 
    let s3 = takes_and_gives_back(s2);         
}

fn gives_ownership() -> String {    
    let some_string = String::from("yours"); 

    some_string
}

fn takes_and_gives_back(a_string: String) -> String { 
    a_string 
}
```


Vi·ªác g√°n s1 b·∫±ng gi√° tr·ªã tr·∫£ v·ªÅ c·ªßa h√†m `gives_ownership`. Theo logic m√† ch√∫ng ta ƒëang hi·ªÉu th√¨ kh·∫£ nƒÉng khi ch·∫°y ch∆∞∆°ng tr√¨nh s·∫Ω b·ªã l·ªói khi bi·∫øn `some_string` s·∫Ω ƒë∆∞·ª£c gi·∫£i ph√≥ng ·ªü cu·ªëi h√†m `gives_ownership` => bi·∫øn s1 s·∫Ω b·ªã l·ªói. T∆∞∆°ng t·ª± vi·ªác g√°n s3 b·∫±ng gi√° tr·ªã tr·∫£ v·ªÅ c·ªßa h√†m `takes_and_gives_back` c≈©ng l√† 1 d·∫•u ch·∫•m h·ªèi. Tuy nhi√™n, khi ch·∫°y ch∆∞∆°ng tr√¨nh th√¨ kh√¥ng h·ªÅ c√≥ l·ªói n√†o xu·∫•t hi·ªán üòï

**Ownership** c·ªßa m·ªôt bi·∫øn lu√¥n tu√¢n theo nguy√™n t·∫Øc: vi·ªác g√°n m·ªôt gi√° tr·ªã cho m·ªôt bi·∫øn kh√°c s·∫Ω di chuy·ªÉn n√≥ (di chuy·ªÉn sang ph·∫°m vi kh√°c) v√† khi n√†o bi·∫øn v∆∞·ª£t kh·ªèi ph·∫°m vi th√¨ s·∫Ω ƒë∆∞·ª£c gi·∫£i ph√≥ng. ·ªû tr√™n vi·ªác "g√°n" gi√° tr·ªã tr·∫£ v·ªÅ c·ªßa c√°c h√†m cho c√°c bi·∫øn kh√°c s·∫Ω di chuy·ªÉn ph·∫°m vi c√°c bi·∫øn **String** kia => cho n√™n ch√∫ng ta v·∫´n c√≥ 1 ƒëo·∫°n code ch·∫°y b√¨nh th∆∞·ªùng nh∆∞ th·∫ø ƒë√≥.

## K·∫øt b√†i

**Ownership** l√† m·ªôt kh√°i ni·ªám r·∫•t hay v√† quan tr·ªçng l√†m n√™n s·ª± ƒë·∫∑c tr∆∞ng c·ªßa ng√¥n ng·ªØ Rust.Khi ch√∫ng ta ti·∫øp c·∫≠n c√°c kh√°i ni·ªám quan tr·ªçng kh√°c trong Rust nh∆∞ **Reference**, **Borrowing** th√¨ vi·ªác c·∫ßn hi·ªÉu v·ªÅ ownership l√† ƒëi·ªÅu ti√™n quy·∫øt. 


## T√†i li·ªáu tham kh·∫£o

[The Rust Programming Language](https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html)